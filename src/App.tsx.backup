import React, { useState, useEffect } from 'react';

// CSS для мигающего курсора
const cursorStyle = `
  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }
`;

// Добавляем стили в head
if (typeof document !== 'undefined') {
  const style = document.createElement('style');
  style.textContent = cursorStyle;
  document.head.appendChild(style);
}
import { knowledgeBase, botCorrections as botCorrectionsAPI, testConnection, users } from './supabaseClient.js';
import * as supabaseClient from './supabaseClient.js';

// Отладочный код для проверки импорта
console.log('supabaseClient:', supabaseClient);
console.log('chatHistory from supabaseClient:', supabaseClient.chatHistory);
import { processContent } from './gigaChatAPI.js';

// Функция для сохранения настроек модели в Supabase и отправки в GigaChat
const saveModelSettings = async (setupData, userId) => {
  try {
    // Формируем промпт для GigaChat на основе настроек
    const systemPrompt = generateSystemPrompt(setupData);
    
    // Сохраняем данные в Supabase
    const { data, error } = await supabaseClient.supabase
      .from('model_settings')
      .upsert({
        user_id: userId,
        settings: setupData,
        system_prompt: systemPrompt,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }, {
        onConflict: 'user_id'
      });

    if (error) {
      console.error('Ошибка сохранения в Supabase:', error);
      throw error;
    }

    // Отправляем промпт в GigaChat для обучения
    await sendPromptToGigaChat(systemPrompt, userId);

    return { success: true, data };
  } catch (error) {
    console.error('Ошибка сохранения настроек:', error);
    throw error;
  }
};

// Функция генерации системного промпта для GigaChat
const generateSystemPrompt = (setupData) => {
  let prompt = `Ты ИИ-оператор Adapto. Твоя задача - помогать клиентам в соответствии со следующими настройками:\n\n`;

  // Шаг 1: Цели и задачи
  if (setupData.task) {
    prompt += `**Основная задача:** ${setupData.task}\n`;
  }
  if (setupData.mainGoal) {
    prompt += `**Главная цель:** ${setupData.mainGoal}\n`;
  }
  if (setupData.customGoal) {
    prompt += `**Дополнительная цель:** ${setupData.customGoal}\n`;
  }
  if (setupData.dealCycle) {
    prompt += `**Цикл сделки:** ${setupData.dealCycle}\n`;
  }
  if (setupData.targetAudience) {
    prompt += `**Целевая аудитория:** ${setupData.targetAudience}\n`;
  }

  // Шаг 2: Правила общения
  prompt += `\n**Правила общения:**\n`;
  prompt += `- Обращение: на "${setupData.addressing}"\n`;
  prompt += `- Стиль общения: ${setupData.communicationStyle}\n`;
  prompt += `- Использование эмодзи: ${setupData.emojiUsage}\n`;

  // Ограничения
  if (setupData.restrictions && setupData.restrictions.length > 0) {
    prompt += `\n**Ограничения:**\n`;
    setupData.restrictions.forEach(restriction => {
      prompt += `- ${restriction}\n`;
    });
  }

  // Дополнительные настройки общения
  if (setupData.communicationSettings && setupData.communicationSettings.length > 0) {
    prompt += `\n**Дополнительные настройки общения:**\n`;
    setupData.communicationSettings.forEach(setting => {
      prompt += `- ${setting}\n`;
    });
  }

  // Сбор данных
  if (setupData.dataCollection && setupData.dataCollection.length > 0) {
    prompt += `\n**Собираемые данные:**\n`;
    setupData.dataCollection.forEach(dataType => {
      prompt += `- ${dataType}\n`;
    });
  }

  // Уточняющие вопросы
  if (setupData.clarificationQuestions && setupData.clarificationQuestions.length > 0) {
    prompt += `\n**Когда задавать уточняющие вопросы:**\n`;
    setupData.clarificationQuestions.forEach(question => {
      prompt += `- ${question}\n`;
    });
  }

  // Шаг 3: Этапы диалога
  if (setupData.dialogStages && setupData.dialogStages.length > 0) {
    prompt += `\n**Этапы диалога (воронка продаж):**\n`;
    setupData.dialogStages.forEach((stage, index) => {
      prompt += `${index + 1}. ${stage}\n`;
    });
  }

  prompt += `\nВсегда следуй этим инструкциям и адаптируй свои ответы под конкретную ситуацию клиента.`;

  return prompt;
};

// Функция отправки промпта в GigaChat
const sendPromptToGigaChat = async (systemPrompt, userId) => {
  try {
    // Здесь должна быть интеграция с GigaChat API
    // Пока что просто логируем промпт
    console.log('Отправка промпта в GigaChat:', systemPrompt);
    
    // TODO: Реализовать отправку в GigaChat API
    // const response = await gigaChatAPI.updateSystemPrompt(systemPrompt, userId);
    
    return { success: true };
  } catch (error) {
    console.error('Ошибка отправки в GigaChat:', error);
    throw error;
  }
};

// Функция загрузки сохраненных настроек из Supabase
const loadModelSettings = async (userId) => {
  try {
    const { data, error } = await supabaseClient.supabase
      .from('model_settings')
      .select('*')
      .eq('user_id', userId)
      .single();

    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
      console.error('Ошибка загрузки настроек:', error);
      throw error;
    }

    if (data) {
      return data.settings;
    }

    return null;
  } catch (error) {
    console.error('Ошибка загрузки настроек:', error);
    return null;
  }
};
import { 
  BarChart3, 
  MessageSquare, 
  Database, 
  Settings, 
  Zap, 
  Plus, 
  Send, 
  AlertTriangle,
  Globe,
  Link as LinkIcon,
  Edit as EditIcon,
  File as FileIcon,
  Trash2,
  Info,
  ChevronRight,
  ExternalLink,
  Menu,
  X,
  User,
  Building,
  Mail,
  Lock,
  Eye,
  EyeOff,
  CheckCircle,
  Upload,
  Download,
  Search,
  Filter,
  MoreHorizontal,
  MoreVertical,
  Home,
  HelpCircle,
  Link,
  File,
  Calendar,
  TrendingUp,
  TrendingDown,
  Clock,
  FileText
} from 'lucide-react';

// UI Components
const Button = ({ children, className = '', onClick, disabled = false, variant = 'default', size = 'default', type = 'button', ...props }) => {
  const baseClasses = 'inline-flex items-center justify-center rounded-[10px] font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background';
  
  const variants = {
    default: 'bg-primary text-primary-foreground hover:bg-primary/90',
    destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
    outline: 'border border-input hover:bg-accent hover:text-accent-foreground',
    secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
    ghost: 'hover:bg-accent hover:text-accent-foreground',
    link: 'underline-offset-4 hover:underline text-primary'
  };

  const sizes = {
    default: 'h-10 py-2 px-4',
    sm: 'h-9 px-3 rounded-[10px]',
    lg: 'h-11 px-8 rounded-[10px]',
    icon: 'h-10 w-10'
  };

  const variantClass = variants[variant] || variants.default;
  const sizeClass = sizes[size] || sizes.default;

  return (
    <button
      type={type}
      className={`${baseClasses} ${variantClass} ${sizeClass} ${className}`}
      onClick={onClick}
      disabled={disabled}
      {...props}
    >
      {children}
    </button>
  );
};

const Input = ({ className = '', type = 'text', ...props }) => (
  <input
    type={type}
    className={`flex h-10 w-full rounded-[10px] border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${className}`}
    {...props}
  />
);

const Textarea = ({ className = '', ...props }) => (
  <textarea
    className={`flex min-h-[80px] w-full rounded-[10px] border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${className}`}
    {...props}
  />
);

const Card = ({ className = '', ...props }) => (
  <div className={`rounded-[10px] border bg-card text-card-foreground shadow-sm ${className}`} {...props} />
);

const CardHeader = ({ className = '', ...props }) => (
  <div className={`flex flex-col space-y-1.5 p-6 ${className}`} {...props} />
);

const CardTitle = ({ className = '', ...props }) => (
  <h3 className={`text-lg font-semibold leading-none tracking-tight ${className}`} {...props} />
);

const CardContent = ({ className = '', ...props }) => (
  <div className={`p-6 pt-0 ${className}`} {...props} />
);

const Select = ({ children, value, onValueChange, ...props }) => {
  return (
    <select
      value={value}
      onChange={(e) => onValueChange && onValueChange(e.target.value)}
      className="flex h-10 w-full items-center justify-between rounded-[10px] border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
      {...props}
    >
      {children}
    </select>
  );
};

export default function App() {
  // State
  const [isLoggedIn, setIsLoggedIn] = useState(() => {
    return localStorage.getItem('isLoggedIn') === 'true';
  });
  
  const [currentUser, setCurrentUser] = useState(() => {
    const stored = localStorage.getItem('currentUser');
    return stored ? JSON.parse(stored) : null;
  });
  
  const [activeSection, setActiveSection] = useState(() => {
    return localStorage.getItem('currentSection') || 'main';
  });
  
  const [currentStep, setCurrentStep] = useState('login');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [showPasswordField, setShowPasswordField] = useState(false);
  const [showSuccessModal, setShowSuccessModal] = useState(false);
  const [showNotification, setShowNotification] = useState(false);
  const [notificationMessage, setNotificationMessage] = useState('');
  const [showSetupWizard, setShowSetupWizard] = useState(false);
  const [setupStep, setSetupStep] = useState(1);
  const [showValidationMessage, setShowValidationMessage] = useState(false);
  const [showProgressBar, setShowProgressBar] = useState(false);
  const [showIntegrationModal, setShowIntegrationModal] = useState(false);
  const [selectedIntegration, setSelectedIntegration] = useState(null);
  const [showWidgetConstructor, setShowWidgetConstructor] = useState(false);
  
  // Состояния для интеграций
  const [integrations, setIntegrations] = useState([
    { id: 'widget', name: 'Виджет на сайт', description: 'Настройте виджет и вставьте скрипт на сайт', icon: 'group-36.svg', installed: false },
    { id: 'whatsapp', name: 'WhatsApp', description: 'Подключите ИИ-бота к WhatsApp Business', icon: 'group-37.svg', installed: false },
    { id: 'telegram', name: 'Telegram', description: 'Подключите ИИ-бота к Telegram', icon: 'group-38.svg', installed: false },
    { id: 'vk', name: 'Вконтакте', description: 'Установите в своем сообществе ИИ-агента', icon: 'group-39.svg', installed: false },
    { id: 'bitrix', name: 'Битрикс24', description: 'Подключите CRM для передачи лидов', icon: 'group-41.svg', installed: false },
    { id: 'amo', name: 'amoCRM', description: 'Подключите CRM для передачи лидов', icon: 'group-42.svg', installed: false },
    { id: 'instagram', name: 'Instagram*', description: 'Внедрите ИИ-бота прямиком в Директ', icon: 'group-43.svg', installed: false },
    { id: 'yclients', name: 'Yclients', description: 'Интегрируйте Adapto в Yclients', icon: 'group-40.svg', installed: false }
  ]);

  const [showUninstallModal, setShowUninstallModal] = useState(false);
  const [integrationToUninstall, setIntegrationToUninstall] = useState(null);
  
  // Состояния для попапа первого входа
  const [isFirstTimeUser, setIsFirstTimeUser] = useState(false);
  const [showModelSetupProgress, setShowModelSetupProgress] = useState(false);
  const [modelSetupTimer, setModelSetupTimer] = useState(300); // 5 минут = 300 секунд

  // Form data
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    name: '',
    company: '',
    phone: '',
    companyField: ''
  });

  // Состояние для кода страны
  const [countryCode, setCountryCode] = useState('+7');

  // Состояния для сводки
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [dateRange, setDateRange] = useState({
    startDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // 30 дней назад
    endDate: new Date()
  });
  const [selectedPeriod, setSelectedPeriod] = useState('last30days');

  // Состояния для диалогов
  const [selectedDialog, setSelectedDialog] = useState(null);
  const [dialogSearch, setDialogSearch] = useState('');
  const [showDialogFilters, setShowDialogFilters] = useState(false);
  const [showProfileModal, setShowProfileModal] = useState(false);
  const [activeProfileTab, setActiveProfileTab] = useState('profile');

  const [formErrors, setFormErrors] = useState({});
  const [validationErrors, setValidationErrors] = useState({});

  // Функция форматирования номера телефона
  const formatPhoneNumber = (value) => {
    // Убираем все кроме цифр
    const phoneNumbers = value.replace(/\D/g, '');
    if (phoneNumbers.length === 0) return '';
    
    // Форматируем номер для России (+7)
    if (phoneNumbers.length <= 3) return `+7 (${phoneNumbers}`;
    if (phoneNumbers.length <= 6) return `+7 (${phoneNumbers.slice(0, 3)}) ${phoneNumbers.slice(3)}`;
    if (phoneNumbers.length <= 8) return `+7 (${phoneNumbers.slice(0, 3)}) ${phoneNumbers.slice(3, 6)}-${phoneNumbers.slice(6)}`;
    if (phoneNumbers.length <= 10) return `+7 (${phoneNumbers.slice(0, 3)}) ${phoneNumbers.slice(3, 6)}-${phoneNumbers.slice(6, 8)}-${phoneNumbers.slice(8)}`;
    return `+7 (${phoneNumbers.slice(0, 3)}) ${phoneNumbers.slice(3, 6)}-${phoneNumbers.slice(6, 8)}-${phoneNumbers.slice(8, 10)}`;
  };

  // Функция форматирования номера телефона для России
  const formatRussianPhone = (value) => {
    const digits = value.replace(/\D/g, '');
    if (digits.length === 0) return '';
    if (digits.length <= 3) return `(${digits}`;
    if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
    if (digits.length <= 8) return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
    if (digits.length <= 10) return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 8)}-${digits.slice(8)}`;
    return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 8)}-${digits.slice(8, 10)}`;
  };

  // Функция валидации номера телефона
  const validatePhone = (phone) => {
    if (!phone) return 'Номер телефона обязателен';
    
    // Убираем все кроме цифр для проверки
    const phoneNumbers = phone.replace(/\D/g, '');
    
    if (phoneNumbers.length === 0) return 'Номер телефона должен содержать цифры';
    if (phoneNumbers.length < 10) return 'Номер телефона должен содержать минимум 10 цифр';
    if (phoneNumbers.length > 15) return 'Номер телефона слишком длинный';
    
    return null;
  };

  // Функции для работы с календарем
  const setPeriod = (period) => {
    const now = new Date();
    let startDate, endDate;
    
    switch (period) {
      case 'today':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
        break;
      case 'yesterday':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59);
        break;
      case 'last7days':
        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        endDate = now;
        break;
      case 'thisMonth':
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        endDate = now;
        break;
      case 'last30days':
        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        endDate = now;
        break;
      case 'last90days':
        startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
        endDate = now;
        break;
      default:
        return;
    }
    
    setDateRange({ startDate, endDate });
    setSelectedPeriod(period);
    setShowDatePicker(false);
  };

  // Функции экспорта данных
  const exportToCSV = () => {
    const data = [
      ['Метрика', 'Значение', 'Динамика', 'Период'],
      ['Количество сообщений', '1,234', '+12%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Количество диалогов', '567', '+8%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Среднее время ответа', '2.3 сек', '+5%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Количество открытий виджета', '2,891', '+25%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Количество заявок', '89', '+18%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Решенных вопросов', '92%', '+15%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`]
    ];
    
    const csvContent = data.map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `сводка_${dateRange.startDate.toLocaleDateString()}_${dateRange.endDate.toLocaleDateString()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const exportToXLS = () => {
    const data = [
      ['Метрика', 'Значение', 'Динамика', 'Период'],
      ['Количество сообщений', '1,234', '+12%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Количество диалогов', '567', '+8%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Среднее время ответа', '2.3 сек', '+5%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Количество открытий виджета', '2,891', '+25%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Количество заявок', '89', '+18%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`],
      ['Решенных вопросов', '92%', '+15%', `${dateRange.startDate.toLocaleDateString()} - ${dateRange.endDate.toLocaleDateString()}`]
    ];
    
    // Создаем HTML таблицу для XLS
    let html = '<table>';
    data.forEach(row => {
      html += '<tr>';
      row.forEach(cell => {
        html += `<td>${cell}</td>`;
      });
      html += '</tr>';
    });
    html += '</table>';
    
    const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `сводка_${dateRange.startDate.toLocaleDateString()}_${dateRange.endDate.toLocaleDateString()}.xls`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Данные диалогов
  const dialogsData = [
    {
      id: 1,
      source: 'widget',
      sourceIcon: '/Group 102.svg',
      sourceName: 'Виджет',
      user: 'Анна Морозова',
      phone: '+7 (921) 331-21-43',
      email: 'anna@example.com',
      status: 'active',
      lastMessage: 'Какие у вас есть тарифы?',
      time: '2 минуты назад',
      messages: 5,
      messagesList: [
        { type: 'user', text: 'Здравствуйте! Интересуют ваши услуги', time: '14:30' },
        { type: 'assistant', text: 'Добрый день! Конечно, расскажу о наших тарифах. У нас есть несколько вариантов...', time: '14:31' },
        { type: 'user', text: 'А что входит в базовый тариф?', time: '14:32' },
        { type: 'assistant', text: 'В базовый тариф входит: подключение ИИ-агента, базовая настройка, 1000 сообщений в месяц...', time: '14:33' },
        { type: 'user', text: 'Какие у вас есть тарифы?', time: '14:35' }
      ]
    },
    {
      id: 2,
      source: 'whatsapp',
      sourceIcon: '/Group 37.svg',
      sourceName: 'WhatsApp',
      user: 'Михаил Козлов',
      phone: '+7 (999) 123-45-67',
      email: null,
      status: 'waiting',
      lastMessage: 'Как подключить интеграцию с CRM?',
      time: '15 минут назад',
      messages: 3,
      messagesList: [
        { type: 'user', text: 'Привет! Нужна помощь с интеграцией', time: '14:15' },
        { type: 'assistant', text: 'Здравствуйте! Конечно, помогу с интеграцией. Какую CRM используете?', time: '14:16' },
        { type: 'user', text: 'Как подключить интеграцию с CRM?', time: '14:20' }
      ]
    },
    {
      id: 3,
      source: 'telegram',
      sourceIcon: '/Group 38.svg',
      sourceName: 'Telegram',
      user: 'Екатерина Смирнова',
      phone: '+7 (916) 555-12-34',
      email: 'kate@example.com',
      status: 'closed',
      lastMessage: 'Спасибо за помощь!',
      time: '1 час назад',
      messages: 12,
      messagesList: [
        { type: 'user', text: 'Добрый день! Есть вопрос по настройке', time: '13:00' },
        { type: 'assistant', text: 'Здравствуйте! Конечно, готов помочь с настройкой. Что именно интересует?', time: '13:01' },
        { type: 'user', text: 'Как настроить виджет на сайте?', time: '13:02' },
        { type: 'assistant', text: 'Для настройки виджета нужно: 1. Скопировать код из панели управления 2. Вставить в HTML вашего сайта 3. Настроить внешний вид...', time: '13:03' },
        { type: 'user', text: 'Спасибо за помощь!', time: '13:05' }
      ]
    },
    {
      id: 4,
      source: 'vk',
      sourceIcon: '/Group 39.svg',
      sourceName: 'ВКонтакте',
      user: 'Дмитрий Петров',
      phone: '+7 (903) 777-88-99',
      email: null,
      status: 'active',
      lastMessage: 'Не работает виджет на сайте',
      time: '5 минут назад',
      messages: 8,
      messagesList: [
        { type: 'user', text: 'Помогите! Виджет не работает', time: '14:25' },
        { type: 'assistant', text: 'Здравствуйте! Давайте разберемся с проблемой. На каком сайте установлен виджет?', time: '14:26' },
        { type: 'user', text: 'На моем интернет-магазине', time: '14:27' },
        { type: 'assistant', text: 'Понятно. Давайте проверим несколько моментов: 1. Правильно ли вставлен код? 2. Нет ли ошибок в консоли браузера?', time: '14:28' },
        { type: 'user', text: 'Не работает виджет на сайте', time: '14:30' }
      ]
    }
  ];

  // Setup data
  const [setupData, setSetupData] = useState({
    // Шаг 1: Цели Adapto
    task: '',
    mainGoal: '',
    customGoal: '',
    dealCycle: '',
    targetAudience: '',
    
    // Шаг 2: Правила общения
    addressing: 'Вы',
    communicationStyle: 'Профессиональный',
    restrictions: [],
    showCustomRestriction: false,
    customRestriction: '',
    communicationSettings: [],
    showCustomCommunicationSetting: false,
    customCommunicationSetting: '',
    dataCollection: [],
    showCustomData: false,
    customData: '',
    clarificationQuestions: [],
    showCustomClarificationQuestion: false,
    customClarificationQuestion: '',
    emojiUsage: 'Редко',
    editingStage: null,
    
    // Шаг 3: Этапы диалога
    dialogStages: [
      'Поздоровайся и спроси имя клиента. Уточни его проблему и пойми текущую ситуацию пользователя',
      'Опиши коротко как решишь его задачу/назови наши преимущества, предложи товары по запросу',
      'Веди клиента к оформлению заказа/заявки',
      'Когда клиент готов оформить заказ, сделай итог заказа и пришли ссылку на оплату из базы знаний.',
      'Переведи клиента на менеджера для проверки оплаты и дальнейшей работы'
    ],
    dialogStagesModified: null, // null = не проверяли, true = изменено, false = не изменено
    
    // Для попапа первого входа - Шаг 4: База знаний
    knowledgeItems: [],
    selectedKnowledgeType: null,
    knowledgeInput: '',
    
    // Технические настройки модели
    modelProvider: 'gigachat',
    modelName: 'GigaChat:latest',
    systemPrompt: '',
    temperature: 0.7,
    maxTokens: 1000
  });

  // Chat and knowledge data
  const [chatHistory, setChatHistory] = useState([
    { type: 'assistant', text: 'Привет! Я ваш ИИ-ассистент Adapto. Как дела?' }
  ]);
  const [currentMessage, setCurrentMessage] = useState('');
  const [botCorrection, setBotCorrection] = useState('');
  const [botCorrections, setBotCorrections] = useState([]);
  const [hasKnowledgeBase, setHasKnowledgeBase] = useState(false);
  const [knowledgeItems, setKnowledgeItems] = useState([]);
  const [newKnowledgeItem, setNewKnowledgeItem] = useState({ type: 'text', content: '' });
  const [selectedKnowledgeItem, setSelectedKnowledgeItem] = useState(null);
  const [showSitePopup, setShowSitePopup] = useState(false);
  const [showFeedPopup, setShowFeedPopup] = useState(false);
  const [showFilePopup, setShowFilePopup] = useState(false);
  const [showTextPopup, setShowTextPopup] = useState(false);
  
  // Обработчик клика вне области для закрытия выпадающего меню
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (selectedKnowledgeItem && !event.target.closest('.dropdown-menu')) {
        setSelectedKnowledgeItem(null);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [selectedKnowledgeItem]);
  const [sitePopupTab, setSitePopupTab] = useState('full'); // 'full' или 'selective'
  const [siteUrl, setSiteUrl] = useState('');
  const [selectedPages, setSelectedPages] = useState(['']);
  const [siteUrlError, setSiteUrlError] = useState('');
  const [selectedPagesErrors, setSelectedPagesErrors] = useState(['']);
  
  // Feed popup states
  const [feedUrl, setFeedUrl] = useState('');
  const [feedUrlError, setFeedUrlError] = useState('');
  
  // File popup states
  const [selectedFiles, setSelectedFiles] = useState([]);
  const [uploadedFiles, setUploadedFiles] = useState([]);
  
  // Text popup states
  const [textContent, setTextContent] = useState('');
  const [textContentError, setTextContentError] = useState('');

  // Widget settings
  const [widgetSettings, setWidgetSettings] = useState({
    accentColor: '#1354FC',
    buttonColor: 'light',
    buttonText: 'Спросить ИИ',
    buttonSubtext: 'Задать вопрос',
    avatar: 'default',
    customButtonColor: '#1354FC',
    showCustomColorPicker: false,
    widgetLocation: 'default',
    // Widget positioning
    desktopBottomOffset: 20,
    desktopRightOffset: 20,
    mobileBottomOffset: 20,
    mobileRightOffset: 20,
    zIndex: 9999,
    // Welcome message
    welcomeMessages: ['Привет! Меня зовут Adapto, я ИИ ассистент.'],
    // Trigger question
    triggerQuestion: 'Задать вопрос',
    triggerQuestionEnabled: 'no',
    triggerQuestionDelay: 5,
    triggerQuestionText: 'Здравствуйте! Если появится вопрос, можете задать его в чате, я оперативно отвечу',
    triggerQuickReply: 'Задать вопрос',
    // Follow up message
    followUpMessage: 'no',
    followUpDelay: 10,
    followUpQuestion: 'Продолжим диалог?',
    followUpQuickReply: 'Расскажи подробнее',
    // Quick replies
    quickReplies: ['Расскажи подробнее'],
    privacyPolicyUrl: 'https://',
    dataTags: ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'roistat_visit', 'gclid', 'fbclid'],
    excludedPages: []
  });

  // Menu items
  const menuItems = [
    { id: 'main', label: 'Главная', icon: () => <img src="/home.svg?v=2" alt="Главная" className="w-5 h-5" /> },
    { id: 'dashboard', label: 'Сводка', icon: BarChart3 },
    { id: 'dialogs', label: 'Диалоги', icon: MessageSquare },
    { id: 'knowledge', label: 'База знаний', icon: Database },
    { id: 'model-settings', label: 'Настройки модели', icon: Settings },
    { id: 'integrations', label: 'Интеграции', icon: Zap },
    { id: 'my-solo', label: 'Мой Adapto', icon: () => <img src="/mouse-square-menu.svg?v=3" alt="Мой Adapto" className="w-5 h-5" /> }
  ];

  // Notification function
  const showNotificationMessage = (message) => {
    setNotificationMessage(message);
    setShowNotification(true);
    setTimeout(() => setShowNotification(false), 3000);
  };

  // Проверка первого входа пользователя - только при регистрации
  useEffect(() => {
    if (isLoggedIn && currentUser) {
      const hasShownSetupWizard = localStorage.getItem('hasShownSetupWizard');
      const isNewUser = localStorage.getItem('isNewUser');
      
      // Показываем попап только если это новый пользователь и попап еще не показывался
      if (isNewUser === 'true' && !hasShownSetupWizard) {
        setIsFirstTimeUser(true);
        setShowSetupWizard(true);
        localStorage.removeItem('isNewUser'); // Убираем флаг нового пользователя
      }
    }
  }, [isLoggedIn, currentUser]);

  // Таймер для настройки модели
  useEffect(() => {
    let interval;
    if (showModelSetupProgress && modelSetupTimer > 0) {
      interval = setInterval(() => {
        setModelSetupTimer(prev => {
          if (prev <= 1) {
            setShowModelSetupProgress(false);
            setModelSetupTimer(300);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [showModelSetupProgress, modelSetupTimer]);

  // Функция для получения или создания пользователя
  const getOrCreateUser = async () => {
    if (!isLoggedIn || !currentUser) return null;
    
    try {
      // Создаем пользователя на основе данных из формы
      const userData = {
        email: currentUser.email || `user${currentUser.id}@example.com`,
        name: currentUser.name || `User ${currentUser.id}`,
        company_name: currentUser.company_name || '',
        phone: currentUser.phone || '',
        company_field: currentUser.company_field || ''
      };
      
      const user = await users.createOrGetUser(currentUser.id, userData);
      return user;
    } catch (error) {
      console.error('Error getting/creating user:', error);
      return null;
    }
  };

  // Загрузка данных из Supabase при инициализации
  useEffect(() => {
    const loadUserData = async () => {
      if (isLoggedIn && currentUser) {
        try {
          // Сначала тестируем подключение
          const connectionTest = await testConnection();
          console.log('Supabase connection test result:', connectionTest);
          
          if (!connectionTest) {
            console.warn('Supabase connection failed, using localStorage fallback');
            throw new Error('Connection failed');
          }

          // Получаем или создаем пользователя
          const user = await getOrCreateUser();
          if (!user) {
            console.warn('Failed to get/create user, using localStorage fallback');
            throw new Error('User creation failed');
          }

          // Загружаем корректировки из Supabase
          const corrections = await botCorrectionsAPI.getCorrections(currentUser.id);
          setBotCorrections(corrections.map(item => ({
            id: item.id,
            correction: item.correction,
            created_at: item.created_at
          })));

          // Загружаем элементы базы знаний из Supabase
          const knowledgeItems = await knowledgeBase.getKnowledgeItems(currentUser.id);
          setKnowledgeItems(knowledgeItems);
          setHasKnowledgeBase(knowledgeItems.length > 0);

          // Загружаем историю чата из Supabase
          try {
            console.log('Loading chat history for user:', currentUser.id);
            const chatHistoryData = await supabaseClient.chatHistory.getChatHistory(currentUser.id);
            console.log('Loaded chat history:', chatHistoryData);
            if (chatHistoryData && chatHistoryData.length > 0) {
              const formattedHistory = chatHistoryData.map(item => ({
                type: item.message_type,
                text: item.message_content
              }));
              console.log('Formatted chat history:', formattedHistory);
              setChatHistory(formattedHistory);
            } else {
              console.log('No chat history found, using default welcome message');
              // Если истории нет, используем приветственное сообщение
              setChatHistory([
                { type: 'assistant', text: 'Привет! Я ваш ИИ-ассистент Adapto. Как дела?' }
              ]);
            }
          } catch (error) {
            console.error('Error loading chat history:', error);
            // Fallback к приветственному сообщению
            setChatHistory([
              { type: 'assistant', text: 'Привет! Я ваш ИИ-ассистент Adapto. Как дела?' }
            ]);
          }
        } catch (error) {
          console.error('Error loading user data:', error);
          // Fallback к localStorage если Supabase недоступен
          const savedCorrections = localStorage.getItem(`botCorrections_${currentUser.id}`);
          if (savedCorrections) {
            setBotCorrections(JSON.parse(savedCorrections));
          }

          const savedKnowledgeItems = localStorage.getItem(`knowledgeItems_${currentUser.id}`);
          if (savedKnowledgeItems) {
            const items = JSON.parse(savedKnowledgeItems);
            setKnowledgeItems(items);
            setHasKnowledgeBase(items.length > 0);
          }

          // Fallback: загружаем историю чата из localStorage
          const savedChatHistory = localStorage.getItem(`chatHistory_${currentUser.id}`);
          if (savedChatHistory) {
            setChatHistory(JSON.parse(savedChatHistory));
          } else {
            setChatHistory([
              { type: 'assistant', text: 'Привет! Я ваш ИИ-ассистент Adapto. Как дела?' }
            ]);
          }
        }
      }
    };

    loadUserData();
  }, [isLoggedIn, currentUser]);

  // Сохранение данных при изменении
  useEffect(() => {
    if (isLoggedIn && currentUser) {
      localStorage.setItem(`botCorrections_${currentUser.id}`, JSON.stringify(botCorrections));
    }
  }, [botCorrections, isLoggedIn, currentUser]);

  useEffect(() => {
    if (isLoggedIn && currentUser) {
      localStorage.setItem(`knowledgeItems_${currentUser.id}`, JSON.stringify(knowledgeItems));
      setHasKnowledgeBase(knowledgeItems.length > 0);
    }
  }, [knowledgeItems, isLoggedIn, currentUser]);

  useEffect(() => {
    if (isLoggedIn && currentUser) {
      localStorage.setItem(`chatHistory_${currentUser.id}`, JSON.stringify(chatHistory));
    }
  }, [chatHistory, isLoggedIn, currentUser]);

  // Загрузка сохраненных настроек модели при входе пользователя
  useEffect(() => {
    if (isLoggedIn && currentUser) {
      loadModelSettings(currentUser.id).then(savedSettings => {
        if (savedSettings) {
          setSetupData(prevData => ({
            ...prevData,
            ...savedSettings
          }));
          console.log('Загружены сохраненные настройки модели:', savedSettings);
        }
      }).catch(error => {
        console.error('Ошибка загрузки настроек модели:', error);
      });
    }
  }, [isLoggedIn, currentUser]);

  // Auth functions
  const handleLogin = async (userData) => {
    try {
      const userWithId = { ...userData, id: Date.now() };
      setCurrentUser(userWithId);
      setIsLoggedIn(true);
      setActiveSection('dashboard');
      localStorage.setItem('currentUser', JSON.stringify(userWithId));
      localStorage.setItem('isLoggedIn', 'true');
      localStorage.setItem('currentSection', 'dashboard');
      showNotificationMessage('Успешный вход в систему!');
    } catch (error) {
      console.error('Login error:', error);
    }
  };

  const handleLoginSubmit = async (e) => {
    e.preventDefault();
    setFormErrors({});

    if (!formData.email || !formData.password) {
      setFormErrors({ general: 'Пожалуйста, заполните все поля' });
      return;
    }

    await handleLogin(formData);
  };

  const handleRegisterSubmit = async (e) => {
    e.preventDefault();
    setFormErrors({});

    // Валидация телефона
    const phoneError = validatePhone(formData.phone);
    if (phoneError) {
      setValidationErrors({ ...validationErrors, phone: phoneError });
      return;
    }

    const userData = {
      name: formData.name,
      company_name: formData.company,
      email: formData.email,
      phone: formData.phone,
      id: 'user-' + Date.now()
    };

    setCurrentUser(userData);
    setIsLoggedIn(true);
    setActiveSection('dashboard');
    localStorage.setItem('currentUser', JSON.stringify(userData));
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('currentSection', 'dashboard');
    localStorage.setItem('isNewUser', 'true'); // Флаг нового пользователя
    showNotificationMessage('Регистрация успешна! Добро пожаловать в Adapto!');
    setFormData({ email: '', password: '', name: '', company: '', phone: '', companyField: '' });
    setValidationErrors({});
  };

  const handleLogout = () => {
    setIsLoggedIn(false);
    setCurrentUser(null);
    setActiveSection('my-solo');
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('currentUser');
    localStorage.removeItem('currentSection');
    showNotificationMessage('Вы вышли из системы');
  };

  // Chat functions
  const handleSendMessage = async () => {
    if (!currentMessage.trim()) return;
    
    const newMessage = { type: 'user', text: currentMessage };
    setChatHistory(prev => [...prev, newMessage]);
    const userMessage = currentMessage;
    setCurrentMessage('');
    
    try {
      // Показываем индикатор загрузки
      const loadingMessage = { type: 'assistant', text: 'Обрабатываю ваш запрос...' };
      setChatHistory(prev => [...prev, loadingMessage]);
      
      // Отправляем запрос к GigaChat через наш backend
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: userMessage,
          conversationHistory: chatHistory,
          agentId: currentUser?.id
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      const assistantResponse = data.response || data.message || 'Извините, произошла ошибка.';
      
      // Удаляем сообщение загрузки и добавляем ответ
      setChatHistory(prev => {
        const withoutLoading = prev.filter(msg => msg.text !== 'Обрабатываю ваш запрос...');
        return [...withoutLoading, { type: 'assistant', text: assistantResponse }];
      });
      
      // Сохраняем сообщения в Supabase
      if (currentUser?.id) {
        try {
          console.log('Saving user message to Supabase:', { userId: currentUser.id, message: userMessage });
          await supabaseClient.chatHistory.saveMessage(currentUser.id, 'user', userMessage);
          console.log('Saving assistant message to Supabase:', { userId: currentUser.id, message: assistantResponse });
          await supabaseClient.chatHistory.saveMessage(currentUser.id, 'assistant', assistantResponse);
          console.log('Chat messages saved successfully');
        } catch (error) {
          console.error('Error saving chat messages to Supabase:', error);
        }
      }
      
    } catch (error) {
      console.error('Error sending message:', error);
      
      // Удаляем сообщение загрузки и добавляем сообщение об ошибке
      setChatHistory(prev => {
        const withoutLoading = prev.filter(msg => msg.text !== 'Обрабатываю ваш запрос...');
        return [...withoutLoading, { type: 'assistant', text: 'Извините, произошла ошибка при обработке вашего сообщения.' }];
      });
    }
  };

  const handleBotCorrection = async () => {
    if (!botCorrection.trim() || !currentUser) return;
    
    try {
      const success = await botCorrectionsAPI.addCorrection(currentUser.id, botCorrection);
      if (success) {
        const newCorrection = {
          id: Date.now(),
          correction: botCorrection,
          created_at: new Date().toISOString()
        };
        setBotCorrections(prev => [...prev, newCorrection]);
        setBotCorrection('');
        showNotificationMessage('Корректировка добавлена!');
      } else {
        showNotificationMessage('Ошибка при добавлении корректировки');
      }
    } catch (error) {
      console.error('Error adding correction:', error);
      showNotificationMessage('Ошибка при добавлении корректировки');
    }
  };

  const removeCorrection = async (index) => {
    try {
      console.log('Removing correction at index:', index);
      const correctionToRemove = botCorrections[index];
      console.log('Correction to remove:', correctionToRemove);
      
      if (correctionToRemove && correctionToRemove.id) {
        console.log('Deleting correction with ID:', correctionToRemove.id);
        const success = await botCorrectionsAPI.deleteCorrection(correctionToRemove.id);
        console.log('Delete result:', success);
        
        if (success) {
          setBotCorrections(prev => prev.filter((_, i) => i !== index));
          showNotificationMessage('Корректировка удалена');
        } else {
          showNotificationMessage('Ошибка при удалении корректировки');
        }
      } else {
        console.log('No ID found, removing from local state only');
        // Если нет ID (локальная корректировка), просто удаляем из состояния
        setBotCorrections(prev => prev.filter((_, i) => i !== index));
        showNotificationMessage('Корректировка удалена');
      }
    } catch (error) {
      console.error('Error removing correction:', error);
      showNotificationMessage('Ошибка при удалении корректировки');
    }
  };

  // Knowledge base functions
  const handleAddKnowledgeItem = async (itemToAdd = null) => {
    console.log('handleAddKnowledgeItem called with:', itemToAdd);
    const item = itemToAdd || newKnowledgeItem;
    
    if (!item.content.trim()) {
      console.log('Item content is empty, returning');
      return;
    }

    try {
      console.log('Adding knowledge item...');
      if (!currentUser) {
        showNotificationMessage('Ошибка: пользователь не найден');
        return;
      }
      
      const knowledgeItem = {
        ...item,
        status: 'Обработка',
        created_at: new Date().toISOString()
      };

      // Добавляем элемент в базу данных
      const createdItem = await knowledgeBase.addKnowledgeItem(currentUser.id, knowledgeItem);
      if (!createdItem) {
        showNotificationMessage('Ошибка при добавлении элемента');
        return;
      }

      // Добавляем в локальное состояние с правильным ID
      const newItem = {
        ...createdItem,
        id: createdItem.id
      };
      setKnowledgeItems(prev => [...prev, newItem]);
      
      // Сбрасываем состояние только если это не из попапа
      if (!itemToAdd) {
        setNewKnowledgeItem({ type: 'text', content: '' });
      }
      
      showNotificationMessage('Элемент добавлен в базу знаний! Статус: Обработка');

      // Запускаем обработку через GigaChat
      processContentWithGigaChat(createdItem.id, item.content, item.type, currentUser.id);
    } catch (error) {
      console.error('Error adding knowledge item:', error);
      showNotificationMessage('Ошибка при добавлении элемента');
    }
  };

  // Функция для обработки контента через GigaChat
  const processContentWithGigaChat = async (itemId, content, contentType, userId) => {
    try {
      console.log('Starting GigaChat processing for item:', itemId);
      
      // Показываем уведомление о начале обработки
      showNotificationMessage('Начинаем обработку контента через ИИ...');
      
      // Отправляем в GigaChat
      const result = await processContent(content, contentType, userId);
      
      if (result.success) {
        // Обновляем статус в базе данных
        const updatedItem = await knowledgeBase.updateKnowledgeItemStatus(itemId, result.status);
        
        if (updatedItem) {
          // Обновляем в локальном состоянии
          setKnowledgeItems(prev => prev.map(item => 
            item.id === itemId 
              ? { ...item, status: result.status }
              : item
          ));
          
          showNotificationMessage('Контент успешно обработан ИИ! Статус: Загружено');
        } else {
          showNotificationMessage('Ошибка при обновлении статуса');
        }
      } else {
        // Обновляем статус на "Ошибка"
        await knowledgeBase.updateKnowledgeItemStatus(itemId, 'Ошибка');
        setKnowledgeItems(prev => prev.map(item => 
          item.id === itemId 
            ? { ...item, status: 'Ошибка' }
            : item
        ));
        
        showNotificationMessage('Ошибка обработки контента ИИ');
      }
    } catch (error) {
      console.error('Error processing content with GigaChat:', error);
      
      // Обновляем статус на "Ошибка"
      await knowledgeBase.updateKnowledgeItemStatus(itemId, 'Ошибка');
      setKnowledgeItems(prev => prev.map(item => 
        item.id === itemId 
          ? { ...item, status: 'Ошибка' }
          : item
      ));
      
      showNotificationMessage('Ошибка обработки контента ИИ');
    }
  };

  const handleDeleteKnowledgeItem = async (id) => {
    try {
      const success = await knowledgeBase.deleteKnowledgeItem(id);
      if (success) {
        setKnowledgeItems(prev => prev.filter(item => item.id !== id));
        showNotificationMessage('Элемент удален из базы знаний');
      } else {
        showNotificationMessage('Ошибка при удалении элемента');
      }
    } catch (error) {
      console.error('Error deleting knowledge item:', error);
      showNotificationMessage('Ошибка при удалении элемента');
    }
  };

  const validateUrl = (url) => {
    if (!url.trim()) return 'Поле обязательно для заполнения';
    try {
      new URL(url);
      return '';
    } catch {
      return 'Введите корректный URL (например: https://example.com)';
    }
  };

  const handleSitePopupOpen = () => {
    setShowSitePopup(true);
    setSiteUrl('');
    setSelectedPages(['']);
    setSiteUrlError('');
    setSelectedPagesErrors(['']);
    setSitePopupTab('full');
  };

  const handleSitePopupClose = () => {
    setShowSitePopup(false);
    setSiteUrl('');
    setSelectedPages(['']);
    setSiteUrlError('');
    setSelectedPagesErrors(['']);
  };

  const handleAddPage = () => {
    setSelectedPages(prev => [...prev, '']);
    setSelectedPagesErrors(prev => [...prev, '']);
  };

  const handleRemovePage = (index) => {
    setSelectedPages(prev => prev.filter((_, i) => i !== index));
    setSelectedPagesErrors(prev => prev.filter((_, i) => i !== index));
  };

  const handlePageChange = (index, value) => {
    setSelectedPages(prev => prev.map((page, i) => i === index ? value : page));
    const error = validateUrl(value);
    setSelectedPagesErrors(prev => prev.map((err, i) => i === index ? error : err));
  };

  const handleSiteUrlChange = (value) => {
    setSiteUrl(value);
    const error = validateUrl(value);
    setSiteUrlError(error);
  };

  const handleSiteImport = async () => {
    console.log('handleSiteImport called');
    console.log('sitePopupTab:', sitePopupTab);
    console.log('siteUrl:', siteUrl);
    console.log('selectedPages:', selectedPages);
    
    if (sitePopupTab === 'full') {
      const error = validateUrl(siteUrl);
      if (error) {
        setSiteUrlError(error);
        return;
      }
      // Добавляем весь сайт
      const newItem = {
        type: 'site',
        content: siteUrl,
        status: 'Обработка'
      };
      console.log('Adding full site item:', newItem);
      await handleAddKnowledgeItem(newItem);
    } else {
      // Проверяем все страницы
      const errors = selectedPages.map(page => validateUrl(page));
      setSelectedPagesErrors(errors);
      
      if (errors.some(error => error)) return;
      
      const validPages = selectedPages.filter(page => page.trim());
      if (validPages.length === 0) return;
      
      for (const page of validPages) {
        const newItem = {
          type: 'site',
          content: page,
          status: 'Обработка'
        };
        console.log('Adding page item:', newItem);
        await handleAddKnowledgeItem(newItem);
      }
    }
    handleSitePopupClose();
  };

  // Feed popup functions
  const handleFeedPopupOpen = () => {
    setShowFeedPopup(true);
    setFeedUrl('');
    setFeedUrlError('');
  };

  const handleFeedPopupClose = () => {
    setShowFeedPopup(false);
    setFeedUrl('');
    setFeedUrlError('');
  };

  const handleFeedUrlChange = (value) => {
    setFeedUrl(value);
    const error = validateUrl(value);
    setFeedUrlError(error);
  };

  const handleFeedImport = async () => {
    const error = validateUrl(feedUrl);
    if (error) {
      setFeedUrlError(error);
      return;
    }
    
    const newItem = {
      type: 'feed',
      content: feedUrl,
      status: 'Обработка'
    };
    await handleAddKnowledgeItem(newItem);
    handleFeedPopupClose();
  };

  // File popup functions
  const handleFilePopupOpen = () => {
    setShowFilePopup(true);
    setSelectedFiles([]);
    setUploadedFiles([]);
  };

  const handleFilePopupClose = () => {
    setShowFilePopup(false);
    setSelectedFiles([]);
    setUploadedFiles([]);
  };

  const handleFileSelect = (event) => {
    const files = Array.from(event.target.files);
    setSelectedFiles(files);
  };

  const handleFileUpload = async () => {
    if (selectedFiles.length === 0) return;
    
    for (const file of selectedFiles) {
      const newItem = {
        type: 'file',
        content: file.name,
        status: 'Обработка'
      };
      await handleAddKnowledgeItem(newItem);
    }
    handleFilePopupClose();
  };

  const handleRemoveFile = (index) => {
    setSelectedFiles(prev => prev.filter((_, i) => i !== index));
  };

  // Text popup functions
  const handleTextPopupOpen = () => {
    setShowTextPopup(true);
    setTextContent('');
    setTextContentError('');
  };

  const handleTextPopupClose = () => {
    setShowTextPopup(false);
    setTextContent('');
    setTextContentError('');
  };

  const handleTextContentChange = (value) => {
    setTextContent(value);
    if (!value.trim()) {
      setTextContentError('Поле обязательно для заполнения');
    } else {
      setTextContentError('');
    }
  };

  const handleTextImport = async () => {
    if (!textContent.trim()) {
      setTextContentError('Поле обязательно для заполнения');
      return;
    }
    
    const newItem = {
      type: 'text',
      content: textContent,
      status: 'Обработка'
    };
    await handleAddKnowledgeItem(newItem);
    handleTextPopupClose();
  };

  // Integration functions
  const handleIntegrationClick = (integration) => {
    setSelectedIntegration(integration);
    setShowIntegrationModal(true);
  };

  // Widget functions
  const handleShowWidgetConstructor = () => {
    setShowWidgetConstructor(true);
  };

  // Функции для интеграций
  const handleInstallIntegration = (integration) => {
    if (integration.id === 'widget') {
      setShowWidgetConstructor(true);
    } else {
      setSelectedIntegration(integration);
      setShowIntegrationModal(true);
    }
  };

  const handleUninstallIntegration = (integration) => {
    setIntegrationToUninstall(integration);
    setShowUninstallModal(true);
  };

  const confirmUninstall = () => {
    if (integrationToUninstall) {
      setIntegrations(prev => prev.map(item => 
        item.id === integrationToUninstall.id 
          ? { ...item, installed: false }
          : item
      ));
      setShowUninstallModal(false);
      setIntegrationToUninstall(null);
      showNotificationMessage('Интеграция удалена');
    }
  };

  const handleIntegrationSuccess = (integrationId) => {
    setIntegrations(prev => prev.map(item => 
      item.id === integrationId 
        ? { ...item, installed: true }
        : item
    ));
    setShowIntegrationModal(false);
    setSelectedIntegration(null);
    showNotificationMessage('Интеграция успешно установлена!');
  };

  // Render functions
  const renderContent = () => {
    switch (activeSection) {
              case 'main':
  return (
            <div className="bg-white rounded-[20px] p-8" style={{ paddingTop: '180px', paddingBottom: '200px' }}>
              {/* Приветствие */}
              <div className="text-center mb-[30px]">
                <img src="/main-icon.svg" alt="Adapto" className="w-[53px] h-[53px] mx-auto mb-[30px]" />
                <h2 className="text-[30px] font-semibold text-[#070F1A] mb-4">
                  Добрый день, {currentUser?.name || 'Илья'}! С чего начнем?
                </h2>
                <p className="text-[#647491] text-[14px]">
                  Выберите действие для продолжения работы с платформой
                </p>
            </div>

                                    {/* Кнопки действий */}
            <div className="flex flex-col items-center space-y-[10px] justify-center">
              {/* Первый ряд: 3 кнопки */}
              <div className="flex space-x-[10px]">
                <div className="w-[168px] h-[40px] bg-[#096EFD]/3 border border-[#096EFD]/15 rounded-[90px] flex items-center cursor-pointer hover:bg-[#096EFD]/5 transition-colors" onClick={() => setActiveSection('dashboard')} style={{ paddingLeft: '8px' }}>
                  <img src="/group-30.svg" alt="Сводка" className="w-6 h-6" style={{ marginRight: '8px' }} />
                  <span className="text-[14px] font-[400] text-[#070F1A]" style={{ letterSpacing: '-0.02em' }}>Смотреть сводку</span>
                </div>
                
                <div className="w-[203px] h-[40px] bg-[#FF900D]/3 border border-[#FF900D]/15 rounded-[90px] flex items-center cursor-pointer hover:bg-[#FF900D]/5 transition-colors" onClick={() => setActiveSection('knowledge')} style={{ paddingLeft: '8px' }}>
                  <img src="/group-31.svg" alt="База знаний" className="w-6 h-6" style={{ marginRight: '8px' }} />
                  <span className="text-[14px] font-[400] text-[#070F1A]" style={{ letterSpacing: '-0.02em' }}>Перейти в базу знаний</span>
                      </div>
                
                <div className="w-[157px] h-[40px] bg-[#169B46]/3 border border-[#169B46]/15 rounded-[90px] flex items-center cursor-pointer hover:bg-[#169B46]/5 transition-colors" onClick={() => setActiveSection('dialogs')} style={{ paddingLeft: '8px' }}>
                  <img src="/group-34.svg" alt="Диалоги" className="w-6 h-6" style={{ marginRight: '8px' }} />
                  <span className="text-[14px] font-[400] text-[#070F1A]" style={{ letterSpacing: '-0.02em' }}>Читать диалоги</span>
                    </div>
                  </div>
              
              {/* Второй ряд: 2 кнопки */}
              <div className="flex space-x-[10px]">
                <div className="w-[178px] h-[40px] bg-[#8B09FD]/3 border border-[#8B09FD]/15 rounded-[90px] flex items-center cursor-pointer hover:bg-[#8B09FD]/5 transition-colors" onClick={() => setActiveSection('model-settings')} style={{ paddingLeft: '8px' }}>
                  <img src="/group-33.svg" alt="Настройки модели" className="w-6 h-6" style={{ marginRight: '8px' }} />
                  <span className="text-[14px] font-[400] text-[#070F1A]" style={{ letterSpacing: '-0.02em' }}>Настройки модели</span>
                </div>
                
                <div className="w-[246px] h-[40px] bg-[#E53E3E]/3 border border-[#E53E3E]/15 rounded-[90px] flex items-center cursor-pointer hover:bg-[#E53E3E]/5 transition-colors" style={{ paddingLeft: '8px' }}>
                  <img src="/group-32.svg" alt="Поддержка" className="w-6 h-6" style={{ marginRight: '8px' }} />
                  <span className="text-[14px] font-[400] text-[#070F1A]" style={{ letterSpacing: '-0.02em' }}>Обратиться в тех.поддержку</span>
              </div>
              </div>
            </div>
                </div>
        );

      case 'my-solo':
        return (
          <div className="space-y-6">
            {/* Заголовок и описание */}
            <h1 className="text-[24px] font-[500] text-[#070F1A]">Мой Adapto</h1>
            <p className="text-[#647491] text-[14px]" style={{ marginTop: '12px' }}>
              Проверьте своего бота на знание скрипта и информации о вашей компании
            </p>

            {/* Два контейнера */}
            <div className="flex gap-[10px]">
              {/* Левый контейнер - поле для правок */}
              <div className="flex-1 bg-white rounded-[20px] flex flex-col" style={{ marginLeft: '-15px', marginRight: '0px', padding: '16px 16px 0px 16px' }}>
                {/* Предупреждение - показывается только если база знаний пуста */}
                {!hasKnowledgeBase && (
                  <div className="bg-[#FFF8F8] border border-[#FF0D0D]/15 rounded-[18px] p-[15px] mb-6">
                    <div className="flex items-start gap-[11px]">
                      <img src="/alarm.svg" alt="Предупреждение" className="w-4 h-4 flex-shrink-0" />
                      <div className="flex-1">
                        <h3 className="text-[#FF0D0D] font-[500] text-base mb-[11px]">Предупреждение</h3>
                        <div className="flex items-center justify-between">
                          <p className="text-[#916464] text-sm flex-1 mr-4">
                            Вы не загрузили ничего в вашу базу знаний, ИИ-бот не готов к полноценной работе и будет отвечать некорректно!
                          </p>
                          <button className="text-[#FF0D0D] font-[500] text-sm px-4 h-[40px] bg-[#FFDBDB] rounded-[12px] hover:bg-[#FFE0E0] transition-colors flex items-center flex-shrink-0">
                            Перейти в базу знаний
                          </button>
                        </div>
                      </div>
                  </div>
                </div>
                )}

                {/* Секция с корректировками */}
                <div className="flex-1 space-y-3 mb-6">
                  {botCorrections.map((correction, index) => {
                    const correctionText = correction.correction || correction;
                    const textLength = correctionText.length;
                    const isShortText = textLength <= 50; // Примерная оценка для одной строки
                    
                    return (
                      <div key={index} className="bg-white rounded-[18px] border border-[#070F1A]/10 p-4">
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center gap-3">
                            <div className="w-[34px] h-[34px] bg-[#F3F8FF] rounded-[7px] flex items-center justify-center">
                              <span className="text-[#096EFD] font-[500] text-[14px]">{index + 1}</span>
                            </div>
                            <h3 className="text-[16px] font-[500] text-[#070F1A]">Корректировка</h3>
                          </div>
                          <button 
                            onClick={() => removeCorrection(index)}
                            className="w-[24px] h-[24px] bg-[#F3F5F7] rounded-[6px] flex items-center justify-center hover:bg-[#F3F5F7]/80 transition-colors"
                          >
                            <img src="/trash-icon.svg" alt="Удалить" className="w-[12px] h-[12px]" />
                          </button>
                        </div>
                        
                        <div className={`bg-[#F6F6F6] rounded-[12px] px-4 ${
                          isShortText ? 'h-[40px] flex items-center' : 'py-3'
                        }`}>
                          <p className="text-[#647491] text-[14px] leading-relaxed">
                            {correctionText}
                          </p>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Поле для корректировок - внизу */}
                <div className="p-0">
                  <div className="mb-4">
                    <h3 className="text-[16px] font-[500] text-[#070F1A]">Корректировки</h3>
                    <p className="text-[13px] text-[#647491]">Если вы увидели ошибку в ответах – напишите правильный вариант здесь</p>
                  </div>
                  
                  <div className="relative">
                    <input 
                      type="text"
                      value={botCorrection}
                      onChange={(e) => setBotCorrection(e.target.value)}
                      placeholder="Нажмите, чтобы печатать"
                      className="w-full h-[48px] px-4 py-2 rounded-[90px] focus:outline-none focus:ring-2 focus:ring-blue-500 pr-[50px]"
                      style={{ 
                        border: '1px solid rgba(7, 15, 26, 0.1)', 
                        backgroundColor: '#FFFFFF',
                        color: '#070F1A',
                        fontSize: '14px'
                      }}
                      onKeyPress={(e) => e.key === 'Enter' && botCorrection.trim() && handleBotCorrection()}
                    />
                    <img 
                      src="/send-button2.svg" 
                      alt="Отправить" 
                      className={`absolute top-[5px] right-[5px] w-[38px] h-[38px] cursor-pointer transition-opacity ${
                        botCorrection.trim() ? 'opacity-100' : 'opacity-30 cursor-not-allowed'
                      }`}
                      onClick={botCorrection.trim() ? handleBotCorrection : undefined}
                    />
                  </div>
                </div>
              </div>

              {/* Правый контейнер - диалоговое окно */}
              <div className="w-[400px] bg-[#070F1A] rounded-[20px] p-4 flex flex-col" style={{ marginLeft: '15px', marginRight: '0px', height: '583px', flexShrink: 0 }}>
                {/* Заголовок "Тестирование Адапто" */}
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2">
                    <img src="/logo-testing.svg" alt="Тест" className="w-5 h-5" />
                    <h2 className="text-[18px] font-[500] text-white">Тестирование Адапто</h2>
  </div>
                  <button 
                    onClick={async () => {
                      if (currentUser?.id) {
                        try {
                          await supabaseClient.chatHistory.clearChatHistory(currentUser.id);
                          setChatHistory([
                            { type: 'assistant', text: 'Привет! Я ваш ИИ-ассистент Adapto. Как дела?' }
                          ]);
                          showNotificationMessage('История чата очищена');
                        } catch (error) {
                          console.error('Error clearing chat history:', error);
                          showNotificationMessage('Ошибка при очистке истории');
                        }
                      }
                    }}
                    className="text-white text-xs px-2 py-1 rounded hover:bg-white/10 transition-colors"
                    title="Очистить историю"
                  >
                    Очистить
                  </button>
                </div>

                {/* Диалог */}
                <div className="flex-1 flex flex-col">
                  {/* История диалога */}
                  <div className="flex-1 space-y-4 overflow-y-auto mb-4">
                    {/* Плашка "Сегодня" */}
                    <div className="text-center">
                      <span className="bg-gray-100 text-gray-600 text-xs px-3 py-1 rounded-full">Сегодня</span>
                    </div>
                    
                        {chatHistory.map((message, index) => (
                      <div key={index} className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'} items-end gap-3`}>
                        {message.type === 'assistant' && (
                          <div className="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style={{ background: 'linear-gradient(135deg, #52AEFF 0%, #096EFD 100%)' }}>
                            <span className="text-white text-xs font-medium">AI</span>
  </div>
                        )}
                        <div className={`max-w-[70%] p-3 text-[14px] ${
                              message.type === 'user' 
                            ? 'bg-blue-600 text-white rounded-[20px] rounded-br-[4px]' 
                            : 'bg-[#DBE9FF] text-[#070F1A] rounded-[20px] rounded-bl-[4px]'
                            }`}>
                              {message.text}
                            </div>
                        {message.type === 'user' && (
                          <div className="w-8 h-8 bg-[#5BE5F7] rounded-full flex items-center justify-center flex-shrink-0">
                            <span className="text-white text-xs font-medium">Я</span>
                          </div>
                        )}
                          </div>
                        ))}
                      </div>
                  
                  {/* Поле ввода */}
                  <div className="relative">
                    <input 
                      type="text"
                      value={currentMessage}
                      onChange={(e) => setCurrentMessage(e.target.value)}
                      placeholder="Нажмите, чтобы печатать"
                      className="w-full h-[48px] px-4 py-2 rounded-[90px] focus:outline-none focus:ring-2 focus:ring-blue-500 pr-[50px]"
                      style={{ 
                        border: '1px solid rgba(255, 255, 255, 0.1)', 
                        backgroundColor: '#070F1A',
                        color: '#FFFFFF',
                        fontSize: '14px'
                      }}
                      onKeyPress={(e) => e.key === 'Enter' && currentMessage.trim() && handleSendMessage()}
                    />
                    <img 
                      src="/send-button2.svg" 
                      alt="Отправить" 
                      className={`absolute top-[5px] right-[5px] w-[38px] h-[38px] cursor-pointer transition-opacity ${
                        currentMessage.trim() ? 'opacity-100' : 'opacity-30 cursor-not-allowed'
                      }`}
                      onClick={currentMessage.trim() ? handleSendMessage : undefined}
                    />
                  </div>
                  </div>
            </div>
          </div>
          </div>
        );

      case 'knowledge':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[24px] font-[500]">База знаний</h1>
            </div>

            {/* Таблица с данными или пустое состояние */}
            {knowledgeItems.length > 0 ? (
              <div className="bg-white rounded-[20px] border border-[#070F1A]/10 overflow-hidden">
                {/* Заголовки таблицы */}
                <div className="grid grid-cols-4 gap-4 p-4 border-b border-[#070F1A]/10 bg-gray-50">
                  <div className="font-[400] text-[14px] text-[#647491]">Название</div>
                  <div className="font-[400] text-[14px] text-[#647491] text-center">Ресурс</div>
                  <div className="font-[400] text-[14px] text-[#647491]">Статус</div>
                  <div className="font-[400] text-[14px] text-[#647491]"></div>
                </div>

                {/* Строки таблицы */}
                <div className="divide-y divide-[#070F1A]/10">
                  {knowledgeItems.map((item, index) => (
                    <div key={item.id || index} className="grid grid-cols-4 gap-4 p-4 hover:bg-gray-50 transition-colors">
                      {/* Название */}
                      <div className="text-[#070F1A] text-sm truncate font-[500]">
                        {item.content.length > 50 ? `${item.content.substring(0, 50)}...` : item.content}
                      </div>
                      
                      {/* Ресурс */}
                      <div className="flex items-center justify-center">
                        <div className="h-[24px] px-2 rounded-[7px] bg-gray-100 flex items-center gap-[2px]">
                          <img 
                            src={
                              item.type === 'site' ? '/global2.svg' :
                              item.type === 'feed' ? '/document-code.svg' :
                              item.type === 'text' ? '/edit-2.svg' :
                              '/document-copy.svg'
                            }
                            alt={item.type}
                            className="w-[10px] h-[10px]"
                          />
                          <span className="text-[12px] font-[400] text-[#070F1A]">
                            {item.type === 'site' && 'Сайт'}
                            {item.type === 'feed' && 'Товарный фид'}
                            {item.type === 'text' && 'Текст'}
                            {item.type === 'file' && 'Файл'}
                          </span>
                        </div>
                      </div>
                      
                      {/* Статус */}
                      <div className="flex items-center">
                        <div className={`h-[24px] px-3 rounded-[50px] flex items-center ${
                          item.status === 'Загружено' ? 'bg-[#36C76A]/15 text-[#36C76A]' :
                          item.status === 'Обработка' ? 'bg-[#096EFD]/15 text-[#096EFD]' :
                          'bg-[#D12020]/15 text-[#D12020]'
                        }`}>
                          <span className="text-[12px] font-[400]">
                            {item.status}
                          </span>
                        </div>
                      </div>
                      
                      {/* Кнопка действий */}
                      <div className="flex justify-end">
                        <div className="relative dropdown-menu">
                          <button 
                            onClick={(e) => {
                              e.stopPropagation();
                              setSelectedKnowledgeItem(selectedKnowledgeItem?.id === item.id ? null : item);
                            }}
                            className="p-1 hover:bg-gray-100 rounded-full transition-colors"
                          >
                            <MoreVertical className="w-4 h-4 text-gray-500" />
                          </button>
                          
                          {selectedKnowledgeItem?.id === item.id && (
                            <div className="absolute right-0 top-8 bg-white border border-gray-200 rounded-[10px] shadow-lg z-10 min-w-[120px]">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleDeleteKnowledgeItem(item.id || index);
                                  setSelectedKnowledgeItem(null);
                                }}
                                className="w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 rounded-[10px] transition-colors flex items-center gap-2"
                              >
                                <Trash2 className="w-4 h-4" />
                                Удалить
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              /* Пустое состояние */
              <div className="bg-white rounded-[20px] border border-[#070F1A]/10 p-8 text-center">
                <div className="max-w-md mx-auto">
                  <h3 className="text-lg font-medium text-[#070F1A] mb-2">База знаний пока пуста</h3>
                  <p className="text-sm text-gray-500 mb-6">Добавьте первый ресурс, чтобы начать работу с Adapto</p>
                </div>
              </div>
            )}

            {/* Ресурсы для добавления */}
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
              {/* Веб-сайт */}
              <div 
                className={`border border-[#070F1A]/10 rounded-[18px] group hover:border-[#096EFD]/50 hover:-translate-y-[10px] transition-all duration-300 cursor-pointer overflow-hidden ${sidebarCollapsed ? 'h-[280px]' : 'h-[255px]'}`}
                onClick={handleSitePopupOpen}
              >
                <div className="w-full h-full flex flex-col">
                  <div className="w-full flex-shrink-0" style={{ borderRadius: '18px 18px 0 0' }}>
                    <img src="/Frame-18.svg" alt="Веб-сайт" className="w-full h-auto" />
  </div>
                  <div className="flex-1 p-[20px]">
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">Веб-сайт</h3>
                    <p className="text-[12px] text-[#647491]">Предоставьте ссылку на сайт, чтобы обеспечить ИИ знаниями</p>
                  </div>
                </div>
              </div>

              {/* Товарный фид */}
              <div 
                className={`border border-[#070F1A]/10 rounded-[18px] group hover:border-[#096EFD]/50 hover:-translate-y-[10px] transition-all duration-300 cursor-pointer overflow-hidden ${sidebarCollapsed ? 'h-[280px]' : 'h-[255px]'}`}
                onClick={handleFeedPopupOpen}
              >
                <div className="w-full h-full flex flex-col">
                  <div className="w-full flex-shrink-0" style={{ borderRadius: '18px 18px 0 0' }}>
                    <img src="/Frame-18-1.svg" alt="Товарный фид" className="w-full h-auto" />
                  </div>
                  <div className="flex-1 p-[20px]">
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">Товарный фид</h3>
                    <p className="text-[12px] text-[#647491]">Вставьте ссылку на товарный фид, чтобы ИИ изучил ваш каталог</p>
                  </div>
                </div>
              </div>

              {/* Файл */}
              <div 
                className={`border border-[#070F1A]/10 rounded-[18px] group hover:border-[#096EFD]/50 hover:-translate-y-[10px] transition-all duration-300 cursor-pointer overflow-hidden ${sidebarCollapsed ? 'h-[280px]' : 'h-[255px]'}`}
                onClick={handleFilePopupOpen}
              >
                <div className="w-full h-full flex flex-col">
                  <div className="w-full flex-shrink-0" style={{ borderRadius: '18px 18px 0 0' }}>
                    <img src="/Frame-18-2.svg" alt="Файл" className="w-full h-auto" />
                  </div>
                  <div className="flex-1 p-[20px]">
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">Файл</h3>
                    <p className="text-[12px] text-[#647491]">Импортируйте знания из документов или файлов для обучения ИИ</p>
                  </div>
                </div>
              </div>

              {/* Текст */}
              <div 
                className={`border border-[#070F1A]/10 rounded-[18px] group hover:border-[#096EFD]/50 hover:-translate-y-[10px] transition-all duration-300 cursor-pointer overflow-hidden ${sidebarCollapsed ? 'h-[280px]' : 'h-[255px]'}`}
                onClick={handleTextPopupOpen}
              >
                <div className="w-full h-full flex flex-col">
                  <div className="w-full flex-shrink-0" style={{ borderRadius: '18px 18px 0 0' }}>
                    <img src="/Frame-18-3.svg" alt="Текст" className="w-full h-auto" />
                  </div>
                  <div className="flex-1 p-[20px]">
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">Текст</h3>
                    <p className="text-[12px] text-[#647491]">Напишите текстом информацию, которую важно знать ИИ</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );

      case 'dashboard':
        return (
          <div className="space-y-6">
            {/* Заголовок с кнопками экспорта и календарем */}
            <div className="flex items-center justify-between">
              <h1 className="text-[24px] font-[500]">Сводка</h1>
              
              <div className="flex items-center gap-4">
                {/* Кнопки экспорта */}
                <div className="flex gap-2">
                  <button 
                    onClick={exportToXLS}
                    className="px-4 py-2 bg-[#096EFD] text-white rounded-[10px] text-sm font-medium hover:bg-[#096EFD]/90 transition-colors"
                  >
                    Экспорт XLS
                  </button>
                  <button 
                    onClick={exportToCSV}
                    className="px-4 py-2 bg-[#096EFD] text-white rounded-[10px] text-sm font-medium hover:bg-[#096EFD]/90 transition-colors"
                  >
                    Экспорт CSV
                  </button>
                </div>
                
                {/* Календарь */}
                <div className="relative">
                  <button 
                    onClick={() => setShowDatePicker(!showDatePicker)}
                    className="px-4 py-2 border border-[#070F1A]/10 rounded-[10px] text-sm font-medium hover:bg-[#F3F5F7] transition-colors flex items-center gap-2"
                  >
                    <Calendar className="w-4 h-4" />
                    {dateRange.startDate.toLocaleDateString('ru-RU')} - {dateRange.endDate.toLocaleDateString('ru-RU')}
                  </button>
                  
                  {showDatePicker && (
                    <div className="absolute top-full right-0 mt-2 bg-white border border-[#070F1A]/10 rounded-[10px] shadow-lg z-50 p-4 min-w-[300px]">
                      <div className="flex items-center justify-between mb-4">
                        <span className="text-sm font-medium">Выберите период</span>
                        <button onClick={() => setShowDatePicker(false)} className="text-gray-400 hover:text-gray-600">
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                      
                      <div className="space-y-2">
                        <button 
                          onClick={() => setPeriod('today')}
                          className={`w-full text-left px-3 py-2 text-sm rounded-[8px] transition-colors ${
                            selectedPeriod === 'today' 
                              ? 'bg-[#096EFD] text-white' 
                              : 'hover:bg-[#F3F5F7]'
                          }`}
                        >
                          Сегодня
                        </button>
                        <button 
                          onClick={() => setPeriod('yesterday')}
                          className={`w-full text-left px-3 py-2 text-sm rounded-[8px] transition-colors ${
                            selectedPeriod === 'yesterday' 
                              ? 'bg-[#096EFD] text-white' 
                              : 'hover:bg-[#F3F5F7]'
                          }`}
                        >
                          Вчера
                        </button>
                        <button 
                          onClick={() => setPeriod('last7days')}
                          className={`w-full text-left px-3 py-2 text-sm rounded-[8px] transition-colors ${
                            selectedPeriod === 'last7days' 
                              ? 'bg-[#096EFD] text-white' 
                              : 'hover:bg-[#F3F5F7]'
                          }`}
                        >
                          Последние 7 дней
                        </button>
                        <button 
                          onClick={() => setPeriod('thisMonth')}
                          className={`w-full text-left px-3 py-2 text-sm rounded-[8px] transition-colors ${
                            selectedPeriod === 'thisMonth' 
                              ? 'bg-[#096EFD] text-white' 
                              : 'hover:bg-[#F3F5F7]'
                          }`}
                        >
                          Этот месяц
                        </button>
                        <button 
                          onClick={() => setPeriod('last30days')}
                          className={`w-full text-left px-3 py-2 text-sm rounded-[8px] transition-colors ${
                            selectedPeriod === 'last30days' 
                              ? 'bg-[#096EFD] text-white' 
                              : 'hover:bg-[#F3F5F7]'
                          }`}
                        >
                          Последние 30 дней
                        </button>
                        <button 
                          onClick={() => setPeriod('last90days')}
                          className={`w-full text-left px-3 py-2 text-sm rounded-[8px] transition-colors ${
                            selectedPeriod === 'last90days' 
                              ? 'bg-[#096EFD] text-white' 
                              : 'hover:bg-[#F3F5F7]'
                          }`}
                        >
                          Последние 90 дней
                        </button>
                      </div>
                      
                      <div className="mt-4 pt-4 border-t border-[#070F1A]/10">
                        <p className="text-sm font-medium mb-3">Или выберите конкретные даты:</p>
                        <div className="grid grid-cols-2 gap-2 mb-4">
                          <div>
                            <label className="text-xs text-[#647491] mb-1 block">С</label>
                            <input 
                              type="date" 
                              value={dateRange.startDate.toISOString().split('T')[0]}
                              onChange={(e) => setDateRange({...dateRange, startDate: new Date(e.target.value)})}
                              className="w-full px-2 py-1 text-sm border border-[#070F1A]/10 rounded-[6px]"
                            />
                          </div>
                          <div>
                            <label className="text-xs text-[#647491] mb-1 block">По</label>
                            <input 
                              type="date" 
                              value={dateRange.endDate.toISOString().split('T')[0]}
                              onChange={(e) => setDateRange({...dateRange, endDate: new Date(e.target.value)})}
                              className="w-full px-2 py-1 text-sm border border-[#070F1A]/10 rounded-[6px]"
                            />
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <button 
                            onClick={() => {
                              setSelectedPeriod('custom');
                              setShowDatePicker(false);
                            }}
                            className="flex-1 px-3 py-2 bg-[#096EFD] text-white rounded-[8px] text-sm font-medium"
                          >
                            Применить
                          </button>
                          <button 
                            onClick={() => setShowDatePicker(false)}
                            className="flex-1 px-3 py-2 border border-[#070F1A]/10 rounded-[8px] text-sm font-medium"
                          >
                            Отмена
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
            
            {/* Метрики */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div className="bg-white rounded-[18px] p-5 border border-[#070F1A]/10">
                <div className="flex items-center justify-between mb-4">
                  <div className="w-[34px] h-[34px] bg-[#F3F8FF] rounded-[7px] flex items-center justify-center">
                    <MessageSquare className="w-[14px] h-[14px] text-[#096EFD]" style={{ strokeWidth: 1.7 }} />
                  </div>
                  <div className="text-right">
                    <div className="flex items-center gap-1 text-green-600 text-sm">
                      <TrendingUp className="w-4 h-4" />
                      <span>+12%</span>
                    </div>
                  </div>
                </div>
                <div>
                  <p className="text-[24px] font-[500] text-[#070F1A] mb-1">1,234</p>
                  <p className="text-[14px] text-[#647491]">Количество сообщений</p>
                </div>
              </div>

              <div className="bg-white rounded-[18px] p-5 border border-[#070F1A]/10">
                <div className="flex items-center justify-between mb-4">
                  <div className="w-[34px] h-[34px] bg-[#F0F9FF] rounded-[7px] flex items-center justify-center">
                    <User className="w-[14px] h-[14px] text-[#0EA5E9]" style={{ strokeWidth: 1.7 }} />
                  </div>
                  <div className="text-right">
                    <div className="flex items-center gap-1 text-green-600 text-sm">
                      <TrendingUp className="w-4 h-4" />
                      <span>+8%</span>
                    </div>
                  </div>
                </div>
                <div>
                  <p className="text-[24px] font-[500] text-[#070F1A] mb-1">567</p>
                  <p className="text-[14px] text-[#647491]">Количество диалогов</p>
                </div>
              </div>

              <div className="bg-white rounded-[18px] p-5 border border-[#070F1A]/10">
                <div className="flex items-center justify-between mb-4">
                  <div className="w-[34px] h-[34px] bg-[#FEF3C7] rounded-[7px] flex items-center justify-center">
                    <Clock className="w-[14px] h-[14px] text-[#F59E0B]" style={{ strokeWidth: 1.7 }} />
                  </div>
                  <div className="text-right">
                    <div className="flex items-center gap-1 text-green-600 text-sm">
                      <TrendingUp className="w-4 h-4" />
                      <span>+5%</span>
                    </div>
                  </div>
                </div>
                <div>
                  <p className="text-[24px] font-[500] text-[#070F1A] mb-1">2.3 сек</p>
                  <p className="text-[14px] text-[#647491]">Среднее время ответа</p>
                </div>
              </div>

              <div className="bg-white rounded-[18px] p-5 border border-[#070F1A]/10">
                <div className="flex items-center justify-between mb-4">
                  <div className="w-[34px] h-[34px] bg-[#F3E8FF] rounded-[7px] flex items-center justify-center">
                    <Eye className="w-[14px] h-[14px] text-[#A855F7]" style={{ strokeWidth: 1.7 }} />
                  </div>
                  <div className="text-right">
                    <div className="flex items-center gap-1 text-green-600 text-sm">
                      <TrendingUp className="w-4 h-4" />
                      <span>+25%</span>
                    </div>
                  </div>
                </div>
                <div>
                  <p className="text-[24px] font-[500] text-[#070F1A] mb-1">2,891</p>
                  <p className="text-[14px] text-[#647491]">Количество открытий виджета</p>
                </div>
              </div>

              <div className="bg-white rounded-[18px] p-5 border border-[#070F1A]/10">
                <div className="flex items-center justify-between mb-4">
                  <div className="w-[34px] h-[34px] bg-[#ECFDF5] rounded-[7px] flex items-center justify-center">
                    <FileText className="w-[14px] h-[14px] text-[#10B981]" style={{ strokeWidth: 1.7 }} />
                  </div>
                  <div className="text-right">
                    <div className="flex items-center gap-1 text-green-600 text-sm">
                      <TrendingUp className="w-4 h-4" />
                      <span>+18%</span>
                    </div>
                  </div>
                </div>
                <div>
                  <p className="text-[24px] font-[500] text-[#070F1A] mb-1">89</p>
                  <p className="text-[14px] text-[#070F1A]">Количество заявок</p>
                </div>
              </div>

              <div className="bg-white rounded-[18px] p-5 border border-[#070F1A]/10">
                <div className="flex items-center justify-between mb-4">
                  <div className="w-[34px] h-[34px] bg-[#FEF2F2] rounded-[7px] flex items-center justify-center">
                    <CheckCircle className="w-[14px] h-[14px] text-[#EF4444]" style={{ strokeWidth: 1.7 }} />
                  </div>
                  <div className="text-right">
                    <div className="flex items-center gap-1 text-green-600 text-sm">
                      <TrendingUp className="w-4 h-4" />
                      <span>+15%</span>
                    </div>
                  </div>
                </div>
                <div>
                  <p className="text-[24px] font-[500] text-[#070F1A] mb-1">92%</p>
                  <p className="text-[14px] text-[#647491]">Решенных вопросов</p>
                </div>
              </div>
            </div>

            {/* Графики */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white rounded-[18px] p-6 border border-[#070F1A]/10">
                <h3 className="text-[18px] font-[500] text-[#070F1A] mb-6">Активность по часам</h3>
                <div className="h-[300px] flex items-end justify-between gap-1">
                  {[
                    5, 3, 2, 1, 1, 2, 8, 15, 25, 35, 42, 48, 52, 55, 58, 60, 65, 70, 75, 80, 85, 90, 95, 100
                  ].map((height, i) => (
                    <div key={i} className="flex-1 bg-[#096EFD]/20 rounded-t-[4px] relative group">
                      <div 
                        className="bg-[#096EFD] rounded-t-[4px] transition-all duration-300 group-hover:bg-[#096EFD]/80" 
                        style={{height: `${height}%`}}
                      ></div>
                      <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-[10px] text-[#647491] opacity-0 group-hover:opacity-100 transition-opacity">
                        {i}:00
                      </div>
                    </div>
                  ))}
                </div>
                <div className="flex justify-between mt-8 text-[12px] text-[#647491]">
                  <span>0:00</span>
                  <span>6:00</span>
                  <span>12:00</span>
                  <span>18:00</span>
                  <span>23:00</span>
                </div>
              </div>

              <div className="bg-white rounded-[18px] p-6 border border-[#070F1A]/10">
                <h3 className="text-[18px] font-[500] text-[#070F1A] mb-6">Последние диалоги</h3>
                <div className="space-y-4">
                  {chatHistory.slice(-4).map((message, index) => (
                    <div key={index} className="flex items-center justify-between p-4 border border-[#070F1A]/5 rounded-[12px] hover:bg-[#F3F5F7] transition-colors">
                      <div className="flex items-center gap-3">
                        <div className={`w-2 h-2 rounded-full ${message.type === 'user' ? 'bg-green-500' : 'bg-blue-500'}`}></div>
                        <div>
                          <p className="font-medium text-[14px] text-[#070F1A]">
                            {message.type === 'user' ? 'Пользователь' : 'ИИ-агент'}
                          </p>
                          <p className="text-[12px] text-[#647491] truncate max-w-[200px]">{message.text}</p>
                        </div>
                      </div>
                      <span className="text-[12px] text-[#647491]">Только что</span>
                    </div>
                  ))}
                  {chatHistory.length === 0 && (
                    <div className="text-center py-8 text-[#647491]">
                      <MessageSquare className="w-8 h-8 mx-auto mb-2 opacity-50" />
                      <p className="text-sm">Диалогов пока нет</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );

      case 'integrations':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[24px] font-[500] text-[#070F1A]">Интеграции</h1>
            </div>

            <div className="grid grid-cols-3 gap-[20px]">
              {integrations.map((integration) => (
                <div 
                  key={integration.id}
                  className="border border-transparent rounded-[18px] p-[15px] group hover:border-[#070F1A]/10 transition-all duration-300"
                >
                  {/* Контент: иконка и текст в одной строке */}
                  <div className="flex items-start gap-[15px] mb-[25px]">
                    {/* Иконка */}
                    <div className="flex-shrink-0">
                      <img src={`/${integration.icon}`} alt={integration.name} className="w-[50px] h-[50px]" />
  </div>

                    {/* Заголовок и описание */}
                    <div className="flex-1">
                      <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">{integration.name}</h3>
                      <p className="text-[12px] text-[#647491]">{integration.description}</p>
                    </div>
                  </div>

                  {/* Кнопка подключения */}
                  <div className="w-full">
                    {integration.installed ? (
                      <button className="w-full h-[40px] border border-[#0084FF]/20 text-[#0084FF]/60 rounded-[12px] transition-colors hover:border-[#0084FF]/30 hover:text-[#0084FF]/80 text-[14px]">
                        Подключено
                      </button>
                    ) : (
                      <button
                        onClick={() => handleInstallIntegration(integration)}
                        className="w-full h-[40px] bg-[#0084FF] text-white rounded-[12px] hover:bg-[#0084FF]/90 transition-colors text-[14px]"
                      >
                        Подключить
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>
            
            {/* Примечание об Instagram */}
            <div className="mt-8 text-center">
              <p className="text-[12px] text-[#647491]">
                *Instagram является продуктом Meta – признанной в РФ экстремисткой организацией
              </p>
          </div>
          </div>
        );

      case 'model-settings':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[24px] font-[500] text-[#070F1A]">Настройки модели</h1>
            </div>



            {/* Шаг 1: Уточните цели Adapto */}
            <div className="mb-[50px]">
              <div className="flex items-center gap-[15px] mb-6">
                  <div className="w-[17px] h-[17px] bg-[#096EFD] rounded-full flex items-center justify-center">
                    <span className="text-white text-[10px] font-medium">1</span>
                  </div>
                  <div>
                  <h3 className="text-[18px] font-[500] text-[#070F1A] tracking-[-3%]">Уточните цели Adapto</h3>
                  <p className="text-[14px] text-[#647491] tracking-[-2%]">
                      Настройте основные цели и задачи вашего ИИ-агента
                    </p>
                  </div>
                </div>
              <div className="px-0 py-6">
                <div className="flex gap-6">
                  {/* Левая колонка: Какую роль должен выполнять бот? */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Какую роль должен выполнять бот?</h4>
                    <div className="flex gap-[10px]">
                    <button
                      onClick={() => setSetupData({...setupData, task: 'Продавать'})}
                        className={`w-[220px] h-[190px] rounded-[18px] transition-all overflow-hidden flex flex-col border ${
                        setupData.task === 'Продавать' 
                            ? 'bg-[#DBE9FF] border-[#096EFD]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                      }`}
                    >
                        <div className="w-full h-[144px] rounded-t-[18px] overflow-hidden">
                          <img src="/Frame-110.svg" alt="Продавец" className="w-full h-full object-cover object-top" />
                      </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                        {setupData.task === 'Продавать' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-full flex items-center justify-center">
                              <svg className="w-[13px] h-[14px] text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                          </div>
                        ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-full border border-[#070F1A]/10"></div>
                        )}
                        <span className="text-[14px] font-[500] text-[#070F1A]">Продавца</span>
                      </div>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, task: 'Консультировать'})}
                        className={`w-[220px] h-[190px] rounded-[18px] transition-all overflow-hidden flex flex-col border ${
                        setupData.task === 'Консультировать' 
                            ? 'bg-[#DBE9FF] border-[#096EFD]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                      }`}
                    >
                        <div className="w-full h-[144px] rounded-t-[18px] overflow-hidden">
                          <img src="/Frame-22.svg" alt="Консультант" className="w-full h-full object-cover object-top" />
                      </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                        {setupData.task === 'Консультировать' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-full flex items-center justify-center">
                              <svg className="w-[13px] h-[14px] text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                          </div>
                        ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-full border border-[#070F1A]/10"></div>
                        )}
                        <span className="text-[14px] font-[500] text-[#070F1A]">Консультанта</span>
                      </div>
                    </button>
                  </div>
                </div>
                
                  {/* Правая колонка: Какая главная цель ИИ-агента? */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Какая главная цель ИИ-агента?</h4>
                    <div className="grid grid-cols-2 gap-[10px]">
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: 'Записать на консультацию'})}
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.mainGoal === 'Записать на консультацию' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">Записать на консультацию</span>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: 'Продать продукт'})}
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.mainGoal === 'Продать продукт' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">Продать продукт</span>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: 'Помочь решить проблему'})}
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.mainGoal === 'Помочь решить проблему' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">Помочь решить проблему</span>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: 'custom'})}
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.mainGoal === 'custom' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">Другое</span>
                    </button>
                  </div>
                  {setupData.mainGoal === 'custom' && (
                      <div className="mt-[10px]">
                      <Input
                        placeholder="Введите вариант"
                          className="w-full h-[40px] rounded-[10px] border border-[#070F1A]/10 text-[14px] text-[#070F1A]/70"
                      />
                    </div>
                  )}
                  </div>
                </div>

                {/* Отступ между вопросами */}
                <div className="h-[20px]"></div>

                {/* 3. Какой цикл сделки в вашей компании? и 4. Целевая аудитория */}
                <div className="flex gap-6">
                  {/* Левая колонка: Какой цикл сделки */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Какой цикл сделки в вашей компании?</h4>
                  <Textarea 
                    value={setupData.dealCycle || ''}
                    onChange={(e) => setSetupData({...setupData, dealCycle: e.target.value})}
                    placeholder="Обычно наши клиенты сначала оставляют заявку, далее наш менеджер связывается с ними по телефону, подтверждают заявку и ведут дальше по воронке: Тут 2 пути, зависит от того на что оставили заявку, но если 1 путь, то отправляет декларацию на отправку груза, обычный срок у нас 7 дней..."
                      className="min-h-[124px] rounded-[10px] border border-[#070F1A]/10 text-[14px] text-[#070F1A]/70"
                  />
                </div>

                  {/* Правая колонка: Целевая аудитория */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Целевая аудитория</h4>
                  <Textarea 
                    value={setupData.targetAudience || ''}
                    onChange={(e) => setSetupData({...setupData, targetAudience: e.target.value})}
                    placeholder="Пол: Женщины Возраст: 18-45 Боль клиента: сложно найти подходящий размер"
                      className="min-h-[124px] rounded-[10px] border border-[#070F1A]/10 text-[14px] text-[#070F1A]/70"
                  />
                </div>
                </div>
              </div>
            </div>

            {/* Шаг 2: Правила общения */}
            <div className="mb-[50px]">
              <div className="flex items-center gap-[15px] mb-6">
                  <div className="w-[17px] h-[17px] bg-[#096EFD] rounded-full flex items-center justify-center">
                    <span className="text-white text-[10px] font-medium">2</span>
                  </div>
                  <div>
                  <h3 className="text-[18px] font-[500] text-[#070F1A] tracking-[-3%]">Правила общения</h3>
                  <p className="text-[14px] text-[#647491] tracking-[-2%]">
                      Настройте стиль общения и ограничения для вашего ИИ-агента
                    </p>
                  </div>
                </div>
              <div className="px-0 py-6">
                <div className="flex gap-6">
                  {/* Левая колонка: Обращение к пользователю */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Обращение к пользователю</h4>
                    <div className="grid grid-cols-2 gap-[10px]">
                    <button 
                      onClick={() => setSetupData({...setupData, addressing: 'Вы'})}
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.addressing === 'Вы' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">На "Вы"</span>
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, addressing: 'Ты'})}
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.addressing === 'Ты' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">На "Ты"</span>
                    </button>
                  </div>
                </div>

                  {/* Правая колонка: Стиль общения */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Стиль общения</h4>
                    <div className="grid grid-cols-2 gap-[10px]">
                    <button 
                      onClick={() => setSetupData({...setupData, communicationStyle: 'Дружелюбный'})} 
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.communicationStyle === 'Дружелюбный' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">😊 Дружелюбный</span>
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, communicationStyle: 'Нейтральный'})} 
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.communicationStyle === 'Нейтральный' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">😐 Нейтральный</span>
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, communicationStyle: 'Профессиональный'})} 
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.communicationStyle === 'Профессиональный' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">💼 Профессиональный</span>
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, communicationStyle: 'Человечный'})} 
                      className={`h-[40px] rounded-[10px] transition-all ${
                        setupData.communicationStyle === 'Человечный' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                    >
                        <span className="text-[14px] font-[500]">😄 Человечный</span>
                    </button>
                    </div>
                  </div>
                </div>

                {/* Отступ между вопросами */}
                <div className="h-[50px]"></div>

                {/* 3. Ограничения Адапто */}
                <div>
                  <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Ограничения Адапто</h4>
                  <div className="flex flex-wrap gap-2">
                    {[
                      'Не обсуждай цены',
                      'Не давай финансовых советов',
                      'Не обсуждай политику',
                      'Не обсуждай религиозные темы',
                      'Не превышай полномочия и не создавай новые обязательства компании',
                      'Не давай юридические консультации',
                      'Не подтверждай наличие товара или услуги',
                      'Не гарантируй результат',
                      'Не давай длинных ответов',
                      'Поясняй ссылки при их отправке',
                      'Используй молодежный сленг',
                      'Не осуждай предпочтения клиента',
                      'Не оказывай давление на клиента',
                      'Избегай споров',
                      'Отвечай от первого лица',
                      'Используй бытовой язык',
                      'Не давай технические советы'
                    ].map(restriction => (
                      <button
                        key={restriction}
                        onClick={() => {
                          const current = setupData.restrictions || [];
                          const newRestrictions = current.includes(restriction)
                            ? current.filter(r => r !== restriction)
                            : [...current, restriction];
                          setSetupData({...setupData, restrictions: newRestrictions});
                        }}
                        className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                          (setupData.restrictions || []).includes(restriction)
                            ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                            : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                        }`}
                      >
                        {restriction}
                      </button>
                    ))}
                    {/* Пользовательские табы для ограничений */}
                    {(setupData.restrictions || []).filter(restriction => 
                      !['Не обсуждай политику', 'Не обсуждай религиозные темы', 'Не превышай полномочия и не создавай новые обязательства компании', 'Не давай юридические консультации', 'Не подтверждай наличие товара или услуги', 'Не гарантируй результат', 'Не давай длинных ответов', 'Поясняй ссылки при их отправке', 'Используй молодежный сленг', 'Не осуждай предпочтения клиента', 'Не оказывай давление на клиента', 'Избегай споров', 'Отвечай от первого лица', 'Используй бытовой язык', 'Не давай технические советы'].includes(restriction)
                    ).map(restriction => (
                    <button
                        key={restriction}
                        onClick={() => {
                          const current = setupData.restrictions || [];
                          const newRestrictions = current.filter(r => r !== restriction);
                          setSetupData({...setupData, restrictions: newRestrictions});
                        }}
                        className="px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] border-[#0084FF] bg-[#0084FF] text-white"
                      >
                        {restriction}
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, showCustomRestriction: !setupData.showCustomRestriction})}
                      className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        setupData.showCustomRestriction
                          ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                          : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                    >
                      Другое
                    </button>
                  </div>
                  {setupData.showCustomRestriction && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customRestriction || ''}
                        onChange={(e) => setSetupData({...setupData, customRestriction: e.target.value})}
                        placeholder="Введите вариант"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customRestriction) {
                            const current = setupData.restrictions || [];
                            setSetupData({
                              ...setupData, 
                              restrictions: [...current, setupData.customRestriction],
                              customRestriction: '',
                              showCustomRestriction: false
                            });
                          }
                        }}
                        disabled={!setupData.customRestriction}
                        className="bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:bg-[#0084FF]/90"
                      >
                        Добавить
                      </Button>
                </div>
                  )}
              </div>

              {/* Отступ между вопросами */}
              <div className="h-[50px]"></div>

                {/* 5. Дополнительные настройки общения */}
                <div>
                  <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Дополнительные настройки общения</h4>
                  <div className="flex flex-wrap gap-2">
                    {[
                      'Не гарантировать результат',
                      'Пояснять ссылки перед отправкой',
                      'Проверять понимание ответа',
                      'Избегать длинных сообщений',
                      'Уточнять задачу в начале общения',
                      'Не оказывать давление на клиента',
                      'Предупреждать об ожидании ответа',
                      'Избегать споров',
                      'Отвечать от первого лица'
                    ].map(setting => (
                      <button
                        key={setting}
                        onClick={() => {
                          const current = setupData.communicationSettings || [];
                          const newSettings = current.includes(setting)
                            ? current.filter(s => s !== setting)
                            : [...current, setting];
                          setSetupData({...setupData, communicationSettings: newSettings});
                        }}
                        className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                          (setupData.communicationSettings || []).includes(setting)
                            ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                            : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                        }`}
                      >
                        {setting}
                      </button>
                    ))}
                    {/* Пользовательские табы для дополнительных настроек */}
                    {(setupData.communicationSettings || []).filter(setting => 
                      !['Не гарантировать результат', 'Пояснять ссылки перед отправкой', 'Проверять понимание ответа', 'Избегать длинных сообщений', 'Уточнять задачу в начале общения', 'Не оказывать давление на клиента', 'Предупреждать об ожидании ответа', 'Избегать споров', 'Отвечать от первого лица'].includes(setting)
                    ).map(setting => (
                      <button
                        key={setting}
                        onClick={() => {
                          const current = setupData.communicationSettings || [];
                          const newSettings = current.filter(s => s !== setting);
                          setSetupData({...setupData, communicationSettings: newSettings});
                        }}
                        className="px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] border-[#0084FF] bg-[#0084FF] text-white"
                      >
                        {setting}
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, showCustomCommunicationSetting: !setupData.showCustomCommunicationSetting})}
                      className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        setupData.showCustomCommunicationSetting
                          ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                          : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                    >
                      Другое
                    </button>
                  </div>
                  {setupData.showCustomCommunicationSetting && (
                    <div className="mt-3 flex gap-2">
                    <Input
                      value={setupData.customCommunicationSetting || ''}
                      onChange={(e) => setSetupData({...setupData, customCommunicationSetting: e.target.value})}
                        placeholder="Введите вариант"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customCommunicationSetting) {
                            const current = setupData.communicationSettings || [];
                            setSetupData({
                              ...setupData, 
                              communicationSettings: [...current, setupData.customCommunicationSetting],
                              customCommunicationSetting: '',
                              showCustomCommunicationSetting: false
                            });
                          }
                        }}
                        disabled={!setupData.customCommunicationSetting}
                        className="bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:bg-[#0084FF]/90"
                      >
                        Добавить
                      </Button>
                  </div>
                  )}
                </div>



                {/* Отступ между вопросами */}
                <div className="h-[50px]"></div>

                {/* 6. Уточнять или задавать вопрос клиенту, если: */}
                <div>
                  <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Уточнять или задавать вопрос клиенту</h4>
                  <div className="flex flex-wrap gap-2">
                    {[
                      'Если запрос неполный',
                      'Если клиент сомневается',
                      'Если есть риск ошибки',
                      'При выборе продукта или услуги',
                      'Если ответ зависит от тонкостей',
                      'Если клиент проявляет интерес к нескольким вариантам',
                      'Если клиент не понимает предложенное',
                      'Если требуется индивидуальный подбор',
                      'Если клиент задаёт вопросы вне своей компетенции',
                      'Если клиент спрашивает о вещах, которые требует специальных знаний',
                      'При оформлении заявки или заказа',
                      'Перед тем как оформить что-то важное',
                      'Если клиент долго молчит'
                    ].map(question => (
                      <button
                        key={question}
                        onClick={() => {
                          const current = setupData.clarificationQuestions || [];
                          const newQuestions = current.includes(question)
                            ? current.filter(q => q !== question)
                            : [...current, question];
                          setSetupData({...setupData, clarificationQuestions: newQuestions});
                        }}
                        className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                          (setupData.clarificationQuestions || []).includes(question)
                            ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                            : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                        }`}
                      >
                        {question}
                      </button>
                    ))}
                    {/* Пользовательские табы для уточняющих вопросов */}
                    {(setupData.clarificationQuestions || []).filter(question => 
                      !['Если запрос неполный', 'Если клиент сомневается', 'Если есть риск ошибки', 'При выборе продукта или услуги', 'Если ответ зависит от тонкостей', 'Если клиент проявляет интерес к нескольким вариантам', 'Если клиент не понимает предложенное', 'Если требуется индивидуальный подбор', 'Если клиент задаёт вопросы вне своей компетенции', 'Если клиент спрашивает о вещах, которые требует специальных знаний', 'При оформлении заявки или заказа', 'Перед тем как оформить что-то важное', 'Если клиент долго молчит'].includes(question)
                    ).map(question => (
                      <button
                        key={question}
                        onClick={() => {
                          const current = setupData.clarificationQuestions || [];
                          const newQuestions = current.filter(q => q !== question);
                          setSetupData({...setupData, clarificationQuestions: newQuestions});
                        }}
                        className="px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] border-[#0084FF] bg-[#0084FF] text-white"
                      >
                        {question}
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, showCustomClarificationQuestion: !setupData.showCustomClarificationQuestion})}
                      className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        setupData.showCustomClarificationQuestion
                          ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                          : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                    >
                      Другое
                    </button>
                  </div>
                  {setupData.showCustomClarificationQuestion && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customClarificationQuestion || ''}
                        onChange={(e) => setSetupData({...setupData, customClarificationQuestion: e.target.value})}
                        placeholder="Введите вариант"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customClarificationQuestion) {
                            const current = setupData.clarificationQuestions || [];
                            setSetupData({
                              ...setupData, 
                              clarificationQuestions: [...current, setupData.customClarificationQuestion],
                              customClarificationQuestion: '',
                              showCustomClarificationQuestion: false
                            });
                          }
                        }}
                        disabled={!setupData.customClarificationQuestion}
                        className="bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:bg-[#0084FF]/90"
                      >
                        Добавить
                      </Button>
                    </div>
                  )}
                </div>

                {/* Отступ между вопросами */}
                <div className="h-[50px]"></div>

                {/* 7. Сбор данных и Количество эмодзи в общении */}
                <div className="flex gap-6">
                  {/* Левая колонка: Сбор данных */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Сбор данных</h4>
                    <div className="flex flex-wrap gap-2">
                    {[
                      'Имя',
                      'Номер телефона',
                      'Почта',
                      'Адрес доставки',
                      'Город',
                      'Возраст'
                    ].map(dataType => (
                      <button
                        key={dataType}
                        onClick={() => {
                          const current = setupData.dataCollection || [];
                          const newData = current.includes(dataType)
                            ? current.filter(d => d !== dataType)
                            : [...current, dataType];
                          // Если добавляем новый таб, то "Не собирать данные" должен быть деактивирован
                          setSetupData({...setupData, dataCollection: newData});
                        }}
                          className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                          (setupData.dataCollection || []).includes(dataType)
                              ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                              : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                        }`}
                      >
                        {dataType}
                      </button>
                    ))}
                    {/* Пользовательские табы */}
                    {(setupData.dataCollection || []).filter(dataType => 
                      !['Имя', 'Номер телефона', 'Почта', 'Адрес доставки', 'Город', 'Возраст'].includes(dataType)
                    ).map(dataType => (
                      <button
                        key={dataType}
                        onClick={() => {
                          const current = setupData.dataCollection || [];
                          const newData = current.filter(d => d !== dataType);
                          setSetupData({...setupData, dataCollection: newData});
                        }}
                        className="px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] border-[#0084FF] bg-[#0084FF] text-white"
                      >
                        {dataType}
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, dataCollection: []})}
                        className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        (setupData.dataCollection || []).length === 0
                            ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                            : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                    >
                      Не собирать данные
                    </button>
                    <button
                      onClick={() => {
                        // При активации "Добавить данные" деактивируем "Не собирать данные"
                        setSetupData({...setupData, showCustomData: !setupData.showCustomData});
                      }}
                      className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        setupData.showCustomData
                          ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                          : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                    >
                      Добавить данные
                    </button>
                  </div>
                  {setupData.showCustomData && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customData || ''}
                        onChange={(e) => setSetupData({...setupData, customData: e.target.value})}
                        placeholder="Ввести параметр"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customData) {
                            const current = setupData.dataCollection || [];
                            setSetupData({
                              ...setupData, 
                              dataCollection: [...current, setupData.customData],
                              customData: '',
                              showCustomData: false
                            });
                          }
                        }}
                        disabled={!setupData.customData}
                        className="bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:bg-[#0084FF]/90"
                      >
                        Добавить
                      </Button>
                    </div>
                  )}
                  </div>

                  {/* Правая колонка: Количество эмодзи в общении */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">Количество эмодзи в общении</h4>
                    <div className="flex gap-[10px]">
                      <button
                        onClick={() => setSetupData({...setupData, emojiUsage: 'Никогда'})}
                        className={`relative w-[178px] h-[190px] rounded-[18px] transition-all overflow-hidden flex flex-col border ${
                          setupData.emojiUsage === 'Никогда' 
                            ? 'bg-[#DBE9FF] border-[#0084FF]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                        }`}
                      >
                        <div className="w-full h-[144px] rounded-t-[18px] overflow-hidden">
                          <div className="w-full h-full bg-[#F3F5F7] flex items-center justify-center">
                            <img src="/Group 101.png?v=1" alt="Никогда" className="w-full h-full object-cover" />
                          </div>
                        </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                          {setupData.emojiUsage === 'Никогда' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-full flex items-center justify-center">
                              <svg className="w-[13px] h-[14px] text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                            </div>
                          ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-full border border-[#070F1A]/10"></div>
                          )}
                          <span className="text-[14px] font-[500] text-[#070F1A]">Никогда</span>
                        </div>
                      </button>
                      <button
                        onClick={() => setSetupData({...setupData, emojiUsage: 'Редко'})}
                        className={`relative w-[178px] h-[190px] rounded-[18px] transition-all overflow-hidden flex flex-col border ${
                          setupData.emojiUsage === 'Редко' 
                            ? 'bg-[#DBE9FF] border-[#0084FF]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                        }`}
                      >
                                                <div className="w-full h-[144px] rounded-t-[18px] overflow-hidden">
                          <div className="w-full h-full bg-[#F3F5F7] flex items-center justify-center">
                            <img src="/Group 98.png?v=1" alt="Редко" className="w-full h-full object-cover" />
                </div>
              </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                          {setupData.emojiUsage === 'Редко' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-full flex items-center justify-center">
                              <svg className="w-[13px] h-[14px] text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                            </div>
                          ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-full border border-[#070F1A]/10"></div>
                          )}
                          <span className="text-[14px] font-[500] text-[#070F1A]">Редко</span>
                        </div>
                      </button>
                      <button
                        onClick={() => setSetupData({...setupData, emojiUsage: 'Часто'})}
                        className={`relative w-[178px] h-[190px] rounded-[18px] transition-all overflow-hidden flex flex-col border ${
                          setupData.emojiUsage === 'Часто' 
                            ? 'bg-[#DBE9FF] border-[#0084FF]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                        }`}
                      >
                        <div className="w-full h-[144px] rounded-t-[18px] overflow-hidden">
                          <div className="w-full h-full bg-[#F3F5F7] flex items-center justify-center">
                            <img src="/Group 100.png?v=1" alt="Часто" className="w-full h-full object-cover" />
                          </div>
                        </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                          {setupData.emojiUsage === 'Часто' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-full flex items-center justify-center">
                              <svg className="w-[13px] h-[14px] text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                            </div>
                          ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-full border border-[#070F1A]/10"></div>
                          )}
                          <span className="text-[14px] font-[500] text-[#070F1A]">Часто</span>
                        </div>
                      </button>
                  </div>
                </div>
                </div>


              </div>
            </div>

            {/* Шаг 3: Этапы диалога */}
            <div className="mb-[50px]">
              <div className="flex items-center gap-[15px] mb-0">
                <div className="w-[17px] h-[17px] bg-[#096EFD] rounded-full flex items-center justify-center">
                  <span className="text-white text-[10px] font-medium">3</span>
                </div>
                <div>
                  <h3 className="text-[18px] font-[500] text-[#070F1A] tracking-[-3%]">Воронка продаж</h3>
                  <p className="text-[14px] text-[#647491] tracking-[-2%]">
                  Опишите детально этапы диалога для вашего ИИ-агента
                  </p>
                            </div>
              </div>
                <div className="px-0 py-6" style={{paddingTop: '0px !important'}}>
                <div className="h-[20px]"></div>
                <div className="bg-[#096EFD]/5 border border-[#096EFD]/30 rounded-[18px] p-4 mb-4">
                  <div className="flex items-start gap-[7px]">
                    <svg className="w-5 h-5 text-[#096EFD] flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <div>
                      <div className="font-medium text-[#0084FF] text-[16px] mb-[11px]">Уделите время детальному заполнению этапов вашей воронки</div>
                      <div className="text-[14px] text-[#647491]">
                        Подробное описание сильно улучшит качество ответов ИИ-агента, так как он будет понимать ваш скрипт и какие этапы проходит ваш клиент. У вас всегда будет возможность изменить воронку продаж и скрипт. Не запускайте тест ИИ-агента без изменений шаблона.
                          </div>
                      </div>
                    </div>
                </div>



                <div className="space-y-[10px]">
                  {(setupData.dialogStages || [
                    'Поздоровайся и спроси имя клиента. Уточни его проблему и пойми текущую ситуацию пользователя',
                    'Опиши коротко как решишь его задачу/назови наши преимущества, предложи товары по запросу',
                    'Веди клиента к оформлению заказа/заявки',
                    'Когда клиент готов оформить заказ, сделай итог заказа и пришли ссылку на оплату из базы знаний.',
                    'Переведи клиента на менеджера для проверки оплаты и дальнейшей работы'
                  ]).map((stage, index) => {
                    const isEditing = setupData.editingStage === index;
                    return (
                    <div key={index} className="flex items-center gap-[10px]">
                      {/* Квадрат с цифрой */}
                      <div className="w-[40px] h-[40px] bg-[#F3F8FF] border border-[#070F1A]/10 rounded-[10px] flex items-center justify-center">
                        <span className="text-[14px] text-[#0084FF] font-medium">{index + 1}</span>
                  </div>
                      
                      {/* Поле ввода */}
                      <div className="flex-1">
                        <div className="flex-1">
                          <Textarea
                            value={stage}
                            onChange={(e) => {
                              const newStages = [...(setupData.dialogStages || [])];
                              newStages[index] = e.target.value;
                              setSetupData({...setupData, dialogStages: newStages});
                            }}
                            className={`w-full resize-none border rounded-[10px] p-3 min-h-[40px] ${isEditing ? 'border-[#070F1A]/10 bg-white' : 'border-[#070F1A]/10 bg-gray-50 cursor-not-allowed'}`}
                            rows={1}
                            placeholder="Опишите этап диалога"
                            readOnly={!isEditing}
                            style={{ minHeight: '40px', height: 'auto' }}
                            onInput={(e) => {
                              e.target.style.height = 'auto';
                              e.target.style.height = Math.max(40, e.target.scrollHeight) + 'px';
                            }}
                            data-stage-index={index}
                          />
                    </div>
                      </div>
                      
                      {/* Кнопка редактирования */}
                      <button 
                        onClick={() => {
                          if (isEditing) {
                            setSetupData({...setupData, editingStage: null});
                          } else {
                            setSetupData({...setupData, editingStage: index});
                            // Автоматически фокусируемся на поле через небольшую задержку
                            setTimeout(() => {
                              const textarea = document.querySelector(`textarea[data-stage-index="${index}"]`);
                              if (textarea) {
                                textarea.focus();
                                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                              }
                            }, 100);
                          }
                        }}
                        className="w-[40px] h-[40px] bg-white border border-[#070F1A]/10 rounded-[10px] flex items-center justify-center hover:bg-gray-50"
                      >
                        <svg className="w-5 h-5 text-[#070F1A]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </button>
                      
                      {/* Кнопка удаления */}
                      <button 
                          onClick={() => {
                            const newStages = [...(setupData.dialogStages || [])];
                            newStages.splice(index, 1);
                            setSetupData({...setupData, dialogStages: newStages});
                          }}
                        className="w-[40px] h-[40px] bg-white border border-[#070F1A]/10 rounded-[10px] flex items-center justify-center"
                      >
                        <svg className="w-5 h-5 text-[#D12020]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  );
                  })}
                  
                  <Button 
                    onClick={() => {
                      const newStages = [...(setupData.dialogStages || []), 'Новый этап диалога'];
                      setSetupData({...setupData, dialogStages: newStages});
                    }}
                    className="w-full h-[40px] bg-white border border-[#096EFD]/50 text-[#070F1A] hover:bg-[#096EFD] hover:text-white text-[14px] transition-all"
                  >
                    Добавить этап
                  </Button>
                    </div>

                <div className="h-[20px]"></div>

                {/* Предупреждение если не изменены этапы */}
                {!setupData.dialogStagesModified && (
                  <div className="bg-[#FFF8F8] border border-[#FF0D0D]/15 rounded-[18px] px-[15px] py-4">
                    <div className="flex items-start gap-[7px]">
                      <svg className="w-6 h-6 text-[#D12020] flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                      </svg>
                      <div>
                        <div className="font-medium text-[#D12020] text-[16px] mb-[11px]">Вы не внесли никаких изменений в этапы диалога</div>
                        <div className="text-[14px] text-[#916464]">
                          Он не адаптирован под ваш бизнес, это может сказаться на эффективности ответов ИИ-агента. Рекомендуем, изменить информацию в полях!
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                <div className="h-[30px]"></div>

                </div>
            </div>

            {/* Закрепленные кнопки внизу контейнера */}
            <div className="sticky bottom-[30px] z-10 mt-6">
              <div className="flex gap-[20px] w-full">
                <Button 
                  onClick={async () => {
                    try {
                      await saveModelSettings(setupData, user?.id);
                      setSetupData({...setupData, dialogStagesModified: true});
                      alert('Настройки успешно сохранены!');
                    } catch (error) {
                      alert('Ошибка сохранения настроек: ' + error.message);
                    }
                  }}
                  className="flex-1 bg-[#070F1A] text-white hover:bg-[#070F1A]/90 font-[500] text-[14px]"
                >
                Сохранить изменения
              </Button>
                <Button 
                  onClick={async () => {
                    try {
                      await saveModelSettings(setupData, user?.id);
                      setSetupData({...setupData, dialogStagesModified: true});
                      // Переключаемся на вкладку диалогов для тестирования
                      setActiveTab('dialogs');
                      alert('Настройки сохранены! Переходим к тестированию.');
                    } catch (error) {
                      alert('Ошибка сохранения настроек: ' + error.message);
                    }
                  }}
                  className="flex-1 bg-[#0084FF] text-white hover:bg-[#0084FF]/90 font-[500] text-[14px]"
                >
                  Сохранить и протестировать
                </Button>
              </div>
            </div>
          </div>
        );

      case 'dialogs':
        return (
          <div className="h-full flex gap-6">
            {/* Первый контейнер: Список диалогов */}
            <div className="w-1/3 bg-white rounded-[18px] border border-[#070F1A]/10 p-6">
              {/* Заголовок и кнопки экспорта */}
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-[20px] font-[500] text-[#070F1A]">Диалоги</h2>
                <div className="flex gap-2">
                  <button 
                    onClick={exportToXLS}
                    className="px-3 py-1.5 bg-[#096EFD] text-white rounded-[8px] text-xs font-medium hover:bg-[#096EFD]/90 transition-colors"
                  >
                    XLS
                  </button>
                  <button 
                    onClick={exportToCSV}
                    className="px-3 py-1.5 bg-[#096EFD] text-white rounded-[8px] text-xs font-medium hover:bg-[#096EFD]/90 transition-colors"
                  >
                    CSV
                  </button>
                </div>
              </div>

              {/* Поиск */}
              <div className="mb-6">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-[#647491]" />
                  <Input
                    value={dialogSearch}
                    onChange={(e) => setDialogSearch(e.target.value)}
                    placeholder="Поиск по диалогам..."
                    className="pl-10 h-10 rounded-[10px] border border-[#070F1A]/10"
                  />
                </div>
              </div>

              {/* Список диалогов */}
              <div className="space-y-3 max-h-[600px] overflow-y-auto">
                {dialogsData
                  .filter(dialog => 
                    dialog.user.toLowerCase().includes(dialogSearch.toLowerCase()) ||
                    dialog.lastMessage.toLowerCase().includes(dialogSearch.toLowerCase())
                  )
                  .map((dialog) => (
                                         <div 
                       key={dialog.id} 
                       onClick={() => setSelectedDialog(dialog)}
                       className={`p-4 rounded-[18px] border cursor-pointer transition-all ${
                         selectedDialog?.id === dialog.id 
                           ? 'border-[#096EFD] bg-[#F3F8FF]' 
                           : 'border-[#070F1A]/10 hover:border-[#096EFD]/30 hover:bg-[#F3F5F7]'
                       }`}
                     >
                                             <div className="flex items-start gap-3">
                         {/* Иконка источника */}
                         <div className="w-8 h-8 bg-[#F3F5F7] rounded-full flex items-center justify-center">
                           <img src={dialog.sourceIcon} alt={dialog.sourceName} className="w-full h-full" />
                         </div>
                        
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <h3 className="font-medium text-[14px] text-[#070F1A] truncate">{dialog.user}</h3>
                            <span className="text-[10px] text-[#647491] bg-[#F3F5F7] px-2 py-0.5 rounded-full">
                              {dialog.sourceName}
                            </span>
                          </div>
                          
                          <p className="text-[12px] text-[#647491] mb-2">{dialog.phone}</p>
                          <p className="text-[13px] text-[#070F1A] line-clamp-2">{dialog.lastMessage}</p>
                          
                          <div className="flex items-center justify-between mt-2">
                            <span className="text-[11px] text-[#647491]">{dialog.time}</span>
                            <div className="flex items-center gap-2">
                              <span className="text-[11px] text-[#647491]">{dialog.messages} сообщ.</span>
                              <div className={`w-2 h-2 rounded-full ${
                                dialog.status === 'active' ? 'bg-green-500' :
                                dialog.status === 'waiting' ? 'bg-yellow-500' :
                                'bg-gray-400'
                              }`}></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            </div>

            {/* Второй контейнер: Диалог */}
            <div className="w-2/5 bg-white rounded-[18px] border border-[#070F1A]/10 p-6">
              {selectedDialog ? (
                <>
                                     {/* Заголовок диалога */}
                   <div className="flex items-center gap-3 mb-6 pb-4 border-b border-[#070F1A]/10">
                     <div className="w-10 h-10 bg-[#F3F5F7] rounded-full flex items-center justify-center">
                       <img src={selectedDialog.sourceIcon} alt={selectedDialog.sourceName} className="w-full h-full" />
                     </div>
                    <div className="flex-1">
                      <h3 className="font-medium text-[16px] text-[#070F1A]">{selectedDialog.user}</h3>
                      <p className="text-[13px] text-[#647491]">{selectedDialog.phone}</p>
                    </div>
                    <div className={`px-3 py-1 rounded-full text-xs font-medium ${
                      selectedDialog.status === 'active' ? 'bg-green-100 text-green-700' :
                      selectedDialog.status === 'waiting' ? 'bg-yellow-100 text-yellow-700' :
                      'bg-gray-100 text-gray-700'
                    }`}>
                      {selectedDialog.status === 'active' ? 'Активный' :
                       selectedDialog.status === 'waiting' ? 'Ожидает' : 'Закрыт'}
                    </div>
                  </div>

                  {/* Сообщения */}
                  <div className="space-y-4 max-h-[500px] overflow-y-auto">
                    {selectedDialog.messagesList.map((message, index) => (
                      <div key={index} className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[80%] p-3 rounded-[12px] ${
                          message.type === 'user' 
                            ? 'bg-[#096EFD] text-white' 
                            : 'bg-[#F3F5F7] text-[#070F1A]'
                        }`}>
                          <p className="text-[14px] leading-relaxed">{message.text}</p>
                          <p className={`text-[11px] mt-1 ${
                            message.type === 'user' ? 'text-blue-100' : 'text-[#647491]'
                          }`}>
                            {message.time}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                </>
              ) : (
                <div className="flex items-center justify-center h-full text-[#647491]">
                  <div className="text-center">
                    <MessageSquare className="w-12 h-12 mx-auto mb-4 opacity-50" />
                    <p className="text-sm">Выберите диалог для просмотра</p>
                  </div>
                </div>
              )}
            </div>

            {/* Третий контейнер: Информация о диалоге */}
            <div className="w-1/4 bg-white rounded-[18px] border border-[#070F1A]/10 p-6">
              {selectedDialog ? (
                <>
                  <h3 className="text-[18px] font-[500] text-[#070F1A] mb-6">Информация</h3>
                  
                  <div className="space-y-4">
                                         <div>
                       <p className="text-[12px] text-[#647491] mb-1">Источник</p>
                       <div className="flex items-center gap-2">
                         <img src={selectedDialog.sourceIcon} alt={selectedDialog.sourceName} className="w-6 h-6" />
                         <span className="text-[14px] font-medium text-[#070F1A]">{selectedDialog.sourceName}</span>
                       </div>
                     </div>

                    <div>
                      <p className="text-[12px] text-[#647491] mb-1">Пользователь</p>
                      <p className="text-[14px] font-medium text-[#070F1A]">{selectedDialog.user}</p>
                    </div>

                    <div>
                      <p className="text-[12px] text-[#647491] mb-1">Телефон</p>
                      <p className="text-[14px] font-medium text-[#070F1A]">{selectedDialog.phone}</p>
                    </div>

                    {selectedDialog.email && (
                      <div>
                        <p className="text-[12px] text-[#647491] mb-1">Email</p>
                        <p className="text-[14px] font-medium text-[#070F1A]">{selectedDialog.email}</p>
                      </div>
                    )}

                    <div>
                      <p className="text-[12px] text-[#647491] mb-1">Статус</p>
                      <div className={`inline-block px-3 py-1 rounded-full text-xs font-medium ${
                        selectedDialog.status === 'active' ? 'bg-green-100 text-green-700' :
                        selectedDialog.status === 'waiting' ? 'bg-yellow-100 text-yellow-700' :
                        'bg-gray-100 text-gray-700'
                      }`}>
                        {selectedDialog.status === 'active' ? 'Активный' :
                         selectedDialog.status === 'waiting' ? 'Ожидает' : 'Закрыт'}
                      </div>
                    </div>

                    <div>
                      <p className="text-[12px] text-[#647491] mb-1">Сообщений</p>
                      <p className="text-[14px] font-medium text-[#070F1A]">{selectedDialog.messages}</p>
                    </div>

                    <div>
                      <p className="text-[12px] text-[#647491] mb-1">Последняя активность</p>
                      <p className="text-[14px] font-medium text-[#070F1A]">{selectedDialog.time}</p>
                    </div>
                  </div>
                </>
              ) : (
                <div className="flex items-center justify-center h-full text-[#647491]">
                  <div className="text-center">
                    <Info className="w-12 h-12 mx-auto mb-4 opacity-50" />
                    <p className="text-sm">Информация о диалоге</p>
                  </div>
                </div>
              )}
            </div>
          </div>
        );



      default:
        return <div className="text-center py-8 text-gray-500">Раздел в разработке</div>;
    }
  };

  // Auth screen
  if (!isLoggedIn) {
    // Для страницы входа используем новый дизайн
    if (currentStep === 'login') {
        return (
        <div className="min-h-screen flex bg-[#070F1A]">
          {/* Левая часть - форма входа */}
          <div className="w-1/2 bg-[#070F1A] flex flex-col">
            {/* Логотип сверху */}
            <div className="pt-10 flex justify-center">
              <img src="/logo.svg" alt="Adapto" className="h-8" />
            </div>
            
            {/* Форма входа */}
            <div className="flex-1 flex items-center justify-center p-8">
              <div className="w-full max-w-md space-y-8">
                <div className="text-center">
                  <h2 className="text-3xl font-bold text-white">Вход в Adapto</h2>
                </div>
                
          <div className="space-y-6">
                  <form onSubmit={handleLoginSubmit} className="space-y-6">
                    <div>
                      <label className="block text-sm font-medium mb-2 text-white">Email</label>
                      <Input
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                        placeholder="your@email.com"
                        required
                        className="h-12 rounded-[10px] border border-white border-opacity-20 bg-transparent text-white placeholder-gray-400 focus:border-white focus:border-opacity-40"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-2 text-white">Пароль</label>
                      <Input
                        type="password"
                        value={formData.password}
                        onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                        placeholder="Введите пароль"
                        required
                        className="h-12 rounded-[10px] border border-white border-opacity-20 bg-transparent text-white placeholder-gray-400 focus:border-white focus:border-opacity-40"
                      />
                    </div>
                    
                    {formErrors.general && (
                      <div className="text-red-400 text-sm">{formErrors.general}</div>
                    )}
                    
                    <Button 
                      type="submit" 
                      className="w-full h-12 rounded-[10px] text-white"
                      style={{ background: 'linear-gradient(40deg, #096EFD 0%, #52AEFF 100%)' }}
                    >
                      Войти в аккаунт
                    </Button>
                    
                    <div className="text-center">
                      <button
                        type="button"
                        className="text-gray-300 hover:text-white text-sm"
                      >
                        Забыл пароль?
                      </button>
            </div>

                    <div className="text-center">
                      <button
                        type="button"
                        onClick={() => setCurrentStep('register')}
                        className="text-gray-300 hover:text-white text-sm"
                      >
                        Нет аккаунта? Зарегистрироваться
                      </button>
                  </div>
                  </form>
                    </div>
                    </div>
                    </div>
                    </div>
          
          {/* Правая часть - изображение с цитатой */}
          <div className="w-1/2 relative p-[15px]">
            <div 
              className="w-full h-full bg-cover bg-center bg-no-repeat rounded-[20px] bg-[#070F1A]"
              style={{
                backgroundImage: 'url(/login-background.png)'
              }}
            >
              <div className="absolute inset-0 flex items-center justify-center rounded-[20px]">
                <div className="text-center text-white max-w-[500px] px-8">
                  <div className="mb-8">
                    <h3 className="text-3xl font-semibold mb-4 leading-tight">
                      В быстроменяющемся мире самое главное – это способность к адаптации.
                    </h3>
                    <p className="text-lg opacity-80">
                      Илон Маск, основатель xAI
                    </p>
                  </div>
                </div>
          </div>
            </div>
          </div>
        </div>
      );
    }
    
        // Для страницы регистрации используем новый дизайн
        return (
      <div className="min-h-screen flex bg-[#070F1A]">
        {/* Левая часть - форма регистрации */}
        <div className="w-1/2 bg-[#070F1A] flex flex-col">
          {/* Логотип сверху */}
          <div className="pt-10 flex justify-center">
            <img src="/logo.svg" alt="Adapto" className="h-8" />
          </div>
          
          {/* Форма регистрации */}
          <div className="flex-1 flex items-center justify-center p-8">
            <div className="w-full max-w-md space-y-8">
              <div className="text-center">
                <h2 className="text-3xl font-bold text-white">Регистрация</h2>
              </div>
              
          <div className="space-y-6">
                <form onSubmit={handleRegisterSubmit} className="space-y-6">
                  {/* Имя и Компания на одной линии */}
                  <div className="grid grid-cols-2 gap-5">
                    <div>
                      <label className="block text-sm font-medium mb-2 text-white">Имя</label>
                      <Input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        placeholder="Ваше имя"
                        required
                        className="h-12 rounded-[10px] border border-white border-opacity-20 bg-transparent text-white placeholder-gray-400 focus:border-white focus:border-opacity-40"
                      />
                    </div>
                    
                <div>
                      <label className="block text-sm font-medium mb-2 text-white">Компания</label>
                      <Input
                        type="text"
                        value={formData.company}
                        onChange={(e) => setFormData({ ...formData, company: e.target.value })}
                        placeholder="Название компании"
                        required
                        className="h-12 rounded-[10px] border border-white border-opacity-20 bg-transparent text-white placeholder-gray-400 focus:border-white focus:border-opacity-40"
                      />
                    </div>
                </div>
                
                  {/* Email и Телефон на одной линии */}
                  <div className="grid grid-cols-2 gap-5">
                <div>
                      <label className="block text-sm font-medium mb-2 text-white">Email</label>
                      <Input
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                        placeholder="your@email.com"
                        required
                        className="h-12 rounded-[10px] border border-white border-opacity-20 bg-transparent text-white placeholder-gray-400 focus:border-white focus:border-opacity-40"
                  />
                </div>

                <div>
                      <label className="block text-sm font-medium mb-2 text-white">Номер телефона</label>
                      <div className="flex gap-2">
                        <select
                          value={countryCode}
                          onChange={(e) => setCountryCode(e.target.value)}
                          className="w-20 h-12 px-3 rounded-[10px] border border-white border-opacity-20 bg-transparent text-white focus:border-white focus:border-opacity-40"
                        >
                          <option value="+7">🇷🇺 +7</option>
                          <option value="+1">🇺🇸 +1</option>
                          <option value="+44">🇬🇧 +44</option>
                          <option value="+49">🇩🇪 +49</option>
                          <option value="+33">🇫🇷 +33</option>
                          <option value="+39">🇮🇹 +39</option>
                          <option value="+34">🇪🇸 +34</option>
                          <option value="+31">🇳🇱 +31</option>
                          <option value="+380">🇺🇦 +380</option>
                          <option value="+375">🇧🇾 +375</option>
                          <option value="+371">🇱🇻 +371</option>
                          <option value="+372">🇪🇪 +372</option>
                          <option value="+370">🇱🇹 +370</option>
                          <option value="+48">🇵🇱 +48</option>
                          <option value="+420">🇨🇿 +420</option>
                          <option value="+36">🇭🇺 +36</option>
                          <option value="+40">🇷🇴 +40</option>
                          <option value="+359">🇧🇬 +359</option>
                          <option value="+30">🇬🇷 +30</option>
                        </select>
                        <Input
                          type="tel"
                          value={formData.phone}
                          onChange={(e) => {
                            const value = e.target.value;
                            const formatted = formatRussianPhone(value);
                            setFormData({ ...formData, phone: formatted });
                            
                            // Валидация
                            const error = validatePhone(formatted);
                            setValidationErrors({ ...validationErrors, phone: error });
                          }}
                          placeholder="(921) 331-21-43"
                          required
                          className="flex-1 h-12 rounded-[10px] border border-white border-opacity-20 bg-transparent text-white placeholder-gray-400 focus:border-white focus:border-opacity-40"
                        />
                      </div>
                    </div>
                </div>

                  {/* Ошибка валидации телефона */}
                  {validationErrors.phone && (
                    <div className="text-red-400 text-sm mt-1">{validationErrors.phone}</div>
                  )}
                  
                  <div>
                    <label className="block text-sm font-medium mb-2 text-white">Пароль</label>
                    <Input
                      type="password"
                      value={formData.password}
                      onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                      placeholder="Создайте пароль"
                      required
                      className="h-12 rounded-[10px] border border-white border-opacity-20 bg-transparent text-white placeholder-gray-400 focus:border-white focus:border-opacity-40"
                    />
                  </div>
                  
                  <Button 
                    type="submit" 
                    className="w-full h-12 rounded-[10px] text-white"
                    style={{ background: 'linear-gradient(40deg, #096EFD 0%, #52AEFF 100%)' }}
                  >
                    Создать аккаунт
                </Button>
                  
                  <div className="text-center space-y-4">
                    <p className="text-xs text-gray-400 leading-relaxed">
                      Нажимая "Создать аккаунт", вы соглашаетесь с условиями Оферты и даете согласие на обработку персональных данных в соответствии с Политикой Конфиденциальности
                    </p>
                    <button
                      type="button"
                      onClick={() => setCurrentStep('login')}
                      className="text-gray-300 hover:text-white text-sm"
                    >
                      Уже есть аккаунт? Войти
                    </button>
          </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        
        {/* Правая часть - изображение с цитатой */}
        <div className="w-1/2 relative p-[15px]">
          <div 
            className="w-full h-full bg-cover bg-center bg-no-repeat rounded-[20px] bg-[#070F1A]"
            style={{
              backgroundImage: 'url(/registration-background.png)'
            }}
          >
            <div className="absolute inset-0 flex items-center justify-center rounded-[20px]">
              <div className="text-center text-white max-w-[500px] px-8">
                <div className="mb-8">
                  <h3 className="text-3xl font-semibold mb-4 leading-tight">
                    Сегодня мы находимся на заре новой эпохи, где главное — не сила, не размер, а скорость и адаптивность.
                  </h3>
                  <p className="text-lg opacity-80">
                    Джек Ма, основатель Alibaba
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }
  return (
    <div className="h-screen flex bg-[#070F1A]">
      {/* Notification */}
      {showNotification && (
        <div className="fixed top-4 right-4 z-50 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300">
          {notificationMessage}
        </div>
      )}

      {/* Sidebar */}
      <div className={`fixed md:relative z-50 md:z-auto transform transition-transform duration-300 ease-in-out ${
        sidebarOpen ? 'translate-x-0' : '-translate-x-full'
      } md:translate-x-0 ${sidebarCollapsed ? 'w-16' : 'w-64'} h-full bg-[#070F1A] flex flex-col`}>
        
        {/* Header with Logo and Language Icon */}
                        <div className="px-[10px] pt-5 pb-0" style={{ width: 'calc(100% + 10px)' }}>
          <div className="flex items-center justify-between">
            <div className="flex items-center pl-[10px]">
              {!sidebarCollapsed && <img src="/logo.svg" alt="Adapto" className="w-[110px] h-6" />}
            </div>
            <div className={`flex items-center ${sidebarCollapsed ? 'justify-center w-full' : 'gap-2'}`}>
              <button 
                onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                className={`text-gray-400 hover:text-white transition-colors ${sidebarCollapsed ? '-ml-[5px]' : ''}`}
              >
                <img 
                  src={sidebarCollapsed ? "/2.svg" : "/1.svg"} 
                  alt="Toggle sidebar" 
                  className="w-4 h-4"
                />
              </button>

            </div>
          </div>
        </div>
        
        {/* Navigation */}
                        <div className="flex-1 px-[10px] pt-5" style={{ width: 'calc(100% + 10px)' }}>
          <nav className="space-y-2">
            {menuItems.map((item) => (
              <button
                key={item.id}
                onClick={() => {
                  setActiveSection(item.id);
                  localStorage.setItem('currentSection', item.id);
                  setSidebarOpen(false);
                }}
                className={`w-full flex items-center ${sidebarCollapsed ? 'justify-center' : 'gap-3'} px-3 h-10 rounded-[10px] text-left transition-colors ${
                  activeSection === item.id 
                    ? 'bg-[#1E2538] text-white' 
                    : 'text-[#B3B7B9] hover:text-white hover:bg-[#1E2538]'
                }`}
                title={sidebarCollapsed ? item.label : ''}
              >
                {typeof item.icon === 'function' ? (
                  <div className="w-4 h-4">
                    {React.cloneElement(item.icon(), {
                      className: `w-4 h-4 ${activeSection === item.id ? 'filter brightness-0 invert' : ''}`,
                      style: {
                        filter: activeSection === item.id ? 'brightness(0) invert(1)' : 'brightness(0) saturate(100%) invert(70%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.7) contrast(1)'
                      }
                    })}
                  </div>
                ) : (
                  <img 
                    src={`/${item.id === 'main' ? 'home' :
                         item.id === 'my-solo' ? 'mouse-square-menu' : 
                         item.id === 'dashboard' ? 'dashboard' : 
                         item.id === 'dialogs' ? 'chat' : 
                         item.id === 'knowledge' ? 'knowledge-base' : 
                         item.id === 'model-settings' ? 'model-settings' : 
                         'integration-2'}.svg?v=${Date.now()}`} 
                    alt={item.label}
                    className={`w-4 h-4 ${activeSection === item.id ? 'filter brightness-0 invert' : ''}`}
                    style={{
                      filter: activeSection === item.id ? 'brightness(0) invert(1)' : 'brightness(0) saturate(100%) invert(70%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.7) contrast(1)'
                    }}
                  />
                )}
                {!sidebarCollapsed && <span className="text-[14px] font-medium tracking-[-0.2px]">{item.label}</span>}
              </button>
            ))}
          </nav>
        </div>

        {/* User Profile */}
                        <div className="px-[10px] pb-[15px]" style={{ width: 'calc(100% + 10px)' }}>
          {!sidebarCollapsed ? (
            <>
              {/* Новая плашка Pro */}
              <div className="w-full h-[150px] rounded-[12px] mb-[10px] relative overflow-hidden" style={{ 
                backgroundImage: 'url(/Frame-17-new.webp)', backgroundSize: 'cover', backgroundPosition: 'center top'
              }}>
                
                {/* Контент */}
                <div className="relative z-10 p-[10px] h-full flex flex-col justify-between">
                  <div>
                    <div className="text-white font-medium text-[14px] mb-2">Больше возможностей<br />с Adapto Pro</div>
                    <div className="text-white font-normal text-[11px] opacity-80 leading-tight">Подключайте тариф Pro, и ваш бизнес станет еще эффективнее</div>
          </div>
          
                  <div className="flex items-center justify-between">
                    <button className="bg-white text-[#070F1A] font-semibold text-[11px] px-6 py-2 rounded-[10px] hover:bg-gray-100 transition-colors">
                      Подробнее
            </button>
                    <img src="/892189398213.svg" alt="" className="w-[34px] h-[34px] opacity-20" />
          </div>
                </div>
              </div>
              
              <div 
                className="bg-[#1E2538] rounded-[12px] p-3 mb-[10px] mt-[5px] cursor-pointer hover:bg-[#2A3447] transition-colors"
                onClick={() => setShowProfileModal(true)}
              >
                <div className="flex items-center gap-3 mb-3">
                  <div className="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center">
                    <div className="flex items-center justify-center w-6 h-6">
                      <div className="w-2 h-2 bg-white rounded-full mr-1"></div>
                      <div className="w-1 h-1 bg-white rounded-full"></div>
                    </div>
                  </div>
                  <div>
                    <div className="text-[14px] font-medium text-white">{currentUser?.name || 'Пользователь'}</div>
                    <div className="text-[12px] text-gray-400">{currentUser?.company_name || 'Компания'}</div>
                  </div>
                </div>
              
                <div className="bg-[#3FDD78] rounded-[7px] w-[89px] h-6 flex items-center justify-center">
                  <div className="text-[11px] text-[#070F1A] font-medium">Бесплатный</div>
                </div>
              </div>
            </>
          ) : (
            /* Укороченная версия плашки профиля при скрытом меню */
            <div className="bg-[#1E2538] rounded-[12px] p-3 mb-[10px] mt-[5px]">
              <div className="flex flex-col items-center">
                <div className="w-8 h-8 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center">
                  <div className="flex items-center justify-center w-4 h-4">
                    <div className="w-1 h-1 bg-white rounded-full mr-0.5"></div>
                    <div className="w-0.5 h-0.5 bg-white rounded-full"></div>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          <button 
            className={`w-full flex items-center ${sidebarCollapsed ? 'justify-center' : 'justify-center gap-[3px]'} px-3 py-2 rounded-[10px] text-left text-gray-400 hover:text-white hover:bg-[#1E2538] transition-colors border border-gray-600 mb-[0px]`}
            onClick={handleLogout}
            title={sidebarCollapsed ? 'Выйти' : ''}
          >
            <img src="/logout.svg" alt="Выйти" className="w-4 h-4" />
            {!sidebarCollapsed && <span className="text-[14px] font-medium">Выйти</span>}
            </button>
        </div>
      </div>

      {/* Main content */}
      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Mobile header */}
        <div className="md:hidden flex items-center gap-4 p-4 border-b border-gray-700 bg-[#070F1A]">
          <Button 
            variant="ghost" 
            size="sm"
            onClick={() => setSidebarOpen(true)}
            className="text-white"
          >
            <Menu className="w-4 h-4" />
          </Button>
          <h1 className="font-medium text-white">Adapto AI Platform</h1>
        </div>

        {/* Content */}
        <main className="flex-1 overflow-auto bg-white rounded-[20px] m-[15px] ml-[10px]">
          <div className="p-6">
          {renderContent()}
          </div>
        </main>
      </div>

      {/* Widget Constructor Modal */}
      {showWidgetConstructor && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowWidgetConstructor(false)} />
          <div className="relative bg-white rounded-xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-gray-200">
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => setShowWidgetConstructor(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  ←
                </button>
                <h3 className="text-xl font-semibold">Интеграции / Виджет</h3>
    </div>
              <button 
                onClick={() => {
                  navigator.clipboard.writeText('<script src="https://adapto.ai/widget.js"></script>');
                  showNotificationMessage('Скрипт скопирован!');
                  // Устанавливаем виджет как установленный
                  setIntegrations(prev => prev.map(item => 
                    item.id === 'widget' 
                      ? { ...item, installed: true }
                      : item
                  ));
                  setShowWidgetConstructor(false);
                }}
                className="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              >
                Скопировать скрипт
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6">
              <div className="space-y-8">
                {/* Settings */}
                <div className="space-y-6">
                  {/* Accent Color */}
                  <div>
                    <label className="block text-sm font-medium mb-3">Акцентный цвет</label>
                    <div className="flex items-center gap-3">
                      <input 
                        type="text" 
                        value={widgetSettings.accentColor}
                        onChange={(e) => setWidgetSettings({...widgetSettings, accentColor: e.target.value})}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                        placeholder="HEX"
                      />
                      <input 
                        type="color" 
                        value={widgetSettings.accentColor}
                        onChange={(e) => setWidgetSettings({...widgetSettings, accentColor: e.target.value})}
                        className="w-10 h-10 rounded-lg border-2 border-gray-300 cursor-pointer"
                      />
                      <button 
                        onClick={() => setWidgetSettings({...widgetSettings, accentColor: '#1354FC'})}
                        className="text-gray-400 hover:text-gray-600"
                      >
                        ×
                      </button>
                    </div>
                  </div>

                  {/* Button Color */}
                  <div>
                    <label className="block text-sm font-medium mb-3">Цвет кнопки</label>
                    <div className="grid grid-cols-3 gap-3">
                      {[
                        { id: 'light', label: 'Светлый фон', bg: 'bg-white', border: 'border-blue-500', text: 'text-blue-500' },
                        { id: 'dark', label: 'Темный фон', bg: 'bg-gray-900', border: 'border-white', text: 'text-white' },
                        { id: 'custom', label: 'Задать свой цвет', bg: 'bg-gradient-to-r from-yellow-400 via-pink-500 to-blue-500', border: 'border-blue-500', text: 'text-white' }
                      ].map((style) => (
                        <button
                          key={style.id}
                          onClick={() => setWidgetSettings({...widgetSettings, buttonColor: style.id})}
                          className={`p-3 rounded-lg border-2 transition-all ${
                            widgetSettings.buttonColor === style.id 
                              ? 'border-blue-500 ring-2 ring-blue-200' 
                              : 'border-gray-200 hover:border-gray-300'
                          }`}
                        >
                          <div 
                            className={`w-[140px] h-[42px] rounded-xl flex items-center justify-center gap-2 mb-2 mx-auto ${
                              style.id === 'light' ? 'bg-white border-2 border-gray-300' :
                              style.id === 'dark' ? 'bg-gray-900' :
                              'bg-gradient-to-r from-yellow-400 via-pink-500 to-blue-500'
                            }`}
                            style={{
                              borderColor: style.id === 'light' ? widgetSettings.accentColor : 'transparent',
                              color: style.id === 'light' ? widgetSettings.accentColor : 'white'
                            }}
                          >
                            <div 
                              className="w-4 h-4 rounded-full opacity-80"
                              style={{ backgroundColor: style.id === 'light' ? widgetSettings.accentColor : 'currentColor' }}
                            ></div>
                            <span className="text-sm font-medium" style={{ maxWidth: '90px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                              Спросить ИИ
                            </span>
                          </div>
                          <span className={`text-xs ${widgetSettings.buttonColor === style.id ? 'text-blue-600' : 'text-gray-600'}`}>
                            {style.label}
                          </span>
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Button Text */}
                  <div>
                    <label className="block text-sm font-medium mb-3">Название кнопки</label>
                    <input 
                      type="text" 
                      value={widgetSettings.buttonText}
                      onChange={(e) => setWidgetSettings({...widgetSettings, buttonText: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                      placeholder="Спросить ИИ"
                    />
                  </div>

                  {/* Avatar */}
                  <div>
                    <label className="block text-sm font-medium mb-3">Аватар Adapto</label>
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        onClick={() => setWidgetSettings({...widgetSettings, avatar: 'default'})}
                        className={`p-3 rounded-lg border-2 transition-all ${
                          widgetSettings.avatar === 'default' 
                            ? 'border-blue-500 ring-2 ring-blue-200' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full mx-auto mb-2 flex items-center justify-center">
                          <div className="flex items-center justify-center w-6 h-6">
                            <div className="w-3 h-3 bg-white rounded-full mr-1"></div>
                            <div className="w-1.5 h-1.5 bg-white rounded-full"></div>
                          </div>
                        </div>
                        <span className="text-xs text-center block">По умолчанию</span>
                      </button>
                      <button
                        onClick={() => document.getElementById('avatar-input')?.click()}
                        className={`p-3 rounded-lg border-2 transition-all ${
                          widgetSettings.avatar === 'custom' 
                            ? 'border-blue-500 ring-2 ring-blue-200' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="w-12 h-12 bg-gray-200 rounded-full mx-auto mb-2 flex items-center justify-center">
                          <span className="text-gray-500">+</span>
                        </div>
                        <span className="text-xs text-center block">Загрузить</span>
                        <input 
                          id="avatar-input"
                          type="file" 
                          accept="image/*"
                          className="hidden" 
                          onChange={(e) => {
                            const file = e.target.files?.[0];
                            if (file) {
                              setWidgetSettings({...widgetSettings, avatar: 'custom'});
                              showNotificationMessage('Аватар загружен!');
                            }
                          }}
                        />
                      </button>
                    </div>
                  </div>
                </div>

                {/* Custom Color Picker */}
                {widgetSettings.buttonColor === 'custom' && (
                  <div>
                    <label className="block text-sm font-medium mb-3">Введите цвет для фона</label>
                    <div className="flex items-center gap-3">
                      <input 
                        type="text" 
                        value={widgetSettings.customButtonColor}
                        onChange={(e) => setWidgetSettings({...widgetSettings, customButtonColor: e.target.value})}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                        placeholder="HEX"
                      />
                      <input 
                        type="color" 
                        value={widgetSettings.customButtonColor}
                        onChange={(e) => setWidgetSettings({...widgetSettings, customButtonColor: e.target.value})}
                        className="w-10 h-10 rounded-lg border-2 border-gray-300 cursor-pointer"
                      />
                    </div>
                  </div>
                )}

                {/* Расположение виджета */}
                <div>
                  <label className="block text-sm font-medium mb-3">Расположение виджета</label>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={() => setWidgetSettings({...widgetSettings, widgetLocation: 'default'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetSettings.widgetLocation === 'default' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">По умолчанию</div>
                        <div className="text-sm text-gray-600">Правый нижний угол</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetSettings, widgetLocation: 'custom'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetSettings.widgetLocation === 'custom' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">Настроить</div>
                        <div className="text-sm text-gray-600">Выбрать позицию</div>
                      </div>
                    </button>
                  </div>
                  
                  {/* Настройки расположения виджета */}
                  {widgetSettings.widgetLocation === 'custom' && (
                    <div className="mt-4 space-y-6 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <h4 className="text-sm font-medium mb-3">Для компьютеров</h4>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-2">Отступ снизу</label>
                            <input 
                              type="number" 
                              value={widgetSettings.desktopBottomOffset}
                              onChange={(e) => setWidgetSettings({...widgetSettings, desktopBottomOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-2">Отступ справа</label>
                            <input 
                              type="number" 
                              value={widgetSettings.desktopRightOffset}
                              onChange={(e) => setWidgetSettings({...widgetSettings, desktopRightOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                        </div>
                      </div>
                      
                      <div>
                        <h4 className="text-sm font-medium mb-3">Для телефонов</h4>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-2">Отступ снизу</label>
                            <input 
                              type="number" 
                              value={widgetSettings.mobileBottomOffset}
                              onChange={(e) => setWidgetSettings({...widgetSettings, mobileBottomOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-2">Отступ справа</label>
                            <input 
                              type="number" 
                              value={widgetSettings.mobileRightOffset}
                              onChange={(e) => setWidgetSettings({...widgetSettings, mobileRightOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">Z-index</label>
                        <input 
                          type="number" 
                          value={widgetSettings.zIndex}
                          onChange={(e) => setWidgetSettings({...widgetSettings, zIndex: parseInt(e.target.value)})}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                          min="1"
                        />
                      </div>
                    </div>
                  )}
                </div>

                {/* Приветственное сообщение */}
                <div>
                  <label className="block text-sm font-medium mb-3">Приветственное сообщение</label>
                  <div className="space-y-3">
                    {widgetSettings.welcomeMessages.map((message, index) => (
                      <div key={index} className="flex gap-2">
                        <input 
                          type="text" 
                          value={message}
                          onChange={(e) => {
                            const newMessages = [...widgetSettings.welcomeMessages];
                            newMessages[index] = e.target.value;
                            setWidgetSettings({...widgetSettings, welcomeMessages: newMessages});
                          }}
                          className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                          placeholder="Приветственное сообщение"
                        />
                        <button 
                          onClick={() => {
                            const newMessages = widgetSettings.welcomeMessages.filter((_, i) => i !== index);
                            setWidgetSettings({...widgetSettings, welcomeMessages: newMessages});
                          }}
                          className="px-3 py-2 text-red-500 hover:text-red-700"
                        >
                          ×
                        </button>
                      </div>
                    ))}
                    <button 
                      onClick={() => {
                        const newMessages = [...widgetSettings.welcomeMessages, ''];
                        setWidgetSettings({...widgetSettings, welcomeMessages: newMessages});
                      }}
                      className="text-blue-600 hover:text-blue-700 text-sm"
                    >
                      + Добавить сообщение
                    </button>
                  </div>
                </div>

                {/* Триггерный вопрос */}
                <div>
                  <label className="block text-sm font-medium mb-3">Триггерный вопрос</label>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <button
                      onClick={() => setWidgetSettings({...widgetSettings, triggerQuestionEnabled: 'no'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetSettings.triggerQuestionEnabled === 'no' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">Нет</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetSettings, triggerQuestionEnabled: 'yes'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetSettings.triggerQuestionEnabled === 'yes' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">Есть</div>
                      </div>
                    </button>
                  </div>
                  
                  {widgetSettings.triggerQuestionEnabled === 'yes' && (
                    <div className="space-y-4 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <label className="block text-sm font-medium mb-2">Через какое время показать:</label>
                        <div className="flex items-center gap-2">
                          <input 
                            type="number" 
                            value={widgetSettings.triggerQuestionDelay}
                            onChange={(e) => setWidgetSettings({...widgetSettings, triggerQuestionDelay: parseInt(e.target.value)})}
                            className="w-20 p-2 border border-gray-300 rounded-lg text-sm"
                            min="1"
                          />
                          <span className="text-sm text-gray-600">сек</span>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">Вопрос:</label>
                        <textarea 
                          value={widgetSettings.triggerQuestionText}
                          onChange={(e) => setWidgetSettings({...widgetSettings, triggerQuestionText: e.target.value})}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                          rows="3"
                          placeholder="Введите вопрос"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">Быстрые ответы:</label>
                        <div className="space-y-2">
                          {widgetSettings.quickReplies.map((reply, index) => (
                            <div key={index} className="flex gap-2">
                              <input 
                                type="text" 
                                value={reply}
                                onChange={(e) => {
                                  const newReplies = [...widgetSettings.quickReplies];
                                  newReplies[index] = e.target.value;
                                  setWidgetSettings({...widgetSettings, quickReplies: newReplies});
                                }}
                                className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                                placeholder="Быстрый ответ"
                              />
                              <button 
                                onClick={() => {
                                  const newReplies = widgetSettings.quickReplies.filter((_, i) => i !== index);
                                  setWidgetSettings({...widgetSettings, quickReplies: newReplies});
                                }}
                                className="px-3 py-2 text-red-500 hover:text-red-700"
                              >
                                ×
                              </button>
                            </div>
                          ))}
                          <button 
                            onClick={() => {
                              const newReplies = [...widgetSettings.quickReplies, ''];
                              setWidgetSettings({...widgetSettings, quickReplies: newReplies});
                            }}
                            className="text-blue-600 hover:text-blue-700 text-sm"
                          >
                            + Добавить быстрый ответ
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Follow up сообщение */}
                <div>
                  <label className="block text-sm font-medium mb-3">Follow up сообщение</label>
                  <p className="text-sm text-gray-600 mb-4">Сообщение, которое увидит пользователь, если выйдет из диалога</p>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <button
                      onClick={() => setWidgetSettings({...widgetSettings, followUpMessage: 'no'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetSettings.followUpMessage === 'no' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">Нет</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetSettings, followUpMessage: 'yes'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetSettings.followUpMessage === 'yes' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">Есть</div>
                      </div>
                    </button>
                  </div>
                  
                  {widgetSettings.followUpMessage === 'yes' && (
                    <div className="space-y-4 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <label className="block text-sm font-medium mb-2">Через какое время показать:</label>
                        <div className="flex items-center gap-2">
                          <input 
                            type="number" 
                            value={widgetSettings.followUpDelay}
                            onChange={(e) => setWidgetSettings({...widgetSettings, followUpDelay: parseInt(e.target.value)})}
                            className="w-20 p-2 border border-gray-300 rounded-lg text-sm"
                            min="1"
                          />
                          <span className="text-sm text-gray-600">сек</span>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">Вопрос:</label>
                        <textarea 
                          value={widgetSettings.followUpQuestion}
                          onChange={(e) => setWidgetSettings({...widgetSettings, followUpQuestion: e.target.value})}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                          rows="3"
                          placeholder="Введите вопрос"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">Быстрые ответы:</label>
                        <div className="space-y-2">
                          {widgetSettings.followUpQuickReply && (
                            <div className="flex gap-2">
                              <input 
                                type="text" 
                                value={widgetSettings.followUpQuickReply}
                                onChange={(e) => setWidgetSettings({...widgetSettings, followUpQuickReply: e.target.value})}
                                className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                                placeholder="Быстрый ответ"
                              />
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Ссылка на политику обработки персональных данных */}
                <div>
                  <label className="block text-sm font-medium mb-2">Ссылка на политику обработки персональных данных</label>
                  <input 
                    type="url" 
                    value={widgetSettings.privacyPolicyUrl}
                    onChange={(e) => setWidgetSettings({...widgetSettings, privacyPolicyUrl: e.target.value})}
                    className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="https://example.com/privacy"
                  />
                </div>

                {/* Какие метки собирать */}
                <div>
                  <label className="block text-sm font-medium mb-3">Какие метки собирать</label>
                  <div className="grid grid-cols-2 gap-2">
                    {[
                      'utm_source',
                      'utm_medium', 
                      'utm_campaign',
                      'utm_term',
                      'utm_content',
                      'roistat_visit',
                      'gclid',
                      'fbclid'
                    ].map(tag => (
                      <button
                        key={tag}
                        onClick={() => {
                          const current = widgetSettings.dataTags || [];
                          const newTags = current.includes(tag)
                            ? current.filter(t => t !== tag)
                            : [...current, tag];
                          setWidgetSettings({...widgetSettings, dataTags: newTags});
                        }}
                        className={`p-2 rounded-lg border-2 transition-all text-sm ${
                          (widgetSettings.dataTags || []).includes(tag)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {tag}
                      </button>
                    ))}
                  </div>
                  <div className="mt-3">
                    <button 
                      onClick={() => {
                        const newTag = prompt('Введите название метки:');
                        if (newTag && !widgetSettings.dataTags.includes(newTag)) {
                          const newTags = [...widgetSettings.dataTags, newTag];
                          setWidgetSettings({...widgetSettings, dataTags: newTags});
                        }
                      }}
                      className="text-blue-600 hover:text-blue-700 text-sm"
                    >
                      + Добавить метку
                    </button>
                  </div>
                </div>



                {/* Кнопки действий */}
                <div className="flex justify-end gap-3 pt-6 border-t">
                  <Button 
                    variant="outline"
                    onClick={() => {
                      // Открываем предосмотр в новой вкладке
                      const previewUrl = `http://localhost:3002/preview.html?settings=${encodeURIComponent(JSON.stringify(widgetSettings))}`;
                      window.open(previewUrl, '_blank');
                    }}
                  >
                    Предосмотр
                  </Button>
                  <Button 
                    onClick={() => {
                      // Сохраняем настройки
                      localStorage.setItem('widgetSettings', JSON.stringify(widgetSettings));
                      showNotificationMessage('Настройки виджета сохранены!');
                      setShowWidgetModal(false);
                    }}
                  >
                    Сохранить
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Integration Modal */}
      {showIntegrationModal && selectedIntegration && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowIntegrationModal(false)} />
          <div className="relative bg-white rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-gray-200">
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => setShowIntegrationModal(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  ←
                </button>
                <h3 className="text-xl font-semibold">Установка {selectedIntegration.name}</h3>
              </div>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6">
              <div className="space-y-6">
                <div className="flex items-center gap-4">
                  <img src={`/${selectedIntegration.icon}`} alt={selectedIntegration.name} className="w-12 h-12" />
                  <div>
                    <h4 className="text-lg font-medium">{selectedIntegration.name}</h4>
                    <p className="text-gray-600">{selectedIntegration.description}</p>
                  </div>
                </div>

                <div className="bg-gray-50 rounded-lg p-4">
                  <h5 className="font-medium mb-3">Инструкция по установке:</h5>
                  <div className="space-y-3 text-sm">
                    <p>1. Перейдите в настройки вашего {selectedIntegration.name}</p>
                    <p>2. Найдите раздел "Интеграции" или "API"</p>
                    <p>3. Скопируйте ваш API ключ</p>
                    <p>4. Вставьте ключ в поле ниже</p>
                    <p>5. Нажмите "Подключить"</p>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">API Ключ</label>
                  <Input
                    placeholder="Введите ваш API ключ"
                    className="w-full"
                  />
                </div>

                <div className="flex gap-3">
                  <Button
                    onClick={() => handleIntegrationSuccess(selectedIntegration.id)}
                    className="flex-1"
                  >
                    Подключить
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => setShowIntegrationModal(false)}
                  >
                    Отмена
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Uninstall Modal */}
      {showUninstallModal && integrationToUninstall && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowUninstallModal(false)} />
          <div className="relative bg-white rounded-xl w-full max-w-md mx-4 p-6">
            <div className="text-center">
              <h3 className="text-lg font-semibold mb-4">Удалить интеграцию?</h3>
              <p className="text-gray-600 mb-6">
                Вы действительно хотите удалить интеграцию с {integrationToUninstall.name}? 
                Это действие нельзя отменить.
              </p>
              <div className="flex gap-3">
                <Button
                  onClick={confirmUninstall}
                  variant="destructive"
                  className="flex-1"
                >
                  Да, удалить
                </Button>
                <Button
                  variant="outline"
                  onClick={() => setShowUninstallModal(false)}
                  className="flex-1"
                >
                  Нет, отмена
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Setup Wizard Modal для первого входа */}
      {showSetupWizard && (
        <div className="fixed inset-0 z-50 flex p-6 overflow-auto scroll-smooth">
          <div className="fixed inset-0 bg-black/50" />
          <div className="relative z-10 w-full m-auto bg-white rounded-[24px] max-w-[48rem] max-h-[90vh] overflow-hidden">
            <div className="p-[30px]">
              {/* Заголовок */}
              <div className="flex items-center justify-between mb-8">
                <div>
                  <h2 className="text-[24px] font-[600] text-[#070F1A]">Настройка вашего ИИ-агента</h2>
                  <p className="text-[14px] text-[#647491] mt-2">Помогите нам настроить Adapto под ваши задачи</p>
                </div>
                <button 
                  onClick={() => setShowSetupWizard(false)}
                  className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
                >
                  <X className="w-5 h-5 text-gray-500" />
                </button>
              </div>

              {/* Прогресс-бар */}
              <div className="mb-8">
                <div className="flex items-center justify-between mb-3">
                  <span className="text-[14px] font-[500] text-[#070F1A]">Шаг {setupStep} из 4</span>
                  <span className="text-[14px] text-[#647491]">{Math.round((setupStep / 4) * 100)}%</span>
                </div>
                <div className="w-full bg-[#F3F5F7] rounded-[10px] h-[8px] overflow-hidden">
                  <div 
                    className="bg-[#0084FF] h-[8px] rounded-[10px] transition-all duration-300"
                    style={{ width: `${(setupStep / 4) * 100}%` }}
                  ></div>
                </div>
              </div>

            {/* Содержимое шагов */}
            {setupStep === 1 && (
              <div className="space-y-6">
                <h3 className="text-xl font-semibold">Шаг 1: Уточните цели Adapto</h3>
                
                {/* 1. Какую задачу должен выполнять Адапто? */}
                <div>
                  <label className="block mb-3 font-medium">1. Какую задачу должен выполнять Адапто?</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button
                      onClick={() => setSetupData({...setupData, task: 'Продавать'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        setupData.task === 'Продавать' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">Продавать</div>
                        <div className="text-sm text-gray-600">Помогать в продажах</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, task: 'Консультировать'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        setupData.task === 'Консультировать' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">Консультировать</div>
                        <div className="text-sm text-gray-600">Давать консультации</div>
                      </div>
                    </button>
                  </div>
                </div>

                {/* 2. Какая главная цель ии-агента? */}
                <div>
                  <label className="block mb-3 font-medium">2. Какая главная цель ии-агента?</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {[
                      'Записать на консультацию',
                      'Продать продукт',
                      'Решить проблему клиента'
                    ].map(goal => (
                      <button
                        key={goal}
                        onClick={() => setSetupData({...setupData, mainGoal: goal})}
                        className={`p-4 rounded-lg border-2 transition-all ${
                          setupData.mainGoal === goal 
                            ? 'border-blue-500 ring-2 ring-blue-200' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="text-center">
                          <div className="text-lg font-medium">{goal}</div>
                        </div>
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: 'custom'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        setupData.mainGoal === 'custom' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">Другое</div>
                        <div className="text-sm text-gray-600">Указать свою цель</div>
                      </div>
                    </button>
                  </div>
                  {setupData.mainGoal === 'custom' && (
                    <div className="mt-3">
                      <Input
                        value={setupData.customGoal || ''}
                        onChange={(e) => setSetupData({...setupData, customGoal: e.target.value})}
                        placeholder="Укажите вашу главную цель"
                        className="w-full"
                      />
                    </div>
                  )}
                </div>

                {/* 3. Какой цикл сделки у вас в компании? */}
                <div>
                  <label className="block mb-2 font-medium">3. Какой цикл сделки у вас в компании?</label>
                  <Textarea
                    value={setupData.dealCycle || ''}
                    onChange={(e) => setSetupData({...setupData, dealCycle: e.target.value})}
                    placeholder="Опишите цикл сделки в вашей компании..."
                    className="min-h-[100px]"
                  />
                </div>

                {/* 4. Целевая аудитория */}
                <div>
                  <label className="block mb-2 font-medium">4. Целевая аудитория</label>
                  <Textarea
                    value={setupData.targetAudience || ''}
                    onChange={(e) => setSetupData({...setupData, targetAudience: e.target.value})}
                    placeholder="Опишите вашу целевую аудиторию..."
                    className="min-h-[100px]"
                  />
                </div>
              </div>
            )}

            {setupStep === 2 && (
              <div className="space-y-6">
                <h3 className="text-xl font-semibold">Шаг 2: Правила общения</h3>
                
                {/* 1. Обращение к пользователю */}
                <div>
                  <label className="block mb-3 font-medium">Обращение к пользователю</label>
                  <div className="flex gap-3">
                    <button 
                      onClick={() => setSetupData({...setupData, addressing: 'Ты'})}
                      className={`flex-1 border rounded-full h-12 transition-colors ${
                        setupData.addressing === 'Ты' ? 'bg-[#096EFD] text-white border-[#096EFD]' : 'bg-white hover:bg-gray-50 border-gray-200'
                      }`}
                    >
                      На "Ты"
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, addressing: 'Вы'})}
                      className={`flex-1 border rounded-full h-12 transition-colors ${
                        setupData.addressing === 'Вы' ? 'bg-[#096EFD] text-white border-[#096EFD]' : 'bg-white hover:bg-gray-50 border-gray-200'
                      }`}
                    >
                      На "Вы"
                    </button>
                  </div>
                </div>

                {/* 2. Стиль общения */}
                <div>
                  <label className="block mb-3 font-medium">2. Стиль общения</label>
                  <div className="flex flex-wrap gap-3">
                    {[
                      { text: 'Дружелюбный', emoji: '😊' },
                      { text: 'Нейтральный', emoji: '😐' },
                      { text: 'Профессиональный', emoji: '💼' },
                      { text: 'Юмористический', emoji: '😄' }
                    ].map(t => (
                      <button 
                        key={t.text} 
                        onClick={() => setSetupData({...setupData, communicationStyle: t.text})} 
                        className={`px-6 py-3 rounded-full border flex items-center gap-2 ${
                          setupData.communicationStyle === t.text ? 'bg-blue-600 text-white border-blue-600' : 'bg-white hover:bg-gray-50'
                        }`}
                      >
                        <span>{t.emoji}</span>
                        <span>{t.text}</span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* 3. Ограничения Адапто */}
                <div>
                  <label className="block mb-3 font-medium">3. Ограничения Адапто</label>
                  <div className="flex flex-wrap gap-2">
                    {[
                      'Не обсуждай цены',
                      'Не давай финансовых советов',
                      'Не консультируй по юридическим вопросам',
                      'Не разъясняй условия договоров',
                      'Не создавай обязательств от лица компании',
                      'Не подтверждай наличие товара или услуги'
                    ].map(restriction => (
                      <button
                        key={restriction}
                        onClick={() => {
                          const current = setupData.restrictions || [];
                          const newRestrictions = current.includes(restriction)
                            ? current.filter(r => r !== restriction)
                            : [...current, restriction];
                          setSetupData({...setupData, restrictions: newRestrictions});
                        }}
                        className={`px-4 py-2 rounded-full border-2 transition-all text-sm ${
                          (setupData.restrictions || []).includes(restriction)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {restriction}
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, showCustomRestriction: true})}
                      className="px-4 py-2 rounded-full border-2 border-gray-200 bg-white text-gray-700 hover:border-gray-300 text-sm"
                    >
                      Другое
                    </button>
                  </div>
                  {setupData.showCustomRestriction && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customRestriction || ''}
                        onChange={(e) => setSetupData({...setupData, customRestriction: e.target.value})}
                        placeholder="Введите ваше ограничение"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customRestriction) {
                            const current = setupData.restrictions || [];
                            setSetupData({
                              ...setupData, 
                              restrictions: [...current, setupData.customRestriction],
                              customRestriction: '',
                              showCustomRestriction: false
                            });
                          }
                        }}
                        disabled={!setupData.customRestriction}
                      >
                        Добавить
                      </Button>
                    </div>
                  )}
                </div>

                {/* 4. Дополнительные настройки стиля общения */}
                <div>
                  <label className="block mb-3 font-medium">4. Дополнительные настройки стиля общения под вашу компанию</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {[
                      'Не гарантировать результат',
                      'Пояснять ссылки перед отправкой',
                      'Проверять понимание ответа',
                      'Избегать длинных сообщений',
                      'Уточнять задачу в начале общения',
                      'Не оказывать давление на клиента',
                      'Предупреждать об ожидании ответа',
                      'Избегать споров',
                      'Отвечать от первого лица'
                    ].map(setting => (
                      <button
                        key={setting}
                        onClick={() => {
                          const current = setupData.communicationSettings || [];
                          const newSettings = current.includes(setting)
                            ? current.filter(s => s !== setting)
                            : [...current, setting];
                          setSetupData({...setupData, communicationSettings: newSettings});
                        }}
                        className={`p-3 rounded-lg border-2 transition-all text-left ${
                          (setupData.communicationSettings || []).includes(setting)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {setting}
                      </button>
                    ))}
                  </div>
                  <div className="mt-3">
                    <Input
                      value={setupData.customCommunicationSetting || ''}
                      onChange={(e) => setSetupData({...setupData, customCommunicationSetting: e.target.value})}
                      placeholder="Добавить свое правило общения"
                      className="w-full"
                    />
                  </div>
                </div>

                {/* 5. Сбор данных */}
                <div>
                  <label className="block mb-3 font-medium">5. Сбор данных</label>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                    {[
                      'Имя',
                      'Номер телефона',
                      'Почта',
                      'Адрес доставки',
                      'Город',
                      'Возраст'
                    ].map(dataType => (
                      <button
                        key={dataType}
                        onClick={() => {
                          const current = setupData.dataCollection || [];
                          const newData = current.includes(dataType)
                            ? current.filter(d => d !== dataType)
                            : [...current, dataType];
                          setSetupData({...setupData, dataCollection: newData});
                        }}
                        className={`p-2 rounded-lg border-2 transition-all text-sm ${
                          (setupData.dataCollection || []).includes(dataType)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {dataType}
                      </button>
                    ))}
                  </div>
                  <div className="flex gap-3">
                    <button
                      onClick={() => setSetupData({...setupData, dataCollection: []})}
                      className={`px-4 py-2 rounded-lg border-2 transition-all ${
                        (setupData.dataCollection || []).length === 0
                          ? 'border-blue-500 bg-blue-50 text-blue-700' 
                          : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                      }`}
                    >
                      Не собирать данные
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, showCustomData: true})}
                      className="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-gray-300"
                    >
                      Добавить данные
                    </button>
                  </div>
                  {setupData.showCustomData && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customData || ''}
                        onChange={(e) => setSetupData({...setupData, customData: e.target.value})}
                        placeholder="Введите тип данных для сбора"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customData) {
                            const current = setupData.dataCollection || [];
                            setSetupData({
                              ...setupData, 
                              dataCollection: [...current, setupData.customData],
                              customData: '',
                              showCustomData: false
                            });
                          }
                        }}
                        disabled={!setupData.customData}
                      >
                        Добавить
                      </Button>
                    </div>
                  )}
                </div>

                {/* 6. Уточнение и вопросы */}
                <div>
                  <label className="block mb-3 font-medium">6. Уточнение и вопросы</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                    {[
                      'Если запрос неполный',
                      'Если клиент сомневается',
                      'Если есть риск ошибки',
                      'При выборе продукта или услуги',
                      'Если ответ зависит от тонкостей',
                      'Если клиент проявляет интерес к нескольким вариантам',
                      'Если клиент не понимает предложенное',
                      'Если требуется индивидуальный подбор',
                      'Если клиент задаёт вопросы вне своей компетенции',
                      'Если клиент спрашивает о вещах, которые требует специальных знаний',
                      'При оформлении заявки или заказа',
                      'Перед тем как оформить что-то важное',
                      'Если клиент долго молчит'
                    ].map(question => (
                      <button
                        key={question}
                        onClick={() => {
                          const current = setupData.clarificationQuestions || [];
                          const newQuestions = current.includes(question)
                            ? current.filter(q => q !== question)
                            : [...current, question];
                          setSetupData({...setupData, clarificationQuestions: newQuestions});
                        }}
                        className={`p-3 rounded-lg border-2 transition-all text-left text-sm ${
                          (setupData.clarificationQuestions || []).includes(question)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {question}
                      </button>
                    ))}
                  </div>
                </div>

                {/* 7. Отправка смайликов */}
                <div>
                  <label className="block mb-3 font-medium">7. Отправка смайликов</label>
                  <div className="flex gap-3">
                    {[
                      { text: 'Никогда', emoji: '😐' },
                      { text: 'Редко', emoji: '😊' },
                      { text: 'Часто', emoji: '😄' }
                    ].map(option => (
                      <button
                        key={option.text}
                        onClick={() => setSetupData({...setupData, emojiUsage: option.text})}
                        className={`flex-1 p-4 rounded-lg border-2 transition-all ${
                          setupData.emojiUsage === option.text
                            ? 'border-blue-500 ring-2 ring-blue-200' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="text-center">
                          <div className="text-2xl mb-2">{option.emoji}</div>
                          <div className="font-medium">{option.text}</div>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {setupStep === 3 && (
              <div className="space-y-6">
                <h3 className="text-xl font-semibold">Шаг 3: Этапы диалога</h3>
                <p className="text-gray-600">Опишите идеальный скрипт</p>
                <p className="text-gray-600">Чем лучше вы опишите ваш скрипт, тем лучше ии-агент сможет выполнять задачи.</p>
                
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                  <div className="flex items-start gap-3">
                    <div className="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                      <span className="text-white text-sm">!</span>
                    </div>
                    <div>
                      <div className="font-medium text-blue-800 mb-1">Уделите время детальному описанию идеального скрипта</div>
                      <div className="text-sm text-blue-700">
                        Это очень важно для хорошей работы вашего ИИ-продажника. Вы сможете скорректировать поведение позже, но правильная настройка сейчас даст лучшие результаты сразу. Ниже представлен шаблон, который вам нужно адаптировать.
                      </div>
                    </div>
                  </div>
                </div>

                <div className="space-y-4">
                  {(setupData.dialogStages || [
                    'Поздоровайся и спроси имя клиента. Уточни его проблему и пойми текущую ситуацию пользователя',
                    'Опиши коротко как решишь его задачу/назови наши преимущества, предложи товары по запросу',
                    'Веди клиента к оформлению заказа/заявки',
                    'Когда клиент готов оформить заказ, сделай итог заказа и пришли ссылку на оплату из базы знаний.',
                    'Переведи клиента на менеджера для проверки оплаты и дальнейшей работы'
                  ]).map((stage, index) => (
                    <div key={index} className="border border-gray-200 rounded-lg p-4">
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-gray-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <span className="text-white text-sm">{index + 1}</span>
                        </div>
                        <div className="flex-1">
                          <Textarea
                            value={stage}
                            onChange={(e) => {
                              const newStages = [...(setupData.dialogStages || [])];
                              newStages[index] = e.target.value;
                              setSetupData({...setupData, dialogStages: newStages, dialogStagesModified: true});
                            }}
                            className="w-full resize-none"
                            rows={2}
                          />
                        </div>
                        <Button 
                          variant="ghost" 
                          size="sm"
                          onClick={() => {
                            const newStages = [...(setupData.dialogStages || [])];
                            newStages.splice(index, 1);
                            setSetupData({...setupData, dialogStages: newStages, dialogStagesModified: true});
                          }}
                        >
                          <Trash2 className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  ))}
                  
                  <Button 
                    variant="outline" 
                    onClick={() => {
                      const newStages = [...(setupData.dialogStages || []), 'Новый этап диалога'];
                      setSetupData({...setupData, dialogStages: newStages, dialogStagesModified: true});
                    }}
                    className="w-full"
                  >
                    <Plus className="w-4 h-4 mr-2" />
                    Добавить этап
                  </Button>
                </div>

                {/* Предупреждение если не изменены этапы */}
                {setupData.dialogStagesModified === false && (
                  <div className="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <div className="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                        <span className="text-white text-sm">⚠</span>
                      </div>
                      <div>
                        <div className="font-medium text-yellow-800 mb-1">Вы не внесли никаких изменений</div>
                        <div className="text-sm text-yellow-700 mb-3">
                          Он не адаптирован под ваш бизнес это может сказаться на эффективности ии-агента.
                        </div>
                        <div className="flex gap-3">
                          <Button 
                            variant="outline"
                            onClick={() => setSetupData({...setupData, dialogStagesModified: true})}
                          >
                            Внести изменения
                          </Button>
                          <Button 
                            onClick={() => setSetupData({...setupData, dialogStagesModified: true})}
                          >
                            Продолжить без изменений
                          </Button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {setupStep === 4 && (
              <div className="space-y-6">
                <h3 className="text-xl font-semibold">Шаг 4: Обучение Адапто</h3>
                <p className="text-gray-600">Загрузите минимум 1 ресурс с информацией о компании, чтобы Адапто смог обучиться на ней</p>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {[
                    { id: 'site', name: 'Сайт', description: 'Добавить URL вашего сайта', icon: Globe },
                    { id: 'feed', name: 'Товарный фид', description: 'Загрузить CSV/XML файл', icon: FileIcon },
                    { id: 'text', name: 'Написать самому', description: 'Ввести информацию вручную', icon: EditIcon },
                    { id: 'file', name: 'Файл', description: 'Загрузить документ', icon: Upload }
                  ].map((option) => (
                    <button
                      key={option.id}
                      onClick={() => setSetupData({...setupData, selectedKnowledgeType: option.id})}
                      className="p-4 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors text-left"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <option.icon className="w-5 h-5 text-blue-600" />
                        </div>
                        <div>
                          <div className="font-medium">{option.name}</div>
                          <div className="text-sm text-gray-600">{option.description}</div>
                        </div>
                      </div>
                    </button>
                  ))}
                </div>

                {/* Поле для ввода в зависимости от выбранного типа */}
                {setupData.selectedKnowledgeType && (
                  <div className="mt-6 p-4 border border-blue-200 rounded-lg bg-blue-50">
                    <h4 className="font-medium mb-3">
                      {setupData.selectedKnowledgeType === 'site' && 'Добавить URL сайта'}
                      {setupData.selectedKnowledgeType === 'feed' && 'Загрузить товарный фид'}
                      {setupData.selectedKnowledgeType === 'text' && 'Ввести информацию вручную'}
                      {setupData.selectedKnowledgeType === 'file' && 'Загрузить файл'}
                    </h4>
                    
                    {setupData.selectedKnowledgeType === 'site' && (
                      <div className="space-y-3">
                        <Input
                          value={setupData.knowledgeInput || ''}
                          onChange={(e) => setSetupData({...setupData, knowledgeInput: e.target.value})}
                          placeholder="https://example.com"
                          className="w-full"
                        />
                        <Button 
                          onClick={() => {
                            if (setupData.knowledgeInput) {
                              const newItems = [...(setupData.knowledgeItems || []), {
                                id: Date.now(),
                                type: 'site',
                                content: setupData.knowledgeInput,
                                status: 'processing'
                              }];
                              setSetupData({
                                ...setupData, 
                                knowledgeItems: newItems,
                                knowledgeInput: '',
                                selectedKnowledgeType: null
                              });
                            }
                          }}
                          disabled={!setupData.knowledgeInput}
                        >
                          Добавить сайт
                        </Button>
                      </div>
                    )}
                    
                    {setupData.selectedKnowledgeType === 'text' && (
                      <div className="space-y-3">
                        <Textarea
                          value={setupData.knowledgeInput || ''}
                          onChange={(e) => setSetupData({...setupData, knowledgeInput: e.target.value})}
                          placeholder="Введите информацию о вашей компании, продуктах, услугах..."
                          className="w-full min-h-[120px]"
                        />
                        <Button 
                          onClick={() => {
                            if (setupData.knowledgeInput) {
                              const newItems = [...(setupData.knowledgeItems || []), {
                                id: Date.now(),
                                type: 'text',
                                content: setupData.knowledgeInput,
                                status: 'processing'
                              }];
                              setSetupData({
                                ...setupData, 
                                knowledgeItems: newItems,
                                knowledgeInput: '',
                                selectedKnowledgeType: null
                              });
                            }
                          }}
                          disabled={!setupData.knowledgeInput}
                        >
                          Добавить текст
                        </Button>
                      </div>
                    )}
                    
                    {setupData.selectedKnowledgeType === 'file' && (
                      <div className="space-y-3">
                        <Input
                          type="file"
                          onChange={(e) => setSetupData({...setupData, knowledgeInput: e.target.files?.[0]?.name || ''})}
                          className="w-full"
                        />
                        <Button 
                          onClick={() => {
                            if (setupData.knowledgeInput) {
                              const newItems = [...(setupData.knowledgeItems || []), {
                                id: Date.now(),
                                type: 'file',
                                content: setupData.knowledgeInput,
                                status: 'processing'
                              }];
                              setSetupData({
                                ...setupData, 
                                knowledgeItems: newItems,
                                knowledgeInput: '',
                                selectedKnowledgeType: null
                              });
                            }
                          }}
                          disabled={!setupData.knowledgeInput}
                        >
                          Загрузить файл
                        </Button>
                      </div>
                    )}
                    
                    {setupData.selectedKnowledgeType === 'feed' && (
                      <div className="space-y-3">
                        <Input
                          type="file"
                          accept=".csv,.xml"
                          onChange={(e) => setSetupData({...setupData, knowledgeInput: e.target.files?.[0]?.name || ''})}
                          className="w-full"
                        />
                        <Button 
                          onClick={() => {
                            if (setupData.knowledgeInput) {
                              const newItems = [...(setupData.knowledgeItems || []), {
                                id: Date.now(),
                                type: 'feed',
                                content: setupData.knowledgeInput,
                                status: 'processing'
                              }];
                              setSetupData({
                                ...setupData, 
                                knowledgeItems: newItems,
                                knowledgeInput: '',
                                selectedKnowledgeType: null
                              });
                            }
                          }}
                          disabled={!setupData.knowledgeInput}
                        >
                          Загрузить фид
                        </Button>
                      </div>
                    )}
                  </div>
                )}

                {setupData.knowledgeItems && setupData.knowledgeItems.length > 0 && (
                  <div className="mt-4">
                    <h4 className="font-medium mb-2">Добавленные ресурсы:</h4>
                    <div className="space-y-2">
                      {setupData.knowledgeItems.map((item, index) => (
                        <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                              {item.type === 'site' && <Globe className="w-4 h-4 text-blue-600" />}
                              {item.type === 'text' && <EditIcon className="w-4 h-4 text-blue-600" />}
                              {item.type === 'file' && <FileIcon className="w-4 h-4 text-blue-600" />}
                              {item.type === 'feed' && <FileIcon className="w-4 h-4 text-blue-600" />}
                            </div>
                            <span className="text-sm">{item.content}</span>
                          </div>
                          <div className="text-xs text-green-600">✓ Добавлено</div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Кнопки навигации */}
            <div className="flex justify-between mt-8">
              <Button 
                variant="outline" 
                onClick={() => setSetupStep(Math.max(1, setupStep - 1))}
                disabled={setupStep === 1}
              >
                Назад
              </Button>
              
              {setupStep < 4 ? (
                <Button 
                  onClick={() => {
                    if (setupStep === 3) {
                      // Проверяем, были ли изменения в этапах диалога
                      const originalStages = [
                        'Поздоровайся и спроси имя клиента. Уточни его проблему и пойми текущую ситуацию пользователя',
                        'Опиши коротко как решишь его задачу/назови наши преимущества, предложи товары по запросу',
                        'Веди клиента к оформлению заказа/заявки',
                        'Когда клиент готов оформить заказ, сделай итог заказа и пришли ссылку на оплату из базы знаний.',
                        'Переведи клиента на менеджера для проверки оплаты и дальнейшей работы'
                      ];
                      
                      const currentStages = setupData.dialogStages || [];
                      const hasChanges = currentStages.length !== originalStages.length || 
                        currentStages.some((stage, index) => stage !== originalStages[index]);
                      
                      if (!hasChanges) {
                        setSetupData({...setupData, dialogStagesModified: false});
                      } else {
                        setSetupData({...setupData, dialogStagesModified: true});
                        setSetupStep(setupStep + 1);
                      }
                    } else {
                      setSetupStep(setupStep + 1);
                    }
                  }}
                  disabled={
                    (setupStep === 1 && !setupData.task) ||
                    (setupStep === 2 && (!setupData.addressing || !setupData.communicationStyle)) ||
                    (setupStep === 3 && (!setupData.dialogStages || setupData.dialogStages.length === 0))
                  }
                >
                  Далее
                </Button>
              ) : (
                <Button 
                  onClick={() => {
                    localStorage.setItem('hasShownSetupWizard', 'true');
                    setShowSetupWizard(false);
                    setShowModelSetupProgress(true);
                  }}
                  disabled={!setupData.knowledgeItems || setupData.knowledgeItems.length === 0}
                >
                  Завершить настройку
                </Button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Model Setup Progress Modal */}
      {showModelSetupProgress && (
        <div className="fixed inset-0 z-50 flex p-6 overflow-auto scroll-smooth">
          <div className="fixed inset-0 bg-black/50" />
          <div className="relative z-10 w-full m-auto bg-white rounded-[24px] max-w-[48rem] max-h-[90vh] overflow-hidden">
            <div className="p-[30px]">
              {/* Заголовок */}
              <div className="mb-8">
                <h2 className="text-[24px] font-[600] text-[#070F1A]">Настройка модели</h2>
                <p className="text-[14px] text-[#647491] mt-2">Мы настраиваем вашу модель под ваши требования</p>
              </div>

              {/* Таймер */}
              <div className="mb-8 text-center">
                <div className="text-[48px] font-[600] text-[#0084FF] mb-2">
                  {Math.floor(modelSetupTimer / 60)}:{(modelSetupTimer % 60).toString().padStart(2, '0')}
                </div>
                <p className="text-[14px] text-[#647491]">Осталось времени</p>
              </div>

              {/* Прогресс-бар */}
              <div className="mb-8">
                <div className="w-full bg-[#F3F5F7] rounded-[10px] h-[8px] overflow-hidden">
                  <div 
                    className="bg-[#0084FF] h-[8px] rounded-[10px] transition-all duration-1000"
                    style={{ width: `${((300 - modelSetupTimer) / 300) * 100}%` }}
                  ></div>
                </div>
                <div className="flex justify-between mt-2 text-[12px] text-[#647491]">
                  <span>0%</span>
                  <span>{Math.round(((300 - modelSetupTimer) / 300) * 100)}%</span>
                  <span>100%</span>
                </div>
              </div>

              {/* Шаги настройки */}
              <div className="space-y-4">
                {/* Шаг 1: Анализ целей и задач */}
                <div className="flex items-center p-4 border border-[#070F1A]/10 rounded-[12px] bg-[#F3F8FF]">
                  <div className="w-8 h-8 bg-[#0084FF] rounded-full flex items-center justify-center mr-4">
                    <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                  </div>
                  <div className="flex-1">
                    <h3 className="text-[16px] font-[500] text-[#070F1A]">Анализ целей и задач</h3>
                    <p className="text-[14px] text-[#647491]">Обрабатываем информацию о ваших целях и задачах</p>
                  </div>
                  <div className="text-[#0084FF] font-[500]">Завершено</div>
                </div>

                {/* Шаг 2: Настройка стиля общения */}
                <div className="flex items-center p-4 border border-[#070F1A]/10 rounded-[12px] bg-[#F3F8FF]">
                  <div className="w-8 h-8 bg-[#0084FF] rounded-full flex items-center justify-center mr-4">
                    <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                  </div>
                  <div className="flex-1">
                    <h3 className="text-[16px] font-[500] text-[#070F1A]">Настройка стиля общения</h3>
                    <p className="text-[14px] text-[#647491]">Настраиваем стиль общения и правила коммуникации</p>
                  </div>
                  <div className="text-[#0084FF] font-[500]">Завершено</div>
                </div>

                {/* Шаг 3: Создание диалоговых сценариев */}
                <div className="flex items-center p-4 border border-[#070F1A]/10 rounded-[12px] bg-[#F3F8FF]">
                  <div className="w-8 h-8 bg-[#0084FF] rounded-full flex items-center justify-center mr-4">
                    <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                  </div>
                  <div className="flex-1">
                    <h3 className="text-[16px] font-[500] text-[#070F1A]">Создание диалоговых сценариев</h3>
                    <p className="text-[14px] text-[#647491]">Формируем сценарии диалогов и воронку продаж</p>
                  </div>
                  <div className="text-[#0084FF] font-[500]">Завершено</div>
                </div>

                {/* Шаг 4: Обучение на базе знаний */}
                <div className="flex items-center p-4 border border-[#070F1A]/10 rounded-[12px] bg-[#F3F8FF]">
                  <div className="w-8 h-8 bg-[#0084FF] rounded-full flex items-center justify-center mr-4 animate-pulse">
                    <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  </div>
                  <div className="flex-1">
                    <h3 className="text-[16px] font-[500] text-[#070F1A]">Обучение на базе знаний</h3>
                    <p className="text-[14px] text-[#647491]">Обучаем модель на вашей базе знаний</p>
                  </div>
                  <div className="text-[#0084FF] font-[500]">В процессе...</div>
                </div>

                {/* Шаг 5: Финальная настройка модели */}
                <div className="flex items-center p-4 border border-[#070F1A]/10 rounded-[12px] bg-[#F3F5F7]">
                  <div className="w-8 h-8 bg-[#647491] rounded-full flex items-center justify-center mr-4">
                    <span className="text-white text-[14px] font-[500]">5</span>
                  </div>
                  <div className="flex-1">
                    <h3 className="text-[16px] font-[500] text-[#647491]">Финальная настройка модели</h3>
                    <p className="text-[14px] text-[#647491]">Завершаем настройку и оптимизацию модели</p>
                  </div>
                  <div className="text-[#647491] font-[500]">Ожидает</div>
                </div>
              </div>

              {/* Информация о процессе */}
              <div className="mt-8 p-4 bg-[#F3F8FF] border border-[#0084FF]/20 rounded-[12px]">
                <div className="flex items-start">
                  <svg className="w-5 h-5 text-[#0084FF] mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  <div>
                    <h4 className="text-[14px] font-[500] text-[#070F1A] mb-1">Что происходит сейчас?</h4>
                    <p className="text-[13px] text-[#647491]">
                      Мы анализируем вашу базу знаний и обучаем ИИ-модель на основе предоставленной информации. 
                      Это поможет боту давать более точные и релевантные ответы вашим клиентам.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Site Import Popup */}
      {showSitePopup && (
        <div className="fixed inset-0 z-50 flex items-center justify-center" style={{ backgroundColor: 'rgba(7, 15, 26, 0.6)' }}>
          <div className="bg-white rounded-[20px] w-[700px] max-h-[90vh] overflow-y-auto relative">
            <div className="p-[25px]">
              {/* Header */}
              <div className="flex items-center justify-between mb-[12px]">
                <h2 className="text-[24px] font-[600] text-[#070F1A]">Как импортировать знания?</h2>
                <button 
                  onClick={handleSitePopupClose}
                  className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
                >
                  <X className="w-5 h-5 text-gray-500" />
                </button>
              </div>

              {/* Description */}
              <p className="text-[#647491] text-[14px] mb-[30px]">
                Выберите, как вы хотите поделиться знаниями. Это научит ИИ, как отвечать на вопросы, связанные с вашим бизнесом
              </p>

              {/* Tabs */}
              <div className="flex gap-[20px] mb-[30px]">
                {/* Tab 1: Сканировать весь сайт */}
                                  <div 
                    className={`w-[315px] h-[84px] border rounded-[18px] cursor-pointer transition-all ${
                      sitePopupTab === 'full' 
                        ? 'border-[#096EFD]/60 bg-[#FFFFFF]' 
                        : 'border-[#070F1A]/10 bg-white'
                    }`}
                    onClick={() => setSitePopupTab('full')}
                  >
                    <div className="h-full flex flex-col items-center justify-center">
                      <h3 className={`text-[16px] font-[500] mb-2 ${
                        sitePopupTab === 'full' ? 'text-[#070F1A]' : 'text-[#647491]/70'
                      }`}>
                        Сканировать весь сайт
                      </h3>
                      <p className={`text-[12px] font-[400] text-center px-4 ${
                        sitePopupTab === 'full' ? 'text-[#647491]' : 'text-[#647491]/70'
                      }`}>
                        ИИ будет брать знания со всех страниц сайта
                      </p>
                    </div>
                  </div>

                {/* Tab 2: Сканировать страницы */}
                                  <div 
                    className={`w-[315px] h-[84px] border rounded-[18px] cursor-pointer transition-all ${
                      sitePopupTab === 'selective' 
                        ? 'border-[#096EFD]/60 bg-[#FFFFFF]' 
                        : 'border-[#070F1A]/10 bg-white'
                    }`}
                    onClick={() => setSitePopupTab('selective')}
                  >
                    <div className="h-full flex flex-col items-center justify-center">
                      <h3 className={`text-[16px] font-[500] mb-2 ${
                        sitePopupTab === 'selective' ? 'text-[#070F1A]' : 'text-[#647491]/70'
                      }`}>
                        Сканировать страницы
                      </h3>
                      <p className={`text-[12px] font-[400] text-center px-4 ${
                        sitePopupTab === 'selective' ? 'text-[#647491]' : 'text-[#647491]/70'
                      }`}>
                        Выберите определенные страницы сайта
                      </p>
                    </div>
                  </div>
              </div>

              {/* Tab Content */}
              {sitePopupTab === 'full' ? (
                <div className="space-y-[30px]">
                  <div>
                    <h3 className="text-[18px] font-[600] text-[#070F1A] mb-[20px]">Предоставить URL-адрес</h3>
                    <div className={`w-[650px] h-[40px] bg-white border rounded-[10px] flex items-center px-3 ${
                      siteUrlError ? 'border-red-500' : 'border-[#070F1A]/10'
                    }`}>
                      <input
                        type="url"
                        value={siteUrl}
                        onChange={(e) => handleSiteUrlChange(e.target.value)}
                        placeholder="https://mypage.com"
                        className="flex-1 bg-transparent text-[14px] font-[500] text-[#070F1A] placeholder-[#070F1A]/30 outline-none"
                      />
                    </div>
                    {siteUrlError && (
                      <p className="text-red-500 text-[12px] mt-1">{siteUrlError}</p>
                    )}
                  </div>
                </div>
              ) : (
                <div className="space-y-[30px]">
                  <div>
                    <h3 className="text-[18px] font-[600] text-[#070F1A] mb-[20px]">Предоставить URL-адреса страниц</h3>
                    
                                          {selectedPages.map((page, index) => (
                        <div key={index} className="flex items-center gap-2 mb-2">
                          <div className={`w-[650px] h-[40px] bg-white border rounded-[10px] flex items-center px-3 ${
                            selectedPagesErrors[index] ? 'border-red-500' : 'border-[#070F1A]/10'
                          }`}>
                            <input
                              type="url"
                              value={page}
                              onChange={(e) => handlePageChange(index, e.target.value)}
                              placeholder="https://mypage.com"
                              className="flex-1 bg-transparent text-[14px] font-[500] text-[#070F1A] placeholder-[#070F1A]/30 outline-none"
                            />
                          </div>
                          {selectedPages.length > 1 && (
                            <button
                              onClick={() => handleRemovePage(index)}
                              className="w-8 h-8 flex items-center justify-center text-red-500 hover:bg-red-50 rounded-[8px] transition-colors"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          )}
                          {selectedPagesErrors[index] && (
                            <p className="text-red-500 text-[12px] mt-1">{selectedPagesErrors[index]}</p>
                          )}
                        </div>
                      ))}
                    
                    <button
                      onClick={handleAddPage}
                      className="h-[34px] px-4 bg-[#096EFD] text-white rounded-[50px] hover:bg-[#096EFD]/80 transition-colors text-[12px] font-[500]"
                    >
                      Добавить страницу
                    </button>
                  </div>
                </div>
              )}

              {/* Footer */}
              <div className="mt-[10px]">
                <p className="text-[10px] text-[#647491] mb-[30px]">
                  Этот процесс может занять несколько минут и будет продолжаться в фоновом режиме.
                </p>
                <div className="flex justify-center">
                                      <button
                      onClick={handleSiteImport}
                      disabled={
                        (sitePopupTab === 'full' && (siteUrlError || !siteUrl.trim())) ||
                        (sitePopupTab === 'selective' && (selectedPagesErrors.some(err => err) || selectedPages.filter(p => p.trim()).length === 0))
                      }
                      className="w-[650px] h-[40px] bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Начать импорт
                    </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Feed Import Popup */}
      {showFeedPopup && (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
          <div className="bg-white rounded-[20px] w-[700px] p-[25px]">
            {/* Header */}
            <div className="flex justify-between items-start mb-[12px]">
              <h2 className="text-[20px] font-[600] text-[#070F1A]">Укажите URL-адрес на товарный фид</h2>
              <button
                onClick={handleFeedPopupClose}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <X className="w-5 h-5 text-gray-500" />
              </button>
            </div>

            {/* Description */}
            <p className="text-[#647491] text-[14px] mb-[30px]">
              Вставьте ссылку на товарный фид, чтобы ИИ изучил ваш каталог товаров
            </p>

            {/* Content */}
            <div className="space-y-[30px]">
              <div>
                <div className={`w-[650px] h-[40px] bg-white border rounded-[10px] flex items-center px-3 ${
                  feedUrlError ? 'border-red-500' : 'border-[#070F1A]/10'
                }`}>
                  <input
                    type="url"
                    value={feedUrl}
                    onChange={(e) => handleFeedUrlChange(e.target.value)}
                    placeholder="https://mypage.xsl"
                    className="flex-1 bg-transparent text-[14px] font-[500] text-[#070F1A] placeholder-[#070F1A]/30 outline-none"
                  />
                </div>
                {feedUrlError && (
                  <p className="text-red-500 text-[12px] mt-1">{feedUrlError}</p>
                )}
              </div>
            </div>

            {/* Footer */}
            <div className="mt-[10px]">
              <p className="text-[10px] text-[#647491] mb-[30px]">
                Этот процесс может занять несколько минут и будет продолжаться в фоновом режиме.
              </p>
              <div className="flex justify-center">
                <button
                  onClick={handleFeedImport}
                  disabled={feedUrlError || !feedUrl.trim()}
                  className="w-[650px] h-[40px] bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Начать импорт
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* File Import Popup */}
      {showFilePopup && (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
          <div className="bg-white rounded-[20px] w-[700px] p-[25px]">
            {/* Header */}
            <div className="flex justify-between items-start mb-[12px]">
              <h2 className="text-[20px] font-[600] text-[#070F1A]">Прикрепите файлы для импорта</h2>
              <button
                onClick={handleFilePopupClose}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <X className="w-5 h-5 text-gray-500" />
              </button>
            </div>

            {/* Description */}
            <p className="text-[#647491] text-[14px] mb-[30px]">
              Поддерживается загрузка файлов формата: .docx, .doc, .pdf, .txt, .xls, .xlsx
            </p>

            {/* File Upload Area */}
            <div className="space-y-[30px]">
              <div className="border-2 border-dashed border-[#070F1A]/10 rounded-[10px] p-8 text-center">
                <input
                  type="file"
                  multiple
                  accept=".docx,.doc,.pdf,.txt,.xls,.xlsx"
                  onChange={handleFileSelect}
                  className="hidden"
                  id="file-upload"
                />
                <label htmlFor="file-upload" className="cursor-pointer">
                  <div className="space-y-4">
                    <div className="mx-auto w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                      <Upload className="w-6 h-6 text-gray-400" />
                    </div>
                    <div>
                      <p className="text-[16px] font-[500] text-[#070F1A]">Прикрепить файл</p>
                      <p className="text-[12px] text-[#647491] mt-1">Максимум: 3 файла, 100 мегабайт за одну отправку.</p>
                    </div>
                  </div>
                </label>
              </div>

              {/* Selected Files */}
              {selectedFiles.length > 0 && (
                <div className="space-y-2">
                  {selectedFiles.map((file, index) => (
                    <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-[10px]">
                      <div className="flex items-center gap-3">
                        <File className="w-5 h-5 text-blue-500" />
                        <span className="text-[14px] text-[#070F1A]">{file.name}</span>
                      </div>
                      <button
                        onClick={() => handleRemoveFile(index)}
                        className="w-[34px] h-[34px] flex items-center justify-center text-red-500 hover:bg-red-50 rounded-full transition-colors"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="mt-[30px]">
              <div className="flex justify-center">
                <button
                  onClick={handleFileUpload}
                  disabled={selectedFiles.length === 0}
                  className="w-[650px] h-[40px] bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Загрузить в базу знаний
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Text Import Popup */}
      {showTextPopup && (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
          <div className="bg-white rounded-[20px] w-[700px] p-[25px]">
            {/* Header */}
            <div className="flex justify-between items-start mb-[12px]">
              <h2 className="text-[20px] font-[600] text-[#070F1A]">Введите информацию текстом</h2>
              <button
                onClick={handleTextPopupClose}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <X className="w-5 h-5 text-gray-500" />
              </button>
            </div>

            {/* Description */}
            <p className="text-[#647491] text-[14px] mb-[30px]">
              Опишите текстом то, что нужно знать ИИ для работы
            </p>

            {/* Text Area */}
            <div className="space-y-[30px]">
              <div>
                <textarea
                  value={textContent}
                  onChange={(e) => handleTextContentChange(e.target.value)}
                  placeholder="Название: EcoHarmony&#10;Сфера: Продажа экологичных товаров для дома (биоразлагаемые, без пластика).&#10;Миссия: Сделать заботу о планете простой и доступной через повседневные товары.&#10;Ценности: Экологичность, качество, прозрачность.&#10;&#10;Основные категории товаров:&#10;&#10;Ванная: Бамбуковые зубные щетки, деревянные расчески, ватные палочки.&#10;Кухня: Многоразовые салфетки, сетчатые сумки, губки из люфы.&#10;Уборка: Концентрированные средства в стекле, щетки с деревянными ручками.&#10;Подарки: Готовые эко-наборы.&#10;&#10;Услуги и политика:&#10;&#10;Доставка: По РФ, бесплатно от 3000 руб.&#10;Оплата: Карты (Visa/MC/МИР), Apple/Google Pay, наличные/карта курьеру.&#10;Программа лояльности: Накопительные баллы за покупки.&#10;&#10;Частые вопросы и короткие ответы:&#10;&#10;В: Как утилизировать бамбуковую щетку?&#10;О: Ручку — в компост или органические отходы. Щетину (нейлон-4) — отрезать и сдать в пункт приема пластика.&#10;&#10;В: Где посмотреть товары?&#10;О: Наш шоу-рум: Москва, ул. Зеленая, 15. Работаем с 10:00 до 20:00.&#10;&#10;В: Есть подарочные карты?&#10;О: Да, электронные и физические, номиналом от 1000 руб. Действуют 1 год.&#10;&#10;В: Как отследить заказ?&#10;О: Трек-номер приходит на email после отправки.&#10;&#10;В: Работаете с юрлицами?&#10;О: Да! Для корпоративных заказов пишите на corporate@ecoharmony.ru."
                  maxLength={10000}
                  className={`w-[650px] h-[200px] bg-white border rounded-[10px] p-3 resize-none ${
                    textContentError ? 'border-red-500' : 'border-[#070F1A]/10'
                  }`}
                  style={{ fontFamily: 'Inter, sans-serif', fontSize: '14px', lineHeight: '1.5' }}
                />
                {textContentError && (
                  <p className="text-red-500 text-[12px] mt-1">{textContentError}</p>
                )}
              </div>
            </div>

            {/* Footer */}
            <div className="mt-[30px]">
              <div className="flex justify-center">
                <button
                  onClick={handleTextImport}
                  disabled={textContentError || !textContent.trim()}
                  className="w-[650px] h-[40px] bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Загрузить в базу знаний
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Profile Modal */}
      {showProfileModal && (
        <div className="fixed inset-0 z-50 flex p-6 overflow-auto scroll-smooth">
          <div className="fixed inset-0 bg-black/50" onClick={() => setShowProfileModal(false)} />
          <div className="relative z-10 w-full m-auto bg-white rounded-[24px] max-w-[48rem] max-h-[90vh] overflow-hidden">
            <div className="p-[30px]">
              <div className="flex">
                {/* Левая панель - навигация */}
                <div className="shrink-0 w-[212px]">
                  <div className="mb-1">
                    <button 
                      className={`group flex items-center w-full px-4 h-[40px] rounded-[10px] border font-[500] text-[14px] transition-colors ${
                        activeProfileTab === 'profile' 
                          ? 'border-[#096EFD]/50 bg-[#F3F8FF] text-[#096EFD]' 
                          : 'border-[#070F1A]/10 text-[#647491] hover:bg-[#F3F5F7]'
                      }`}
                      onClick={() => setActiveProfileTab('profile')}
                    >
                      <svg className="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3.415 18.298c1.973-2.611 5.081-4.303 8.582-4.303s6.609 1.692 8.582 4.303l.027.036.482.697a1.93 1.93 0 0 1 .267 1.001c-.006.318-.102.615-.219.85s-.296.491-.546.687c-.333.262-.696.354-1.019.393-.283.034-.618.034-.955.034h-.046H5.425h-.046c-.337 0-.672 0-.955-.034-.322-.039-.685-.131-1.019-.393-.25-.196-.429-.452-.546-.687s-.213-.532-.219-.85a1.93 1.93 0 0 1 .267-1.001c.13-.232.312-.473.482-.697l.027-.036zM6.497 7.495a5.5 5.5 0 1 1 11 0 5.5 5.5 0 1 1-11 0z"></path>
                      </svg>
                      Личная информация
                    </button>
                  </div>
                  <div className="mb-1">
                    <button 
                      className={`group flex items-center w-full px-4 h-[40px] rounded-[10px] border font-[500] text-[14px] transition-colors ${
                        activeProfileTab === 'subscription' 
                          ? 'border-[#096EFD]/50 bg-[#F3F8FF] text-[#096EFD]' 
                          : 'border-[#070F1A]/10 text-[#647491] hover:bg-[#F3F5F7]'
                      }`}
                      onClick={() => setActiveProfileTab('subscription')}
                    >
                      <svg className="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zm0 6a1 1 0 0 1 1 1v5.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 1.414-1.414L11 13.586V8a1 1 0 0 1 1-1z"></path>
                      </svg>
                      Подписка
                    </button>
                  </div>
                  <div className="mb-1">
                    <button 
                      className={`group flex items-center w-full px-4 h-[40px] rounded-[10px] border font-[500] text-[14px] transition-colors ${
                        activeProfileTab === 'notifications' 
                          ? 'border-[#096EFD]/50 bg-[#F3F8FF] text-[#096EFD]' 
                          : 'border-[#070F1A]/10 text-[#647491] hover:bg-[#F3F5F7]'
                      }`}
                      onClick={() => setActiveProfileTab('notifications')}
                    >
                      <svg className="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8.593 20.328a1 1 0 0 1 1.411-.088c.529.467 1.223.75 1.984.75s1.455-.282 1.984-.75a1 1 0 1 1 1.323 1.5c-.881.777-2.04 1.25-3.308 1.25s-2.427-.473-3.308-1.25a1 1 0 0 1-.088-1.412zM7.039 3.04a7 7 0 0 1 9.899 0 7 7 0 0 1 2.05 4.95c0 2.913.732 4.844 1.499 6.077l.012.019.83 1.359.247.467c.032.071.068.158.096.252.023.078.068.246.051.449a1.48 1.48 0 0 1-.173.612 1.48 1.48 0 0 1-.428.47c-.25.186-.538.228-.634.242l-.005.001a4.62 4.62 0 0 1-.483.039l-1.377.013H5.353c-.577 0-1.041 0-1.377-.013l-.483-.039-.004-.001c-.096-.014-.383-.057-.634-.242a1.48 1.48 0 0 1-.428-.47c-.134-.242-.162-.475-.173-.612-.017-.204.028-.371.051-.449.028-.094.064-.181.096-.252.064-.142.151-.301.247-.467l.83-1.359.012-.019c.767-1.233 1.499-3.164 1.499-6.077a7 7 0 0 1 2.05-4.95z"></path>
                      </svg>
                      Уведомления
                    </button>
                  </div>
                  <div className="mb-1">
                    <button 
                      className={`group flex items-center w-full px-4 h-[40px] rounded-[10px] border font-[500] text-[14px] transition-colors ${
                        activeProfileTab === 'password' 
                          ? 'border-[#096EFD]/50 bg-[#F3F8FF] text-[#096EFD]' 
                          : 'border-[#070F1A]/10 text-[#647491] hover:bg-[#F3F5F7]'
                      }`}
                      onClick={() => setActiveProfileTab('password')}
                    >
                      <svg className="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.834 1.995H6.156L4.8 2.026c-.395.032-.789.104-1.167.296a3 3 0 0 0-1.311 1.311c-.193.378-.264.772-.296 1.167-.031.375-.031.829-.031 1.356v11.677l.031 1.356c.032.395.104.789.296 1.167a3 3 0 0 0 1.311 1.311c.378.193.772.264 1.167.296.375.031.829.031 1.356.031h11.677l1.356-.031c.395-.032.789-.104 1.167-.296a3 3 0 0 0 1.311-1.311c.193-.378.264-.772.296-1.167.031-.375.031-.829.031-1.356V6.156L21.964 4.8c-.032-.395-.104-.789-.296-1.167a3 3 0 0 0-1.311-1.311c-.378-.193-.772-.264-1.167-.296-.375-.031-.829-.031-1.356-.031zM13.727 13.19l.917 2.752c.119.355.178.533.142.675a.5.5 0 0 1-.216.3c-.123.078-.31.078-.685.078h-3.78c-.375 0-.562 0-.685-.078a.5.5 0 0 1-.216-.3c-.036-.141.024-.319.142-.675l.917-2.752c.071-.212.106-.317.104-.404a.42.42 0 0 0-.056-.22c-.04-.077-.146-.176-.36-.374a2.99 2.99 0 0 1-.957-2.197 3 3 0 1 1 6 0 2.99 2.99 0 0 1-.957 2.197c-.213.198-.32.298-.36.374a.42.42 0 0 0-.056.22c-.002.087.033.192.104.404z"></path>
                      </svg>
                      Пароль
                    </button>
                  </div>
                </div>

                {/* Правая панель - контент */}
                <div className="grow pl-12">
                  {activeProfileTab === 'profile' && (
                    <form>
                      <div className="mb-8">
                        <h2 className="text-[24px] font-[600] text-[#070F1A]">Личная информация</h2>
                      </div>
                    
                    <div className="mb-6">
                      <div className="mb-3">
                        <label className="text-[14px] font-[500] text-[#070F1A]">Аватар</label>
                      </div>
                      <div className="flex items-center mb-6">
                        <div className="relative flex justify-center items-center shrink-0 w-28 h-28 mr-4 rounded-full overflow-hidden bg-[#F3F5F7]">
                          <div className="w-28 h-28 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center">
                            <span className="text-[32px] font-[600] text-white">
                              {currentUser?.name ? currentUser.name.charAt(0).toUpperCase() : 'П'}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className="mb-6">
                      <div className="mb-2">
                        <label className="text-[14px] font-[500] text-[#070F1A]">Имя</label>
                      </div>
                      <div className="relative">
                        <input 
                          className="w-full h-[40px] px-4 border rounded-[10px] text-[14px] text-[#070F1A] outline-none transition-colors placeholder:text-[#647491]/50 focus:bg-transparent pl-[50px] bg-transparent border-[#070F1A]/10" 
                          placeholder="Имя пользователя" 
                          required 
                          type="text" 
                          value={currentUser?.name || ''}
                        />
                        <svg className="w-6 h-6 absolute top-2 left-4 fill-[#647491]/50 pointer-events-none" viewBox="0 0 24 24">
                          <path d="M2.264 19.81c2.506-2.658 5.933-4.314 9.728-4.314s7.222 1.656 9.728 4.314a1 1 0 0 1-.728 1.686h-18a1 1 0 0 1-.728-1.686zM6.492 7.996a5.5 5.5 0 1 1 11 0 5.5 5.5 0 1 1-11 0z"></path>
                        </svg>
                      </div>
                    </div>

                    <div className="mb-6">
                      <div className="mb-2">
                        <label className="text-[14px] font-[500] text-[#070F1A]">Компания</label>
                      </div>
                      <div className="relative">
                        <input 
                          className="w-full h-[40px] px-4 border rounded-[10px] text-[14px] text-[#070F1A] outline-none transition-colors placeholder:text-[#647491]/50 focus:bg-transparent pl-[50px] bg-transparent border-[#070F1A]/10" 
                          placeholder="Название компании" 
                          required 
                          type="text" 
                          value={currentUser?.company_name || ''}
                        />
                        <svg className="w-6 h-6 absolute top-2 left-4 pointer-events-none fill-[#647491]" viewBox="0 0 24 24">
                          <path d="M12 .996a9 9 0 0 1 9 9c0 3.119-1.744 5.365-3.529 7.224l-1.304 1.308-.056.055-1.292 1.301c-.821.865-1.491 1.692-1.925 2.559a1 1 0 0 1-1.789 0c-.434-.868-1.104-1.695-1.925-2.559a53.76 53.76 0 0 0-1.292-1.301l-.056-.055-1.304-1.308C4.744 15.361 3 13.115 3 9.996a9 9 0 0 1 9-9zm0 5.5a3 3 0 0 0 0 6 3 3 0 0 0 0-6z"></path>
                        </svg>
                      </div>
                    </div>

                    <div className="mb-6">
                      <div className="mb-2">
                        <label className="text-[14px] font-[500] text-[#070F1A]">Email</label>
                      </div>
                      <div className="relative">
                        <input 
                          className="w-full h-[40px] px-4 border rounded-[10px] text-[14px] text-[#070F1A] outline-none transition-colors placeholder:text-[#647491]/50 focus:bg-transparent pl-[50px] bg-transparent border-[#070F1A]/10" 
                          placeholder="email@example.com" 
                          required 
                          type="email" 
                          value={currentUser?.email || ''}
                        />
                        <svg className="w-6 h-6 absolute top-2 left-4 pointer-events-none fill-[#647491]" viewBox="0 0 24 24">
                          <path d="M22.707 2.777a1 1 0 0 1 0 1.414l-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L18 6.07l3.293-3.293a1 1 0 0 1 1.414 0zM6.758 13.484h4.483l2.011.044c.562.046 1.079.144 1.564.392a4 4 0 0 1 1.748 1.748c.247.485.346 1.002.392 1.564.044.541.044 1.206.044 2.011l-.01.851a1.51 1.51 0 0 1-.153.571 1.5 1.5 0 0 1-.656.656 1.51 1.51 0 0 1-.571.153c-.125.01-.268.01-.387.01-4.149-.001-8.298-.001-12.446 0-.119 0-.261 0-.387-.01a1.51 1.51 0 0 1-.571-.153 1.5 1.5 0 0 1-.656-.656c-.111-.218-.141-.426-.153-.571-.023-.282-.01-.569-.01-.851 0-.805 0-1.469.044-2.011.046-.562.144-1.079.392-1.564a4 4 0 0 1 1.748-1.748c.485-.247 1.002-.346 1.564-.392.541-.044 1.206-.044 2.011-.044zM4.5 6.984a4.5 4.5 0 0 1 9 0 4.5 4.5 0 0 1-9 0z"></path>
                        </svg>
                      </div>
                    </div>

                    <div className="mb-6">
                      <div className="mb-2">
                        <label className="text-[14px] font-[500] text-[#070F1A]">Номер телефона</label>
                      </div>
                      <div className="relative">
                        <input 
                          className="w-full h-[40px] px-4 border rounded-[10px] text-[14px] text-[#070F1A] outline-none transition-colors placeholder:text-[#647491]/50 focus:bg-transparent pl-[50px] bg-transparent border-[#070F1A]/10" 
                          placeholder="+7 (___) ___-__-__" 
                          required 
                          type="tel" 
                          value={currentUser?.phone || ''}
                        />
                        <svg className="w-6 h-6 absolute top-2 left-4 pointer-events-none fill-[#647491]" viewBox="0 0 24 24">
                          <path d="M21.97 18.33c-.03 1.47-.58 2.86-1.57 3.85-1.01 1.01-2.4 1.54-3.87 1.57-1.47.03-2.86-.58-3.85-1.57-1.01-1.01-1.54-2.4-1.57-3.87-.03-1.47.58-2.86 1.57-3.85 1.01-1.01 2.4-1.54 3.87-1.57 1.47-.03 2.86.58 3.85 1.57 1.01 1.01 1.54 2.4 1.57 3.87zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
                        </svg>
                      </div>
                    </div>

                                         <button className="w-full h-[40px] bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:bg-[#0073E6] transition-colors">
                       Сохранить изменения
                     </button>
                   </form>
                  )}

                  {activeProfileTab === 'subscription' && (
                    <div>
                      <div className="mb-8">
                        <h2 className="text-[24px] font-[600] text-[#070F1A]">Подписка</h2>
                      </div>
                      
                      {/* Текущая подписка */}
                      <div className="space-y-4 mb-6">
                        <div className="p-4 border border-[#070F1A]/10 rounded-[12px]">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-[16px] font-[500] text-[#070F1A]">Текущий план</h3>
                            <span className="px-3 py-1 bg-[#3FDD78] text-[#070F1A] rounded-[6px] text-[12px] font-[500]">Бесплатный</span>
                          </div>
                          <div className="space-y-2 text-[14px] text-[#647491]">
                            <p>• До 100 сообщений в месяц</p>
                            <p>• Базовые настройки ИИ-агента</p>
                            <p>• Поддержка по email</p>
                          </div>
                        </div>
                      </div>

                      {/* Плашка перейти на подписку */}
                      <div className="relative p-6 bg-cover bg-center rounded-[18px] overflow-hidden" style={{backgroundImage: 'url(/йы.png)'}}>
                        <div className="absolute inset-0 bg-gradient-to-r from-[#0084FF]/90 to-[#0084FF]/90"></div>
                        <div className="relative z-10 text-white">
                          <h3 className="text-[16px] font-[500] mb-2">Перейти на Адапто Pro</h3>
                          <p className="text-[14px] opacity-90 mb-4">Откройте новые возможности с Pro тарифом</p>
                          <button className="px-6 h-[34px] bg-white text-[#0084FF] rounded-[10px] font-[500] text-[14px] hover:bg-gray-50 transition-colors">
                            Перейти
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {activeProfileTab === 'notifications' && (
                    <div>
                      <div className="mb-8">
                        <h2 className="text-[24px] font-[600] text-[#070F1A]">Уведомления</h2>
                      </div>
                      
                      {/* Основной переключатель */}
                      <div className="flex items-center justify-between mb-8">
                        <div>
                          <h3 className="text-[18px] font-[500] text-[#070F1A]">Получайте уведомления в Telegram</h3>
                        </div>
                        <div className="relative inline-flex w-12 h-6 cursor-pointer rounded-full border-2 border-transparent transition-colors bg-[#096EFD]">
                          <span className="pointer-events-none inline-block w-5 h-5 rounded-full bg-white transition-all translate-x-6"></span>
                        </div>
                      </div>

                      {/* Секции уведомлений */}
                      <div className="space-y-6">
                        <div className="border-t border-[#E5E7EB] pt-6">
                          <div className="mb-4">
                            <h4 className="text-[16px] font-[500] text-[#070F1A]">Adapto Platform</h4>
                          </div>
                          <div className="space-y-3">
                            <label className="group relative flex items-start select-none cursor-pointer flex-row-reverse">
                              <input className="absolute top-0 left-0 opacity-0 invisible" type="checkbox" defaultChecked />
                              <span className="relative flex justify-center items-center shrink-0 w-6 h-6 rounded border-2 border-[#096EFD] bg-[#096EFD]">
                                <svg className="w-4 h-4 fill-white" viewBox="0 0 24 24">
                                  <path d="M18.929 5.434a1.5 1.5 0 0 1 2.246 1.98l-.125.141-11 11a1.5 1.5 0 0 1-1.98.125l-.141-.125-5-5a1.5 1.5 0 0 1 1.98-2.246l.141.125 3.939 3.939 9.94-9.939z"></path>
                                </svg>
                              </span>
                              <span className="text-[14px] text-[#070F1A] mr-auto pr-3">Новые уведомления</span>
                            </label>
                            <label className="group relative flex items-start select-none cursor-pointer flex-row-reverse">
                              <input className="absolute top-0 left-0 opacity-0 invisible" type="checkbox" defaultChecked />
                              <span className="relative flex justify-center items-center shrink-0 w-6 h-6 rounded border-2 border-[#096EFD] bg-[#096EFD]">
                                <svg className="w-4 h-4 fill-white" viewBox="0 0 24 24">
                                  <path d="M18.929 5.434a1.5 1.5 0 0 1 2.246 1.98l-.125.141-11 11a1.5 1.5 0 0 1-1.98.125l-.141-.125-5-5a1.5 1.5 0 0 1 1.98-2.246l.141.125 3.939 3.939 9.94-9.939z"></path>
                                </svg>
                              </span>
                              <span className="text-[14px] text-[#070F1A] mr-auto pr-3">Новые диалоги</span>
                            </label>
                            <label className="group relative flex items-start select-none cursor-pointer flex-row-reverse">
                              <input className="absolute top-0 left-0 opacity-0 invisible" type="checkbox" defaultChecked />
                              <span className="relative flex justify-center items-center shrink-0 w-6 h-6 rounded border-2 border-[#096EFD] bg-[#096EFD]">
                                <svg className="w-4 h-4 fill-white" viewBox="0 0 24 24">
                                  <path d="M18.929 5.434a1.5 1.5 0 0 1 2.246 1.98l-.125.141-11 11a1.5 1.5 0 0 1-1.98.125l-.141-.125-5-5a1.5 1.5 0 0 1 1.98-2.246l.141.125 3.939 3.939 9.94-9.939z"></path>
                                </svg>
                              </span>
                              <span className="text-[14px] text-[#070F1A] mr-auto pr-3">Упоминания</span>
                            </label>
                          </div>
                        </div>

                        <div className="border-t border-[#E5E7EB] pt-6">
                          <div className="mb-4">
                            <h4 className="text-[16px] font-[500] text-[#070F1A]">От команды</h4>
                          </div>
                          <div className="space-y-3">
                            <label className="group relative flex items-start select-none cursor-pointer flex-row-reverse">
                              <input className="absolute top-0 left-0 opacity-0 invisible" type="checkbox" />
                              <span className="relative flex justify-center items-center shrink-0 w-6 h-6 rounded border-2 border-[#070F1A]/20 bg-transparent">
                                <svg className="w-4 h-4 fill-white opacity-0" viewBox="0 0 24 24">
                                  <path d="M18.929 5.434a1.5 1.5 0 0 1 2.246 1.98l-.125.141-11 11a1.5 1.5 0 0 1-1.98.125l-.141-.125-5-5a1.5 1.5 0 0 1 1.98-2.246l.141.125 3.939 3.939 9.94-9.939z"></path>
                                </svg>
                              </span>
                              <span className="text-[14px] text-[#070F1A] mr-auto pr-3">Новые уведомления</span>
                            </label>
                            <label className="group relative flex items-start select-none cursor-pointer flex-row-reverse">
                              <input className="absolute top-0 left-0 opacity-0 invisible" type="checkbox" />
                              <span className="relative flex justify-center items-center shrink-0 w-6 h-6 rounded border-2 border-[#070F1A]/20 bg-transparent">
                                <svg className="w-4 h-4 fill-white opacity-0" viewBox="0 0 24 24">
                                  <path d="M18.929 5.434a1.5 1.5 0 0 1 2.246 1.98l-.125.141-11 11a1.5 1.5 0 0 1-1.98.125l-.141-.125-5-5a1.5 1.5 0 0 1 1.98-2.246l.141.125 3.939 3.939 9.94-9.939z"></path>
                                </svg>
                              </span>
                              <span className="text-[14px] text-[#070F1A] mr-auto pr-3">Приглашения в чат</span>
                            </label>
                            <label className="group relative flex items-start select-none cursor-pointer flex-row-reverse">
                              <input className="absolute top-0 left-0 opacity-0 invisible" type="checkbox" defaultChecked />
                              <span className="relative flex justify-center items-center shrink-0 w-6 h-6 rounded border-2 border-[#096EFD] bg-[#096EFD]">
                                <svg className="w-4 h-4 fill-white" viewBox="0 0 24 24">
                                  <path d="M18.929 5.434a1.5 1.5 0 0 1 2.246 1.98l-.125.141-11 11a1.5 1.5 0 0 1-1.98.125l-.141-.125-5-5a1.5 1.5 0 0 1 1.98-2.246l.141.125 3.939 3.939 9.94-9.939z"></path>
                                </svg>
                              </span>
                              <span className="text-[14px] text-[#070F1A] mr-auto pr-3">Упоминания</span>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {activeProfileTab === 'password' && (
                    <div>
                      <div className="mb-8">
                        <h2 className="text-[24px] font-[600] text-[#070F1A]">Пароль</h2>
                      </div>
                      <div className="space-y-6">
                        <div>
                          <label className="text-[14px] font-[500] text-[#070F1A] mb-2 block">Пароль</label>
                          <div className="relative">
                            <input 
                              type="password"
                              className="w-full h-[40px] px-4 border rounded-[10px] text-[14px] text-[#070F1A] outline-none transition-colors placeholder:text-[#647491]/50 focus:bg-transparent pl-[50px] bg-transparent border-[#070F1A]/10" 
                              placeholder="Пароль"
                            />
                            <svg className="w-6 h-6 absolute top-2 left-4 fill-[#647491]/50 pointer-events-none" viewBox="0 0 24 24">
                              <path d="M12 1.995a6 6 0 0 1 6 6v1.15c.283.062.554.152.816.286a4 4 0 0 1 1.748 1.748c.247.485.346 1.002.392 1.564.044.541.044 1.206.044 2.011v1.483l-.044 2.01c-.046.562-.144 1.079-.392 1.564a4 4 0 0 1-1.748 1.748c-.485.247-1.002.346-1.564.392-.541.044-1.206.044-2.01.044H8.759c-.805 0-1.469 0-2.011-.044-.562-.046-1.079-.144-1.564-.392a4 4 0 0 1-1.748-1.748c-.247-.485-.346-1.002-.392-1.564-.038-.464-.043-1.018-.044-1.674v-1.819l.044-2.011c.046-.562.144-1.079.392-1.564a4 4 0 0 1 1.748-1.748c.262-.134.533-.224.816-.286v-1.15a6 6 0 0 1 6-6zm0 11.5a1 1 0 0 0-1 1v2a1 1 0 1 0 2 0v-2a1 1 0 0 0-1-1zm0-9.5a4 4 0 0 0-4 4h0v1.002h8V7.995a4 4 0 0 0-4-4z"></path>
                            </svg>
                          </div>
                        </div>
                        <div>
                          <label className="text-[14px] font-[500] text-[#070F1A] mb-2 block">Новый пароль</label>
                          <div className="relative">
                            <input 
                              type="password"
                              className="w-full h-[40px] px-4 border rounded-[10px] text-[14px] text-[#070F1A] outline-none transition-colors placeholder:text-[#647491]/50 focus:bg-transparent pl-[50px] bg-transparent border-[#070F1A]/10" 
                              placeholder="Новый пароль"
                            />
                            <svg className="w-6 h-6 absolute top-2 left-4 fill-[#647491]/50 pointer-events-none" viewBox="0 0 24 24">
                              <path d="M12 1.995a6 6 0 0 1 6 6v1.15c.283.062.554.152.816.286a4 4 0 0 1 1.748 1.748c.247.485.346 1.002.392 1.564.044.541.044 1.206.044 2.011v1.483l-.044 2.01c-.046.562-.144 1.079-.392 1.564a4 4 0 0 1-1.748 1.748c-.485.247-1.002.346-1.564.392-.541.044-1.206.044-2.01.044H8.759c-.805 0-1.469 0-2.011-.044-.562-.046-1.079-.144-1.564-.392a4 4 0 0 1-1.748-1.748c-.247-.485-.346-1.002-.392-1.564-.038-.464-.043-1.018-.044-1.674v-1.819l.044-2.011c.046-.562.144-1.079.392-1.564a4 4 0 0 1 1.748-1.748c.262-.134.533-.224.816-.286v-1.15a6 6 0 0 1 6-6zm0 11.5a1 1 0 0 0-1 1v2a1 1 0 1 0 2 0v-2a1 1 0 0 0-1-1zm0-9.5a4 4 0 0 0-4 4h0v1.002h8V7.995a4 4 0 0 0-4-4z"></path>
                            </svg>
                          </div>
                          <div className="mt-2 text-[14px] text-[#647491]/50">Минимум 8 символов</div>
                        </div>
                        <div>
                          <label className="text-[14px] font-[500] text-[#070F1A] mb-2 block">Подтвердите новый пароль</label>
                          <div className="relative">
                            <input 
                              type="password"
                              className="w-full h-[40px] px-4 border rounded-[10px] text-[14px] text-[#070F1A] outline-none transition-colors placeholder:text-[#647491]/50 focus:bg-transparent pl-[50px] bg-transparent border-[#070F1A]/10" 
                              placeholder="Подтвердите новый пароль"
                            />
                            <svg className="w-6 h-6 absolute top-2 left-4 fill-[#647491]/50 pointer-events-none" viewBox="0 0 24 24">
                              <path d="M12 1.995a6 6 0 0 1 6 6v1.15c.283.062.554.152.816.286a4 4 0 0 1 1.748 1.748c.247.485.346 1.002.392 1.564.044.541.044 1.206.044 2.011v1.483l-.044 2.01c-.046.562-.144 1.079-.392 1.564a4 4 0 0 1-1.748 1.748c-.485.247-1.002.346-1.564.392-.541.044-1.206.044-2.01.044H8.759c-.805 0-1.469 0-2.011-.044-.562-.046-1.079-.144-1.564-.392a4 4 0 0 1-1.748-1.748c-.247-.485-.346-1.002-.392-1.564-.038-.464-.043-1.018-.044-1.674v-1.819l.044-2.011c.046-.562.144-1.079.392-1.564a4 4 0 0 1 1.748-1.748c.262-.134.533-.224.816-.286v-1.15a6 6 0 0 1 6-6zm0 11.5a1 1 0 0 0-1 1v2a1 1 0 1 0 2 0v-2a1 1 0 0 0-1-1zm0-9.5a4 4 0 0 0-4 4h0v1.002h8V7.995a4 4 0 0 0-4-4z"></path>
                            </svg>
                          </div>
                          <div className="mt-2 text-[14px] text-[#647491]/50">Минимум 8 символов</div>
                        </div>
                        <button className="w-full h-[40px] bg-[#0084FF] text-white font-[500] text-[14px] rounded-[10px] hover:bg-[#0073E6] transition-colors">
                          Изменить пароль
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
            
            {/* Кнопка закрытия */}
            <button 
              className="absolute top-5 right-5 w-6 h-6 flex items-center justify-center text-[#647491] hover:text-[#070F1A] transition-colors"
              onClick={() => setShowProfileModal(false)}
            >
              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M6.613 5.21l.094.083L12 10.585l5.293-5.292a1 1 0 0 1 1.497 1.32l-.083.094L13.414 12l5.293 5.293a1 1 0 0 1-1.32 1.497l-.094-.083L12 13.414l-5.293 5.293a1 1 0 0 1-1.497-1.32l.083-.094L10.585 12 5.293 6.707A1 1 0 0 1 6.511 5.14l.101.069z"></path>
              </svg>
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
