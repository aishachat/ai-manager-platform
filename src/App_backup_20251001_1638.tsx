import React, { useState, useEffect, useRef } from 'react';
import { crmAPI } from './crm_api_functions.js';
import { getStories, getAllStories, addStory, updateStory, deleteStory } from './api/stories.js';
import crypto from 'crypto';


// CSS —Å—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫
const phoneIconGreenStyle = {
  color: 'rgb(22 163 74 / var(--tw-text-opacity, 1))'
};

const grayIconStyle = {
  filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)'
};

// –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
const greenIconStyle = {
  filter: 'brightness(0) saturate(100%) invert(58%) sepia(96%) saturate(1234%) hue-rotate(87deg) brightness(119%) contrast(119%)'
};

// –ü—Ä–æ—Å—Ç–æ–π –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∏–∫–æ–Ω–∫–∏ –≥–∞–ª–∫–∏
const simpleGreenStyle = {
  // –£–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º CSS –∫–ª–∞—Å—Å
};

const redIconStyle = {
  filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%)'
};
// import IntegrationHelper from './integrationHelper.js'; // –£–î–ê–õ–ï–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É ai-agent-system
// –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ ai-agent-system –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ API endpoints
// –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤: ai-agent-system.js + ai-agent-endpoints.js

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
if (import.meta.env.DEV) {
  import('./developerTools.js');
}

// CSS –¥–ª—è –º–∏–≥–∞—é—â–µ–≥–æ –∫—É—Ä—Å–æ—Ä–∞ –∏ —Å—Ç–∏–ª–µ–π –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ —á–∞—Ç–∞
const cursorStyle = `
  :root {
    --accent-color: #0084FF;
  }
  
  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }
  
  @keyframes pouring {
    from {
      background-position: 0 0;
    }
    to {
      background-position: 100% 0;
    }
  }
  
  @keyframes flash {
    0% {
      background: linear-gradient(90deg, var(--accent-color, #0084FF) 0%, var(--accent-color, #0084FF) 40%, #ffffff 50%, var(--accent-color, #0084FF) 60%, var(--accent-color, #0084FF) 100%);
      background-size: 200% 100%;
      background-position: -200% 0;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    100% {
      background: linear-gradient(90deg, var(--accent-color, #0084FF) 0%, var(--accent-color, #0084FF) 40%, #ffffff 50%, var(--accent-color, #0084FF) 60%, var(--accent-color, #0084FF) 100%);
      background-size: 200% 100%;
      background-position: 200% 0;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  }
  
  .animate-flash {
    color: var(--accent-color, #0084FF);
    font-weight: 600;
    animation: flash 4s linear infinite;
  }

  /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫—Ä—É–∂–∫–æ–≤ –≤ –ø–ª–∞—à–∫–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –¥–∏–∞–ª–æ–≥–∞ */
  @keyframes pulse-1 {
    0%, 80%, 100% { opacity: 0.25; }
    40% { opacity: 1; }
  }
  
  @keyframes pulse-2 {
    0%, 80%, 100% { opacity: 0.5; }
    40% { opacity: 1; }
  }
  
  @keyframes pulse-3 {
    0%, 80%, 100% { opacity: 1; }
    40% { opacity: 0.25; }
  }

  .animate-pulse-1 {
    animation: pulse-1 2s linear infinite;
  }
  
  .animate-pulse-2 {
    animation: pulse-2 2s linear infinite 0.3s;
  }
  
  .animate-pulse-3 {
    animation: pulse-3 2s linear infinite 0.6s;
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ —á–∞—Ç–∞ */
  .chat-search-input {
    border: 1px solid rgba(7, 15, 26, 0.1) !important;
    background-color: white !important;
    color: #8E8E93 !important;
    transition: all 0.2s ease;
  }
  
  .chat-search-input::placeholder {
    color: #8E8E93 !important;
  }
  
  .chat-search-input:focus {
    outline: none !important;
    border-color: transparent !important;
    background-color: #F9FAFB !important;
    color: #070F1A !important;
    box-shadow: none !important;
    ring: none !important;
  }
  
  .chat-search-input:focus::placeholder {
    color: #8E8E93 !important;
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
  .user-dropdown button.group:hover img:not([style*="invert(27%)"]) {
    filter: brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%) !important;
  }
`;

// Global styles for buttons and inputs
const BUTTON_STYLES = {
  // Blue button with shadows and 13px font
  blueButton: {
    fontSize: '13px',
    fontWeight: '500',
    boxShadow: 'rgba(95, 122, 143, 0.25) 0px 2px 3px, rgba(0, 0, 0, 0.11) -2px -2px 3px inset, rgba(255, 255, 255, 0.19) 2px 2px 3px inset'
  },
  // White/gray button with shadows
  whiteButton: {
    fontSize: '13px',
    fontWeight: '500',
    backgroundColor: '#F6F6F8',
    border: 'none',
    boxShadow: 'rgba(95, 122, 143, 0.25) 0px 1px 2px, rgb(255, 255, 255) 1px 1px 1px 0px inset'
  },
  // Disabled button
  disabledButton: {
    fontSize: '13px',
    fontWeight: '500',
    backgroundColor: '#F6F6F8',
    color: '#070F1A',
    border: 'none',
    boxShadow: 'rgba(95, 122, 143, 0.25) 0px 1px 2px, rgba(0, 0, 0, 0.03) -1px -1px 1px inset, rgb(255, 255, 255) 1px 1px 1px 0px inset'
  }
};

const INPUT_STYLES = {
  // Input field with shadows and 13px font
  inputField: {
    fontSize: '13px',
    border: 'none',
    boxShadow: 'rgba(95, 122, 143, 0.25) 0px 1px 2px, rgba(0, 0, 0, 0.03) -1px -1px 1px inset, rgb(255, 255, 255) 1px 1px 1px 0px inset'
  }
};

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ head
if (typeof document !== 'undefined') {
  const style = document.createElement('style');
  style.textContent = cursorStyle;
  document.head.appendChild(style);
}

import { knowledgeBase, botCorrections as botCorrectionsAPI, testConnection, users, supabase, supabaseAdmin, chatHistory as chatHistoryAPI, agentSettings, modelSettings, userLimits as userLimitsAPI, dialogsDB, statsAPI } from './supabaseClient.js';
import { operatorStatusAPI } from './operatorStatusAPI.js';
import HourlyActivityChart from './components/HourlyActivityChart.jsx';
import ChannelStatistics from './components/ChannelStatistics.jsx';

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
const API_CONFIG = {
  BASE_URL: import.meta.env.VITE_API_URL || 'https://adaptoai.ru',
  CHAT_ENDPOINT: '/api/chat/message',
  WIDGET_ENDPOINT: '/api/widget/chat',
  WEBSOCKET_ENDPOINT: '/dialogs'
};

// –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
const createUnifiedMessage = (data) => {
  const baseMessage = {
    id: data.id || `msg_${Date.now()}_${Math.random()}`,
    text: data.text || '',
    time: data.time || '–¢–æ–ª—å–∫–æ —á—Ç–æ',
    timestamp: data.timestamp || Date.now(),
    isTyping: data.isTyping || false
  };

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  if (data.type) {
    // –ê–¥–º–∏–Ω—Å–∫–∏–π —á–∞—Ç –∏ –¥–∏–∞–ª–æ–≥–∏
    baseMessage.type = data.type; // 'user', 'assistant', 'operator', 'system'
    baseMessage.sender_role = data.sender_role || data.type;
  } else if (data.isUser !== undefined) {
    // –í–∏–¥–∂–µ—Ç —á–∞—Ç
    baseMessage.type = data.isUser ? 'user' : 'assistant';
    baseMessage.sender_role = data.isUser ? 'user' : 'assistant';
  }

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
  if (data.operatorId || data.operatorName) {
    baseMessage.operatorId = data.operatorId;
    baseMessage.operatorName = data.operatorName;
    baseMessage.sender = data.sender || 'operator';
  }

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  if (data.isUser !== undefined) {
    baseMessage.isUser = data.isUser;
  }

  return baseMessage;
};

// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
const MessageUtils = {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  isUserMessage: (message) => {
    return message.type === 'user' || message.isUser === true;
  },

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  isOperatorMessage: (message) => {
    return message.type === 'operator' || message.sender_role === 'operator';
  },

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ò–ò
  isAssistantMessage: (message) => {
    return message.type === 'assistant' || (message.isUser === false && message.type !== 'operator');
  },

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–º
  isSystemMessage: (message) => {
    return message.type === 'system' || message.sender_role === 'system';
  },

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  getSenderName: (message) => {
    if (message.operatorName) return message.operatorName;
    if (message.type === 'user') return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    if (message.type === 'assistant') return '–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç';
    if (message.type === 'operator') return '–û–ø–µ—Ä–∞—Ç–æ—Ä';
    if (message.type === 'system') return '–°–∏—Å—Ç–µ–º–∞';
    return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  }
};

// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π
const MessageComponent = React.memo(({ message, getMessageAlignment, getMessageOrder, getMessageStyle, getMessageFooter, aiAgentName }) => {
  return (
    <div className={`mb-4 ${getMessageAlignment(message)}`}>
      <div className={`max-w-[80%] ${getMessageOrder(message)}`}>
        <div className={`flex ${getMessageAlignment(message)} items-end`}>
          <div className={`max-w-[70%] p-3 text-[14px] ${getMessageStyle(message)}`}>
            {message.isTyping ? <TypingIndicator /> : message.text}
          </div>
        </div>
        {getMessageFooter(message)}
      </div>
    </div>
  );
});

// –í–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
const VirtualizedMessageList = React.memo(({ messages, getMessageAlignment, getMessageOrder, getMessageStyle, getMessageFooter, aiAgentName, containerRef }) => {
  const [visibleRange, setVisibleRange] = React.useState({ start: 0, end: 50 });
  const [containerHeight, setContainerHeight] = React.useState(0);
  const [itemHeight, setItemHeight] = React.useState(80);

  // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
  const handleScroll = React.useCallback(() => {
    if (!containerRef.current) return;
    
    const scrollTop = containerRef.current.scrollTop;
    const start = Math.floor(scrollTop / itemHeight);
    const end = Math.min(start + Math.ceil(containerHeight / itemHeight) + 10, messages.length);
    
    setVisibleRange({ start, end });
  }, [containerHeight, itemHeight, messages.length]);

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  React.useEffect(() => {
    if (!containerRef.current) return;
    
    const updateDimensions = () => {
      const rect = containerRef.current.getBoundingClientRect();
      setContainerHeight(rect.height);
    };
    
    updateDimensions();
    window.addEventListener('resize', updateDimensions);
    return () => window.removeEventListener('resize', updateDimensions);
  }, []);

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
  React.useEffect(() => {
    if (!containerRef.current) return;
    
    containerRef.current.addEventListener('scroll', handleScroll);
    return () => containerRef.current?.removeEventListener('scroll', handleScroll);
  }, [handleScroll]);

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  const visibleMessages = messages.slice(visibleRange.start, visibleRange.end);
  const offsetY = visibleRange.start * itemHeight;
  const totalHeight = messages.length * itemHeight;

  return (
    <div style={{ height: totalHeight, position: 'relative' }}>
      <div style={{ transform: `translateY(${offsetY}px)` }}>
        {visibleMessages.map((message, index) => (
          <MessageComponent
            key={message.id}
            message={message}
            getMessageAlignment={getMessageAlignment}
            getMessageOrder={getMessageOrder}
            getMessageStyle={getMessageStyle}
            getMessageFooter={getMessageFooter}
            aiAgentName={aiAgentName}
          />
        ))}
      </div>
    </div>
  );
});

// –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —á–∞—Ç–æ–≤
const ChatUtils = {
  // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
  createLoadingMessage: (type = 'assistant', isUser = false) => {
    return createUnifiedMessage({
      id: `loading_${Date.now()}_${Math.random()}`,
      type: type,
      text: '',
      time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
      timestamp: Date.now(),
      isTyping: true,
      isUser: isUser
    });
  },

  // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
  createErrorMessage: (errorText = '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.') => {
    return createUnifiedMessage({
      id: `error_${Date.now()}_${Math.random()}`,
      type: 'assistant',
      text: errorText,
      time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
      timestamp: Date.now()
    });
  },

  // –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  removeLoadingMessage: (messages) => {
    return messages.filter(msg => !msg.isTyping);
  },

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –º–∞—Å—Å–∏–≤ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
  addMessageAndRemoveLoading: (messages, newMessage) => {
    const withoutLoading = ChatUtils.removeLoadingMessage(messages);
    return [...withoutLoading, newMessage];
  },

  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∏–∑—É —á–∞—Ç–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
  scrollToBottom: (ref, delay = 100) => {
    setTimeout(() => {
      if (ref && ref.current) {
        ref.current.scrollTop = ref.current.scrollHeight;
      }
    }, delay);
  },

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
  handleChatError: (error, showNotification) => {
    console.error('Chat error:', error);
    const errorMessage = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
    if (showNotification) {
      showNotification(`‚ùå –û—à–∏–±–∫–∞: ${errorMessage}`);
    }
    return ChatUtils.createErrorMessage();
  },

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ retry –ª–æ–≥–∏–∫–æ–π
  saveMessageToDB: async (userId, messageType, messageText, channel, chatHistoryAPI) => {
    return ChatUtils.retryRequest(async () => {
      await chatHistoryAPI.saveMessage(userId, messageType, messageText, channel);
    }, {
      maxRetries: 2,
      baseDelay: 500,
      retryCondition: (error) => {
        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ –∏ 5xx —Å—Ç–∞—Ç—É—Å–æ–≤
        return !error.response || error.response.status >= 500;
      }
    }).catch(error => {
      console.warn('Failed to save message to DB after retries:', error);
      // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
    });
  },

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
  loadChatHistoryOptimized: async (userId, channel, chatHistoryAPI, page = 1, limit = 50) => {
    try {
      const history = await chatHistoryAPI.getHistory(userId, channel, page, limit);
      return {
        messages: history || [],
        hasMore: (history || []).length === limit,
        page: page
      };
    } catch (error) {
      console.warn('Failed to load chat history:', error);
      return { messages: [], hasMore: false, page: 1 };
    }
  },

  // –î–µ–±–∞—É–Ω—Å –¥–ª—è –ø–æ–∏—Å–∫–∞
  debounce: (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  },

  // –ú–µ–º–æ–∏–∑–∞—Ü–∏—è –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
  memoize: (fn) => {
    const cache = new Map();
    return (...args) => {
      const key = JSON.stringify(args);
      if (cache.has(key)) {
        return cache.get(key);
      }
      const result = fn(...args);
      cache.set(key, result);
      return result;
    };
  },

  // Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  retryRequest: async (requestFn, options = {}) => {
    const {
      maxRetries = 3,
      baseDelay = 1000,
      maxDelay = 10000,
      backoffFactor = 2,
      retryCondition = (error) => {
        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ –∏ 5xx —Å—Ç–∞—Ç—É—Å–æ–≤
        return !error.response || error.response.status >= 500;
      }
    } = options;

    let lastError;
    
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        const result = await requestFn();
        return result;
      } catch (error) {
        lastError = error;
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è retry
        if (attempt === maxRetries || !retryCondition(error)) {
          throw error;
        }
        
        // –í—ã—á–∏—Å–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
        const delay = Math.min(
          baseDelay * Math.pow(backoffFactor, attempt),
          maxDelay
        );
        
        console.warn(`Request failed (attempt ${attempt + 1}/${maxRetries + 1}), retrying in ${delay}ms:`, error.message);
        
        // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
    
    throw lastError;
  },

  // Retry –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
  retrySendMessage: async (sendFn, messageData, options = {}) => {
    return ChatUtils.retryRequest(async () => {
      return await sendFn(messageData);
    }, {
      maxRetries: 2,
      baseDelay: 500,
      retryCondition: (error) => {
        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫, —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ 5xx
        return !error.response || 
               error.response.status >= 500 || 
               error.code === 'NETWORK_ERROR' ||
               error.message.includes('timeout');
      },
      ...options
    });
  },

  // Retry –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
  retryApiRequest: async (apiFn, options = {}) => {
    return ChatUtils.retryRequest(apiFn, {
      maxRetries: 3,
      baseDelay: 1000,
      retryCondition: (error) => {
        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ –∏ 5xx —Å—Ç–∞—Ç—É—Å–æ–≤
        return !error.response || error.response.status >= 500;
      },
      ...options
    });
  },

  // Retry –¥–ª—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  retryWebSocketConnection: (wsUrl, options = {}) => {
    const {
      maxRetries = 5,
      baseDelay = 2000,
      onConnect = () => {},
      onError = () => {},
      onRetry = () => {}
    } = options;

    let retryCount = 0;
    
    const connect = () => {
      try {
        const ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          console.log('WebSocket connected successfully');
          retryCount = 0;
          onConnect(ws);
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          onError(error);
          
          if (retryCount < maxRetries) {
            retryCount++;
            const delay = baseDelay * Math.pow(2, retryCount - 1);
            console.log(`WebSocket retry ${retryCount}/${maxRetries} in ${delay}ms`);
            
            setTimeout(() => {
              onRetry(retryCount);
              connect();
            }, delay);
          } else {
            console.error('WebSocket max retries exceeded');
          }
        };
        
        ws.onclose = (event) => {
          if (!event.wasClean && retryCount < maxRetries) {
            retryCount++;
            const delay = baseDelay * Math.pow(2, retryCount - 1);
            console.log(`WebSocket reconnecting ${retryCount}/${maxRetries} in ${delay}ms`);
            
            setTimeout(() => {
              onRetry(retryCount);
              connect();
            }, delay);
          }
        };
        
        return ws;
      } catch (error) {
        console.error('WebSocket connection error:', error);
        onError(error);
        return null;
      }
    };
    
    return connect();
  }
};

// Offline —Ä–µ–∂–∏–º –¥–ª—è —á–∞—Ç–æ–≤
const OfflineManager = {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ç–∏
  isOnline: () => navigator.onLine,
  
  // –ö–ª—é—á–∏ –¥–ª—è localStorage
  KEYS: {
    OFFLINE_MESSAGES: 'offline_messages',
    CHAT_HISTORY_CACHE: 'chat_history_cache',
    NETWORK_STATUS: 'network_status',
    LAST_SYNC: 'last_sync'
  },

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ offline —Ä–µ–∂–∏–º–µ
  saveOfflineMessage: (message, channel = 'admin') => {
    try {
      const offlineMessages = OfflineManager.getOfflineMessages();
      const messageWithMeta = {
        ...message,
        channel,
        timestamp: Date.now(),
        offline: true,
        synced: false
      };
      
      offlineMessages.push(messageWithMeta);
      localStorage.setItem(OfflineManager.KEYS.OFFLINE_MESSAGES, JSON.stringify(offlineMessages));
      
      console.log('üíæ Message saved offline:', messageWithMeta);
      return messageWithMeta;
    } catch (error) {
      console.error('Failed to save offline message:', error);
      return null;
    }
  },

  // –ü–æ–ª—É—á–µ–Ω–∏–µ offline —Å–æ–æ–±—â–µ–Ω–∏–π
  getOfflineMessages: () => {
    try {
      const messages = localStorage.getItem(OfflineManager.KEYS.OFFLINE_MESSAGES);
      return messages ? JSON.parse(messages) : [];
    } catch (error) {
      console.error('Failed to get offline messages:', error);
      return [];
    }
  },

  // –û—á–∏—Å—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö offline —Å–æ–æ–±—â–µ–Ω–∏–π
  clearOfflineMessages: () => {
    try {
      localStorage.removeItem(OfflineManager.KEYS.OFFLINE_MESSAGES);
      console.log('üßπ Offline messages cleared');
    } catch (error) {
      console.error('Failed to clear offline messages:', error);
    }
  },

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è offline —Å–æ–æ–±—â–µ–Ω–∏–π
  syncOfflineMessages: async (sendFn, chatHistoryAPI) => {
    if (!OfflineManager.isOnline()) {
      console.log('üì¥ Still offline, skipping sync');
      return;
    }

    const offlineMessages = OfflineManager.getOfflineMessages();
    if (offlineMessages.length === 0) {
      console.log('‚úÖ No offline messages to sync');
      return;
    }

    console.log(`üîÑ Syncing ${offlineMessages.length} offline messages...`);

    for (const message of offlineMessages) {
      try {
        if (message.synced) continue;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await sendFn(message);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        await chatHistoryAPI.saveMessage(
          message.userId || 'offline_user',
          message.type || 'user',
          message.text,
          message.channel || 'admin'
        );

        // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ
        message.synced = true;
        message.syncedAt = Date.now();
        
        console.log('‚úÖ Message synced:', message.id);
      } catch (error) {
        console.error('‚ùå Failed to sync message:', message.id, error);
        // –ù–µ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º localStorage
    localStorage.setItem(OfflineManager.KEYS.OFFLINE_MESSAGES, JSON.stringify(offlineMessages));
    
    // –£–¥–∞–ª—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    const unsyncedMessages = offlineMessages.filter(msg => !msg.synced);
    localStorage.setItem(OfflineManager.KEYS.OFFLINE_MESSAGES, JSON.stringify(unsyncedMessages));
    
    console.log(`üéâ Sync completed. ${offlineMessages.length - unsyncedMessages.length} messages synced, ${unsyncedMessages.length} remaining`);
  },

  // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
  cacheChatHistory: (messages, channel = 'admin') => {
    try {
      const cache = {
        messages,
        channel,
        timestamp: Date.now(),
        version: '1.0'
      };
      
      localStorage.setItem(
        `${OfflineManager.KEYS.CHAT_HISTORY_CACHE}_${channel}`,
        JSON.stringify(cache)
      );
      
      console.log(`üíæ Chat history cached for ${channel}:`, messages.length, 'messages');
    } catch (error) {
      console.error('Failed to cache chat history:', error);
    }
  },

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏
  getCachedChatHistory: (channel = 'admin') => {
    try {
      const cache = localStorage.getItem(`${OfflineManager.KEYS.CHAT_HISTORY_CACHE}_${channel}`);
      if (!cache) return null;
      
      const parsed = JSON.parse(cache);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∫—ç—à–∞ (24 —á–∞—Å–∞)
      const isExpired = Date.now() - parsed.timestamp > 24 * 60 * 60 * 1000;
      if (isExpired) {
        localStorage.removeItem(`${OfflineManager.KEYS.CHAT_HISTORY_CACHE}_${channel}`);
        return null;
      }
      
      console.log(`üì± Using cached chat history for ${channel}:`, parsed.messages.length, 'messages');
      return parsed.messages;
    } catch (error) {
      console.error('Failed to get cached chat history:', error);
      return null;
    }
  },

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ç–∏
  updateNetworkStatus: (isOnline) => {
    try {
      localStorage.setItem(OfflineManager.KEYS.NETWORK_STATUS, JSON.stringify({
        isOnline,
        timestamp: Date.now()
      }));
    } catch (error) {
      console.error('Failed to update network status:', error);
    }
  },

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ç–∏
  getNetworkStatus: () => {
    try {
      const status = localStorage.getItem(OfflineManager.KEYS.NETWORK_STATUS);
      return status ? JSON.parse(status) : { isOnline: true, timestamp: Date.now() };
    } catch (error) {
      console.error('Failed to get network status:', error);
      return { isOnline: true, timestamp: Date.now() };
    }
  }
};

// –£—Ç–∏–ª–∏—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è —á–∞—Ç–∞
const SECURITY_CONFIG = {
  MAX_MESSAGE_LENGTH: 4000,
  MIN_MESSAGE_LENGTH: 1,
  RATE_LIMIT_WINDOW: 60000, // 1 –º–∏–Ω—É—Ç–∞
  RATE_LIMIT_MAX_MESSAGES: 10,
  ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br', 'p'],
  DANGEROUS_PATTERNS: [
    /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
    /javascript:/gi,
    /on\w+\s*=/gi,
    /<iframe/gi,
    /<object/gi,
    /<embed/gi
  ]
};

// Rate limiting storage
const rateLimitStorage = new Map();

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
const validateMessage = (message) => {
  const errors = [];
  
  if (!message || typeof message !== 'string') {
    errors.push('–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π');
    return { isValid: false, errors };
  }
  
  const trimmedMessage = message.trim();
  
  if (trimmedMessage.length < SECURITY_CONFIG.MIN_MESSAGE_LENGTH) {
    errors.push('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
  }
  
  if (trimmedMessage.length > SECURITY_CONFIG.MAX_MESSAGE_LENGTH) {
    errors.push(`–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º ${SECURITY_CONFIG.MAX_MESSAGE_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤)`);
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
  for (const pattern of SECURITY_CONFIG.DANGEROUS_PATTERNS) {
    if (pattern.test(trimmedMessage)) {
      errors.push('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç');
      break;
    }
  }
  
  return {
    isValid: errors.length === 0,
    errors,
    sanitizedMessage: trimmedMessage
  };
};

// –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è HTML
const sanitizeMessage = (message) => {
  if (!message || typeof message !== 'string') return '';
  
  // –£–¥–∞–ª—è–µ–º –≤—Å–µ HTML —Ç–µ–≥–∏ –∫—Ä–æ–º–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö
  let sanitized = message.replace(/<(?![\/]?(?:b|i|em|strong|br|p)(?:\s|>))/gi, '&lt;');
  sanitized = sanitized.replace(/(?<![\/])(?:b|i|em|strong|br|p)(?=\s|>)/gi, (match) => match.toLowerCase());
  
  // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
  sanitized = sanitized
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
  
  return sanitized;
};

// –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
const TypingIndicator = () => (
  <div className="flex items-center space-x-1">
    <div className="flex space-x-1">
      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
    </div>
  </div>
);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit
const checkRateLimit = (userId) => {
  const now = Date.now();
  const userKey = `user_${userId}`;
  
  if (!rateLimitStorage.has(userKey)) {
    rateLimitStorage.set(userKey, { count: 1, resetTime: now + SECURITY_CONFIG.RATE_LIMIT_WINDOW });
    return { allowed: true, remaining: SECURITY_CONFIG.RATE_LIMIT_MAX_MESSAGES - 1 };
  }
  
  const userLimit = rateLimitStorage.get(userKey);
  
  if (now > userLimit.resetTime) {
    // –°–±—Ä–æ—Å –ª–∏–º–∏—Ç–∞
    rateLimitStorage.set(userKey, { count: 1, resetTime: now + SECURITY_CONFIG.RATE_LIMIT_WINDOW });
    return { allowed: true, remaining: SECURITY_CONFIG.RATE_LIMIT_MAX_MESSAGES - 1 };
  }
  
  if (userLimit.count >= SECURITY_CONFIG.RATE_LIMIT_MAX_MESSAGES) {
    return { 
      allowed: false, 
      remaining: 0, 
      resetTime: userLimit.resetTime 
    };
  }
  
  userLimit.count++;
  return { 
    allowed: true, 
    remaining: SECURITY_CONFIG.RATE_LIMIT_MAX_MESSAGES - userLimit.count 
  };
};

// –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–º–ø–æ—Ä—Ç–∞
console.log('supabase:', supabase);
console.log('chatHistoryAPI:', chatHistoryAPI);
console.log('chatHistoryAPI.clearChatHistory:', chatHistoryAPI.clearChatHistory);
// import { processContent } from './gigaChatAPI.js'; // –£–¥–∞–ª–µ–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º RAG —Å–∏—Å—Ç–µ–º—É
import { 
  BarChart3, 
  MessageSquare, 
  Database, 
  Settings, 
  Zap, 
  Plus,
  Users, 
  Send, 
  AlertTriangle,
  Globe,
  Link as LinkIcon,
  Edit as EditIcon,
  File as FileIcon,
  Trash2,
  Info,
  ChevronRight,
  ExternalLink,
  Menu,
  X,
  User,
  Building,
  Mail,
  Lock,
  Eye,
  EyeOff,
  CheckCircle,
  Upload,
  Download,
  Search,
  Filter,
  MoreHorizontal,
  MoreVertical,
  Home,
  HelpCircle,
  Link,
  File,
  Calendar,
  FileText,
  FileSpreadsheet,
  Clock,
  Phone,
  Hash,
  CreditCard,
  Bell
} from 'lucide-react';

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–µ—á–∞—Ç–∏

// UI Components
const Button = ({ children, className = '', onClick, disabled = false, variant = 'default', size = 'default', type = 'button' as const, ...props }) => {
  const baseClasses = 'inline-flex items-center justify-center rounded-[10px] font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background';
  
  const variants = {
    default: 'bg-primary text-primary-foreground hover:bg-primary/90',
    destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
    outline: 'border border-input hover:bg-accent hover:text-accent-foreground',
    secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
    ghost: 'hover:bg-accent hover:text-accent-foreground',
    link: 'underline-offset-4 hover:underline text-primary'
  };

  const sizes = {
    default: 'h-10 py-2 px-4',
    sm: 'h-9 px-3 rounded-[10px]',
    lg: 'h-11 px-8 rounded-[10px]',
    icon: 'h-10 w-10'
  };

  const variantClass = variants[variant] || variants.default;
  const sizeClass = sizes[size] || sizes.default;

  return (
    <button
      type={type}
      className={`${baseClasses} ${variantClass} ${sizeClass} ${className}`}
      onClick={onClick}
      disabled={disabled}
      {...props}
    >
      {children}
    </button>
  );
};

const Input = ({ className = '', type = 'text', style = {}, ...props }) => (
  <input
    type={type}
    className={`flex h-[34px] w-full rounded-[10px] bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-[#070F1A]/60 focus:outline-none focus:ring-0 focus:placeholder:text-[#070F1A]/40 disabled:cursor-not-allowed disabled:opacity-50 ${className}`}
    style={{ ...INPUT_STYLES.inputField, ...style }}
    {...props}
  />
);

const Textarea = ({ className = '', style = {}, ...props }) => (
  <textarea
    className={`flex min-h-[124px] w-full rounded-[10px] bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-[#070F1A]/60 focus:outline-none focus:ring-0 focus:placeholder:text-[#070F1A]/40 disabled:cursor-not-allowed disabled:opacity-50 ${className}`}
    style={{ ...INPUT_STYLES.inputField, ...style }}
    {...props}
  />
);

const Card = ({ className = '', ...props }) => (
  <div className={`rounded-[15px] border bg-card text-card-foreground ${className}`} {...props} />
);

const CardHeader = ({ className = '', ...props }) => (
  <div className={`flex flex-col space-y-1.5 p-6 ${className}`} {...props} />
);

const CardTitle = ({ className = '', ...props }) => (
  <h3 className={`text-lg font-semibold leading-none tracking-tight ${className}`} {...props} />
);

const CardContent = ({ className = '', ...props }) => (
  <div className={`p-6 pt-0 ${className}`} {...props} />
);

const Select = ({ children, value, onValueChange, ...props }: { children: React.ReactNode, value: string, onValueChange?: (value: string) => void, [key: string]: any }) => {
  return (
    <select
      value={value}
      onChange={(e) => onValueChange && onValueChange(e.target.value)}
      className="flex h-10 w-full items-center justify-between rounded-[10px] border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
      {...props}
    >
      {children}
    </select>
  );
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ UUID –≤ –±—Ä–∞—É–∑–µ—Ä–µ
function generateUUID() {
  // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

export default function App() {

  // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
  React.useEffect(() => {
    const style = document.createElement('style');
    style.textContent = `
      @keyframes typing-bounce {
        0%, 60%, 100% {
          transform: translateY(0) scale(1);
          opacity: 0.3;
        }
        30% {
          transform: translateY(-12px) scale(1.1);
          opacity: 1;
        }
      }
      
      input::placeholder {
        opacity: 1;
        transition: opacity 0.2s ease;
      }
      input:focus::placeholder {
        opacity: 0.3;
      }
    `;
    document.head.appendChild(style);
    
    return () => {
      document.head.removeChild(style);
    };
  }, []);

  // State - –ë–ï–ó localStorage, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Supabase session
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [isLoadingAuth, setIsLoadingAuth] = useState(true); // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  
  const [activeSection, setActiveSection] = useState(() => {
    return localStorage.getItem('currentSection') || 'main';
  });
  
  // –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const [debugMode, setDebugMode] = useState(false);
  const [originalUser, setOriginalUser] = useState(null);
  
  // –ü–ª–∞—à–∫–∞ "–í—Å—Ç—É–ø–∏—Ç—å –≤ –¥–∏–∞–ª–æ–≥"
  const [showJoinDialogPlaque, setShowJoinDialogPlaque] = useState(false);
  
  const isOperator = currentUser?.role === 'operator';
  
  const [currentStep, setCurrentStep] = useState('login');
  const [currentSlide, setCurrentSlide] = useState(0);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  
  // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞
  console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–∞:', { currentStep, currentSlide });
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [showPasswordField, setShowPasswordField] = useState(false);
  const [showSuccessModal, setShowSuccessModal] = useState(false);
  const [showNotification, setShowNotification] = useState(false);
  const [notificationMessage, setNotificationMessage] = useState('');
  const [systemNotification, setSystemNotification] = useState('');
  const [showSystemNotification, setShowSystemNotification] = useState(false);
  const [showSetupWizard, setShowSetupWizard] = useState(false);
  const [stories, setStories] = useState([]);
  const [showStoriesModal, setShowStoriesModal] = useState(false);
  const dialogChatRef = useRef(null);
  const [editingStory, setEditingStory] = useState(null);
  const [newStoryTitle, setNewStoryTitle] = useState('');
  const [newStoryImage, setNewStoryImage] = useState('');
  const [setupStep, setSetupStep] = useState(1);
  const [setupProgress, setSetupProgress] = useState(0);
  const [completedSteps, setCompletedSteps] = useState([]);
  const [expandedStep, setExpandedStep] = useState(null);
  const [showSetupGuide, setShowSetupGuide] = useState(true);
  const [showValidationMessage, setShowValidationMessage] = useState(false);
  const [showProgressBar, setShowProgressBar] = useState(false);
  const [showIntegrationModal, setShowIntegrationModal] = useState(false);
  const [selectedIntegration, setSelectedIntegration] = useState(null);
  const [showWidgetConstructor, setShowWidgetConstructor] = useState(false);
  const [showWidgetModal, setShowWidgetModal] = useState(false);
  const [showProfileModal, setShowProfileModal] = useState(false);
  const [profileTab, setProfileTab] = useState('personal');
  const [showUserDropdown, setShowUserDropdown] = useState(false);
  const [theme, setTheme] = useState('light');
  const [messageCount, setMessageCount] = useState(500);
  const [paymentPeriod, setPaymentPeriod] = useState('monthly'); // 'monthly' –∏–ª–∏ 'quarterly'
  const [expandedMenus, setExpandedMenus] = useState([]);
  const [teamDropdownOpen, setTeamDropdownOpen] = useState(null);

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (teamDropdownOpen && !event.target.closest('.relative')) {
        setTeamDropdownOpen(null);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [teamDropdownOpen]);

  // üîê –ü–†–û–í–ï–†–ö–ê –°–ï–°–°–ò–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–ë–ï–ó localStorage!)
  useEffect(() => {
    const initializeAuth = async () => {
      try {
        console.log('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ Supabase...');
        const { checkSession } = await import('./utils/auth.js');
        const { user, isLoggedIn: loggedIn } = await checkSession();
        
        if (loggedIn && user) {
          console.log('‚úÖ –°–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user);
          setCurrentUser({
            ...user,
            role: user.role || 'user'
          });
          setIsLoggedIn(true);
          setCurrentStep('dashboard');
          setActiveSection('main');
        } else {
          console.log('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏');
          setCurrentUser(null);
          setIsLoggedIn(false);
          setCurrentStep('login');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
        setCurrentUser(null);
        setIsLoggedIn(false);
        setCurrentStep('login');
      } finally {
        setIsLoadingAuth(false);
      }
    };

    initializeAuth();
  }, []);

  // üîÑ –ü–û–î–ü–ò–°–ö–ê –ù–ê –ò–ó–ú–ï–ù–ï–ù–ò–Ø –°–ï–°–°–ò–ò
  useEffect(() => {
    const setupAuthListener = async () => {
      const { onAuthStateChange } = await import('./utils/auth.js');
      const subscription = onAuthStateChange(({ event, user }) => {
        console.log('üîÑ Auth state changed:', event, user ? 'User: ' + user.id : 'No user');
        
        if (event === 'SIGNED_IN' && user) {
          // –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ user –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–Ω—ã–µ (–µ—Å—Ç—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users)
          if (user.project_id) {
            console.log('‚úÖ SIGNED_IN with full user data');
            setCurrentUser({
              ...user,
              role: user.role || 'user'
            });
            setIsLoggedIn(true);
            if (!isLoggedIn) {
              setCurrentStep('dashboard');
            }
          } else {
            console.log('‚ö†Ô∏è SIGNED_IN but user data incomplete, waiting for full data...');
          }
        } else if (event === 'SIGNED_OUT') {
          console.log('‚ùå SIGNED_OUT');
          setCurrentUser(null);
          setIsLoggedIn(false);
          setCurrentStep('login');
        } else if (event === 'USER_UPDATED' && user) {
          console.log('üîÑ USER_UPDATED');
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–∏—à–ª–∏
          if (user.project_id && isLoggedIn) {
            setCurrentUser({
              ...user,
              role: user.role || 'user'
            });
          }
        }
      });

      return () => {
        subscription.unsubscribe();
      };
    };

    setupAuthListener();
  }, [isLoggedIn]);

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–æ—Ä–∏—Å –ø—Ä–∏ –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  useEffect(() => {
    if (isLoggedIn && currentUser) {
      loadStories();
    }
  }, [isLoggedIn, currentUser]);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const inviter = urlParams.get('inviter');
    
    if (token && inviter) {
      setInviteToken(token);
      setInviterId(inviter);
      setCurrentStep('register-operator');
    }
  }, []);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  useEffect(() => {
    if (isLoggedIn && currentUser) {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω, –Ω–æ –∏–º–µ–µ—Ç —Ä–æ–ª—å admin - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
      if (currentUser.role === 'admin' && currentUser.email !== 'admin@adapto.ai') {
        console.log('–ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å admin –Ω–∞ user:', currentUser.email);
        const correctedUser = { ...currentUser, role: 'user' };
        setCurrentUser(correctedUser);
        // –ë–ï–ó localStorage - —Ä–æ–ª—å –≤ –±–∞–∑–µ
        showNotificationMessage('–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ "user"');
      }
    }
  }, [isLoggedIn, currentUser]);

  // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–∞—Ä–∏—Ñ–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
  const calculatePrice = (tariffName, messages, period = 'monthly') => {
    const tariffs = {
      "–°—Ç–∞—Ä—Ç": 2490,
      "–ü—Ä–æ": 5490,
      "–ë–∏–∑–Ω–µ—Å": 14990
    };
    const costPerDialog = 3;     // —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–∏–∞–ª–æ–≥–∞
    const markup = 3;            // –Ω–∞—Ü–µ–Ω–∫–∞
    const messagesPerDialog = 5;
    
    const basePrice = tariffs[tariffName];      // —Ü–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞ —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç 500 —Å–æ–æ–±—â–µ–Ω–∏–π
    if (messages < 500) {
      messages = 500;                           // –º–∏–Ω–∏–º—É–º 500
    }
    const extraMessages = messages - 500;       // —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–≤–µ—Ä—Ö—É
    const dialogsExtra = extraMessages / messagesPerDialog;
    const extraCost = dialogsExtra * costPerDialog * markup;
    const monthlyPrice = basePrice + extraCost;
    
    // –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –Ω–∞ 3 –º–µ—Å—è—Ü–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É 15%
    if (period === 'quarterly') {
      return Math.round(monthlyPrice * 0.85);
    }
    
    return Math.round(monthlyPrice);
  };
  const [activeStatisticsTab, setActiveStatisticsTab] = useState('general');
  const [showMetricInfoModal, setShowMetricInfoModal] = useState(false);
  const [currentMetricInfo, setCurrentMetricInfo] = useState(null);
  const [showHelpModal, setShowHelpModal] = useState(false);
  const [hoveredMetricId, setHoveredMetricId] = useState(null);
  const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è Telegram –±–æ—Ç–∞
  const [showTelegramModal, setShowTelegramModal] = useState(false);
  const [telegramBotToken, setTelegramBotToken] = useState('');
  const [isConnectingTelegramBot, setIsConnectingTelegramBot] = useState(false);
  const [telegramBotConnected, setTelegramBotConnected] = useState(false);
  const [telegramBotStats, setTelegramBotStats] = useState(null);
  const [hoveredMenuId, setHoveredMenuId] = useState(null);
  const [hoveredSubId, setHoveredSubId] = useState(null);
  
  // CRM states
  const [crmActiveTab, setCrmActiveTab] = useState('deals');
  const [crmViewMode, setCrmViewMode] = useState('kanban');
  const [crmSortOrder, setCrmSortOrder] = useState('newest');
  const [crmSelectedDeal, setCrmSelectedDeal] = useState(null);
  const [crmSidebarOpen, setCrmSidebarOpen] = useState(false);
  const [editingField, setEditingField] = useState(null);
  const [editedClientData, setEditedClientData] = useState({});
  const [editingLeadQuality, setEditingLeadQuality] = useState(false);
  // Inline editing for dialog client info (safe, controlled inputs)
  const [dialogEditingField, setDialogEditingField] = useState<null | 'name' | 'phone' | 'email' | 'address' | 'company' | 'notes'>(null);
  const [dialogEditingValue, setDialogEditingValue] = useState<string>('');
  
  // Team invite email state
  const [teamInviteEmail, setTeamInviteEmail] = useState('');
  
  // Invite token state for operator registration
  const [inviteToken, setInviteToken] = useState(null);
  const [inviterId, setInviterId] = useState(null);

  const startDialogEdit = (field: 'name' | 'phone' | 'email' | 'address' | 'company' | 'notes', currentValue: string = '') => {
    setDialogEditingField(field);
    setDialogEditingValue(currentValue || '');
  };

  const saveDialogEdit = () => {
    if (!selectedDialog) {
      setDialogEditingField(null);
      setDialogEditingValue('');
      return;
    }
    const value = (dialogEditingValue || '').trim();
    if (!value) {
      setDialogEditingField(null);
      setDialogEditingValue('');
      return;
    }
    if (dialogEditingField === 'phone') {
      const phoneOk = /^\+?[0-9\s()\-]{7,}$/.test(value);
      if (!phoneOk) {
        setDialogEditingField(null);
        setDialogEditingValue('');
        return;
      }
    }
    switch (dialogEditingField) {
      case 'name':
        setSelectedDialog(prev => prev ? { ...prev, name: value } : prev);
        break;
      case 'phone':
        setSelectedDialog(prev => prev ? { ...prev, phone: value } : prev);
        break;
      case 'email':
        setSelectedDialog(prev => prev ? { ...prev, email: value } : prev);
        break;
      case 'address':
        setSelectedDialog(prev => prev ? { ...prev, address: value } : prev);
        break;
      case 'company':
        setSelectedDialog(prev => prev ? { ...prev, company: value } : prev);
        break;
      case 'notes':
        setSelectedDialog(prev => prev ? { ...prev, notes: value } : prev);
        break;
      default:
        break;
    }
    setDialogEditingField(null);
    setDialogEditingValue('');
  };

  const cancelDialogEdit = () => {
    setDialogEditingField(null);
    setDialogEditingValue('');
  };
  const [selectedClient, setSelectedClient] = useState(null);
  const [clientSidebarOpen, setClientSidebarOpen] = useState(false);
  const [createDealModalOpen, setCreateDealModalOpen] = useState(false);
  const [createTaskModalOpen, setCreateTaskModalOpen] = useState(false);
  const [showTaskModal, setShowTaskModal] = useState(false);
  const [newTaskTitle, setNewTaskTitle] = useState('');
  const [newDeal, setNewDeal] = useState({
    title: '',
    stage: '–ù–æ–≤—ã–µ',
    leadQuality: 'warm',
    amount: '',
    client: {
      name: '',
      email: '',
      phone: '',
      company: '',
      address: ''
    },
    notes: ''
  });
  const [newTask, setNewTask] = useState({
    title: '',
    description: '',
    assignee: 'operator-1',
    assigneeName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
    priority: 'medium',
    dueDate: '',
    dealId: '',
    notes: ''
  });
  const [editingStatus, setEditingStatus] = useState(null);
  const [editingAssignee, setEditingAssignee] = useState(null);
  const [draggedDeal, setDraggedDeal] = useState(null);
  const [dragOverColumn, setDragOverColumn] = useState(null);
  
  // –§–∏–ª—å—Ç—Ä—ã CRM
  const [crmLeadQualityFilter, setCrmLeadQualityFilter] = useState([]); // [], ['hot'], ['warm'], ['cold'], ['hot', 'warm'], etc.
  const [crmContactFilter, setCrmContactFilter] = useState('all'); // all, with_contacts, without_contacts
  const [crmOwnerFilter, setCrmOwnerFilter] = useState([]); // [], ['ai'], ['operator-1'], ['operator-2'], ['ai', 'operator-1'], etc.
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫
  const [editingNotes, setEditingNotes] = useState(false);
  const [editedNotes, setEditedNotes] = useState('');
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫ –∑–∞–¥–∞—á
  const [editingTaskNotes, setEditingTaskNotes] = useState(false);
  const [editingTaskDeadline, setEditingTaskDeadline] = useState(false);
  const [editedTaskDeadline, setEditedTaskDeadline] = useState('');
  const [editingTaskDescription, setEditingTaskDescription] = useState(false);
  const [editedTaskDescription, setEditedTaskDescription] = useState('');

  // –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ–π –∫–ª–∏–µ–Ω—Ç–∞
  const handleEditField = (field, currentValue) => {
    setEditingField(field);
    setEditedClientData(prev => ({ ...prev, [field]: currentValue }));
  };

  const handleSaveField = (field) => {
    if (crmSelectedDeal) {
      const updatedClient = {
        ...crmSelectedDeal.client,
        [field]: editedClientData[field]
      };
      
      setCrmSelectedDeal(prev => ({
        ...prev,
        client: updatedClient
      }));

      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–ø–∏—Å–∫–µ —Å–¥–µ–ª–æ–∫
      setDeals(prev => prev.map(deal => 
        deal.id === crmSelectedDeal.id 
          ? { ...deal, client: updatedClient }
          : deal
      ));

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å –¥–∏–∞–ª–æ–≥–æ–º, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑—å
      if (crmSelectedDeal.dialogId) {
        syncClientData(updatedClient, crmSelectedDeal.dialogId);
      }
    }
    setEditingField(null);
  };

  const handleCancelEdit = () => {
    setEditingField(null);
    setEditedClientData({});
  };

  // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –ª–∏–¥–∞
  const handleSaveLeadQuality = (newQuality) => {
    if (crmSelectedDeal) {
      setDeals(prev => prev.map(deal => 
        deal.id === crmSelectedDeal.id 
          ? { ...deal, leadQuality: newQuality }
          : deal
      ));
      setCrmSelectedDeal(prev => ({ ...prev, leadQuality: newQuality }));
    }
    setEditingLeadQuality(false);
  };

  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –ª–∏–¥–∞
  const handleCancelLeadQualityEdit = () => {
    setEditingLeadQuality(false);
  };

  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π –∫–ª–∏–µ–Ω—Ç–∞
  const openClientDetails = (client) => {
    setSelectedClient(client);
    setClientSidebarOpen(true);
  };

  // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏
  const handleDeleteDeal = (dealId) => {
    if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–¥–µ–ª–∫—É?')) {
      setDeals(prev => prev.filter(deal => deal.id !== dealId));
      if (crmSelectedDeal && crmSelectedDeal.id === dealId) {
        setCrmSidebarOpen(false);
        setCrmSelectedDeal(null);
      }
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
  const handleDeleteClient = (clientId) => {
    if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?')) {
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
      console.log('–£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:', clientId);
      setClientSidebarOpen(false);
      setSelectedClient(null);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
  const handleInviteMember = async (email) => {
    try {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
      const inviteToken = crypto.randomBytes(32).toString('hex');
      
      // –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –ë–î (–∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å API –≤—ã–∑–æ–≤)
      const inviteData = {
        email: email,
        projectId: currentUser?.id, // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ projectId
        invitedBy: currentUser?.id,
        role: 'operator',
        inviteToken: inviteToken,
        inviteExpiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 –¥–Ω–µ–π
      };

      // TODO: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π API –≤—ã–∑–æ–≤
      console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:', inviteData);
      
      // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      const inviteLink = `${window.location.origin}/register?token=${inviteToken}&inviter=${currentUser?.id}`;
      
      // TODO: –û—Ç–ø—Ä–∞–≤–∏—Ç—å email —Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º
      // await sendInviteEmail(email, inviteLink);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      setNotificationMessage(`–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ${email}`);
      setShowNotification(true);
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
      setTeamInviteEmail('');
      
      // –°–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        setShowNotification(false);
      }, 3000);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:', error);
      setNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è');
      setShowNotification(true);
      setTimeout(() => {
        setShowNotification(false);
      }, 3000);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ –∏–∑ –¥–∏–∞–ª–æ–≥–∞
  const createDealFromDialog = async (dialog) => {
    try {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –ª–∏–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–∏–∞–ª–æ–≥–∞
      let leadQuality = 'cold';
      if (dialog.status === 'taken' || dialog.status === 'resolved_by_operator') {
        leadQuality = 'hot';
      } else if (dialog.status === 'waiting') {
        leadQuality = 'warm';
      }

      const dealData = {
        title: `–õ–∏–¥ –∏–∑ –¥–∏–∞–ª–æ–≥–∞: ${dialog.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}`,
        description: `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ –∏–∑ –¥–∏–∞–ª–æ–≥–∞. –ò—Å—Ç–æ—á–Ω–∏–∫: ${dialog.source}. –°—Ç–∞—Ç—É—Å –¥–∏–∞–ª–æ–≥–∞: ${dialog.status}`,
        amount: 0,
        currency: 'RUB',
        stage: '–ù–æ–≤—ã–µ',
        probability: 0,
        source: 'chat_dialog',
        priority: 'medium',
        lead_quality: leadQuality,
        has_contacts: !!(dialog.email || dialog.phone),
        is_resolved: false,
        owner_type: dialog.assignedTo ? 'operator' : 'ai',
        owner_name: dialog.assignedTo ? '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' : '–ò–ò-–∞–≥–µ–Ω—Ç',
        client_id: null,
        dialog_id: dialog.id
      };

      if (currentUser) {
        try {
          const createdDeal = await crmAPI.createDeal(currentUser?.id, dealData);
          console.log('‚úÖ –°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ –ë–î:', createdDeal);
          
          // –ø–æ–º–µ—á–∞–µ–º –¥–∏–∞–ª–æ–≥ –∫–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –≤ CRM
          try { 
            await dialogsDB.updateDialog(dialog.id, { is_added_to_crm: true }); 
            console.log('‚úÖ –î–∏–∞–ª–æ–≥ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –≤ CRM');
          } catch (e) {
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–º–µ—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥ –∫–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –≤ CRM:', e);
          }
          
          const newDeal = {
            id: createdDeal.id,
            title: dealData.title,
            company: '',
            amount: dealData.amount,
            days: 0,
            stage: dealData.stage,
            leadQuality: dealData.lead_quality,
            hasContacts: dealData.has_contacts,
            owner: dealData.owner_type,
            ownerName: dealData.owner_name,
            isResolved: dealData.is_resolved,
            client: {
              name: dialog.name || '',
              email: dialog.email || '',
              phone: dialog.phone || '',
              company: ''
            },
            notes: dealData.description,
            createdDate: new Date().toISOString().split('T')[0],
            lastContact: new Date().toISOString().split('T')[0],
            dialogId: dialog.id
          };
          
          setDeals(prev => [newDeal, ...prev]);
              // –ü–æ–º–µ—á–∞–µ–º –¥–∏–∞–ª–æ–≥ –∫–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –≤ CRM
              setDialogsData(prev => prev.map(d => d.id === dialog.id ? { ...d, isAddedToCRM: true } : d));
              setSelectedDialog(prev => prev && prev.id === dialog.id ? { ...prev, isAddedToCRM: true } : prev);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          setNotificationMessage('–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏–∑ –¥–∏–∞–ª–æ–≥–∞');
          setShowNotification(true);
          setTimeout(() => setShowNotification(false), 3000);
          
          return createdDeal;
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ –≤ –ë–î:', error);
          
          // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Å–æ–∑–¥–∞–Ω–∏—é
          const localDeal = {
            id: `local-${Date.now()}`,
            title: dealData.title,
            company: '',
            amount: dealData.amount,
            days: 0,
            stage: dealData.stage,
            leadQuality: dealData.lead_quality,
            hasContacts: dealData.has_contacts,
            owner: dealData.owner_type,
            ownerName: dealData.owner_name,
            isResolved: dealData.is_resolved,
            client: {
              name: dialog.name || '',
              email: dialog.email || '',
              phone: dialog.phone || '',
              company: ''
            },
            notes: dealData.description,
            createdDate: new Date().toISOString().split('T')[0],
            lastContact: new Date().toISOString().split('T')[0],
            dialogId: dialog.id
          };
          
          console.log('‚ö†Ô∏è –°–æ–∑–¥–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞:', localDeal);
          
          setDeals(prev => [localDeal, ...prev]);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          setNotificationMessage('–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ (–æ—à–∏–±–∫–∞ –ë–î)');
          setShowNotification(true);
          setTimeout(() => setShowNotification(false), 3000);
          
          return localDeal;
        }
      }
    } catch (error) {
      console.error('Error creating deal from dialog:', error);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ –º–µ–∂–¥—É CRM –∏ –¥–∏–∞–ª–æ–≥–∞–º–∏
  const syncClientData = (clientData, dialogId) => {
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞
    setDialogsData(prev => prev.map(dialog => 
      dialog.id === dialogId 
        ? { 
            ...dialog, 
            name: clientData.name,
            email: clientData.email,
            phone: clientData.phone
          }
        : dialog
    ));

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
    setDeals(prev => prev.map(deal => 
      deal.dialogId === dialogId
        ? {
            ...deal,
            client: {
              ...deal.client,
              name: clientData.name,
              email: clientData.email,
              phone: clientData.phone
            }
          }
        : deal
    ));
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
  const updateDialogStatistics = async (dialogId, action, additionalData = {}) => {
    try {
      if (!currentUser?.id) return;

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      const dialog = dialogsData.find(d => d.id === dialogId);
      if (!dialog) return;

      let statsUpdate = {};
      
      switch (action) {
        case 'created':
          statsUpdate = {
            dialogsTotal: statisticsAggregates.dialogsTotal + 1,
            messagesTotal: statisticsAggregates.messagesTotal + (dialog.messages?.length || 0)
          };
          break;
          
        case 'taken':
          statsUpdate = {
            handoverTotal: statisticsAggregates.handoverTotal + 1
          };
          break;
          
        case 'resolved':
          statsUpdate = {
            resolvedTotal: statisticsAggregates.resolvedTotal + 1
          };
          break;
          
        case 'converted':
          statsUpdate = {
            convertedTotal: statisticsAggregates.convertedTotal + 1
          };
          break;
          
        case 'message_added':
          statsUpdate = {
            messagesTotal: statisticsAggregates.messagesTotal + 1,
            avgMessagesPerDialog: Math.round(
              (statisticsAggregates.messagesTotal + 1) / Math.max(statisticsAggregates.dialogsTotal, 1)
            )
          };
          break;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setStatisticsAggregates(prev => ({
        ...prev,
        ...statsUpdate
      }));

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î (–µ—Å–ª–∏ –µ—Å—Ç—å API –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
      try {
        await statsAPI.updateDialogMetrics(currentUser.id, {
          dialogId,
          action,
          timestamp: new Date().toISOString(),
          ...additionalData
        });
      } catch (e) {
        console.warn('Failed to update dialog metrics in DB:', e);
      }

    } catch (error) {
      console.error('Error updating dialog statistics:', error);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
  const handleDeleteDialog = (dialogId) => {
    if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–∏–∞–ª–æ–≥? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
      setDialogsData(prev => prev.filter(dialog => dialog.id !== dialogId));
      
      // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º—ã–π –¥–∏–∞–ª–æ–≥ —Å–µ–π—á–∞—Å –≤—ã–±—Ä–∞–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      if (selectedDialog && selectedDialog.id === dialogId) {
        setSelectedDialog(null);
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏
      setNotificationMessage('–î–∏–∞–ª–æ–≥ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ CRM –¥–∞–Ω–Ω—ã—Ö
  const reloadCRMData = async () => {
    if (!currentUser?.id) return;
    
    try {
      console.log('Reloading CRM data for user:', currentUser.id);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
      const clients = await crmAPI.getClients(currentUser.id);
      console.log('Reloaded clients:', clients);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–¥–µ–ª–∫–∏
      const deals = await crmAPI.getDeals(currentUser.id);
      console.log('Reloaded deals:', deals);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏
      const tasks = await crmAPI.getTasks(currentUser.id);
      console.log('Reloaded tasks:', tasks);
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç, –æ–∂–∏–¥–∞–µ–º—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
      const formattedDeals = deals.map(deal => ({
        id: deal.id,
        title: deal.title,
        company: deal.crm_clients?.company || '',
        amount: deal.amount || 0,
        days: 0, // –õ–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
        stage: deal.stage || '–ù–æ–≤—ã–µ',
        leadQuality: deal.lead_quality || 'medium',
        hasContacts: !!(deal.crm_clients?.email || deal.crm_clients?.phone),
        owner: deal.owner || 'ai',
        ownerName: deal.owner_name || '–ò–ò-–∞–≥–µ–Ω—Ç',
        isResolved: deal.is_resolved || false,
        client: {
          name: deal.crm_clients?.name || '',
          email: deal.crm_clients?.email || '',
          phone: deal.crm_clients?.phone || '',
          company: deal.crm_clients?.company || ''
        },
        notes: deal.description || '',
        createdDate: deal.created_at ? deal.created_at.split('T')[0] : new Date().toISOString().split('T')[0],
        lastContact: deal.created_at ? deal.created_at.split('T')[0] : new Date().toISOString().split('T')[0],
        dialogId: deal.dialog_id
      }));
      
      const formattedTasks = tasks.map(task => ({
        id: task.id,
        title: task.title,
        description: task.description || '',
        assignee: task.assignee || 'operator-1',
        assigneeName: task.assignee_name || '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
        priority: task.priority || 'medium',
        status: task.status || 'pending',
        dueDate: task.due_date || '',
        dealId: task.deal_id || '',
        notes: task.result || '',
        createdBy: task.created_by || '–ò–ò-–∞–≥–µ–Ω—Ç',
        createdDate: task.created_at ? task.created_at.split('T')[0] : new Date().toLocaleDateString('ru-RU')
      }));
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setDeals(formattedDeals);
      setTasks(formattedTasks);
      setClients(clients);
      
      console.log('CRM data reloaded successfully');
    } catch (error) {
      console.error('Error reloading CRM data:', error);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏
  const handleCreateDeal = async () => {
    try {
      const dealData = {
        title: newDeal.title || `–°–¥–µ–ª–∫–∞ #${Date.now().toString().slice(-4)}`,
        stage: newDeal.stage,
        lead_quality: newDeal.leadQuality,
        amount: parseFloat(newDeal.amount) || 0,
        days: 0,
        owner: isOperator ? 'operator-1' : 'ai',
        owner_name: isOperator ? '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' : '–ò–ò-–∞–≥–µ–Ω—Ç',
        is_resolved: false,
        description: newDeal.notes,
        client_id: null,
        dialog_id: null
      };
      
      if (currentUser) {
        const createdDeal = await crmAPI.createDeal(currentUser?.id, dealData);
        console.log('Deal created in Supabase:', createdDeal);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const newDealObj = {
          id: createdDeal.id,
          title: dealData.title,
          company: newDeal.client.company || '',
          amount: dealData.amount,
          days: dealData.days,
          stage: dealData.stage,
          leadQuality: dealData.lead_quality,
          hasContacts: !!(newDeal.client.email || newDeal.client.phone),
          owner: dealData.owner,
          ownerName: dealData.owner_name,
          isResolved: dealData.is_resolved,
          client: newDeal.client,
          notes: dealData.description,
          createdDate: new Date().toISOString().split('T')[0],
          lastContact: new Date().toISOString().split('T')[0],
          dialogId: dealData.dialog_id || ''
        };
        setDeals(prev => [newDealObj, ...prev]);
      }
      
      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
      setNewDeal({
        title: '',
        stage: '–ù–æ–≤—ã–µ',
        leadQuality: 'medium',
        amount: '',
        client: { name: '', email: '', phone: '', company: '' },
        notes: '',
        dialogId: null
      });
      setCreateDealModalOpen(false);
      
    } catch (error) {
      console.error('Error creating deal:', error);
      // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Å–æ–∑–¥–∞–Ω–∏—é
      const deal = {
        id: `deal-${Date.now()}`,
        title: newDeal.title || `–°–¥–µ–ª–∫–∞ #${Date.now().toString().slice(-4)}`,
        stage: newDeal.stage,
        leadQuality: newDeal.leadQuality,
        amount: parseFloat(newDeal.amount) || 0,
        days: 0,
        owner: isOperator ? 'operator-1' : 'ai',
        ownerName: isOperator ? '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' : '–ò–ò-–∞–≥–µ–Ω—Ç',
        isResolved: false,
        client: newDeal.client,
        notes: newDeal.notes,
        createdDate: new Date().toISOString().split('T')[0],
        lastContact: new Date().toISOString().split('T')[0],
        dialogId: null
      };
      setDeals(prev => [deal, ...prev]);
      setNewDeal({
        title: '',
        stage: '–ù–æ–≤—ã–µ',
        leadQuality: 'medium',
        amount: '',
        client: { name: '', email: '', phone: '', company: '' },
        notes: '',
        dialogId: null
      });
      setCreateDealModalOpen(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
  const handleCreateTask = async () => {
    try {
      const taskData = {
        title: newTask.title || `–ó–∞–¥–∞—á–∞ #${Date.now().toString().slice(-4)}`,
        description: newTask.description,
        assignee: newTask.assignee,
        assignee_name: newTask.assigneeName,
        priority: newTask.priority,
        status: '–ù–æ–≤—ã–µ',
        due_date: newTask.dueDate,
        deal_id: newTask.dealId,
        result: newTask.notes,
        created_by: isOperator ? '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' : '–ò–ò-–∞–≥–µ–Ω—Ç'
      };
      
      if (currentUser) {
        const createdTask = await crmAPI.createTask(currentUser?.id, taskData);
        console.log('Task created in Supabase:', createdTask);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const newTaskObj = {
          ...taskData,
          id: createdTask.id,
          assigneeName: taskData.assignee_name,
          dueDate: taskData.due_date,
          dealId: taskData.deal_id,
          notes: taskData.result,
          createdBy: taskData.created_by,
          createdDate: new Date().toLocaleDateString('ru-RU')
        };
        setTasks(prev => [newTaskObj, ...prev]);
      }
      
      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
      setNewTask({
        title: '',
        description: '',
        assignee: 'operator-1',
        assigneeName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
        priority: 'medium',
        dueDate: '',
        dealId: '',
        notes: ''
      });
      setCreateTaskModalOpen(false);
      
    } catch (error) {
      console.error('Error creating task:', error);
      // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Å–æ–∑–¥–∞–Ω–∏—é
      const task = {
        id: `task-${Date.now()}`,
        title: newTask.title || `–ó–∞–¥–∞—á–∞ #${Date.now().toString().slice(-4)}`,
        description: newTask.description,
        assignee: newTask.assignee,
        assigneeName: newTask.assigneeName,
        priority: newTask.priority,
        status: '–ù–æ–≤—ã–µ',
        dueDate: newTask.dueDate,
        dealId: newTask.dealId,
        notes: newTask.notes,
        createdBy: isOperator ? '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' : '–ò–ò-–∞–≥–µ–Ω—Ç',
        createdDate: new Date().toLocaleDateString('ru-RU')
      };
      setTasks(prev => [task, ...prev]);
      setNewTask({
        title: '',
        description: '',
        assignee: 'operator-1',
        assigneeName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
        priority: 'medium',
        dueDate: '',
        dealId: '',
        notes: ''
      });
      setCreateTaskModalOpen(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö
  const handleStatusChange = (dealId, newStatus) => {
    setDeals(prev => prev.map(deal => 
      deal.id === dealId ? { ...deal, stage: newStatus } : deal
    ));
    setEditingStatus(null);
  };

  const handleAssigneeChange = (dealId, newAssignee) => {
    setDeals(prev => prev.map(deal => 
      deal.id === dealId ? { ...deal, ownerName: newAssignee } : deal
    ));
    setEditingAssignee(null);
  };

  const [editedTaskNotes, setEditedTaskNotes] = useState('');
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∑–∞–¥–∞—á
  const [tasks, setTasks] = useState([
    {
      id: 'task-1',
      title: '–ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É –ò–≤–∞–Ω—É –ü–µ—Ç—Ä–æ–≤—É',
      description: '–û–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Å–∞–π—Ç–∞',
      assignee: 'operator-1',
      assigneeName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
      priority: 'high',
      status: 'pending',
      dueDate: '2024-01-22T10:00:00Z',
      dealId: 'deal-1',
      notes: '–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏',
      createdBy: 'admin',
      createdDate: '2024-01-21T15:30:00Z'
    },
    {
      id: 'task-2',
      title: '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
      description: '–î–ª—è –û–û–û "–¢–µ—Ö–Ω–æ–°—Ñ–µ—Ä–∞" –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞',
      assignee: 'operator-1',
      assigneeName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
      priority: 'medium',
      status: 'in_progress',
      dueDate: '2024-01-23T14:00:00Z',
      dealId: 'deal-1',
      notes: '–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å CRM –∏ –º–æ–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é',
      createdBy: 'ai',
      createdDate: '2024-01-21T16:00:00Z'
    }
  ]);
  
  const [editingTask, setEditingTask] = useState(null);
  const [selectedTask, setSelectedTask] = useState(null);
  const [taskSidebarOpen, setTaskSidebarOpen] = useState(false);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è drag & drop –∑–∞–¥–∞—á
  const [draggedTask, setDraggedTask] = useState(null);
  const [dragOverTaskColumn, setDragOverTaskColumn] = useState(null);
  const [isDragging, setIsDragging] = useState(false);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –¥—Ä–æ–ø–¥–∞—É–Ω–æ–≤ CRM
  const [crmDropdowns, setCrmDropdowns] = useState({
    leadQuality: false,
    contact: false,
    owner: false,
    sortOrder: false,
    dealStage: false,
    leadQualityDeal: false
  });
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
  const [executorDropdowns, setExecutorDropdowns] = useState({
    deal: false,
    task: false
  });
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –¥—Ä–æ–ø–¥–∞—É–Ω–æ–≤
  const toggleCrmDropdown = (dropdownName) => {
    setCrmDropdowns(prev => {
      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä, –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
      if (!prev[dropdownName]) {
        return {
          leadQuality: false,
          contact: false,
          owner: false,
          sortOrder: false,
          dealStage: false,
          leadQualityDeal: false,
          [dropdownName]: true
        };
      }
      // –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä
      return {
      ...prev,
        [dropdownName]: false
      };
    });
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
  const toggleExecutorDropdown = (dropdownName) => {
    setExecutorDropdowns(prev => ({
      ...prev,
      [dropdownName]: !prev[dropdownName]
    }));
  };
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö –æ–±–ª–∞—Å—Ç–∏
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (!event.target.closest('.crm-dropdown')) {
        setCrmDropdowns({
          leadQuality: false,
          contact: false,
          owner: false,
          sortOrder: false,
          dealStage: false,
          leadQualityDeal: false
        });
      }
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ª–∏–¥–∞
      if (!event.target.closest('.lead-quality-dropdown')) {
        setEditingLeadQuality(false);
      }
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
      if (!event.target.closest('.executor-dropdown')) {
        setExecutorDropdowns({
          deal: false,
          task: false
        });
      }
    };
    
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞–¥–∏–∏ —Å–¥–µ–ª–∫–∏
  const updateDealStage = (dealId, newStage) => {
    setDeals(prevDeals => 
      prevDeals.map(deal => 
        deal.id === dealId 
          ? { ...deal, stage: newStage }
          : deal
      )
    );
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫
  const saveNotes = () => {
    if (crmSelectedDeal) {
      setDeals(prevDeals => 
        prevDeals.map(deal => 
          deal.id === crmSelectedDeal.id 
            ? { ...deal, notes: editedNotes }
            : deal
        )
      );
      setCrmSelectedDeal(prev => prev ? { ...prev, notes: editedNotes } : null);
      setEditingNotes(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫
  const startEditingNotes = () => {
    setEditedNotes(crmSelectedDeal?.notes || '');
    setEditingNotes(true);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const cancelEditingNotes = () => {
    setEditingNotes(false);
    setEditedNotes('');
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–¥–∞—á–∞–º–∏
  const createTask = (taskData) => {
    const newTask = {
      id: `task-${Date.now()}`,
      ...taskData,
      status: 'pending',
      createdDate: new Date().toISOString(),
      createdBy: 'admin' // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –±–µ—Ä–µ—Ç—Å—è –∏–∑ auth
    };
    setTasks(prevTasks => [...prevTasks, newTask]);
    setShowTaskModal(false);
    setNewTaskTitle('');
  };

  const updateTask = (taskId, updates) => {
    setTasks(prevTasks => 
      prevTasks.map(task => 
        task.id === taskId ? { ...task, ...updates } : task
      )
    );
  };

  const deleteTask = (taskId) => {
    setTasks(prevTasks => prevTasks.filter(task => task.id !== taskId));
    setTaskSidebarOpen(false);
    setSelectedTask(null);
  };

  const openTaskDetails = (task) => {
    setSelectedTask(task);
    setTaskSidebarOpen(true);
    setEditedTaskNotes(task.notes || '');
    setEditingTaskNotes(false);
  };
  
  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫ –∑–∞–¥–∞—á
  const startEditingTaskNotes = () => {
    setEditingTaskNotes(true);
    setEditedTaskNotes(selectedTask.notes || '');
  };
  
  const cancelEditingTaskNotes = () => {
    setEditingTaskNotes(false);
    setEditedTaskNotes(selectedTask.notes || '');
  };
  
  const saveTaskNotes = () => {
    if (selectedTask) {
      updateTask(selectedTask.id, { notes: editedTaskNotes });
      setSelectedTask({ ...selectedTask, notes: editedTaskNotes });
      setEditingTaskNotes(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–¥–ª–∞–π–Ω–∞ –∑–∞–¥–∞—á
  const startEditingTaskDeadline = () => {
    setEditingTaskDeadline(true);
    setEditedTaskDeadline(selectedTask.dueDate || '');
  };
  
  const cancelEditingTaskDeadline = () => {
    setEditingTaskDeadline(false);
    setEditedTaskDeadline(selectedTask.dueDate || '');
  };
  
  const saveTaskDeadline = () => {
    if (selectedTask) {
      updateTask(selectedTask.id, { dueDate: editedTaskDeadline });
      setSelectedTask({ ...selectedTask, dueDate: editedTaskDeadline });
      setEditingTaskDeadline(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è –∑–∞–¥–∞—á
  const startEditingTaskDescription = () => {
    setEditingTaskDescription(true);
    setEditedTaskDescription(selectedTask.description || '');
  };
  
  const cancelEditingTaskDescription = () => {
    setEditingTaskDescription(false);
    setEditedTaskDescription(selectedTask.description || '');
  };
  
  const saveTaskDescription = () => {
    if (selectedTask) {
      updateTask(selectedTask.id, { description: editedTaskDescription });
      setSelectedTask({ ...selectedTask, description: editedTaskDescription });
      setEditingTaskDescription(false);
    }
  };

  const getTasksByStatus = (status) => {
    return tasks.filter(task => task.status === status);
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è drag & drop –∑–∞–¥–∞—á
  const handleTaskDragStart = (e, task) => {
    console.log('Drag start:', task);
    setDraggedTask(task);
    setIsDragging(true);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', task.id);
  };

  const handleTaskDragOver = (e, status) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    setDragOverTaskColumn(status);
    console.log('Drag over column:', status);
  };

  const handleTaskDragLeave = () => {
    setDragOverTaskColumn(null);
  };

  const handleTaskDrop = (e, newStatus) => {
    e.preventDefault();
    console.log('Drop event triggered:', { draggedTask, newStatus });
    
    if (draggedTask && draggedTask.status !== newStatus) {
      console.log(`–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ "${draggedTask.title}" –∏–∑ ${draggedTask.status} –≤ ${newStatus}`);
      updateTask(draggedTask.id, { status: newStatus });
    }
    
    setDraggedTask(null);
    setDragOverTaskColumn(null);
    setIsDragging(false);
  };

  const handleTaskDragEnd = () => {
    setDraggedTask(null);
    setDragOverTaskColumn(null);
    setIsDragging(false);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –ª–∏–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  const analyzeLeadQuality = (message, clientInfo) => {
    const text = message.toLowerCase();
    const hasEmail = clientInfo.email && clientInfo.email.trim() !== '';
    const hasPhone = clientInfo.phone && clientInfo.phone.trim() !== '';
    const hasName = clientInfo.name && clientInfo.name.trim() !== '' && clientInfo.name !== '–ê–Ω–æ–Ω–∏–º';
    
    // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
    const hotKeywords = [
      '–∑–∞–∫–∞–∑–∞—Ç—å', '–∫—É–ø–∏—Ç—å', '–Ω—É–∂–µ–Ω', '—Ç—Ä–µ–±—É–µ—Ç—Å—è', '—Ö–æ—á—É', '–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ',
      '—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞', '—Å–æ–∑–¥–∞–Ω–∏–µ', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '—Ü–µ–Ω–∞', '–±—é–¥–∂–µ—Ç', '—Å—Ä–æ–∫–∏',
      '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', '–¥–æ–≥–æ–≤–æ—Ä', '–æ–ø–ª–∞—Ç–∞', '–∑–∞–∫–ª—é—á–∏—Ç—å'
    ];
    
    const warmKeywords = [
      '–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ', '—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ', '–ø–æ–¥—Ä–æ–±–Ω–µ–µ', '–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏',
      '—É—Å–ª—É–≥–∏', '—á—Ç–æ –º–æ–∂–µ—Ç–µ', '–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç', '–ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç'
    ];
    
    const coldKeywords = [
      '–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ', '–≤–æ–ø—Ä–æ—Å', '—Å–ø–∞—Å–∏–±–æ', '–ø–æ–Ω—è–ª', '—è—Å–Ω–æ'
    ];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    const hasHotKeywords = hotKeywords.some(keyword => text.includes(keyword));
    const hasWarmKeywords = warmKeywords.some(keyword => text.includes(keyword));
    const hasColdKeywords = coldKeywords.some(keyword => text.includes(keyword));
    
    // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
    if (hasHotKeywords && (hasEmail && hasPhone)) {
      return 'hot'; // –ì–æ—Ä—è—á–∏–π - –µ—Å—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ + –ø–æ–ª–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
    } else if (hasHotKeywords && (hasEmail || hasPhone)) {
      return 'warm'; // –¢–µ–ø–ª—ã–π - –µ—Å—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ + —á–∞—Å—Ç–∏—á–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
    } else if (hasWarmKeywords && (hasEmail || hasPhone)) {
      return 'warm'; // –¢–µ–ø–ª—ã–π - –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å + –∫–æ–Ω—Ç–∞–∫—Ç—ã
    } else if (hasHotKeywords || hasWarmKeywords) {
      return 'warm'; // –¢–µ–ø–ª—ã–π - –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å, –Ω–æ –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    } else {
      return 'cold'; // –•–æ–ª–æ–¥–Ω—ã–π - —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–¥–µ–ª–æ–∫
  const getFilteredDeals = () => {
    return deals.filter(deal => {
      // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –ª–∏–¥–∞
      if (crmLeadQualityFilter.length > 0 && !crmLeadQualityFilter.includes(deal.leadQuality)) {
        return false;
      }
      
      // –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–ª–∏—á–∏—é –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
      if (crmContactFilter === 'with_contacts' && !deal.hasContacts) {
        return false;
      }
      if (crmContactFilter === 'without_contacts' && deal.hasContacts) {
        return false;
      }
      
      // –§–∏–ª—å—Ç—Ä –ø–æ –≤–ª–∞–¥–µ–ª—å—Ü—É
      if (crmOwnerFilter.length > 0 && !crmOwnerFilter.includes(deal.owner)) {
        return false;
      }
      
      return true;
    });
  };

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–¥–µ–ª–æ–∫ CRM (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î)
  const [deals, setDeals] = useState([]);
  const [clients, setClients] = useState([]);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–ø–∞–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞
  const [crmClientSidebarOpen, setCrmClientSidebarOpen] = useState(false);
  const [selectedCrmClient, setSelectedCrmClient] = useState(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  const [telegramApiKey, setTelegramApiKey] = useState('');
  const [isConnectingTelegram, setIsConnectingTelegram] = useState(false);
  const [telegramConnected, setTelegramConnected] = useState(false);
  const [telegramSettings, setTelegramSettings] = useState(null);
  const [activeNotificationTab, setActiveNotificationTab] = useState('new_messages');

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  const [personalInfo, setPersonalInfo] = useState({
    name: currentUser?.name || '',
    email: currentUser?.email || '',
    company: currentUser?.company_name || '',
    phone: currentUser?.phone || '',
    newPassword: '',
    confirmPassword: ''
  });
  const [originalPersonalInfo, setOriginalPersonalInfo] = useState({
    name: currentUser?.name || '',
    email: currentUser?.email || '',
    company: currentUser?.company_name || '',
    phone: currentUser?.phone || ''
  });
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const [userLimits, setUserLimits] = useState({
    daysRemaining: 7,
    tokensRemaining: 1000,
    tokensUsed: 0,
    totalTokens: 1000,
    tierType: 'free',
    isExpired: false
  });

  // Refs –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —á–∞—Ç–∞
  const chatHistoryRef = useRef(null);
  const widgetChatRef = useRef(null);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ –Ω–∏–∑—É —á–∞—Ç–∞
  const scrollToBottom = (ref) => {
    if (ref.current) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      requestAnimationFrame(() => {
        ref.current.scrollTop = ref.current.scrollHeight;
      });
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ timestamp
  let lastTimestamp = 0;
  const getUniqueTimestamp = () => {
    const now = Date.now();
    if (now <= lastTimestamp) {
      lastTimestamp += 1;
    } else {
      lastTimestamp = now;
    }
    return lastTimestamp;
  };

  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∏–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —á–∞—Ç —Ä–∞–∑–¥–µ–ª–∞—Ö
  useEffect(() => {
    if (activeSection === 'my-adapto' && chatHistoryRef.current) {
      ChatUtils.scrollToBottom(chatHistoryRef, 500);
    } else if (activeSection === 'widget-dev' && widgetChatRef.current) {
      ChatUtils.scrollToBottom(widgetChatRef, 500);
    }
  }, [activeSection]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  useEffect(() => {
    if ((profileTab === 'notifications' || activeSection === 'notifications') && isLoggedIn && currentUser) {
      loadTelegramSettings();
    }
  }, [profileTab, activeSection, isLoggedIn, currentUser]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å Telegram –±–æ—Ç–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–æ–≤
  useEffect(() => {
    if (activeSection === 'messengers' && isLoggedIn && currentUser) {
      loadTelegramBotStatus();
    }
  }, [activeSection, isLoggedIn, currentUser]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
  useEffect(() => {
    if (activeSection === 'model-extensions' && isLoggedIn) {
      loadAutoswitchSettings();
    }
  }, [activeSection, isLoggedIn]);

  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
  const [userAccess, setUserAccess] = useState({
    hasAccess: true,
    isExpired: false,
    reason: null
  });
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [showUnsavedChangesModal, setShowUnsavedChangesModal] = useState(false);
  const [pendingNavigation, setPendingNavigation] = useState(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
  const [integrations, setIntegrations] = useState([
    { id: 'widget', name: '–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç', description: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∏–¥–∂–µ—Ç –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–∞–π—Ç', icon: 'group-36.svg', installed: false },
    { id: 'whatsapp', name: 'WhatsApp', description: '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –ò–ò-–±–æ—Ç–∞ –∫ WhatsApp Business', icon: 'group-37.svg', installed: false },
    { id: 'telegram', name: 'Telegram', description: '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –ò–ò-–±–æ—Ç–∞ –∫ Telegram', icon: 'group-38.svg', installed: false },
    { id: 'vk', name: '–í–∫–æ–Ω—Ç–∞–∫—Ç–µ', description: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤ —Å–≤–æ–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –ò–ò-–∞–≥–µ–Ω—Ç–∞', icon: 'group-39.svg', installed: false },
    { id: 'bitrix', name: '–ë–∏—Ç—Ä–∏–∫—Å24', description: '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ CRM –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ª–∏–¥–æ–≤', icon: 'group-41.svg', installed: false },
    { id: 'amo', name: 'amoCRM', description: '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ CRM –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ª–∏–¥–æ–≤', icon: 'group-42.svg', installed: false },
    { id: 'instagram', name: 'Instagram*', description: '–í–Ω–µ–¥—Ä–∏—Ç–µ –ò–ò-–±–æ—Ç–∞ –ø—Ä—è–º–∏–∫–æ–º –≤ –î–∏—Ä–µ–∫—Ç', icon: 'group-43.svg', installed: false },
    { id: 'yclients', name: 'Yclients', description: '–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ Adapto –≤ Yclients', icon: 'group-40.svg', installed: false }
  ]);

  const [showUninstallModal, setShowUninstallModal] = useState(false);
  const [integrationToUninstall, setIntegrationToUninstall] = useState(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–ø–∞–ø–∞ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞
  const [isFirstTimeUser, setIsFirstTimeUser] = useState(false);
  const [showModelSetupProgress, setShowModelSetupProgress] = useState(false);
  const [modelSetupTimer, setModelSetupTimer] = useState(300); // 5 –º–∏–Ω—É—Ç = 300 —Å–µ–∫—É–Ω–¥


  // Form data
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    name: '',
    company: '',
    phone: '',
    companyField: ''
  });

  const [formErrors, setFormErrors] = useState({});
  const [validationErrors, setValidationErrors] = useState({});

  // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  const formatPhoneNumber = (value) => {
    const phoneNumbers = value.replace(/\D/g, '');
    if (phoneNumbers.length === 0) return '';
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –Ω–æ–º–µ—Ä, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å 7, —É–±–∏—Ä–∞–µ–º –µ–≥–æ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    let cleanNumbers = phoneNumbers;
    if (phoneNumbers.startsWith('7') && phoneNumbers.length > 1) {
      cleanNumbers = phoneNumbers.slice(1);
    }
    
    if (cleanNumbers.length <= 3) return `+7 (${cleanNumbers}`;
    if (cleanNumbers.length <= 6) return `+7 (${cleanNumbers.slice(0, 3)}) ${cleanNumbers.slice(3)}`;
    if (cleanNumbers.length <= 8) return `+7 (${cleanNumbers.slice(0, 3)}) ${cleanNumbers.slice(3, 6)}-${cleanNumbers.slice(6)}`;
    return `+7 (${cleanNumbers.slice(0, 3)}) ${cleanNumbers.slice(3, 6)}-${cleanNumbers.slice(6, 8)}-${cleanNumbers.slice(8, 10)}`;
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
  const handleSwitchRole = (role) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Ä–æ–ª–∏
    if (currentUser?.role !== 'super_admin' && currentUser?.role !== 'admin') {
      showNotificationMessage('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–æ–ª–µ–π');
      return;
    }

    if (role === 'operator') {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (!originalUser) {
        setOriginalUser(currentUser);
      }
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      setCurrentUser({
        ...currentUser,
        role: 'operator'
      });
    } else if (role === 'admin') {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∞–¥–º–∏–Ω—É
      if (originalUser) {
        setCurrentUser(originalUser);
        setOriginalUser(null);
      } else {
        setCurrentUser({
          ...currentUser,
          role: 'admin'
        });
      }
    } else if (role === 'user') {
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      setCurrentUser({
        ...currentUser,
        role: 'user'
      });
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –¥–∏–∞–ª–æ–≥ (–ø–µ—Ä–µ—Ö–≤–∞—Ç)
  const handleJoinDialog = async (dialogId) => {
    // –ù–∞—Ö–æ–¥–∏–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    const dialog = dialogsData.find(d => d.id === dialogId);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –ª–∏ –¥–∏–∞–ª–æ–≥ –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
    if (dialog && dialog.assignedTo && dialog.assignedTo !== currentUser?.id) {
      setNotificationMessage('–î–∏–∞–ª–æ–≥ —É–∂–µ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
      return;
    }
    
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
    setDialogsData(prev => prev.map(dialog => 
      dialog.id === dialogId 
        ? { 
            ...dialog, 
            status: 'taken', 
            assignedTo: currentUser?.id || 'current_operator',
            canTakeover: false,
            need_handover: false,
            lastMessage: '–î–∏–∞–ª–æ–≥ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º',
            interceptedBy: currentUser?.id || 'current_operator',
            interceptedAt: new Date().toISOString()
          }
        : dialog
    ));
    
    setSelectedDialog(prev => 
      prev && prev.id === dialogId 
        ? { 
            ...prev, 
            status: 'taken', 
            assignedTo: currentUser?.id || 'current_operator',
            canTakeover: false,
            need_handover: false,
            interceptedBy: currentUser?.id || 'current_operator',
            interceptedAt: new Date().toISOString()
          }
        : prev
    );
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ
    setNotificationMessage('–î–∏–∞–ª–æ–≥ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω');
    setShowNotification(true);
    setTimeout(() => setShowNotification(false), 3000);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
    setShowJoinDialogPlaque(false);
    
    // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM - —Å–æ–∑–¥–∞–µ–º —Å–¥–µ–ª–∫—É –ø—Ä–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ –¥–∏–∞–ª–æ–≥–∞
    if (dialog && (dialog.email || dialog.phone)) {
      try {
        await createDealFromDialog(dialog);
        console.log('‚úÖ –õ–∏–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –≤ CRM –ø—Ä–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ –¥–∏–∞–ª–æ–≥–∞:', dialogId);
      } catch (error) {
        console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –ª–∏–¥ –≤ CRM –ø—Ä–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ:', error);
      }
    }
    
    showNotificationMessage('–î–∏–∞–ª–æ–≥ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—á–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É.');
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –ë–î
    try {
      dialogsDB.updateDialog(dialogId, {
        status: 'taken',
        assigned_to: currentUser?.id || null,
        need_handover: false,
        last_message_at: new Date().toISOString()
      });
    } catch (e) {
      console.warn('Failed to sync join to DB:', e);
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ –¥–∏–∞–ª–æ–≥–∞
    if (dialog) {
      const message = `ü§ñ –î–∏–∞–ª–æ–≥ ID: ${dialogId}\nüë§ –ö–ª–∏–µ–Ω—Ç: ${dialog.user || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\nüìû ${dialog.phone || dialog.email || '–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤'}\n‚ö° –°—Ç–∞—Ç—É—Å: –ü–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º`;
      sendTelegramNotification(message, 'operator_takeover');
    }
  };

  const handleTakeoverDialog = async (dialogId) => {
    // –ù–∞—Ö–æ–¥–∏–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    const dialog = dialogsData.find(d => d.id === dialogId);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –ª–∏ –¥–∏–∞–ª–æ–≥ –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
    if (dialog && dialog.assignedTo && dialog.assignedTo !== currentUser?.id) {
      setNotificationMessage('–î–∏–∞–ª–æ–≥ —É–∂–µ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
      return;
    }
    
    // –°–æ–∑–¥–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ
    const takeoverMessage = {
      id: `takeover_${dialogId}_${Date.now()}`,
      type: 'system',
      sender_role: 'system',
      text: `–î–∏–∞–ª–æ–≥ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º ${currentUser?.email || '–û–ø–µ—Ä–∞—Ç–æ—Ä'}`,
      time: '—Ç–æ–ª—å–∫–æ —á—Ç–æ',
      timestamp: Date.now(),
      isSystemMessage: true
    };
    
    setDialogsData(prev => prev.map(dialog => 
      dialog.id === dialogId 
        ? { 
            ...dialog, 
            status: 'taken', 
            assignedTo: currentUser?.id || 'current_operator',
            canTakeover: false,
            need_handover: false,
            lastMessage: '–î–∏–∞–ª–æ–≥ –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É',
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            messages: [...(dialog.messages || []), takeoverMessage],
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
            isOperatorActive: true,
            operatorId: currentUser?.id || 'current_operator'
          }
        : dialog
    ));
    
    setSelectedDialog(prev => 
      prev && prev.id === dialogId 
        ? { 
            ...prev, 
            status: 'taken', 
            assignedTo: currentUser?.id || 'current_operator',
            canTakeover: false,
            need_handover: false,
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            messages: [...(prev.messages || []), takeoverMessage],
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
            isOperatorActive: true,
            operatorId: currentUser?.id || 'current_operator'
          }
        : prev
    );
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –ë–î
    try {
      dialogsDB.updateDialog(dialogId, {
        status: 'taken',
        assigned_to: currentUser?.id || null,
        need_handover: false,
        last_message_at: new Date().toISOString()
      });
    } catch (e) {
      console.warn('Failed to sync takeover to DB:', e);
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º –ª–∏–¥ –≤ CRM –ø—Ä–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ –¥–∏–∞–ª–æ–≥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
    if (dialog && (dialog.email || dialog.phone)) {
      try {
        await createDealFromDialog(dialog);
        console.log('‚úÖ –õ–∏–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –≤ CRM –ø—Ä–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ –¥–∏–∞–ª–æ–≥–∞:', dialogId);
      } catch (error) {
        console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –ª–∏–¥ –≤ CRM –ø—Ä–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ:', error);
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    await updateDialogStatistics(dialogId, 'taken', {
      operatorId: currentUser?.id,
      channel: dialog?.channel || dialog?.source
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ –¥–∏–∞–ª–æ–≥–∞
    if (dialog) {
      const message = `ü§ñ –î–∏–∞–ª–æ–≥ ID: ${dialogId}\nüë§ –ö–ª–∏–µ–Ω—Ç: ${dialog.user || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\nüìû ${dialog.phone || dialog.email || '–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤'}\n‚ö° –°—Ç–∞—Ç—É—Å: –ü–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º`;
      sendTelegramNotification(message, 'operator_takeover');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
  const createTestDialog = async (source, firstMessage, needHandover = false) => {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∏–∞–ª–æ–≥–∞
    const dialogSource = source.includes('–í–∏–¥–∂–µ—Ç') ? 'widget' : source.includes('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ') ? 'admin' : source;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ –æ—Ç –∞–¥–º–∏–Ω–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    let existingDialog = dialogsData.find(d => 
      d.isTest && 
      d.source === dialogSource && 
      d.owner === 'admin' && 
      (d.status === 'active' || d.status === 'waiting')
    );
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ë–î
    if (!existingDialog && currentUser?.id) {
      try {
        const dbDialogs = await dialogsDB.getDialogsByUser(currentUser.id);
        existingDialog = dbDialogs.find(d => 
          d.isTest && 
          d.source === dialogSource && 
          d.owner === 'admin' && 
          (d.status === 'active' || d.status === 'waiting')
        );
        
        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –≤ –ë–î, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if (existingDialog && !dialogsData.find(d => d.id === existingDialog.id)) {
          setDialogsData(prev => [existingDialog, ...prev]);
        }
      } catch (error) {
        console.warn('Failed to check existing dialogs in DB:', error);
      }
    }
    
    if (existingDialog) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–∏–∞–ª–æ–≥
      const existingMessages = existingDialog.messages || [];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–µ–∫—Å—Ç—É –∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
      const isDuplicate = existingMessages.some(msg => 
        msg.text === firstMessage && 
        msg.isUser === true &&
        (Date.now() - (msg.id || 0) < 5000) // –ú–µ–Ω–µ–µ 5 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
      );
      
      const updatedDialog = {
        ...existingDialog,
        lastMessage: firstMessage,
        time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
        lastContact: new Date().toISOString(),
        need_handover: needHandover || existingDialog.need_handover,
        status: needHandover ? 'waiting' : existingDialog.status,
        priority: needHandover ? 'high' : existingDialog.priority,
        messages: isDuplicate ? existingMessages : [
          ...existingMessages,
          {
            id: Date.now(),
            text: firstMessage,
            isUser: true,
            time: '–¢–æ–ª—å–∫–æ —á—Ç–æ'
          }
        ],
        messageCount: isDuplicate ? existingDialog.messageCount : (existingDialog.messageCount || 0) + 1
      };
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥ –≤ —Å–ø–∏—Å–∫–µ
      setDialogsData(prev => prev.map(dialog => 
        dialog.id === existingDialog.id ? updatedDialog : dialog
      ));
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ –µ—Å–ª–∏ –æ–Ω —Ç–æ—Ç –∂–µ
      setSelectedDialog(prev => 
        prev && prev.id === existingDialog.id ? updatedDialog : prev
      );
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –¥—É–±–ª–∏–∫–∞—Ç
      if (!isDuplicate) {
        try {
          await chatHistoryAPI.saveMessage(currentUser.id, 'user', firstMessage, 'widget');
        } catch (e) {
          console.warn('Failed to save message to DB:', e);
        }
      }
      
      console.log('–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ –æ–±–Ω–æ–≤–ª–µ–Ω:', existingDialog.id);
      return updatedDialog;
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
    const dialogId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
    const testDialog = {
      id: dialogId,
      client: {
        name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        email: null,
        phone: null,
        company: '–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è'
      },
      title: `–¢–µ—Å—Ç: "${firstMessage.substring(0, 30)}${firstMessage.length > 30 ? '...' : ''}"`,
      stage: '–ù–æ–≤—ã–π',
      leadQuality: '–ì–æ—Ä—è—á–∏–π',
      amount: 0,
      days: 0,
      hasContacts: true,
      owner: 'admin',
      ownerName: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
      isResolved: false,
      notes: `–¢–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "${source}". –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${firstMessage}"`,
      createdDate: new Date().toISOString(),
      lastContact: new Date().toISOString(),
      dialogId: dialogId,
      status: needHandover ? 'waiting' : 'active',
      assignedTo: null,
      canTakeover: true,
      need_handover: needHandover,
      priority: needHandover ? 'high' : 'low',
      isTest: true, // –§–ª–∞–≥ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
      lastMessage: firstMessage,
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      user: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
      email: null, // –î–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ email –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ–º
      phone: null, // –î–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ–º
      source: source.includes('–í–∏–¥–∂–µ—Ç') ? 'widget' : source.includes('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ') ? 'admin' : source,
      time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
      // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ä–µ–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
      messages: [
        {
          id: 1,
          text: firstMessage,
          isUser: true,
          time: '–¢–æ–ª—å–∫–æ —á—Ç–æ'
        }
      ],
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ë–î
      messageCount: 1
    };
    
    try {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∏–∞–ª–æ–≥ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      if (currentUser?.id) {
        const saved = await dialogsDB.createTestDialog(currentUser.id, testDialog);
        if (saved && saved.id) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π id –ø–æ–¥ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π id –∏–∑ –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, UUID)
          testDialog.id = saved.id;
          testDialog.dialogId = saved.id;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
          try {
            await chatHistoryAPI.saveMessage(currentUser.id, 'user', firstMessage, 'widget');
          } catch (e) {
            console.warn('Failed to save message to DB:', e);
          }
        }
      }
      console.log('–ù–æ–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω:', dialogId);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞:', error);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥ –≤ —Å–ø–∏—Å–æ–∫
    setDialogsData(prev => [testDialog, ...prev]);
    // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç —Ä–∞–∑–¥–µ–ª –¥–∏–∞–ª–æ–≥–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–í—Å–µ" —á—Ç–æ–±—ã –Ω–µ —Å–∫—Ä—ã–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
    setActiveChatTab('all');
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º –ª–∏–¥ –≤ CRM –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (testDialog.email || testDialog.phone) {
      try {
        await createDealFromDialog(testDialog);
        console.log('‚úÖ –õ–∏–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –≤ CRM –¥–ª—è –¥–∏–∞–ª–æ–≥–∞:', testDialog.id);
      } catch (error) {
        console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –ª–∏–¥ –≤ CRM:', error);
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    await updateDialogStatistics(testDialog.id, 'created', {
      source: testDialog.source,
      needHandover: needHandover
    });
    
    return testDialog;
  };

  const handleReleaseDialog = (dialogId) => {
    setDialogsData(prev => prev.map(dialog => 
      dialog.id === dialogId 
        ? { 
            ...dialog, 
            status: 'waiting', 
            assignedTo: null,
            canTakeover: true 
          }
        : dialog
    ));
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –ë–î
    try {
      dialogsDB.updateDialog(dialogId, {
        status: 'waiting',
        assigned_to: null,
        need_handover: false
      });
    } catch (e) {
      console.warn('Failed to sync release to DB:', e);
    }
  };

  const handleCloseDialog = async (dialogId) => {
    setDialogsData(prev => prev.map(dialog => 
      dialog.id === dialogId 
        ? { 
            ...dialog, 
            status: 'resolved', 
            assignedTo: dialog.assignedTo,
            canTakeover: false,
            priority: null
          }
        : dialog
    ));
    
    // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–∏–∞–ª–æ–≥–∞
    try {
      await crmAPI.updateDealFromDialog(dialogId, 'closed', '–î–∏–∞–ª–æ–≥ –∑–∞–∫—Ä—ã—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º');
      console.log('CRM: –°–¥–µ–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–∏–∞–ª–æ–≥–∞');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–∏–∞–ª–æ–≥–∞:', error);
    }
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –ë–î
    try {
      dialogsDB.updateDialog(dialogId, {
        status: 'resolved_by_operator',
        need_handover: false
      });
    } catch (e) {
      console.warn('Failed to sync close to DB:', e);
    }
  };

  const handleConfirmCloseDialog = () => {
    if (dialogToClose) {
      handleCloseDialog(dialogToClose);
      setShowCloseDialogPopup(false);
      setDialogToClose(null);
    }
  };

  const handleConfirmDeleteDialog = () => {
    if (dialogToDelete) {
      // –£–¥–∞–ª—è–µ–º –¥–∏–∞–ª–æ–≥ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      setDialogsData(prev => prev.filter(dialog => dialog.id !== dialogToDelete));
      
      // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º—ã–π –¥–∏–∞–ª–æ–≥ —Å–µ–π—á–∞—Å –≤—ã–±—Ä–∞–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      if (selectedDialog && selectedDialog.id === dialogToDelete) {
        setSelectedDialog(null);
      }
      
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –ë–î - —É–¥–∞–ª—è–µ–º –¥–∏–∞–ª–æ–≥
      try {
        dialogsDB.deleteDialog(dialogToDelete);
      } catch (e) {
        console.warn('Failed to sync delete to DB:', e);
      }
      
      setShowDeleteDialogPopup(false);
      setDialogToDelete(null);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ –∫–∞–Ω–∞–ª–∞–º
  const groupDialogsByChannel = (dialogs) => {
    const grouped = {
      widget: [],
      telegram: [],
      whatsapp: [],
      vk: [],
      instagram: [],
      admin: [],
      other: []
    };

    dialogs.forEach(dialog => {
      const channel = dialog.channel || dialog.source || 'other';
      if (grouped[channel]) {
        grouped[channel].push(dialog);
      } else {
        grouped.other.push(dialog);
      }
    });

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    Object.keys(grouped).forEach(channel => {
      grouped[channel].sort((a, b) => {
        const timeA = new Date(a.last_message_at || a.created_at || 0).getTime();
        const timeB = new Date(b.last_message_at || b.created_at || 0).getTime();
        return timeB - timeA; // –ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
      });
    });

    return grouped;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ (—É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã)
  const getUniqueDialogs = (dialogs) => {
    const uniqueMap = new Map();
    
    dialogs.forEach(dialog => {
      const key = dialog.uniqueKey || `${dialog.channel}_${dialog.user_id}_${dialog.id}`;
      
      if (!uniqueMap.has(key)) {
        uniqueMap.set(key, dialog);
      } else {
        // –ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥ —É–∂–µ –µ—Å—Ç—å, –±–µ—Ä–µ–º –±–æ–ª–µ–µ –Ω–æ–≤—ã–π
        const existing = uniqueMap.get(key);
        const existingTime = new Date(existing.last_message_at || existing.created_at || 0).getTime();
        const currentTime = new Date(dialog.last_message_at || dialog.created_at || 0).getTime();
        
        if (currentTime > existingTime) {
          uniqueMap.set(key, dialog);
        }
      }
    });
    
    return Array.from(uniqueMap.values());
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –∫–∞–Ω–∞–ª—É
  // –î–µ–±–∞—É–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
  const debouncedSearch = ChatUtils.debounce((query) => {
    setSearchQuery(query);
  }, 300);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤ (–º–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
  const getFilteredDialogs = ChatUtils.memoize(() => {
    let filtered = dialogsData;

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
    if (activeChatTab === 'active') {
      if (isOperator) {
        // –î–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ "–ú–æ–∏" - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏
        filtered = filtered.filter(dialog => 
          dialog.status === 'taken' && dialog.assignedTo === (currentUser?.id || 'current_operator')
        );
      } else {
        // –î–ª—è –∞–¥–º–∏–Ω–∞ "–ê–∫—Ç–∏–≤–Ω—ã–µ" - –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –æ–∂–∏–¥–∞—é—â–∏–µ
        filtered = filtered.filter(dialog => 
          dialog.status === 'active' || dialog.status === 'waiting'
        );
      }
    } else if (activeChatTab === 'closed') {
      filtered = filtered.filter(dialog => 
        dialog.status === 'closed' || dialog.status === 'resolved' || dialog.status === 'resolved_by_operator'
      );
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞–Ω–∞–ª—É
    if (activeChannelFilter !== 'all') {
      filtered = filtered.filter(dialog => 
        (dialog.channel || dialog.source) === activeChannelFilter
      );
    }

    // –ü–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase().trim();
      filtered = filtered.filter(dialog => {
        // –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (dialog.user && dialog.user.toLowerCase().includes(query)) {
          return true;
        }
        // –ü–æ–∏—Å–∫ –ø–æ email
        if (dialog.email && dialog.email.toLowerCase().includes(query)) {
          return true;
        }
        // –ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        if (dialog.lastMessage && dialog.lastMessage.toLowerCase().includes(query)) {
          return true;
        }
        // –ü–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏–π
        if (dialog.messages && dialog.messages.some(message => 
          message.text && message.text.toLowerCase().includes(query)
        )) {
          return true;
        }
        return false;
      });
    }

    return filtered;
  });

  // –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
  const getMessageAlignment = ChatUtils.memoize((message) => {
    if (MessageUtils.isUserMessage(message) || MessageUtils.isOperatorMessage(message)) {
      return 'flex justify-end';
    }
    return 'flex justify-start'; // AI –∏ system —Å–ª–µ–≤–∞
  });

  const getMessageOrder = ChatUtils.memoize((message) => {
    if (MessageUtils.isUserMessage(message) || MessageUtils.isOperatorMessage(message)) {
      return 'order-2';
    }
    return 'order-1';
  });

  const getMessageStyle = ChatUtils.memoize((message) => {
    if (MessageUtils.isUserMessage(message)) {
      return 'bg-blue-600 text-white rounded-[20px] rounded-br-[4px]';
    }
    if (MessageUtils.isOperatorMessage(message)) {
      return 'bg-green-600 text-white rounded-[20px] rounded-br-[4px]';
    }
    if (MessageUtils.isSystemMessage(message)) {
      return 'bg-gray-400 text-white rounded-[20px] rounded-bl-[4px]';
    }
    if (MessageUtils.isAssistantMessage(message)) {
      return 'bg-[#EFEFEF] text-[#070F1A] rounded-[20px] rounded-bl-[4px]';
    }
    return 'bg-[#EFEFEF] text-[#070F1A] rounded-[20px] rounded-bl-[4px]';
  });

  const getMessageFooter = ChatUtils.memoize((message) => {
    if (MessageUtils.isAssistantMessage(message)) {
      return (
        <div className="mt-[5px] ml-11">
          <p className="text-[9px] text-[#8E8E93]">
            {aiAgentName} ‚Ä¢ {message.time || '–¢–æ–ª—å–∫–æ —á—Ç–æ'}
          </p>
        </div>
      );
    }
    if (MessageUtils.isOperatorMessage(message)) {
      return (
        <div className="mt-[5px] mr-11 text-right">
          <p className="text-[9px] text-[#8E8E93]">
            {MessageUtils.getSenderName(message)} ‚Ä¢ {message.time || '–¢–æ–ª—å–∫–æ —á—Ç–æ'}
          </p>
        </div>
      );
    }
    if (MessageUtils.isSystemMessage(message)) {
      return (
        <div className="mt-[5px] ml-11">
          <p className="text-[9px] text-[#8E8E93]">
            –°–∏—Å—Ç–µ–º–∞ ‚Ä¢ {message.time || '–¢–æ–ª—å–∫–æ —á—Ç–æ'}
          </p>
        </div>
      );
    }
    return null;
  });

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö
  const handleSendDialogMessage = async () => {
    if (!currentUser?.id || !selectedDialog?.id) return;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    const validation = validateMessage(messageText);
    if (!validation.isValid) {
      showNotificationMessage(`‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${validation.errors.join(', ')}`);
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit
    const rateLimit = checkRateLimit(currentUser.id);
    if (!rateLimit.allowed) {
      const resetTime = new Date(rateLimit.resetTime).toLocaleTimeString();
      showNotificationMessage(`‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –≤ ${resetTime}`);
      return;
    }
    
    // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    const sanitizedMessage = sanitizeMessage(validation.sanitizedMessage);
    
    try {
      // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      const operatorMessage = createUnifiedMessage({
        id: `operator_${Date.now()}_${Math.random()}`,
        text: sanitizedMessage,
        type: 'operator',
        sender_role: 'operator',
        isUser: false,
        sender: 'operator',
        time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
        timestamp: getUniqueTimestamp(),
        operatorId: currentUser?.id || 'current_operator',
        operatorName: currentUser?.email || '–û–ø–µ—Ä–∞—Ç–æ—Ä'
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
      setSelectedDialog(prev => prev ? {
        ...prev,
        messages: [...(prev.messages || []), operatorMessage],
        lastMessage: messageText,
        time: '–¢–æ–ª—å–∫–æ —á—Ç–æ'
      } : prev);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥ –≤ —Å–ø–∏—Å–∫–µ
      setDialogsData(prev => prev.map(dialog => 
        dialog.id === selectedDialog.id 
          ? { 
              ...dialog, 
              messages: [...(dialog.messages || []), operatorMessage],
              lastMessage: messageText,
              time: '–¢–æ–ª—å–∫–æ —á—Ç–æ'
            }
          : dialog
      ));
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      await chatHistoryAPI.saveMessage(currentUser.id, 'operator', messageText, 'dialog');
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      setMessageText('');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      await updateDialogStatistics(selectedDialog.id, 'message_added', {
        senderType: 'operator',
        messageLength: messageText.length
      });
      
      showNotificationMessage('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
      
    } catch (error) {
      console.error('Error sending dialog message:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram –±–æ—Ç–æ–º
  const handleConnectTelegramBot = async () => {
    if (!telegramBotToken.trim()) {
      setNotificationMessage('–í–≤–µ–¥–∏—Ç–µ API —Ç–æ–∫–µ–Ω –±–æ—Ç–∞');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
      return;
    }

    if (!currentUser?.id) {
      setNotificationMessage('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
      return;
    }

    setIsConnectingTelegramBot(true);
    
    try {
      const response = await fetch(`${API_CONFIG.BASE_URL}/api/messenger/telegram/connect`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          botToken: telegramBotToken,
          userId: currentUser.id
        })
      });

      const data = await response.json();

      if (data.success) {
        setTelegramBotConnected(true);
        setShowTelegramModal(false);
        setNotificationMessage('Telegram –±–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
        setShowNotification(true);
        setTimeout(() => setShowNotification(false), 3000);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ—Ç–∞
        await loadTelegramBotStatus();
      } else {
        setNotificationMessage(data.error || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞');
        setShowNotification(true);
        setTimeout(() => setShowNotification(false), 3000);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Telegram –±–æ—Ç–∞:', error);
      setNotificationMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
    } finally {
      setIsConnectingTelegramBot(false);
    }
  };

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Telegram –±–æ—Ç–∞
  const loadTelegramBotStatus = async () => {
    if (!currentUser?.id) return;

    try {
      const response = await fetch(`${API_CONFIG.BASE_URL}/api/messenger/telegram/status?userId=${currentUser.id}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      if (response.ok) {
        const data = await response.json();
        setTelegramBotConnected(data.connected);
        setTelegramBotStats(data.stats);
      }
    } catch (error) {
      console.error('Error loading Telegram bot status:', error);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ—Ä–∏—Å
  const loadStories = async () => {
    try {
      const storiesData = await getStories();
      setStories(storiesData);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–æ—Ä–∏—Å:', error);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å—Ç–æ—Ä–∏—Å
      setStories([
        {
          id: '1',
          title: '–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Adapto',
          image_url: '/Frame 137.png',
          order_index: 1
        },
        {
          id: '2', 
          title: '–û–±–∑–æ—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã',
          image_url: '/Frame 137-1.png',
          order_index: 2
        },
        {
          id: '3',
          title: '–ò—Å—Ç–æ—Ä–∏—è Adapto', 
          image_url: '/Frame 137-2.png',
          order_index: 3
        },
        {
          id: '4',
          title: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
          image_url: '/Frame 137-3.png', 
          order_index: 4
        },
        {
          id: '5',
          title: '–ù–∞—à —Ç–≥-–∫–∞–Ω–∞–ª',
          image_url: '/Frame 137-4.png',
          order_index: 5
        }
      ]);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ—Ä–∏—Å
  const handleAddStory = async () => {
    if (!newStoryTitle.trim() || !newStoryImage.trim()) {
      showNotificationMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }

    try {
      const newStory = {
        title: newStoryTitle,
        image_url: newStoryImage,
        order_index: stories.length + 1,
        is_active: true
      };

      await addStory(newStory);
      await loadStories();
      setNewStoryTitle('');
      setNewStoryImage('');
      setShowStoriesModal(false);
      showNotificationMessage('–°—Ç–æ—Ä–∏—Å –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç–æ—Ä–∏—Å:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç–æ—Ä–∏—Å');
    }
  };

  const handleEditStory = async (storyId, updates) => {
    try {
      await updateStory(storyId, updates);
      await loadStories();
      setEditingStory(null);
      showNotificationMessage('–°—Ç–æ—Ä–∏—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–æ—Ä–∏—Å:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–æ—Ä–∏—Å');
    }
  };

  const handleDeleteStory = async (storyId) => {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç–æ—Ä–∏—Å?')) {
      return;
    }

    try {
      await deleteStory(storyId);
      await loadStories();
      showNotificationMessage('–°—Ç–æ—Ä–∏—Å —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–æ—Ä–∏—Å:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–æ—Ä–∏—Å');
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
  const handleConnectTelegram = async () => {
    if (!telegramApiKey.trim()) {
      setNotificationMessage('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
      return;
    }

    if (!currentUser?.id) {
      console.log('‚ùå –ù–µ—Ç currentUser.id:', currentUser);
      setNotificationMessage('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
      return;
    }

    console.log('üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram —Å userId:', currentUser.id);

    setIsConnectingTelegram(true);
    
    try {
      const response = await fetch('${API_CONFIG.BASE_URL}/api/telegram/connect', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          apiKey: telegramApiKey,
          userId: currentUser?.id
        })
      });

      const data = await response.json();

      if (data.success) {
        setTelegramConnected(true);
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        await loadTelegramSettings();
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑—ã–≤–∞–µ–º user_id —Å chat_id
        try {
          const linkResponse = await fetch('${API_CONFIG.BASE_URL}/api/telegram/link-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              chatId: telegramSettings?.chat_id || '466811672', // Fallback –Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã–π chat_id
              userId: currentUser?.id
            })
          });
          
          if (linkResponse.ok) {
            console.log('‚úÖ User ID —Å–≤—è–∑–∞–Ω —Å Chat ID');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å–ª–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è
            await loadTelegramSettings();
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è user_id —Å chat_id:', error);
        }
        
        setNotificationMessage('Telegram –±–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
        setShowNotification(true);
        setTimeout(() => setShowNotification(false), 3000);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –æ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        const welcomeMessage = `üéâ Telegram –±–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!\n\n‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã\nüì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã\nüîî –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã\n\n–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!`;
        await sendTelegramNotification(welcomeMessage, 'system_alerts');
      } else {
        setNotificationMessage(data.error || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        setShowNotification(true);
        setTimeout(() => setShowNotification(false), 3000);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Telegram:', error);
      setNotificationMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
    } finally {
      setIsConnectingTelegram(false);
    }
  };

  const loadTelegramSettings = async () => {
    try {
      const response = await fetch(`${API_CONFIG.BASE_URL}/api/telegram/settings?userId=${currentUser?.id}`);
      const data = await response.json();
      
      if (data.success && data.settings) {
        setTelegramSettings(data.settings);
        setTelegramConnected(true);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram:', error);
    }
  };

  const updateNotificationSettings = async (enabled, notificationTypes) => {
    try {
      const response = await fetch('${API_CONFIG.BASE_URL}/api/telegram/settings', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: currentUser?.id,
          enabled,
          notificationTypes
        })
      });

      const data = await response.json();
      
      if (data.success) {
        setTelegramSettings(data.settings);
        setNotificationMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        setShowNotification(true);
        setTimeout(() => setShowNotification(false), 3000);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
    }
  };

  const toggleNotificationType = async (type) => {
    console.log('Toggle notification type:', type, 'Current settings:', telegramSettings);
    
    if (!telegramSettings) {
      console.log('No telegram settings found, creating default');
      // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ
      const defaultTypes = ['new_messages', 'operator_takeover', 'system_alerts', 'daily_reports'];
      const newTypes = defaultTypes.includes(type)
        ? defaultTypes.filter(t => t !== type)
        : [...defaultTypes, type];
      
      await updateNotificationSettings(true, newTypes);
      return;
    }

    const currentTypes = telegramSettings.notification_types || [];
    const newTypes = currentTypes.includes(type)
      ? currentTypes.filter(t => t !== type)
      : [...currentTypes, type];

    await updateNotificationSettings(telegramSettings.enabled, newTypes);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  const sendTelegramNotification = async (message, type = 'operator_takeover') => {
    try {
      console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', { 
        userId: currentUser?.id, 
        type, 
        message: message.substring(0, 50) + '...',
        telegramSettings: telegramSettings
      });

      // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Ö
      if (!telegramSettings || !telegramSettings.chat_id) {
        console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram...');
        await loadTelegramSettings();
      }

      const response = await fetch('${API_CONFIG.BASE_URL}/api/telegram/send', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: currentUser?.id,
          message: message,
          type: type
        })
      });

      const responseData = await response.json();
      
      if (!response.ok) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', responseData);
        setNotificationMessage(`–û—à–∏–±–∫–∞ Telegram: ${responseData.error || response.statusText}`);
        setShowNotification(true);
        setTimeout(() => setShowNotification(false), 5000);
      } else {
        console.log('‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', responseData);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
      setNotificationMessage(`–û—à–∏–±–∫–∞ Telegram: ${error.message}`);
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 5000);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
  const generateDailyReport = () => {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const yesterdayStr = yesterday.toLocaleDateString('ru-RU');
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –≤—á–µ—Ä–∞
    const totalDialogs = dialogsData.length;
    const newToday = dialogsData.filter(dialog => {
      const dialogDate = new Date(dialog.createdDate);
      return dialogDate.toDateString() === yesterday.toDateString();
    }).length;
    
    const resolved = dialogsData.filter(dialog => dialog.isResolved).length;
    const waiting = dialogsData.filter(dialog => dialog.status === 'waiting').length;
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
    const totalMessages = chatMessages.length;
    const successfulResponses = Math.round(totalMessages * 0.93); // 93% —É—Å–ø–µ—à–Ω—ã—Ö
    const handedToOperator = dialogsData.filter(dialog => dialog.need_handover).length;
    
    // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    const uniqueVisitors = Math.round(newToday * 3); // –ø—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
    const conversionRate = Math.round((resolved / Math.max(newToday, 1)) * 100);
    const avgResponseTime = "2.3 —Å–µ–∫";

    const report = `üìä –ï–ñ–ï–î–ù–ï–í–ù–´–ô –û–¢–ß–ï–¢ - ${yesterdayStr}

üí¨ –î–ò–ê–õ–û–ì–ò:
‚Ä¢ –í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤: ${totalDialogs}
‚Ä¢ –ù–æ–≤—ã—Ö –≤—á–µ—Ä–∞: ${newToday}
‚Ä¢ –†–µ—à–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: ${resolved}
‚Ä¢ –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è: ${waiting}

ü§ñ –ò–ò:
‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${totalMessages}
‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${successfulResponses} (93%)
‚Ä¢ –ü–µ—Ä–µ–¥–∞–Ω–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É: ${handedToOperator}

üìà –ê–ö–¢–ò–í–ù–û–°–¢–¨:
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π: ${uniqueVisitors}
‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ª–∏–¥—ã: ${conversionRate}%
‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${avgResponseTime}`;

    return report;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
  const sendDailyReport = async () => {
    try {
      const response = await fetch('${API_CONFIG.BASE_URL}/api/telegram/daily-report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: currentUser?.id
        })
      });

      if (response.ok) {
        showNotificationMessage('–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram');
      } else {
        showNotificationMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
  const loadAutoswitchSettings = async () => {
    try {
      const response = await fetch('${API_CONFIG.BASE_URL}/api/autoswitch/settings');
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          setAutoswitchSettings(data.settings);
        }
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è:', error);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  const hasPersonalChanges = () => {
    return personalInfo.name !== originalPersonalInfo.name ||
           personalInfo.email !== originalPersonalInfo.email ||
           personalInfo.company !== originalPersonalInfo.company ||
           personalInfo.phone !== originalPersonalInfo.phone ||
           personalInfo.newPassword !== '' ||
           personalInfo.confirmPassword !== '';
  };

  const handleSavePersonalInfo = async () => {
    if (!hasPersonalChanges()) return;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
    if (personalInfo.newPassword && personalInfo.newPassword !== personalInfo.confirmPassword) {
      setNotificationMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
      setShowNotification(true);
      return;
    }

    try {
      // –ó–¥–µ—Å—å –±—É–¥–µ—Ç API –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
      console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:', personalInfo);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º currentUser
      setCurrentUser(prev => ({
        ...prev,
        name: personalInfo.name,
        email: personalInfo.email,
        company: personalInfo.company,
        phone: personalInfo.phone
      }));

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      setOriginalPersonalInfo({
        name: personalInfo.name,
        email: personalInfo.email,
        company: personalInfo.company,
        phone: personalInfo.phone
      });

      // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–∞—Ä–æ–ª—è
      setPersonalInfo(prev => ({
        ...prev,
        newPassword: '',
        confirmPassword: ''
      }));

      setNotificationMessage('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      setShowNotification(true);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
      setNotificationMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      setShowNotification(true);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  const validatePhone = (phone) => {
    const phoneNumbers = phone.replace(/\D/g, '');
    if (!phone) return '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω';
    if (phoneNumbers.length !== 11) return '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 11 —Ü–∏—Ñ—Ä';
    if (!phoneNumbers.startsWith('7')) return '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 7';
    return null;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞
  const generateAvatar = (name) => {
    if (!name) return { color: '#3B82F6', letter: '–ü' };
    
    const colors = [
      '#3B82F6', '#EF4444', '#10B981', '#F59E0B', 
      '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16'
    ];
    
    const letter = name.charAt(0).toUpperCase();
    const colorIndex = name.charCodeAt(0) % colors.length;
    
    return { color: colors[colorIndex], letter };
  };

  // Setup data
  const [setupData, setSetupData] = useState({
    // –®–∞–≥ 1: –¶–µ–ª–∏ Adapto
    task: '',
    mainGoal: '',
    mainGoalCustom: '',
    customGoal: '',
    dealCycle: '',
    targetAudience: '',
    
    // –®–∞–≥ 2: –ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è
    addressing: '–í—ã',
    communicationStyle: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π',
    restrictions: [],
    showCustomRestriction: false,
    customRestriction: '',
    communicationSettings: [],
    showCustomCommunicationSetting: false,
    customCommunicationSetting: '',
    dataCollection: [],
    showCustomData: false,
    customData: '',
    clarificationQuestions: [],
    showCustomClarificationQuestion: false,
    customClarificationQuestion: '',
    emojiUsage: '–ù–∏–∫–æ–≥–¥–∞',
    editingStage: null,
    
    // –®–∞–≥ 3: –≠—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞
    dialogStages: [
      'üéØ –£–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–ê: –ü–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è —Ç–µ–ø–ª–æ, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫–∞–∫ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫. –°–ø—Ä–æ—Å–∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∫–∞–∫ –¥–µ–ª–∞. –°–æ–∑–¥–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.',
      'üîç –í–´–Ø–°–ù–ï–ù–ò–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ï–ô: –ó–∞–¥–∞–≤–∞–π –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞, —Ü–µ–ª—è—Ö –∏ —Å–∏—Ç—É–∞—Ü–∏–∏. –£—Ç–æ—á–Ω–∏ –¥–µ—Ç–∞–ª–∏: –±—é–¥–∂–µ—Ç, —Å—Ä–æ–∫–∏, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.',
      'üí° –ü–†–ï–ó–ï–ù–¢–ê–¶–ò–Ø –ò –ó–ê–ö–†–´–¢–ò–ï: –ü—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π. –†–∞—Å—Å–∫–∞–∂–∏ –æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö –∏ –≤—ã–≥–æ–¥–∞—Ö. –ü—Ä–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è—Ö - –≤—ã—è—Å–Ω–∏ –ø—Ä–∏—á–∏–Ω—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã. –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤ - –ø–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.'
    ],
    dialogStagesModified: null, // null = –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏, true = –∏–∑–º–µ–Ω–µ–Ω–æ, false = –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ
    
    // –î–ª—è –ø–æ–ø–∞–ø–∞ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ - –®–∞–≥ 4: –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
    knowledgeItems: [],
    selectedKnowledgeType: null,
    knowledgeInput: '',
    
    // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏
    modelProvider: 'gigachat',
    modelName: 'GigaChat:latest',
    systemPrompt: '',
    temperature: 0.7,
    maxTokens: 1000,
    customInstructions: '',
    enableRag: true,
    enableValidation: true,
    enableMonitoring: true
  });

  // Chat and knowledge data
  const [chatHistory, setChatHistory] = useState([
    { type: 'assistant', text: '–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Adapto. –ö–∞–∫ –¥–µ–ª–∞?', time: '–¢–æ–ª—å–∫–æ —á—Ç–æ', timestamp: Date.now() },
    { type: 'user', text: '–ü—Ä–∏–≤–µ—Ç! –†–∞—Å—Å–∫–∞–∂–∏ –æ –≤–∞—à–∏—Ö —É—Å–ª—É–≥–∞—Ö', time: '–¢–æ–ª—å–∫–æ —á—Ç–æ', timestamp: Date.now() },
    { type: 'assistant', text: '–ö–æ–Ω–µ—á–Ω–æ! –ú—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º —à–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä —É—Å–ª—É–≥ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ IT-—Ä–µ—à–µ–Ω–∏–π.', time: '1 –º–∏–Ω –Ω–∞–∑–∞–¥', timestamp: Date.now() - 60000 }
  ]);

  // –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ ai-agent-system
  const [aiAgentInitialized, setAiAgentInitialized] = useState(false);
  const [currentMessage, setCurrentMessage] = useState('');
  const [botCorrection, setBotCorrection] = useState('');
  const [botCorrections, setBotCorrections] = useState([]);
  const [hiddenCorrections, setHiddenCorrections] = useState(new Set());
  const [selectedCorrections, setSelectedCorrections] = useState(new Set());
  const [activeCorrections, setActiveCorrections] = useState(new Set()); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã
  const [showAddCorrectionForm, setShowAddCorrectionForm] = useState(false);
  const [newCorrectionText, setNewCorrectionText] = useState('');
  const [isUpdatingCorrections, setIsUpdatingCorrections] = useState(false);
  const [isUpdatingDialog, setIsUpdatingDialog] = useState(false);
  const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false);
  const [showScriptModal, setShowScriptModal] = useState(false);
  const [hasKnowledgeBase, setHasKnowledgeBase] = useState(false);
  const [knowledgeItems, setKnowledgeItems] = useState([]);
  const [newKnowledgeItem, setNewKnowledgeItem] = useState({ type: 'text', content: '', nicheId: '' });
  const [availableNiches, setAvailableNiches] = useState([]);
  const [selectedNicheId, setSelectedNicheId] = useState('');
  const [currentNicheSynonyms, setCurrentNicheSynonyms] = useState([]);
  // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ü–≤–µ—Ç/–ª–µ–π–±–ª –¥–ª—è –Ω–∏—à
  const normalize = (s: string = '') => s.toLowerCase().trim();
  const getNicheDisplayName = (name: string = ''): string => {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
    return name || '–ë–µ–∑ –Ω–∏—à–∏';
  };
  const getNicheColorByName = (name: string = ''): string => {
    const n = normalize(name);
    if (n.includes('–¥–µ—Ç–µ–π–ª–∏–Ω')) return '#56AAF7'; // –≥–æ–ª—É–±–æ–π
    if (n.includes('–∫—Ä–∞—Å–æ—Ç') || n.includes('—É—Ö–æ–¥')) return '#FF6FAE'; // —Ä–æ–∑–æ–≤—ã–π
    if (n.includes('–æ–±—Ä–∞–∑–æ–≤–∞–Ω')) return '#FFA64D'; // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
    if (n.includes('–º–µ–¥–∏—Ü–∏–Ω') || n.includes('—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥')) return '#0084FF'; // —Å–∏–Ω–∏–π
    if (n.includes('ecom') || n.includes('e-comm') || n.includes('ecomm') || (n.includes('–∏–Ω—Ç–µ—Ä–Ω–µ—Ç') && n.includes('–º–∞–≥–∞–∑'))) return '#8EE38A'; // —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
    if (n.includes('–∞–π—Ç–∏') || n.includes('it') || n.includes('–¥–∏–∑–∞–π–Ω')) return '#8B5CF6'; // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
    if (n.includes('–º–∞—Ä–∫–µ—Ç–∏–Ω–≥') || n.includes('—Ä–µ–∫–ª–∞–º')) return '#B19CD9'; // —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—Å–≤–µ—Ç–ª—ã–π
    if (n.includes('–¥–µ—Ç—Å–∫')) return '#FFD84D'; // –∂–µ–ª—Ç—ã–π
    if (n.includes('—Ä–µ—Å—Ç–æ—Ä–∞–Ω')) return '#FF8A80'; // —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π
    if (n.includes('–æ—Ç–µ–ª') || n.includes('–∫–µ–º–ø–∏–Ω–≥')) return '#34C759'; // –∑–µ–ª–µ–Ω—ã–π
    if (n.includes('—Å–ø–æ—Ä—Ç')) return '#FF3B30'; // –∫—Ä–∞—Å–Ω—ã–π
    return '#E5E6E7';
  };
  const getNicheColor = (nicheId: string): string => {
    const niche = availableNiches.find(n => n.id === nicheId);
    return getNicheColorByName(niche?.name || '');
  };

  useEffect(() => {
    (async () => {
      try {
        const { data, error } = await supabase
          .from('niches')
          .select('id, name')
          .order('name', { ascending: true });
        if (!error) setAvailableNiches(data || []);
      } catch (e) {}
    })();
  }, []);

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –Ω–∏—à–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã user_niches –ø–æ project_id
  useEffect(() => {
    (async () => {
      try {
        if (!currentUser?.id || !currentUser?.project_id) return;
        console.log('=== LOADING NICHE FROM USER_NICHES ===');
        console.log('Current user ID:', currentUser.id);
        console.log('Current project ID:', currentUser.project_id);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏—à—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã user_niches
        const { data: userNiche, error: nicheError } = await supabase
          .from('user_niches')
          .select('niche_id')
          .eq('project_id', currentUser.project_id)
          .single();
        
        if (!nicheError && userNiche?.niche_id) {
          console.log('Niche loaded from user_niches:', userNiche.niche_id);
          setSelectedNicheId(userNiche.niche_id);
          setNewKnowledgeItem(prev => ({
            ...prev,
            nicheId: userNiche.niche_id
          }));
        } else {
          // Fallback: –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≥–µ–Ω—Ç–∞
          console.log('Loading niche from agent settings as fallback');
          const settings = await agentSettings.getAgentSettings(currentUser.id);
          const nicheIdFromSettings = settings?.niche_id || settings?.settings?.nicheId || '';
          
          if (nicheIdFromSettings) {
            console.log('Niche loaded from agent settings:', nicheIdFromSettings);
            setSelectedNicheId(nicheIdFromSettings);
            setNewKnowledgeItem(prev => ({
              ...prev,
              nicheId: nicheIdFromSettings
            }));
          }
        }
      } catch (e) {
        console.error('Error loading niche:', e);
      }
    })();
  }, [currentUser?.id, currentUser?.project_id]);

  // –°–∏–Ω–æ–Ω–∏–º—ã –±–æ–ª—å—à–µ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∏–∑ UI; –ø–æ–∫–∞–∑ –∏–∑ –ë–î –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å/—Å–∫—Ä—ã—Ç—å
  useEffect(() => {
    setCurrentNicheSynonyms([]);
  }, [selectedNicheId]);

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–∏—à–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
  const handleSelectNiche = async (nicheId) => {
    try {
      console.log('=== SELECTING NICHE ===');
      console.log('Selected nicheId:', nicheId);
      console.log('Current user ID:', currentUser?.id);
      
      setSelectedNicheId(nicheId);
      // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –Ω–∏—à—É –≤ –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
      setNewKnowledgeItem(prev => {
        const updated = { ...prev, nicheId };
        console.log('Updated newKnowledgeItem:', updated);
        return updated;
      });
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏—à—É –≤ —Ç–∞–±–ª–∏—Ü—É user_niches —Å project_id
      if (currentUser?.project_id) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ –µ—Å—Ç—å
        await supabase
          .from('user_niches')
          .delete()
          .eq('project_id', currentUser.project_id);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        if (nicheId && nicheId.trim() !== '') {
          const { error: insertError } = await supabase
            .from('user_niches')
            .insert({
              project_id: currentUser.project_id,
              niche_id: nicheId,
              created_at: new Date().toISOString()
            });
          
          if (insertError) {
            console.error('Error saving niche:', insertError);
            throw insertError;
          }
        }
        console.log('Niche saved to user_niches table');
      }
      
      // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      const existing = await agentSettings.getAgentSettings(currentUser.id);
      const mergedSettings = {
        ...(existing?.settings || {}),
        nicheId
      };
      await agentSettings.saveAgentSettings(currentUser.id, mergedSettings);
      
      showNotificationMessage('‚úÖ –ù–∏—à–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∏—à–∏:', e);
      showNotificationMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏—à—É');
    }
  };

  // –£–±—Ä–∞–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –∏–∑ UI
  const [processingProgress, setProcessingProgress] = useState({});

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–µ—Ä–∏–æ–¥–∞
  const updateStatisticsForPeriod = async (startDate, endDate) => {
    if (!currentUser?.id) return;
    
    try {
      const agg = await statsAPI.getAggregates(currentUser.id, startDate, endDate);
      if (agg) {
        setStatisticsAggregates(agg);
      }
    } catch (e) {
      console.warn('Failed to update statistics for period:', e);
    }
  };
  const [statisticsAggregates, setStatisticsAggregates] = useState({
    dialogsTotal: 0,
    messagesTotal: 0,
    resolvedTotal: 0,
    handoverTotal: 0,
    convertedTotal: 0,
    avgMessagesPerDialog: 0,
    conversionRate: 0,
    // –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    widget_opens: 0,
    bounce_rate: 0,
    customer_engagement: 0,
    resolved_questions: 0,
    escalation_rate: 0,
    avg_response_time: 0,
    avg_resolution_time: 0,
    ai_effectiveness_score: 0,
    help_request_rate: 0
  });
  const [selectedKnowledgeItem, setSelectedKnowledgeItem] = useState(null);
  const [showSitePopup, setShowSitePopup] = useState(false);
  const [showFeedPopup, setShowFeedPopup] = useState(false);
  const [showFilePopup, setShowFilePopup] = useState(false);
  const [showTextPopup, setShowTextPopup] = useState(false);
  const [showKnowledgeDetailsPopup, setShowKnowledgeDetailsPopup] = useState(false);
  const [selectedKnowledgeDetails, setSelectedKnowledgeDetails] = useState(null);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (selectedKnowledgeItem && !event.target.closest('.dropdown-menu')) {
        setSelectedKnowledgeItem(null);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [selectedKnowledgeItem]);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  const loadDialogs = async () => {
    console.log('=== LOAD DIALOGS DEBUG ===');
    console.log('currentUser:', currentUser);
    console.log('currentUser?.id:', currentUser?.id);
    console.log('currentUser?.email:', currentUser?.email);
    
    if (!currentUser?.id) {
      console.log('–ù–µ—Ç currentUser?.id, –≤—ã—Ö–æ–¥–∏–º');
      return;
    }
    
    try {
      console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUser?.id);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏ (–∫–∞—Ä—Ç–æ—á–∫–∏ CRM) –∏–∑ –ë–î
      const dbDialogs = await dialogsDB.getDialogs(currentUser?.id, { limit: 200 });
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ–¥ UI-—Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Å–æ—Ö—Ä–∞–Ω—è—è –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è
      const uiDialogs = (dbDialogs || []).map(d => ({
        id: d.id,
        name: d.client_name || '–ö–ª–∏–µ–Ω—Ç',
        email: d.client_email || '',
        phone: d.client_phone || '',
        source: d.source || 'admin',
        status: d.status || 'active',
        assignedTo: d.assigned_to || null,
        need_handover: d.need_handover || false,
        canTakeover: d.can_takeover !== false,
        isTest: !!d.is_test,
        lastMessage: d.description || '',
        time: d.last_message_at ? updateMessageTime(new Date(d.last_message_at).getTime()) : '',
        messages: d.messages || [],
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–∏
        channel: d.channel,
        assistant_id: d.assistant_id,
        session_persistent_id: d.session_persistent_id,
        user_id: d.user_id,
        is_operator_takeover: d.is_operator_takeover,
        operator_id: d.operator_id,
        takeover_at: d.takeover_at,
        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
        uniqueKey: `${d.channel}_${d.user_id || d.assistant_id}_${d.session_persistent_id || d.id}`
      }));
      
      // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –¥–∏–∞–ª–æ–≥–æ–≤
      const uniqueDialogs = getUniqueDialogs(uiDialogs);
      console.log('Unique dialogs:', uniqueDialogs.length, 'from', uiDialogs.length);
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥–∏ –ø–æ –∫–∞–Ω–∞–ª–∞–º –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
      const groupedDialogs = groupDialogsByChannel(uniqueDialogs);
      console.log('Grouped dialogs:', groupedDialogs);
      
      setDialogsData(uniqueDialogs);
      setGroupedDialogs(groupedDialogs);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≥—Ä–µ–≥–∞—Ç—ã –º–µ—Ç—Ä–∏–∫
      try {
        const agg = await statsAPI.getAggregates(currentUser.id, dateRange.start, dateRange.end);
        if (agg) {
          setStatisticsAggregates(agg);
        }
      } catch (e) {
        console.warn('Failed to load aggregates:', e);
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏ –∏–∑ admin –∫–∞–Ω–∞–ª–∞ (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞)
      const adminHistory = await chatHistoryAPI.getChatHistory(currentUser?.id, 'admin', 50);
      console.log('Admin –¥–∏–∞–ª–æ–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', adminHistory);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏ –∏–∑ widget –∫–∞–Ω–∞–ª–∞ (–¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –í–∏–¥–∂–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
      const widgetHistory = await chatHistoryAPI.getChatHistory(currentUser?.id, 'widget', 50);
      console.log('Widget –¥–∏–∞–ª–æ–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', widgetHistory);
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º admin –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è chatHistory
      const formattedAdminHistory = adminHistory.map(msg => ({
        type: msg.role === 'user' ? 'user' : 'assistant',
        text: msg.message_content,
        time: updateMessageTime(new Date(msg.created_at).getTime()),
        timestamp: new Date(msg.created_at).getTime(),
        id: `loaded_${msg.id}_${Date.now()}`
      })).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º widget –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è chatMessages
      const formattedWidgetHistory = widgetHistory.map(msg => ({
        id: msg.id,
        text: msg.message_content,
        isUser: msg.role === 'user',
        time: updateMessageTime(new Date(msg.created_at).getTime()),
        timestamp: new Date(msg.created_at).getTime()
      })).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
      
      console.log('–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ admin –¥–∏–∞–ª–æ–≥–∏:', formattedAdminHistory);
      console.log('–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ widget –¥–∏–∞–ª–æ–≥–∏:', formattedWidgetHistory);
      
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ - —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é –∏ –≤—Ä–µ–º–µ–Ω–∏
      const uniqueAdminHistory = formattedAdminHistory.filter((msg, index, arr) => {
        return arr.findIndex(m => m.text === msg.text && Math.abs(m.timestamp - msg.timestamp) < 1000) === index;
      });
      
      const uniqueWidgetHistory = formattedWidgetHistory.filter((msg, index, arr) => {
        return arr.findIndex(m => m.text === msg.text && Math.abs(m.timestamp - msg.timestamp) < 1000) === index;
      });
      
      setChatHistory(uniqueAdminHistory);
      setChatMessages(uniqueWidgetHistory);
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
      ChatUtils.scrollToBottom(chatHistoryRef, 200);
      ChatUtils.scrollToBottom(widgetChatRef, 200);
      
      console.log('–î–∏–∞–ª–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã');
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤:', error);
    }
  };

  // Offline —Ä–µ–∂–∏–º - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ç–∏
  useEffect(() => {
    const handleOnline = () => {
      console.log('üåê Network online - starting sync');
      setIsOnline(true);
      setShowOfflineIndicator(false);
      OfflineManager.updateNetworkStatus(true);
      
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º offline —Å–æ–æ–±—â–µ–Ω–∏—è
      OfflineManager.syncOfflineMessages(
        async (message) => {
          // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
          if (message.channel === 'admin') {
            return await sendMessageToAiAgent(message.text, message.userId, message.assistantId, []);
          } else if (message.channel === 'widget') {
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
            return await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.WIDGET_ENDPOINT}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                key: `adapto_${message.userId}_${Date.now()}`,
                message: message.text,
                conversationHistory: []
              })
            });
          }
        },
        chatHistoryAPI
      );
    };

    const handleOffline = () => {
      console.log('üì¥ Network offline');
      setIsOnline(false);
      setShowOfflineIndicator(true);
      OfflineManager.updateNetworkStatus(false);
    };

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ offline —Å–æ–æ–±—â–µ–Ω–∏–π
    const updateOfflineCount = () => {
      const offlineMessages = OfflineManager.getOfflineMessages();
      setOfflineMessageCount(offlineMessages.filter(msg => !msg.synced).length);
    };

    // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è —Å–µ—Ç–∏
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateOfflineCount();
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    const interval = setInterval(updateOfflineCount, 5000);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
      clearInterval(interval);
    };
  }, [currentUser?.id]);

  // WebSocket –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  useEffect(() => {
    if (!currentUser?.id) return;

    // –°–æ–∑–¥–∞–µ–º WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å retry –ª–æ–≥–∏–∫–æ–π
    const wsUrl = API_CONFIG.BASE_URL.replace('http', 'ws') + API_CONFIG.WEBSOCKET_ENDPOINT + `/${currentUser.id}`;
    
    const ws = ChatUtils.retryWebSocketConnection(wsUrl, {
      maxRetries: 5,
      baseDelay: 2000,
      onConnect: (ws) => {
        console.log('üîå WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤');
      },
      onError: (error) => {
        console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
      },
      onRetry: (retryCount) => {
        console.log(`üîÑ WebSocket –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ${retryCount}/5`);
      }
    });
    
    if (ws) {
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤:', data);
          
          switch (data.type) {
            case 'dialog_created':
            case 'dialog_updated':
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
              loadDialogs();
              break;
            case 'message_added':
              // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥
              setDialogsData(prev => prev.map(dialog => 
                dialog.id === data.dialogId 
                  ? { ...dialog, lastMessage: data.message, time: '—Ç–æ–ª—å–∫–æ —á—Ç–æ' }
                  : dialog
              ));
              break;
            case 'dialog_taken':
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–∏–∞–ª–æ–≥–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ
              setDialogsData(prev => prev.map(dialog => 
                dialog.id === data.dialogId 
                  ? { ...dialog, status: 'taken', assignedTo: data.operatorId }
                  : dialog
              ));
              break;
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ WebSocket —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        }
      };
    }
    
    ws.onclose = () => {
      console.log('üîå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
      // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        if (currentUser?.id) {
          console.log('üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket...');
        }
      }, 5000);
    };
    
    return () => {
      ws.close();
    };
  }, [currentUser?.id]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  useEffect(() => {
    if (currentUser?.id) {
      loadDialogs();
      // loadUserLimits(); // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ
      
      // –î–∞–µ–º –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤
      setUserAccess({
        hasAccess: true,
        isExpired: false,
        reason: null
      });
    }
  }, [currentUser]);


  // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const loadUserLimits = async () => {
    if (!currentUser?.id) return;
    
    try {
      const response = await fetch(`${API_CONFIG.BASE_URL}/api/user-limits/${currentUser?.id}`);
      if (response.ok) {
        const limits = await response.json();
        setUserLimits(limits);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ limits –Ω–µ null
        if (limits) {
          const hasAccess = !limits.isExpired && limits.daysRemaining > 0 && limits.tokensRemaining > 0;
          setUserAccess({
            hasAccess,
            isExpired: limits.isExpired,
            reason: limits.isExpired ? 'trial_expired' : 
                    limits.daysRemaining <= 0 ? 'days_expired' :
                    limits.tokensRemaining <= 0 ? 'tokens_expired' : null
          });
        } else {
          // –ï—Å–ª–∏ –ª–∏–º–∏—Ç–æ–≤ –Ω–µ—Ç, –¥–∞–µ–º –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
          setUserAccess({
            hasAccess: true,
            isExpired: false,
            reason: null
          });
        }
      } else {
        // –ï—Å–ª–∏ –ª–∏–º–∏—Ç–æ–≤ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –∏—Ö
        const createResponse = await fetch('${API_CONFIG.BASE_URL}/api/user-limits', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser?.id })
        });
        
        if (createResponse.ok) {
          const newLimits = await createResponse.json();
          setUserLimits(newLimits);
          setUserAccess({
            hasAccess: true,
            isExpired: false,
            reason: null
          });
        }
      }
    } catch (error) {
      console.error('Error loading user limits:', error);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (showUserDropdown && !event.target.closest('.user-dropdown')) {
        setShowUserDropdown(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showUserDropdown]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∏–∑ localStorage –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  // –£–±–∏—Ä–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑ localStorage - —Ç–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑ Supabase –ø—Ä–∏ –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  // useEffect(() => {
  //   const savedCorrections = localStorage.getItem('botCorrections');
  //   if (savedCorrections) {
  //     try {
  //       const parsedCorrections = JSON.parse(savedCorrections);
  //       setBotCorrections(parsedCorrections);
  //     } catch (error) {
  //       console.error('Error parsing saved corrections:', error);
  //     }
  //   }
  // }, []);

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ dashboard –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–æ—à–µ–ª
  useEffect(() => {
    if (isLoggedIn && currentUser && currentStep === 'login') {
      console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–æ—à–µ–ª, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ dashboard');
      setCurrentStep('dashboard');
    }
  }, [isLoggedIn, currentUser, currentStep]);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ —Å–ª–∞–π–¥–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  const slideImages = ['/Frame 126.png', '/Frame 127.png', '/Frame 128.png', '/Frame 129.png', '/Frame 130.png'];
  
  useEffect(() => {
    if (currentStep === 'login' || currentStep === 'register') {
      console.log('–°–ª–∞–π–¥–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω, —Ç–µ–∫—É—â–∏–π —Å–ª–∞–π–¥:', currentSlide, 'URL:', slideImages[currentSlide]);
      const interval = setInterval(() => {
        setIsTransitioning(true);
        setTimeout(() => {
          setCurrentSlide((prev) => (prev + 1) % 5);
          setIsTransitioning(false);
        }, 300);
      }, 4500);

      return () => clearInterval(interval);
    }
  }, [currentStep, currentSlide]);

  const [sitePopupTab, setSitePopupTab] = useState('full'); // 'full' –∏–ª–∏ 'selective'
  const [siteUrl, setSiteUrl] = useState('');
  const [selectedPages, setSelectedPages] = useState(['']);
  const [siteUrlError, setSiteUrlError] = useState('');
  const [selectedPagesErrors, setSelectedPagesErrors] = useState(['']);
  
  // Feed popup states
  const [feedUrl, setFeedUrl] = useState('');
  const [feedUrlError, setFeedUrlError] = useState('');
  
  // File popup states
  const [selectedFiles, setSelectedFiles] = useState([]);
  const [uploadedFiles, setUploadedFiles] = useState([]);
  
  // Text popup states
  const [textContent, setTextContent] = useState('');
  const [textContentError, setTextContentError] = useState('');

  // Dashboard states
  const [showCalendar, setShowCalendar] = useState(false);
  const [showExport, setShowExport] = useState(false);
  const [dateRange, setDateRange] = useState({ start: null, end: null });
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [selectedDates, setSelectedDates] = useState([]);
  const [activeQuickSelect, setActiveQuickSelect] = useState(null);
  const [dateStartInput, setDateStartInput] = useState('');
  const [dateEndInput, setDateEndInput] = useState('');
  const [dateStartError, setDateStartError] = useState(false);
  const [dateEndError, setDateEndError] = useState(false);

  const formatDateInputValue = (value) => {
    const digits = (value || '').replace(/\D/g, '').slice(0, 8);
    let out = digits;
    if (digits.length > 4) {
      out = `${digits.slice(0, 2)}.${digits.slice(2, 4)}.${digits.slice(4)}`;
    } else if (digits.length > 2) {
      out = `${digits.slice(0, 2)}.${digits.slice(2)}`;
    }
    return out;
  };

  const isValidDateDmy = (str) => {
    const m = /^([0-3]\d)\.([0-1]\d)\.(\d{4})$/.exec(str);
    if (!m) return false;
    const d = parseInt(m[1], 10);
    const mo = parseInt(m[2], 10);
    const y = parseInt(m[3], 10);
    if (mo < 1 || mo > 12) return false;
    if (d < 1 || d > 31) return false;
    const dt = new Date(y, mo - 1, d);
    return dt.getFullYear() === y && dt.getMonth() === mo - 1 && dt.getDate() === d;
  };

  const parseDmyToDate = (str) => {
    if (!isValidDateDmy(str)) return null;
    const [d, m, y] = str.split('.').map((v) => parseInt(v, 10));
    return new Date(y, m - 1, d);
  };

  // Dialogs states
  const [selectedDialog, setSelectedDialog] = useState(null);
  const [messageText, setMessageText] = useState('');
  const [activeChatTab, setActiveChatTab] = useState('all'); // 'all', 'active', 'closed'
  const [activeChannelFilter, setActiveChannelFilter] = useState('all'); // 'all', 'widget', 'telegram', 'whatsapp', 'vk', 'instagram', 'admin'
  const [searchQuery, setSearchQuery] = useState(''); // –ü–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –¥–∏–∞–ª–æ–≥–æ–≤
  const [activeDialogsTab, setActiveDialogsTab] = useState('chats'); // 'chats', 'analytics', 'settings'
  
  // Offline —Ä–µ–∂–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [offlineMessageCount, setOfflineMessageCount] = useState(0);
  const [showOfflineIndicator, setShowOfflineIndicator] = useState(false);
  const [openWidgetSections, setOpenWidgetSections] = useState({
    sections: false,
    styling: false,
    triggers: false
  });
  const [activeWidgetTab, setActiveWidgetTab] = useState('main'); // 'main', 'chat', 'form'
  
  // Widget states
  const [showAILabel, setShowAILabel] = useState(true);
  const [logoType, setLogoType] = useState('default'); // 'default' or 'custom'
  const [customLogo, setCustomLogo] = useState<string | null>(null);
  const [customLogoName, setCustomLogoName] = useState<string>('');
  const [aiAgentName, setAiAgentName] = useState('–ê–¥–∞–ø—Ç–æ');
  const [managerPhotoType, setManagerPhotoType] = useState('none'); // 'none' or 'add'
  const [managerPhotos, setManagerPhotos] = useState<string[]>([]);
  const [statusText, setStatusText] = useState('–û—Ç–≤–µ—á–∞–µ–º –¥–æ 3-—Ö –º–∏–Ω—É—Ç');
  const [showStatus, setShowStatus] = useState(true);
  const [welcomeMessage, setWelcomeMessage] = useState('–î–æ–±—Ä–æ–≥–æ –¥–Ω—è! –ß–µ–º –º—ã –º–æ–∂–µ–º –ø–æ–º–æ—á—å?');
  const [chatMessages, setChatMessages] = useState([
    { id: 1, text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', isUser: false, time: '–¢–æ–ª—å–∫–æ —á—Ç–æ' }
  ]);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∏–∑—É –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç
  useEffect(() => {
    if (activeSection === 'my-adapto' && chatHistoryRef.current) {
      ChatUtils.scrollToBottom(chatHistoryRef);
    }
  }, [chatHistory, activeSection]);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∏–∑—É –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ widget —á–∞—Ç
  useEffect(() => {
    if (activeSection === 'widget-dev' && widgetChatRef.current) {
      ChatUtils.scrollToBottom(widgetChatRef);
    }
  }, [chatMessages, activeSection]);

  const [formTrigger, setFormTrigger] = useState('before'); // 'never', 'before', 'during', 'timer', 'after_answer'
  const [showFormDropdown, setShowFormDropdown] = useState(false);
  const [selectedFormFields, setSelectedFormFields] = useState<string[]>([]);
  const [formFields, setFormFields] = useState([
    { id: 1, type: 'name', label: '–ò–º—è', placeholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è', required: true },
    { id: 2, type: 'email', label: '–≠–ª. –ø–æ—á—Ç–∞', placeholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É', required: true },
    { id: 3, type: 'phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω', placeholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω', required: false },
    { id: 4, type: 'company', label: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏', placeholder: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏', required: false },
    { id: 5, type: 'position', label: '–î–æ–ª–∂–Ω–æ—Å—Ç—å', placeholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–æ–ª–∂–Ω–æ—Å—Ç—å', required: false },
    { id: 6, type: 'website', label: '–í–µ–±-—Å–∞–π—Ç', placeholder: '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —Å–∞–π—Ç–∞', required: false },
    { id: 7, type: 'city', label: '–ì–æ—Ä–æ–¥', placeholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥', required: false },
    { id: 8, type: 'age', label: '–í–æ–∑—Ä–∞—Å—Ç', placeholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç', required: false }
  ]);
  const [privacyPolicyLink, setPrivacyPolicyLink] = useState('');
  const [formTitle, setFormTitle] = useState('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É');
  const [formTimerSeconds, setFormTimerSeconds] = useState(30);
  const [showForm, setShowForm] = useState(false);
  const [widgetFormData, setWidgetFormData] = useState<{[key: string]: string}>({});
  const [widgetOpenTime, setWidgetOpenTime] = useState<number | null>(null);
  const [isFormSubmitting, setIsFormSubmitting] = useState(false);
  const [policyAccepted, setPolicyAccepted] = useState(false);
  
  // Widget preview state
  const [widgetPreviewOpen, setWidgetPreviewOpen] = useState(true);
  const [widgetCurrentPage, setWidgetCurrentPage] = useState('home'); // 'home' –∏–ª–∏ 'chat'
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–ª–∞—à–∫–∏ 3 —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
  const [showHumanButton, setShowHumanButton] = useState(false);
  const [showCompletionButton, setShowCompletionButton] = useState(false);
  const [showFollowUpMessage, setShowFollowUpMessage] = useState(false);
  const [showTriggerMessage, setShowTriggerMessage] = useState(false);
  const [widgetClosedTime, setWidgetClosedTime] = useState<number | null>(null);
  const [widgetOpenedTime, setWidgetOpenedTime] = useState<number | null>(null);
  const [aiReceivedResponse, setAiReceivedResponse] = useState(false); // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º, –ø–æ–ª—É—á–∏–ª –ª–∏ –ò–ò –æ—Ç–≤–µ—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  const [triggerMessagesEnabled, setTriggerMessagesEnabled] = useState(false);
  const [triggerMessages, setTriggerMessages] = useState([
    {
      id: 1,
      timeDelay: 5,
      message: '–£ –Ω–∞—Å –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω–∞—è –∞–∫—Ü–∏—è',
      buttonText: '–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ'
    }
  ]);

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–æ–≥–æ–Ω—è—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  const [followUpMessagesEnabled, setFollowUpMessagesEnabled] = useState(false);
  const [followUpMessages, setFollowUpMessages] = useState([
    {
      id: 1,
      timeDelay: 5,
      message: '–ü—Ä–æ–¥–æ–ª–∂–∏–º –¥–∏–∞–ª–æ–≥?',
      buttonText: '–î–∞'
    }
  ]);
  
  // –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ —Ñ–æ—Ä–º—ã
  useEffect(() => {
    if (formTrigger === 'before' && widgetCurrentPage === 'chat' && !showForm) {
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã —á–∞—Ç —É—Å–ø–µ–ª –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è
      setTimeout(() => {
        setShowForm(true);
      }, 100);
    }
  }, [formTrigger, widgetCurrentPage, showForm]);
  
  useEffect(() => {
    if (formTrigger === 'timer' && widgetPreviewOpen && !widgetOpenTime) {
      setWidgetOpenTime(Date.now());
    }
  }, [formTrigger, widgetPreviewOpen, widgetOpenTime]);
  
  useEffect(() => {
    if (formTrigger === 'timer' && widgetOpenTime && !showForm) {
      const timer = setTimeout(() => {
        if (widgetCurrentPage === 'chat') {
          setShowForm(true);
        }
      }, formTimerSeconds * 1000);
      
      return () => clearTimeout(timer);
    }
  }, [formTrigger, widgetOpenTime, showForm, formTimerSeconds, widgetCurrentPage]);
  
  // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  useEffect(() => {
    if (widgetCurrentPage === 'home') {
      setShowForm(false);
    }
  }, [widgetCurrentPage]);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω–æ –ª—é–±–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫—Ä–æ–º–µ "–ù–∏–∫–æ–≥–¥–∞"
  useEffect(() => {
    if (formTrigger !== 'never') {
      // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
      setSelectedFormFields(prev => {
        if (!prev.includes('phone')) {
          return [...prev, 'phone'];
        }
        return prev;
      });
    }
  }, [formTrigger]);

  // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –≤–∏–¥–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç
  useEffect(() => {
    if (triggerMessagesEnabled && triggerMessages.length > 0 && !widgetPreviewOpen && !showTriggerMessage) {
      const message = triggerMessages[0];
      const timer = setTimeout(() => {
        setShowTriggerMessage(true);
      }, message.timeDelay * 1000);
      return () => clearTimeout(timer);
    }
    // –ï—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é –ø–ª–∞—à–∫—É
    if (widgetPreviewOpen && showTriggerMessage) {
      setShowTriggerMessage(false);
    }
  }, [triggerMessagesEnabled, triggerMessages, widgetPreviewOpen, showTriggerMessage]);

  // –õ–æ–≥–∏–∫–∞ –¥–ª—è –¥–æ–≥–æ–Ω—è—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  useEffect(() => {
    if (followUpMessagesEnabled && followUpMessages.length > 0 && widgetClosedTime && !showFollowUpMessage && !aiReceivedResponse) {
      const message = followUpMessages[0]; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const timer = setTimeout(() => {
        setShowFollowUpMessage(true);
      }, message.timeDelay * 1000);
      
      return () => clearTimeout(timer);
    }
  }, [followUpMessagesEnabled, followUpMessages, widgetClosedTime, showFollowUpMessage, aiReceivedResponse]);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–∏–¥–∂–µ—Ç–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  useEffect(() => {
    const loadWidgetSettings = async () => {
      if (!currentUser?.id) return;

      try {
        console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUser.id);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ supabaseClient (–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏)
        const { widgetDevelopmentSettings: widgetDevAPI } = await import('./supabaseClient.js');
        const savedSettings = await widgetDevAPI.getWidgetDevelopmentSettings(currentUser.id);
        
        if (savedSettings) {
          console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ë–î:', savedSettings);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ widgetDevelopmentSettings –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î
          setWidgetSettings(prevSettings => ({
            ...prevSettings,
            // –†–ê–ó–î–ï–õ–´ –í–ò–î–ñ–ï–¢–ê - –ì–ª–∞–≤–Ω–∞—è
            accentColor: savedSettings.accent_color || prevSettings.accentColor,
            buttonColor: savedSettings.button_color || prevSettings.buttonColor,
            buttonText: savedSettings.button_text || prevSettings.buttonText,
            buttonSubtext: savedSettings.button_subtext || prevSettings.buttonSubtext,
            avatar: savedSettings.avatar || prevSettings.avatar,
            customButtonColor: savedSettings.custom_button_color || prevSettings.customButtonColor,
            widgetLocation: savedSettings.widget_location || prevSettings.widgetLocation,
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            desktopBottomOffset: savedSettings.desktop_bottom_offset || prevSettings.desktopBottomOffset,
            desktopRightOffset: savedSettings.desktop_right_offset || prevSettings.desktopRightOffset,
            mobileBottomOffset: savedSettings.mobile_bottom_offset || prevSettings.mobileBottomOffset,
            mobileRightOffset: savedSettings.mobile_right_offset || prevSettings.mobileRightOffset,
            zIndex: savedSettings.z_index || prevSettings.zIndex,
            
            // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            welcomeMessages: savedSettings.welcome_messages || prevSettings.welcomeMessages,
            
            // –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            triggerQuestion: savedSettings.trigger_question || prevSettings.triggerQuestion,
            triggerQuestionEnabled: savedSettings.trigger_question_enabled || prevSettings.triggerQuestionEnabled,
            triggerQuestionDelay: savedSettings.trigger_question_delay || prevSettings.triggerQuestionDelay,
            triggerQuestionText: savedSettings.trigger_question_text || prevSettings.triggerQuestionText,
            triggerQuickReply: savedSettings.trigger_quick_reply || prevSettings.triggerQuickReply,
            
            // –î–æ–≥–æ–Ω—è—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            followUpMessage: savedSettings.follow_up_message || prevSettings.followUpMessage,
            followUpDelay: savedSettings.follow_up_delay || prevSettings.followUpDelay,
            followUpQuestion: savedSettings.follow_up_question || prevSettings.followUpQuestion,
            followUpQuickReply: savedSettings.follow_up_quick_reply || prevSettings.followUpQuickReply,
            
            // –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
            quickReplies: savedSettings.quick_replies || prevSettings.quickReplies,
            
            // –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
            privacyPolicyUrl: savedSettings.privacy_policy_url || prevSettings.privacyPolicyUrl,
            
            // –¢–µ–≥–∏ –¥–∞–Ω–Ω—ã—Ö
            dataTags: savedSettings.data_tags || prevSettings.dataTags,
            
            // –ò—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            excludedPages: savedSettings.excluded_pages || prevSettings.excludedPages,
            
            // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –≤–∏–¥–∂–µ—Ç–∞
            widgetMode: savedSettings.widget_mode || prevSettings.widgetMode,
            
            // –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            quickQuestions: savedSettings.quick_questions || prevSettings.quickQuestions,
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º—ã –∑–∞—è–≤–∫–∏
            leadFormEnabled: savedSettings.lead_form_enabled || prevSettings.leadFormEnabled,
            leadFormTitle: savedSettings.lead_form_title || prevSettings.leadFormTitle,
            leadFormDescription: savedSettings.lead_form_description || prevSettings.leadFormDescription,
            leadFormFields: savedSettings.lead_form_fields || prevSettings.leadFormFields,
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞
            widgetTheme: savedSettings.widget_theme || prevSettings.widgetTheme,
            widgetSize: savedSettings.widget_size || prevSettings.widgetSize,
            showAvatar: savedSettings.show_avatar !== undefined ? savedSettings.show_avatar : prevSettings.showAvatar,
            showTypingIndicator: savedSettings.show_typing_indicator !== undefined ? savedSettings.show_typing_indicator : prevSettings.showTypingIndicator,
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏
            escalationEnabled: savedSettings.escalation_enabled !== undefined ? savedSettings.escalation_enabled : prevSettings.escalationEnabled,
            escalationButtonText: savedSettings.escalation_button_text || prevSettings.escalationButtonText,
            escalationMessage: savedSettings.escalation_message || prevSettings.escalationMessage,
            escalationAutoAssign: savedSettings.escalation_auto_assign !== undefined ? savedSettings.escalation_auto_assign : prevSettings.escalationAutoAssign,
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è
            autoOpenOnScroll: savedSettings.auto_open_on_scroll !== undefined ? savedSettings.auto_open_on_scroll : prevSettings.autoOpenOnScroll,
            autoOpenDelay: savedSettings.auto_open_delay || prevSettings.autoOpenDelay,
            showOnMobile: savedSettings.show_on_mobile !== undefined ? savedSettings.show_on_mobile : prevSettings.showOnMobile,
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            notificationSound: savedSettings.notification_sound !== undefined ? savedSettings.notification_sound : prevSettings.notificationSound,
            notificationTitle: savedSettings.notification_title || prevSettings.notificationTitle,
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
            trackEvents: savedSettings.track_events !== undefined ? savedSettings.track_events : prevSettings.trackEvents,
            trackConversions: savedSettings.track_conversions !== undefined ? savedSettings.track_conversions : prevSettings.trackConversions,
            
            // –õ–æ–≥–æ—Ç–∏–ø
            logoUrl: savedSettings.logo_url || prevSettings.logoUrl,
            logoName: savedSettings.logo_name || prevSettings.logoName,
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            suggestions: savedSettings.suggestions || prevSettings.suggestions
          }));
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
          if (savedSettings.ai_agent_name) setAiAgentName(savedSettings.ai_agent_name);
          if (savedSettings.show_ai_label !== undefined) setShowAILabel(savedSettings.show_ai_label);
          if (savedSettings.logo_type) setLogoType(savedSettings.logo_type);
          if (savedSettings.custom_logo) setCustomLogo(savedSettings.custom_logo);
          if (savedSettings.custom_logo_name) setCustomLogoName(savedSettings.custom_logo_name);
          if (savedSettings.widget_title) setWidgetTitle(savedSettings.widget_title);
          if (savedSettings.widget_description) setWidgetDescription(savedSettings.widget_description);
          if (savedSettings.questions) setQuestions(savedSettings.questions);
          if (savedSettings.button_title) setButtonTitle(savedSettings.button_title);
          if (savedSettings.button_description) setButtonDescription(savedSettings.button_description);
          
          // –†–ê–ó–î–ï–õ–´ –í–ò–î–ñ–ï–¢–ê - –ß–∞—Ç
          if (savedSettings.manager_photo_type) setManagerPhotoType(savedSettings.manager_photo_type);
          if (savedSettings.manager_photos) setManagerPhotos(savedSettings.manager_photos);
          if (savedSettings.status_text) setStatusText(savedSettings.status_text);
          if (savedSettings.show_status !== undefined) setShowStatus(savedSettings.show_status);
          if (savedSettings.welcome_message) setWelcomeMessage(savedSettings.welcome_message);
          
          // –†–ê–ó–î–ï–õ–´ –í–ò–î–ñ–ï–¢–ê - –§–æ—Ä–º–∞
          if (savedSettings.form_trigger) setFormTrigger(savedSettings.form_trigger);
          if (savedSettings.form_timer_seconds) setFormTimerSeconds(savedSettings.form_timer_seconds);
          if (savedSettings.form_fields) setFormFields(savedSettings.form_fields);
          if (savedSettings.selected_form_fields) setSelectedFormFields(savedSettings.selected_form_fields);
          if (savedSettings.form_title) setFormTitle(savedSettings.form_title);
          if (savedSettings.privacy_policy_link) setPrivacyPolicyLink(savedSettings.privacy_policy_link);
          
          // –°–¢–ò–õ–ò–ó–ê–¶–ò–Ø –í–ò–î–ñ–ï–¢–ê
          if (savedSettings.widget_theme) setWidgetTheme(savedSettings.widget_theme);
          if (savedSettings.background_color) setBackgroundColor(savedSettings.background_color);
          if (savedSettings.selected_gradient !== undefined) setSelectedGradient(savedSettings.selected_gradient);
          if (savedSettings.accent_color) setAccentColor(savedSettings.accent_color);
          if (savedSettings.button_color) setButtonColor(savedSettings.button_color);
          if (savedSettings.desktop_bottom_offset) setDesktopBottomOffset(savedSettings.desktop_bottom_offset);
          if (savedSettings.desktop_right_offset) setDesktopRightOffset(savedSettings.desktop_right_offset);
          if (savedSettings.mobile_bottom_offset) setMobileBottomOffset(savedSettings.mobile_bottom_offset);
          if (savedSettings.mobile_right_offset) setMobileRightOffset(savedSettings.mobile_right_offset);
          
          // –ë–´–°–¢–†–´–ï –û–¢–í–ï–¢–´ –ò –¢–†–ò–ì–ì–ï–†–´
          if (savedSettings.trigger_messages_enabled !== undefined) setTriggerMessagesEnabled(savedSettings.trigger_messages_enabled);
          if (savedSettings.trigger_messages) setTriggerMessages(savedSettings.trigger_messages);
          if (savedSettings.follow_up_messages) setFollowUpMessages(savedSettings.follow_up_messages);
          if (savedSettings.quick_replies) setWidgetSettings(prev => ({...prev, quickReplies: savedSettings.quick_replies}));
          
          console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        } else {
          console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ë–î, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–∏–¥–∂–µ—Ç–∞:', error);
      }
    };

    loadWidgetSettings();
  }, [currentUser?.id]);
  
  // Styling states
  const [widgetTheme, setWidgetTheme] = useState('white'); // 'white' or 'dark'
  const [backgroundColor, setBackgroundColor] = useState('linear-gradient(30deg, #52AEFF 0%, #096EFD 100%)');
  const [accentColor, setAccentColor] = useState('#0084FF');
  const [buttonColor, setButtonColor] = useState('#0084FF');
  
  // Escalation settings
  const [escalationEnabled, setEscalationEnabled] = useState(true);
  const [escalationButtonText, setEscalationButtonText] = useState('–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º');
  const [escalationMessage, setEscalationMessage] = useState('–í–∞—à –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä—É. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞.');
  const [escalationAutoAssign, setEscalationAutoAssign] = useState(true);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–∫—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
  useEffect(() => {
    document.documentElement.style.setProperty('--accent-color', accentColor);
  }, [accentColor]);
  const [selectedGradient, setSelectedGradient] = useState(1);
  const [showColorPicker, setShowColorPicker] = useState({
    background: false,
    accent: false,
    button: false
  });
  const [hue, setHue] = useState(0);
  const [saturation, setSaturation] = useState(100);
  const [lightness, setLightness] = useState(50);
  const [desktopBottomOffset, setDesktopBottomOffset] = useState(20);
  const [desktopRightOffset, setDesktopRightOffset] = useState(20);
  const [mobileBottomOffset, setMobileBottomOffset] = useState(20);
  const [mobileRightOffset, setMobileRightOffset] = useState(20);
  const [widgetTitle, setWidgetTitle] = useState('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã –ß–µ–º –º—ã –º–æ–∂–µ–º –ø–æ–º–æ—á—å?');

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
  const [selectedCompletionButton, setSelectedCompletionButton] = useState('üëç –≠—Ç–æ –ø–æ–º–æ–≥–ª–æ');
  const [selectedHumanButton, setSelectedHumanButton] = useState('–ü–æ–ª—É—á–∏—Ç—å –¥–æ–ø. –ø–æ–º–æ—â—å');

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
  const addTriggerMessage = () => {
    const newId = Math.max(...triggerMessages.map(m => m.id), 0) + 1;
    setTriggerMessages([...triggerMessages, {
      id: newId,
      timeDelay: 5,
      message: '–£ –Ω–∞—Å –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω–∞—è –∞–∫—Ü–∏—è',
      buttonText: '–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ'
    }]);
  };

  const removeTriggerMessage = (id: number) => {
    setTriggerMessages(triggerMessages.filter(m => m.id !== id));
  };

  const updateTriggerMessage = (id: number, field: string, value: any) => {
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ (–º–∞–∫—Å–∏–º—É–º 15 —Å–ª–æ–≤)
    if (field === 'message' && typeof value === 'string') {
      const words = value.trim().split(/\s+/);
      if (words.length > 15) {
        value = words.slice(0, 15).join(' ');
      }
    }
    
    setTriggerMessages(triggerMessages.map(m => 
      m.id === id ? { ...m, [field]: value } : m
    ));
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–≥–æ–Ω—è—é—â–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
  const addFollowUpMessage = () => {
    const newId = Math.max(...followUpMessages.map(m => m.id), 0) + 1;
    setFollowUpMessages([...followUpMessages, {
      id: newId,
      timeDelay: 5,
      message: '–ü—Ä–æ–¥–æ–ª–∂–∏–º –¥–∏–∞–ª–æ–≥?',
      buttonText: '–î–∞–≤–∞–π'
    }]);
  };

  const removeFollowUpMessage = (id: number) => {
    setFollowUpMessages(followUpMessages.filter(m => m.id !== id));
  };

  const updateFollowUpMessage = (id: number, field: string, value: any) => {
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ (–º–∞–∫—Å–∏–º—É–º 15 —Å–ª–æ–≤)
    if (field === 'message' && typeof value === 'string') {
      const words = value.trim().split(/\s+/);
      if (words.length > 15) {
        value = words.slice(0, 15).join(' ');
      }
    }
    
    setFollowUpMessages(followUpMessages.map(m => 
      m.id === id ? { ...m, [field]: value } : m
    ));
  };

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–ª–∏—Ç—Ä—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏ (–æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –ª—É—á—à–µ–≥–æ UX)
  // useEffect(() => {
  //   const handleClickOutside = (event: MouseEvent) => {
  //     const target = event.target as HTMLElement;
  //     // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –ø–æ –ø–∞–ª–∏—Ç—Ä–µ –∏ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–ª–∏—Ç—Ä—ã
  //     if (!target.closest('.color-picker-container') && 
  //         !target.closest('.color-picker-button') &&
  //         !target.closest('.color-picker-preview')) {
  //       setShowColorPicker({
  //         background: false,
  //         accent: false,
  //         button: false
  //       });
  //     }
  //   };

  //   document.addEventListener('click', handleClickOutside);
  //   return () => {
  //     document.removeEventListener('click', handleClickOutside);
  //   };
  // }, []);
  const [widgetDescription, setWidgetDescription] = useState('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤ —á–∞—Ç–µ —Å–≤–æ–π');
  const [buttonTitle, setButtonTitle] = useState('–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
  const [buttonDescription, setButtonDescription] = useState('–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã, –º—ã –≤—Å–µ–≥–¥–∞ –ø–æ–º–æ–∂–µ–º');
  const [questions, setQuestions] = useState([
    { id: 1, text: '–ö–∞–∫–æ–π —É –≤–∞—Å —Ç–∞—Ä–∏—Ñ?', enabled: true },
    { id: 2, text: '–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é?', enabled: true },
    { id: 3, text: '–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∞?', enabled: true }
  ]);
  // API key –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ –≤–∏–¥–∂–µ—Ç–∞
  const [widgetApiKey, setWidgetApiKey] = useState<string | null>(null);
  const [showDeleteQuestionModal, setShowDeleteQuestionModal] = useState(false);
  const [questionToDelete, setQuestionToDelete] = useState<number | null>(null);

  // Widget functions
  const toggleQuestionEnabled = (questionId: number) => {
    setQuestions(prev => prev.map(q => 
      q.id === questionId ? { ...q, enabled: !q.enabled } : q
    ));
  };

  // –ó–∞–≥—Ä—É–∂–∞–µ–º/—Å–æ–∑–¥–∞—ë–º apiKey –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  useEffect(() => {
    const fetchApiKey = async () => {
      try {
        if (!currentUser?.id) { setWidgetApiKey(null); return; }
        const res = await fetch(`${API_CONFIG.BASE_URL}/api/widget/key?userId=${currentUser.id}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to get api key');
        const data = await res.json();
        if (data?.apiKey) setWidgetApiKey(data.apiKey as string);
      } catch (e) {
        console.warn('Failed to fetch widget api key', e);
      }
    };
    fetchApiKey();
  }, [currentUser?.id]);


  const handleCopyScript = async () => {
    try {
      const script = generateWidgetCode();
      await navigator.clipboard.writeText(script);
      setShowScriptModal(true);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞');
    }
  };

  const saveWidgetSettings = async () => {
    console.log('=== –ù–ê–ß–ê–õ–û –°–û–•–†–ê–ù–ï–ù–ò–Ø –í–ò–î–ñ–ï–¢–ê ===');
    console.log('currentUser:', currentUser);
    console.log('widgetApiKey:', widgetApiKey);
    console.log('formTrigger:', formTrigger);
    console.log('formTitle:', formTitle);
    console.log('selectedFormFields:', selectedFormFields);
    
    if (!currentUser?.id) {
      console.log('–û–®–ò–ë–ö–ê: –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
      showNotificationMessage('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
      return;
    }

    try {
      console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...');
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î —Å –í–°–ï–ú–ò –ø–æ–ª—è–º–∏ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      const widgetData = {
        // –†–ê–ó–î–ï–õ–´ –í–ò–î–ñ–ï–¢–ê - –ì–ª–∞–≤–Ω–∞—è
        ai_agent_name: aiAgentName,
        show_ai_label: showAILabel,
        logo_type: logoType,
        custom_logo: customLogo,
        custom_logo_name: customLogoName,
        widget_title: widgetTitle,
        widget_description: widgetDescription,
        questions: questions,
        button_title: buttonTitle,
        button_description: buttonDescription,
        
        // –†–ê–ó–î–ï–õ–´ –í–ò–î–ñ–ï–¢–ê - –ß–∞—Ç
        manager_photo_type: managerPhotoType,
        manager_photos: managerPhotos,
        status_text: statusText,
        show_status: showStatus,
        welcome_message: welcomeMessage,
        
        // –†–ê–ó–î–ï–õ–´ –í–ò–î–ñ–ï–¢–ê - –§–æ—Ä–º–∞
        form_trigger: formTrigger,
        form_timer_seconds: formTimerSeconds,
        form_fields: formFields,
        selected_form_fields: selectedFormFields,
        form_title: formTitle,
        privacy_policy_link: privacyPolicyLink,
        
        // –°–¢–ò–õ–ò–ó–ê–¶–ò–Ø –í–ò–î–ñ–ï–¢–ê
        widget_theme: widgetTheme,
        background_color: backgroundColor,
        selected_gradient: selectedGradient,
        accent_color: accentColor,
        
        // –ù–ê–°–¢–†–û–ô–ö–ò –≠–°–ö–ê–õ–ê–¶–ò–ò
        escalation_enabled: escalationEnabled,
        escalation_button_text: escalationButtonText,
        escalation_message: escalationMessage,
        escalation_auto_assign: escalationAutoAssign,
        button_color: buttonColor,
        desktop_bottom_offset: desktopBottomOffset,
        desktop_right_offset: desktopRightOffset,
        mobile_bottom_offset: mobileBottomOffset,
        mobile_right_offset: mobileRightOffset,
        
        // –ë–´–°–¢–†–´–ï –û–¢–í–ï–¢–´ –ò –¢–†–ò–ì–ì–ï–†–´
        trigger_messages_enabled: triggerMessagesEnabled,
        trigger_messages: triggerMessages,
        follow_up_messages: followUpMessages,
        quick_replies: widgetDevelopmentSettings.quickReplies
      };

      console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', widgetData);
      console.log('user_id:', currentUser.id);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ apiKey –Ω–∞ backend (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞)
      const key = widgetApiKey || (currentUser?.id ? `adapto_${currentUser.id}` : 'adapto_demo');
      console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º API –∫–ª—é—á:', key);
      
      const res = await fetch('${API_CONFIG.BASE_URL}/api/widget/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key, settings: {
          accentColor,
          buttonColor,
          widgetTheme,
          backgroundColor,
          selectedGradient,
          logoType,
          customLogo,
          customLogoName,
          aiAgentName,
          title: widgetTitle,
          description: widgetDescription,
          buttonTitle,
          buttonDescription,
          managerPhotoType,
          managerPhotos,
          statusText,
          showStatus,
          showAILabel,
          questions,
          showCompletionButton,
          selectedCompletionButton,
          showHumanButton,
          selectedHumanButton,
          formTrigger,
          formTitle,
          formTimerSeconds,
          selectedFormFields,
          formFields,
          privacyPolicyLink,
          desktopBottomOffset,
          desktopRightOffset,
          mobileBottomOffset,
          mobileRightOffset,
          triggerMessagesEnabled,
          triggerMessages,
          followUpMessagesEnabled,
          followUpMessages,
          quickReplies: widgetDevelopmentSettings.quickReplies,
          zIndex: widgetDevelopmentSettings.zIndex
        }})
      });
      
      if (!res.ok) {
        const responseText = await res.text();
        console.log('–û—Ç–≤–µ—Ç –æ—Ç API /api/widget/save:', res.status, responseText);
        throw new Error('Save failed: ' + responseText);
      }
      
      const responseText = await res.text();
      console.log('–û—Ç–≤–µ—Ç –æ—Ç API /api/widget/save:', res.status, responseText);
      
      // –î—É–±–ª–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Supabase, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ F5 —Ä–∞–∑–¥–µ–ª ¬´–≤–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç¬ª –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è
      try {
        const { widgetDevelopmentSettings: widgetDevAPI } = await import('./supabaseClient.js');
        await widgetDevAPI.saveWidgetDevelopmentSettings(currentUser.id, {
          ai_agent_name: aiAgentName,
          show_ai_label: showAILabel,
          logo_type: logoType,
          custom_logo: customLogo,
          custom_logo_name: customLogoName,
          widget_title: widgetTitle,
          widget_description: widgetDescription,
          questions,
          button_title: buttonTitle,
          button_description: buttonDescription,
          manager_photo_type: managerPhotoType,
          manager_photos: managerPhotos,
          status_text: statusText,
          show_status: showStatus,
          welcome_message: welcomeMessage,
          form_trigger: formTrigger,
          form_timer_seconds: formTimerSeconds,
          form_fields: formFields,
          selected_form_fields: selectedFormFields,
          form_title: formTitle,
          privacy_policy_link: privacyPolicyLink,
          widget_theme: widgetTheme,
          background_color: backgroundColor,
          selected_gradient: selectedGradient,
          accent_color: accentColor,
          button_color: buttonColor,
          desktop_bottom_offset: desktopBottomOffset,
          desktop_right_offset: desktopRightOffset,
          mobile_bottom_offset: mobileBottomOffset,
          mobile_right_offset: mobileRightOffset,
          trigger_messages_enabled: triggerMessagesEnabled,
          trigger_messages: triggerMessages,
          follow_up_messages: followUpMessages,
          quick_replies: widgetDevelopmentSettings.quickReplies,
          z_index: widgetDevelopmentSettings.zIndex,
          // –õ–æ–≥–æ—Ç–∏–ø
          logo_url: widgetDevelopmentSettings.logoUrl || '',
          logo_name: widgetDevelopmentSettings.logoName || ''
        });
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Supabase (UI —Ä–∞–∑–¥–µ–ª):', e);
      }
      showNotificationMessage('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
      setHasUnsavedChanges(false);

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
      showNotificationMessage(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ${error.message}`);
    }
    
    console.log('=== –ö–û–ù–ï–¶ –°–û–•–†–ê–ù–ï–ù–ò–Ø –í–ò–î–ñ–ï–¢–ê ===');
  };

  const deleteQuestion = (questionId: number) => {
    setQuestions(prev => prev.filter(q => q.id !== questionId));
    setShowDeleteQuestionModal(false);
    setQuestionToDelete(null);
  };

  const addQuestion = () => {
    if (questions.length >= 4) {
      showNotificationMessage('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤: 4');
      return;
    }
    const newId = Math.max(...questions.map(q => q.id)) + 1;
    setQuestions(prev => [...prev, { id: newId, text: '–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å', enabled: true }]);
  };

  const updateQuestionText = (questionId: number, newText: string) => {
    setQuestions(prev => prev.map(q =>
      q.id === questionId ? { ...q, text: newText } : q
    ));
  };

  // Logo upload handler
  const handleLogoUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        setCustomLogo(e.target?.result as string);
        setCustomLogoName(file.name);
      };
      reader.readAsDataURL(file);
    }
  };

  // Form functions
  const toggleFormField = (fieldType: string) => {
    setSelectedFormFields(prev => {
      if (prev.includes(fieldType)) {
        return prev.filter(type => type !== fieldType);
      } else if (prev.length < 4) {
        return [...prev, fieldType];
      }
      return prev;
    });
  };

  const updateFormFieldPlaceholder = (fieldId: number, newPlaceholder: string) => {
    setFormFields(prev => prev.map(field =>
      field.id === fieldId ? { ...field, placeholder: newPlaceholder } : field
    ));
  };

  const toggleFormFieldRequired = (fieldId: number) => {
    setFormFields(prev => prev.map(field =>
      field.id === fieldId ? { ...field, required: !field.required } : field
    ));
  };

  const validateUrl = (url: string) => {
    try {
      new URL(url);
      return false; // false –æ–∑–Ω–∞—á–∞–µ—Ç "–ù–ï–¢ –æ—à–∏–±–∫–∏" (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL)
    } catch {
      return '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É'; // —Å—Ç—Ä–æ–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç "–ï–°–¢–¨ –æ—à–∏–±–∫–∞" (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL)
    }
  };

  // Styling functions
  const openColorPicker = (type: 'background' | 'accent' | 'button') => {
    // Close all other pickers
    setShowColorPicker({
      background: false,
      accent: false,
      button: false
    });
    
    // Get current color and convert to HSL
    let currentColor = '#0084FF';
    switch (type) {
      case 'background':
        currentColor = backgroundColor.includes('gradient') ? '#0084FF' : backgroundColor;
        break;
      case 'accent':
        currentColor = accentColor;
        break;
      case 'button':
        currentColor = buttonColor;
        break;
    }
    
    // Convert hex to HSL
    const hex = currentColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16) / 255;
    const g = parseInt(hex.substr(2, 2), 16) / 255;
    const b = parseInt(hex.substr(4, 2), 16) / 255;
    
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    let h = 0, s = 0, l = (max + min) / 2;
    
    if (max !== min) {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
        case g: h = (b - r) / d + 2; break;
        case b: h = (r - g) / d + 4; break;
      }
      h /= 6;
    }
    
    setHue(Math.round(h * 360));
    setSaturation(Math.round(s * 100));
    setLightness(Math.round(l * 100));
    
    // Open the specific picker
    setShowColorPicker(prev => ({
      ...prev,
      [type]: true
    }));
  };

  const hslToHex = (h: number, s: number, l: number) => {
    l /= 100;
    const a = s * Math.min(l, 1 - l) / 100;
    const f = (n: number) => {
      const k = (n + h / 30) % 12;
      const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
      return Math.round(255 * color).toString(16).padStart(2, '0');
    };
    return `#${f(0)}${f(8)}${f(4)}`;
  };

  const handleColorChange = (color: string, type: 'background' | 'accent' | 'button') => {
    switch (type) {
      case 'background':
        setBackgroundColor(color);
        setSelectedGradient(0); // Reset gradient when solid color is chosen
        break;
      case 'accent':
        setAccentColor(color);
        break;
      case 'button':
        setButtonColor(color);
        break;
    }
    // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä–æ–µ—Ç –µ—ë –∫—Ä–µ—Å—Ç–∏–∫–æ–º
    // setShowColorPicker(prev => ({
    //   ...prev,
    //   [type]: false
    // }));
  };

  const handleHSLChange = (newHue: number, newSaturation: number, newLightness: number, type: 'background' | 'accent' | 'button') => {
    setHue(newHue);
    setSaturation(newSaturation);
    setLightness(newLightness);
    
    const hexColor = hslToHex(newHue, newSaturation, newLightness);
    handleColorChange(hexColor, type);
  };

  const selectGradient = (gradientNumber: number) => {
    setSelectedGradient(gradientNumber);
    // Set background color based on gradient
    const gradientColors = [
      '#FFFFFF', // Default white
      'linear-gradient(30deg, #52AEFF 0%, #096EFD 100%)',
      'linear-gradient(30deg, #39E978 0%, #2A7344 100%)',
      'linear-gradient(30deg, #4C4C4C 0%, #282828 100%)',
      'linear-gradient(30deg, #D12020 0%, #8A2626 100%)',
      'linear-gradient(30deg, #D15820 0%, #8A4B26 100%)',
      'linear-gradient(30deg, #FDAB54 0%, #FA7F89 100%)',
      'linear-gradient(30deg, #A41AE8 0%, #60268A 100%)',
      'linear-gradient(30deg, #DAC887 0%, #EDAA24 100%)',
      'linear-gradient(30deg, #5675FF 0%, #1749BD 100%)',
      'linear-gradient(30deg, #28BCEE 0%, #27B0C2 100%)'
    ];
    setBackgroundColor(gradientColors[gradientNumber] || '#FFFFFF');
  };

  // Simple function to get hue from hex color
  const getHueFromColor = (hexColor: string) => {
    const hex = hexColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16) / 255;
    const g = parseInt(hex.substr(2, 2), 16) / 255;
    const b = parseInt(hex.substr(4, 2), 16) / 255;
    
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    let h = 0;
    
    if (max !== min) {
      const d = max - min;
      switch (max) {
        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
        case g: h = (b - r) / d + 2; break;
        case b: h = (r - g) / d + 4; break;
      }
      h /= 6;
    }
    
    return Math.round(h * 360);
  };

  // Convert HEX color to CSS filter for SVG icons
  const getColorFilter = (hexColor: string) => {
    // Convert hex to RGB
    const hex = hexColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16) / 255;
    const g = parseInt(hex.substr(2, 2), 16) / 255;
    const b = parseInt(hex.substr(4, 2), 16) / 255;
    
    // Convert RGB to HSL
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;
    
    if (max === min) {
      h = s = 0;
    } else {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
        case g: h = (b - r) / d + 2; break;
        case b: h = (r - g) / d + 4; break;
      }
      h /= 6;
    }
    
    // Convert to CSS filter values
    const hue = Math.round(h * 360);
    const saturation = Math.round(s * 100);
    const lightness = Math.round(l * 100);
    
    // Improved filter calculation for better color accuracy
    const brightness = Math.round(100 + (lightness - 50) * 1.2);
    const contrast = Math.round(100 + (saturation - 50) * 0.5);
    
    return `invert(0%) sepia(100%) saturate(${Math.max(200, saturation * 3)}%) hue-rotate(${hue}deg) brightness(${brightness}%) contrast(${contrast}%)`;
  };

  const renderColorPicker = (type: 'background' | 'accent' | 'button') => {
    if (!showColorPicker[type]) return null;

    return (
      <div className={`color-picker-container absolute left-0 right-0 bg-white border border-[#070F1A]/10 rounded-[10px] shadow-lg z-[9999] p-[10px] w-[200px] bottom-full mb-1`}>
        {/* –ö—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è - —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É –æ—Ç –ø–∞–ª–∏—Ç—Ä—ã */}
        <div className="absolute -top-2 w-6 h-6 cursor-pointer z-[10001] bg-white rounded-full flex items-center justify-center hover:bg-gray-100 transition-colors shadow-md border border-gray-200" style={{ left: '190px' }} onClick={(e) => {
          e.preventDefault();
          e.stopPropagation();
          setShowColorPicker({
            background: false,
            accent: false,
            button: false
          });
        }}>
          <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
            <path d="M12 4L4 12M4 4L12 12" stroke="#8E8E93" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        </div>
        {/* Saturation/Lightness Area */}
        <div className="w-full pb-[75%] relative overflow-hidden mb-2">
          <div 
            className="absolute inset-0 cursor-crosshair"
            style={{ backgroundColor: `hsl(${hue}, 100%, 50%)` }}
            onMouseDown={(e) => {
              e.preventDefault();
              e.stopPropagation();
              const rect = e.currentTarget.getBoundingClientRect();
              const x = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
              const y = Math.max(0, Math.min(100, ((e.clientY - rect.top) / rect.height) * 100));
              handleHSLChange(hue, x, 100 - y, type);
              
              const handleMouseMove = (moveEvent: MouseEvent) => {
                const x = Math.max(0, Math.min(100, ((moveEvent.clientX - rect.left) / rect.width) * 100));
                const y = Math.max(0, Math.min(100, ((moveEvent.clientY - rect.top) / rect.height) * 100));
                handleHSLChange(hue, x, 100 - y, type);
              };
              
              const handleMouseUp = () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };
              
              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            }}
          >
            <div 
              className="absolute inset-0"
              style={{ background: 'linear-gradient(to right, #fff, rgba(255,255,255,0))' }}
            >
              <div 
                className="absolute inset-0"
                style={{ background: 'linear-gradient(to top, #000, rgba(0,0,0,0))' }}
              >
                <div 
                  className="absolute w-2 h-2 rounded-[90px] border-2 border-white shadow-lg pointer-events-none"
                  style={{ 
                    top: `${100 - lightness}%`, 
                    left: `${saturation}%`,
                    transform: 'translate(-4px, -4px)'
                  }}
                />
              </div>
            </div>
          </div>
        </div>
        
        {/* Hue Slider */}
        <div className="relative h-[10px] overflow-hidden mb-2">
          <div 
            className="absolute inset-0 cursor-crosshair"
            style={{ 
              background: 'linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%)'
            }}
            onMouseDown={(e) => {
              e.preventDefault();
              e.stopPropagation();
              const rect = e.currentTarget.getBoundingClientRect();
              const x = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
              handleHSLChange(x * 3.6, saturation, lightness, type);
              
              const handleMouseMove = (moveEvent: MouseEvent) => {
                const x = Math.max(0, Math.min(100, ((moveEvent.clientX - rect.left) / rect.width) * 100));
                handleHSLChange(x * 3.6, saturation, lightness, type);
              };
              
              const handleMouseUp = () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
              };
              
              document.addEventListener('mousemove', handleMouseMove);
              document.addEventListener('mouseup', handleMouseUp);
            }}
          >
            <div 
              className="absolute w-1 h-2 bg-white rounded-sm shadow-md pointer-events-none"
              style={{ 
                left: `${(hue / 360) * 100}%`,
                transform: 'translateX(-2px)',
                marginTop: '1px'
              }}
            ></div>
          </div>
        </div>
        
        {/* Color Inputs */}
        <div className="flex gap-1 mb-2">
          <div className="flex-1">
            <input
              type="text"
              value={hslToHex(hue, saturation, lightness).toUpperCase()}
              readOnly
              className="w-full text-[11px] p-1 border border-gray-300 rounded text-center"
            />
            <label className="block text-[11px] text-center text-gray-600 mt-1">HEX</label>
          </div>
          <div className="flex-1">
            <input
              type="number"
              value={Math.round(hue)}
              onChange={(e) => handleHSLChange(Number(e.target.value), saturation, lightness, type)}
              className="w-full text-[11px] p-1 border border-gray-300 rounded text-center"
            />
            <label className="block text-[11px] text-center text-gray-600 mt-1">H</label>
          </div>
          <div className="flex-1">
            <input
              type="number"
              value={Math.round(saturation)}
              onChange={(e) => handleHSLChange(hue, Number(e.target.value), lightness, type)}
              className="w-full text-[11px] p-1 border border-gray-300 rounded text-center"
            />
            <label className="block text-[11px] text-center text-gray-600 mt-1">S</label>
          </div>
          <div className="flex-1">
            <input
              type="number"
              value={Math.round(lightness)}
              onChange={(e) => handleHSLChange(hue, saturation, Number(e.target.value), type)}
              className="w-full text-[11px] p-1 border border-gray-300 rounded text-center"
            />
            <label className="block text-[11px] text-center text-gray-600 mt-1">L</label>
          </div>
        </div>
        
        {/* Preset Colors */}
        <div className="flex flex-wrap gap-1 pt-2 border-t border-gray-200">
          {[
            '#D0021B', '#F5A623', '#F8E71C', '#8B572A', '#7ED321', '#417505',
            '#BD10E0', '#9013FE', '#4A90E2', '#50E3C2', '#B8E986', '#000000',
            '#4A4A4A', '#9B9B9B', '#FFFFFF'
          ].map((color) => (
            <div
              key={color}
              className="w-4 h-4 rounded cursor-pointer border border-gray-300"
              style={{ backgroundColor: color }}
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                const hex = color.replace('#', '');
                const r = parseInt(hex.substr(0, 2), 16) / 255;
                const g = parseInt(hex.substr(2, 2), 16) / 255;
                const b = parseInt(hex.substr(4, 2), 16) / 255;
                
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                let h = 0, s = 0, l = (max + min) / 2;
                
                if (max !== min) {
                  const d = max - min;
                  s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                  switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                  }
                  h /= 6;
                }
                
                handleHSLChange(Math.round(h * 360), Math.round(s * 100), Math.round(l * 100), type);
              }}
            ></div>
          ))}
        </div>
      </div>
    );
  };

  // –î–∞–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–æ–≤ - –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥—É—Ç –ø—É—Å—Ç—ã–º–∏
  // –î–∞–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–æ–≤ - –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const [dialogsData, setDialogsData] = useState([]);
  
  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ –ø–æ –∫–∞–Ω–∞–ª–∞–º
  const [groupedDialogs, setGroupedDialogs] = useState({
    widget: [],
    telegram: [],
    whatsapp: [],
    vk: [],
    instagram: [],
    admin: [],
    other: []
  });

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
  const [showAutoswitchPopup, setShowAutoswitchPopup] = useState(false);
  const [autoswitchSettings, setAutoswitchSettings] = useState({
    disableOnHumanIntervention: true,
    enableAfterOperatorSwitch: false,
    switchDelayMinutes: 5
  });

  // –ü–æ–ø–∞–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
  const [showCloseDialogPopup, setShowCloseDialogPopup] = useState(false);
  const [dialogToClose, setDialogToClose] = useState(null);

  // –ü–æ–ø–∞–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
  const [showDeleteDialogPopup, setShowDeleteDialogPopup] = useState(false);
  const [dialogToDelete, setDialogToDelete] = useState(null);


  // Widget settings
  const [widgetDevelopmentSettings, setWidgetSettings] = useState({
    accentColor: '#0084FF', // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç –≤–∏–¥–∂–µ—Ç–∞
    buttonColor: 'custom', // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ü–≤–µ—Ç
    buttonText: '–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º',
    buttonSubtext: '–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
    avatar: 'default',
    customButtonColor: '#0084FF', // –°–∏–Ω–∏–π —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏
    showCustomColorPicker: false,
    widgetLocation: 'default',
    // Widget positioning
    desktopBottomOffset: 20,
    desktopRightOffset: 20,
    mobileBottomOffset: 20,
    mobileRightOffset: 20,
    zIndex: 9999,
    // Welcome message
    welcomeMessages: ['–ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç Adapto, —è –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.'],
    // Trigger question
    triggerQuestion: '–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
    triggerQuestionEnabled: 'no',
    triggerQuestionDelay: 5,
    triggerQuestionText: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ï—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è –≤–æ–ø—Ä–æ—Å, –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –µ–≥–æ –≤ —á–∞—Ç–µ, —è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –æ—Ç–≤–µ—á—É',
    triggerQuickReply: '–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
    // Follow up message
    followUpMessage: 'no',
    followUpDelay: 10,
    followUpQuestion: '–ü—Ä–æ–¥–æ–ª–∂–∏–º –¥–∏–∞–ª–æ–≥?',
    followUpQuickReply: '–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ',
    // Quick replies
    quickReplies: ['–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ'],
    privacyPolicyUrl: 'https://',
    dataTags: ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'roistat_visit', 'gclid', 'fbclid'],
    excludedPages: [],
    // –ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
    // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –≤–∏–¥–∂–µ—Ç–∞
    widgetMode: 'chat', // 'chat' –∏–ª–∏ 'questions'
    // –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã
    quickQuestions: [
      { question: '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∞—à —Å–µ—Ä–≤–∏—Å?', answer: '–ù–∞—à —Å–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ò–ò –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ–±—â–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏.' },
      { question: '–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?', answer: '–£ –Ω–∞—Å –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤. –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω —Å—Ç–æ–∏—Ç 2990‚ÇΩ –≤ –º–µ—Å—è—Ü.' },
      { question: '–ï—Å—Ç—å –ª–∏ –¥–µ–º–æ?', answer: '–î–∞, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–º–æ-–≤–µ—Ä—Å–∏—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π.' }
    ],
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º—ã –∑–∞—è–≤–∫–∏
    leadFormEnabled: 'yes',
    leadFormTitle: '–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É',
    leadFormDescription: '–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è',
    leadFormFields: [
      { name: 'name', label: '–ò–º—è', type: 'text', required: true },
      { name: 'phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'tel', required: true },
      { name: 'email', label: 'Email', type: 'email', required: false }
    ],
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞
    widgetTheme: 'light', // 'light' –∏–ª–∏ 'dark'
    widgetSize: 'medium', // 'small', 'medium', 'large'
    showAvatar: true,
    showTypingIndicator: true,
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    escalationEnabled: true,
    escalationButtonText: '–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º',
    escalationMessage: '–í–∞—à –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä—É. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞.',
    escalationAutoAssign: true,
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è
    autoOpenOnScroll: false,
    autoOpenDelay: 0,
    showOnMobile: true,
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    notificationSound: true,
    notificationTitle: '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    trackEvents: true,
    trackConversions: true,
    // –õ–æ–≥–æ—Ç–∏–ø
    logoUrl: '',
    logoName: '',
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    suggestions: [] // –º–∞—Å—Å–∏–≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
  });

  // Menu items with nested structure - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const getMenuItems = () => {
    if (isOperator) {
      // –ú–µ–Ω—é –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      return [
        { id: 'available-dialogs', label: '–î–æ—Å—Ç—É–ø–Ω—ã–µ', icon: () => <img src="/Icon inbox.svg" alt="–î–æ—Å—Ç—É–ø–Ω—ã–µ" className="w-5 h-5" /> },
        { id: 'dialogs', label: '–î–∏–∞–ª–æ–≥–∏', icon: () => <img src="/dialog.svg" alt="–î–∏–∞–ª–æ–≥–∏" className="w-5 h-5" /> },
        { id: 'crm', label: 'CRM', icon: () => <img src="/crm.svg" alt="CRM" className="w-5 h-5" /> },
        { id: 'operator-statistics', label: '–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon: () => <img src="/stat.svg" alt="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" className="w-5 h-5" /> },
        { id: 'notifications', label: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', icon: () => <img src="/Icon inbox-1.svg" alt="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" className="w-5 h-5" /> }
      ];
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const isAdmin = currentUser?.role === 'super_admin' || currentUser?.role === 'admin';
    
    if (isAdmin) {
      // –ú–µ–Ω—é –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
      return [
        { id: 'statistics', label: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon: () => <img src="/stat.svg" alt="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" className="w-5 h-5" /> },
        { id: 'dialogs', label: '–î–∏–∞–ª–æ–≥–∏', icon: () => <img src="/dialog.svg" alt="–î–∏–∞–ª–æ–≥–∏" className="w-5 h-5" /> },
        { id: 'crm', label: 'CRM', icon: () => <img src="/crm.svg" alt="CRM" className="w-5 h-5" /> },
        { 
          id: 'adapto-ai', 
          label: '–ò–ò-–∞–≥–µ–Ω—Ç', 
          icon: () => <img src="/ai.svg" alt="–ò–ò-–∞–≥–µ–Ω—Ç" className="w-5 h-5" />,
          hasSubmenu: true,
          submenu: [
            { id: 'my-adapto', label: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', icon: () => <img src="/test.svg" alt="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" className="w-4 h-4" /> },
            { id: 'model-settings', label: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏', icon: () => <img src="/set.svg" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏" className="w-4 h-4" /> },
            { id: 'model-extensions', label: '–†–∞—Å—à–∏—Ä–µ–Ω–∏—è', icon: () => <img src="/plugin.svg" alt="–†–∞—Å—à–∏—Ä–µ–Ω–∏—è" className="w-4 h-4" /> }
          ]
        },
        { id: 'knowledge', label: '–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π', icon: () => <img src="/baza.svg" alt="–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π" className="w-5 h-5" /> },
        { 
          id: 'integrations', 
          label: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏', 
          icon: () => <img src="/inegra.svg" alt="–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏" className="w-5 h-5" />,
          hasSubmenu: true,
          submenu: [
            { id: 'widget-dev', label: '–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç', icon: () => <img src="/wiget.svg" alt="–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç" className="w-4 h-4" /> },
            { id: 'messengers', label: '–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã', icon: () => <img src="/mess.svg" alt="–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã" className="w-4 h-4" /> },
            { id: 'crm-systems', label: 'CRM-—Å–∏—Å—Ç–µ–º—ã', icon: () => <img src="/crm2.svg" alt="CRM-—Å–∏—Å—Ç–µ–º—ã" className="w-4 h-4" /> },
            { id: 'other-integrations', label: '–°–µ—Ä–≤–∏—Å—ã', icon: () => <img src="/more.svg" alt="–°–µ—Ä–≤–∏—Å—ã" className="w-4 h-4" /> }
          ]
        },
        { id: 'team', label: '–ö–æ–º–∞–Ω–¥–∞', icon: () => <img src="/team.svg" alt="–ö–æ–º–∞–Ω–¥–∞" className="w-5 h-5" /> },
        { id: 'stories-management', label: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ—Ä–∏—Å', icon: () => <img src="/stories.svg" alt="–°—Ç–æ—Ä–∏—Å—ã" className="w-5 h-5" /> }
      ];
    } else {
      // –ú–µ–Ω—é –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      return [
        { id: 'statistics', label: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon: () => <img src="/stat.svg" alt="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" className="w-5 h-5" /> },
        { id: 'dialogs', label: '–î–∏–∞–ª–æ–≥–∏', icon: () => <img src="/dialog.svg" alt="–î–∏–∞–ª–æ–≥–∏" className="w-5 h-5" /> },
        { id: 'crm', label: 'CRM', icon: () => <img src="/crm.svg" alt="CRM" className="w-5 h-5" /> },
        { 
          id: 'adapto-ai', 
          label: '–ò–ò-–∞–≥–µ–Ω—Ç', 
          icon: () => <img src="/ai.svg" alt="–ò–ò-–∞–≥–µ–Ω—Ç" className="w-5 h-5" />,
          hasSubmenu: true,
          submenu: [
            { id: 'my-adapto', label: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', icon: () => <img src="/test.svg" alt="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" className="w-4 h-4" /> },
            { id: 'model-settings', label: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏', icon: () => <img src="/set.svg" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏" className="w-4 h-4" /> },
            { id: 'model-extensions', label: '–†–∞—Å—à–∏—Ä–µ–Ω–∏—è', icon: () => <img src="/plugin.svg" alt="–†–∞—Å—à–∏—Ä–µ–Ω–∏—è" className="w-4 h-4" /> }
          ]
        },
        { id: 'knowledge', label: '–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π', icon: () => <img src="/baza.svg" alt="–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π" className="w-5 h-5" /> },
        { 
          id: 'integrations', 
          label: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏', 
          icon: () => <img src="/inegra.svg" alt="–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏" className="w-5 h-5" />,
          hasSubmenu: true,
          submenu: [
            { id: 'widget-dev', label: '–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç', icon: () => <img src="/wiget.svg" alt="–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç" className="w-4 h-4" /> },
            { id: 'messengers', label: '–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã', icon: () => <img src="/mess.svg" alt="–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã" className="w-4 h-4" /> },
            { id: 'crm-systems', label: 'CRM-—Å–∏—Å—Ç–µ–º—ã', icon: () => <img src="/crm2.svg" alt="CRM-—Å–∏—Å—Ç–µ–º—ã" className="w-4 h-4" /> },
            { id: 'other-integrations', label: '–°–µ—Ä–≤–∏—Å—ã', icon: () => <img src="/more.svg" alt="–°–µ—Ä–≤–∏—Å—ã" className="w-4 h-4" /> }
          ]
        },
        { id: 'team', label: '–ö–æ–º–∞–Ω–¥–∞', icon: () => <img src="/team.svg" alt="–ö–æ–º–∞–Ω–¥–∞" className="w-5 h-5" /> },
        { id: 'operator-stats', label: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon: () => <img src="/stats.svg" alt="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" className="w-5 h-5" /> }
        // –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ù–ï –≤–∏–¥—è—Ç "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ—Ä–∏—Å"
      ];
    }
  };

  const menuItems = getMenuItems();

  // Notification function
  const showNotificationMessage = (message) => {
    setNotificationMessage(message);
    setShowNotification(true);
    setTimeout(() => setShowNotification(false), 3000);
  };

  // System notification function
  const showSystemNotificationMessage = (message) => {
    setSystemNotification(message);
    setShowSystemNotification(true);
    setTimeout(() => setShowSystemNotification(false), 4000);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const handleNavigation = (newSection) => {
    if (hasUnsavedChanges) {
      setPendingNavigation(newSection);
      setShowUnsavedChangesModal(true);
    } else {
      setActiveSection(newSection);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–æ—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
  const confirmNavigation = () => {
    if (pendingNavigation) {
      setActiveSection(pendingNavigation);
      setHasUnsavedChanges(false);
    }
    setShowUnsavedChangesModal(false);
    setPendingNavigation(null);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
  const cancelNavigation = () => {
    setShowUnsavedChangesModal(false);
    setPendingNavigation(null);
  };

  // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  const metricsData = {
    'widget-opens': {
      title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç–∏–π –≤–∏–¥–∂–µ—Ç–∞',
      description: '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ –≤–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ.',
      formula: '–°—É–º–º–∞ –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç–∏–π –≤–∏–¥–∂–µ—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç —Å –≤–∞—à–∏–º –≤–∏–¥–∂–µ—Ç–æ–º. –í—ã—Å–æ–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç–∏–π —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ö–æ—Ä–æ—à—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å –∏ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–∂–µ—Ç–∞.\n\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n‚Ä¢ –†–∞–∑–º–µ—â–∞–π—Ç–µ –≤–∏–¥–∂–µ—Ç –Ω–∞ –≤–∏–¥–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö —Å–∞–π—Ç–∞\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ –∞–Ω–∏–º–∞—Ü–∏–∏\n‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é —Ä—è–¥–æ–º —Å –≤–∏–¥–∂–µ—Ç–æ–º'
    },
    'dialog-count': {
      title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤',
      description: '–û–±—â–µ–µ —á–∏—Å–ª–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ò–ò-–∞–≥–µ–Ω—Ç–æ–º.',
      formula: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–∞—à–∏–º –ò–ò-–∞–≥–µ–Ω—Ç–æ–º. –ö–∞–∂–¥—ã–π –¥–∏–∞–ª–æ–≥ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π.\n\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ç—Ä–µ–Ω–¥—ã —Ä–æ—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–æ–≤\n‚Ä¢ –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–π –≤–∏–¥–∂–µ—Ç–∞\n‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏'
    },
    'message-count': {
      title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π',
      description: '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ò–ò-–∞–≥–µ–Ω—Ç–æ–º.',
      formula: '–°—É–º–º–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ò–ò-–∞–≥–µ–Ω—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±—â–µ–Ω–∏—è –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ. –í—ã—Å–æ–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∫–∞—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤.\n\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ò–ò-–∞–≥–µ–Ω—Ç–∞\n‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò-–∞–≥–µ–Ω—Ç–∞\n‚Ä¢ –£–ª—É—á—à–∞–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è'
    },
    'avg-messages-per-dialog': {
      title: '–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª-–≤–æ —Å–º—Å –Ω–∞ –¥–∏–∞–ª–æ–≥',
      description: '–°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ–¥–Ω–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –ò–ò-–∞–≥–µ–Ω—Ç–æ–º.',
      formula: '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π / –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª—É–±–∏–Ω—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ò–ò-–∞–≥–µ–Ω—Ç–æ–º. –í—ã—Å–æ–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ –∏ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤.\\n\\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\\n‚Ä¢ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 5-10 —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –¥–∏–∞–ª–æ–≥\\n‚Ä¢ –°–ª–∏—à–∫–æ–º –º–∞–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π - —É–ø—Ä–æ—Å—Ç–∏—Ç–µ –≤–æ–ø—Ä–æ—Å—ã\\n‚Ä¢ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –ò–ò-–∞–≥–µ–Ω—Ç–∞'
    },
    'conversion-rate': {
      title: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å',
      description: '–ü—Ä–æ—Ü–µ–Ω—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∏–≥–ª–∏ –≤–∞—à–µ–π –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–∑–Ω–µ—Å-—Ü–µ–ª–∏.',
      formula: '0 (converted chats) / 0 (total analyzed chats) √ó 100% = 0%',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ò–ò-–∞–≥–µ–Ω—Ç–∞ –≤ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –≤–∞—à–∏—Ö –±–∏–∑–Ω–µ—Å-—Ü–µ–ª–µ–π. –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∞–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞–º.\\n\\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\\n‚Ä¢ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 15-25% –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –±–∏–∑–Ω–µ—Å–æ–≤\\n‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è\\n‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–º–ø—Ç—ã –ø–æ–¥ –≤–∞—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏'
    },
    'bounce-rate': {
      title: '–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ–≤',
      description: '–ü—Ä–æ—Ü–µ–Ω—Ç –ª–∏–¥–æ–≤, —Å –∫–æ—Ç–æ—Ä—ã–º –ò–ò –ø—ã—Ç–∞–ª—Å—è –¥–æ—Å—Ç–∏—á—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–µ–ª–∏, –Ω–æ –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Å—Ç–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å.',
      formula: '0 (inconclusive leads) / 0 (total analyzed chats) √ó 100% = 0%',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª–∏ –æ–±—â–µ–Ω–∏–µ –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏. –ù–∏–∑–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ–≤ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.\\n\\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\\n‚Ä¢ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –º–µ–Ω–µ–µ 20%\\n‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–æ–≤\\n‚Ä¢ –£–ª—É—á—à–∞–π—Ç–µ –ø–µ—Ä–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ–¥—Ö–æ–¥'
    },
    'customer-engagement': {
      title: '–í–æ–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞',
      description: '–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –≤ –∫–∞–∂–¥–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ.',
      formula: '0 (total messages) / 0 (total chats) = 0',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω–æ –∫–ª–∏–µ–Ω—Ç—ã —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –¥–∏–∞–ª–æ–≥–µ. –í—ã—Å–æ–∫–æ–µ –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø—Ä–æ–¥—É–∫—Ç—É –∏–ª–∏ —É—Å–ª—É–≥–µ.\n\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n‚Ä¢ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 3-7 —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\n‚Ä¢ –ó–∞–¥–∞–≤–∞–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –∫–ª–∏–µ–Ω—Ç–∞'
    },
    'resolved-questions': {
      title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—à–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤',
      description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –ò–ò-–∞–≥–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª, –∞ –∫–ª–∏–µ–Ω—Ç –¥–∞–ª –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤ –∏–ª–∏ –Ω–µ –∑–∞–ø—Ä–æ—Å–∏–ª —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –∫–æ–ª–ª–µ–≥–æ–π.',
      formula: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤'
    },
    'rejection-rate': {
      title: '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π',
      description: '–ü—Ä–æ—Ü–µ–Ω—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –≥–¥–µ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–ª–∏ –Ω–∞ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ò–ò.',
      formula: '0 (no response chats) / 0 (total chats) √ó 100% = 0%'
    },
    'avg-response-time': {
      title: '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ –ò–ò-–∞–≥–µ–Ω—Ç–∞',
      description: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –ò–ò-–∞–≥–µ–Ω—Ç—É, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞',
      formula: '0.0 sec (sum of response times) / 0 (total AI responses) = 0 —Å–µ–∫',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –ò–ò-–∞–≥–µ–Ω—Ç–∞. –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã —É–ª—É—á—à–∞—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç –∏ –ø–æ–≤—ã—à–∞—é—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏—é.\\n\\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\\n‚Ä¢ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –º–µ–Ω–µ–µ 2 —Å–µ–∫—É–Ω–¥\\n‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤\\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤'
    },
    'avg-resolution-time': {
      title: '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞',
      description: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ò–ò-–∞–≥–µ–Ω—Ç—É –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞',
      formula: '–í—Ä–µ–º—è –æ—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä–æ –ò–ò-–∞–≥–µ–Ω—Ç —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –∫–ª–∏–µ–Ω—Ç–æ–≤. –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–≤—ã—à–∞–µ—Ç —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤.\\n\\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\\n‚Ä¢ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 2-5 –º–∏–Ω—É—Ç\\n‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è\\n‚Ä¢ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏'
    },
    'ai-effectiveness': {
      title: '–û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ò–ò-–∞–≥–µ–Ω—Ç–∞',
      description: '–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –ò–ò-–∞–≥–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∫–∞—á–µ—Å—Ç–≤–∞.',
      formula: '(–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ + –°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã + –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ + –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π) / 4',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –¥–∞–µ—Ç –æ–±—â—É—é –æ—Ü–µ–Ω–∫—É –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã –ò–ò-–∞–≥–µ–Ω—Ç–∞. –í—ã—Å–æ–∫–∞—è –æ—Ü–µ–Ω–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã.\\n\\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\\n‚Ä¢ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 8+ –∏–∑ 10\\n‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π\\n‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π'
    },
    'help-request-rate': {
      title: '–ü—Ä–æ—Ü–µ–Ω—Ç —á–∞—Ç–æ–≤ —Å –∑–∞–ø—Ä–æ—Å–æ–º –æ –ø–æ–º–æ—â–∏',
      description: '–ü—Ä–æ—Ü–µ–Ω—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –≥–¥–µ –∫–ª–∏–µ–Ω—Ç—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –ø–µ—Ä–µ–¥–∞—á—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —á–µ–ª–æ–≤–µ–∫—É –∏–∑ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤.',
      formula: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Ç–æ–≤ —Å –∑–∞–ø—Ä–æ—Å–æ–º –ø–æ–º–æ—â–∏ / –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Ç–æ–≤ √ó 100%',
      explanation: '–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–æ –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–æ—Å—è—Ç –ø–æ–º–æ—â–∏ —á–µ–ª–æ–≤–µ–∫–∞. –ù–∏–∑–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É –ò–ò-–∞–≥–µ–Ω—Ç–∞.\\n\\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\\n‚Ä¢ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –º–µ–Ω–µ–µ 5%\\n‚Ä¢ –£–ª—É—á—à–∞–π—Ç–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\\n‚Ä¢ –î–æ–±–∞–≤–ª—è–π—Ç–µ —ç—Å–∫–∞–ª–∞—Ü–∏—é –∫ —á–µ–ª–æ–≤–µ–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏'
    }
  };

  // Function to open metric info modal
  const openMetricInfo = (metricInfo) => {
    setCurrentMetricInfo(metricInfo);
    setShowMetricInfoModal(true);
  };

  // Function to handle hover on metric icon
  const handleMetricHover = (metricId, event) => {
    const rect = event.target.getBoundingClientRect();
    setTooltipPosition({ x: rect.left + rect.width / 2, y: rect.top - 10 });
    setHoveredMetricId(metricId);
  };

  // Function to handle mouse leave
  const handleMetricLeave = () => {
    setHoveredMetricId(null);
  };

    // Function to generate trend indicator
  const generateTrendIndicator = (trend, value, inverted = false) => {
    const isPositive = inverted ? trend === 'down' : trend === 'up';
    return (
      <div className="flex items-end gap-1 ml-2">
        <svg 
          className={`w-3 h-3 ${isPositive ? 'text-green-600' : 'text-red-600'}`} 
          fill="none" 
          stroke="currentColor" 
          viewBox="0 0 24 24"
          style={{ paddingBottom: '0px', borderBottomWidth: '0px', height: '31px' }}
        >
          {isPositive ? (
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" style={{ paddingBottom: '0px' }} />
          ) : (
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" style={{ paddingBottom: '0px' }} />
          )}
        </svg>
        <div className={`text-[11px] font-[500] ${isPositive ? 'text-green-600' : 'text-red-600'}`} style={{ height: '13px' }}>
          {value}
        </div>
      </div>
    );
  };

  // Function to generate progress bar with 50 sticks
  const generateProgressBar = (value, maxValue = 100, isRating = false, color = 'blue') => {
    const totalSticks = 50;
    let filledSticks;
    
    if (isRating) {
      // For rating: 10 points = 50 sticks, so 1 point = 5 sticks
      filledSticks = Math.round((value / 10) * totalSticks);
    } else {
      // For percentage: 100% = 50 sticks, so 1% = 0.5 sticks
      filledSticks = Math.round((value / maxValue) * totalSticks);
    }
    
    const colorMap = {
      blue: '#0084FF',
      purple: '#8B5CF6',
      green: '#10B981',
      orange: '#F59E0B',
      red: '#EF4444',
      indigo: '#6366F1'
    };
    
    const sticks = [];
    for (let i = 0; i < totalSticks; i++) {
      const isFilled = i < filledSticks;
      sticks.push(
        <div
          key={i}
          className={`w-[2px] h-[16px] rounded-[1px] ${
            isFilled ? '' : 'bg-[#D3D3D3]'
          }`}
          style={{
            position: 'absolute',
            left: `${i * 4}px`,
            top: '0px',
            backgroundColor: isFilled ? colorMap[color] : '#D3D3D3'
          }}
        />
      );
    }
    
    return (
      <div className="relative w-[200px] h-[16px] mt-2">
        {sticks}
      </div>
    );
  };

  // Generate widget code
  const generateWidgetCode = () => {
    const settings = {
      accentColor: widgetDevelopmentSettings.accentColor,
      buttonText: widgetDevelopmentSettings.buttonText,
      buttonStyle: widgetDevelopmentSettings.buttonColor || 'rectangle',
      buttonColor: widgetDevelopmentSettings.buttonColor || 'light',
      customButtonColor: widgetDevelopmentSettings.customButtonColor,
      widgetMode: widgetDevelopmentSettings.widgetMode,
      quickQuestions: widgetDevelopmentSettings.quickQuestions,
      leadFormEnabled: widgetDevelopmentSettings.leadFormEnabled,
      leadFormTitle: widgetDevelopmentSettings.leadFormTitle,
      leadFormDescription: widgetDevelopmentSettings.leadFormDescription,
      leadFormFields: widgetDevelopmentSettings.leadFormFields,
      welcomeMessages: widgetDevelopmentSettings.welcomeMessages,
      quickReplies: widgetDevelopmentSettings.quickReplies,
      logoUrl: widgetDevelopmentSettings.logoUrl,
      logoName: widgetDevelopmentSettings.logoName,
      suggestions: widgetDevelopmentSettings.suggestions,
      triggerQuestionEnabled: widgetDevelopmentSettings.triggerQuestionEnabled,
      triggerQuestionDelay: widgetDevelopmentSettings.triggerQuestionDelay,
      triggerQuestionText: widgetDevelopmentSettings.triggerQuestionText,
      followUpMessage: widgetDevelopmentSettings.followUpMessage,
      followUpDelay: widgetDevelopmentSettings.followUpDelay,
      followUpQuestion: widgetDevelopmentSettings.followUpQuestion,
      followUpQuickReply: widgetDevelopmentSettings.followUpQuickReply,
      privacyPolicyUrl: widgetDevelopmentSettings.privacyPolicyUrl,
      dataTags: widgetDevelopmentSettings.dataTags,
      widgetLocation: widgetDevelopmentSettings.widgetLocation,
      desktopBottomOffset: widgetDevelopmentSettings.desktopBottomOffset,
      desktopRightOffset: widgetDevelopmentSettings.desktopRightOffset,
      mobileBottomOffset: widgetDevelopmentSettings.mobileBottomOffset,
      mobileRightOffset: widgetDevelopmentSettings.mobileRightOffset,
      zIndex: widgetDevelopmentSettings.zIndex,
      avatar: widgetDevelopmentSettings.avatar
    };

    const encodedSettings = encodeURIComponent(JSON.stringify(settings));
    
    // –û–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∫–∞–∫ —É Tidio: –æ–¥–∏–Ω —Ç–µ–≥ + data-key
    const userKey = widgetApiKey || (currentUser?.id ? `adapto_${currentUser.id}` : 'adapto_demo');
    // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º ngrok URL, –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ - ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    const baseUrl = import.meta.env.PROD
      ? (import.meta.env.VITE_WIDGET_URL || 'https://your-domain.com')
      : 'https://666eefe9cca2.ngrok-free.app';
    return `<script src="${baseUrl}/adapto.js" data-key="${userKey}"></script>`;
  };

  // Open live preview in new tab using same widget script (identical to production embed)
  const openWidgetPreview = () => {
    const userKey = widgetApiKey || (currentUser?.id ? `adapto_${currentUser.id}` : 'adapto_demo');
    const url = `${API_CONFIG.BASE_URL}/widget-preview.html?key=${userKey}&noCache=1&ts=${Date.now()}`;
    window.open(url, '_blank', 'noopener,noreferrer');
  };

  // Export functions
  const exportToCSV = () => {
    const period = dateRange.start && dateRange.end 
      ? `${dateRange.start.toLocaleDateString()} - ${dateRange.end.toLocaleDateString()}`
      : '–í—Å–µ –≤—Ä–µ–º—è';
    
    const data = [
      ['–ú–µ—Ç—Ä–∏–∫–∞', '–ó–Ω–∞—á–µ–Ω–∏–µ', '–ü–µ—Ä–∏–æ–¥'],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤', statisticsAggregates.dialogsTotal || 0, period],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π', statisticsAggregates.messagesTotal || 0, period],
      ['–°—Ä–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –¥–∏–∞–ª–æ–≥', (statisticsAggregates.avgMessagesPerDialog || 0).toFixed(2), period],
      ['–û—Ç–∫—Ä—ã—Ç–∏–π –≤–∏–¥–∂–µ—Ç–∞', statisticsAggregates.widget_opens || 0, period],
      ['–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å', `${Math.round(statisticsAggregates.conversionRate || 0)}%`, period],
      ['–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ–≤', `${Math.round(statisticsAggregates.bounce_rate || 0)}%`, period],
      ['–í–æ–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞', `${Math.round(statisticsAggregates.customer_engagement || 0)}%`, period],
      ['–†–µ—à–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤', statisticsAggregates.resolved_questions || 0, period],
      ['–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π', `${Math.round(statisticsAggregates.escalation_rate || 0)}%`, period],
      ['–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞', `${Math.round(statisticsAggregates.avg_response_time || 0)}—Å`, period],
      ['–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è', `${Math.round(statisticsAggregates.avg_resolution_time || 0)}–º`, period],
      ['–û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ò–ò', `${(statisticsAggregates.ai_effectiveness_score || 0).toFixed(1)}/10`, period],
      ['–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –ø–æ–º–æ—â–∏', `${Math.round(statisticsAggregates.help_request_rate || 0)}%`, period]
    ];
    
    const csvContent = data.map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `statistics_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const exportToXLS = () => {
    const period = dateRange.start && dateRange.end 
      ? `${dateRange.start.toLocaleDateString()} - ${dateRange.end.toLocaleDateString()}`
      : '–í—Å–µ –≤—Ä–µ–º—è';
    
    const data = [
      ['–ú–µ—Ç—Ä–∏–∫–∞', '–ó–Ω–∞—á–µ–Ω–∏–µ', '–ü–µ—Ä–∏–æ–¥'],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤', statisticsAggregates.dialogsTotal || 0, period],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π', statisticsAggregates.messagesTotal || 0, period],
      ['–°—Ä–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –¥–∏–∞–ª–æ–≥', (statisticsAggregates.avgMessagesPerDialog || 0).toFixed(2), period],
      ['–û—Ç–∫—Ä—ã—Ç–∏–π –≤–∏–¥–∂–µ—Ç–∞', statisticsAggregates.widget_opens || 0, period],
      ['–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å', `${Math.round(statisticsAggregates.conversionRate || 0)}%`, period],
      ['–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ–≤', `${Math.round(statisticsAggregates.bounce_rate || 0)}%`, period],
      ['–í–æ–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞', `${Math.round(statisticsAggregates.customer_engagement || 0)}%`, period],
      ['–†–µ—à–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤', statisticsAggregates.resolved_questions || 0, period],
      ['–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π', `${Math.round(statisticsAggregates.escalation_rate || 0)}%`, period],
      ['–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞', `${Math.round(statisticsAggregates.avg_response_time || 0)}—Å`, period],
      ['–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è', `${Math.round(statisticsAggregates.avg_resolution_time || 0)}–º`, period],
      ['–û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ò–ò', `${(statisticsAggregates.ai_effectiveness_score || 0).toFixed(1)}/10`, period],
      ['–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –ø–æ–º–æ—â–∏', `${Math.round(statisticsAggregates.help_request_rate || 0)}%`, period]
    ];
    
    let xlsContent = '<table>';
    data.forEach(row => {
      xlsContent += '<tr>';
      row.forEach(cell => {
        xlsContent += `<td>${cell}</td>`;
      });
      xlsContent += '</tr>';
    });
    xlsContent += '</table>';
    
    const blob = new Blob([xlsContent], { type: 'application/vnd.ms-excel' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `statistics_${new Date().toISOString().split('T')[0]}.xls`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const exportDialogsToCSV = () => {
    const data = [
      ['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'Email', '–ò—Å—Ç–æ—á–Ω–∏–∫', '–°—Ç–∞—Ç—É—Å', '–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', '–í—Ä–µ–º—è', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π']
    ];
    
    dialogsData.forEach(dialog => {
      data.push([
        dialog.user,
        dialog.email,
        dialog.source,
        dialog.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : dialog.status === 'waiting' ? '–û–∂–∏–¥–∞–µ—Ç' : '–ó–∞–∫—Ä—ã—Ç',
        dialog.lastMessage,
        dialog.time,
        dialog.messages.length.toString()
      ]);
    });
    
    const csvContent = data.map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `dialogs_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ CRM –¥–∞–Ω–Ω—ã—Ö
  const exportCRMToCSV = () => {
    const data = [
      ['–ù–∞–∑–≤–∞–Ω–∏–µ', '–°—Ç–∞–¥–∏—è', '–ö–∞—á–µ—Å—Ç–≤–æ –ª–∏–¥–∞', '–°—É–º–º–∞', '–î–Ω–∏', '–í–ª–∞–¥–µ–ª–µ—Ü', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è', '–ö–ª–∏–µ–Ω—Ç', 'Email', '–¢–µ–ª–µ—Ñ–æ–Ω', '–ö–æ–º–ø–∞–Ω–∏—è']
    ];
    
    deals.forEach(deal => {
      data.push([
        deal.title,
        deal.stage,
        deal.leadQuality,
        deal.amount.toString(),
        deal.days.toString(),
        deal.ownerName,
        deal.isResolved ? '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' : '–ê–∫—Ç–∏–≤–Ω–∞',
        deal.createdDate,
        deal.client.name,
        deal.client.email,
        deal.client.phone,
        deal.client.company
      ]);
    });
    
    const csvContent = data.map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `crm_deals_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const exportCRMToXLS = () => {
    const headers = ['–ù–∞–∑–≤–∞–Ω–∏–µ', '–°—Ç–∞–¥–∏—è', '–ö–∞—á–µ—Å—Ç–≤–æ –ª–∏–¥–∞', '–°—É–º–º–∞', '–î–Ω–∏', '–í–ª–∞–¥–µ–ª–µ—Ü', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è', '–ö–ª–∏–µ–Ω—Ç', 'Email', '–¢–µ–ª–µ—Ñ–æ–Ω', '–ö–æ–º–ø–∞–Ω–∏—è'];
    const data = deals.map(deal => [
      deal.title,
      deal.stage,
      deal.leadQuality,
      deal.amount,
      deal.days,
      deal.ownerName,
      deal.isResolved ? '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' : '–ê–∫—Ç–∏–≤–Ω–∞',
      deal.createdDate,
      deal.client.name,
      deal.client.email,
      deal.client.phone,
      deal.client.company
    ]);
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π HTML —Ñ–∞–π–ª —Å —Ç–∞–±–ª–∏—Ü–µ–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel
    const htmlContent = `
      <html>
        <head>
          <meta charset="utf-8">
          <style>
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
          </style>
        </head>
        <body>
          <table>
            <thead>
              <tr>
                ${headers.map(header => `<th>${header}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${data.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
            </tbody>
          </table>
        </body>
      </html>
    `;
    
    const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `crm_deals_${new Date().toISOString().split('T')[0]}.xls`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∏–∞–ª–æ–≥–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
  const exportDialogToText = (dialog) => {
    if (!dialog) return;

    let textContent = `–î–ò–ê–õ–û–ì: ${dialog.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}\n`;
    textContent += `====================================\n\n`;
    textContent += `–ò—Å—Ç–æ—á–Ω–∏–∫: ${dialog.source === 'vk' ? '–í–∫–æ–Ω—Ç–∞–∫—Ç–µ' : dialog.source}\n`;
    textContent += `Email: ${dialog.email || '‚Äî'}\n`;
    textContent += `–¢–µ–ª–µ—Ñ–æ–Ω: ${dialog.phone || '‚Äî'}\n`;
    textContent += `–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: ${dialog.startTime}\n`;
    textContent += `–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${dialog.lastActivity}\n`;
    textContent += `–°—Ç–∞—Ç—É—Å: ${dialog.status}\n`;
    if (dialog.assignedTo) {
      textContent += `–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${dialog.assignedTo === (currentUser?.id || 'current_operator') ? '–í—ã' : '–î—Ä—É–≥–æ–π –æ–ø–µ—Ä–∞—Ç–æ—Ä'}\n`;
    }
    textContent += `\n==== –°–û–û–ë–©–ï–ù–ò–Ø ====\n\n`;

    if (dialog.messages && dialog.messages.length > 0) {
      dialog.messages.forEach((message) => {
        const sender = message.isUser ? dialog.name || '–ö–ª–∏–µ–Ω—Ç' : '–ò–ò-–∞–≥–µ–Ω—Ç';
        textContent += `[${message.time}] ${sender}: ${message.text}\n\n`;
      });
    } else {
      textContent += '–°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç\n';
    }

    textContent += `\n==== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ====\n`;
    textContent += `–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${dialog.messageCount}\n`;
    textContent += `–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${dialog.priority || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}\n`;
    textContent += `–ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å: ${dialog.canTakeover ? '–î–∞' : '–ù–µ—Ç'}\n`;
    textContent += `\n–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}\n`;

    const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `dialog_${dialog.name || 'unknown'}_${new Date().toISOString().split('T')[0]}.txt`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleChatFileUpload = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'image/*,.pdf,.doc,.docx,.txt';
    input.onchange = (e) => {
      const files = Array.from((e.target as HTMLInputElement).files || []);
      console.log('Selected files:', files);
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤
    };
    input.click();
  };

  const handleSendMessage = async () => {
    if (!currentUser?.id) return;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    const validation = validateMessage(messageText);
    if (!validation.isValid) {
      showNotificationMessage(`‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${validation.errors.join(', ')}`);
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit
    const rateLimit = checkRateLimit(currentUser.id);
    if (!rateLimit.allowed) {
      const resetTime = new Date(rateLimit.resetTime).toLocaleTimeString();
      showNotificationMessage(`‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –≤ ${resetTime}`);
      return;
    }
    
    // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    const sanitizedMessage = sanitizeMessage(validation.sanitizedMessage);
    
    try {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
      const messageId = `user_${Date.now()}_${Math.random()}`;
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      const userMessage = createUnifiedMessage({
        id: messageId,
        type: 'user',
        text: sanitizedMessage,
        time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
        timestamp: getUniqueTimestamp()
      });
      setChatHistory(prev => [...prev, userMessage]);
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É —á–∞—Ç–∞
      ChatUtils.scrollToBottom(chatHistoryRef);
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      setMessageText('');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ç–∏
      if (!OfflineManager.isOnline()) {
        // Offline —Ä–µ–∂–∏–º - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ
        OfflineManager.saveOfflineMessage({
          id: messageId,
          text: sanitizedMessage,
          type: 'user',
          userId: currentUser.id,
          assistantId: currentUser.id
        }, 'admin');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± offline —Ä–µ–∂–∏–º–µ
        showNotificationMessage('üì¥ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ offline —Ä–µ–∂–∏–º–µ. –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏.');
        return;
      }
      
      // Online —Ä–µ–∂–∏–º - –æ–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      await chatHistoryAPI.saveMessage(currentUser.id, 'user', messageText, 'admin');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      const loadingMessage = ChatUtils.createLoadingMessage('assistant');
      setChatHistory(prev => [...prev, loadingMessage]);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É ai-agent-system
      const assistantId = currentUser.id;
      const result = await sendMessageToAiAgent(sanitizedMessage, currentUser.id, assistantId, chatHistory);
      
      if (result.success) {
        // –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
        const aiMessage = createUnifiedMessage({
          id: `ai_${Date.now()}_${Math.random()}`,
          type: 'assistant',
          text: result.response || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞',
          time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
          timestamp: getUniqueTimestamp()
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —É–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        setChatHistory(prev => ChatUtils.addMessageAndRemoveLoading(prev, aiMessage));
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        await ChatUtils.saveMessageToDB(currentUser.id, 'assistant', result.response || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'admin', chatHistoryAPI);
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É —á–∞—Ç–∞
        ChatUtils.scrollToBottom(chatHistoryRef);
      } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        const errorMessage = ChatUtils.createErrorMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
        setChatHistory(prev => ChatUtils.addMessageAndRemoveLoading(prev, errorMessage));
        ChatUtils.scrollToBottom(chatHistoryRef);
      }
      
      // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É ai-agent-system
      
    } catch (error) {
      const errorMessage = ChatUtils.handleChatError(error, showNotificationMessage);
      setChatHistory(prev => ChatUtils.addMessageAndRemoveLoading(prev, errorMessage));
      ChatUtils.scrollToBottom(chatHistoryRef);
    }
  };


  const handleWidgetChatSendMessage = async () => {
    if (!currentMessage.trim() || !currentUser?.id) return;
    
    try {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
      const corrections = await botCorrectionsAPI.getCorrections(currentUser.id);
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
      const newMessage = {
        id: getUniqueTimestamp(), 
        text: currentMessage, 
        isUser: true, 
        time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
        timestamp: getUniqueTimestamp()
      };
      setChatMessages(prev => [...prev, newMessage]);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –ò–ò –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
      setAiReceivedResponse(true);
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
      setShowCompletionButton(false);
      setShowHumanButton(false);
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –≤–∏–¥–∂–µ—Ç–∞
      ChatUtils.scrollToBottom(widgetChatRef);
      
      // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —Ñ–æ—Ä–º—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–∏–∞–ª–æ–≥–∞)
      try {
        const lc = String(currentMessage || '').toLowerCase();
        const formTriggers = [
          /–∑–∞—è–≤–∫/,
          /–∑–∞–ø–∏—Å–∞—Ç—å—Å—è/,
          /–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü/,
          /–æ—Å—Ç–∞–≤(–∏—Ç—å)?\s*(–Ω–æ–º–µ—Ä|—Ç–µ–ª–µ—Ñ–æ–Ω)/,
          /–∑–∞–ø–æ–ª–Ω(–∏—Ç—å)?\s*—Ñ–æ—Ä–º—É/,
          /–æ—Ñ–æ—Ä–º–∏—Ç—å\s*–∑–∞—è–≤–∫—É/,
          /—Å–≤—è–∑–∞—Ç—å—Å—è/,
          /–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å/
        ];
        if (formTriggers.some(r => r.test(lc))) {
          setShowForm(true);
        }
      } catch (_) {}
      
      
      
      // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç" (–±–µ–∑ handover)
      await createTestDialog('–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç', currentMessage);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –∫–∞–Ω–∞–ª–æ–º 'widget'
      await chatHistoryAPI.saveMessage(currentUser.id, 'user', currentMessage, 'widget');
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
      const message = `üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\n\nüë§ –ö–ª–∏–µ–Ω—Ç: –í–∏–¥–∂–µ—Ç\nüí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: "${currentMessage}"\nüïí –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}`;
      sendTelegramNotification(message, 'new_messages');
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      setCurrentMessage('');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      const loadingMessage = ChatUtils.createLoadingMessage('assistant', false);
      setChatMessages(prev => [...prev, loadingMessage]);
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –≤–∏–¥–∂–µ—Ç–∞
      ChatUtils.scrollToBottom(widgetChatRef);
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
      const activeCorrectionsList = corrections.filter((_, index) => activeCorrections.has(index));
      
      const requestData = {
        message: currentMessage,
        conversationHistory: chatMessages,
        agentId: currentUser.id,
        setupData: {
          ...setupData,
          knowledgeItems: [
            ...(setupData.knowledgeItems || []),
            ...activeCorrectionsList.map(correction => ({
              type: 'correction',
              content: correction.correction || correction
            }))
          ]
        }
      };
      
      console.log('Sending widget request to API with corrections:', {
        loadedCorrections: corrections,
        activeCorrections: activeCorrectionsList,
        activeCorrectionsIndexes: Array.from(activeCorrections),
        knowledgeItems: requestData.setupData.knowledgeItems
      });
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –≤–∏–¥–∂–µ—Ç—É API
      const apiKey = `adapto_${currentUser.id}_${Date.now()}`;
      const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.WIDGET_ENDPOINT}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          key: apiKey,
          message: currentMessage,
          conversationHistory: chatMessages.map(msg => ({
            role: msg.isUser ? 'user' : 'assistant',
            content: msg.text
          }))
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      const assistantResponse = data.answer || data.response || data.message || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.';
      
      // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –ø—Ä–æ—Å–∏—Ç –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
      if (data.showForm === true) {
        setShowForm(true);
      }
      
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
      setChatMessages(prev => {
        const withoutLoading = prev.filter(msg => !msg.isTyping);
        return [...withoutLoading, { 
          id: getUniqueTimestamp(), 
          text: assistantResponse, 
          isUser: false, 
          time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
          timestamp: getUniqueTimestamp()
        }];
      });
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –≤–∏–¥–∂–µ—Ç–∞
      ChatUtils.scrollToBottom(widgetChatRef);
      
      // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –ø—Ä–æ—Å–∏—Ç —ç—Å–∫–∞–ª–∞—Ü–∏—é ‚Äî —Å–æ–∑–¥–∞—ë–º –¥–∏–∞–ª–æ–≥ —Å need_handover=true
      if (data.handover === true) {
        try {
          // –°–æ–∑–¥–∞–µ–º –¥–∏–∞–ª–æ–≥ —Å —Ñ–ª–∞–≥–æ–º need_handover
          const dialog = await createTestDialog('–í–∏–¥–∂–µ—Ç: —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä', currentMessage, true);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –ë–î
          if (dialog && dialog.id) {
            try {
              await dialogsDB.updateDialog(dialog.id, { priority: 'high' });
            } catch (e) {
              console.warn('Failed to update dialog priority:', e);
            }
          }
          
          // –°–æ–∑–¥–∞–µ–º CRM-–∑–∞–¥–∞—á—É —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
          const { crmAPI } = await import('./crm_api_functions.js');
          await crmAPI.createTask(currentUser.id, {
            title: '–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–º–æ—â—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
            description: `–ê–≤—Ç–æ—ç—Å–∫–∞–ª–∞—Ü–∏—è –∏–∑ –≤–∏–¥–∂–µ—Ç–∞: "${currentMessage.slice(0, 100)}"`,
            priority: 'high',
            status: 'pending',
            type: 'follow_up',
            notes: '–°–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä–∏ handover'
          });
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞/CRM-–∑–∞–¥–∞—á–∏ –¥–ª—è handover:', e);
        }
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      await chatHistoryAPI.saveMessage(currentUser.id, 'assistant', assistantResponse, 'widget');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
      try {
        const updatedLimits = await userLimitsAPI.getUserLimits(currentUser.id);
        if (updatedLimits) {
          setUserLimits(updatedLimits);
          console.log('User limits updated (widget):', updatedLimits);
        }
      } catch (limitError) {
        console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ (widget):', limitError.message);
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞
      setShowCompletionButton(true);
      setShowHumanButton(true);
      
    } catch (error) {
      console.error('Error sending widget message:', error);
      
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É
      setChatMessages(prev => {
        const withoutLoading = prev.filter(msg => !msg.isTyping);
        return [...withoutLoading, { 
          id: getUniqueTimestamp(), 
          text: '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 
          isUser: false, 
          time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
          timestamp: getUniqueTimestamp()
        }];
      });
      
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
  const handleWidgetOpen = () => {
    setWidgetPreviewOpen(true);
    setWidgetOpenedTime(Date.now());
    setWidgetClosedTime(null);
    setShowFollowUpMessage(false);
    setAiReceivedResponse(false); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∏–¥–∂–µ—Ç–∞
  };

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∏–Ω—Ç–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–≠—Ç–æ –ø–æ–º–æ–≥–ª–æ¬ª, ¬´–ø–æ–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞¬ª)
  const sendWidgetIntentMessage = async (intentText) => {
    if (!currentUser?.id) return;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    const validation = validateMessage(intentText);
    if (!validation.isValid) {
      showNotificationMessage(`‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${validation.errors.join(', ')}`);
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit
    const rateLimit = checkRateLimit(currentUser.id);
    if (!rateLimit.allowed) {
      const resetTime = new Date(rateLimit.resetTime).toLocaleTimeString();
      showNotificationMessage(`‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –≤ ${resetTime}`);
      return;
    }
    
    // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    const sanitizedMessage = sanitizeMessage(validation.sanitizedMessage);
    
    try {
      const newMessage = createUnifiedMessage({
        id: getUniqueTimestamp(),
        text: sanitizedMessage,
        isUser: true,
        time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
        timestamp: getUniqueTimestamp()
      });
      setChatMessages(prev => [...prev, newMessage]);
      ChatUtils.scrollToBottom(widgetChatRef);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –≤–∏–¥–∂–µ—Ç—É API —Å retry –ª–æ–≥–∏–∫–æ–π
      const apiKey = `adapto_${currentUser.id}_${Date.now()}`;
      const data = await ChatUtils.retryApiRequest(async () => {
        const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.WIDGET_ENDPOINT}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            key: apiKey,
            message: sanitizedMessage,
            conversationHistory: chatMessages.map(msg => ({
              role: msg.isUser ? 'user' : 'assistant',
              content: msg.text
            }))
          })
        });
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      }, {
        maxRetries: 2,
        baseDelay: 1000,
        retryCondition: (error) => {
          return !error.response || 
                 error.response.status >= 500 || 
                 error.message.includes('timeout') ||
                 error.message.includes('NetworkError');
        }
      });

      if (data.showForm === true) setShowForm(true);

      // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–º–æ—â—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ - —Å–æ–∑–¥–∞–µ–º –¥–∏–∞–ª–æ–≥ —Å need_handover=true
      if (data.handover === true || intentText.toLowerCase().includes('–º–µ–Ω–µ–¥–∂–µ—Ä') || intentText.toLowerCase().includes('–ø–æ–º–æ—â—å')) {
        try {
          // –°–æ–∑–¥–∞–µ–º –¥–∏–∞–ª–æ–≥ —Å —Ñ–ª–∞–≥–æ–º need_handover
          const dialog = await createTestDialog('–í–∏–¥–∂–µ—Ç: –∑–∞–ø—Ä–æ—Å –ø–æ–º–æ—â–∏', intentText, true);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –ë–î
          if (dialog && dialog.id) {
            try {
              await dialogsDB.updateDialog(dialog.id, { priority: 'high' });
            } catch (e) {
              console.warn('Failed to update dialog priority:', e);
            }
          }
          
          // –°–æ–∑–¥–∞–µ–º CRM-–∑–∞–¥–∞—á—É
          const { crmAPI } = await import('./crm_api_functions.js');
          await crmAPI.createTask(currentUser.id, {
            title: '–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–º–æ—â—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
            description: `–ó–∞–ø—Ä–æ—Å –ø–æ–º–æ—â–∏ –∏–∑ –≤–∏–¥–∂–µ—Ç–∞: "${intentText}"`,
            priority: 'high',
            status: 'pending',
            type: 'follow_up',
            notes: '–°–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–º–æ—â–∏'
          });
        } catch (e) { 
          console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞/CRM-–∑–∞–¥–∞—á–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–º–æ—â–∏:', e); 
        }
      }

      const assistantResponse = data.answer || data.response || data.message || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.';
      const aiMessage = createUnifiedMessage({
        id: getUniqueTimestamp(),
        text: assistantResponse,
        isUser: false,
        time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
        timestamp: getUniqueTimestamp()
      });
      
      setChatMessages(prev => ChatUtils.addMessageAndRemoveLoading(prev, aiMessage));
      ChatUtils.scrollToBottom(widgetChatRef);
      await ChatUtils.saveMessageToDB(currentUser.id, 'assistant', assistantResponse, 'widget', chatHistoryAPI);
    } catch (e) {
      const errorMessage = ChatUtils.handleChatError(e, showNotificationMessage);
      setChatMessages(prev => ChatUtils.addMessageAndRemoveLoading(prev, errorMessage));
      ChatUtils.scrollToBottom(widgetChatRef);
    }
  };

  const handleWidgetClose = () => {
    setWidgetPreviewOpen(false);
    setWidgetClosedTime(Date.now());
    setWidgetOpenedTime(null);
    setShowTriggerMessage(false);
  };

  const handleLikeMessage = (index) => {
    console.log('Liked message at index:', index);
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–∞–π–∫–∞ –≤ GigaChat
    showNotificationMessage('–û—Ç–≤–µ—Ç –æ—Ü–µ–Ω–µ–Ω –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ');
  };

  const handleDislikeMessage = (index) => {
    console.log('Disliked message at index:', index);
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∏–∑–ª–∞–π–∫–∞ –≤ GigaChat
    showNotificationMessage('–û—Ç–≤–µ—Ç –æ—Ü–µ–Ω–µ–Ω –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ');
  };

  const exportDialogsToXLS = () => {
    const headers = ['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'Email', '–ò—Å—Ç–æ—á–Ω–∏–∫', '–°—Ç–∞—Ç—É—Å', '–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', '–í—Ä–µ–º—è', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π'];
    const data = dialogsData.map(dialog => [
      dialog.user,
      dialog.email,
      dialog.source,
      dialog.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : dialog.status === 'waiting' ? '–û–∂–∏–¥–∞–µ—Ç' : '–ó–∞–∫—Ä—ã—Ç',
      dialog.lastMessage,
      dialog.time,
      dialog.messages.length.toString()
    ]);
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π HTML —Ñ–∞–π–ª —Å —Ç–∞–±–ª–∏—Ü–µ–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel
    const htmlContent = `
      <html>
        <head>
          <meta charset="utf-8">
          <title>–î–∏–∞–ª–æ–≥–∏</title>

  // Calendar functions
  const handleQuickDateSelect = (type) => {
    try {
    console.log('handleQuickDateSelect called with type:', type);
    const today = new Date();
    let start, end;
    
    switch(type) {
      case 'today':
        start = new Date(today);
        end = new Date(today);
        break;
      case 'yesterday':
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        start = yesterday;
        end = yesterday;
        break;
      case 'last7days':
        start = new Date(today);
        start.setDate(start.getDate() - 6);
        end = new Date(today);
        break;
      case 'last30days':
        start = new Date(today);
        start.setDate(start.getDate() - 29);
        end = new Date(today);
        break;
      case 'last90days':
        start = new Date(today);
        start.setDate(start.getDate() - 89);
        end = new Date(today);
        break;
      case 'thisMonth':
        start = new Date(today.getFullYear(), today.getMonth(), 1);
        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        break;
      default:
          return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞—Ç
      if (!start || !(start instanceof Date) || isNaN(start.getTime()) ||
          !end || !(end instanceof Date) || isNaN(end.getTime())) {
        console.error('Invalid dates generated:', { start, end });
        return;
    }
    
    console.log('Setting dateRange:', { start, end });
    setDateRange({ start, end });
    setSelectedDates([]);
    setActiveQuickSelect(type);
    console.log('activeQuickSelect set to:', type);
    } catch (error) {
      console.error('Error in handleQuickDateSelect:', error);
    }
  };

  const handleDateClick = (date) => {
    try {
      if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
        console.warn('Invalid date in handleDateClick:', date);
        return;
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –±—ã—Å—Ç—Ä—É—é –∫–Ω–æ–ø–∫—É
    setActiveQuickSelect(null);
    
      // –ï—Å–ª–∏ —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω–µ—á–Ω—É—é
      if (dateRange.start && !dateRange.end) {
        if (date >= dateRange.start) {
          setDateRange(prev => ({ ...prev, end: date }));
      } else {
          // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ —Ä–∞–Ω—å—à–µ –Ω–∞—á–∞–ª—å–Ω–æ–π, –º–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
          setDateRange({ start: date, end: dateRange.start });
        }
      } else {
        // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
        setDateRange({ start: date, end: null });
        setSelectedDates([]);
      }
    } catch (error) {
      console.error('Error in handleDateClick:', error);
    }
  };

  const isDateSelected = (date) => {
    if (!date) return false;
    const dateStr = date.toISOString().split('T')[0];
    return selectedDates.includes(dateStr);
  };

  const isDateInRange = (date) => {
    try {
      if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
        return false;
      }
      
      if (!dateRange.start || !(dateRange.start instanceof Date) || isNaN(dateRange.start.getTime())) {
        return false;
      }
      
    const dateStr = date.toISOString().split('T')[0];
    const startStr = dateRange.start.toISOString().split('T')[0];
      
      if (!dateRange.end || !(dateRange.end instanceof Date) || isNaN(dateRange.end.getTime())) {
        // –ï—Å–ª–∏ –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—å–Ω—É—é
        return dateStr === startStr;
      }
      
    const endStr = dateRange.end.toISOString().split('T')[0];
    return dateStr >= startStr && dateStr <= endStr;
    } catch (error) {
      console.error('Error in isDateInRange:', error);
      return false;
    }
  };

  const nextMonth = () => {
    setCurrentMonth(prev => {
      const next = new Date(prev);
      next.setMonth(next.getMonth() + 1);
      return next;
    });
  };

  const prevMonth = () => {
    setCurrentMonth(prev => {
      const prevMonth = new Date(prev);
      prevMonth.setMonth(prevMonth.getMonth() - 1);
      return prevMonth;
    });
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–π —Å–µ—Ç–∫–∏
  const generateCalendarDays = (month) => {
    try {
      if (!month || !(month instanceof Date) || isNaN(month.getTime())) {
        console.warn('Invalid month parameter:', month);
        return [];
      }
    
    const year = month.getFullYear();
    const monthIndex = month.getMonth();
    const firstDay = new Date(year, monthIndex, 1);
    const lastDay = new Date(year, monthIndex + 1, 0);
      
      // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ (1) –≤–º–µ—Å—Ç–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è (0)
      const firstDayOfWeek = firstDay.getDay();
    const startDate = new Date(firstDay);
      const daysToSubtract = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
      startDate.setDate(startDate.getDate() - daysToSubtract);
    
    const days = [];
    const currentDate = new Date(startDate);
    
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 42 –¥–Ω—è (6 –Ω–µ–¥–µ–ª—å)
    for (let i = 0; i < 42; i++) {
      days.push(new Date(currentDate));
      currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return days;
    } catch (error) {
      console.error('Error in generateCalendarDays:', error);
      return [];
    }
  };

  const getDayClass = (date) => {
    try {
      if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
        return "w-8 h-8 rounded hover:bg-gray-100 text-center text-xs cursor-pointer";
      }
      
      if (!currentMonth || !(currentMonth instanceof Date) || isNaN(currentMonth.getTime())) {
        return "w-8 h-8 rounded hover:bg-gray-100 text-center text-xs cursor-pointer";
      }
    
    const today = new Date();
    const isToday = date.toDateString() === today.toDateString();
    const isCurrentMonth = date.getMonth() === currentMonth.getMonth();
    const isInRange = isDateInRange(date);
    
      let classes = "w-8 h-8 rounded hover:bg-gray-100 text-center text-xs cursor-pointer transition-colors";
    
    if (!isCurrentMonth) {
      classes += " text-gray-300";
    } else if (isInRange) {
        if (date.toDateString() === dateRange.start?.toDateString() || 
            (dateRange.end && date.toDateString() === dateRange.end.toDateString())) {
          // –ù–∞—á–∞–ª—å–Ω–∞—è –∏–ª–∏ –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
          classes += " bg-[#0084FF] text-white hover:bg-[#0073E6]";
        } else {
          // –î–∞—Ç—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
          classes += " bg-[#0084FF]/20 text-[#0084FF] hover:bg-[#0084FF]/30";
        }
    } else if (isToday) {
      classes += " bg-gray-200 text-gray-800";
    }
    
    return classes;
    } catch (error) {
      console.error('Error in getDayClass:', error);
      return "w-8 h-8 rounded hover:bg-gray-100 text-center text-xs cursor-pointer";
    }
  };
        </head>
        <body>
          <table border="1">
            <thead>
              <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${data.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
            </tbody>
          </table>
        </body>
      </html>
    `;
    
    const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `dialogs_${new Date().toISOString().split('T')[0]}.xls`;
    link.click();
  };

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  useEffect(() => {
    if (isLoggedIn && currentUser) {
      const hasShownSetupWizard = localStorage.getItem('hasShownSetupWizard');
      const isNewUser = localStorage.getItem('isNewUser');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø–∞–ø —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –ø–æ–ø–∞–ø –µ—â–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è
      if (isNewUser === 'true' && !hasShownSetupWizard) {
        setIsFirstTimeUser(true);
        // setShowSetupWizard(true); // –û—Ç–∫–ª—é—á–µ–Ω –ø–æ–ø–∞–ø –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò-–∞–≥–µ–Ω—Ç–∞
        localStorage.removeItem('isNewUser'); // –£–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      }
    }
  }, [isLoggedIn, currentUser]);

  // –¢–∞–π–º–µ—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏
  useEffect(() => {
    let interval;
    if (showModelSetupProgress && modelSetupTimer > 0) {
      interval = setInterval(() => {
        setModelSetupTimer(prev => {
          if (prev <= 1) {
            setShowModelSetupProgress(false);
            setModelSetupTimer(300);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [showModelSetupProgress, modelSetupTimer]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const getOrCreateUser = async () => {
    if (!isLoggedIn || !currentUser) return null;
    
    try {
      // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–æ—Ä–º—ã
      const userData = {
        email: currentUser.email || `user${currentUser.id}@example.com`,
        name: currentUser.name || `User ${currentUser.id}`,
        company_name: currentUser.company_name || '',
        phone: currentUser.phone || '',
        company_field: currentUser.company_field || ''
      };
      
      const user = await users.createOrGetUser(currentUser.id, userData);
      return user;
    } catch (error) {
      console.error('Error getting/creating user:', error);
      return null;
    }
  };

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Supabase –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π ai-agent-system
  const initializeAiAgent = async (userId, assistantId) => {
    try {
      console.log('ü§ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã ai-agent-system...');
      
      // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–∞
      const settingsResponse = await fetch(`${API_CONFIG.BASE_URL}/api/agent/settings/${assistantId}`, {
        headers: {
          'x-user-id': userId,
          'Content-Type': 'application/json'
        }
      });
      
      if (settingsResponse.ok) {
        const settings = await settingsResponse.json();
        console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', settings);
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–Ω–∞–Ω–∏–π
      const knowledgeResponse = await fetch('${API_CONFIG.BASE_URL}/api/knowledge/sources', {
        headers: {
          'x-user-id': userId,
          'Content-Type': 'application/json'
        }
      });
      
      if (knowledgeResponse.ok) {
        const knowledge = await knowledgeResponse.json();
        console.log('‚úÖ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', knowledge);
      }
      
      setAiAgentInitialized(true);
      console.log('üéâ –°–∏—Å—Ç–µ–º–∞ ai-agent-system –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ai-agent-system:', error);
    }
  };

  const sendMessageToAiAgent = async (message, userId, assistantId, conversationHistory = []) => {
    return ChatUtils.retryApiRequest(async () => {
      // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è AI
      const formattedHistory = conversationHistory
        .filter(msg => msg.type === 'user' || msg.type === 'assistant')
        .map(msg => ({
          role: msg.type === 'user' ? 'user' : 'assistant',
          content: msg.text
        }));

      const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.CHAT_ENDPOINT}`, {
        method: 'POST',
        headers: {
          'x-user-id': userId || currentUser?.id || 'test-user-id',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: message,
          assistantId: assistantId || userId || currentUser?.id || 'test-user-id',
          conversationId: `conv_${userId || currentUser?.id || 'test-user-id'}_${assistantId || userId || currentUser?.id || 'test-user-id'}`,
          conversationHistory: formattedHistory
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        return result;
      } else {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
    }, {
      maxRetries: 2,
      baseDelay: 1000,
      retryCondition: (error) => {
        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫, —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ 5xx —Å—Ç–∞—Ç—É—Å–æ–≤
        return !error.response || 
               error.response.status >= 500 || 
               error.message.includes('timeout') ||
               error.message.includes('NetworkError');
      }
    }).catch(error => {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ retry:', error);
      return { success: false, error: error.message };
    });
  };

  useEffect(() => {
    const loadUserData = async () => {
      if (isLoggedIn && currentUser) {
        try {
          // –°–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
          const connectionTest = await testConnection();
          console.log('Supabase connection test result:', connectionTest);
          
          if (!connectionTest) {
            console.warn('Supabase connection failed, using localStorage fallback');
            throw new Error('Connection failed');
          }

          // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          const user = await getOrCreateUser();
          if (!user) {
            console.warn('Failed to get/create user, using localStorage fallback');
            throw new Error('User creation failed');
          }

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∏–∑ Supabase
          console.log('Loading corrections for user:', currentUser.id);
          const corrections = await botCorrectionsAPI.getCorrections(currentUser.id);
          console.log('Loaded corrections from Supabase:', corrections);
          console.log('Number of corrections loaded:', corrections.length);
          
          const formattedCorrections = corrections.map(item => ({
            id: item.id,
            correction: item.correction,
            created_at: item.created_at
          }));
          console.log('Formatted corrections:', formattedCorrections);
          setBotCorrections(formattedCorrections);
          console.log('botCorrections state set to:', formattedCorrections);

          // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏–∑ Supabase
          const knowledgeItems = await knowledgeBase.getKnowledgeItems(currentUser.id);
          setKnowledgeItems(knowledgeItems);
          setHasKnowledgeBase(knowledgeItems.length > 0);
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º selectedNicheId –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
          if (knowledgeItems.length > 0 && knowledgeItems[0].nicheId && !selectedNicheId) {
            console.log('=== RESTORING NICHE FROM KNOWLEDGE ITEMS ===');
            console.log('First knowledge item:', knowledgeItems[0]);
            console.log('Restoring nicheId:', knowledgeItems[0].nicheId);
            setSelectedNicheId(knowledgeItems[0].nicheId);
            setNewKnowledgeItem(prev => ({ ...prev, nicheId: knowledgeItems[0].nicheId }));
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –≤ setupData –¥–ª—è –ò–ò –∞–≥–µ–Ω—Ç–∞
          setSetupData(prev => ({
            ...prev,
            knowledgeItems: knowledgeItems.map(item => ({
              type: item.source_type || item.type,
              content: item.processed_content || item.original_content || item.content,
              structured_data: item.structured_data
            }))
          }));

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –∏–∑ Supabase
          try {
            console.log('Loading chat history for user:', currentUser.id);
            const chatHistoryData = await chatHistoryAPI.getChatHistory(currentUser.id);
            console.log('Loaded chat history:', chatHistoryData);
            if (chatHistoryData && chatHistoryData.length > 0) {
              const formattedHistory = chatHistoryData.map((item, index) => ({
                type: item.role === 'user' ? 'user' : 'assistant',
                text: item.message_content,
                time: updateMessageTime(item.created_at ? new Date(item.created_at).getTime() : Date.now()),
                timestamp: item.created_at ? new Date(item.created_at).getTime() : Date.now() + index,
                id: `loaded_${item.id || index}_${Date.now()}`
              }));
              console.log('Formatted chat history:', formattedHistory);
              setChatHistory(formattedHistory);
              // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
              ChatUtils.scrollToBottom(chatHistoryRef, 300);
            } else {
              console.log('No chat history found, using default welcome message');
              // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
              setChatHistory([
                { type: 'assistant', text: '–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Adapto. –ö–∞–∫ –¥–µ–ª–∞?', time: '–¢–æ–ª—å–∫–æ —á—Ç–æ', timestamp: Date.now() }
              ]);
              // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
              ChatUtils.scrollToBottom(chatHistoryRef, 300);
            }
          } catch (error) {
            console.error('Error loading chat history:', error);
            // Fallback –∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            setChatHistory([
              { type: 'assistant', text: '–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Adapto. –ö–∞–∫ –¥–µ–ª–∞?' }
            ]);
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –ø–æ—Å–ª–µ fallback
            ChatUtils.scrollToBottom(chatHistoryRef, 300);
          }

          // –ó–∞–≥—Ä—É–∂–∞–µ–º CRM –¥–∞–Ω–Ω—ã–µ –∏–∑ Supabase
          try {
            console.log('Loading CRM data for user:', currentUser.id);
            console.log('Current user object:', currentUser);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
            const clients = await crmAPI.getClients(currentUser.id);
            console.log('Loaded clients from Supabase:', clients);
            console.log('Clients count:', clients.length);
            console.log('First client:', clients[0]);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–¥–µ–ª–∫–∏
            const deals = await crmAPI.getDeals(currentUser.id);
            console.log('Loaded deals from Supabase:', deals);
            console.log('Deals count:', deals.length);
            console.log('First deal:', deals[0]);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏
            const tasks = await crmAPI.getTasks(currentUser.id);
            console.log('Loaded tasks from Supabase:', tasks);
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç, –æ–∂–∏–¥–∞–µ–º—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
            const formattedDeals = deals.map(deal => ({
              id: deal.id,
              title: deal.title,
              company: deal.crm_clients?.company || '',
              amount: deal.amount || 0,
              days: 0, // –õ–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
              stage: deal.stage || '–ù–æ–≤—ã–µ',
              leadQuality: deal.lead_quality || 'medium',
              hasContacts: !!(deal.crm_clients?.email || deal.crm_clients?.phone),
              owner: deal.owner || 'ai',
              ownerName: deal.owner_name || '–ò–ò-–∞–≥–µ–Ω—Ç',
              isResolved: deal.is_resolved || false,
              client: {
                name: deal.crm_clients?.name || '',
                email: deal.crm_clients?.email || '',
                phone: deal.crm_clients?.phone || '',
                company: deal.crm_clients?.company || ''
              },
              notes: deal.description || '',
              createdDate: deal.created_at ? deal.created_at.split('T')[0] : new Date().toISOString().split('T')[0],
              lastContact: deal.created_at ? deal.created_at.split('T')[0] : new Date().toISOString().split('T')[0], // –ò—Å–ø–æ–ª—å–∑—É–µ–º created_at –≤–º–µ—Å—Ç–æ last_contact_at
              dialogId: deal.dialog_id
            }));
            
            const formattedTasks = tasks.map(task => ({
              id: task.id,
              title: task.title,
              description: task.description || '',
              assignee: task.assignee || 'operator-1',
              assigneeName: task.assignee_name || '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
              priority: task.priority || 'medium',
              status: task.status || '–ù–æ–≤—ã–µ',
              dueDate: task.due_date ? task.due_date.split('T')[0] : '',
              dealId: task.deal_id,
              notes: task.result || '',
              createdBy: task.created_by || '–ò–ò-–∞–≥–µ–Ω—Ç',
              createdDate: task.created_at ? task.created_at.split('T')[0] : new Date().toLocaleDateString('ru-RU')
            }));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ CRM –¥–∞–Ω–Ω—ã—Ö
            console.log('Setting deals:', formattedDeals.length);
            console.log('Setting clients:', clients.length);
            console.log('Formatted deals:', formattedDeals);
            setDeals(formattedDeals);
            setTasks(formattedTasks);
            setClients(clients);
            
            console.log('CRM data loaded successfully:', {
              deals: formattedDeals.length,
              tasks: formattedTasks.length
            });
            
          } catch (error) {
            console.error('Error loading CRM data:', error);
            // Fallback –∫ localStorage –µ—Å–ª–∏ Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            const savedDeals = localStorage.getItem(`deals_${currentUser.id}`);
            if (savedDeals) {
              setDeals(JSON.parse(savedDeals));
            }
            
            const savedTasks = localStorage.getItem(`tasks_${currentUser.id}`);
            if (savedTasks) {
              setTasks(JSON.parse(savedTasks));
            }
          }
        } catch (error) {
          console.error('Error loading user data:', error);
          // Fallback –∫ localStorage –µ—Å–ª–∏ Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
          const savedCorrections = localStorage.getItem(`botCorrections_${currentUser.id}`);
          if (savedCorrections) {
            setBotCorrections(JSON.parse(savedCorrections));
          }

          const savedKnowledgeItems = localStorage.getItem(`knowledgeItems_${currentUser.id}`);
          if (savedKnowledgeItems) {
            const items = JSON.parse(savedKnowledgeItems);
            setKnowledgeItems(items);
            setHasKnowledgeBase(items.length > 0);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º selectedNicheId –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (items.length > 0 && items[0].nicheId && !selectedNicheId) {
              console.log('=== RESTORING NICHE FROM LOCALSTORAGE ===');
              console.log('First localStorage item:', items[0]);
              console.log('Restoring nicheId:', items[0].nicheId);
              setSelectedNicheId(items[0].nicheId);
              setNewKnowledgeItem(prev => ({ ...prev, nicheId: items[0].nicheId }));
            }
          }

          // Fallback: –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –∏–∑ localStorage
          const savedChatHistory = localStorage.getItem(`chatHistory_${currentUser.id}`);
          if (savedChatHistory) {
            setChatHistory(JSON.parse(savedChatHistory));
          } else {
            setChatHistory([
              { type: 'assistant', text: '–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Adapto. –ö–∞–∫ –¥–µ–ª–∞?' }
            ]);
          }

          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          try {
            const statusResult = await operatorStatusAPI.getOperatorStatus(currentUser.id);
            if (statusResult.success) {
              setIsOnline(statusResult.isOnline);
            } else {
              console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage –∫–∞–∫ fallback');
              const savedOperatorStatus = localStorage.getItem(`operatorStatus_${currentUser.id}`);
              if (savedOperatorStatus !== null) {
                setIsOnline(JSON.parse(savedOperatorStatus));
              }
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            // Fallback to localStorage
            const savedOperatorStatus = localStorage.getItem(`operatorStatus_${currentUser.id}`);
            if (savedOperatorStatus !== null) {
              setIsOnline(JSON.parse(savedOperatorStatus));
            }
          }


          // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          try {
            console.log('Loading user profile data for:', currentUser.id);
            const { data: userProfile, error: profileError } = await supabase
              .from('users')
              .select('name, email, company_name, phone, company_field')
              .eq('id', currentUser.id)
              .single();
            
            if (profileError) {
              console.error('Error loading user profile:', profileError);
            } else if (userProfile) {
              console.log('Loaded user profile:', userProfile);
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ personalInfo
              setPersonalInfo({
                name: userProfile.name || currentUser.name || '',
                email: userProfile.email || currentUser.email || '',
                company: userProfile.company_name || '',
                phone: userProfile.phone || '',
                newPassword: '',
                confirmPassword: ''
              });
              setOriginalPersonalInfo({
                name: userProfile.name || currentUser.name || '',
                email: userProfile.email || currentUser.email || '',
                company: userProfile.company_name || '',
                phone: userProfile.phone || ''
              });
            }
          } catch (error) {
            console.error('Error loading user profile:', error);
          }

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É ai-agent-system
          if (currentUser && currentUser.id) {
            const assistantId = currentUser.id; // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ assistantId
            initializeAiAgent(currentUser.id, assistantId);
          }
        }
      }
    };

    loadUserData();
  }, [isLoggedIn, currentUser]);

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ CRM –¥–∞–Ω–Ω—ã—Ö –≤ localStorage –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
  useEffect(() => {
    if (currentUser && deals.length > 0) {
      localStorage.setItem(`deals_${currentUser.id}`, JSON.stringify(deals));
    }
  }, [deals, currentUser]);

  useEffect(() => {
    if (currentUser && tasks.length > 0) {
      localStorage.setItem(`tasks_${currentUser.id}`, JSON.stringify(tasks));
    }
  }, [tasks, currentUser]);

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  useEffect(() => {
    if (currentUser && isOnline !== undefined) {
      // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      operatorStatusAPI.updateOperatorStatus(currentUser.id, isOnline)
        .then(result => {
          if (result.success) {
            console.log('–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:', result.isOnline);
          } else {
            console.warn('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ –ë–î, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage:', result.error);
            localStorage.setItem(`operatorStatus_${currentUser.id}`, JSON.stringify(isOnline));
          }
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
          // Fallback to localStorage
          localStorage.setItem(`operatorStatus_${currentUser.id}`, JSON.stringify(isOnline));
        });
    }
  }, [isOnline, currentUser]);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —à–∞–≥–æ–≤ –≤ –±–ª–æ–∫–µ "–ó–∞–ø—É—Å–∫ Adapto"
  useEffect(() => {
    if (!isLoggedIn || !currentUser) return;

    const checkStepCompletion = () => {
      const newCompletedSteps = [];

      // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ò–ò-–º–æ–¥–µ–ª–∏
      // –°—á–∏—Ç–∞–µ–º —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      if (setupData.task && setupData.mainGoal && setupData.addressing && setupData.communicationStyle) {
        newCompletedSteps.push(1);
      }

      // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
      if (hasKnowledgeBase && knowledgeItems.length > 0) {
        newCompletedSteps.push(2);
      }

      // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤–∏–¥–∂–µ—Ç–∞
      // –°—á–∏—Ç–∞–µ–º —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
      if (widgetDevelopmentSettings.accentColor && 
          widgetDevelopmentSettings.buttonText && 
          widgetDevelopmentSettings.buttonColor) {
        newCompletedSteps.push(3);
      }

      setCompletedSteps(newCompletedSteps);

      // –ï—Å–ª–∏ –≤—Å–µ 3 —à–∞–≥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫
      if (newCompletedSteps.length === 3) {
        setShowSetupGuide(false);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∏–ª –Ω–∞—Å—Ç—Ä–æ–π–∫—É
        localStorage.setItem(`setupCompleted_${currentUser.id}`, 'true');
      }
    };

    checkStepCompletion();
  }, [isLoggedIn, currentUser, setupData, hasKnowledgeBase, knowledgeItems, widgetDevelopmentSettings]);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ä–∞–Ω–µ–µ
  useEffect(() => {
    if (isLoggedIn && currentUser) {
      const setupCompleted = localStorage.getItem(`setupCompleted_${currentUser.id}`);
      if (setupCompleted === 'true') {
        setShowSetupGuide(false);
      }
    }
  }, [isLoggedIn, currentUser]);

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  useEffect(() => {
    if (isLoggedIn && currentUser) {
      localStorage.setItem(`botCorrections_${currentUser.id}`, JSON.stringify(botCorrections));
    }
  }, [botCorrections, isLoggedIn, currentUser]);


  // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  useEffect(() => {
    const loadModelSettings = async () => {
      if (activeSection === 'model-settings' && isLoggedIn && currentUser) {
        try {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          console.log('Loading model settings from database for user:', currentUser.id);
          const dbSettings = await modelSettings.getModelSettings(currentUser.id);
          console.log('Loaded settings from DB:', dbSettings);
          
          if (dbSettings) {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ getModelSettings
            console.log('Loaded settings from DB:', dbSettings);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
            setSetupData(prevData => ({
              ...prevData,
              ...dbSettings
            }));
            
            console.log('Model settings loaded and applied to state');
          } else {
            console.log('No model settings found in database, using defaults');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const defaultSettings = modelSettings.getDefaultSettings();
            setSetupData(prevData => ({
              ...prevData,
              ...defaultSettings
            }));
          }
        } catch (error) {
          console.error('Error loading model settings:', error);
          showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
          // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          const defaultSettings = modelSettings.getDefaultSettings();
          setSetupData(prevData => ({
            ...prevData,
            ...defaultSettings
          }));
        }
      }
    };
    
    const loadWidgetSettings = async () => {
      if (activeSection === 'widget-development' && isLoggedIn && currentUser) {
        try {
          console.log('Loading widget settings from database for user:', currentUser.id);
          
          // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ supabaseClient
          const { widgetDevelopmentSettings } = await import('./supabaseClient.js');
          const dbWidgetSettings = await widgetDevelopmentSettings.getWidgetDevelopmentSettings(currentUser.id);
          console.log('Loaded widget settings from DB:', dbWidgetSettings);
          
          if (dbWidgetSettings && Object.keys(dbWidgetSettings).length > 0) {
            console.log('=== LOADING WIDGET SETTINGS TO STATE ===');
            console.log('DB Settings:', dbWidgetSettings);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ widgetDevelopmentSettings
            const newWidgetSettings = {
              // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
              accentColor: dbWidgetSettings.accent_color || '#0084FF',
              buttonColor: dbWidgetSettings.button_color || 'custom',
              buttonText: dbWidgetSettings.button_text || '–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º',
              buttonSubtext: dbWidgetSettings.button_subtext || '–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
              avatar: dbWidgetSettings.avatar || 'default',
              customButtonColor: dbWidgetSettings.custom_button_color || '#0084FF',
              widgetLocation: dbWidgetSettings.widget_location || 'default',
              
              // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
              desktopBottomOffset: dbWidgetSettings.desktop_bottom_offset || 20,
              desktopRightOffset: dbWidgetSettings.desktop_right_offset || 20,
              mobileBottomOffset: dbWidgetSettings.mobile_bottom_offset || 20,
              mobileRightOffset: dbWidgetSettings.mobile_right_offset || 20,
              zIndex: dbWidgetSettings.z_index || 9999,
              
              // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
              welcomeMessages: dbWidgetSettings.welcome_messages || ['–ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç Adapto, —è –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.'],
              
              // –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
              triggerQuestion: dbWidgetSettings.trigger_question || '–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
              triggerQuestionEnabled: dbWidgetSettings.trigger_question_enabled || 'no',
              triggerQuestionDelay: dbWidgetSettings.trigger_question_delay || 5,
              triggerQuestionText: dbWidgetSettings.trigger_question_text || '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ï—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è –≤–æ–ø—Ä–æ—Å, –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –µ–≥–æ –≤ —á–∞—Ç–µ, —è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –æ—Ç–≤–µ—á—É',
              triggerQuickReply: dbWidgetSettings.trigger_quick_reply || '–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
              
              // –î–æ–≥–æ–Ω—è—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
              followUpMessage: dbWidgetSettings.follow_up_message || 'no',
              followUpDelay: dbWidgetSettings.follow_up_delay || 10,
              followUpQuestion: dbWidgetSettings.follow_up_question || '–ü—Ä–æ–¥–æ–ª–∂–∏–º –¥–∏–∞–ª–æ–≥?',
              followUpQuickReply: dbWidgetSettings.follow_up_quick_reply || '–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ',
              
              // –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
              quickReplies: dbWidgetSettings.quick_replies || ['–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ'],
              
              // –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
              privacyPolicyUrl: dbWidgetSettings.privacy_policy_url || 'https://',
              
              // –¢–µ–≥–∏ –¥–∞–Ω–Ω—ã—Ö
              dataTags: dbWidgetSettings.data_tags || ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'roistat_visit', 'gclid', 'fbclid'],
              
              // –ò—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
              excludedPages: dbWidgetSettings.excluded_pages || [],
              
              // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –≤–∏–¥–∂–µ—Ç–∞
              widgetMode: dbWidgetSettings.widget_mode || 'chat',
              
              // –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã
              quickQuestions: dbWidgetSettings.quick_questions || [
                { question: '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∞—à —Å–µ—Ä–≤–∏—Å?', answer: '–ù–∞—à —Å–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ò–ò –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ–±—â–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏.' },
                { question: '–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?', answer: '–£ –Ω–∞—Å –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤. –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω —Å—Ç–æ–∏—Ç 2990‚ÇΩ –≤ –º–µ—Å—è—Ü.' },
                { question: '–ï—Å—Ç—å –ª–∏ –¥–µ–º–æ?', answer: '–î–∞, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–º–æ-–≤–µ—Ä—Å–∏—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π.' }
              ],
              
              // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º—ã –∑–∞—è–≤–∫–∏
              leadFormEnabled: dbWidgetSettings.lead_form_enabled === true || dbWidgetSettings.lead_form_enabled === 'yes',
              leadFormTitle: dbWidgetSettings.lead_form_title || '–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É',
              leadFormDescription: dbWidgetSettings.lead_form_description || '–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è',
              leadFormFields: dbWidgetSettings.lead_form_fields || [
                { name: 'name', label: '–ò–º—è', type: 'text', required: true },
                { name: 'phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'tel', required: true },
                { name: 'email', label: 'Email', type: 'email', required: false }
              ],
              
              // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞
              widgetTheme: dbWidgetSettings.widget_theme || 'light',
              widgetSize: dbWidgetSettings.widget_size || 'medium',
              showAvatar: dbWidgetSettings.show_avatar !== undefined ? dbWidgetSettings.show_avatar : true,
              showTypingIndicator: dbWidgetSettings.show_typing_indicator !== undefined ? dbWidgetSettings.show_typing_indicator : true,
              
              // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è
              autoOpenOnScroll: dbWidgetSettings.auto_open_on_scroll !== undefined ? dbWidgetSettings.auto_open_on_scroll : false,
              autoOpenDelay: dbWidgetSettings.auto_open_delay || 0,
              showOnMobile: dbWidgetSettings.show_on_mobile !== undefined ? dbWidgetSettings.show_on_mobile : true,
              
              // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
              notificationSound: dbWidgetSettings.notification_sound !== undefined ? dbWidgetSettings.notification_sound : true,
              notificationTitle: dbWidgetSettings.notification_title || '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
              
              // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
              trackEvents: dbWidgetSettings.track_events !== undefined ? dbWidgetSettings.track_events : true,
              trackConversions: dbWidgetSettings.track_conversions !== undefined ? dbWidgetSettings.track_conversions : true,
              
              // –õ–æ–≥–æ—Ç–∏–ø
              logoUrl: dbWidgetSettings.logo_url || '',
              logoName: dbWidgetSettings.logo_name || '',
              
              // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
              suggestions: dbWidgetSettings.suggestions || []
            };
            
            console.log('New widget settings to set:', newWidgetSettings);
            setWidgetSettings(newWidgetSettings);
            console.log('Widget settings loaded successfully from database');
          } else {
            console.log('No widget settings found in database, using defaults');
          }
        } catch (error) {
          console.error('Error loading widget settings from database:', error);
          showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–∏–¥–∂–µ—Ç–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
        }
      }
    };
    
    loadModelSettings();
    loadWidgetSettings();
  }, [activeSection, isLoggedIn, currentUser]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª
  useEffect(() => {
    if (activeSection === 'knowledge' && isLoggedIn && currentUser) {
      const savedKnowledgeItems = localStorage.getItem(`knowledgeItems_${currentUser.id}`);
      if (savedKnowledgeItems) {
        try {
          const items = JSON.parse(savedKnowledgeItems);
          setKnowledgeItems(items);
          setHasKnowledgeBase(items.length > 0);
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º selectedNicheId –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
          if (items.length > 0 && items[0].nicheId && !selectedNicheId) {
            console.log('=== RESTORING NICHE FROM LOCALSTORAGE (SECTION) ===');
            console.log('First localStorage item:', items[0]);
            console.log('Restoring nicheId:', items[0].nicheId);
            setSelectedNicheId(items[0].nicheId);
            setNewKnowledgeItem(prev => ({ ...prev, nicheId: items[0].nicheId }));
          }
        } catch (error) {
          console.error('Error loading knowledge items:', error);
        }
      }
    }
  }, [activeSection, isLoggedIn, currentUser]);

  useEffect(() => {
    if (isLoggedIn && currentUser) {
      localStorage.setItem(`knowledgeItems_${currentUser.id}`, JSON.stringify(knowledgeItems));
      setHasKnowledgeBase(knowledgeItems.length > 0);
    }
  }, [knowledgeItems, isLoggedIn, currentUser]);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  useEffect(() => {
    const chatContainer = document.querySelector('.chat-history-container');
    if (chatContainer) {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
  }, [chatHistory]);

  useEffect(() => {
    const widgetChatContainer = document.querySelector('.widget-chat-container');
    if (widgetChatContainer) {
      widgetChatContainer.scrollTop = widgetChatContainer.scrollHeight;
    }
  }, [chatMessages]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
  const updateMessageTime = (timestamp) => {
    const now = new Date();
    const messageTime = new Date(timestamp);
    const diffInMinutes = Math.floor((now - messageTime) / (1000 * 60));
    
    if (diffInMinutes < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
    if (diffInMinutes < 60) return `${diffInMinutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
    if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)} —á –Ω–∞–∑–∞–¥`;
    return `${Math.floor(diffInMinutes / 1440)} –¥–Ω –Ω–∞–∑–∞–¥`;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–∞—Ç—ã
  const getDateHeader = (timestamp) => {
    const now = new Date();
    const messageDate = new Date(timestamp);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–∞—Ç
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const messageDay = new Date(messageDate.getFullYear(), messageDate.getMonth(), messageDate.getDate());
    
    if (messageDay.getTime() === today.getTime()) {
      return '–°–µ–≥–æ–¥–Ω—è';
    } else if (messageDay.getTime() === yesterday.getTime()) {
      return '–í—á–µ—Ä–∞';
    } else {
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∫–∞–∫ "9 —Å–µ–Ω—Ç—è–±—Ä—è"
      const months = [
        '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
        '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
      ];
      return `${messageDate.getDate()} ${months[messageDate.getMonth()]}`;
    }
  };

  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
  useEffect(() => {
    const interval = setInterval(() => {
      setChatHistory(prev => prev.map(msg => ({
        ...msg,
        time: msg.timestamp ? updateMessageTime(msg.timestamp) : msg.time
      })));
      
      setChatMessages(prev => prev.map(msg => ({
        ...msg,
        time: msg.timestamp ? updateMessageTime(msg.timestamp) : msg.time
      })));
    }, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    if (isLoggedIn && currentUser) {
      localStorage.setItem(`chatHistory_${currentUser.id}`, JSON.stringify(chatHistory));
    }
  }, [chatHistory, isLoggedIn, currentUser]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const getRegisteredUsers = () => {
    const users = localStorage.getItem('registeredUsers');
    return users ? JSON.parse(users) : [];
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const saveRegisteredUsers = (users) => {
    localStorage.setItem('registeredUsers', JSON.stringify(users));
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π)
  const clearUserData = () => {
    localStorage.removeItem('currentUser');
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('currentSection');
    setCurrentUser(null);
    setIsLoggedIn(false);
    setCurrentStep('login');
    showNotificationMessage('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—á–∏—â–µ–Ω—ã. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.');
  };

  // –ê–¥–º–∏–Ω—Å–∫–∏–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–≤—Ä–µ–º–µ–Ω–Ω–æ —Ö–∞—Ä–¥–∫–æ–¥)
  const ADMIN_CREDENTIALS = {
    email: 'admin@adapto.ai',
    password: 'admin123',
    name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
    role: 'super_admin',
    id: 'admin-uuid-12345'
  };

  // –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  const handleAdminLogin = async (email, password) => {
    if (email === ADMIN_CREDENTIALS.email && password === ADMIN_CREDENTIALS.password) {
      setCurrentUser(ADMIN_CREDENTIALS);
      setIsLoggedIn(true);
      setCurrentStep('dashboard');
      setActiveSection('main');
      localStorage.setItem('currentUser', JSON.stringify(ADMIN_CREDENTIALS));
      localStorage.setItem('isLoggedIn', 'true');
      localStorage.setItem('currentSection', 'main');
      showNotificationMessage('–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
      return true;
    }
    return false;
  };

  // üîê Auth functions –ë–ï–ó localStorage
  const handleLogin = async (userData) => {
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Supabase
      setCurrentUser({
        ...userData,
        role: userData.role || 'user'
      });
      setIsLoggedIn(true);
      setCurrentStep('dashboard');
      setActiveSection('main');
      showNotificationMessage('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É!');
    } catch (error) {
      console.error('Login error:', error);
    }
  };

  const handleLoginSubmit = async (e) => {
    e.preventDefault();
    setFormErrors({});

    console.log('üîë Login attempt:', { email: formData.email, hasPassword: !!formData.password });

    if (!formData.email || !formData.password) {
      console.error('‚ùå Missing email or password');
      setFormErrors({ general: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è' });
      return;
    }

    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const isAdminLogin = await handleAdminLogin(formData.email, formData.password);
    if (isAdminLogin) {
      console.log('‚úÖ Admin login successful');
      return;
    }

    try {
      console.log('üöÄ Attempting Supabase login...');
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é login
      const { login } = await import('./utils/auth.js');
      const { success, user, error } = await login(formData.email, formData.password);

      if (!success) {
        console.error('‚ùå Login failed:', error);
        setFormErrors({ general: error });
        return;
      }

      console.log('‚úÖ Login successful, user:', user);
      // –í—Ö–æ–¥–∏–º –≤ —Å–∏—Å—Ç–µ–º—É —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã
      await handleLogin(user);
    } catch (error) {
      console.error('‚ùå Login error:', error);
      setFormErrors({ general: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ' });
    }
  };

  const handleRegisterSubmit = async (e) => {
    e.preventDefault();
    setFormErrors({});

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
    if (!formData.name || !formData.company || !formData.email || !formData.phone || !formData.password) {
      setFormErrors({ general: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è' });
      return;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phoneError = validatePhone(formData.phone);
    if (phoneError) {
      setValidationErrors({ ...validationErrors, phone: phoneError });
      return;
    }

    try {
      console.log('üöÄ –®–ê–ì 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Supabase Auth...');
      // 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Supabase Auth (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è auth)
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: formData.email,
        password: formData.password,
      });

      if (authError) {
        console.error('‚ùå –®–ê–ì 1 FAILED:', authError);
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ email
        if (authError.message.includes('already registered') || 
            authError.message.includes('already exists') ||
            authError.message.includes('User already registered')) {
          setFormErrors({ general: '‚ö†Ô∏è –≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–í—Ö–æ–¥" –∏ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.' });
        } else {
          setFormErrors({ general: authError.message });
        }
        return;
      }

      if (!authData.user) {
        console.error('‚ùå –®–ê–ì 1 FAILED: No user data');
        setFormErrors({ general: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
        return;
      }

      console.log('‚úÖ –®–ê–ì 1 OK: User created:', authData.user.id);
      console.log('Session:', authData.session ? 'Active' : 'Pending confirmation');

      console.log('üöÄ –®–ê–ì 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...');
      // 2. –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–µ–∫—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º admin –∫–ª–∏–µ–Ω—Ç –¥–ª—è bypass RLS)
      const { data: project, error: projectError } = await supabaseAdmin
        .from('projects')
        .insert({
          name: formData.company || `${formData.name}'s Project`,
          description: `–ü—Ä–æ–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${formData.name}`,
          owner_id: authData.user.id
        })
        .select()
        .single();

      if (projectError) {
        console.error('‚ùå –®–ê–ì 2 FAILED:', projectError);
        setFormErrors({ general: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞: ' + projectError.message });
        return;
      }

      console.log('‚úÖ –®–ê–ì 2 OK: Project created:', project.id);

      console.log('üöÄ –®–ê–ì 3: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
      // 3. –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å project_id
      const { error: profileError } = await supabaseAdmin
        .from('users')
        .upsert({
          id: authData.user.id,
          email: formData.email,
          name: formData.name,
          company_name: formData.company,
          phone: formData.phone,
          company_field: formData.companyField || null,
          project_id: project.id
        }, {
          onConflict: 'id'
        });

      if (profileError) {
        console.error('‚ùå –®–ê–ì 3 FAILED:', profileError);
        setFormErrors({ general: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + profileError.message });
        return;
      }

      console.log('‚úÖ –®–ê–ì 3 OK: User profile created');

      console.log('üöÄ –®–ê–ì 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–º–∞–Ω–¥—É –ø—Ä–æ–µ–∫—Ç–∞...');
      // 4. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ project_members
      const { error: memberError } = await supabaseAdmin
        .from('project_members')
        .upsert({
          project_id: project.id,
          user_id: authData.user.id,
          email: formData.email,
          role: 'owner'
        }, {
          onConflict: 'project_id,user_id'
        });

      if (memberError) {
        console.error('‚ùå –®–ê–ì 4 FAILED:', memberError);
        setFormErrors({ general: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ–º–∞–Ω–¥—É –ø—Ä–æ–µ–∫—Ç–∞: ' + memberError.message });
        return;
      }

      console.log('‚úÖ –®–ê–ì 4 OK: Added to project_members');

      console.log('üöÄ –®–ê–ì 5: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...');
      // 5. –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
      const userData = {
        id: authData.user.id,
        name: formData.name,
        company_name: formData.company,
        email: formData.email,
        phone: formData.phone,
        company_field: formData.companyField || null,
        project_id: project.id,
        role: 'user'
      };

      // –°–µ—Å—Å–∏—è —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ supabase.auth.signUp
      setCurrentUser(userData);
      setIsLoggedIn(true);
      setCurrentStep('dashboard');
      setActiveSection('main');
      setIsFirstTimeUser(true);
      
      console.log('‚úÖ –í–°–ï –®–ê–ì–ò –í–´–ü–û–õ–ù–ï–ù–´! –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ dashboard...');
      showNotificationMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Adapto!');
      setFormData({ email: '', password: '', name: '', company: '', phone: '', companyField: '' });
      setValidationErrors({});

    } catch (error) {
      console.error('Registration error:', error);
      setFormErrors({ general: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' });
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é
  const handleOperatorRegisterSubmit = async (e) => {
    e.preventDefault();
    setFormErrors({});

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
    if (!formData.name || !formData.email || !formData.password) {
      setFormErrors({ general: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è' });
      return;
    }

    try {
      // 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Supabase Auth
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: formData.email,
        password: formData.password,
      });

      if (authError) {
        if (authError.message.includes('already registered') || authError.message.includes('already exists')) {
          setFormErrors({ general: '–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' });
        } else {
          setFormErrors({ general: authError.message });
        }
        return;
      }

      if (!authData.user) {
        setFormErrors({ general: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
        return;
      }

      // 2. –ü–æ–ª—É—á–∞–µ–º project_id –∏–∑ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (—á–µ—Ä–µ–∑ inviterId)
      const { data: inviterData } = await supabase
        .from('users')
        .select('project_id')
        .eq('id', inviterId)
        .single();

      if (!inviterData?.project_id) {
        setFormErrors({ general: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç' });
        return;
      }

      // 3. –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      const { error: profileError } = await supabaseAdmin
        .from('users')
        .upsert({
          id: authData.user.id,
          email: formData.email,
          name: formData.name,
          project_id: inviterData.project_id,
          role: 'operator'
        }, {
          onConflict: 'id'
        });

      if (profileError) {
        console.error('Profile creation error:', profileError);
        setFormErrors({ general: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + profileError.message });
        return;
      }

      // 4. –î–æ–±–∞–≤–ª—è–µ–º –≤ project_members
      const { error: memberError } = await supabaseAdmin
        .from('project_members')
        .upsert({
          project_id: inviterData.project_id,
          user_id: authData.user.id,
          email: formData.email,
          role: 'member'
        }, {
          onConflict: 'project_id,user_id'
        });

      if (memberError) {
        console.error('Member creation error:', memberError);
      }

      // 5. –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
      const userData = {
        id: authData.user.id,
        name: formData.name,
        email: formData.email,
        project_id: inviterData.project_id,
        role: 'operator'
      };

      setCurrentUser(userData);
      setIsLoggedIn(true);
      setCurrentStep('dashboard');
      setActiveSection('main');
      showNotificationMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É!');
      setFormData({ email: '', password: '', name: '', company: '', phone: '', companyField: '' });
      setValidationErrors({});
      
      // –û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
      setInviteToken(null);
      setInviterId(null);
    } catch (error) {
      console.error('Operator registration error:', error);
      setFormErrors({ general: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' });
    }
  };

  const handleLogout = async () => {
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é logout
      const { logout } = await import('./utils/auth.js');
      const { success } = await logout();

      if (success) {
        setIsLoggedIn(false);
        setCurrentUser(null);
        setCurrentStep('login');
        setActiveSection('main');
        showNotificationMessage('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
      }
    } catch (error) {
      console.error('Logout error:', error);
      // –í—Å—ë —Ä–∞–≤–Ω–æ –≤—ã—Ö–æ–¥–∏–º –ª–æ–∫–∞–ª—å–Ω–æ
      setIsLoggedIn(false);
      setCurrentUser(null);
      setCurrentStep('login');
      setActiveSection('main');
    }
  };



  const handleBotCorrection = async () => {
    if (!botCorrection.trim()) return;
    
    try {
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      const user = await getOrCreateUser();
      if (!user) {
        showNotificationMessage('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const success = await botCorrectionsAPI.addCorrection(currentUser.id, botCorrection);
      if (success) {
        const newCorrection = {
          id: generateUUID(),
          correction: botCorrection,
          created_at: new Date().toISOString()
        };
        setBotCorrections(prev => [...prev, newCorrection]);
        setBotCorrection('');
        showNotificationMessage('–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
      } else {
        showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏');
      }
    } catch (error) {
      console.error('Error adding correction:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏');
    }
  };

  const removeCorrection = async (index) => {
    try {
      console.log('Removing correction at index:', index);
      const correctionToRemove = botCorrections[index];
      console.log('Correction to remove:', correctionToRemove);
      
      if (correctionToRemove && correctionToRemove.id) {
        console.log('Deleting correction with ID:', correctionToRemove.id);
        const success = await botCorrectionsAPI.deleteCorrection(correctionToRemove.id);
        console.log('Delete result:', success);
        
        if (success) {
          setBotCorrections(prev => prev.filter((_, i) => i !== index));
          showNotificationMessage('–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
        } else {
          showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏');
        }
      } else {
        console.log('No ID found, removing from local state only');
        // –ï—Å–ª–∏ –Ω–µ—Ç ID (–ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞), –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        setBotCorrections(prev => prev.filter((_, i) => i !== index));
        showNotificationMessage('–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
      }
    } catch (error) {
      console.error('Error removing correction:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏');
    }
  };

  const toggleCorrectionVisibility = (index) => {
    setHiddenCorrections(prev => {
      const newSet = new Set(prev);
      if (newSet.has(index)) {
        newSet.delete(index);
      } else {
        newSet.add(index);
      }
      return newSet;
    });
  };

  const toggleCorrectionSelection = (index) => {
    console.log(`toggleCorrectionSelection called with index: ${index}`);
    setSelectedCorrections(prev => {
      const newSet = new Set(prev);
      if (newSet.has(index)) {
        newSet.delete(index);
        console.log(`Removed index ${index} from selection`);
      } else {
        newSet.add(index);
        console.log(`Added index ${index} to selection`);
      }
      console.log('New selection set:', newSet);
      return newSet;
    });
  };

  const toggleCorrectionActivity = async (index) => {
    let newActiveSet;
    
    setActiveCorrections(prev => {
      const newSet = new Set(prev);
      if (newSet.has(index)) {
        newSet.delete(index);
      } else {
        newSet.add(index);
      }
      newActiveSet = newSet;
      return newSet;
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è state
    if (currentUser?.id && newActiveSet) {
      try {
        const activeArray = Array.from(newActiveSet);
        const response = await fetch(`${API_CONFIG.BASE_URL}/api/corrections/active/${currentUser.id}`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ activeCorrections: activeArray })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Active corrections saved:', data);
      } catch (error) {
        console.error('‚ùå Error saving active corrections:', error);
        showNotificationMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫');
      }
    }
  };

  const [isAddingCorrection, setIsAddingCorrection] = useState(false);

  const handleAddCorrection = async () => {
    if (isAddingCorrection || !newCorrectionText.trim() || !currentUser?.id) return;
    
    setIsAddingCorrection(true);
    
    try {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
      const success = await botCorrectionsAPI.addCorrection(currentUser.id, newCorrectionText.trim(), 'admin');
      
      if (success) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const newCorrection = {
          id: generateUUID(), // –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID
          correction: newCorrectionText.trim(),
          created_at: new Date().toISOString()
        };
        setBotCorrections(prev => [...prev, newCorrection]);
        setNewCorrectionText('');
        setShowAddCorrectionForm(false);
        showNotificationMessage('–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
      } else {
        showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏');
      }
    } catch (error) {
      console.error('Error adding correction:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏');
    } finally {
      setIsAddingCorrection(false);
    }
  };

  const handleDeleteCorrections = async () => {
    if (!currentUser?.id) {
      showNotificationMessage('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      setShowDeleteConfirmModal(false);
      return;
    }

    const indicesToRemove = Array.from(selectedCorrections);
    if (indicesToRemove.length === 0) {
      setShowDeleteConfirmModal(false);
      return;
    }

    try {
      // –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î –ø–æ id —Ç–∞–º, –≥–¥–µ –æ–Ω –µ—Å—Ç—å
      for (const idx of indicesToRemove) {
        const correction = botCorrections[idx];
        if (correction && typeof correction.id === 'string' && correction.id) {
          try {
            await botCorrectionsAPI.deleteCorrection(correction.id);
          } catch (e) {
            console.error('deleteCorrection failed for id:', correction.id, e);
          }
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setBotCorrections(prev => prev.filter((_, i) => !indicesToRemove.includes(i)));
      setSelectedCorrections(new Set());
      setShowDeleteConfirmModal(false);
      showNotificationMessage('–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —É–¥–∞–ª–µ–Ω—ã');
    } catch (error) {
      console.error('Error deleting corrections:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫');
    }
  };

  // Knowledge base functions
  const handleAddKnowledgeItem = async (itemToAdd = null) => {
    console.log('handleAddKnowledgeItem called with:', itemToAdd);
    console.log('currentUser:', currentUser);
    console.log('currentUser?.id:', currentUser?.id);
    
    if (!currentUser?.id) {
      console.log('No currentUser.id, cannot add knowledge item');
      showNotificationMessage('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
      return;
    }
    
    const item = itemToAdd || newKnowledgeItem;
    
    console.log('Item to add:', item);
    console.log('Item nicheId:', item.nicheId);
    console.log('Selected niche ID:', selectedNicheId);
    
    if (!item.content.trim()) {
      console.log('Item content is empty, returning');
      return;
    }

    try {
      console.log('Getting or creating user...');
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      const user = await getOrCreateUser();
      if (!user) {
        showNotificationMessage('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const knowledgeItem = {
        ...item,
        status: '–û–±—Ä–∞–±–æ—Ç–∫–∞',
        created_at: new Date().toISOString()
      };

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ –ë–î –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
      const existingItems = await knowledgeBase.getKnowledgeItems(currentUser.id);
      const isDuplicate = existingItems.some(existingItem => 
        existingItem.content === item.content && existingItem.type === item.type
      );
      
      if (isDuplicate) {
        showNotificationMessage('–≠—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π');
        return;
      }
      
      // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ —Ç–∞–±–ª–∏—Ü—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–û–±—Ä–∞–±–æ—Ç–∫–∞"
      const tempItem = {
        ...knowledgeItem,
        id: 'temp_' + generateUUID(),
        status: '–û–±—Ä–∞–±–æ—Ç–∫–∞'
      };
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è —Å–∞–π—Ç–æ–≤
      if (item.type === 'site') {
        showNotificationMessage('üåê –ü–∞—Ä—Å–∏–Ω–≥ —Å–∞–π—Ç–∞... –û–∂–∏–¥–∞–π—Ç–µ 2-5 –º–∏–Ω—É—Ç');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        updateProcessingProgress(tempItem.id, 10, '–ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Å–∞–π—Ç–∞...');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        const progressInterval = setInterval(() => {
          const currentProgress = processingProgress[tempItem.id]?.progress || 10;
          const newProgress = Math.min(currentProgress + 15, 90);
          updateProcessingProgress(tempItem.id, newProgress, '‚è≥ –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è... –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏ —Ü–µ–Ω—ã');
        }, 30000);
        
        // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
        setTimeout(() => {
          clearInterval(progressInterval);
        }, 300000);
      } else {
        // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        updateProcessingProgress(tempItem.id, 20, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...');
      }
      setKnowledgeItems(prev => [...prev, tempItem]);
      setHasKnowledgeBase(true);
      showNotificationMessage('–≠–ª–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π! –°—Ç–∞—Ç—É—Å: –û–±—Ä–∞–±–æ—Ç–∫–∞');
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API —Å–µ—Ä–≤–µ—Ä
      console.log('Sending to API for processing and storage:', knowledgeItem);
      const response = await fetch('${API_CONFIG.BASE_URL}/api/knowledge/upload', {
        method: 'POST',
        headers: {
          'x-user-id': currentUser.id,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          sourceType: item.type,
          content: item.content,
          title: item.title || '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç',
          sourceUrl: item.url || null,
          nicheId: item.nicheId && item.nicheId.trim() !== '' ? item.nicheId : null
        })
      });
      
      const result = await response.json();
      console.log('API response:', result);
      
      if (!response.ok || !result.success) {
        console.error('Failed to process through API:', result);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–û—à–∏–±–∫–∞"
        setKnowledgeItems(prev => prev.map(prevItem => 
          prevItem.id === tempItem.id 
            ? { ...prevItem, status: '–û—à–∏–±–∫–∞' }
            : prevItem
        ));
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        setProcessingProgress(prev => {
          const newProgress = { ...prev };
          delete newProgress[tempItem.id];
          return newProgress;
        });
        showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
        return;
      }

      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Å–∞–π—Ç–∞ —á–µ—Ä–µ–∑ RAG —Å–∏—Å—Ç–µ–º—É
      if (item.type === 'site' || item.type === 'website') {
        console.log('Starting website parsing through RAG system...');
        try {
          const parseResult = await fetch('${API_CONFIG.BASE_URL}/api/parse-website', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              url: item.content,
              userId: currentUser.id,
              nicheId: item.nicheId || selectedNicheId
            })
          });
          
          const parseData = await parseResult.json();
          console.log('Website parsing result:', parseData);
          
          if (parseData.success) {
            console.log('‚úÖ Website parsing completed successfully');
            console.log(`üìù Created ${parseData.data.chunksCount} chunks`);
          } else {
            console.log('‚ùå Website parsing failed:', parseData.error);
          }
        } catch (parseError) {
          console.error('‚ùå Error during website parsing:', parseError);
        }
      }

      // –ï—Å–ª–∏ —ç—Ç–æ —Å–∞–π—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫—Ä–∞—É–ª–∏–Ω–≥–∞ —Å—Å—ã–ª–æ–∫ (–ø—É–ª–ª–∏–º —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)
      try {
        if (item.type === 'site' || item.type === 'website') {
          const createdSourceId = result?.data?.id;
          if (createdSourceId) {
            let tries = 0;
            const poll = setInterval(async () => {
              tries += 1;
              try {
                const res = await fetch('${API_CONFIG.BASE_URL}/api/knowledge/sources', {
                  headers: { 'x-user-id': currentUser.id }
                });
                const payload = await res.json();
                const src = (payload?.data || []).find((s) => s.id === createdSourceId);
                const linksCount = Array.isArray(src?.structured_data?.links) ? src.structured_data.links.length : 0;
                if (linksCount > 0) {
                  updateProcessingProgress(tempItem.id, 95, `–ù–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫: ${linksCount}`);
                  clearInterval(poll);
                } else {
                  updateProcessingProgress(tempItem.id, Math.min((processingProgress[tempItem.id]?.progress || 40) + 5, 90), '–ö—Ä–∞—É–ª–∏–Ω–≥ —Å—Å—ã–ª–æ–∫...');
                }
              } catch (e) {}
              if (tries >= 20) clearInterval(poll);
            }, 5000);
          }
        }
      } catch (e) { console.warn('Crawl poll error', e); }

             // –ñ–¥–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ò–ò (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
             console.log('Waiting for AI processing...');
             let attempts = 0;
             const maxAttempts = item.type === 'site' ? 60 : 20; // 5 –º–∏–Ω—É—Ç –¥–ª—è —Å–∞–π—Ç–æ–≤, 1 –º–∏–Ω—É—Ç–∞ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
             
             while (attempts < maxAttempts) {
               await new Promise(resolve => setTimeout(resolve, 5000)); // –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥
               
               // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
               const progressPercent = Math.min(30 + (attempts * 2), 95);
               const timeElapsed = Math.floor(attempts * 5 / 60);
               const timeMessage = timeElapsed > 0 ? ` (${timeElapsed} –º–∏–Ω)` : '';
               updateProcessingProgress(tempItem.id, progressPercent, `–û–±—Ä–∞–±–æ—Ç–∫–∞ –ò–ò...${timeMessage}`);
               
               const updatedKnowledgeItems = await knowledgeBase.getKnowledgeItems(currentUser.id);
               
               // –ò—â–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è
               const newItem = updatedKnowledgeItems.find(dbItem => 
                 dbItem.original_content === item.content && 
                 dbItem.source_type === item.type &&
                 new Date(dbItem.created_at) > new Date(Date.now() - 600000) // —Å–æ–∑–¥–∞–Ω –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç
               );
               
               if (newItem && newItem.processed_content && 
                   newItem.processed_content !== "–ü–æ–Ω—è–ª, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞." &&
                   (newItem.status === '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ' || newItem.status === '–ó–∞–≥—Ä—É–∂–µ–Ω–æ')) {
                 // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –∑–∞–º–µ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
                 updateProcessingProgress(tempItem.id, 100, '–ó–∞–≥—Ä—É–∂–µ–Ω–æ');
                 setKnowledgeItems(prev => prev.map(prevItem => 
                   prevItem.id === tempItem.id 
                     ? { ...newItem, status: '–ó–∞–≥—Ä—É–∂–µ–Ω–æ' }
                     : prevItem
                 ));
                 
                 // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                 setTimeout(() => {
                   setProcessingProgress(prev => {
                     const newProgress = { ...prev };
                     delete newProgress[tempItem.id];
                     return newProgress;
                   });
                 }, 2000);
                 
                 showNotificationMessage('‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ò–ò!');
                 break;
               }
               
               attempts++;
             }
             
             if (attempts >= maxAttempts) {
               // –¢–∞–π–º–∞—É—Ç - –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å "–û–±—Ä–∞–±–æ—Ç–∫–∞"
               setKnowledgeItems(prev => prev.map(prevItem => 
                 prevItem.id === tempItem.id 
                   ? { ...prevItem, status: '–û–±—Ä–∞–±–æ—Ç–∫–∞ (—Ç–∞–π–º–∞—É—Ç)' }
                   : prevItem
               ));
               
               // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
               setProcessingProgress(prev => {
                 const newProgress = { ...prev };
                 delete newProgress[tempItem.id];
                 return newProgress;
               });
               
               showNotificationMessage('‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–æ–∑–∂–µ.');
             }
             
             // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∏–∑ –ø–æ–ø–∞–ø–∞
             if (!itemToAdd) {
               setNewKnowledgeItem({ type: 'text', content: '', nicheId: '' });
             }
    } catch (error) {
      console.error('Error adding knowledge item:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  const updateProcessingProgress = (itemId, progress, message) => {
    setProcessingProgress(prev => ({
      ...prev,
      [itemId]: {
        progress: progress,
        message: message,
        timestamp: Date.now()
      }
    }));
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
  const getProcessingStatus = (item) => {
    if (item.status !== '–û–±—Ä–∞–±–æ—Ç–∫–∞') {
      return item.status;
    }
    
    const progress = processingProgress[item.id];
    if (!progress) {
      return '–û–±—Ä–∞–±–æ—Ç–∫–∞';
    }
    
    if (progress.progress >= 100) {
      return '–ó–∞–≥—Ä—É–∂–µ–Ω–æ';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è —Å–∞–π—Ç–æ–≤
    if (item.type === 'site' && progress.progress < 50) {
      const elapsed = Math.floor((Date.now() - progress.timestamp) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      return `–û–±—Ä–∞–±–æ—Ç–∫–∞: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    return `–û–±—Ä–∞–±–æ—Ç–∫–∞: ${progress.progress}%`;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  const checkProcessingStatus = async () => {
    const processingItems = knowledgeItems.filter(item => 
      item.status === '–û–±—Ä–∞–±–æ—Ç–∫–∞' || item.status === '–û–±—Ä–∞–±–æ—Ç–∫–∞ (—Ç–∞–π–º–∞—É—Ç)'
    );
    
    if (processingItems.length === 0) return;
    
    try {
      const updatedItems = await knowledgeBase.getKnowledgeItems(currentUser.id);
      
      processingItems.forEach(processingItem => {
        // –ò—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –±–∞–∑–µ
        const updatedItem = updatedItems.find(dbItem => 
          (dbItem.id === processingItem.id) ||
          (dbItem.original_content === processingItem.content && 
           dbItem.source_type === processingItem.type &&
           new Date(dbItem.created_at) > new Date(Date.now() - 300000)) // —Å–æ–∑–¥–∞–Ω –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
        );
        
        if (updatedItem && updatedItem.status === '–ó–∞–≥—Ä—É–∂–µ–Ω–æ') {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          setKnowledgeItems(prev => prev.map(prevItem => 
            prevItem.id === processingItem.id 
              ? { ...updatedItem, status: '–ó–∞–≥—Ä—É–∂–µ–Ω–æ' }
              : prevItem
          ));
          
          // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          setProcessingProgress(prev => {
            const newProgress = { ...prev };
            delete newProgress[processingItem.id];
            return newProgress;
          });
          
          showNotificationMessage('‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!');
        }
      });
    } catch (error) {
      console.error('Error checking processing status:', error);
    }
  };

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  useEffect(() => {
    const interval = setInterval(checkProcessingStatus, 10000);
    return () => clearInterval(interval);
  }, [knowledgeItems, currentUser?.id]);

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  useEffect(() => {
    const processingItems = knowledgeItems.filter(item => 
      item.status === '–û–±—Ä–∞–±–æ—Ç–∫–∞' && processingProgress[item.id]
    );
    
    if (processingItems.length === 0) return;
    
    const interval = setInterval(() => {
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
      setProcessingProgress(prev => ({ ...prev }));
    }, 1000);
    
    return () => clearInterval(interval);
  }, [knowledgeItems, processingProgress]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ GigaChat
  const processContentWithGigaChat = async (itemId, content, contentType, userId) => {
    try {
      console.log('Starting GigaChat processing for item:', itemId);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
      showNotificationMessage('–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ –ò–ò...');
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ GigaChat
      const result = await processContent(content, contentType, userId);
      
      if (result.success) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        const updatedItem = await knowledgeBase.updateKnowledgeItemStatus(itemId, result.status);
        
        if (updatedItem) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
          setKnowledgeItems(prev => prev.map(item => 
            item.id === itemId 
              ? { ...item, status: result.status }
              : item
          ));
          
          showNotificationMessage('–ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ò–ò! –°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∂–µ–Ω–æ');
        } else {
          showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        }
      } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–û—à–∏–±–∫–∞"
        await knowledgeBase.updateKnowledgeItemStatus(itemId, '–û—à–∏–±–∫–∞');
        setKnowledgeItems(prev => prev.map(item => 
          item.id === itemId 
            ? { ...item, status: '–û—à–∏–±–∫–∞' }
            : item
        ));
        
        showNotificationMessage('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ò–ò');
      }
    } catch (error) {
      console.error('Error processing content with GigaChat:', error);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–û—à–∏–±–∫–∞"
      await knowledgeBase.updateKnowledgeItemStatus(itemId, '–û—à–∏–±–∫–∞');
      setKnowledgeItems(prev => prev.map(item => 
        item.id === itemId 
          ? { ...item, status: '–û—à–∏–±–∫–∞' }
          : item
      ));
      
      showNotificationMessage('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ò–ò');
    }
  };

  const handleDeleteKnowledgeItem = async (id) => {
    try {
      const success = await knowledgeBase.deleteKnowledgeItem(id);
      if (success) {
        setKnowledgeItems(prev => prev.filter(item => item.id !== id));
        showNotificationMessage('–≠–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π');
      } else {
        showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞');
      }
    } catch (error) {
      console.error('Error deleting knowledge item:', error);
      showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞');
    }
  };

  const handleShowKnowledgeDetails = (item) => {
    setSelectedKnowledgeDetails(item);
    setShowKnowledgeDetailsPopup(true);
    setSelectedKnowledgeItem(null); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é
  };


  const handleSitePopupOpen = () => {
    setShowSitePopup(true);
    setSiteUrl('');
    setSelectedPages(['']);
    setSiteUrlError('');
    setSelectedPagesErrors(['']);
    setSitePopupTab('full');
  };

  const handleSitePopupClose = () => {
    setShowSitePopup(false);
    setSiteUrl('');
    setSelectedPages(['']);
    setSiteUrlError('');
    setSelectedPagesErrors(['']);
  };

  const handleAddPage = () => {
    setSelectedPages(prev => [...prev, '']);
    setSelectedPagesErrors(prev => [...prev, '']);
  };

  const handleRemovePage = (index) => {
    setSelectedPages(prev => prev.filter((_, i) => i !== index));
    setSelectedPagesErrors(prev => prev.filter((_, i) => i !== index));
  };

  const handlePageChange = (index, value) => {
    setSelectedPages(prev => prev.map((page, i) => i === index ? value : page));
    const error = validateUrl(value);
    setSelectedPagesErrors(prev => prev.map((err, i) => i === index ? error : err));
  };

  const handleSiteUrlChange = (value) => {
    setSiteUrl(value);
    const error = validateUrl(value);
    setSiteUrlError(error);
  };

  const handleSiteImport = async () => {
    console.log('handleSiteImport called');
    console.log('sitePopupTab:', sitePopupTab);
    console.log('siteUrl:', siteUrl);
    console.log('selectedPages:', selectedPages);
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
    handleSitePopupClose();
    
    if (sitePopupTab === 'full') {
      const error = validateUrl(siteUrl);
      if (error) {
        setSiteUrlError(error);
        showNotificationMessage('–ù–µ–≤–µ—Ä–Ω—ã–π URL —Å–∞–π—Ç–∞');
        return;
      }
      // –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Å—å —Å–∞–π—Ç
      const newItem = {
        type: 'site',
        content: siteUrl,
        status: '–û–±—Ä–∞–±–æ—Ç–∫–∞'
      };
      console.log('Adding full site item:', newItem);
      await handleAddKnowledgeItem(newItem);
    } else {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      const errors = selectedPages.map(page => validateUrl(page));
      setSelectedPagesErrors(errors);
      
      if (errors.some(error => error)) {
        showNotificationMessage('–ù–µ–≤–µ—Ä–Ω—ã–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü');
        return;
      }
      
      const validPages = selectedPages.filter(page => page.trim());
      if (validPages.length === 0) return;
      
      for (const page of validPages) {
        const newItem = {
          type: 'site',
          content: page,
          status: '–û–±—Ä–∞–±–æ—Ç–∫–∞'
        };
        console.log('Adding page item:', newItem);
        await handleAddKnowledgeItem(newItem);
      }
    }
  };

  // Feed popup functions
  const handleFeedPopupOpen = () => {
    setShowFeedPopup(true);
    setFeedUrl('');
    setFeedUrlError('');
  };

  const handleFeedPopupClose = () => {
    setShowFeedPopup(false);
    setFeedUrl('');
    setFeedUrlError('');
  };

  const handleFeedUrlChange = (value) => {
    setFeedUrl(value);
    const error = validateUrl(value);
    setFeedUrlError(error);
  };

  const handleFeedImport = async () => {
    const error = validateUrl(feedUrl);
    if (error) {
      setFeedUrlError(error);
      return;
    }
    
    const newItem = {
      type: 'feed',
      content: feedUrl,
      status: '–û–±—Ä–∞–±–æ—Ç–∫–∞'
    };
    await handleAddKnowledgeItem(newItem);
    handleFeedPopupClose();
  };

  // File popup functions
  const handleFilePopupOpen = () => {
    setShowFilePopup(true);
    setSelectedFiles([]);
    setUploadedFiles([]);
  };

  const handleFilePopupClose = () => {
    setShowFilePopup(false);
    setSelectedFiles([]);
    setUploadedFiles([]);
  };

  const handleFileSelect = (event) => {
    const files = Array.from(event.target.files);
    setSelectedFiles(files);
  };

  const handleRemoveFile = (index) => {
    setSelectedFiles(prev => prev.filter((_, i) => i !== index));
  };

  const handleFileUpload = async () => {
    if (selectedFiles.length === 0) return;
    
    if (!currentUser?.id) {
      showNotificationMessage('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
      return;
    }

    for (const file of selectedFiles) {
      try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        showNotificationMessage(`–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞: ${file.name}`);
        
        // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        const formData = new FormData();
        formData.append('file', file);
        formData.append('userId', currentUser.id);
        formData.append('contentType', 'file');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        const response = await fetch('${API_CONFIG.BASE_URL}/api/upload-file', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          const newItem = {
            id: result.knowledge_item?.id || generateUUID(),
            type: 'file',
            content: file.name,
            status: result.status || '–ó–∞–≥—Ä—É–∂–µ–Ω–æ',
            processed_content: result.analysis,
            created_at: new Date().toISOString()
          };
          
          setKnowledgeItems(prev => [...prev, newItem]);
          setHasKnowledgeBase(true);
          showNotificationMessage(`‚úÖ –§–∞–π–ª ${file.name} —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!`);
        } else {
          showNotificationMessage(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ ${file.name}: ${result.message}`);
        }
      } catch (error) {
        console.error('File upload error:', error);
        showNotificationMessage(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ${file.name}`);
      }
    }
    
    handleFilePopupClose();
  };

  // Text popup functions
  const handleTextPopupOpen = () => {
    setShowTextPopup(true);
    setTextContent('');
    setTextContentError('');
  };

  const handleTextPopupClose = () => {
    setShowTextPopup(false);
    setTextContent('');
    setTextContentError('');
  };

  const handleTextContentChange = (value) => {
    setTextContent(value);
    if (!value.trim()) {
      setTextContentError('–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
    } else {
      setTextContentError('');
    }
  };

  const handleTextImport = async () => {
    if (!textContent.trim()) {
      setTextContentError('–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
      return;
    }
    
    const newItem = {
      type: 'text',
      content: textContent,
      status: '–û–±—Ä–∞–±–æ—Ç–∫–∞'
    };
    await handleAddKnowledgeItem(newItem);
    handleTextPopupClose();
  };

  // Integration functions
  const handleIntegrationClick = (integration) => {
    setSelectedIntegration(integration);
    setShowIntegrationModal(true);
  };

  // Widget functions
  const handleShowWidgetConstructor = () => {
    setShowWidgetConstructor(true);
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
  const handleInstallIntegration = (integration) => {
    if (integration.id === 'widget') {
      setShowWidgetConstructor(true);
    } else {
      setSelectedIntegration(integration);
      setShowIntegrationModal(true);
    }
  };

  const handleUninstallIntegration = (integration) => {
    setIntegrationToUninstall(integration);
    setShowUninstallModal(true);
  };

  const confirmUninstall = () => {
    if (integrationToUninstall) {
      setIntegrations(prev => prev.map(item => 
        item.id === integrationToUninstall.id 
          ? { ...item, installed: false }
          : item
      ));
      setShowUninstallModal(false);
      setIntegrationToUninstall(null);
      showNotificationMessage('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
    }
  };

  const handleIntegrationSuccess = (integrationId) => {
    setIntegrations(prev => prev.map(item => 
      item.id === integrationId 
        ? { ...item, installed: true }
        : item
    ));
    setShowIntegrationModal(false);
    setSelectedIntegration(null);
    showNotificationMessage('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
  };

  // Render functions
  const renderContent = () => {
    switch (activeSection) {
              case 'main':
  return (
          <div className="p-0">
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
            <div className="text-left mb-[16px]">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">
                –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –≤–∞—Å, {currentUser?.name || currentUser?.email?.split('@')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}! –° —á–µ–≥–æ –Ω–∞—á–Ω–µ–º?
              </h1>
            </div>
            
            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
            <div className="h-px bg-[#E5E7EB] mb-[50px]" style={{ marginLeft: '-32px', marginRight: '-32px' }}></div>

            {/* –°—Ç–æ—Ä–∏—Å—ã */}
            <div className="mb-[50px]">
              <h2 className="text-[16px] font-[500] text-[#070F1A] mb-[20px]">–°—Ç–æ—Ä–∏—Å—ã</h2>
              <div className="flex gap-4 overflow-x-auto pb-4">
                {stories.map((story) => (
                  <div key={story.id} className="flex-shrink-0 flex flex-col items-center">
                    <div className="w-[70px] h-[70px] border border-[#0084FF] rounded-[90px] flex items-center justify-center">
                      <div className="w-[64px] h-[64px] bg-white rounded-[90px] relative overflow-hidden">
                        <img 
                          src={story.image_url} 
                          alt={story.title} 
                          className="w-full h-full object-cover" 
                        />
                      </div>
                    </div>
                    <span className="text-[11px] font-[400] text-[#070F1A] text-center leading-tight mt-2">
                      {story.title.split(' ').map((word, index) => (
                        <span key={index}>
                          {word}
                          {index < story.title.split(' ').length - 1 && <br />}
                        </span>
                      ))}
                    </span>
                  </div>
                ))}
              </div>
            </div>

            {/* –ë–ª–æ–∫ "–ó–∞–ø—É—Å–∫ Adapto" */}
            {showSetupGuide && (
              <div className="mb-[50px]">
                <div className="flex items-center gap-3 mb-[20px]">
                  {/* –ö—Ä—É–≥–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */}
                  <div className="relative w-[22px] h-[22px]">
                    <svg className="w-[22px] h-[22px]" viewBox="0 0 32 32" style={{ transform: 'rotate(-90deg)' }}>
                      {/* –§–æ–Ω */}
                      <circle cx="16" cy="16" r="14" fill="none" stroke="#E5E7EB" strokeWidth="4"/>
                      {/* –ü—Ä–æ–≥—Ä–µ—Å—Å */}
                      <circle 
                        cx="16" cy="16" r="14" 
                        fill="none" 
                        stroke="#36C76A" 
                        strokeWidth="4"
                        strokeDasharray={`${2 * Math.PI * 14}`}
                        strokeDashoffset={`${2 * Math.PI * 14 * (1 - completedSteps.length / 3)}`}
                        strokeLinecap="round"
                        className="transition-all duration-500"
                      />
                    </svg>
                  </div>
                  <h2 className="text-[18px] font-[500] text-[#070F1A]">–ó–∞–ø—É—Å–∫ Adapto</h2>
                  <div className="flex items-center gap-[10px]">
                    <span className="text-[14px] text-[#8E8E93]">‚Ä¢</span>
                    <span className="text-[14px] text-[#8E8E93]">{completedSteps.length} / 3 —à–∞–≥–∞</span>
                  </div>
                </div>

                {/* –û—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—à–∫–∞ —Å —à–∞–≥–∞–º–∏ */}
                <div className="bg-white rounded-[20px] p-5 w-full">
                  <h3 className="text-[20px] font-[500] text-[#070F1A] mb-[34px]">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –ò–ò-–∞–≥–µ–Ω—Ç–∞:</h3>
                  
                  <div className="w-full">
                    {/* –®–∞–≥–∏ –Ω–∞ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */}
                    <div className="w-full space-y-4 pb-0">
                      {/* –®–∞–≥ 1 */}
                      <div className="rounded-[15px] p-0">
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex items-center gap-[10px]">
                            {completedSteps.includes(1) ? (
                              <img src="/Checkbox.svg" alt="–í—ã–ø–æ–ª–Ω–µ–Ω–æ" className="w-[16px] h-[16px]" />
                            ) : (
                              <img src="/Checkbox-1.svg" alt="–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ" className="w-[16px] h-[16px]" />
                            )}
                            <h4 
                              className={`text-[16px] font-[500] cursor-pointer ${completedSteps.includes(1) ? 'line-through text-[#8E8E93]' : 'text-[#070F1A]'}`}
                              onClick={() => setExpandedStep(expandedStep === 1 ? null : 1)}
                            >
                              –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ò–ò-–º–æ–¥–µ–ª—å –ø–æ–¥ –≤–∞—à –±–∏–∑–Ω–µ—Å
                            </h4>
                          </div>
                          <button
                            onClick={() => setExpandedStep(expandedStep === 1 ? null : 1)}
                            className="text-[#0084FF] hover:text-[#0073E6] transition-colors"
                          >
                            <img
                              src="/Bounds.svg"
                              alt="–†–∞—Å–∫—Ä—ã—Ç—å"
                              className={`w-[11px] h-[11px] transition-transform duration-300 ${expandedStep === 1 ? 'rotate-90' : ''}`}
                              style={{ filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }}
                            />
                          </button>
                        </div>
                        
                        {expandedStep === 1 && (
                          <div className="space-y-4">
                            <p className="text-[14px] text-[#8E8E93] leading-relaxed">
                              –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞—à–µ–π –ò–ò-–º–æ–¥–µ–ª–∏: —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è, –ø—Ä–∞–≤–∏–ª–∞, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏.
                            </p>
                            <button
                              onClick={() => setActiveSection('model-settings')}
                              className="h-[34px] w-full px-6 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                              style={BUTTON_STYLES.blueButton}
                            >
                              –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                            </button>
            </div>
                        )}
                      </div>
                      <div className="h-px bg-[#E5E7EB] my-[15px]"></div>

                      {/* –®–∞–≥ 2 */}
                      <div className="rounded-[15px] p-0">
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex items-center gap-[10px]">
                            {completedSteps.includes(2) ? (
                              <img src="/Checkbox.svg" alt="–í—ã–ø–æ–ª–Ω–µ–Ω–æ" className="w-[16px] h-[16px]" />
                            ) : (
                              <img src="/Checkbox-1.svg" alt="–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ" className="w-[16px] h-[16px]" />
                            )}
                            <h4 
                              className={`text-[16px] font-[500] cursor-pointer ${completedSteps.includes(2) ? 'line-through text-[#8E8E93]' : 'text-[#070F1A]'}`}
                              onClick={() => setExpandedStep(expandedStep === 2 ? null : 2)}
                            >
                              –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
                            </h4>
                          </div>
                          <button
                            onClick={() => setExpandedStep(expandedStep === 2 ? null : 2)}
                            className="text-[#0084FF] hover:text-[#0073E6] transition-colors"
                          >
                            <img
                              src="/Bounds.svg"
                              alt="–†–∞—Å–∫—Ä—ã—Ç—å"
                              className={`w-[11px] h-[11px] transition-transform duration-300 ${expandedStep === 2 ? 'rotate-90' : ''}`}
                              style={{ filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }}
                            />
                          </button>
                </div>
                
                        {expandedStep === 2 && (
                          <div className="space-y-4">
                            <p className="text-[14px] text-[#8E8E93] leading-relaxed">
                              –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –∏ —É—Å–ª—É–≥–∞—Ö. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ò–ò-–±–æ—Ç—É –¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤–∞—à–∏–º –∫–ª–∏–µ–Ω—Ç–∞–º.
                            </p>
                            <button
                              onClick={() => setActiveSection('knowledge')}
                              className="h-[34px] w-full px-6 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                              style={BUTTON_STYLES.blueButton}
                            >
                              –ó–∞–≥—Ä—É–∑–∏—Ç—å
                            </button>
                      </div>
                        )}
                      </div>
                      <div className="h-px bg-[#E5E7EB] my-[15px]"></div>

                      {/* –®–∞–≥ 3 */}
                      <div className="rounded-[15px] p-0">
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex items-center gap-[10px]">
                            {completedSteps.includes(3) ? (
                              <img src="/Checkbox.svg" alt="–í—ã–ø–æ–ª–Ω–µ–Ω–æ" className="w-[16px] h-[16px]" />
                            ) : (
                              <img src="/Checkbox-1.svg" alt="–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ" className="w-[16px] h-[16px]" />
                            )}
                            <h4 
                              className={`text-[16px] font-[500] cursor-pointer ${completedSteps.includes(3) ? 'line-through text-[#8E8E93]' : 'text-[#070F1A]'}`}
                              onClick={() => setExpandedStep(expandedStep === 3 ? null : 3)}
                            >
                              –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ –≤ –∫–∞–Ω–∞–ª—ã —Å–≤—è–∑–∏
                            </h4>
                    </div>
                          <button
                            onClick={() => setExpandedStep(expandedStep === 3 ? null : 3)}
                            className="text-[#0084FF] hover:text-[#0073E6] transition-colors"
                          >
                            <img
                              src="/Bounds.svg"
                              alt="–†–∞—Å–∫—Ä—ã—Ç—å"
                              className={`w-[11px] h-[11px] transition-transform duration-300 ${expandedStep === 3 ? 'rotate-90' : ''}`}
                              style={{ filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }}
                            />
                          </button>
                  </div>
              
                        {expandedStep === 3 && (
                          <div className="space-y-4">
                            <p className="text-[14px] text-[#8E8E93] leading-relaxed">
                              –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–±–æ—Ç—É –≤–∞—à–µ–≥–æ –ò–ò-–±–æ—Ç–∞, –∑–∞–¥–∞–≤ –µ–º—É —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
                            </p>
                            <button
                              onClick={() => setActiveSection('my-solo')}
                              className="h-[34px] w-full px-6 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                              style={BUTTON_STYLES.blueButton}
                            >
                              –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                          </div>
                        )}
                      </div>
                </div>
                  </div>
                </div>
              </div>
            )}

            {/* –ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä "–î–∞—à–±–æ—Ä–¥" */}
            <div className="mb-[50px]">
              <h2 className="text-[18px] font-[500] text-[#070F1A] mb-[20px]">–î–∞—à–±–æ—Ä–¥</h2>
              <div className="grid grid-cols-3 gap-4">
                {/* CRM */}
                <div 
                  className="rounded-[16px] p-6 cursor-pointer flex flex-col items-center text-center transition-all duration-200"
                  onClick={() => setActiveSection('crm')}
                  style={{
                    ...BUTTON_STYLES.whiteButton,
                    ':hover': {
                      backgroundColor: 'white',
                      boxShadow: '0 4px 8px rgba(0,0,0,0.15)'
                    }
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = 'white';
                    e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = BUTTON_STYLES.whiteButton.backgroundColor;
                    e.currentTarget.style.boxShadow = BUTTON_STYLES.whiteButton.boxShadow;
                  }}
                >
                  <div className="w-[24px] h-[24px] flex items-center justify-center mb-[5px]">
                    <img src="./crm.svg" alt="CRM" className="w-[24px] h-[24px]" style={{ filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)' }} />
                  </div>
                  <h3 className="text-[14px] font-[500] text-[#070F1A]">CRM</h3>
                </div>

                {/* –î–∏–∞–ª–æ–≥–∏ */}
                <div 
                  className="rounded-[16px] p-6 cursor-pointer flex flex-col items-center text-center transition-all duration-200"
                  onClick={() => setActiveSection('dialogs')}
                  style={{
                    ...BUTTON_STYLES.whiteButton,
                    ':hover': {
                      backgroundColor: 'white',
                      boxShadow: '0 4px 8px rgba(0,0,0,0.15)'
                    }
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = 'white';
                    e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = BUTTON_STYLES.whiteButton.backgroundColor;
                    e.currentTarget.style.boxShadow = BUTTON_STYLES.whiteButton.boxShadow;
                  }}
                >
                  <div className="w-[24px] h-[24px] flex items-center justify-center mb-[5px]">
                    <img src="./dialog.svg" alt="–î–∏–∞–ª–æ–≥–∏" className="w-[24px] h-[24px]" style={{ filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)' }} />
                  </div>
                  <h3 className="text-[14px] font-[500] text-[#070F1A]">–î–∏–∞–ª–æ–≥–∏</h3>
                </div>

                {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                <div 
                  className="rounded-[16px] p-6 cursor-pointer flex flex-col items-center text-center transition-all duration-200"
                  onClick={() => setActiveSection('statistics')}
                  style={{
                    ...BUTTON_STYLES.whiteButton,
                    ':hover': {
                      backgroundColor: 'white',
                      boxShadow: '0 4px 8px rgba(0,0,0,0.15)'
                    }
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = 'white';
                    e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = BUTTON_STYLES.whiteButton.backgroundColor;
                    e.currentTarget.style.boxShadow = BUTTON_STYLES.whiteButton.boxShadow;
                  }}
                >
                  <div className="w-[24px] h-[24px] flex items-center justify-center mb-[5px]">
                    <img src="./stat.svg" alt="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" className="w-[24px] h-[24px]" style={{ filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)' }} />
                  </div>
                  <h3 className="text-[14px] font-[500] text-[#070F1A]">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                </div>
              </div>
            </div>

            {/* –ë–ª–æ–∫ "–ú–∏–Ω–∏-–æ–±—É—á–µ–Ω–∏–µ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ" */}
            <div className="mt-[20px]">
              <h2 className="text-[20px] font-[500] text-[#070F1A] mb-[20px]">–ú–∏–Ω–∏-–æ–±—É—á–µ–Ω–∏–µ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ</h2>
              <div className="w-full h-32 rounded-[15px] flex items-center justify-start cursor-pointer transition-all duration-300 p-0">
                <img src="/Frame 131.png" alt="–ú–∏–Ω–∏-–æ–±—É—á–µ–Ω–∏–µ" className="w-[290px] h-[140px] object-contain" />
              </div>
            </div>
                </div>
        );

      case 'my-solo':
        return (
          <div className="space-y-6">
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ */}
            <h1 className="text-[20px] font-[500] text-[#070F1A]">–ú–æ–π Adapto</h1>
            <p className="text-[#8E8E93] text-[14px]" style={{ marginTop: '12px' }}>
              –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞ –Ω–∞ –∑–Ω–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
            </p>

            {/* –î–≤–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */}
            <div className="flex gap-[10px]">
              {/* –õ–µ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä - –ø–æ–ª–µ –¥–ª—è –ø—Ä–∞–≤–æ–∫ */}
              <div className="flex-1 bg-white rounded-[20px] flex flex-col" style={{ marginLeft: '-15px', marginRight: '10px', padding: '16px 16px 0px 16px' }}>
                {/* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞ */}
                {!hasKnowledgeBase && (
                  <div className="bg-[#FF3B30]/5 border border-[#FF3B30]/15 rounded-[15px] p-[15px] mb-6">
                    <div className="flex items-start gap-[11px]">
                      <img src="/alarm.svg" alt="–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ" className="w-4 h-4 flex-shrink-0" style={{ filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(340deg) brightness(104%) contrast(97%)' }} />
                      <div className="flex-1">
                        <h3 className="text-[#FF3B30] font-[500] text-base mb-[11px]">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</h3>
                        <div className="flex justify-between items-center">
                          <p className="text-[#916464]/90 text-sm flex-1">
                            –í—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –Ω–∏—á–µ–≥–æ –≤ –≤–∞—à—É –±–∞–∑—É –∑–Ω–∞–Ω–∏–π, –ò–ò-–±–æ—Ç –Ω–µ –≥–æ—Ç–æ–≤ –∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∏ –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
                          </p>
                          <button className="text-[#FF3B30] font-[500] text-sm px-4 h-[34px] bg-[#FF3B30]/10 rounded-[12px] hover:bg-[#FF3B30]/20 transition-colors flex items-center ml-4">
                            –ü–µ—Ä–µ–π—Ç–∏ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* –°–µ–∫—Ü–∏—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞–º–∏ */}
                <div className="flex-1 space-y-3 mb-6">
                  {botCorrections.map((correction, index) => (
                    <div key={index} className="flex items-center">
                      {/* –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –Ω–æ–º–µ—Ä */}
                      <div className="w-[40px] h-[40px] border border-[#070F1A]/10 rounded-[10px] flex items-center justify-center">
                        <span className="text-[#0084FF] font-semibold text-[14px]">{index + 1}</span>
                      </div>
                      {/* –û—Ç—Å—Ç—É–ø */}
                      <div className="w-[10px]"></div>
                      {/* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å - –æ–ø–∏—Å–∞–Ω–∏–µ */}
                      <div className="flex-1 h-[40px] bg-[#F3F5F7] rounded-[10px] flex items-center px-[10px]">
                        <span className="text-[#070F1A] font-medium text-[14px] opacity-90">{correction.correction || correction}</span>
                      </div>
                      {/* –û—Ç—Å—Ç—É–ø */}
                      <div className="w-[10px]"></div>
                      {/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */}
                      <div className="w-[40px] h-[40px] border border-[#070F1A]/10 rounded-[10px] flex items-center justify-center">
                        <button 
                          onClick={() => removeCorrection(index)}
                          className="w-[16px] h-[16px] flex items-center justify-center"
                        >
                          <img src="/traash.svg" alt="–£–¥–∞–ª–∏—Ç—å" className="w-[16px] h-[16px] text-red-500" style={{ filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%)' }} />
                        </button>
                      </div>
                    </div>
                  ))}
              </div>

                {/* –ü–æ–ª–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ - –≤–Ω–∏–∑—É */}
                <div className="relative">
                  <textarea
                    value={botCorrection}
                    onChange={(e) => setBotCorrection(e.target.value)}
                    placeholder="–ï—Å–ª–∏ –≤—ã —É–≤–∏–¥–µ–ª–∏ –æ—à–∏–±–∫—É –≤ –æ—Ç–≤–µ—Ç–∞—Ö ‚Äì –Ω–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∑–¥–µ—Å—å"
                    className="w-full h-[48px] border border-gray-300 rounded-[90px] px-[15px] py-[12px] text-[#8E8E93] text-[14px] resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 pr-[60px]"
                  />

                  <img 
                    src="/send-button.svg" 
                    alt="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" 
                    className="absolute top-[5px] right-[5px] w-[38px] h-[38px] cursor-pointer" 
                    onClick={handleBotCorrection}
                  />
  </div>
              </div>

              {/* –ü—Ä–∞–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä - –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ */}
              <div className="w-[400px] bg-[#070F1A] rounded-[20px] p-0 flex flex-col" style={{ marginLeft: '15px', marginRight: '0px', height: '583px', flexShrink: 0 }}>
                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ê–¥–∞–ø—Ç–æ" */}
                <div className="flex items-center justify-between mb-4 px-4 pt-4">
                  <div className="flex items-center gap-2">
                    <img src="/logo-testing.svg" alt="–¢–µ—Å—Ç" className="w-5 h-5" />
                    <h2 className="text-[18px] font-[500] text-white">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ê–¥–∞–ø—Ç–æ</h2>
  </div>
                  <button 
                    onClick={async () => {
                      if (currentUser?.id) {
                        try {
                          console.log('Attempting to clear chat history for user:', currentUser.id);
                          console.log('chatHistoryAPI object:', chatHistoryAPI);
                          console.log('clearChatHistory function:', chatHistoryAPI.clearChatHistory);
                          
                          if (typeof chatHistoryAPI.clearChatHistory !== 'function') {
                            throw new Error('clearChatHistory is not a function');
                          }
                          
                          const result = await chatHistoryAPI.clearChatHistory(currentUser.id);
                          console.log('Clear chat history result:', result);
                          
                          if (result) {
                            setChatHistory([
                              { type: 'assistant', text: '–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Adapto. –ö–∞–∫ –¥–µ–ª–∞?', time: '–¢–æ–ª—å–∫–æ —á—Ç–æ', timestamp: Date.now() }
                            ]);
                            showNotificationMessage('–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
                            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
                            ChatUtils.scrollToBottom(chatHistoryRef);
                          } else {
                            showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏');
                          }
                        } catch (error) {
                          console.error('Error clearing chat history:', error);
                          showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message);
                        }
                      } else {
                        console.error('No current user ID available');
                        showNotificationMessage('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                      }
                    }}
                    className="text-white text-xs px-2 py-1 rounded hover:bg-white/10 transition-colors"
                    title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
                  >
                    –û—á–∏—Å—Ç–∏—Ç—å
                  </button>
                </div>

                {/* –î–∏–∞–ª–æ–≥ */}
                <div className="flex-1 flex flex-col">
                  {/* –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ */}
                  <div ref={chatHistoryRef} className="flex-1 space-y-4 overflow-y-auto mb-4 chat-history-container" style={{ flexBasis: 0 }}>
                    
                    {/* DEBUG INFO */}
                    <div className="text-xs text-gray-500 p-2 bg-yellow-100 rounded">
                      DEBUG: chatHistory.length = {chatHistory.length}, currentUser.email = {currentUser?.email}, currentUser.id = {currentUser?.id}
                      <br />
                      chatHistory: {JSON.stringify(chatHistory.slice(0, 2))}
                    </div>
                    
                        <VirtualizedMessageList
                          messages={chatHistory}
                          getMessageAlignment={getMessageAlignment}
                          getMessageOrder={getMessageOrder}
                          getMessageStyle={getMessageStyle}
                          getMessageFooter={getMessageFooter}
                          aiAgentName={aiAgentName}
                          containerRef={chatHistoryRef}
                        />
                      </div>
                  
                  {/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ - –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –≤–Ω–∏–∑—É */}
                  <div className="relative flex-shrink-0 px-0 pb-4">
  <input 
                      type="text"
                      value={currentMessage}
                      onChange={(e) => setCurrentMessage(e.target.value)}
                      placeholder="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø–µ—á–∞—Ç–∞—Ç—å"
                      className="w-full h-[48px] px-0 py-2 rounded-[90px] focus:outline-none focus:ring-2 focus:ring-blue-500 pr-[50px]"
                      style={{ 
                        border: '1px solid rgba(255, 255, 255, 0.1)', 
                        backgroundColor: '#070F1A',
                        color: '#8E8E93',
                        fontSize: '14px'
                      }}
                      onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                    />
                    <img 
                      src="/send-button2.svg" 
                      alt="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" 
                      className="absolute top-[5px] right-[5px] w-[38px] h-[38px] cursor-pointer" 
                      onClick={handleSendMessage}
                    />
                    </div>
                  </div>
            </div>
          </div>
          </div>
        );

      case 'knowledge':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <div>
                <h1 className="text-[20px] font-[500]">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h1>
                {(() => {
                  const filteredItems = knowledgeItems.filter(item => {
                    if (!selectedNicheId) return true;
                    return item.nicheId === selectedNicheId;
                  });
                  const totalItems = knowledgeItems.length;
                  const shownItems = filteredItems.length;
                  
                  if (totalItems > 0) {
                    return (
                      <p className="text-[12px] text-[#8E8E93] mt-1">
                        {selectedNicheId 
                          ? `–ü–æ–∫–∞–∑–∞–Ω–æ: ${shownItems} –∏–∑ ${totalItems} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤`
                          : `–í—Å–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: ${totalItems}`
                        }
                      </p>
                    );
                  }
                  return null;
                })()}
              </div>
            </div>

            

            {/* –õ–∏–Ω–∏—è –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º + —Ç–∞–±–ª–∏—Ü–∞ –≤–ø–ª–æ—Ç–Ω—É—é */}
            <div>
              <div className="border-b border-gray-200 mb-0" style={{ borderColor: '#E5E6E7', marginTop: '16px', marginLeft: '-24px', marginRight: '-24px', width: 'calc(100% + 48px)' }}></div>
              {/* –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */}
              {(() => {
                const filteredItems = knowledgeItems.filter(item => {
                  if (!selectedNicheId) return true;
                  return item.nicheId === selectedNicheId;
                });
                return filteredItems.length > 0;
              })() ? (
              <div className="border border-t-0 border-[#070F1A]/10 rounded-none overflow-hidden" style={{ marginLeft: '-24px', marginRight: '-24px', width: 'calc(100% + 48px)' }}>
                {/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã */}
                <div className="grid grid-cols-4 gap-4 px-[26px] py-4 border-b border-[#070F1A]/10 bg-gray-50">
                  <div className="font-[400] text-[14px] text-[#8E8E93]">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                  <div className="font-[400] text-[14px] text-[#8E8E93] text-center">–†–µ—Å—É—Ä—Å</div>
                  <div className="font-[400] text-[14px] text-[#8E8E93]">–°—Ç–∞—Ç—É—Å</div>
                  <div className="font-[400] text-[14px] text-[#8E8E93]"></div>
                </div>

                {/* –°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã */}
                <div className="divide-y divide-[#070F1A]/10">
                  {knowledgeItems
                    .filter(item => {
                      // –ï—Å–ª–∏ –Ω–∏—à–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
                      if (!selectedNicheId) return true;
                      // –ï—Å–ª–∏ –Ω–∏—à–∞ –≤—ã–±—Ä–∞–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —ç—Ç–æ–π –Ω–∏—à–∏
                      return item.nicheId === selectedNicheId;
                    })
                    .map((item, index) => (
                    <div key={item.id || index} className="grid grid-cols-4 gap-4 px-[26px] py-4 hover:bg-gray-50 transition-colors">
                      {/* –ù–∞–∑–≤–∞–Ω–∏–µ */}
                      <div className={`text-[#070F1A] text-sm truncate font-[500] ${
                        item.status === '–û–±—Ä–∞–±–æ—Ç–∫–∞' ? 'animate-pulse' : ''
                      }`}>
                        {(item.original_content || item.content || '').length > 50 ? `${(item.original_content || item.content || '').substring(0, 50)}...` : (item.original_content || item.content || '')}
                      </div>
                      
                      {/* –†–µ—Å—É—Ä—Å */}
                      <div className="flex items-center justify-center">
                        <div className="h-[24px] px-2 rounded-[7px] bg-gray-100 flex items-center gap-[2px]">
                          <img 
                            src={
                              (item.source_type || item.type) === 'site' ? '/global2.svg' :
                              (item.source_type || item.type) === 'feed' ? '/document-code.svg' :
                              (item.source_type || item.type) === 'text' ? '/edit-2.svg' :
                              '/document-copy.svg'
                            }
                            alt={item.type}
                            className="w-[10px] h-[10px]"
                          />
                          <span className="text-[12px] font-[400] text-[#070F1A]">
                            {(item.source_type || item.type) === 'site' && '–°–∞–π—Ç'}
                            {(item.source_type || item.type) === 'feed' && '–¢–æ–≤–∞—Ä–Ω—ã–π —Ñ–∏–¥'}
                            {(item.source_type || item.type) === 'text' && '–¢–µ–∫—Å—Ç'}
                            {(item.source_type || item.type) === 'file' && '–§–∞–π–ª'}
                            {(item.source_type || item.type) === 'website' && '–°–∞–π—Ç'}
                          </span>
                        </div>
                      </div>
                      
                      {/* –°—Ç–∞—Ç—É—Å */}
                      <div className="flex items-center">
                        <div className={`h-[24px] px-3 rounded-[50px] flex items-center gap-2 relative overflow-hidden ${
                          item.status === '–ó–∞–≥—Ä—É–∂–µ–Ω–æ' ? 'bg-[#36C76A]/15 text-[#36C76A]' :
                          item.status === '–û–±—Ä–∞–±–æ—Ç–∫–∞' ? 'bg-[#0084FF]/15 text-[#0084FF]' :
                          item.status === '–û—à–∏–±–∫–∞' ? 'bg-[#FF3B30]/15 text-[#FF3B30]' :
                          'bg-[#0084FF]/15 text-[#0084FF]'
                        }`}>
                          {item.status === '–û–±—Ä–∞–±–æ—Ç–∫–∞' && (
                            <div className="w-3 h-3 border-2 border-[#0084FF] border-t-transparent rounded-full animate-spin"></div>
                          )}
                          <span className="text-[12px] font-[400] relative z-10">
                            {getProcessingStatus(item)}
                          </span>
                          {/* –ü–æ–ª–æ—Å–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */}
                          {item.status === '–û–±—Ä–∞–±–æ—Ç–∫–∞' && processingProgress[item.id] && (
                            <div 
                              className="absolute inset-0 bg-[#0084FF]/20 transition-all duration-300 ease-out"
                              style={{ 
                                width: `${processingProgress[item.id].progress}%`,
                                left: 0,
                                top: 0,
                                height: '100%'
                              }}
                            />
                          )}
                        </div>
                      </div>
                      
                      {/* –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π */}
                      <div className="flex justify-end items-center gap-2">
                        <div className="relative dropdown-menu">
                          {selectedKnowledgeItem?.id === item.id && (
                            <div className="absolute right-8 top-0 bg-white border border-gray-200 rounded-[10px] shadow-lg z-[9999] w-[120px]">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleShowKnowledgeDetails(item);
                                }}
                                className="w-full h-[34px] px-3 text-left text-[13px] text-[#070F1A] hover:bg-gray-50 rounded-t-[10px] transition-colors flex items-center gap-2"
                              >
                                <img src="/eye-open.svg" alt="–ü–æ–¥—Ä–æ–±–Ω–µ–µ" className="w-4 h-4" />
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleDeleteKnowledgeItem(item.id || index);
                                  setSelectedKnowledgeItem(null);
                                }}
                                className="w-full h-[34px] px-3 text-left text-[13px] text-red-600 hover:bg-red-50 rounded-b-[10px] transition-colors flex items-center gap-2"
                              >
                                <img src="/traash.svg" alt="–£–¥–∞–ª–∏—Ç—å" className="w-4 h-4" />
                                –£–¥–∞–ª–∏—Ç—å
                              </button>
                            </div>
                          )}
                          <button 
                            onClick={(e) => {
                              e.stopPropagation();
                              setSelectedKnowledgeItem(selectedKnowledgeItem?.id === item.id ? null : item);
                            }}
                            className="p-1 hover:bg-gray-100 rounded-[90px] transition-colors"
                          >
                            <MoreVertical className="w-4 h-4 text-gray-500" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
              ) : (
              /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
              <div className="bg-[#F8F8FA] rounded-none border border-[#070F1A]/10 p-8 text-center" style={{ marginLeft: '-24px', marginRight: '-24px', width: 'calc(100% + 48px)', borderTopWidth: 0 }}>
                <div className="max-w-md mx-auto">
                  <span
                    className="w-8 h-8 mx-auto mb-4 inline-block"
                    style={{
                      backgroundColor: '#0084FF',
                      WebkitMaskImage: 'url(/baza.svg)',
                      maskImage: 'url(/baza.svg)',
                      WebkitMaskRepeat: 'no-repeat',
                      maskRepeat: 'no-repeat',
                      WebkitMaskSize: 'contain',
                      maskSize: 'contain',
                      WebkitMaskPosition: 'center',
                      maskPosition: 'center'
                    }}
                  />
                  <h3 className="text-[20px] font-medium mb-2" style={{ color: '#8E8E93', opacity: 0.7 }}>
                    {selectedNicheId 
                      ? `–ù–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –Ω–∏—à–∏ "${availableNiches.find(n => n.id === selectedNicheId)?.name || '–í—ã–±—Ä–∞–Ω–Ω–∞—è –Ω–∏—à–∞'}"`
                      : '–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–æ–∫–∞ –ø—É—Å—Ç–∞'
                    }
                  </h3>
                  <p className="text-sm mb-6" style={{ color: '#8E8E93', opacity: 0.7 }}>
                    {selectedNicheId 
                      ? '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–Ω–∞–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–∏—à–∏ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –Ω–∏—à—É'
                      : '–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–µ—Å—É—Ä—Å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å Adapto'
                    }
                  </p>
                </div>
              </div>
              )}
            </div>

            {/* –í—ã–±–æ—Ä –Ω–∏—à–∏ –∫–∞–∫ –ø–ª–∞—à–∫–∞ —Å —Ç–∞–±–∞–º–∏ */}
            <div className="relative rounded-[20px] border border-[#070F1A]/10 p-6 text-center bg-transparent overflow-hidden">
              {/* –¶–≤–µ—Ç–Ω–æ–π –ø–æ–ª—É–∫—Ä—É–≥ —Å–≤–µ—Ä—Ö—É (blur) */}
              <div
                className="absolute left-1/2 -translate-x-1/2 -top-10 w-[240px] h-[120px] rounded-b-[240px] blur-[120px] opacity-50 pointer-events-none"
                style={{ background: selectedNicheId ? getNicheColor(selectedNicheId) : '#E5E6E7', zIndex: 0 }}
              />
              <h3 className="text-[20px] font-[500] text-[#070F1A] mb-[10px]">
                {selectedNicheId
                  ? (<>
                      –í–∞—à–∞ –Ω–∏—à–∞: <span style={{ color: getNicheColor(selectedNicheId) }}>{getNicheDisplayName(availableNiches.find(n=>n.id===selectedNicheId)?.name || '')}</span>
                    </>)
                  : '–í–∞—à–∞ –Ω–∏—à–∞'}
              </h3>
              <p className="text-[14px] text-[#8E8E93] mb-[30px]">–î–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é –Ω–∏—à—É</p>
              <div className="relative z-10 flex flex-wrap justify-center gap-2">
                {([ {id:'', name:'–ë–µ–∑ –Ω–∏—à–∏'}, ...availableNiches.slice(0,10).map(n=>({ ...n, name: getNicheDisplayName(n.name) })) ]).map((niche) => {
                  const isActive = (selectedNicheId || '') === (niche.id || '');
                  const nicheClr = niche.id ? getNicheColor(niche.id) : '#8EE38A';
                  const activeBg = isActive ? (niche.id ? nicheClr : '#070F1A') : 'transparent';
                  return (
                    <button
                      key={niche.id || 'none'}
                      onClick={() => handleSelectNiche(niche.id || '')}
                      className={`h-[34px] px-4 rounded-[90px] text-[13px] font-[500] border transition-colors`}
                      style={{
                        backgroundColor: activeBg,
                        color: isActive ? '#FFFFFF' : '#8E8E93',
                        borderColor: isActive ? activeBg : '#E5E6E7'
                      }}
                    >
                      {niche.name}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* –†–µ—Å—É—Ä—Å—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */}
              <div className="grid grid-cols-2 lg:grid-cols-4 gap-4" style={{ marginLeft: '1px', marginRight: '1px' }}>
              {/* –í–µ–±-—Å–∞–π—Ç */}
              <div 
                className={`border border-[#070F1A]/10 bg-white rounded-[15px] group hover:-translate-y-[10px] transition-all duration-300 cursor-pointer overflow-hidden ${sidebarCollapsed ? 'h-[280px]' : 'h-[255px]'}`}
                onClick={handleSitePopupOpen}
              >
                <div className="w-full h-full flex flex-col">
                    <div className="w-full flex-shrink-0" style={{ borderRadius: '15px 15px 0 0' }}>
                      <img src="/Frame 2081.png" alt="–í–µ–±-—Å–∞–π—Ç" className="w-[101%] h-auto" />
                    </div>
                  <div className="flex-1 p-[16px]">
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">–í–µ–±-—Å–∞–π—Ç</h3>
                    <p className="text-[12px] text-[#8E8E93]">–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç, —á—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å –ò–ò –∑–Ω–∞–Ω–∏—è–º–∏</p>
                  </div>
                </div>
              </div>

              {/* –¢–æ–≤–∞—Ä–Ω—ã–π —Ñ–∏–¥ */}
              <div 
                className={`border border-[#070F1A]/10 bg-white rounded-[15px] group hover:-translate-y-[10px] transition-all duration-300 cursor-pointer overflow-hidden ${sidebarCollapsed ? 'h-[280px]' : 'h-[255px]'}`}
                onClick={handleFeedPopupOpen}
              >
                <div className="w-full h-full flex flex-col">
                  <div className="w-full flex-shrink-0" style={{ borderRadius: '15px 15px 0 0' }}>
                    <img src="/Frame 2082.png" alt="–¢–æ–≤–∞—Ä–Ω—ã–π —Ñ–∏–¥" className="w-[101%] h-auto" />
                  </div>
                  <div className="flex-1 p-[16px]">
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">–¢–æ–≤–∞—Ä–Ω—ã–π —Ñ–∏–¥</h3>
                    <p className="text-[12px] text-[#8E8E93]">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV/XML —Ñ–∏–¥ –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥</p>
                  </div>
                </div>
              </div>

              {/* –§–∞–π–ª */}
              <div 
                className={`border border-[#070F1A]/10 bg-white rounded-[15px] group hover:-translate-y-[10px] transition-all duration-300 cursor-pointer overflow-hidden ${sidebarCollapsed ? 'h-[280px]' : 'h-[255px]'}`}
                onClick={handleFilePopupOpen}
              >
                <div className="w-full h-full flex flex-col">
                  <div className="w-full flex-shrink-0" style={{ borderRadius: '15px 15px 0 0' }}>
                    <img src="/Frame 2083.png" alt="–§–∞–π–ª" className="w-[101%] h-auto" />
                  </div>
                  <div className="flex-1 p-[16px]">
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">–§–∞–π–ª</h3>
                    <p className="text-[12px] text-[#8E8E93]">–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∑–Ω–∞–Ω–∏—è –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–ª–∏ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –ò–ò</p>
                  </div>
                </div>
              </div>

              {/* –¢–µ–∫—Å—Ç */}
              <div 
                className={`border border-[#070F1A]/10 bg-white rounded-[15px] group hover:-translate-y-[10px] transition-all duration-300 cursor-pointer overflow-hidden ${sidebarCollapsed ? 'h-[280px]' : 'h-[255px]'}`}
                onClick={handleTextPopupOpen}
              >
                <div className="w-full h-full flex flex-col">
                  <div className="w-full flex-shrink-0" style={{ borderRadius: '15px 15px 0 0' }}>
                    <img src="/Frame 2084.png" alt="–¢–µ–∫—Å—Ç" className="w-[101%] h-auto" />
                  </div>
                  <div className="flex-1 p-[16px]">
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">–¢–µ–∫—Å—Ç</h3>
                    <p className="text-[12px] text-[#8E8E93]">–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å –ò–ò</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );

      case 'statistics':
        return (
          <div className="space-y-6">
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º –∏ —ç–∫—Å–ø–æ—Ä—Ç–æ–º */}
            <div className="flex justify-between items-center mb-4">
            <h1 className="text-[20px] font-[500]">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
              <div className="flex gap-3">
                {/* –ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å */}
                <div className="relative">
                  <Button 
                    variant="outline" 
                    size="sm" 
                    onClick={() => {
                      console.log('Calendar button clicked');
                      setShowCalendar(!showCalendar);
                    }}
                    className="h-[34px] bg-[#0084FF] text-white rounded-[10px] border-none"
                    style={BUTTON_STYLES.blueButton}
                  >
                    <svg width="17" height="17" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg" className="mr-[5px]">
                      <path fillRule="evenodd" clipRule="evenodd" d="M3.43597 4.18404C3 5.03969 3 6.15979 3 8.4V13.6C3 15.8402 3 16.9603 3.43597 17.816C3.81947 18.5686 4.43139 19.1805 5.18404 19.564C6.03969 20 7.15979 20 9.4 20H14.6C16.8402 20 17.9603 20 18.816 19.564C19.5686 19.1805 20.1805 18.5686 20.564 17.816C21 16.9603 21 15.8402 21 13.6V8.4C21 6.15979 21 5.03969 20.564 4.18404C20.1805 3.43139 19.5686 2.81947 18.816 2.43597C17.9603 2 16.9603 2 14.6 2H9.4C7.15979 2 6.03969 2 5.18404 2.43597C4.43139 2.81947 3.81947 3.43139 3.43597 4.18404ZM5.10899 7.54601C5 7.75992 5 8.03995 5 8.6V14.8C5 15.9201 5 16.4802 5.21799 16.908C5.40973 17.2843 5.71569 17.5903 6.09202 17.782C6.51984 18 7.0799 18 8.2 18H15.8C16.9201 18 17.4802 18 17.908 17.782C18.2843 17.5903 18.5903 17.2843 18.782 16.908C19 16.4802 19 15.9201 19 14.8V8.6C19 8.03995 19 7.75992 18.891 7.54601C18.7951 7.35785 18.6422 7.20487 18.454 7.10899C18.2401 7 17.9601 7 17.4 7H6.6C6.03995 7 5.75992 7 5.54601 7.10899C5.35785 7.20487 5.20487 7.35785 5.10899 7.54601Z" fill="white"/>
                    </svg>
                    {dateRange.start && dateRange.end 
                      ? `${dateRange.start.toLocaleDateString()} - ${dateRange.end.toLocaleDateString()}`
                      : '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥'
                    }
                  </Button>
                  
                  {showCalendar && (
                    <div className="absolute top-full right-0 mt-2 bg-white border border-gray-200 rounded-[15px] shadow-lg z-50 w-[400px]">
                      <div className="p-4">
                        <div className="flex items-center justify-between mb-4">
                          <h4 className="font-medium text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</h4>
                          <button onClick={() => setShowCalendar(false)} className="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4 text-gray-500">
                              <path d="M18 6 6 18"></path>
                              <path d="m6 6 12 12"></path>
                            </svg>
                          </button>
                        </div>
                        
                        {/* –ë—ã—Å—Ç—Ä—ã–µ –æ–ø—Ü–∏–∏ */}
                        <div className="mb-4">
                          <div className="grid grid-cols-3 gap-2">
                            <button 
                              className={`px-3 h-[34px] rounded-[90px] text-center transition-colors text-[13px] ${
                                activeQuickSelect === 'today' ? 'bg-[#0084FF] text-white' : 'bg-gray-100 hover:bg-gray-200'
                              }`}
                              style={activeQuickSelect === 'today' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                              onClick={() => {
                                const today = new Date();
                                setDateRange({ start: today, end: today });
                                setDateStartInput(formatDateInputValue(`${String(today.getDate()).padStart(2,'0')}${String(today.getMonth()+1).padStart(2,'0')}${today.getFullYear()}`));
                                setDateEndInput(formatDateInputValue(`${String(today.getDate()).padStart(2,'0')}${String(today.getMonth()+1).padStart(2,'0')}${today.getFullYear()}`));
                                setActiveQuickSelect('today');
                                updateStatisticsForPeriod(today, today);
                              }}
                            >
                              –°–µ–≥–æ–¥–Ω—è
                            </button>
                            <button 
                              className={`px-3 h-[34px] rounded-[90px] text-center transition-colors text-[13px] ${
                                activeQuickSelect === 'yesterday' ? 'bg-[#0084FF] text-white' : 'bg-gray-100 hover:bg-gray-200'
                              }`}
                              style={activeQuickSelect === 'yesterday' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                              onClick={() => {
                                const yesterday = new Date();
                                yesterday.setDate(yesterday.getDate() - 1);
                                setDateRange({ start: yesterday, end: yesterday });
                                setDateStartInput(formatDateInputValue(`${String(yesterday.getDate()).padStart(2,'0')}${String(yesterday.getMonth()+1).padStart(2,'0')}${yesterday.getFullYear()}`));
                                setDateEndInput(formatDateInputValue(`${String(yesterday.getDate()).padStart(2,'0')}${String(yesterday.getMonth()+1).padStart(2,'0')}${yesterday.getFullYear()}`));
                                setActiveQuickSelect('yesterday');
                              }}
                            >
                              –í—á–µ—Ä–∞
                            </button>
                            <button 
                              className={`px-3 h-[34px] rounded-[90px] text-center transition-colors text-[13px] ${
                                activeQuickSelect === 'last7days' ? 'bg-[#0084FF] text-white' : 'bg-gray-100 hover:bg-gray-200'
                              }`}
                              style={activeQuickSelect === 'last7days' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                              onClick={() => {
                                const today = new Date();
                                const weekAgo = new Date();
                                weekAgo.setDate(today.getDate() - 6);
                                setDateRange({ start: weekAgo, end: today });
                                setDateStartInput(formatDateInputValue(`${String(weekAgo.getDate()).padStart(2,'0')}${String(weekAgo.getMonth()+1).padStart(2,'0')}${weekAgo.getFullYear()}`));
                                setDateEndInput(formatDateInputValue(`${String(today.getDate()).padStart(2,'0')}${String(today.getMonth()+1).padStart(2,'0')}${today.getFullYear()}`));
                                setActiveQuickSelect('last7days');
                              }}
                            >
                              7 –¥–Ω–µ–π
                            </button>
                            <button 
                              className={`px-3 h-[34px] rounded-[90px] text-center transition-colors text-[13px] ${
                                activeQuickSelect === 'thisMonth' ? 'bg-[#0084FF] text-white' : 'bg-gray-100 hover:bg-gray-200'
                              }`}
                              style={activeQuickSelect === 'thisMonth' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                              onClick={() => {
                                const today = new Date();
                                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                                setDateRange({ start: firstDay, end: lastDay });
                                setDateStartInput(formatDateInputValue(`${String(firstDay.getDate()).padStart(2,'0')}${String(firstDay.getMonth()+1).padStart(2,'0')}${firstDay.getFullYear()}`));
                                setDateEndInput(formatDateInputValue(`${String(lastDay.getDate()).padStart(2,'0')}${String(lastDay.getMonth()+1).padStart(2,'0')}${lastDay.getFullYear()}`));
                                setActiveQuickSelect('thisMonth');
                              }}
                            >
                              –≠—Ç–æ—Ç –º–µ—Å—è—Ü
                            </button>
                            <button 
                              className={`px-3 h-[34px] rounded-[90px] text-center transition-colors text-[13px] ${
                                activeQuickSelect === 'last30days' ? 'bg-[#0084FF] text-white' : 'bg-gray-100 hover:bg-gray-200'
                              }`}
                              style={activeQuickSelect === 'last30days' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                              onClick={() => {
                                const today = new Date();
                                const monthAgo = new Date();
                                monthAgo.setDate(today.getDate() - 29);
                                setDateRange({ start: monthAgo, end: today });
                                setDateStartInput(formatDateInputValue(`${String(monthAgo.getDate()).padStart(2,'0')}${String(monthAgo.getMonth()+1).padStart(2,'0')}${monthAgo.getFullYear()}`));
                                setDateEndInput(formatDateInputValue(`${String(today.getDate()).padStart(2,'0')}${String(today.getMonth()+1).padStart(2,'0')}${today.getFullYear()}`));
                                setActiveQuickSelect('last30days');
                              }}
                            >
                              30 –¥–Ω–µ–π
                            </button>
                            <button 
                              className={`px-3 h-[34px] rounded-[90px] text-center transition-colors text-[13px] ${
                                activeQuickSelect === 'last90days' ? 'bg-[#0084FF] text-white' : 'bg-gray-100 hover:bg-gray-200'
                              }`}
                              style={activeQuickSelect === 'last90days' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                              onClick={() => {
                                const today = new Date();
                                const threeMonthsAgo = new Date();
                                threeMonthsAgo.setDate(today.getDate() - 89);
                                setDateRange({ start: threeMonthsAgo, end: today });
                                setDateStartInput(formatDateInputValue(`${String(threeMonthsAgo.getDate()).padStart(2,'0')}${String(threeMonthsAgo.getMonth()+1).padStart(2,'0')}${threeMonthsAgo.getFullYear()}`));
                                setDateEndInput(formatDateInputValue(`${String(today.getDate()).padStart(2,'0')}${String(today.getMonth()+1).padStart(2,'0')}${today.getFullYear()}`));
                                setActiveQuickSelect('last90days');
                              }}
                            >
                              90 –¥–Ω–µ–π
                            </button>
                          </div>
                        </div>
                        
                        {/* –ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å */}
                        <div className="mb-4">
                          <div className="flex justify-between items-center mb-2">
                            <button 
                              onClick={() => {
                                setCurrentMonth(prev => {
                                  const newMonth = new Date(prev);
                                  newMonth.setMonth(newMonth.getMonth() - 1);
                                  return newMonth;
                                });
                              }}
                              className="p-1 hover:bg-gray-100 rounded"
                            >
                              ‚Üê
                            </button>
                            <span className="text-sm font-medium">
                              {currentMonth.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })}
                            </span>
                            <button 
                              onClick={() => {
                                setCurrentMonth(prev => {
                                  const newMonth = new Date(prev);
                                  newMonth.setMonth(newMonth.getMonth() + 1);
                                  return newMonth;
                                });
                              }}
                              className="p-1 hover:bg-gray-100 rounded"
                            >
                              ‚Üí
                            </button>
                          </div>
                          
                          {/* –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ */}
                          <div className="grid grid-cols-7 gap-1 mb-1">
                            {['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map(day => (
                              <div key={day} className="text-xs text-gray-500 text-center" style={{ width: '49px' }}>
                                {day}
                              </div>
                            ))}
                          </div>
                          
                          {/* –°–µ—Ç–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */}
                          <div className="grid grid-cols-7 gap-1">
                            {(() => {
                              const days = [];
                              const year = currentMonth.getFullYear();
                              const month = currentMonth.getMonth();
                              const firstDay = new Date(year, month, 1);
                              const lastDay = new Date(year, month + 1, 0);
                              const firstDayOfWeek = firstDay.getDay();
                              const startOffset = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
                              
                              // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –Ω–∞—á–∞–ª–µ
                              for (let i = 0; i < startOffset; i++) {
                                days.push(null);
                              }
                              
                              // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ –º–µ—Å—è—Ü–∞
                              for (let day = 1; day <= lastDay.getDate(); day++) {
                                days.push(new Date(year, month, day));
                              }
                              
                              // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –∫–æ–Ω—Ü–µ –¥–æ 42 —è—á–µ–µ–∫
                              while (days.length < 42) {
                                days.push(null);
                              }
                              
                              return days.map((date, index) => {
                                if (!date) {
                                  return <div key={index} className="w-[49px] h-8"></div>;
                                }
                                
                                const today = new Date();
                                const isToday = date.toDateString() === today.toDateString();
                                const isSelected = dateRange.start && date.toDateString() === dateRange.start.toDateString();
                                const isInRange = dateRange.start && dateRange.end && 
                                  date >= dateRange.start && date <= dateRange.end;
                                
                                let className = "h-8 rounded hover:bg-gray-100 text-center text-xs cursor-pointer inline-flex items-center justify-center";
                                
                                if (isSelected) {
                                  className += " bg-[#F3F5F7] text-[#070F1A]";
                                } else if (isInRange) {
                                  className += " bg-[#0084FF]/20 text-[#0084FF]";
                                } else if (isToday) {
                                  className += " bg-gray-200 text-gray-800";
                                }
                                
                                return (
                                  <button
                                    key={index}
                                    onClick={() => {
                                      if (dateRange.start && !dateRange.end) {
                                        setDateRange(prev => ({ ...prev, end: date }));
                                      } else {
                                        setDateRange({ start: date, end: null });
                                      }
                                      setActiveQuickSelect(null);
                                    }}
                                    className={className}
                                  style={{ width: '49px', paddingLeft: '8px', paddingRight: '8px' }}
                                  >
                                    {date.getDate()}
                                  </button>
                                );
                              });
                            })()}
                          </div>
                        </div>
                        
                        {/* –†—É—á–Ω–æ–π –≤–≤–æ–¥ –¥–∞—Ç */}
                        <div className="mb-4">
                          <div className="grid grid-cols-2 gap-2">
                            <div>
                              <input
                                type="text"
                                value={dateStartInput}
                                onChange={(e) => {
                                  const v = formatDateInputValue(e.target.value);
                                  setDateStartInput(v);
                                  setDateStartError(false);
                                }}
                                onBlur={() => {
                                  if (!isValidDateDmy(dateStartInput)) {
                                    setDateStartError(true);
                                    return;
                                  }
                                  const d = parseDmyToDate(dateStartInput);
                                  if (d) {
                                    setDateRange(prev => ({ ...prev, start: d }));
                                    setActiveQuickSelect(null);
                                  }
                                }}
                                placeholder="–î–î.–ú–ú.–ì–ì–ì–ì"
                                className={`w-full h-[34px] px-3 text-[12px] border rounded-[10px] ${dateStartError ? 'border-red-400' : 'border-gray-300'}`}
                              />
                            </div>
                            <div>
                              <input
                                type="text"
                                value={dateEndInput}
                                onChange={(e) => {
                                  const v = formatDateInputValue(e.target.value);
                                  setDateEndInput(v);
                                  setDateEndError(false);
                                }}
                                onBlur={() => {
                                  if (!isValidDateDmy(dateEndInput)) {
                                    setDateEndError(true);
                                    return;
                                  }
                                  const d = parseDmyToDate(dateEndInput);
                                  if (d) {
                                    setDateRange(prev => ({ ...prev, end: d }));
                                    setActiveQuickSelect(null);
                                  }
                                }}
                                placeholder="–î–î.–ú–ú.–ì–ì–ì–ì"
                                className={`w-full h-[34px] px-3 text-[12px] border rounded-[10px] ${dateEndError ? 'border-red-400' : 'border-gray-300'}`}
                              />
                            </div>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-2">
                          <button 
                            onClick={() => setShowCalendar(false)}
                            className="h-[34px] w-full bg-[#0084FF] text-white hover:bg-[#0073E6] rounded-[10px]"
                            style={BUTTON_STYLES.blueButton}
                          >
                            –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                          </button>
                          <button 
                            onClick={() => {
                              setDateRange({ start: null, end: null });
                              setActiveQuickSelect(null);
                              setDateStartInput('');
                              setDateEndInput('');
                              setShowCalendar(false);
                            }}
                            className="h-[34px] w-full text-gray-700 hover:bg-[#E5E7EB] rounded-[10px]"
                            style={BUTTON_STYLES.whiteButton}
                          >
                            –°–±—Ä–æ—Å–∏—Ç—å
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                
                {/* –≠–∫—Å–ø–æ—Ä—Ç */}
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => exportToCSV()}
                    className="h-[34px] text-[#070F1A] rounded-[10px]"
                    style={BUTTON_STYLES.whiteButton}
                  >
                    <svg width="17" height="17" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" className="mr-[5px]">
                      <path d="M10 0.500244C15.2467 0.500244 19.5 4.75354 19.5 10.0002C19.5 15.2469 15.2467 19.5002 10 19.5002C4.75329 19.5002 0.5 15.2469 0.5 10.0002C0.5 4.75354 4.75329 0.500244 10 0.500244ZM10.5312 5.18384C10.2567 4.90956 9.82182 4.89203 9.52734 5.13208L9.4707 5.18384L6.04199 8.61255C5.74926 8.90535 5.7494 9.3802 6.04199 9.6731C6.33487 9.9659 6.80966 9.9659 7.10254 9.6731L9.25098 7.52466V14.2854C9.25098 14.6996 9.58683 15.0353 10.001 15.0354C10.4151 15.0353 10.751 14.6996 10.751 14.2854V7.52466L12.8994 9.6731C13.1923 9.96578 13.6671 9.96592 13.96 9.6731C14.2526 9.38026 14.2526 8.90539 13.96 8.61255L10.5312 5.18384Z" fill="#070F1A"/>
                    </svg>
                    CSV
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => exportToXLS()}
                    className="h-[34px] text-[#070F1A] rounded-[10px]"
                    style={BUTTON_STYLES.whiteButton}
                  >
                    <svg width="17" height="17" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" className="mr-[5px]">
                      <path d="M10 0.500244C15.2467 0.500244 19.5 4.75354 19.5 10.0002C19.5 15.2469 15.2467 19.5002 10 19.5002C4.75329 19.5002 0.5 15.2469 0.5 10.0002C0.5 4.75354 4.75329 0.500244 10 0.500244ZM10.5312 5.18384C10.2567 4.90956 9.82182 4.89203 9.52734 5.13208L9.4707 5.18384L6.04199 8.61255C5.74926 8.90535 5.7494 9.3802 6.04199 9.6731C6.33487 9.9659 6.80966 9.9659 7.10254 9.6731L9.25098 7.52466V14.2854C9.25098 14.6996 9.58683 15.0353 10.001 15.0354C10.4151 15.0353 10.751 14.6996 10.751 14.2854V7.52466L12.8994 9.6731C13.1923 9.96578 13.6671 9.96592 13.96 9.6731C14.2526 9.38026 14.2526 8.90539 13.96 8.61255L10.5312 5.18384Z" fill="#070F1A"/>
                    </svg>
                    XLS
                  </Button>
                </div>
              </div>
            </div>
            
            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
            <div className="h-px bg-[#E5E7EB] mb-4" style={{ marginLeft: '-32px', marginRight: '-32px' }}></div>
            
            {/* –¢–∞–±—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */}
            <div>
              <div className="flex">
                <div className="flex-1 relative">
                  <button
                    onClick={() => setActiveStatisticsTab('general')}
                    className={`w-full py-3 px-4 text-[14px] font-medium transition-colors ${
                      activeStatisticsTab === 'general'
                        ? 'text-[#0084FF]'
                        : 'text-[#8E8E93] hover:text-[#0084FF]'
                    }`}
                  >
                    –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
                  </button>
                  {activeStatisticsTab === 'general' && (
                    <div className="absolute bottom-0 left-0 right-0 h-[4px] bg-[#0084FF] rounded-t-[4px]"></div>
                  )}
                    </div>
                <div className="flex-1 relative">
                  <button
                    onClick={() => setActiveStatisticsTab('conversion')}
                    className={`w-full py-3 px-4 text-[14px] font-medium transition-colors ${
                      activeStatisticsTab === 'conversion'
                        ? 'text-[#0084FF]'
                        : 'text-[#8E8E93] hover:text-[#0084FF]'
                    }`}
                  >
                    –ú–µ—Ç—Ä–∏–∫–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–π
                  </button>
                  {activeStatisticsTab === 'conversion' && (
                    <div className="absolute bottom-0 left-0 right-0 h-[4px] bg-[#0084FF] rounded-t-[4px]"></div>
                  )}
                  </div>
                <div className="flex-1 relative">
                  <button
                    onClick={() => setActiveStatisticsTab('technical')}
                    className={`w-full py-3 px-4 text-[14px] font-medium transition-colors ${
                      activeStatisticsTab === 'technical'
                        ? 'text-[#0084FF]'
                        : 'text-[#8E8E93] hover:text-[#0084FF]'
                    }`}
                  >
                    –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
                  </button>
                  {activeStatisticsTab === 'technical' && (
                    <div className="absolute bottom-0 left-0 right-0 h-[4px] bg-[#0084FF] rounded-t-[4px]"></div>
                  )}
                  </div>
                <div className="flex-1 relative">
                  <button
                    onClick={() => setActiveStatisticsTab('channels')}
                    className={`w-full py-3 px-4 text-[14px] font-medium transition-colors ${
                      activeStatisticsTab === 'channels'
                        ? 'text-[#0084FF]'
                        : 'text-[#8E8E93] hover:text-[#0084FF]'
                    }`}
                  >
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º
                  </button>
                  {activeStatisticsTab === 'channels' && (
                    <div className="absolute bottom-0 left-0 right-0 h-[4px] bg-[#0084FF] rounded-t-[4px]"></div>
                  )}
                  </div>
                </div>
              </div>
              <div className="border-b mb-0 mt-0" style={{ borderColor: '#E5E6E7', marginTop: 0, marginLeft: '-32px', marginRight: '-32px' }}></div>

            {/* –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–æ–≤ */}
            {activeStatisticsTab === 'general' && (
              <div className="space-y-6">
                {dialogsData.length === 0 ? (
                  // –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                  <div className="flex flex-col items-center justify-center py-16">
                    <span
                      className="w-8 h-8 mb-6 inline-block"
                      style={{
                        backgroundColor: '#0084FF',
                        WebkitMaskImage: 'url(/stat.svg)',
                        maskImage: 'url(/stat.svg)',
                        WebkitMaskRepeat: 'no-repeat',
                        maskRepeat: 'no-repeat',
                        WebkitMaskSize: 'contain',
                        maskSize: 'contain',
                        WebkitMaskPosition: 'center',
                        maskPosition: 'center'
                      }}
                    />
                    <h3 className="text-[20px] font-[500] mb-3" style={{ color: '#8E8E93', opacity: 0.7 }}>–ü–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
                    <p className="text-[14px] text-center max-w-[400px] mb-8" style={{ color: '#8E8E93', opacity: 0.7 }}>
                      –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–Ω—É—Ç –æ–±—â–∞—Ç—å—Å—è —Å –≤–∞—à–∏–º –ò–ò-–∞–≥–µ–Ω—Ç–æ–º
                    </p>
                    <div className="flex flex-col gap-[10px] w-full max-w-[380px]">
                      <button
                        onClick={() => {
                          setActiveSection('widget-dev');
                          // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –≤–∏–¥–∂–µ—Ç–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
                          ChatUtils.scrollToBottom(widgetChatRef, 500);
                        }}
                        className="w-full h-[34px] px-6 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                        style={BUTTON_STYLES.blueButton}
                      >
                        –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥–∂–µ—Ç
                      </button>
                      <button
                        onClick={() => setActiveSection('my-adapto')}
                        className="w-full h-[34px] px-6 text-[#070F1A] rounded-[10px] hover:bg-[#F9FAFB] transition-colors"
                        style={BUTTON_STYLES.whiteButton}
                      >
                        –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ò–ò
                      </button>
                    </div>
                  </div>
                ) : (
                  <>
                {/* –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <Card className="shadow-none">
                    <CardContent className="p-[15px] h-[130px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                        <div 
                          onMouseEnter={(e) => handleMetricHover('widget-opens', e)}
                          onMouseLeave={handleMetricLeave}
                          className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                        >
                          <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                          </svg>
                        </div>
                        <p className="text-[14px] font-[500] text-[#8E8E93]">–ö–æ–ª-–≤–æ –æ—Ç–∫—Ä—ã—Ç–∏–π –≤–∏–¥–∂–µ—Ç–∞</p>
                    </div>
                                              <div className="flex flex-col">
                                                  <div className="flex items-end">
                          <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{statisticsAggregates.widget_opens || 0}</p>
                          {generateTrendIndicator('neutral', '0%')}
                  </div>
                </div>
                    </CardContent>
                  </Card>

                  <Card className="shadow-none">
                    <CardContent className="p-[15px] h-[130px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                        <div 
                          onMouseEnter={(e) => handleMetricHover('dialog-count', e)}
                          onMouseLeave={handleMetricLeave}
                          className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                        >
                          <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                          </svg>
                        </div>
                        <p className="text-[14px] font-[500] text-[#8E8E93]">–ö–æ–ª-–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤</p>
                  </div>
                                              <div className="flex flex-col">
                                                  <div className="flex items-end">
                          <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{statisticsAggregates.dialogsTotal || 0}</p>
                          {generateTrendIndicator('neutral', '0%')}
                  </div>
                </div>
                    </CardContent>
                  </Card>

                  <Card className="shadow-none">
                    <CardContent className="p-[15px] h-[130px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                        <div 
                          onMouseEnter={(e) => handleMetricHover('message-count', e)}
                          onMouseLeave={handleMetricLeave}
                          className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                        >
                          <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                          </svg>
                        </div>
                        <p className="text-[14px] font-[500] text-[#8E8E93]">–ö–æ–ª-–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
              </div>
                                              <div className="flex flex-col">
                                                  <div className="flex items-end">
                          <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{statisticsAggregates.messagesTotal || 0}</p>
                          {generateTrendIndicator('neutral', '0%')}
                        </div>
                </div>
                    </CardContent>
                  </Card>

                  <Card className="shadow-none">
                    <CardContent className="p-[15px] h-[130px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                        <div 
                          onMouseEnter={(e) => handleMetricHover('avg-messages-per-dialog', e)}
                          onMouseLeave={handleMetricLeave}
                          className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                        >
                          <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                          </svg>
                        </div>
                        <p className="text-[14px] font-[500] text-[#8E8E93]">–°—Ä. –∫–æ–ª-–≤–æ —Å–º—Å –Ω–∞ –¥–∏–∞–ª–æ–≥</p>
                    </div>
                                              <div className="flex flex-col">
                                                  <div className="flex items-end">
                          <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{statisticsAggregates.avgMessagesPerDialog?.toFixed(2) || '0.00'}</p>
                          {generateTrendIndicator('neutral', '0')}
                  </div>
                </div>
                    </CardContent>
                  </Card>
                  </div>

                {/* –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */}
                <Card className="shadow-none">
                  <CardHeader>
                    <h3 style={{fontWeight: 500}} className="text-lg font-semibold leading-none tracking-tight text-[18px] font-[500] text-[#070F1A]">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h3>
                  </CardHeader>
                  <CardContent>
                    <div className="h-[300px] flex items-center justify-center">
                      <HourlyActivityChart userId={currentUser?.id} startDate={dateRange.start} endDate={dateRange.end} />
                    </div>
                  </CardContent>
                </Card>
                  </>
                )}
              </div>
            )}

            {activeStatisticsTab === 'conversion' && (
              <div className="space-y-6">
                {dialogsData.length === 0 ? (
                  // –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–µ—Ç—Ä–∏–∫ –∫–æ–Ω–≤–µ—Ä—Å–∏–π
                  <div className="flex flex-col items-center justify-center py-16">
                    <span
                      className="w-8 h-8 mb-6 inline-block"
                      style={{
                        backgroundColor: '#0084FF',
                        WebkitMaskImage: 'url(/stat.svg)',
                        maskImage: 'url(/stat.svg)',
                        WebkitMaskRepeat: 'no-repeat',
                        maskRepeat: 'no-repeat',
                        WebkitMaskSize: 'contain',
                        maskSize: 'contain',
                        WebkitMaskPosition: 'center',
                        maskPosition: 'center'
                      }}
                    />
                    <h3 className="text-[20px] font-[500] mb-3" style={{ color: '#8E8E93', opacity: 0.7 }}>–ü–æ–∫–∞ –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫ –∫–æ–Ω–≤–µ—Ä—Å–∏–π</h3>
                    <p className="text-[14px] text-center max-w-[400px] mb-8" style={{ color: '#8E8E93', opacity: 0.7 }}>
                      –ú–µ—Ç—Ä–∏–∫–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–π –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
                    </p>
                    <div className="flex flex-col gap-[10px] w-full max-w-[380px]">
                    <button
                      onClick={() => setActiveSection('widget-dev')}
                        className="w-full h-[34px] px-6 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                        style={BUTTON_STYLES.blueButton}
                    >
                      –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥–∂–µ—Ç
                    </button>
                      <button
                        onClick={() => setActiveSection('my-adapto')}
                        className="w-full h-[34px] px-6 text-[#070F1A] rounded-[10px] hover:bg-[#F9FAFB] transition-colors"
                        style={BUTTON_STYLES.whiteButton}
                      >
                        –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ò–ò
                      </button>
                    </div>
                  </div>
                ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" style={{ paddingTop: '12px' }}>
                <Card className="shadow-none">
                  <CardContent className="p-[15px] h-[170px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                      <div 
                        onMouseEnter={(e) => handleMetricHover('conversion-rate', e)}
                        onMouseLeave={handleMetricLeave}
                        className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                      >
                        <svg fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                      </div>
                                              <p className="text-[14px] font-[500] text-[#8E8E93]">–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å</p>
                    </div>
                    <div className="flex flex-col">
                      <div className="flex items-end">
                        <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{Math.round(statisticsAggregates.conversionRate || 0)}%</p>
                        {generateTrendIndicator('neutral', '0%')}
                  </div>
                </div>
                  </CardContent>
                </Card>

                <Card className="shadow-none">
                  <CardContent className="p-[15px] h-[170px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                      <div 
                        onMouseEnter={(e) => handleMetricHover('bounce-rate', e)}
                        onMouseLeave={handleMetricLeave}
                        className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                      >
                        <svg fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                      </div>
                                              <p className="text-[14px] font-[500] text-[#8E8E93]">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ–≤</p>
              </div>
                    <div className="flex flex-col">
                                              <div className="flex items-end">
                          <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{Math.round(statisticsAggregates.bounce_rate || 0)}%</p>
                          {generateTrendIndicator('neutral', '0%', false)}
                        </div>
                    </div>
                  </CardContent>
                </Card>

                <Card className="shadow-none">
                  <CardContent className="p-[15px] h-[170px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                      <div 
                        onMouseEnter={(e) => handleMetricHover('customer-engagement', e)}
                        onMouseLeave={handleMetricLeave}
                        className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                      >
                        <svg fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                      </div>
                                              <p className="text-[14px] font-[500] text-[#8E8E93]">–í–æ–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</p>
                    </div>
                    <div className="flex flex-col">
                      <div className="flex items-end">
                        <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{Math.round(statisticsAggregates.customer_engagement || 0)}%</p>
                        {generateTrendIndicator('neutral', '0%')}
                  </div>
                </div>
                  </CardContent>
                </Card>

                <Card className="shadow-none">
                  <CardContent className="p-[15px] h-[170px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                      <div 
                        onMouseEnter={(e) => handleMetricHover('resolved-questions', e)}
                        onMouseLeave={handleMetricLeave}
                        className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                      >
                        <svg fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                      </div>
                                              <p className="text-[14px] font-[500] text-[#8E8E93]">–ö–æ–ª-–≤–æ —Ä–µ—à–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤</p>
              </div>
                                          <div className="flex flex-col">
                                                  <div className="flex items-end">
                        <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{statisticsAggregates.resolved_questions || 0}</p>
                        {generateTrendIndicator('neutral', '0')}
                  </div>
                </div>
                  </CardContent>
                </Card>

                                                                  <Card className="shadow-none">
                   <CardContent className="p-[15px] h-[170px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                       <div 
                         onMouseEnter={(e) => handleMetricHover('rejection-rate', e)}
                         onMouseLeave={handleMetricLeave}
                         className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                       >
                         <svg fill="currentColor" viewBox="0 0 24 24">
                           <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                         </svg>
                       </div>
                                               <p className="text-[14px] font-[500] text-[#8E8E93]">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π</p>
                    </div>
                                           <div className="flex flex-col">
                                                  <div className="flex items-end">
                            <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{Math.round(statisticsAggregates.escalation_rate || 0)}%</p>
                            {generateTrendIndicator('neutral', '0%', false)}
                  </div>
                </div>
                   </CardContent>
                 </Card>
              </div>
                )}
              </div>
            )}

            {activeStatisticsTab === 'technical' && (
              <div className="space-y-6">
                {dialogsData.length === 0 ? (
                  // –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫
                  <div className="flex flex-col items-center justify-center py-16">
                    <span
                      className="w-8 h-8 mb-6 inline-block"
                      style={{
                        backgroundColor: '#0084FF',
                        WebkitMaskImage: 'url(/stat.svg)',
                        maskImage: 'url(/stat.svg)',
                        WebkitMaskRepeat: 'no-repeat',
                        maskRepeat: 'no-repeat',
                        WebkitMaskSize: 'contain',
                        maskSize: 'contain',
                        WebkitMaskPosition: 'center',
                        maskPosition: 'center'
                      }}
                    />
                    <h3 className="text-[20px] font-[500] mb-3" style={{ color: '#8E8E93', opacity: 0.7 }}>–ü–æ–∫–∞ –Ω–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫</h3>
                    <p className="text-[14px] text-center max-w-[400px] mb-8" style={{ color: '#8E8E93', opacity: 0.7 }}>
                      –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
                    </p>
                    <div className="flex flex-col gap-[10px] w-full max-w-[380px]">
                      <button
                        onClick={() => setActiveSection('widget-dev')}
                        className="w-full h-[34px] px-6 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                        style={BUTTON_STYLES.blueButton}
                      >
                        –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥–∂–µ—Ç
                      </button>
                    <button
                      onClick={() => setActiveSection('my-adapto')}
                        className="w-full h-[34px] px-6 text-[#070F1A] rounded-[10px] hover:bg-[#F9FAFB] transition-colors"
                        style={BUTTON_STYLES.whiteButton}
                    >
                      –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ò–ò
                    </button>
                    </div>
                  </div>
                ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" style={{ paddingTop: '12px' }}>
                <Card className="shadow-none hover:bg-[#F9FAFB] hover:border-white transition-colors duration-150">
                   <CardContent className="p-[15px] h-[170px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                       <div 
                         onMouseEnter={(e) => handleMetricHover('avg-response-time', e)}
                         onMouseLeave={handleMetricLeave}
                         className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                       >
                         <svg fill="currentColor" viewBox="0 0 24 24">
                           <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                         </svg>
                       </div>
                                               <p className="text-[14px] font-[500] text-[#8E8E93]">–°—Ä. —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ –ò–ò-–∞–≥–µ–Ω—Ç–∞</p>
            </div>
                                                                                        <div className="flex flex-col">
                                                  <div className="flex items-end">
                          <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{Math.round(statisticsAggregates.avg_response_time || 0)}—Å</p>
                          {generateTrendIndicator('neutral', '0', false)}
                  </div>
                </div>
                   </CardContent>
                 </Card>

                                 <Card className="shadow-none">
                   <CardContent className="p-[15px] h-[170px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                       <div 
                         onMouseEnter={(e) => handleMetricHover('avg-resolution-time', e)}
                         onMouseLeave={handleMetricLeave}
                         className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                       >
                         <svg fill="currentColor" viewBox="0 0 24 24">
                           <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                         </svg>
                       </div>
                                               <p className="text-[14px] font-[500] text-[#8E8E93]">–°—Ä. —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞</p>
                  </div>
                                                                                        <div className="flex flex-col">
                                                  <div className="flex items-end">
                          <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{Math.round(statisticsAggregates.avg_resolution_time || 0)}–º</p>
                          {generateTrendIndicator('neutral', '0', false)}
                  </div>
                </div>
                </CardContent>
              </Card>

                                 <Card className="shadow-none">
                   <CardContent className="p-[15px] h-[170px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                     <div className="flex items-center gap-2" style={{ height: '21px' }}>
                       <div 
                         onMouseEnter={(e) => handleMetricHover('ai-effectiveness', e)}
                         onMouseLeave={handleMetricLeave}
                         className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                       >
                         <svg fill="currentColor" viewBox="0 0 24 24">
                           <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                         </svg>
                       </div>
                                               <p className="text-[14px] font-[500] text-[#8E8E93]">–û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ò–ò-–∞–≥–µ–Ω—Ç–∞</p>
                            </div>
                                           <div className="flex flex-col">
                                                  <div className="flex items-end">
                            <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{statisticsAggregates.ai_effectiveness_score?.toFixed(1) || '0.0'}/10</p>
                            {generateTrendIndicator('neutral', '0')}
                  </div>
                    </div>
                   </CardContent>
                 </Card>

                                 <Card className="shadow-none">
                   <CardContent className="p-[15px] h-[170px] flex flex-col justify-between" style={{ paddingTop: '15px' }}>
                     <div className="flex items-center gap-2" style={{ height: '21px' }}>
                       <div 
                         onMouseEnter={(e) => handleMetricHover('help-request-rate', e)}
                         onMouseLeave={handleMetricLeave}
                         className="w-4 h-4 text-gray-400 hover:text-gray-600 transition-colors relative cursor-help"
                       >
                         <svg fill="currentColor" viewBox="0 0 24 24">
                           <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                         </svg>
                       </div>
                                               <p className="text-[14px] font-[500] text-[#8E8E93]">–ü—Ä–æ—Ü–µ–Ω—Ç —á–∞—Ç–æ–≤ —Å –∑–∞–ø—Ä–æ—Å–æ–º –æ –ø–æ–º–æ—â–∏</p>
                     </div>
                                           <div className="flex flex-col">
                                                  <div className="flex items-end">
                            <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>{Math.round(statisticsAggregates.help_request_rate || 0)}%</p>
                            {generateTrendIndicator('neutral', '0%', false)}
                          </div>
                </div>
              </CardContent>
            </Card>
          </div>
                )}
              </div>
            )}

            {activeStatisticsTab === 'channels' && (
              <div className="space-y-6">
                {dialogsData.length === 0 ? (
                  // –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–∞–Ω–∞–ª–∞–º
                  <div className="flex flex-col items-center justify-center py-16">
                    <span
                      className="w-8 h-8 mb-6 inline-block"
                      style={{
                        backgroundColor: '#0084FF',
                        WebkitMaskImage: 'url(/stat.svg)',
                        maskImage: 'url(/stat.svg)',
                        WebkitMaskRepeat: 'no-repeat',
                        maskRepeat: 'no-repeat',
                        WebkitMaskSize: 'contain',
                        maskSize: 'contain',
                        WebkitMaskPosition: 'center',
                        maskPosition: 'center'
                      }}
                    />
                    <h3 className="text-[20px] font-[500] mb-3" style={{ color: '#8E8E93', opacity: 0.7 }}>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–Ω–∞–ª–∞–º</h3>
                    <p className="text-[14px] text-center max-w-[400px] mb-8" style={{ color: '#8E8E93', opacity: 0.7 }}>
                      –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
                    </p>
                    <div className="flex flex-col gap-[10px] w-full max-w-[380px]">
                      <button
                        onClick={() => setActiveSection('integrations')}
                        className="w-full h-[34px] px-6 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                        style={BUTTON_STYLES.blueButton}
                      >
                        –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
                      </button>
                      <button
                        onClick={() => setActiveSection('widget-dev')}
                        className="w-full h-[34px] px-6 text-[#070F1A] rounded-[10px] hover:bg-[#F9FAFB] transition-colors"
                        style={BUTTON_STYLES.whiteButton}
                      >
                        –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥–∂–µ—Ç
                      </button>
                    </div>
                  </div>
                ) : (
                  <ChannelStatistics userId={currentUser?.id} startDate={dateRange.start} endDate={dateRange.end} />
                )}
              </div>
            )}
          </div>
        );
      case 'integrations':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h1>
            </div>

            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
              {integrations.map((integration) => (
                <div 
                  key={integration.id}
                  className="border border-transparent rounded-[15px] p-[15px] group hover:border-[#070F1A]/10 transition-all duration-300"
                >
                  {/* –ö–æ–Ω—Ç–µ–Ω—Ç: –∏–∫–æ–Ω–∫–∞ –∏ —Ç–µ–∫—Å—Ç –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ */}
                  <div className="flex items-start gap-[15px] mb-[25px]">
                    {/* –ò–∫–æ–Ω–∫–∞ */}
                    <div className="flex-shrink-0">
                      <img src={`/${integration.icon}`} alt={integration.name} className="w-[50px] h-[50px]" />
  </div>

                    {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ */}
                    <div className="flex-1">
                      <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">{integration.name}</h3>
                      <p className="text-[12px] text-[#8E8E93]">{integration.description}</p>
                    </div>
                  </div>

                  {/* –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */}
                  <div className="w-full">
                    {integration.installed ? (
                      <button className="w-full h-[34px] border border-[#0084FF]/20 text-[#0084FF]/60 rounded-[12px] transition-colors hover:border-[#0084FF]/30 hover:text-[#0084FF]/80 text-[14px]">
                        –ü–æ–¥–∫–ª—é—á–µ–Ω–æ
                      </button>
                    ) : (
                      <button
                        onClick={() => handleInstallIntegration(integration)}
                        className="w-full h-[34px] bg-[#0084FF] text-white rounded-[12px] hover:bg-[#0084FF]/90 transition-colors text-[14px]"
                      >
                        –ü–æ–¥–∫–ª—é—á–∏—Ç—å
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>
            
            {/* –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ–± Instagram */}
            <div className="mt-8 text-center">
              <p className="text-[12px] text-[#8E8E93]">
                *Instagram —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–º Meta ‚Äì –ø—Ä–∏–∑–Ω–∞–Ω–Ω–æ–π –≤ –†–§ —ç–∫—Å—Ç—Ä–µ–º–∏—Å—Ç–∫–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π
              </p>
          </div>
          </div>
        );

      case 'model-settings':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[20px] font-[500] text-[#070F1A] mb-[16px]">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏</h1>
            </div>
            <div className="border-b" style={{ borderColor: '#E5E7EB', marginLeft: '-16px', marginRight: '-16px', marginTop: '0px' }}></div>



            {/* –®–∞–≥ 1: –£—Ç–æ—á–Ω–∏—Ç–µ —Ü–µ–ª–∏ Adapto */}
            <div className="mb-[50px]">
              <div className="flex items-center gap-[15px] mb-6">
                  <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-[90px] flex items-center justify-center mb-[20px]">
                    <span className="text-white text-[10px] font-medium">1</span>
                  </div>
                  <div>
                  <h3 className="text-[18px] font-[500] text-[#070F1A] tracking-[-3%]">–£—Ç–æ—á–Ω–∏—Ç–µ —Ü–µ–ª–∏ Adapto</h3>
                  <p className="text-[14px] text-[#8E8E93] tracking-[-2%]">
                      –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏ –≤–∞—à–µ–≥–æ –ò–ò-–∞–≥–µ–Ω—Ç–∞
                    </p>
                  </div>
                </div>
              {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è - –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤—ã—à–µ, –∑–¥–µ—Å—å —É–±—Ä–∞–Ω –ø–æ –ø—Ä–æ—Å—å–±–µ */}

              <div className="px-0 py-6">
                <div className="flex gap-6">
                  {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ö–∞–∫—É—é —Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å –±–æ—Ç? */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–ö–∞–∫—É—é —Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å –±–æ—Ç?</h4>
                    <div className="flex gap-[10px]">
                    <button
                      onClick={() => setSetupData({...setupData, task: '–ü—Ä–æ–¥–∞–≤–∞—Ç—å'})}
                        className={`w-[220px] h-[190px] rounded-[15px] transition-all overflow-hidden flex flex-col border ${
                        setupData.task === '–ü—Ä–æ–¥–∞–≤–∞—Ç—å' 
                            ? 'bg-[#DBE9FF] border-[#0084FF]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                      }`}
                    >
                        <div className="w-full h-[144px] rounded-t-[15px] overflow-hidden">
                          <img src="/–ü—Ä–æ–¥–∞–≤–µ—Ü.png" alt="–ü—Ä–æ–¥–∞–≤–µ—Ü" className="w-full h-full object-cover object-top" />
                      </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                          {setupData.task === '–ü—Ä–æ–¥–∞–≤–∞—Ç—å' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-[90px] flex items-center justify-center">
                              <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                            </div>
                          ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-[90px] border border-[#070F1A]/10"></div>
                          )}
                          <span className="text-[14px] font-[500] text-[#070F1A]">–ü—Ä–æ–¥–∞–≤—Ü–∞</span>
                        </div>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, task: '–ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å'})}
                        className={`w-[220px] h-[190px] rounded-[15px] transition-all overflow-hidden flex flex-col border ${
                        setupData.task === '–ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å' 
                            ? 'bg-[#DBE9FF] border-[#0084FF]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                      }`}
                    >
                        <div className="w-full h-[144px] rounded-t-[15px] overflow-hidden">
                          <img src="/–ö–æ–Ω—Å—É–ª.png" alt="–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç" className="w-full h-full object-cover object-top" />
                      </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                        {setupData.task === '–ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-[90px] flex items-center justify-center">
                              <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                          </div>
                        ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-[90px] border border-[#070F1A]/10"></div>
                        )}
                        <span className="text-[14px] font-[500] text-[#070F1A]">–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞</span>
                      </div>
                    </button>
                  </div>
                </div>
                
                  {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ö–∞–∫–∞—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –ò–ò-–∞–≥–µ–Ω—Ç–∞? */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–ö–∞–∫–∞—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –ò–ò-–∞–≥–µ–Ω—Ç–∞?</h4>
                    <div className="grid grid-cols-2 gap-[10px]">
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: '–ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é'})}
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.mainGoal === '–ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.mainGoal === '–ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">–ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</span>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: '–ü—Ä–æ–¥–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç'})}
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.mainGoal === '–ü—Ä–æ–¥–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.mainGoal === '–ü—Ä–æ–¥–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">–ü—Ä–æ–¥–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç</span>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: '–ü–æ–º–æ—á—å —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É'})}
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.mainGoal === '–ü–æ–º–æ—á—å —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.mainGoal === '–ü–æ–º–æ—á—å —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">–ü–æ–º–æ—á—å —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É</span>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: 'custom'})}
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.mainGoal === 'custom' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.mainGoal === 'custom' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">–î—Ä—É–≥–æ–µ</span>
                    </button>
                  </div>
                  {setupData.mainGoal === 'custom' && (
                      <div className="mt-[10px]">
                      <Input
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç"
                          className="w-full h-[34px] rounded-[10px] border border-[#070F1A]/10 text-[14px] text-[#070F1A]/70"
                      />
                    </div>
                  )}
                  </div>
                </div>

                {/* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –≤–æ–ø—Ä–æ—Å–∞–º–∏ */}
                <div className="h-[50px]"></div>

                {/* 3. –ö–∞–∫–æ–π —Ü–∏–∫–ª —Å–¥–µ–ª–∫–∏ –≤ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏? –∏ 4. –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è */}
                <div className="flex gap-6">
                  {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ö–∞–∫–æ–π —Ü–∏–∫–ª —Å–¥–µ–ª–∫–∏ */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–ö–∞–∫–æ–π —Ü–∏–∫–ª —Å–¥–µ–ª–∫–∏ –≤ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏?</h4>
                  <Textarea 
                    value={setupData.dealCycle || ''}
                    onChange={(e) => setSetupData({...setupData, dealCycle: e.target.value})}
                    placeholder="–û–±—ã—á–Ω–æ –Ω–∞—à–∏ –∫–ª–∏–µ–Ω—Ç—ã —Å–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–≤–ª—è—é—Ç –∑–∞—è–≤–∫—É, –¥–∞–ª–µ–µ –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å –Ω–∏–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –∑–∞—è–≤–∫—É –∏ –≤–µ–¥—É—Ç –¥–∞–ª—å—à–µ –ø–æ –≤–æ—Ä–æ–Ω–∫–µ: –¢—É—Ç 2 –ø—É—Ç–∏, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ –Ω–∞ —á—Ç–æ –æ—Å—Ç–∞–≤–∏–ª–∏ –∑–∞—è–≤–∫—É, –Ω–æ –µ—Å–ª–∏ 1 –ø—É—Ç—å, —Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—é –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –≥—Ä—É–∑–∞, –æ–±—ã—á–Ω—ã–π —Å—Ä–æ–∫ —É –Ω–∞—Å 7 –¥–Ω–µ–π..."
                      className="min-h-[124px] rounded-[10px] border border-[#070F1A]/10 text-[14px] text-[#070F1A]/70"
                  />
                </div>

                  {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</h4>
                  <Textarea 
                    value={setupData.targetAudience || ''}
                    onChange={(e) => setSetupData({...setupData, targetAudience: e.target.value})}
                    placeholder="–ü–æ–ª: –ñ–µ–Ω—â–∏–Ω—ã –í–æ–∑—Ä–∞—Å—Ç: 18-45 –ë–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞: —Å–ª–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–∞–∑–º–µ—Ä"
                      className="min-h-[124px] rounded-[10px] border border-[#070F1A]/10 text-[14px] text-[#070F1A]/70"
                  />
                </div>
                </div>
              </div>
            </div>

            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è */}
            <div className="border-b" style={{ borderColor: '#E5E7EB', marginLeft: '-16px', marginRight: '-16px', marginTop: '25px', marginBottom: '25px' }}></div>

            {/* –®–∞–≥ 2: –ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è */}
            <div className="mb-[50px]">
              <div className="flex items-center gap-[15px] mb-6">
                  <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-[90px] flex items-center justify-center mb-[20px]">
                    <span className="text-white text-[10px] font-medium">2</span>
                  </div>
                  <div>
                  <h3 className="text-[18px] font-[500] text-[#070F1A] tracking-[-3%]">–ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è</h3>
                  <p className="text-[14px] text-[#8E8E93] tracking-[-2%]">
                      –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ –ò–ò-–∞–≥–µ–Ω—Ç–∞
                    </p>
                  </div>
                </div>
              <div className="px-0 py-6">
                <div className="flex gap-6">
                  {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h4>
                    <div className="grid grid-cols-2 gap-[10px]">
                    <button 
                      onClick={() => setSetupData({...setupData, addressing: '–í—ã'})}
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.addressing === '–í—ã' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.addressing === '–í—ã' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">–ù–∞ "–í—ã"</span>
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, addressing: '–¢—ã'})}
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.addressing === '–¢—ã' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.addressing === '–¢—ã' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">–ù–∞ "–¢—ã"</span>
                    </button>
                  </div>
                </div>

                  {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è</h4>
                    <div className="grid grid-cols-2 gap-[10px]">
                    <button 
                      onClick={() => setSetupData({...setupData, communicationStyle: '–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π'})} 
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.communicationStyle === '–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.communicationStyle === '–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">üòä –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</span>
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, communicationStyle: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π'})} 
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.communicationStyle === '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.communicationStyle === '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π</span>
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, communicationStyle: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π'})} 
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.communicationStyle === '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.communicationStyle === '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">üíº –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</span>
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, communicationStyle: '–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π'})} 
                      className={`h-[34px] rounded-[10px] transition-all text-[13px] ${
                        setupData.communicationStyle === '–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π' 
                            ? 'bg-[#0084FF] text-white' 
                            : 'bg-white border border-[#070F1A]/10 text-[#070F1A]/70'
                      }`}
                      style={setupData.communicationStyle === '–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π' ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                        <span className="font-[500]">üòÑ –Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π</span>
                    </button>
                    </div>
                  </div>
                </div>

                {/* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –≤–æ–ø—Ä–æ—Å–∞–º–∏ */}
                <div className="h-[50px]"></div>

                {/* 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ê–¥–∞–ø—Ç–æ */}
                <div>
                  <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ê–¥–∞–ø—Ç–æ</h4>
                  <div className="flex flex-wrap gap-2">
                    {[
                      '–ù–µ –æ–±—Å—É–∂–¥–∞–π —Ü–µ–Ω—ã',
                      '–ù–µ –¥–∞–≤–∞–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å–æ–≤–µ—Ç–æ–≤',
                      '–ù–µ –æ–±—Å—É–∂–¥–∞–π –ø–æ–ª–∏—Ç–∏–∫—É',
                      '–ù–µ –æ–±—Å—É–∂–¥–∞–π —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ —Ç–µ–º—ã',
                      '–ù–µ –ø—Ä–µ–≤—ã—à–∞–π –ø–æ–ª–Ω–æ–º–æ—á–∏—è –∏ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∫–æ–º–ø–∞–Ω–∏–∏',
                      '–ù–µ –¥–∞–≤–∞–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏',
                      '–ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–π –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏',
                      '–ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
                      '–ù–µ –¥–∞–≤–∞–π –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤',
                      '–ü–æ—è—Å–Ω—è–π —Å—Å—ã–ª–∫–∏ –ø—Ä–∏ –∏—Ö –æ—Ç–ø—Ä–∞–≤–∫–µ',
                      '–ò—Å–ø–æ–ª—å–∑—É–π –º–æ–ª–æ–¥–µ–∂–Ω—ã–π —Å–ª–µ–Ω–≥',
                      '–ù–µ –æ—Å—É–∂–¥–∞–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞',
                      '–ù–µ –æ–∫–∞–∑—ã–≤–∞–π –¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞',
                      '–ò–∑–±–µ–≥–∞–π —Å–ø–æ—Ä–æ–≤',
                      '–û—Ç–≤–µ—á–∞–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞',
                      '–ò—Å–ø–æ–ª—å–∑—É–π –±—ã—Ç–æ–≤–æ–π —è–∑—ã–∫',
                      '–ù–µ –¥–∞–≤–∞–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã'
                    ].map(restriction => (
                      <button
                        key={restriction}
                        onClick={() => {
                          const current = setupData.restrictions || [];
                          const newRestrictions = current.includes(restriction)
                            ? current.filter(r => r !== restriction)
                            : [...current, restriction];
                          setSetupData({...setupData, restrictions: newRestrictions});
                        }}
                        className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                          (setupData.restrictions || []).includes(restriction)
                            ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                            : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                        }`}
                        style={(setupData.restrictions || []).includes(restriction) ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                      >
                        {restriction}
                      </button>
                    ))}

                    <button
                      onClick={() => setSetupData({...setupData, showCustomRestriction: !setupData.showCustomRestriction})}
                      className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        setupData.showCustomRestriction
                          ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                          : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                      style={setupData.showCustomRestriction ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                    >
                      –î—Ä—É–≥–æ–µ
                    </button>
                  </div>
                  {setupData.showCustomRestriction && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customRestriction || ''}
                        onChange={(e) => setSetupData({...setupData, customRestriction: e.target.value})}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customRestriction) {
                            const current = setupData.restrictions || [];
                            setSetupData({
                              ...setupData, 
                              restrictions: [...current, setupData.customRestriction],
                              customRestriction: '',
                              showCustomRestriction: false
                            });
                          }
                        }}
                        disabled={!setupData.customRestriction}
                        className="bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0084FF]/90"
                        style={BUTTON_STYLES.blueButton}
                      >
                        –î–æ–±–∞–≤–∏—Ç—å
                      </Button>
                </div>
                  )}
              </div>

              {/* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –≤–æ–ø—Ä–æ—Å–∞–º–∏ */}
              <div className="h-[50px]"></div>

                {/* 5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—â–µ–Ω–∏—è */}
                <div>
                  <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—â–µ–Ω–∏—è</h4>
                  <div className="flex flex-wrap gap-2">
                    {[
                      '–ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
                      '–ü–æ—è—Å–Ω—è—Ç—å —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π',
                      '–ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞',
                      '–ò–∑–±–µ–≥–∞—Ç—å –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π',
                      '–£—Ç–æ—á–Ω—è—Ç—å –∑–∞–¥–∞—á—É –≤ –Ω–∞—á–∞–ª–µ –æ–±—â–µ–Ω–∏—è',
                      '–ù–µ –æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞',
                      '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –æ–± –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞',
                      '–ò–∑–±–µ–≥–∞—Ç—å —Å–ø–æ—Ä–æ–≤',
                      '–û—Ç–≤–µ—á–∞—Ç—å –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞'
                    ].map(setting => (
                      <button
                        key={setting}
                        onClick={() => {
                          const current = setupData.communicationSettings || [];
                          const newSettings = current.includes(setting)
                            ? current.filter(s => s !== setting)
                            : [...current, setting];
                          setSetupData({...setupData, communicationSettings: newSettings});
                        }}
                        className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                          (setupData.communicationSettings || []).includes(setting)
                            ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                            : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                        }`}
                        style={(setupData.communicationSettings || []).includes(setting) ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                      >
                        {setting}
                      </button>
                    ))}
                    {/* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–∞–±—ã –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ */}
                    {(setupData.communicationSettings || []).filter(setting => 
                      !['–ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç', '–ü–æ—è—Å–Ω—è—Ç—å —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π', '–ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞', '–ò–∑–±–µ–≥–∞—Ç—å –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π', '–£—Ç–æ—á–Ω—è—Ç—å –∑–∞–¥–∞—á—É –≤ –Ω–∞—á–∞–ª–µ –æ–±—â–µ–Ω–∏—è', '–ù–µ –æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞', '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –æ–± –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞', '–ò–∑–±–µ–≥–∞—Ç—å —Å–ø–æ—Ä–æ–≤', '–û—Ç–≤–µ—á–∞—Ç—å –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞'].includes(setting)
                    ).map(setting => (
                      <button
                        key={setting}
                        onClick={() => {
                          const current = setupData.communicationSettings || [];
                          const newSettings = current.filter(s => s !== setting);
                          setSetupData({...setupData, communicationSettings: newSettings});
                        }}
                        className="px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] border-[#0084FF] bg-[#0084FF] text-white"
                      >
                        {setting}
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, showCustomCommunicationSetting: !setupData.showCustomCommunicationSetting})}
                      className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        setupData.showCustomCommunicationSetting
                          ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                          : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                    >
                      –î—Ä—É–≥–æ–µ
                    </button>
                  </div>
                  {setupData.showCustomCommunicationSetting && (
                    <div className="mt-3 flex gap-2">
                    <Input
                      value={setupData.customCommunicationSetting || ''}
                      onChange={(e) => setSetupData({...setupData, customCommunicationSetting: e.target.value})}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customCommunicationSetting) {
                            const current = setupData.communicationSettings || [];
                            setSetupData({
                              ...setupData, 
                              communicationSettings: [...current, setupData.customCommunicationSetting],
                              customCommunicationSetting: '',
                              showCustomCommunicationSetting: false
                            });
                          }
                        }}
                        disabled={!setupData.customCommunicationSetting}
                        className="bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0084FF]/90"
                        style={BUTTON_STYLES.blueButton}
                      >
                        –î–æ–±–∞–≤–∏—Ç—å
                      </Button>
                  </div>
                  )}
                </div>



                {/* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –≤–æ–ø—Ä–æ—Å–∞–º–∏ */}
                <div className="h-[50px]"></div>

                {/* 6. –£—Ç–æ—á–Ω—è—Ç—å –∏–ª–∏ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç—É, –µ—Å–ª–∏: */}
                <div>
                  <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–£—Ç–æ—á–Ω—è—Ç—å –∏–ª–∏ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç—É</h4>
                  <div className="flex flex-wrap gap-2">
                    {[
                      '–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ–ø–æ–ª–Ω—ã–π',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è',
                      '–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∏—Å–∫ –æ—à–∏–±–∫–∏',
                      '–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏',
                      '–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–Ω–∫–æ—Å—Ç–µ–π',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ',
                      '–ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥–±–æ—Ä',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å—ã –≤–Ω–µ —Å–≤–æ–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –≤–µ—â–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π',
                      '–ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –∏–ª–∏ –∑–∞–∫–∞–∑–∞',
                      '–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–≥–æ –º–æ–ª—á–∏—Ç'
                    ].map(question => (
                      <button
                        key={question}
                        onClick={() => {
                          const current = setupData.clarificationQuestions || [];
                          const newQuestions = current.includes(question)
                            ? current.filter(q => q !== question)
                            : [...current, question];
                          setSetupData({...setupData, clarificationQuestions: newQuestions});
                        }}
                        className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                          (setupData.clarificationQuestions || []).includes(question)
                            ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                            : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                        }`}
                        style={(setupData.clarificationQuestions || []).includes(question) ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                      >
                        {question}
                      </button>
                    ))}
                    {/* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–∞–±—ã –¥–ª—è —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ */}
                    {(setupData.clarificationQuestions || []).filter(question => 
                      !['–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ–ø–æ–ª–Ω—ã–π', '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è', '–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∏—Å–∫ –æ—à–∏–±–∫–∏', '–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏', '–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–Ω–∫–æ—Å—Ç–µ–π', '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º', '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ', '–ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥–±–æ—Ä', '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å—ã –≤–Ω–µ —Å–≤–æ–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏', '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –≤–µ—â–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π', '–ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –∏–ª–∏ –∑–∞–∫–∞–∑–∞', '–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ', '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–≥–æ –º–æ–ª—á–∏—Ç'].includes(question)
                    ).map(question => (
                      <button
                        key={question}
                        onClick={() => {
                          const current = setupData.clarificationQuestions || [];
                          const newQuestions = current.filter(q => q !== question);
                          setSetupData({...setupData, clarificationQuestions: newQuestions});
                        }}
                        className="px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] border-[#0084FF] bg-[#0084FF] text-white"
                      >
                        {question}
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, showCustomClarificationQuestion: !setupData.showCustomClarificationQuestion})}
                      className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        setupData.showCustomClarificationQuestion
                          ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                          : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                    >
                      –î—Ä—É–≥–æ–µ
                    </button>
                  </div>
                  {setupData.showCustomClarificationQuestion && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customClarificationQuestion || ''}
                        onChange={(e) => setSetupData({...setupData, customClarificationQuestion: e.target.value})}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customClarificationQuestion) {
                            const current = setupData.clarificationQuestions || [];
                            setSetupData({
                              ...setupData, 
                              clarificationQuestions: [...current, setupData.customClarificationQuestion],
                              customClarificationQuestion: '',
                              showCustomClarificationQuestion: false
                            });
                          }
                        }}
                        disabled={!setupData.customClarificationQuestion}
                        className="bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0084FF]/90"
                        style={BUTTON_STYLES.blueButton}
                      >
                        –î–æ–±–∞–≤–∏—Ç—å
                      </Button>
                    </div>
                  )}
                </div>

                {/* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –≤–æ–ø—Ä–æ—Å–∞–º–∏ */}
                <div className="h-[50px]"></div>

                {/* 7. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–æ–¥–∑–∏ –≤ –æ–±—â–µ–Ω–∏–∏ */}
                <div className="flex gap-6">
                  {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</h4>
                    <div className="flex flex-wrap gap-2">
                    {[
                      '–ò–º—è',
                      '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
                      '–ü–æ—á—Ç–∞',
                      '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏',
                      '–ì–æ—Ä–æ–¥',
                      '–í–æ–∑—Ä–∞—Å—Ç'
                    ].map(dataType => (
                      <button
                        key={dataType}
                        onClick={() => {
                          const current = setupData.dataCollection || [];
                          const newData = current.includes(dataType)
                            ? current.filter(d => d !== dataType)
                            : [...current, dataType];
                          // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–∞–±, —Ç–æ "–ù–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ" –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
                          setSetupData({...setupData, dataCollection: newData});
                        }}
                          className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                          (setupData.dataCollection || []).includes(dataType)
                              ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                              : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                        }`}
                        style={(setupData.dataCollection || []).includes(dataType) ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                      >
                        {dataType}
                      </button>
                    ))}
                    {/* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–∞–±—ã */}
                    {(setupData.dataCollection || []).filter(dataType => 
                      !['–ò–º—è', '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', '–ü–æ—á—Ç–∞', '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏', '–ì–æ—Ä–æ–¥', '–í–æ–∑—Ä–∞—Å—Ç'].includes(dataType)
                    ).map(dataType => (
                      <button
                        key={dataType}
                        onClick={() => {
                          const current = setupData.dataCollection || [];
                          const newData = current.filter(d => d !== dataType);
                          setSetupData({...setupData, dataCollection: newData});
                        }}
                        className="px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] border-[#0084FF] bg-[#0084FF] text-white"
                      >
                        {dataType}
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, dataCollection: []})}
                        className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        (setupData.dataCollection || []).length === 0
                            ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                            : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                    >
                      –ù–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <button
                      onClick={() => {
                        // –ü—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ "–î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º "–ù–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ"
                        setSetupData({...setupData, showCustomData: !setupData.showCustomData});
                      }}
                      className={`px-4 h-[34px] rounded-[50px] border border-[1px] transition-all text-[13px] ${
                        setupData.showCustomData
                          ? 'border-[#0084FF] bg-[#0084FF] text-white' 
                          : 'border-[#070F1A]/10 bg-white text-[#070F1A]/70'
                      }`}
                    >
                      –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                  </div>
                  {setupData.showCustomData && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customData || ''}
                        onChange={(e) => setSetupData({...setupData, customData: e.target.value})}
                        placeholder="–í–≤–µ—Å—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customData) {
                            const current = setupData.dataCollection || [];
                            setSetupData({
                              ...setupData, 
                              dataCollection: [...current, setupData.customData],
                              customData: '',
                              showCustomData: false
                            });
                          }
                        }}
                        disabled={!setupData.customData}
                        className="bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0084FF]/90"
                        style={BUTTON_STYLES.blueButton}
                      >
                        –î–æ–±–∞–≤–∏—Ç—å
                      </Button>
                    </div>
                  )}
                  </div>

                  {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–æ–¥–∑–∏ –≤ –æ–±—â–µ–Ω–∏–∏ */}
                  <div className="flex-1">
                    <h4 className="text-[16px] font-[500] text-[#070F1A] tracking-[-3%] mb-[20px]">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–æ–¥–∑–∏ –≤ –æ–±—â–µ–Ω–∏–∏</h4>
                    <div className="flex gap-[10px]">
                      <button
                        onClick={() => setSetupData({...setupData, emojiUsage: '–ù–∏–∫–æ–≥–¥–∞'})}
                        className={`relative w-[178px] h-[190px] rounded-[15px] transition-all overflow-hidden flex flex-col border ${
                          setupData.emojiUsage === '–ù–∏–∫–æ–≥–¥–∞' 
                            ? 'bg-[#DBE9FF] border-[#0084FF]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                        }`}
                      >
                        <div className="w-full h-[144px] rounded-t-[15px] overflow-hidden">
                          <div className="w-full h-full bg-[#F3F5F7] flex items-center justify-center">
                            <img src="/Frame 121.png" alt="–ù–∏–∫–æ–≥–¥–∞" className="w-full h-full object-cover" />
                          </div>
                        </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                          {setupData.emojiUsage === '–ù–∏–∫–æ–≥–¥–∞' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-[90px] flex items-center justify-center">
                              <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                            </div>
                          ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-[90px] border border-[#070F1A]/10"></div>
                          )}
                          <span className="text-[14px] font-[500] text-[#070F1A]">–ù–∏–∫–æ–≥–¥–∞</span>
                        </div>
                      </button>
                      <button
                        onClick={() => setSetupData({...setupData, emojiUsage: '–†–µ–¥–∫–æ'})}
                        className={`relative w-[178px] h-[190px] rounded-[15px] transition-all overflow-hidden flex flex-col border ${
                          setupData.emojiUsage === '–†–µ–¥–∫–æ' 
                            ? 'bg-[#DBE9FF] border-[#0084FF]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                        }`}
                      >
                                                <div className="w-full h-[144px] rounded-t-[15px] overflow-hidden">
                          <div className="w-full h-full bg-[#F3F5F7] flex items-center justify-center">
                            <img src="/Frame 119.png" alt="–†–µ–¥–∫–æ" className="w-full h-full object-cover" />
                </div>
              </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                          {setupData.emojiUsage === '–†–µ–¥–∫–æ' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-[90px] flex items-center justify-center">
                              <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                            </div>
                          ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-[90px] border border-[#070F1A]/10"></div>
                          )}
                          <span className="text-[14px] font-[500] text-[#070F1A]">–†–µ–¥–∫–æ</span>
                        </div>
                      </button>
                      <button
                        onClick={() => setSetupData({...setupData, emojiUsage: '–ß–∞—Å—Ç–æ'})}
                        className={`relative w-[178px] h-[190px] rounded-[15px] transition-all overflow-hidden flex flex-col border ${
                          setupData.emojiUsage === '–ß–∞—Å—Ç–æ' 
                            ? 'bg-[#DBE9FF] border-[#0084FF]/50' 
                            : 'bg-[#F3F5F7] border-[#070F1A]/10'
                        }`}
                      >
                        <div className="w-full h-[144px] rounded-t-[15px] overflow-hidden">
                          <div className="w-full h-full bg-[#F3F5F7] flex items-center justify-center">
                            <img src="/Frame 120.png" alt="–ß–∞—Å—Ç–æ" className="w-full h-full object-cover" />
                          </div>
                        </div>
                        <div className="flex-1 flex items-center gap-[7px] px-[15px]">
                          {setupData.emojiUsage === '–ß–∞—Å—Ç–æ' ? (
                            <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-[90px] flex items-center justify-center">
                              <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                              </svg>
                            </div>
                          ) : (
                            <div className="w-[17px] h-[17px] bg-white rounded-[90px] border border-[#070F1A]/10"></div>
                          )}
                          <span className="text-[14px] font-[500] text-[#070F1A]">–ß–∞—Å—Ç–æ</span>
                        </div>
                      </button>
                  </div>
                </div>
                </div>


              </div>
            </div>

            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ */}
            <div className="border-b" style={{ borderColor: '#E5E7EB', marginLeft: '-16px', marginRight: '-16px', marginTop: '25px', marginBottom: '25px' }}></div>

            {/* –®–∞–≥ 3: –≠—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞ */}
            <div className="mb-[50px]">
              <div className="flex items-center gap-[15px] mb-0">
                <div className="w-[17px] h-[17px] bg-[#0084FF] rounded-[90px] flex items-center justify-center mb-[20px]">
                  <span className="text-white text-[10px] font-medium">3</span>
                </div>
                <div>
                  <h3 className="text-[18px] font-[500] text-[#070F1A] tracking-[-3%]">–í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</h3>
                  <p className="text-[14px] text-[#8E8E93] tracking-[-2%]">
                  –û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ —ç—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –≤–∞—à–µ–≥–æ –ò–ò-–∞–≥–µ–Ω—Ç–∞
                  </p>
                            </div>
              </div>
                <div className="px-0 py-6" style={{paddingTop: '0px'}}>
                <div className="h-[20px]"></div>



                <div className="space-y-[10px]">
                  {(setupData.dialogStages || [
                    'üéØ –£–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–ê: –ü–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è —Ç–µ–ø–ª–æ, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫–∞–∫ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫. –°–ø—Ä–æ—Å–∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∫–∞–∫ –¥–µ–ª–∞. –°–æ–∑–¥–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.',
                    'üîç –í–´–Ø–°–ù–ï–ù–ò–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ï–ô: –ó–∞–¥–∞–≤–∞–π –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞, —Ü–µ–ª—è—Ö –∏ —Å–∏—Ç—É–∞—Ü–∏–∏. –£—Ç–æ—á–Ω–∏ –¥–µ—Ç–∞–ª–∏: –±—é–¥–∂–µ—Ç, —Å—Ä–æ–∫–∏, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.',
                    'üí° –ü–†–ï–ó–ï–ù–¢–ê–¶–ò–Ø –ò –ó–ê–ö–†–´–¢–ò–ï: –ü—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π. –†–∞—Å—Å–∫–∞–∂–∏ –æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö –∏ –≤—ã–≥–æ–¥–∞—Ö. –ü—Ä–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è—Ö - –≤—ã—è—Å–Ω–∏ –ø—Ä–∏—á–∏–Ω—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã. –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤ - –ø–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.'
                  ]).map((stage, index) => {
                    const isEditing = setupData.editingStage === index;
                    return (
                    <div key={index} className="flex items-center gap-[10px]">
                      {/* –ö–≤–∞–¥—Ä–∞—Ç —Å —Ü–∏—Ñ—Ä–æ–π */}
                      <div className="w-[34px] h-[34px] bg-[#F3F8FF] border border-[#070F1A]/10 rounded-[10px] flex items-center justify-center">
                        <span className="text-[14px] text-[#0084FF] font-medium">{index + 1}</span>
                  </div>
                      
                      {/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */}
                      <div className="flex-1">
                        <div className="flex-1">
                          <Textarea
                            value={stage}
                            onChange={(e) => {
                              const newStages = [...(setupData.dialogStages || [])];
                              newStages[index] = e.target.value;
                              setSetupData({...setupData, dialogStages: newStages});
                            }}
                            className={`w-full resize-none border rounded-[10px] p-3 min-h-[60px] ${isEditing ? 'border-[#070F1A]/10 bg-white' : 'border-[#070F1A]/10 bg-gray-50 cursor-not-allowed'}`}
                            rows={1}
                            placeholder="–û–ø–∏—à–∏—Ç–µ —ç—Ç–∞–ø –¥–∏–∞–ª–æ–≥–∞"
                            readOnly={!isEditing}
                            style={{ minHeight: '60px', height: 'auto' }}
                            onInput={(e) => {
                              e.target.style.height = 'auto';
                              e.target.style.height = Math.max(60, e.target.scrollHeight) + 'px';
                            }}
                            data-stage-index={index}
                          />
                    </div>
                      </div>
                      
                      {/* –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */}
                      <button 
                        onClick={() => {
                          if (isEditing) {
                            setSetupData({...setupData, editingStage: null});
                          } else {
                            setSetupData({...setupData, editingStage: index});
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                            setTimeout(() => {
                              const textarea = document.querySelector(`textarea[data-stage-index="${index}"]`);
                              if (textarea) {
                                textarea.focus();
                                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                              }
                            }, 100);
                          }
                        }}
                        className="w-[34px] h-[34px] bg-white border border-[#070F1A]/10 rounded-[10px] flex items-center justify-center hover:bg-gray-50"
                      >
                        <img src="/pencil.svg" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" className="w-[14px] h-[14px]" style={{ filter: 'brightness(0) saturate(100%) invert(59%) sepia(2%) saturate(0%) hue-rotate(217deg) brightness(92%) contrast(89%)' }} />
                      </button>
                      
                      {/* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */}
                      <button 
                          onClick={() => {
                            const newStages = [...(setupData.dialogStages || [])];
                            newStages.splice(index, 1);
                            setSetupData({...setupData, dialogStages: newStages});
                          }}
                        className="w-[34px] h-[34px] bg-white border border-[#070F1A]/10 rounded-[10px] flex items-center justify-center"
                      >
                        <img src="/traash.svg" alt="–£–¥–∞–ª–∏—Ç—å" className="w-5 h-5" style={{ filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%)' }} />
                      </button>
                    </div>
                  );
                  })}
                  
                  <div className="flex gap-2">
                    <Button 
                      onClick={() => {
                        const newStages = [...(setupData.dialogStages || []), '–ù–æ–≤—ã–π —ç—Ç–∞–ø –¥–∏–∞–ª–æ–≥–∞'];
                        setSetupData({...setupData, dialogStages: newStages});
                      }}
                      className="flex-1 h-[34px] bg-white border border-[#E5E6E7] text-[#070F1A] hover:bg-[#F2F3F4] text-[14px] transition-all shadow-[0_1px_2px_rgba(7,15,26,0.06)]"
                    >
                      –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø
                    </Button>
                    <Button 
                      onClick={() => {
                        const defaultStages = [
                          'üéØ –£–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–ê: –ü–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è —Ç–µ–ø–ª–æ, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫–∞–∫ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫. –°–ø—Ä–æ—Å–∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∫–∞–∫ –¥–µ–ª–∞. –°–æ–∑–¥–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.',
                          'üîç –í–´–Ø–°–ù–ï–ù–ò–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ï–ô: –ó–∞–¥–∞–≤–∞–π –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞, —Ü–µ–ª—è—Ö –∏ —Å–∏—Ç—É–∞—Ü–∏–∏. –£—Ç–æ—á–Ω–∏ –¥–µ—Ç–∞–ª–∏: –±—é–¥–∂–µ—Ç, —Å—Ä–æ–∫–∏, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.',
                          'üí° –ü–†–ï–ó–ï–ù–¢–ê–¶–ò–Ø –ò –ó–ê–ö–†–´–¢–ò–ï: –ü—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π. –†–∞—Å—Å–∫–∞–∂–∏ –æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö –∏ –≤—ã–≥–æ–¥–∞—Ö. –ü—Ä–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è—Ö - –≤—ã—è—Å–Ω–∏ –ø—Ä–∏—á–∏–Ω—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã. –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤ - –ø–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.'
                        ];
                        setSetupData({...setupData, dialogStages: defaultStages, dialogStagesModified: true});
                      }}
                      className="flex-1 h-[34px] bg-[#F2F3F4] border border-[#E5E6E7] text-[#070F1A] hover:bg-white text-[14px] transition-all shadow-[0_1px_2px_rgba(7,15,26,0.06)]"
                    >
                      –°–±—Ä–æ—Å–∏—Ç—å –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º
                    </Button>
                  </div>
                    </div>

                <div className="h-[20px]"></div>


                <div className="h-[30px]"></div>

                </div>
            </div>

            {/* –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */}
            <div className="sticky bottom-0 z-10 mt-6">
              <div className="flex gap-[20px] w-full shadow-[0_12px_30px_rgba(7,15,26,0.12)]/50">
                          <Button 
                            onClick={async () => {
                              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤–∏–¥–∂–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
                              if (isLoggedIn && currentUser) {
                                try {
                                  const settings = {
                                    // –®–∞–≥ 1: –¶–µ–ª–∏ Adapto
                                    task: setupData.task,
                                    mainGoal: setupData.mainGoal,
                                    mainGoalCustom: setupData.mainGoalCustom,
                                    customGoal: setupData.customGoal,
                                    dealCycle: setupData.dealCycle,
                                    targetAudience: setupData.targetAudience,
                                    // –®–∞–≥ 2: –ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è
                                    addressing: setupData.addressing,
                                    communicationStyle: setupData.communicationStyle,
                                    restrictions: setupData.restrictions,
                                    customRestriction: setupData.customRestriction,
                                    communicationSettings: setupData.communicationSettings,
                                    customCommunicationSetting: setupData.customCommunicationSetting,
                                    dataCollection: setupData.dataCollection,
                                    customData: setupData.customData,
                                    clarificationQuestions: setupData.clarificationQuestions,
                                    customClarificationQuestion: setupData.customClarificationQuestion,
                                    emojiUsage: setupData.emojiUsage,
                                    // –®–∞–≥ 3: –≠—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞
                                    dialogStages: setupData.dialogStages,
                                    dialogStagesModified: setupData.dialogStagesModified,
                                    // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                    modelProvider: setupData.modelProvider,
                                    modelName: setupData.modelName,
                                    temperature: setupData.temperature,
                                    maxTokens: setupData.maxTokens,
                                    systemPrompt: setupData.systemPrompt,
                                    customInstructions: setupData.customInstructions,
                                    enableRag: setupData.enableRag,
                                    enableValidation: setupData.enableValidation,
                                    enableMonitoring: setupData.enableMonitoring
                                  };
                                  
                                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                                  try {
                                  const result = await modelSettings.saveModelSettings(currentUser.id, settings);
                                  if (result) {
                                    showSystemNotificationMessage('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!');
                                  } else {
                                    showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö');
                                    }
                                  } catch (error) {
                                    console.error('Error saving model settings to database:', error);
                                    showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                                  }
                                } catch (error) {
                                  console.error('Error saving model settings:', error);
                                  showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                                }
                              } else {
                                showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                              }
                            }}
                  className="flex-1 h-[34px] px-6 text-[#070F1A] rounded-[10px] hover:bg-[#F2F3F4] transition-colors"
                  style={BUTTON_STYLES.whiteButton}
                          >
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                          </Button>
                          <Button 
                            onClick={async () => {
                              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤–∏–¥–∂–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
                              if (isLoggedIn && currentUser) {
                                try {
                                  const settings = {
                                    // –®–∞–≥ 1: –¶–µ–ª–∏ Adapto
                                    task: setupData.task,
                                    mainGoal: setupData.mainGoal,
                                    mainGoalCustom: setupData.mainGoalCustom,
                                    customGoal: setupData.customGoal,
                                    dealCycle: setupData.dealCycle,
                                    targetAudience: setupData.targetAudience,
                                    // –®–∞–≥ 2: –ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è
                                    addressing: setupData.addressing,
                                    communicationStyle: setupData.communicationStyle,
                                    restrictions: setupData.restrictions,
                                    customRestriction: setupData.customRestriction,
                                    communicationSettings: setupData.communicationSettings,
                                    customCommunicationSetting: setupData.customCommunicationSetting,
                                    dataCollection: setupData.dataCollection,
                                    customData: setupData.customData,
                                    clarificationQuestions: setupData.clarificationQuestions,
                                    customClarificationQuestion: setupData.customClarificationQuestion,
                                    emojiUsage: setupData.emojiUsage,
                                    // –®–∞–≥ 3: –≠—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞
                                    dialogStages: setupData.dialogStages,
                                    dialogStagesModified: setupData.dialogStagesModified,
                                    // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                    modelProvider: setupData.modelProvider,
                                    modelName: setupData.modelName,
                                    temperature: setupData.temperature,
                                    maxTokens: setupData.maxTokens,
                                    systemPrompt: setupData.systemPrompt,
                                    customInstructions: setupData.customInstructions,
                                    enableRag: setupData.enableRag,
                                    enableValidation: setupData.enableValidation,
                                    enableMonitoring: setupData.enableMonitoring
                                  };
                                  
                                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                                  try {
                                  const result = await modelSettings.saveModelSettings(currentUser.id, settings);
                                  if (result) {
                                    showSystemNotificationMessage('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!');
                                  } else {
                                    showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö');
                                  }
                                  } catch (error) {
                                    console.error('Error saving model settings to database:', error);
                                    showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                                  }
                                  
                                  // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
                                  setActiveSection('my-adapto');
                                  // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É —á–∞—Ç–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
                                  ChatUtils.scrollToBottom(chatHistoryRef, 500);
                                } catch (error) {
                                  console.error('Error saving model settings:', error);
                                  showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                                }
                              } else {
                                showSystemNotificationMessage('‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                              }
                            }}
                  className="flex-1 h-[34px] px-6 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                  style={BUTTON_STYLES.blueButton}
                          >
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                          </Button>
                        </div>
            </div>
          </div>
        );

      case 'dialogs':
        return (
          <div className="flex flex-col h-full">
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
            <div className="flex justify-between items-center mb-[16px]">
              <h1 className="text-[20px] font-[500]">–î–∏–∞–ª–æ–≥–∏</h1>
            </div>
            
            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
            <div className="h-px bg-[#E5E7EB]" style={{ marginLeft: '-32px', marginRight: '-32px' }}></div>

            {/* –¢—Ä–µ—Ö–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ */}
            <div className="grid grid-cols-12 gap-0 overflow-hidden flex-1 min-h-0 -mb-4">
                             {/* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ */}
              <div className="col-span-4 bg-[#F8F8FA] flex flex-col h-full min-h-0 overflow-hidden pr-4">
                <div className="p-0">
                  {/* –¢–∞–±—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —á–∞—Ç–æ–≤ */}
                  <div className="mb-[10px] mt-[10px]">
                    <div className="flex gap-0 bg-[#F2F3F4] h-[40px] rounded-[10px] p-[3px]">
                      <button
                        onClick={() => setActiveChatTab('all')}
                        className={`flex-1 h-[34px] rounded-[9px] text-[13px] font-medium transition-colors ${
                          activeChatTab === 'all'
                            ? 'bg-white text-[#0084FF]'
                            : 'text-[#8E8E93] hover:text-[#0084FF]'
                        }`}
                      >
                        {isOperator ? '–í—Ö–æ–¥—è—â–∏–µ' : '–í—Ö–æ–¥—è—â–∏–µ'}
                      </button>
                      <button
                        onClick={() => setActiveChatTab('active')}
                        className={`flex-1 h-[34px] rounded-[9px] text-[13px] font-medium transition-colors ${
                          activeChatTab === 'active'
                            ? 'bg-white text-[#0084FF]'
                            : 'text-[#8E8E93] hover:text-[#0084FF]'
                        }`}
                      >
                        {isOperator ? '–ú–æ–∏' : '–ê–∫—Ç–∏–≤–Ω—ã–µ'}
                      </button>
                      <button
                        onClick={() => setActiveChatTab('closed')}
                        className={`flex-1 h-[34px] rounded-[9px] text-[13px] font-medium transition-colors ${
                          activeChatTab === 'closed'
                            ? 'bg-white text-[#0084FF]'
                            : 'text-[#8E8E93] hover:text-[#0084FF]'
                        }`}
                      >
                        –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
                      </button>
                    </div>
                  </div>
                  
                  {/* –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞–Ω–∞–ª–∞–º */}
                  <div className="mb-[10px] mt-[10px]">
                    <div className="flex gap-1 bg-[#F8F8FA] h-[32px] rounded-[8px] p-[2px] overflow-x-auto">
                      <button
                        onClick={() => setActiveChannelFilter('all')}
                        className={`px-3 h-[28px] rounded-[6px] text-[12px] font-medium transition-colors whitespace-nowrap ${
                          activeChannelFilter === 'all'
                            ? 'bg-white text-[#0084FF] shadow-sm'
                            : 'text-[#8E8E93] hover:text-[#0084FF]'
                        }`}
                      >
                        –í—Å–µ –∫–∞–Ω–∞–ª—ã
                      </button>
                      <button
                        onClick={() => setActiveChannelFilter('widget')}
                        className={`px-3 h-[28px] rounded-[6px] text-[12px] font-medium transition-colors whitespace-nowrap ${
                          activeChannelFilter === 'widget'
                            ? 'bg-white text-[#0084FF] shadow-sm'
                            : 'text-[#8E8E93] hover:text-[#0084FF]'
                        }`}
                      >
                        –í–∏–¥–∂–µ—Ç
                      </button>
                      <button
                        onClick={() => setActiveChannelFilter('telegram')}
                        className={`px-3 h-[28px] rounded-[6px] text-[12px] font-medium transition-colors whitespace-nowrap ${
                          activeChannelFilter === 'telegram'
                            ? 'bg-white text-[#0084FF] shadow-sm'
                            : 'text-[#8E8E93] hover:text-[#0084FF]'
                        }`}
                      >
                        Telegram
                      </button>
                      <button
                        onClick={() => setActiveChannelFilter('whatsapp')}
                        className={`px-3 h-[28px] rounded-[6px] text-[12px] font-medium transition-colors whitespace-nowrap ${
                          activeChannelFilter === 'whatsapp'
                            ? 'bg-white text-[#0084FF] shadow-sm'
                            : 'text-[#8E8E93] hover:text-[#0084FF]'
                        }`}
                      >
                        WhatsApp
                      </button>
                      <button
                        onClick={() => setActiveChannelFilter('admin')}
                        className={`px-3 h-[28px] rounded-[6px] text-[12px] font-medium transition-colors whitespace-nowrap ${
                          activeChannelFilter === 'admin'
                            ? 'bg-white text-[#0084FF] shadow-sm'
                            : 'text-[#8E8E93] hover:text-[#0084FF]'
                        }`}
                      >
                        –ê–¥–º–∏–Ω
                      </button>
                    </div>
                  </div>
                  
                  <div className="relative">
                    <Search className="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#8E8E93]" />
                    <input
                      placeholder="–ù–∞–π—Ç–∏ —á–∞—Ç"
                      value={searchQuery}
                      onChange={(e) => debouncedSearch(e.target.value)}
                      className="w-full pl-10 h-[34px] text-[13px] border-0 bg-transparent focus:outline-none focus:ring-0"
                      style={{
                        color: '#070F1A'
                      }}
                    />
                  </div>
                  <div className="border-b mt-[10px]" style={{ borderColor: '#E5E6E7' }}></div>
                </div>
                
                                 <div className="overflow-y-auto p-0 space-y-3 flex-1 mt-4">
                  {dialogsData.length > 0 && (
                    getFilteredDialogs()
                    .map((dialog) => (
                                         <div 
                       key={dialog.id} 
                       className={`p-3 rounded-[15px] cursor-pointer transition-all ${
                         selectedDialog?.id === dialog.id 
                           ? 'bg-[#F2F3F4] border border-transparent' 
                           : 'hover:bg-[#F2F3F4] border border-transparent'
                       }`}
                       onClick={() => {
                         setSelectedDialog(dialog);
                         // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤ –ò–ò –∏–ª–∏ –æ–∂–∏–¥–∞—é—â–∏—Ö
                         if (dialog.status === 'active' || dialog.status === 'waiting') {
                           setShowJoinDialogPlaque(true);
                         } else {
                           setShowJoinDialogPlaque(false);
                         }
                       }}
                     >
                      <div className="space-y-3">
                        {/* –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞: –∏–∫–æ–Ω–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ + –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –∏–∫–æ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ + –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–µ–º */}
                        <div className="flex items-center gap-3">
                          <div className="w-[18px] h-[18px] bg-[#F3F4F6] rounded-[90px] flex items-center justify-center overflow-hidden" style={{ marginBottom: '20px' }}>
                            {dialog.source === 'widget' && <img src="/Group 102.svg" alt="Widget" className="w-full h-full" />}
                            {dialog.source === 'telegram' && <img src="/Group 38.svg" alt="Telegram" className="w-full h-full" />}
                            {dialog.source === 'whatsapp' && <img src="/Group 37.svg" alt="WhatsApp" className="w-full h-full" />}
                            {dialog.source === 'vk' && <img src="/Group 39.svg" alt="VK" className="w-full h-full" />}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between">
                              <h3 className="font-[500] text-[14px] text-[#070F1A] truncate">{dialog.user}</h3>
                              <div className="flex items-center gap-1">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  {(() => {
                                    const p = (dialog.priority || 'low');
                                    const inactive = 'rgba(7,15,26,0.2)';
                                    const isHigh = p === 'high' || p === 'urgent';
                                    const isMedium = p === 'medium';
                                    const c1 = isHigh ? '#FF3B30' : isMedium ? '#FFCE52' : '#05D560';
                                    const c2 = isHigh ? '#FF3B30' : isMedium ? '#FFCE52' : inactive;
                                    const c3 = isHigh ? '#FF3B30' : inactive;
                                    return (
                                      <g>
                                        <rect x="1" y="10" width="4" height="6" rx="1" fill={c1}></rect>
                                        <rect x="6" y="6" width="4" height="10" rx="1" fill={c2}></rect>
                                        <rect x="11" y="3" width="4" height="13" rx="1" fill={c3}></rect>
                                      </g>
                                    );
                                  })()}
                                </svg>
                                <div className="rounded-full flex items-center justify-center" style={{ width: '18px', height: '18px', backgroundColor: dialog.status === 'taken' ? '#A684FF' : 'transparent' }}>
                                  {dialog.status === 'taken' ? (
                                    <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-[11px] h-[11px]" style={{ filter: 'brightness(0) invert(1)' }} />
                                  ) : (
                                    <span
                                      className="w-[18px] h-[18px] inline-block"
                                      style={{
                                        backgroundColor: '#0084FF',
                                        WebkitMaskImage: 'url(/aiii.svg)',
                                        maskImage: 'url(/aiii.svg)',
                                        WebkitMaskRepeat: 'no-repeat',
                                        maskRepeat: 'no-repeat',
                                        WebkitMaskSize: 'contain',
                                        maskSize: 'contain',
                                        WebkitMaskPosition: 'center',
                                        maskPosition: 'center'
                                      }}
                                    />
                                  )}
                                </div>
                              </div>
                            </div>
                            <div className="flex items-center justify-between mt-1 gap-3">
                              <p className="text-[12px] text-[#8E8E93] truncate flex-1">{dialog.lastMessage}</p>
                              <span className="text-[10px] text-[#9CA3AF] whitespace-nowrap">{dialog.time}</span>
                            </div>
                          </div>
                        </div>
                        
                        {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                        {/* –ö–Ω–æ–ø–∫–∞ "–í–∑—è—Ç—å –¥–∏–∞–ª–æ–≥" - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –æ–∂–∏–¥–∞—é—â–∏–µ –¥–∏–∞–ª–æ–≥–∏ */}
                        {(dialog.status === 'active' || dialog.status === 'waiting') && (
                          <>
                            {dialog.canTakeover && !dialog.assignedTo ? (
                              <button 
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleTakeoverDialog(dialog.id);
                                }}
                                className="mt-[6px] h-[34px] px-4 bg-[#36C76A] text-white rounded-[10px] hover:bg-[#2BA855] transition-colors"
                                style={BUTTON_STYLES.blueButton}
                              >
                                –í–∑—è—Ç—å –¥–∏–∞–ª–æ–≥
                              </button>
                            ) : dialog.assignedTo && dialog.assignedTo !== currentUser?.id ? (
                              <button 
                                disabled
                                className="mt-[6px] h-[34px] px-4 bg-gray-300 text-gray-500 rounded-[10px] cursor-not-allowed"
                              >
                                –ó–∞–Ω—è—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
                              </button>
                            ) : dialog.assignedTo === currentUser?.id ? (
                              <button 
                                disabled
                                className="mt-[6px] h-[34px] px-4 bg-[#0084FF] text-white rounded-[10px] cursor-default"
                              >
                                –í–∞—à –¥–∏–∞–ª–æ–≥
                              </button>
                            ) : null}
                          </>
                        )}
                        
                      </div>
                    </div>
                  ))
                  )}
                </div>
              </div>

                             {/* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å - –¥–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥ –¥–∏–∞–ª–æ–≥–∞ */}
              <div className="col-span-5 bg-[#F8F8FA] rounded-[0px] flex flex-col h-full min-h-0 overflow-hidden" style={{ borderLeft: '1px solid #E5E6E7' }}>
                {selectedDialog ? (
                  <>
                        <div className="px-4 pt-3 pb-3 border-b border-[#E5E7EB]">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                              <div className="w-[20px] h-[20px] bg-[#F3F4F6] rounded-[90px] flex items-center justify-center overflow-hidden">
                             {selectedDialog.source === 'widget' && <img src="/Group 102.svg" alt="Widget" className="w-full h-full" />}
                             {selectedDialog.source === 'telegram' && <img src="/Group 38.svg" alt="Telegram" className="w-full h-full" />}
                             {selectedDialog.source === 'whatsapp' && <img src="/Group 37.svg" alt="WhatsApp" className="w-full h-full" />}
                             {selectedDialog.source === 'vk' && <img src="/Group 39.svg" alt="VK" className="w-full h-full" />}
          </div>
                        <div>
                            <div className="flex items-center gap-2">
                              <h3 className="font-[500] text-[16px] text-[#070F1A]">
                                {selectedDialog.phone || selectedDialog.email || `–û–±—Ä–∞—â–µ–Ω–∏–µ ‚Ññ${selectedDialog.id.substring(0, 8)}`}
                              </h3>
                            </div>
                        </div>
                      </div>
                        <div className="flex items-center justify-end">
                          <button 
                            onClick={(e) => { 
                              e.stopPropagation(); 
                              setDialogToClose(selectedDialog.id);
                              setShowCloseDialogPopup(true);
                            }}
                            className="h-[30px] px-3 bg-white border border-[#E5E6E7] text-[#0084FF] rounded-[10px] text-[13px] font-[500] hover:opacity-90 transition-colors"
                          >
                            –ó–∞–≤–µ—Ä—à–∏—Ç—å
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <div className="overflow-y-auto p-4 flex-1" ref={dialogChatRef}>
                      <VirtualizedMessageList
                        messages={selectedDialog.messages || []}
                        getMessageAlignment={getMessageAlignment}
                        getMessageOrder={getMessageOrder}
                        getMessageStyle={getMessageStyle}
                        getMessageFooter={getMessageFooter}
                        aiAgentName={aiAgentName}
                        containerRef={dialogChatRef}
                      />
                    </div>
                    
                    <div className="p-4 pb-4 border-t border-[#E5E7EB]" style={{ paddingTop: '14px', paddingBottom: '3px', paddingRight: '5px', paddingLeft: '14px' }}>
                      {/* –ü–ª–∞—à–∫–∞ "–í—Å—Ç—É–ø–∏—Ç—å –≤ –¥–∏–∞–ª–æ–≥" - –ø–æ–≤–µ—Ä—Ö –ø–æ–ª—è –≤–≤–æ–¥–∞ */}
                      {selectedDialog && (selectedDialog.status === 'active' || selectedDialog.status === 'waiting') && (showJoinDialogPlaque || selectedDialog.need_handover === true) && (
                      <div className="rounded-[15px] p-0" style={{ background: 'rgba(255,255,255,0.05)', backdropFilter: 'blur(40px)' }}>
                        <div className="p-4 flex flex-col items-center gap-2" style={{ paddingTop: '0px !important', paddingBottom: '14px !important' }}>
                          <div className="flex items-center gap-2">
                            {/* –ò–∫–æ–Ω–∫–∞ Frame 2085.svg */}
                            <img src="/Frame 2085.svg" alt="Frame 2085" className="w-6 h-6" />
                            
                            {/* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—Ä—É–∂–∫–∏ */}
                            <div className="flex items-center gap-[2px]">
                              <div className="w-[5px] h-[5px] rounded-full bg-[#8E8E93] opacity-[0.25] animate-pulse-1"></div>
                              <div className="w-[5px] h-[5px] rounded-full bg-[#8E8E93] opacity-[0.5] animate-pulse-2"></div>
                              <div className="w-[5px] h-[5px] rounded-full bg-[#8E8E93] opacity-[1] animate-pulse-3"></div>
                            </div>
                            
                            {/* –ò–∫–æ–Ω–∫–∞ Frame 2086.svg */}
                            <img src="/Frame 2086.svg" alt="Frame 2086" className="w-6 h-6" />
                          </div>
                          <h4 className="text-[14px] text-[#070F1A] font-[500]">–ü–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä</h4>
                          <p className="text-[12px] text-center" style={{ color: '#8E8E93' }}>–ï—Å–ª–∏ –≤—ã –Ω–∞–∂–º–µ—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É, —Ç–æ –ò–ò –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É –≤ —á–∞—Ç–µ</p>
                          <button
                              onClick={() => handleJoinDialog(selectedDialog.id)}
                            className="h-[34px] w-[160px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors flex items-center justify-center mt-[10px]"
                            style={BUTTON_STYLES.blueButton}
                            >
                              –í—Å—Ç—É–ø–∏—Ç—å –≤ –¥–∏–∞–ª–æ–≥
                            </button>
                          </div>
                        </div>
                      )}
                      
                      {/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */}
                      {selectedDialog && selectedDialog.status === 'taken' && selectedDialog.assignedTo === (currentUser?.id || 'current_operator') && (
                        <div className="relative">
                          <textarea
                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                            value={messageText}
                            onChange={(e) => setMessageText(e.target.value)}
                            onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendDialogMessage(); } }}
                            className="w-full min-h-[96px] resize-none rounded-[12px] border-0 p-0 pr-[70px] focus:outline-none focus:ring-0 text-[14px] text-[#070F1A] bg-[#F8F8FA]"
                            style={{ borderLeftWidth: 0, borderTopWidth: 0, borderBottomWidth: 0, borderRightWidth: 0, paddingLeft: 0, paddingTop: 0, paddingBottom: 0, paddingRight: '70px' }}
                          />
                          <div className="absolute right-2 bottom-2 flex items-center gap-0" style={{ marginBottom: '0px', marginLeft: '0px', paddingLeft: '0px' }}>
                          <button 
                            onClick={handleChatFileUpload}
                              className="w-[32px] h-[32px] flex items-center justify-center transition-colors"
                          >
                              <img src="/paperclip.svg" alt="–í–ª–æ–∂–µ–Ω–∏—è" className="w-[18px] h-[18px]" />
                          </button>
                          <button 
                            onClick={handleSendDialogMessage}
                            className="w-[32px] h-[32px] bg-[#0084FF] rounded-[90px] flex items-center justify-center cursor-pointer disabled:bg-[#070F1A] disabled:bg-opacity-10 disabled:cursor-not-allowed transition-colors"
                            disabled={!messageText.trim()}
                          >
                            <img 
                              src="/Frame 118.svg" 
                          alt="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" 
                              className={`w-3 h-3 ${!messageText.trim() ? 'opacity-60' : ''}`}
                        />
                          </button>
                        </div>
                        </div>
                      )}
                    </div>
                  </>
                ) : (
                  <div className="flex-1 flex items-center justify-center">
                    <div className="text-center">
                      <span
                        className="w-8 h-8 mx-auto mb-3 inline-block"
                        style={{
                          backgroundColor: '#0084FF',
                          WebkitMaskImage: 'url(/dialog.svg)',
                          maskImage: 'url(/dialog.svg)',
                          WebkitMaskRepeat: 'no-repeat',
                          maskRepeat: 'no-repeat',
                          WebkitMaskSize: 'contain',
                          maskSize: 'contain',
                          WebkitMaskPosition: 'center',
                          maskPosition: 'center'
                        }}
                        role="img"
                        aria-label="–ü–æ–∫–∞ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤"
                      ></span>
                      <h3 className="text-[20px] font-[500] mb-2" style={{ color: '#8E8E93', opacity: 0.7 }}>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</h3>
                      <p className="text-[14px] text-[#8E8E93] text-center mb-6" style={{ width: '370px', opacity: 0.7 }}>
                        –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–Ω—É—Ç –æ–±—â–∞—Ç—å—Å—è —Å –≤–∞—à–∏–º –ò–ò-–∞–≥–µ–Ω—Ç–æ–º, –¥–∏–∞–ª–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å
                      </p>
                      <div className="flex flex-col gap-3 justify-center">
                        <button 
                          className="bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors h-[34px]"
                          style={BUTTON_STYLES.blueButton}
                        >
                          –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥–∂–µ—Ç
                        </button>
                        <button 
                          className="text-[#070F1A] rounded-[10px] hover:bg-[#F9FAFB] transition-colors h-[34px]"
                          style={BUTTON_STYLES.whiteButton}
                        >
                          –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ò–ò
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>

                             {/* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏–∞–ª–æ–≥–µ */}
                              <div className="col-span-3 bg-[#F8F8FA] rounded-[0px] flex flex-col h-full min-h-0 overflow-hidden" style={{ borderLeft: '1px solid #E5E6E7' }}>
                {selectedDialog ? (
                    <div className="p-4 overflow-y-auto flex-1 space-y-6">
                      <h3 className="font-[500] text-[16px] text-[#070F1A] mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                      
                      {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                      <div>
                        <div className="space-y-3">
                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–ò—Å—Ç–æ—á–Ω–∏–∫</p>
                            <div className="flex items-center gap-2">
                              <div className="w-[16px] h-[16px] bg-[#F3F4F6] rounded-[90px] flex items-center justify-center">
                                {selectedDialog.source === 'widget' && <img src="/Group 102.svg" alt="Widget" className="w-full h-full" />}
                                {selectedDialog.source === 'telegram' && <img src="/Group 38.svg" alt="Telegram" className="w-full h-full" />}
                                {selectedDialog.source === 'whatsapp' && <img src="/Group 37.svg" alt="WhatsApp" className="w-full h-full" />}
                                {selectedDialog.source === 'vk' && <img src="/Group 39.svg" alt="VK" className="w-full h-full" />}
                              </div>
                              <span className="text-[12px] text-[#070F1A] capitalize font-[500]">
                                {selectedDialog.source === 'vk' ? '–í–∫–æ–Ω—Ç–∞–∫—Ç–µ' : selectedDialog.source}
                              </span>
                            </div>
                          </div>
                          
                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–°—Ç–∞—Ç—É—Å</p>
                            <div className="flex items-center gap-2">
                              {selectedDialog.status === 'waiting' || selectedDialog.status === 'active' || selectedDialog.status === 'taken' ? (
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M20.25 12C20.25 7.44365 16.5563 3.75 12 3.75C7.44365 3.75 3.75 7.44365 3.75 12C3.75 16.5563 7.44365 20.25 12 20.25C16.5563 20.25 20.25 16.5563 20.25 12ZM21.75 12C21.75 17.3848 17.3848 21.75 12 21.75C6.61522 21.75 2.25 17.3848 2.25 12C2.25 6.61522 6.61522 2.25 12 2.25C17.3848 2.25 21.75 6.61522 21.75 12Z" fill={selectedDialog.status === 'waiting' ? '#FFCE52' : '#05D560'} />
                                  <path d="M11.5 6C11.5 5.44772 11.9495 4.99353 12.4975 5.06216C14.1184 5.26514 15.634 5.95891 16.8033 7.05025C18.2098 8.36301 19 10.1435 19 12C19 13.8565 18.2098 15.637 16.8033 16.9497C15.634 18.0411 14.1184 18.7349 12.4975 18.9378C11.9495 19.0065 11.5 18.5523 11.5 18L11.5 12L11.5 6Z" fill={selectedDialog.status === 'waiting' ? '#FFCE52' : '#05D560'} />
                                </svg>
                              ) : (
                                <svg width="18" height="18" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <g>
                                    <circle cx="8" cy="8" r="6" fill="#0084FF" />
                                    <path d="M5.5 8.5 L7.5 10.5 L11 6.5" stroke="white" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                                  </g>
                                </svg>
                              )}
                              <span className="text-[12px] text-[#070F1A] leading-[16px] font-[500]">
                                {selectedDialog.status === 'waiting' ? '–û–∂–∏–¥–∞–µ—Ç' :
                                 selectedDialog.status === 'active' || selectedDialog.status === 'taken' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' :
                                 selectedDialog.status === 'resolved' || selectedDialog.status === 'resolved_by_operator' || selectedDialog.status === 'closed' ? '–ó–∞–∫—Ä—ã—Ç' : '–ê–∫—Ç–∏–≤–Ω—ã–π'}
                              </span>
                            </div>
                          </div>

                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</p>
                            <div className="flex items-center gap-2">
                              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                {(() => {
                                  const p = (selectedDialog.priority || 'low');
                                  const inactive = 'rgba(7,15,26,0.2)';
                                  const isHigh = p === 'high' || p === 'urgent';
                                  const isMedium = p === 'medium';
                                  const c1 = isHigh ? '#FF3B30' : isMedium ? '#FFCE52' : '#05D560';
                                  const c2 = isHigh ? '#FF3B30' : isMedium ? '#FFCE52' : inactive;
                                  const c3 = isHigh ? '#FF3B30' : inactive;
                                  const f1 = p === 'low' ? '#05D560' : c1;
                                  const f2 = p === 'low' ? inactive : c2;
                                  const f3 = p === 'low' ? inactive : c3;
                                  return (
                                    <g>
                                      <rect x="1" y="8" width="4" height="6" rx="1" fill={f1}></rect>
                                      <rect x="6" y="4" width="4" height="10" rx="1" fill={f2}></rect>
                                      <rect x="11" y="1" width="4" height="13" rx="1" fill={f3}></rect>
                                    </g>
                                  );
                                })()}
                              </svg>
                              <span className="text-[12px] text-[#070F1A] leading-[16px] font-[500]">
                                {selectedDialog.priority === 'high' ? '–í—ã—Å–æ–∫–∏–π' :
                                 selectedDialog.priority === 'medium' ? '–°—Ä–µ–¥–Ω–∏–π' : '–ù–∏–∑–∫–∏–π'}
                              </span>
                            </div>
                          </div>

                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</p>
                            <div className="flex items-center gap-2">
                              <div className="rounded-full flex items-center justify-center" style={{ width: '16px', height: '16px', backgroundColor: selectedDialog.status === 'taken' ? '#A684FF' : 'transparent' }}>
                                {selectedDialog.status === 'taken' ? (
                                  <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-[10px] h-[10px]" style={{ filter: 'brightness(0) invert(1)' }} />
                                ) : (
                                  <span
                                    className="w-[16px] h-[16px] inline-block"
                                    style={{
                                      backgroundColor: '#0084FF',
                                      WebkitMaskImage: 'url(/aiii.svg)',
                                      maskImage: 'url(/aiii.svg)',
                                      WebkitMaskRepeat: 'no-repeat',
                                      maskRepeat: 'no-repeat',
                                      WebkitMaskSize: 'contain',
                                      maskSize: 'contain',
                                      WebkitMaskPosition: 'center',
                                      maskPosition: 'center'
                                    }}
                                  />
                                )}
                              </div>
                              <span className="text-[12px] text-[#070F1A] font-[500]">
                                {selectedDialog.status === 'taken' ? 
                                 (selectedDialog.assignedTo === (currentUser?.id || 'current_operator') ? '–û–ø–µ—Ä–∞—Ç–æ—Ä (–í—ã)' : '–û–ø–µ—Ä–∞—Ç–æ—Ä') : 
                                 '–ò–ò-–∞–≥–µ–Ω—Ç'}
                              </span>
                            </div>
                          </div>

                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞</p>
                            <span className="text-[12px] text-[#070F1A] font-[500]">
                              {selectedDialog.createdAt ? new Date(selectedDialog.createdAt).toLocaleString() : (selectedDialog.startTime || '‚Äî')}
                            </span>
                          </div>

                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–ö–æ–Ω–µ—Ü –¥–∏–∞–ª–æ–≥–∞</p>
                            <span className="text-[12px] text-[#070F1A] font-[500]">
                              {selectedDialog.updatedAt ? new Date(selectedDialog.updatedAt).toLocaleString() : (selectedDialog.endTime || '‚Äî')}
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */}
                      <div className="border-t border-[#E5E7EB] my-4"></div>

                      {/* –ö–æ–Ω—Ç–∞–∫—Ç—ã */}
                      <div>
                        <div className="space-y-3">
                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–ò–º—è</p>
                            {selectedDialog.name && dialogEditingField !== 'name' ? (
                              <span className="text-[12px] text-[#070F1A] font-[500]">{selectedDialog.name}</span>
                            ) : dialogEditingField === 'name' ? (
                              <input
                                type="text"
                                value={dialogEditingValue}
                                onChange={(e) => setDialogEditingValue(e.target.value)}
                                placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
                                className="text-[12px] text-[#070F1A] bg-transparent border-none outline-none p-0 w-full"
                                autoFocus
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    saveDialogEdit();
                                  } else if (e.key === 'Escape') {
                                    e.preventDefault();
                                    cancelDialogEdit();
                                  }
                                }}
                                onBlur={(e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  saveDialogEdit();
                                }}
                              />
                            ) : (
                              <button 
                                className="text-[12px] text-[#8E8E93] flex items-center cursor-text focus:outline-none bg-transparent border-none p-0"
                                onClick={(e) => { 
                                  e.preventDefault();
                                  e.stopPropagation();
                                  startDialogEdit('name', '');
                                }}
                              >
                                <span className="text-[18px]" style={{ fontWeight: 300, marginBottom: '2px', marginRight: '4px' }}>+</span> –î–æ–±–∞–≤–∏—Ç—å
                              </button>
                            )}
                          </div>

                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–¢–µ–ª–µ—Ñ–æ–Ω</p>
                            {selectedDialog.phone && dialogEditingField !== 'phone' ? (
                              <span className="text-[12px] text-[#070F1A] font-[500]">{selectedDialog.phone}</span>
                            ) : dialogEditingField === 'phone' ? (
                              <input
                                type="tel"
                                value={dialogEditingValue}
                                onChange={(e) => setDialogEditingValue(e.target.value)}
                                placeholder="+7 (999) 123-45-67"
                                className="text-[12px] text-[#070F1A] bg-transparent border-none outline-none p-0 w-full"
                                autoFocus
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    saveDialogEdit();
                                  } else if (e.key === 'Escape') {
                                    e.preventDefault();
                                    cancelDialogEdit();
                                  }
                                }}
                                onBlur={(e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  saveDialogEdit();
                                }}
                              />
                            ) : (
                              <button 
                                className="text-[12px] text-[#8E8E93] flex items-center cursor-text focus:outline-none bg-transparent border-none p-0"
                                onClick={(e) => { 
                                  e.preventDefault();
                                  e.stopPropagation();
                                  startDialogEdit('phone', '');
                                }}
                              >
                                <span className="text-[18px]" style={{ fontWeight: 300, marginBottom: '2px', marginRight: '4px' }}>+</span> –î–æ–±–∞–≤–∏—Ç—å
                              </button>
                            )}
                          </div>

                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–ü–æ—á—Ç–∞</p>
                            {selectedDialog.email && dialogEditingField !== 'email' ? (
                              <span className="text-[12px] text-[#070F1A] font-[500]">{selectedDialog.email}</span>
                            ) : dialogEditingField === 'email' ? (
                              <input
                                type="email"
                                value={dialogEditingValue}
                                onChange={(e) => setDialogEditingValue(e.target.value)}
                                placeholder="ivan@example.com"
                                className="text-[12px] text-[#070F1A] bg-transparent border-none outline-none p-0 w-full"
                                autoFocus
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    saveDialogEdit();
                                  } else if (e.key === 'Escape') {
                                    e.preventDefault();
                                    cancelDialogEdit();
                                  }
                                }}
                                onBlur={(e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  saveDialogEdit();
                                }}
                              />
                            ) : (
                              <button 
                                className="text-[12px] text-[#8E8E93] flex items-center cursor-text focus:outline-none bg-transparent border-none p-0"
                                onClick={(e) => { 
                                  e.preventDefault();
                                  e.stopPropagation();
                                  startDialogEdit('email', '');
                                }}
                              >
                                <span className="text-[18px]" style={{ fontWeight: 300, marginBottom: '2px', marginRight: '4px' }}>+</span> –î–æ–±–∞–≤–∏—Ç—å
                              </button>
                            )}
                          </div>

                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '120px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–ê–¥—Ä–µ—Å</p>
                            {selectedDialog.address && dialogEditingField !== 'address' ? (
                              <span className="text-[12px] text-[#070F1A] font-[500]">{selectedDialog.address}</span>
                            ) : dialogEditingField === 'address' ? (
                              <input
                                type="text"
                                value={dialogEditingValue}
                                onChange={(e) => setDialogEditingValue(e.target.value)}
                                placeholder="–ú–æ—Å–∫–≤–∞"
                                className="text-[12px] text-[#070F1A] bg-transparent border-none outline-none p-0 w-full"
                                autoFocus
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    saveDialogEdit();
                                  } else if (e.key === 'Escape') {
                                    e.preventDefault();
                                    cancelDialogEdit();
                                  }
                                }}
                                onBlur={(e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  saveDialogEdit();
                                }}
                              />
                            ) : (
                              <button 
                                className="text-[12px] text-[#8E8E93] flex items-center cursor-text focus:outline-none bg-transparent border-none p-0"
                                style={{ marginLeft: '-2px' }}
                                onClick={(e) => { 
                                  e.preventDefault();
                                  e.stopPropagation();
                                  startDialogEdit('address', '');
                                }}
                              >
                                <span className="text-[18px]" style={{ fontWeight: 300, marginBottom: '2px', marginRight: '4px' }}>+</span> –î–æ–±–∞–≤–∏—Ç—å
                              </button>
                            )}
                          </div>

                          <div className="grid items-center gap-2" style={{ gridTemplateColumns: '120px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93]">–ö–æ–º–ø–∞–Ω–∏—è</p>
                            {selectedDialog.company && dialogEditingField !== 'company' ? (
                              <span className="text-[12px] text-[#070F1A] font-[500]">{selectedDialog.company}</span>
                            ) : dialogEditingField === 'company' ? (
                              <input
                                type="text"
                                value={dialogEditingValue}
                                onChange={(e) => setDialogEditingValue(e.target.value)}
                                placeholder='–û–û–û "–ê–≥—Ä–æ–°—Ç—Ä–æ–π"'
                                className="text-[12px] text-[#070F1A] bg-transparent border-none outline-none p-0 w-full"
                                autoFocus
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    saveDialogEdit();
                                  } else if (e.key === 'Escape') {
                                    e.preventDefault();
                                    cancelDialogEdit();
                                  }
                                }}
                                onBlur={(e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  saveDialogEdit();
                                }}
                              />
                            ) : (
                              <button 
                                className="text-[12px] text-[#8E8E93] flex items-center cursor-text focus:outline-none bg-transparent border-none p-0"
                                style={{ marginLeft: '-2px' }}
                                onClick={(e) => { 
                                  e.preventDefault();
                                  e.stopPropagation();
                                  startDialogEdit('company', '');
                                }}
                              >
                                <span className="text-[18px]" style={{ fontWeight: 300, marginBottom: '2px', marginRight: '4px' }}>+</span> –î–æ–±–∞–≤–∏—Ç—å
                              </button>
                            )}
                          </div>

                          {/* Dialog ID */}
                          <div className="space-y-1">
                            <p className="text-[12px] text-[#8E8E93]">Dialog ID</p>
                            <span className="text-[12px] text-[#8E8E93] font-[500] font-mono">{selectedDialog.id}</span>
                          </div>

                          <div className="grid gap-2" style={{ gridTemplateColumns: '115px 1fr' }}>
                            <p className="text-[12px] text-[#8E8E93] col-span-1">–ó–∞–º–µ—Ç–∫–∏</p>
                            <div className="col-span-2" style={{ gridColumn: '1 / -1' }}>
                              {dialogEditingField === 'notes' ? (
                                <textarea
                                  value={dialogEditingValue}
                                  onChange={(e) => setDialogEditingValue(e.target.value)}
                                  placeholder="–ó–∞–º–µ—Ç–∫–∞"
                                  className="text-[12px] text-[#070F1A] bg-transparent border-none outline-none p-0 w-full resize-none"
                                  rows={3}
                                  autoFocus
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter') {
                                      e.preventDefault();
                                      e.stopPropagation();
                                      saveDialogEdit();
                                    } else if (e.key === 'Escape') {
                                      e.preventDefault();
                                      cancelDialogEdit();
                                    }
                                  }}
                                  onBlur={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    saveDialogEdit();
                                  }}
                                />
                              ) : selectedDialog.notes ? (
                                <div
                                  className="text-[12px] text-[#070F1A] font-[500] whitespace-pre-wrap cursor-text"
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    startDialogEdit('notes', selectedDialog.notes || '');
                                  }}
                                >
                                  {selectedDialog.notes}
                                </div>
                              ) : (
                                <button
                                  className="text-[12px] text-[#8E8E93] flex items-center cursor-text focus:outline-none bg-transparent border-none p-0"
                                  onClick={(e) => { 
                                    e.preventDefault();
                                    e.stopPropagation();
                                    startDialogEdit('notes', '');
                                  }}
                                >
                                  <span className="text-[18px]" style={{ fontWeight: 300, marginBottom: '2px', marginRight: '4px' }}>+</span> –î–æ–±–∞–≤–∏—Ç—å
                              </button>
                            )}
                          </div>

                        </div>
                      </div>
                        </div>
                      {/* —Å–∫—Ä—ã—Ç–æ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é: –°–æ–æ–±—â–µ–Ω–∏–π/–ù–∞—á–∞–ª–æ/–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å */}
                      </div>
                ) : (
                    <div className="flex flex-col items-center justify-center h-full py-12">
                  </div>
                )}
            
                  {/* –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É */}
                  {selectedDialog && (
                    <div className="p-4 border-t border-[#E5E7EB] space-y-3">
                      {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                      <div className="flex gap-2">
                        <button 
                          onClick={() => exportDialogToText(selectedDialog)}
                          className="flex-1 h-[34px] bg-[#F3F4F6] text-[#070F1A] hover:bg-[#E5E7EB] rounded-[10px] text-[14px] font-[500] transition-colors flex items-center justify-center gap-2"
                        >
                          <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 0.500244C15.2467 0.500244 19.5 4.75354 19.5 10.0002C19.5 15.2469 15.2467 19.5002 10 19.5002C4.75329 19.5002 0.5 15.2469 0.5 10.0002C0.5 4.75354 4.75329 0.500244 10 0.500244ZM10.5312 5.18384C10.2567 4.90956 9.82182 4.89203 9.52734 5.13208L9.4707 5.18384L6.04199 8.61255C5.74926 8.90535 5.7494 9.3802 6.04199 9.6731C6.33487 9.9659 6.80966 9.9659 7.10254 9.6731L9.25098 7.52466V14.2854C9.25098 14.6996 9.58683 15.0353 10.001 15.0354C10.4151 15.0353 10.751 14.6996 10.751 14.2854V7.52466L12.8994 9.6731C13.1923 9.96578 13.6671 9.96592 13.96 9.6731C14.2526 9.38026 14.2526 8.90539 13.96 8.61255L10.5312 5.18384Z" fill="#0084FF"/>
                          </svg>
                        </button>
                        <button 
                          onClick={() => {
                            setDialogToDelete(selectedDialog.id);
                            setShowDeleteDialogPopup(true);
                          }}
                          className="flex-1 h-[34px] bg-[#FEF2F2] text-[#EF4444] hover:bg-[#FEE2E2] rounded-[10px] text-[14px] font-[500] transition-colors flex items-center justify-center gap-2"
                        >
                          <img src="/traash.svg" alt="–£–¥–∞–ª–∏—Ç—å" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%)' }} />
                        </button>
                      </div>
                      
                      {/* –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ CRM" - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –Ω–µ –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ CRM */}
                      {!selectedDialog.isAddedToCRM && (selectedDialog.email || selectedDialog.phone) && (
                        <Button 
                          onClick={() => createDealFromDialog(selectedDialog)}
                          variant="outline" 
                          size="sm" 
                          className="w-full h-[34px] bg-[#0084FF] border-none text-white hover:bg-[#0073E6] rounded-[10px] font-[500] text-[14px] transition-colors"
                        >
                          –î–æ–±–∞–≤–∏—Ç—å –≤ CRM
                        </Button>
                      )}
                    </div>
                  )}

              </div>
            </div>
          </div>
        );

      case 'my-adapto':
        return (
          <div className="flex flex-col h-full">
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */}
            <div className="flex items-center justify-between mb-[16px]">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
              
            </div>
            <div className="border-b mb-0 mt-0" style={{ borderColor: '#E5E6E7', marginTop: 0, marginLeft: '-16px', marginRight: '-16px' }}></div>

            {/* –û—Å–Ω–æ–≤–Ω–∞—è –ø–ª–æ—â–∞–¥—å –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */}
            <div className="flex gap-0 items-stretch flex-1 min-h-0 -mb-4" style={{ marginLeft: 0, marginRight: 0 }}>
              {/* –õ–µ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä - –ø–æ–ª–µ –¥–ª—è –ø—Ä–∞–≤–æ–∫ */}
              <div className="flex-1 bg-[#F8F8FA] rounded-none flex flex-col h-full overflow-y-auto" style={{ paddingTop: 0, paddingRight: 0, paddingBottom: 0, paddingLeft: 0, marginLeft: 0, marginRight: '16px', marginTop: '16px' }}>

                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏" –∏ –∫–Ω–æ–ø–∫–∏ */}
                <div className="flex items-center justify-between mb-[30px]">
                  <div className="flex items-center gap-3">
                  <h3 className="text-[18px] font-[500] text-[#070F1A]">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</h3>
                    {selectedCorrections.size > 0 && (
                      <span className="text-[14px] text-[#8E8E93]">–í—ã–±—Ä–∞–Ω–æ: {selectedCorrections.size}</span>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    {/* –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ */}
                    <button 
                      onClick={async () => {
                        // –†–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
                        setIsUpdatingCorrections(true);
                        showNotificationMessage('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫...');
                        
                        try {
                          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∏–∑ Supabase
                          if (currentUser?.id) {
                            const updatedCorrections = await botCorrectionsAPI.getCorrections(currentUser.id);
                            setBotCorrections(updatedCorrections);
                            console.log('–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', updatedCorrections);
                            showNotificationMessage('–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –ò–ò –∞–≥–µ–Ω—Ç—É');
                          } else {
                            console.error('No current user ID available');
                            showNotificationMessage('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                          }
                        } catch (error) {
                          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫:', error);
                          showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫');
                        } finally {
                          setIsUpdatingCorrections(false);
                        }
                      }}
                      className="h-[32px] px-3 text-[#8E8E93] hover:bg-[#F2F3F4] hover:text-[#070F1A] rounded-[10px] transition-colors flex items-center justify-center gap-2 group"
                      style={BUTTON_STYLES.whiteButton}
                    >
                      <img 
                        src="/arrow-refresh-02.svg" 
                        alt="–û–±–Ω–æ–≤–∏—Ç—å" 
                        className={`w-[14px] h-[14px] transition-transform duration-200 ${isUpdatingCorrections ? 'animate-spin' : ''} [filter:brightness(0)_saturate(100%)_invert(59%)_sepia(2%)_saturate(0%)_hue-rotate(217deg)_brightness(92%)_contrast(89%)] group-hover:[filter:none]`} 
                      />
                      –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    
                    {selectedCorrections.size > 0 && (
                      <>
                        <button 
                          onClick={() => setShowDeleteConfirmModal(true)}
                          className="h-[32px] px-3 bg-[#FEF2F2] text-[#FF0D0D] hover:text-[#FF0D0D] hover:bg-[#FEF2F2] rounded-[10px] transition-colors flex items-center justify-center gap-2"
                          style={BUTTON_STYLES.whiteButton}
                        >
                          <img src="/traash.svg" alt="–£–¥–∞–ª–∏—Ç—å" className="w-4 h-4" />
                          –£–¥–∞–ª–∏—Ç—å
                        </button>
                      </>
                    )}
                  <button 
                    onClick={() => setShowAddCorrectionForm(!showAddCorrectionForm)}
                      className="h-[32px] px-3 bg-[#0084FF] rounded-[10px] text-white hover:bg-[#0073E6] transition-colors flex items-center justify-center gap-1"
                      style={BUTTON_STYLES.blueButton}
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    –î–æ–±–∞–≤–∏—Ç—å
                  </button>
                  </div>
                </div>

                {/* –£–±—Ä–∞–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */}

                {/* –°–µ–∫—Ü–∏—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞–º–∏ */}
                <div className="space-y-3 mb-[15px]">
                  {/* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ */}
                  {botCorrections.map((correction, index) => (
                    <div key={index} className={`flex items-center p-3 rounded-[15px] transition-colors cursor-pointer ${
                      selectedCorrections.has(index) ? 'bg-[#F9FAFB]' : 'hover:bg-[#F2F3F4]'
                    }`}>
                      {/* –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –∫–Ω–æ–ø–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è */}
                      <div className="w-4 mr-4">
                        <img 
                          src={selectedCorrections.has(index) ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                          alt="–í—ã–±—Ä–∞—Ç—å" 
                          className="w-4 h-4 cursor-pointer" 
                          onClick={() => toggleCorrectionSelection(index)}
                        />
                      </div>
                      {/* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å - –æ–ø–∏—Å–∞–Ω–∏–µ */}
                      <div className="flex-1">
                        <span className="text-[#070F1A] font-medium text-[14px]">{correction.correction || correction}</span>
                      </div>
                      {/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */}
                      <div className="flex items-center gap-2 ml-4">
                        <img 
                          src={activeCorrections.has(index) ? "/iOS/Switch-1.svg" : "/iOS/Switch.svg"} 
                          alt="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" 
                          className="w-[34px] h-[34px] cursor-pointer" 
                          onClick={() => toggleCorrectionActivity(index)}
                        />
                      </div>
                    </div>
                  ))}

                  {/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞ */}
                  {showAddCorrectionForm && (
                    <div className={`flex items-center p-3 rounded-[10px] transition-colors cursor-pointer bg-[#F9FAFB]`}>
                      {/* –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –∫–Ω–æ–ø–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è */}
                      <div className="w-4 mr-4">
                        <img 
                          src="/Checkbox-1.svg" 
                          alt="–í—ã–±—Ä–∞—Ç—å" 
                          className="w-4 h-4 cursor-pointer" 
                        />
                      </div>
                      {/* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å - –æ–ø–∏—Å–∞–Ω–∏–µ */}
                      <div className="flex-1">
                        <input
                          type="text"
                          value={newCorrectionText}
                          onChange={(e) => setNewCorrectionText(e.target.value)}
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É..."
                          className="w-full h-[34px] px-3 border-none bg-transparent text-[#070F1A] text-[14px] focus:outline-none focus:ring-0 focus:border-transparent"
                          onKeyPress={(e) => e.key === 'Enter' && handleAddCorrection()}
                        />
                      </div>
                      {/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –∫–Ω–æ–ø–∫–∏ */}
                      <div className="flex items-center gap-2 ml-4">
                        <button
                          onClick={handleAddCorrection}
                          disabled={isAddingCorrection}
                          className={`h-[32px] px-4 rounded-[10px] transition-colors flex items-center justify-center ${
                            isAddingCorrection 
                              ? 'bg-[#0084FF]/50 text-white cursor-not-allowed' 
                              : 'bg-[#0084FF] text-white hover:bg-[#0073E6]'
                          }`}
                          style={!isAddingCorrection ? BUTTON_STYLES.blueButton : { fontSize: '13px', fontWeight: '500' }}
                        >
                          {isAddingCorrection ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
                        </button>
                        <button 
                          onClick={() => setShowAddCorrectionForm(false)}
                          className="w-[32px] h-[32px] flex items-center justify-center text-[#8E8E93] hover:text-[#070F1A] transition-colors"
                        >
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  )}

                </div>


              </div>

              {/* –ü—Ä–∞–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä - –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ */}
              <div className="w-[400px] bg-[#F8F8FA] rounded-none p-4 flex flex-col border border-[#E5E7EB] border-t-0 h-full overflow-y-auto -mr-4" style={{ flexShrink: 0, paddingLeft: 0, paddingRight: 0, marginRight: '-16px' }}>
                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" */}
                <div className="flex items-center justify-between mb-4" style={{ paddingLeft: '16px', paddingRight: '16px' }}>
                  <div className="flex items-center gap-2">
                    <h2 className="text-[18px] font-[500] text-[#070F1A]">–ß–∞—Ç</h2>
                  </div>
                  <button 
                    onClick={async () => {
                      if (currentUser?.id) {
                        try {
                          setIsUpdatingDialog(true);
                          console.log('Attempting to clear chat history for user:', currentUser.id);
                          const result = await chatHistoryAPI.clearChatHistory(currentUser.id);
                          console.log('Clear chat history result:', result);
                          
                          if (result) {
                            setChatHistory([
                              { type: 'assistant', text: '–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Adapto. –ö–∞–∫ –¥–µ–ª–∞?', time: '–¢–æ–ª—å–∫–æ —á—Ç–æ', timestamp: Date.now() }
                            ]);
                            showNotificationMessage('–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
                            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
                            ChatUtils.scrollToBottom(chatHistoryRef);
                          } else {
                            showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏');
                          }
                        } catch (error) {
                          console.error('Error clearing chat history:', error);
                          showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message);
                        } finally {
                          setIsUpdatingDialog(false);
                        }
                      } else {
                        console.error('No current user ID available');
                        showNotificationMessage('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                      }
                    }}
                    className="w-[32px] h-[32px] bg-[#FFFFFF] rounded-[90px] flex items-center justify-center hover:bg-gray-100 transition-colors"
                    title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–ª–æ–≥"
                  >
                    <img 
                      src="/arrow-refresh-02.svg" 
                      alt="–û–±–Ω–æ–≤–∏—Ç—å" 
                      className={`w-4 h-4 transition-transform duration-200 ${isUpdatingDialog ? 'animate-spin' : ''}`} 
                      style={{ filter: 'brightness(0) saturate(100%) invert(57%) sepia(0%) saturate(0%) hue-rotate(186deg) brightness(94%) contrast(92%)' }}
                    />
                  </button>
                </div>
                
                {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */}
                <div className="border-b border-[#E5E7EB] mb-4"></div>

                {/* –î–∏–∞–ª–æ–≥ */}
                <div className="flex-1 flex flex-col" style={{ paddingLeft: '0px', paddingRight: '0px' }}>
                  {/* –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ */}
                  <div ref={widgetChatRef} className="flex-1 space-y-4 overflow-y-auto mb-4 widget-chat-container" style={{ paddingLeft: '16px', paddingRight: '16px', flexBasis: 0 }}>
                    {/* –ü–ª–∞—à–∫–∞ "–°–µ–≥–æ–¥–Ω—è" */}
                    <div className="text-center">
                      <span className="bg-gray-100 text-gray-600 text-xs px-3 py-1 rounded-[90px]">–°–µ–≥–æ–¥–Ω—è</span>
                    </div>
                    
                    <VirtualizedMessageList
                      messages={chatMessages}
                      getMessageAlignment={getMessageAlignment}
                      getMessageOrder={getMessageOrder}
                      getMessageStyle={getMessageStyle}
                      getMessageFooter={getMessageFooter}
                      aiAgentName={aiAgentName}
                      containerRef={widgetChatRef}
                    />
                  </div>

                  {/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ - –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –≤–Ω–∏–∑—É */}
                  <div className="relative flex-shrink-0" style={{ paddingLeft: '16px', paddingRight: '16px' }}>
                    <div className="relative">
                    <input
                      type="text"
                      value={currentMessage}
                      onChange={(e) => setCurrentMessage(e.target.value)}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          handleWidgetChatSendMessage();
                        }
                      }}
                      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                        className="w-full h-[40px] px-4 py-2 pr-[100px] rounded-[20px] border border-[#E5E7EB] focus:outline-none focus:ring-0 text-[14px] text-[#070F1A] bg-[#F8F8FA]"
                    />
                      <div className="absolute right-1 top-1/2 transform -translate-y-1/2 flex items-center gap-1">
                      <button 
                        onClick={handleChatFileUpload}
                          className="w-[22px] h-[32px] flex items-center justify-center transition-colors"
                        title="–î–æ–±–∞–≤–∏—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ"
                      >
                          <img src="/paperclip.svg" alt="–í–ª–æ–∂–µ–Ω–∏–µ" className="w-[18px] h-[18px] text-[#8E8E93] hover:text-[#070F1A] transition-colors" />
                      </button>
                      <button 
                        onClick={handleWidgetChatSendMessage}
                          className="w-[32px] h-[32px] bg-[#0084FF] rounded-[90px] flex items-center justify-center cursor-pointer disabled:bg-[#070F1A] disabled:bg-opacity-10 disabled:cursor-not-allowed transition-colors"
                        disabled={!currentMessage.trim()}
                        title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"
                      >
                        <img 
                          src="/Frame 118.svg" 
                      alt="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" 
                          className={`w-3 h-3 ${!currentMessage.trim() ? 'opacity-60' : ''}`}
                    />
                      </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        );

      case 'model-extensions':
        return (
          <div className="space-y-0">
            <div className="flex justify-between items-center">
              <h1 className="text-[20px] font-[500] text-[#070F1A] mb-[16px]">–†–∞—Å—à–∏—Ä–µ–Ω–∏—è</h1>
            </div>
            <div className="border-b" style={{ borderColor: '#E5E7EB', marginLeft: '-16px', marginRight: '-16px' }}></div>

            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4" style={{ marginLeft: '1px', marginRight: '1px', marginTop: '20px' }}>
              {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram */}
              <div className="border border-transparent rounded-[16px] p-[15px] bg-white">
                <div className="flex flex-col">
                  <div className="flex-shrink-0 mb-3">
                    <img src="/333312.png" alt="Telegram" className="w-[24px] h-[24px]" />
                  </div>
                  <div>
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</h3>
                    <p className="text-[13px] text-[#8E8E93]">–ë—É–¥—å—Ç–µ –≤—Å–µ–≥–¥–∞ –≤ –∫—É—Ä—Å–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</p>
                  </div>
                </div>
                <div className="w-full mt-[20px]">
                  <button 
                    onClick={() => {
                      setActiveSection('profile');
                      setProfileTab('notifications');
                      setSidebarOpen(false);
                    }}
                    className="w-full h-[34px] text-[#8E8E93] rounded-[12px] transition-colors hover:bg-[#F2F3F4]"
                    style={BUTTON_STYLES.whiteButton}
                  >
                    –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
                  </button>
                </div>
              </div>

              {/* –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ */}
              <div className="border border-transparent rounded-[16px] p-[15px] bg-white">
                <div className="flex flex-col">
                  <div className="flex-shrink-0 mb-3">
                    <img src="/333313.png" alt="–ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è" className="w-[24px] h-[24px]" />
                  </div>
                  <div>
                    <h3 className="text-[16px] font-medium text-[#070F1A] mb-1">–ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤</h3>
                    <p className="text-[13px] text-[#8E8E93]">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ò–ò-–∞–≥–µ–Ω—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–µ</p>
                  </div>
                </div>
                <div className="w-full mt-[20px]">
                  <button 
                    onClick={() => setShowAutoswitchPopup(true)}
                    className="w-full h-[34px] bg-[#0084FF] text-white rounded-[12px] transition-colors hover:bg-[#0073E6]"
                    style={BUTTON_STYLES.blueButton}
                  >
                    –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                  </button>
                </div>
              </div>
            </div>

            {/* –ü–æ–ø–∞–ø –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è */}
            {showAutoswitchPopup && (
              <div className="fixed inset-0 bg-black/20 flex items-center justify-center z-50">
                <div className="bg-white rounded-[16px] p-5 w-[500px] max-h-[90vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-3">
                    <h2 className="text-[20px] font-[500] text-[#070F1A]">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è</h2>
                    <button 
                      onClick={() => setShowAutoswitchPopup(false)}
                      className="w-8 h-8 flex items-center justify-center text-[#8E8E93] hover:text-[#070F1A] transition-colors rounded-[8px] hover:bg-[#F2F3F4]"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                      </svg>
                    </button>
                  </div>

                  <div className="space-y-[15px]">
                    <p className="text-[14px] text-[#8E8E93] leading-relaxed">
                      –ò–ò-–∞–≥–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∏—Ç—å—Å—è –æ—Ç –¥–∏–∞–ª–æ–≥–∞ –∏–ª–∏ –≤—Å—Ç—É–ø–∏—Ç—å –≤ –Ω–µ–≥–æ —Å–ø—É—Å—Ç—è –≤—Ä–µ–º—è
                    </p>

                    {/* –í—ã–∫–ª—é—á–∞—Ç—å –ò–ò –ø—Ä–∏ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–µ —á–µ–ª–æ–≤–µ–∫–∞ */}
                    <div className="flex items-center justify-between p-4 rounded-[12px] mt-[30px]" style={{ background: '#F8F8FA' }}>
                      <div className="w-[310px]">
                        <h3 className="text-[14px] font-[500] text-[#070F1A] mb-1">
                          –í—ã–∫–ª—é—á–∞—Ç—å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ø—Ä–∏ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–µ –≤ –¥–∏–∞–ª–æ–≥ —á–µ–ª–æ–≤–µ–∫–∞
                        </h3>
                        <p className="text-[12px] text-[#8E8E93]">
                          –î–∏–∞–ª–æ–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–π–¥–µ—Ç –≤ —Ä–∞–±–æ—Ç—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
                        </p>
                      </div>
                      <div className="flex items-center">
                        <img 
                          src={autoswitchSettings.disableOnHumanIntervention ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                          alt="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å" 
                          className="w-[34px] h-6 cursor-pointer" 
                          onClick={() => setAutoswitchSettings(prev => ({
                            ...prev,
                            disableOnHumanIntervention: !prev.disableOnHumanIntervention
                          }))}
                        />
                      </div>
                    </div>

                    {/* –í–∫–ª—é—á–∞—Ç—å –ò–ò –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */}
                    <div className="flex items-center justify-between p-4 rounded-[12px]" style={{ background: '#F8F8FA' }}>
                      <div className="w-[310px]">
                        <h3 className="text-[14px] font-[500] text-[#070F1A] mb-1">
                          –í–∫–ª—é—á–∞—Ç—å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                        </h3>
                        <p className="text-[12px] text-[#8E8E93]">
                          –ò–ò-–∞–≥–µ–Ω—Ç —Å–ø—É—Å—Ç—è –≤—Ä–µ–º—è –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ –¥–∏–∞–ª–æ–≥
                        </p>
                      </div>
                      <div className="flex items-center">
                        <img 
                          src={autoswitchSettings.enableAfterOperatorSwitch ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                          alt="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å" 
                          className="w-[34px] h-6 cursor-pointer" 
                          onClick={() => setAutoswitchSettings(prev => ({
                            ...prev,
                            enableAfterOperatorSwitch: !prev.enableAfterOperatorSwitch
                          }))}
                        />
                      </div>
                    </div>

                    {/* –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –º–∏–Ω—É—Ç */}
                    {autoswitchSettings.enableAfterOperatorSwitch && (
                      <div className="p-4 rounded-[12px]" style={{ background: '#F8F8FA' }}>
                        <label className="block text-[14px] font-[500] text-[#070F1A] mb-2">
                          –í–∫–ª—é—á–∞—Ç—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑
                        </label>
                        <div className="flex items-center gap-2">
                          <input
                            type="number"
                            min="1"
                            max="60"
                            value={autoswitchSettings.switchDelayMinutes}
                            onChange={(e) => setAutoswitchSettings(prev => ({
                              ...prev,
                              switchDelayMinutes: parseInt(e.target.value) || 5
                            }))}
                            className="w-20 h-10 px-3 rounded-[8px] focus:outline-none"
                            style={INPUT_STYLES.inputField}
                          />
                          <span className="text-[14px] text-[#8E8E93]">–º–∏–Ω—É—Ç</span>
                        </div>
                      </div>
                    )}

                    {/* –ö–Ω–æ–ø–∫–∏ */}
                    <div className="flex gap-3 pt-4">
                      <button
                        onClick={() => setShowAutoswitchPopup(false)}
                        className="flex-1 h-[34px] text-[#070F1A] rounded-[12px] transition-colors hover:border-[#070F1A]/20"
                        style={BUTTON_STYLES.whiteButton}
                      >
                        –û—Ç–º–µ–Ω–∞
                      </button>
                      <button
                        onClick={async () => {
                          try {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ API
                            const response = await fetch('${API_CONFIG.BASE_URL}/api/autoswitch/settings', {
                              method: 'POST',
                              headers: {
                                'Content-Type': 'application/json',
                              },
                              body: JSON.stringify(autoswitchSettings),
                            });
                            
                            if (response.ok) {
                              setShowAutoswitchPopup(false);
                              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                              setShowNotification(true);
                              setTimeout(() => setShowNotification(false), 3000);
                            }
                          } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                          }
                        }}
                        className="flex-1 h-[34px] bg-[#0084FF] text-white rounded-[12px] transition-colors hover:bg-[#0066CC]"
                        style={BUTTON_STYLES.blueButton}
                      >
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );

      case 'widget-settings':
        return (
          <div className="space-y-6">
            <h1 className="text-[20px] font-[500] text-[#070F1A]">–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç</h1>
            
            <div className="bg-white rounded-[20px] p-6 border border-gray-200">
              <div className="space-y-8">
                {/* Accent Color */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</label>
                  <div className="flex items-center gap-3">
                    <input 
                      type="text" 
                      value={widgetDevelopmentSettings.accentColor}
                      onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, accentColor: e.target.value})}
                      className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                      placeholder="HEX"
                    />
                    <input 
                      type="color" 
                      value={widgetDevelopmentSettings.accentColor}
                      onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, accentColor: e.target.value})}
                      className="w-10 h-10 rounded-lg border-2 border-gray-300 cursor-pointer"
                    />
                    <button 
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, accentColor: '#1354FC'})}
                      className="text-gray-400 hover:text-gray-600"
                    >
                      √ó
                    </button>
                  </div>
                </div>

                {/* Button Color */}
                <div>
                  <label className="block text-sm font-medium mb-3">–¶–≤–µ—Ç –∫–Ω–æ–ø–∫–∏</label>
                  <div className="grid grid-cols-3 gap-3">
                    {[
                      { id: 'light', label: '–°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω', bg: 'bg-white', border: 'border-blue-500', text: 'text-blue-500' },
                      { id: 'dark', label: '–¢–µ–º–Ω—ã–π —Ñ–æ–Ω', bg: 'bg-gray-900', border: 'border-white', text: 'text-white' },
                      { id: 'custom', label: '–ó–∞–¥–∞—Ç—å —Å–≤–æ–π —Ü–≤–µ—Ç', bg: 'bg-gradient-to-r from-yellow-400 via-pink-500 to-blue-500', border: 'border-blue-500', text: 'text-white' }
                    ].map((style) => (
                      <button
                        key={style.id}
                        onClick={() => setWidgetSettings({...widgetDevelopmentSettings, buttonColor: style.id})}
                        className={`p-3 rounded-lg border-2 transition-all ${
                          widgetDevelopmentSettings.buttonColor === style.id 
                            ? 'border-blue-500 ring-2 ring-blue-200' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div 
                          className={`w-[140px] h-[42px] rounded-xl flex items-center justify-center gap-2 mb-2 mx-auto ${
                            style.id === 'light' ? 'bg-white border-2 border-gray-300' :
                            style.id === 'dark' ? 'bg-gray-900' :
                            'bg-gradient-to-r from-yellow-400 via-pink-500 to-blue-500'
                          }`}
                          style={{
                            borderColor: style.id === 'light' ? widgetDevelopmentSettings.accentColor : 'transparent',
                            color: style.id === 'light' ? widgetDevelopmentSettings.accentColor : 'white'
                          }}
                        >
                          <div 
                            className="w-4 h-4 rounded-[90px] opacity-80"
                            style={{ backgroundColor: style.id === 'light' ? widgetDevelopmentSettings.accentColor : 'currentColor' }}
                          ></div>
                          <span className="text-sm font-medium" style={{ maxWidth: '90px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                            –ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º
                          </span>
                        </div>
                        <span className={`text-xs ${widgetDevelopmentSettings.buttonColor === style.id ? 'text-blue-600' : 'text-gray-600'}`}>
                          {style.label}
                        </span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Custom Color Picker */}
                {widgetDevelopmentSettings.buttonColor === 'custom' && (
                  <div>
                    <label className="block text-sm font-medium mb-3">–í–≤–µ–¥–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è —Ñ–æ–Ω–∞</label>
                    <div className="flex items-center gap-3">
                      <input 
                        type="text" 
                        value={widgetDevelopmentSettings.customButtonColor}
                        onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, customButtonColor: e.target.value})}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                        placeholder="HEX"
                      />
                      <input 
                        type="color" 
                        value={widgetDevelopmentSettings.customButtonColor}
                        onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, customButtonColor: e.target.value})}
                        className="w-10 h-10 rounded-lg border-2 border-gray-300 cursor-pointer"
                      />
                    </div>
                  </div>
                )}

                {/* Button Text */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏</label>
                  <input 
                    type="text" 
                    value={widgetDevelopmentSettings.buttonText}
                    onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, buttonText: e.target.value})}
                    className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º"
                  />
                </div>

                {/* Button Style */}
                <div>
                  <label className="block text-sm font-medium mb-3">–°—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏</label>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, buttonColor: 'rectangle'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.buttonColor === 'rectangle' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="w-[120px] h-[40px] bg-blue-600 rounded-lg mx-auto mb-2 flex items-center justify-center">
                          <span className="text-white text-sm font-medium">–°–ø—Ä–æ—Å–∏—Ç—å –ò–ò</span>
                        </div>
                        <div className="text-sm font-medium">–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, buttonColor: 'ellipse'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.buttonColor === 'ellipse' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="w-[120px] h-[40px] bg-blue-600 rounded-[90px] mx-auto mb-2 flex items-center justify-center">
                          <span className="text-white text-sm font-medium">üí¨</span>
                        </div>
                        <div className="text-sm font-medium">–ö—Ä—É–≥–ª–∞—è</div>
                      </div>
                    </button>
                  </div>
                </div>

                {/* Logo Settings */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <div className="space-y-6 border p-4 rounded-lg">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä—è–¥–æ–º —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º</label>
                      <input 
                        type="text"
                        value={widgetDevelopmentSettings.logoName || ''}
                        onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, logoName: e.target.value})}
                        className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                      />
                      <p className="mt-2 text-sm text-gray-500">–¢–µ–∫—Å—Ç, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ä—è–¥–æ–º —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –≤ –≤–∏–¥–∂–µ—Ç–µ.</p>
                    </div>
                  </div>
                  <div className="space-y-6 border p-4 rounded-lg">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">–°—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø</label>
                      <input 
                        type="url"
                        value={widgetDevelopmentSettings.logoUrl || ''}
                        onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, logoUrl: e.target.value})}
                        className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø"
                      />
                      <p className="mt-2 text-sm text-gray-500">–í—Å—Ç–∞–≤—å—Ç–µ URL –ª–æ–≥–æ—Ç–∏–ø–∞ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –≤–∏–¥–∂–µ—Ç–µ.</p>
                    </div>
                  </div>
                </div>

                {/* –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–±—ã—Å—Ç—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è) */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</label>
                  <p className="text-sm text-gray-600 mb-4">–£–∫–∞–∂–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∏–¥–Ω—ã –≤ –≤–∏–¥–∂–µ—Ç–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</p>
                  <div className="space-y-4">
                    {widgetDevelopmentSettings.suggestions?.map((suggestion, index) => (
                      <div key={index} className="flex items-center border rounded-md p-2">
                        <input 
                          type="text" 
                          value={suggestion}
                          onChange={(e) => {
                            const newSuggestions = [...(widgetDevelopmentSettings.suggestions || [])];
                            newSuggestions[index] = e.target.value;
                            setWidgetSettings({...widgetDevelopmentSettings, suggestions: newSuggestions});
                          }}
                          className="flex-1 p-2 border border-gray-300 rounded-md text-sm"
                          placeholder={`–°–æ–æ–±—â–µ–Ω–∏–µ ${index + 1}`}
                        />
                        <button 
                          onClick={() => {
                            const newSuggestions = (widgetDevelopmentSettings.suggestions || []).filter((_, i) => i !== index);
                            setWidgetSettings({...widgetDevelopmentSettings, suggestions: newSuggestions});
                          }}
                          className="ml-2 text-red-400 hover:text-red-600 flex-none whitespace-nowrap"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block mr-1">
                            <path d="M18 6 6 18"></path>
                            <path d="m6 6 12 12"></path>
                          </svg>
                        </button>
                      </div>
                    ))}
                    <button 
                      onClick={() => {
                        const newSuggestions = [...(widgetDevelopmentSettings.suggestions || []), ''];
                        setWidgetSettings({...widgetDevelopmentSettings, suggestions: newSuggestions});
                      }}
                      className="text-blue-400 hover:text-blue-600 font-medium"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    </button>
                  </div>
                </div>

                {/* Avatar */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ê–≤–∞—Ç–∞—Ä Adapto</label>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, avatar: 'default'})}
                      className={`p-3 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.avatar === 'default' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-[90px] mx-auto mb-2 flex items-center justify-center">
                        <div className="flex items-center justify-center w-6 h-6">
                          <div className="w-3 h-3 bg-white rounded-[90px] mr-1"></div>
                          <div className="w-1.5 h-1.5 bg-white rounded-[90px]"></div>
                        </div>
                      </div>
                      <span className="text-xs text-center block">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                    </button>
                    <button
                      onClick={() => document.getElementById('avatar-input')?.click()}
                      className={`p-3 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.avatar === 'custom' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="w-12 h-12 bg-gray-200 rounded-[90px] mx-auto mb-2 flex items-center justify-center">
                        <span className="text-gray-500">+</span>
                      </div>
                      <span className="text-xs text-center block">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
                      <input 
                        id="avatar-input"
                        type="file" 
                        accept="image/*"
                        className="hidden" 
                        onChange={(e) => {
                          const file = e.target.files?.[0];
                          if (file) {
                            setWidgetSettings({...widgetDevelopmentSettings, avatar: 'custom'});
                            showNotificationMessage('–ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω!');
                          }
                        }}
                      />
                    </button>
                  </div>
                </div>

                {/* –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ */}
                <div>
                  <label className="block text-sm font-medium mb-3">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞</label>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, widgetLocation: 'default'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.widgetLocation === 'default' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
                        <div className="text-sm text-gray-600">–ü—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, widgetLocation: 'custom'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.widgetLocation === 'custom' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</div>
                        <div className="text-sm text-gray-600">–í—ã–±—Ä–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é</div>
                      </div>
                    </button>
                  </div>
                  
                  {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞ */}
                  {widgetDevelopmentSettings.widgetLocation === 'custom' && (
                    <div className="mt-4 space-y-6 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <h4 className="text-sm font-medium mb-3">–î–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤</h4>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-2">–û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É</label>
                            <input 
                              type="number" 
                              value={widgetDevelopmentSettings.desktopBottomOffset}
                              onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, desktopBottomOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-2">–û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞</label>
                            <input 
                              type="number" 
                              value={widgetDevelopmentSettings.desktopRightOffset}
                              onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, desktopRightOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                        </div>
                      </div>
                      
                      <div>
                        <h4 className="text-sm font-medium mb-3">–î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤</h4>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-2">–û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É</label>
                            <input 
                              type="number" 
                              value={widgetDevelopmentSettings.mobileBottomOffset}
                              onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, mobileBottomOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-2">–û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞</label>
                            <input 
                              type="number" 
                              value={widgetDevelopmentSettings.mobileRightOffset}
                              onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, mobileRightOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">Z-index</label>
                        <input 
                          type="number" 
                          value={widgetDevelopmentSettings.zIndex}
                          onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, zIndex: parseInt(e.target.value)})}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                          min="1"
                        />
                      </div>
                    </div>
                  )}
                </div>

                {/* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                  <div className="space-y-3">
                    {widgetDevelopmentSettings.welcomeMessages.map((message, index) => (
                      <div key={index} className="flex gap-2">
                        <input 
                          type="text" 
                          value={message}
                          onChange={(e) => {
                            const newMessages = [...widgetDevelopmentSettings.welcomeMessages];
                            newMessages[index] = e.target.value;
                            setWidgetSettings({...widgetDevelopmentSettings, welcomeMessages: newMessages});
                          }}
                          className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                          placeholder="–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
                        />
                        <button 
                          onClick={() => {
                            const newMessages = widgetDevelopmentSettings.welcomeMessages.filter((_, i) => i !== index);
                            setWidgetSettings({...widgetDevelopmentSettings, welcomeMessages: newMessages});
                          }}
                          className="px-3 py-2 text-red-500 hover:text-red-700"
                        >
                          √ó
                        </button>
                      </div>
                    ))}
                    <button 
                      onClick={() => {
                        const newMessages = [...widgetDevelopmentSettings.welcomeMessages, ''];
                        setWidgetSettings({...widgetDevelopmentSettings, welcomeMessages: newMessages});
                      }}
                      className="text-blue-600 hover:text-blue-700 text-sm"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    </button>
                  </div>
                </div>

                {/* –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–π –≤–æ–ø—Ä–æ—Å */}
                <div>
                  <label className="block text-sm font-medium mb-3">–¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–π –≤–æ–ø—Ä–æ—Å</label>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, triggerQuestionEnabled: 'no'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.triggerQuestionEnabled === 'no' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">–ù–µ—Ç</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, triggerQuestionEnabled: 'yes'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.triggerQuestionEnabled === 'yes' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">–ï—Å—Ç—å</div>
                      </div>
                    </button>
                  </div>
                  
                  {widgetDevelopmentSettings.triggerQuestionEnabled === 'yes' && (
                    <div className="space-y-4 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <label className="block text-sm font-medium mb-2">–ß–µ—Ä–µ–∑ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞—Ç—å:</label>
                        <div className="flex items-center gap-2">
                          <input 
                            type="number" 
                            value={widgetDevelopmentSettings.triggerQuestionDelay}
                            onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, triggerQuestionDelay: parseInt(e.target.value)})}
                            className="w-20 p-2 border border-gray-300 rounded-lg text-sm"
                            min="1"
                          />
                          <span className="text-sm text-gray-600">—Å–µ–∫</span>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">–í–æ–ø—Ä–æ—Å:</label>
                        <textarea 
                          value={widgetDevelopmentSettings.triggerQuestionText}
                          onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, triggerQuestionText: e.target.value})}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                          rows="3"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã:</label>
                        <div className="space-y-2">
                          {widgetDevelopmentSettings.quickReplies.map((reply, index) => (
                            <div key={index} className="flex gap-2">
                              <input 
                                type="text" 
                                value={reply}
                                onChange={(e) => {
                                  const newReplies = [...widgetDevelopmentSettings.quickReplies];
                                  newReplies[index] = e.target.value;
                                  setWidgetSettings({...widgetDevelopmentSettings, quickReplies: newReplies});
                                }}
                                className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                                placeholder="–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç"
                              />
                              <button 
                                onClick={() => {
                                  const newReplies = widgetDevelopmentSettings.quickReplies.filter((_, i) => i !== index);
                                  setWidgetSettings({...widgetDevelopmentSettings, quickReplies: newReplies});
                                }}
                                className="px-3 py-2 text-red-500 hover:text-red-700"
                              >
                                √ó
                              </button>
                            </div>
                          ))}
                          <button 
                            onClick={() => {
                              const newReplies = [...widgetDevelopmentSettings.quickReplies, ''];
                              setWidgetSettings({...widgetDevelopmentSettings, quickReplies: newReplies});
                            }}
                            className="text-blue-600 hover:text-blue-700 text-sm"
                          >
                            + –î–æ–±–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Follow up —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                <div>
                  <label className="block text-sm font-medium mb-3">Follow up —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                  <p className="text-sm text-gray-600 mb-4">–°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —É–≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –µ—Å–ª–∏ –≤—ã–π–¥–µ—Ç –∏–∑ –¥–∏–∞–ª–æ–≥–∞</p>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, followUpMessage: 'no'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.followUpMessage === 'no' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">–ù–µ—Ç</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, followUpMessage: 'yes'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.followUpMessage === 'yes' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">–ï—Å—Ç—å</div>
                      </div>
                    </button>
                  </div>
                  
                  {widgetDevelopmentSettings.followUpMessage === 'yes' && (
                    <div className="space-y-4 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <label className="block text-sm font-medium mb-2">–ß–µ—Ä–µ–∑ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞—Ç—å:</label>
                        <div className="flex items-center gap-2">
                          <input 
                            type="number" 
                            value={widgetDevelopmentSettings.followUpDelay}
                            onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, followUpDelay: parseInt(e.target.value)})}
                            className="w-20 p-2 border border-gray-300 rounded-lg text-sm"
                            min="1"
                          />
                          <span className="text-sm text-gray-600">—Å–µ–∫</span>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">–í–æ–ø—Ä–æ—Å:</label>
                        <textarea 
                          value={widgetDevelopmentSettings.followUpQuestion}
                          onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, followUpQuestion: e.target.value})}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                          rows="3"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã:</label>
                        <div className="space-y-2">
                          {widgetDevelopmentSettings.followUpQuickReply && (
                            <div className="flex gap-2">
                              <input 
                                type="text" 
                                value={widgetDevelopmentSettings.followUpQuickReply}
                                onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, followUpQuickReply: e.target.value})}
                                className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                                placeholder="–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç"
                              />
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö */}
                <div>
                  <label className="block text-sm font-medium mb-2">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</label>
                  <input 
                    type="url" 
                    value={widgetDevelopmentSettings.privacyPolicyUrl}
                    onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, privacyPolicyUrl: e.target.value})}
                    className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="https://example.com/privacy"
                  />
                </div>

                {/* –ö–∞–∫–∏–µ –º–µ—Ç–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ö–∞–∫–∏–µ –º–µ—Ç–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å</label>
                  <div className="grid grid-cols-2 gap-2">
                    {[
                      'utm_source',
                      'utm_medium', 
                      'utm_campaign',
                      'utm_term',
                      'utm_content',
                      'roistat_visit',
                      'gclid',
                      'fbclid'
                    ].map(tag => (
                      <button
                        key={tag}
                        onClick={() => {
                          const current = widgetDevelopmentSettings.dataTags || [];
                          const newTags = current.includes(tag)
                            ? current.filter(t => t !== tag)
                            : [...current, tag];
                          setWidgetSettings({...widgetDevelopmentSettings, dataTags: newTags});
                        }}
                        className={`p-2 rounded-lg border-2 transition-all text-sm ${
                          (widgetDevelopmentSettings.dataTags || []).includes(tag)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {tag}
                      </button>
                    ))}
                  </div>
                  <div className="mt-3">
                    <button 
                      onClick={() => {
                        const newTag = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏:');
                        if (newTag && !widgetDevelopmentSettings.dataTags.includes(newTag)) {
                          const newTags = [...widgetDevelopmentSettings.dataTags, newTag];
                          setWidgetSettings({...widgetDevelopmentSettings, dataTags: newTags});
                        }
                      }}
                      className="text-blue-600 hover:text-blue-700 text-sm"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É
                    </button>
                  </div>
                </div>

                {/* –ü—Ä–µ–≤—å—é –≤–∏–¥–∂–µ—Ç–∞ */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ü—Ä–µ–≤—å—é –≤–∏–¥–∂–µ—Ç–∞</label>
                  <div className="border rounded-lg shadow-inner h-[400px] overflow-hidden relative bg-gray-50">
                    <div className="absolute bottom-4 right-4">
                      {widgetDevelopmentSettings.buttonColor === 'ellipse' ? (
                        <div 
                          className="w-12 h-12 rounded-[90px] flex items-center justify-center cursor-pointer shadow-lg"
                          style={{ 
                            backgroundColor: widgetDevelopmentSettings.buttonColor === 'custom' ? widgetDevelopmentSettings.customButtonColor : 
                                         widgetDevelopmentSettings.buttonColor === 'dark' ? '#1f2937' : '#3b82f6'
                          }}
                        >
                          <span className="text-white text-lg">üí¨</span>
                        </div>
                      ) : (
                        <div 
                          className="px-4 py-2 rounded-lg flex items-center gap-2 cursor-pointer shadow-lg"
                          style={{ 
                            backgroundColor: widgetDevelopmentSettings.buttonColor === 'custom' ? widgetDevelopmentSettings.customButtonColor : 
                                         widgetDevelopmentSettings.buttonColor === 'dark' ? '#1f2937' : '#3b82f6'
                          }}
                        >
                          <div 
                            className="w-4 h-4 rounded-[90px] opacity-80"
                            style={{ backgroundColor: widgetDevelopmentSettings.accentColor }}
                          ></div>
                          <span className="text-white text-sm font-medium">
                            {widgetDevelopmentSettings.buttonText || '–°–ø—Ä–æ—Å–∏—Ç—å –ò–ò'}
                          </span>
                        </div>
                      )}
                    </div>
                    
                    {/* –ò–º–∏—Ç–∞—Ü–∏—è —á–∞—Ç–∞ */}
                    <div className="absolute bottom-20 right-4 w-80 h-64 bg-white rounded-lg shadow-lg border">
                      <div className="p-3 border-b bg-gray-50 rounded-t-lg">
                        <div className="flex items-center gap-2">
                          {widgetDevelopmentSettings.logoUrl ? (
                            <img src={widgetDevelopmentSettings.logoUrl} alt="Logo" className="w-6 h-6 rounded" />
                          ) : (
                            <div className="w-6 h-6 bg-blue-600 rounded flex items-center justify-center">
                              <span className="text-white text-xs">A</span>
                            </div>
                          )}
                          <span className="text-sm font-medium">
                            {widgetDevelopmentSettings.logoName || 'Adapto'}
                          </span>
                        </div>
                      </div>
                      <div className="p-3 space-y-2">
                        {widgetDevelopmentSettings.welcomeMessages?.slice(0, 2).map((message, index) => (
                          <div key={index} className="text-sm text-gray-700">
                            {message || `–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ${index + 1}`}
                          </div>
                        ))}
                        {widgetDevelopmentSettings.suggestions?.slice(0, 2).map((suggestion, index) => (
                          <div key={index} className="mt-2">
                            <button className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">
                              {suggestion || `–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ${index + 1}`}
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>

                {/* –ö–æ–¥ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ö–æ–¥ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –Ω–∞ —Å–∞–π—Ç</label>
                  <div className="bg-gray-900 text-white p-4 rounded-lg font-mono text-sm overflow-x-auto">
                    <pre>{generateWidgetCode()}</pre>
                  </div>
                  <div className="mt-3 flex items-center gap-2">
                    <button 
                      onClick={() => {
                        navigator.clipboard.writeText(generateWidgetCode());
                        showNotificationMessage('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
                      }}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors"
                    >
                      –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
                    </button>
                    <button 
                      onClick={openWidgetPreview}
                      className="bg-gray-100 text-gray-900 px-4 py-2 rounded-lg text-sm hover:bg-gray-200 transition-colors border border-gray-300"
                    >
                      –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );

      case 'messengers':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center mb-[16px]">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã</h1>
            </div>
            
            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
            <div className="h-px bg-[#E5E7EB] mb-4" style={{ marginLeft: '-32px', marginRight: '-32px', marginTop: '0px' }}></div>

            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
              {/* Telegram */}
              <div className="bg-white rounded-[16px] p-[16px]">
                <div className="flex flex-col">
                  <div className="flex-shrink-0 mb-3">
                    <img src="/tg.png" alt="Telegram" className="w-[24px] h-[24px]" />
                  </div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">Telegram</h3>
                  <p className="text-[13px] text-[#8E8E93]">
                    {telegramBotConnected ? '–ò–ò-–±–æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Telegram' : '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –ò–ò-–±–æ—Ç–∞ –∫ Telegram'}
                  </p>
                  {telegramBotConnected ? (
                    <div className="mt-[20px] space-y-2">
                      <button className="w-full h-[34px] text-[13px] bg-[#6B7280] text-white rounded-[10px] cursor-default" style={BUTTON_STYLES.blueButton}>
                        –ü–æ–¥–∫–ª—é—á–µ–Ω–æ
                      </button>
                      {telegramBotStats && (
                        <div className="text-[11px] text-[#8E8E93] text-center">
                          –î–∏–∞–ª–æ–≥–æ–≤: {telegramBotStats.total} | –°–µ–≥–æ–¥–Ω—è: {telegramBotStats.today}
                        </div>
                      )}
                    </div>
                  ) : (
                    <button 
                      onClick={() => setShowTelegramModal(true)}
                      className="w-full h-[34px] mt-[20px] text-[13px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6]"
                      style={BUTTON_STYLES.blueButton}
                    >
                      –ü–æ–¥–∫–ª—é—á–∏—Ç—å
                    </button>
                  )}
                </div>
              </div>

              {/* WhatsApp */}
              <div className="bg-white rounded-[16px] p-[16px]">
                <div className="flex flex-col">
                  <div className="flex-shrink-0 mb-3">
                    <img src="/wa.png" alt="WhatsApp" className="w-[24px] h-[24px]" />
                  </div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">WhatsApp</h3>
                  <p className="text-[13px] text-[#8E8E93]">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –ò–ò-–±–æ—Ç–∞ –∫ WhatsApp</p>
                  <button className="w-full h-[34px] mt-[20px] text-[13px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6]" style={BUTTON_STYLES.blueButton}>–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                </div>
              </div>

              {/* VK */}
              <div className="bg-white rounded-[16px] p-[16px]">
                <div className="flex flex-col">
                  <div className="flex-shrink-0 mb-3">
                    <img src="/vk.png" alt="VK" className="w-[24px] h-[24px]" />
                  </div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">–í–∫–æ–Ω—Ç–∞–∫—Ç–µ</h3>
                  <p className="text-[13px] text-[#8E8E93]">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –ò–ò-–±–æ—Ç–∞ –∫ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ</p>
                  <button className="w-full h-[34px] mt-[20px] text-[13px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6]" style={BUTTON_STYLES.blueButton}>–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                </div>
              </div>

              {/* Instagram */}
              <div className="bg-white rounded-[16px] p-[16px]">
                <div className="flex flex-col">
                  <div className="flex-shrink-0 mb-3">
                    <img src="/ig.png" alt="Instagram" className="w-[24px] h-[24px]" />
                  </div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">Instagram*</h3>
                  <p className="text-[13px] text-[#8E8E93]">–í–Ω–µ–¥—Ä–∏—Ç–µ –ò–ò-–±–æ—Ç–∞ –ø—Ä—è–º–æ –≤ –î–∏—Ä–µ–∫—Ç</p>
                  <button className="w-full h-[34px] mt-[20px] text-[13px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6]" style={BUTTON_STYLES.blueButton}>–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                </div>
              </div>
            </div>
            
            {/* –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ–± Instagram */}
            <div className="mt-8 text-center">
              <p className="text-[12px] text-[#8E8E93]">
                *Instagram —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–º Meta ‚Äì –ø—Ä–∏–∑–Ω–∞–Ω–Ω–æ–π –≤ –†–§ —ç–∫—Å—Ç—Ä–µ–º–∏—Å—Ç–∫–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π
              </p>
            </div>
          </div>
        );

      case 'crm-systems':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center mb-[16px]">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">CRM-—Å–∏—Å—Ç–µ–º—ã</h1>
            </div>
            
            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
            <div className="h-px bg-[#E5E7EB] mb-4" style={{ marginLeft: '-32px', marginRight: '-32px', marginTop: '0px' }}></div>

            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
              {/* –ë–∏—Ç—Ä–∏–∫—Å24 */}
              <div className="bg-white rounded-[16px] p-[16px]">
                <div className="flex flex-col">
                  <div className="flex-shrink-0 mb-3">
                    <img src="/bitrix.png" alt="–ë–∏—Ç—Ä–∏–∫—Å24" className="w-[55px] h-[24px]" />
                  </div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">–ë–∏—Ç—Ä–∏–∫—Å24</h3>
                  <p className="text-[13px] text-[#8E8E93]">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ë–∏—Ç—Ä–∏–∫—Å24</p>
                  <button className="w-full h-[34px] mt-[20px] text-[13px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6]" style={BUTTON_STYLES.blueButton}>–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                </div>
              </div>

              {/* AmoCRM */}
              <div className="bg-white rounded-[16px] p-[16px]">
                <div className="flex flex-col">
                  <div className="flex-shrink-0 mb-3">
                    <img src="/amo.png" alt="AmoCRM" className="w-[39px] h-[24px]" />
                  </div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">amoCRM</h3>
                  <p className="text-[13px] text-[#8E8E93]">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å amoCRM</p>
                  <button className="w-full h-[34px] mt-[20px] text-[13px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6]" style={BUTTON_STYLES.blueButton}>–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                </div>
              </div>
            </div>
          </div>
        );

      case 'other-integrations':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center mb-[16px]">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">–°–µ—Ä–≤–∏—Å—ã</h1>
            </div>
            
            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
            <div className="h-px bg-[#E5E7EB] mb-4" style={{ marginLeft: '-32px', marginRight: '-32px', marginTop: '0px' }}></div>

            <div className="grid grid-cols-2 lg:grid-cols-4 gap-[20px]">
              {/* Uclients */}
              <div className="bg-white rounded-[16px] p-[16px]">
                <div className="flex flex-col">
                  <div className="flex-shrink-0 mb-3">
                    <img src="/yc.png" alt="Yclients" className="w-[24px] h-[24px]" />
                  </div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">Yclients</h3>
                  <p className="text-[13px] text-[#8E8E93]">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yclients</p>
                  <button className="w-full h-[34px] mt-[20px] text-[13px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6]" style={BUTTON_STYLES.blueButton}>–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                </div>
              </div>
            </div>
          </div>
        );



      case 'profile':
        return (
          <div className="space-y-6">
            <div className="bg-[#F8F8FA] min-h-[600px] h-full relative">
              <div className="flex h-full">
                {/* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ */}
                <div className="w-64 space-y-4 pr-4">
                  <div>
                    <h1 className="text-[20px] font-[500] text-[#070F1A]" style={{ marginBottom: '16px' }}>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h1>
                    
                    {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
                    <div className="h-px bg-[#E5E7EB] mb-4" style={{ marginLeft: '-32px', marginRight: '-22px' }}></div>
                    
                    <div className="space-y-2">
                  <button
                    onClick={() => setProfileTab('personal')}
                    className={`w-full h-[34px] flex items-center gap-3 px-3 rounded-[10px] text-left transition-colors ${
                      profileTab === 'personal' 
                        ? 'bg-white text-[#0084FF]' 
                        : 'text-[#8E8E93] hover:bg-white hover:text-[#0084FF]'
                    }`}
                  >
                    <img 
                      src="/Icon%20pers.svg" 
                      alt="–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç" 
                      className="w-4 h-4" 
                      style={{ 
                        filter: profileTab === 'personal'
                          ? 'brightness(0) saturate(100%) invert(27%) sepia(96%) saturate(1456%) hue-rotate(204deg) brightness(101%) contrast(101%)'
                          : 'brightness(0) saturate(100%) invert(56%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%)'
                      }} 
                    />
                    <span className="text-[13px] font-[500]">–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</span>
                  </button>
                  
                  
                  {!isOperator && (
                    <button
                      onClick={() => setProfileTab('subscription')}
                      className={`w-full h-[34px] flex items-center gap-3 px-3 rounded-[10px] text-left transition-colors ${
                        profileTab === 'subscription' 
                          ? 'bg-white text-[#0084FF]' 
                          : 'text-[#8E8E93] hover:bg-white hover:text-[#0084FF]'
                      }`}
                    >
                      <img 
                        src="/Icon%20pers-1.svg" 
                        alt="–û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã" 
                        className="w-4 h-4" 
                        style={{ 
                          filter: profileTab === 'subscription'
                            ? 'brightness(0) saturate(100%) invert(27%) sepia(96%) saturate(1456%) hue-rotate(204deg) brightness(101%) contrast(101%)'
                            : 'brightness(0) saturate(100%) invert(56%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%)'
                        }} 
                      />
                      <span className="text-[13px] font-[500]">–û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã</span>
                    </button>
                  )}
                  
                  {!isOperator && (
                    <button
                      onClick={() => setProfileTab('notifications')}
                      className={`w-full h-[34px] flex items-center gap-3 px-3 rounded-[10px] text-left transition-colors ${
                        profileTab === 'notifications' 
                          ? 'bg-white text-[#0084FF]' 
                          : 'text-[#8E8E93] hover:bg-white hover:text-[#0084FF]'
                      }`}
                    >
                      <img 
                        src="/Icon%20notific.svg" 
                        alt="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" 
                        className="w-4 h-4" 
                        style={{ 
                          filter: profileTab === 'notifications'
                            ? 'brightness(0) saturate(100%) invert(27%) sepia(96%) saturate(1456%) hue-rotate(204deg) brightness(101%) contrast(101%)'
                            : 'brightness(0) saturate(100%) invert(56%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%)'
                        }} 
                      />
                      <span className="text-[13px] font-[500]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                    </button>
                  )}
                  
                  <button
                    onClick={() => setProfileTab('theme')}
                    className={`w-full h-[34px] flex items-center gap-3 px-3 rounded-[10px] text-left transition-colors ${
                      profileTab === 'theme' 
                        ? 'bg-white text-[#0084FF]' 
                        : 'text-[#8E8E93] hover:bg-white hover:text-[#0084FF]'
                    }`}
                  >
                    <img 
                      src="/Icon%20tema.svg" 
                      alt="–¢–µ–º–∞" 
                      className="w-4 h-4" 
                      style={{ 
                        filter: profileTab === 'theme'
                          ? 'brightness(0) saturate(100%) invert(27%) sepia(96%) saturate(1456%) hue-rotate(204deg) brightness(101%) contrast(101%)'
                          : 'brightness(0) saturate(100%) invert(56%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%)'
                      }} 
                    />
                    <span className="text-[13px] font-[500]">–¢–µ–º–∞</span>
                  </button>
                    </div>
                  </div>
                </div>

                {/* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */}
                <div className="w-px bg-[#E5E6E7] absolute left-64" style={{ top: '-24px', bottom: '-24px' }}></div>

                {/* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º */}
                <div className="flex-1 pl-5">
                  {/* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */}
                  <div className="mb-[16px]">
                    <h1 className="text-[20px] font-[500] text-[#070F1A]" style={{ marginBottom: '16px' }}>
                      {profileTab === 'personal' && '–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç'}
                      {profileTab === 'subscription' && '–û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã'}
                      {profileTab === 'notifications' && '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'}
                      {profileTab === 'theme' && '–¢–µ–º–∞'}
                    </h1>
                    
                    {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
                    <div className="h-px bg-[#E5E7EB] mb-4" style={{ marginLeft: '-32px', marginRight: '-22px' }}></div>
                  </div>
                  {profileTab === 'personal' && (
                    <div className="space-y-6">
                      <div className="flex items-center gap-4 mb-6">
                        <div className="w-16 h-16 rounded-[90px] flex items-center justify-center" style={{ backgroundColor: generateAvatar(currentUser?.name).color }}>
                          <span className="text-white font-semibold text-xl">{generateAvatar(currentUser?.name).letter}</span>
                        </div>
                        <div>
                          <h2 className="text-[18px] font-medium text-[#070F1A]">{currentUser?.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</h2>
                          <p className="text-[14px] text-[#8E8E93]">{currentUser?.company_name || '–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        </div>
                      </div>
                      
                      <div className="space-y-4">
                        <div>
                          <label className="block text-[14px] font-medium text-[#8E8E93] mb-2">–ò–º—è</label>
                          <input
                            type="text"
                            value={personalInfo.name}
                            onChange={(e) => setPersonalInfo({...personalInfo, name: e.target.value})}
                            className="w-full h-[34px] px-4 rounded-[10px] focus:outline-none"
                            style={INPUT_STYLES.inputField}
                          />
                        </div>
                        
                        <div>
                          <label className="block text-[14px] font-medium text-[#8E8E93] mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
                          <input
                            type="text"
                            value={personalInfo.company}
                            onChange={(e) => setPersonalInfo({...personalInfo, company: e.target.value})}
                            className="w-full h-[34px] px-4 rounded-[10px] focus:outline-none"
                            style={INPUT_STYLES.inputField}
                          />
                        </div>
                        
                        <div>
                          <label className="block text-[14px] font-medium text-[#8E8E93] mb-2">Email</label>
                          <input
                            type="email"
                            value={personalInfo.email}
                            onChange={(e) => setPersonalInfo({...personalInfo, email: e.target.value})}
                            className="w-full h-[34px] px-4 rounded-[10px] focus:outline-none"
                            style={INPUT_STYLES.inputField}
                          />
                        </div>
                        
                        <div>
                          <label className="block text-[14px] font-medium text-[#8E8E93] mb-2">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                          <input
                            type="tel"
                            value={personalInfo.phone}
                            onChange={(e) => setPersonalInfo({...personalInfo, phone: e.target.value})}
                            className="w-full h-[34px] px-4 rounded-[10px] focus:outline-none"
                            style={INPUT_STYLES.inputField}
                          />
                        </div>

                        <div>
                          <label className="block text-[14px] font-medium text-[#8E8E93] mb-2">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                          <input
                            type="password"
                            value={personalInfo.newPassword}
                            onChange={(e) => setPersonalInfo({...personalInfo, newPassword: e.target.value})}
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
                            className="w-full h-[34px] px-4 rounded-[10px] focus:outline-none"
                            style={INPUT_STYLES.inputField}
                          />
                        </div>
                        
                        <div>
                          <label className="block text-[14px] font-medium text-[#8E8E93] mb-2">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                          <input
                            type="password"
                            value={personalInfo.confirmPassword}
                            onChange={(e) => setPersonalInfo({...personalInfo, confirmPassword: e.target.value})}
                            placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
                            className="w-full h-[34px] px-4 rounded-[10px] focus:outline-none"
                            style={INPUT_STYLES.inputField}
                          />
                        </div>
                      </div>
                      
                      <div className="w-full">
                        <button 
                          onClick={handleSavePersonalInfo}
                          disabled={!hasPersonalChanges()}
                          className={`w-full h-[34px] rounded-[10px] transition-colors text-[13px] ${
                            hasPersonalChanges() 
                              ? 'bg-[#0084FF] text-white hover:bg-[#0073E6]' 
                              : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                          }`}
                          style={hasPersonalChanges() ? BUTTON_STYLES.blueButton : BUTTON_STYLES.whiteButton}
                        >
                          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                      </div>
                      
                    </div>
                  )}

                  {profileTab === 'invite' && (
                    <div className="space-y-6">
                      {!isOperator && (
                        <div className="bg-white rounded-[16px] p-5">
                          <h3 className="text-[18px] font-medium text-[#070F1A] mb-4">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –∫–æ–ª–ª–µ–≥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º</h3>
                          
                          <div className="space-y-4">
                            <div>
                              <label className="block text-[14px] font-medium text-[#8E8E93] mb-2">Email —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
                              <div className="flex gap-3">
                                <input
                                  type="email"
                                  placeholder="example@company.com"
                                  className="flex-1 h-[34px] px-4 rounded-[10px] focus:outline-none"
                                  style={INPUT_STYLES.inputField}
                                />
                                <button 
                                  className="h-[34px] px-6 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                                  style={BUTTON_STYLES.blueButton}
                                >
                                  –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      <div className="p-0">
                        <h3 className="text-[18px] font-medium text-[#070F1A] mb-4">–¢–µ–∫—É—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                        <div className="space-y-3">
                          {/* –í–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ–µ–∫—Ç–∞ */}
                          <div className="flex items-center justify-between p-3 bg-white rounded-[16px]">
                            <div className="flex items-center gap-3">
                              <div className="w-8 h-8 rounded-[90px] bg-[#0084FF] flex items-center justify-center">
                                <span className="text-white text-sm font-medium">{generateAvatar(currentUser?.name).letter}</span>
                              </div>
                              <div>
                                <p className="text-[14px] font-[500] text-[#070F1A]">{currentUser?.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</p>
                                <p className="text-[12px] text-[#8E8E93]">{currentUser?.email || 'vibe@mail.ru'}</p>
                              </div>
                            </div>
                            <span className="text-[12px] bg-[#10B981]/10 text-[#10B981] px-2 py-1 rounded-[6px] font-[500]">
                              –í–ª–∞–¥–µ–ª–µ—Ü
                            </span>
                          </div>

                        </div>
                      </div>
                    </div>
                  )}

                  {profileTab === 'subscription' && !isOperator && (
                    <div className="space-y-6">
                      {/* –¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ */}
                      <div className="bg-white rounded-[16px] p-6">
                        <p className="text-[12px] text-[#8E8E93] mb-2">–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ</p>
                        <h3 className="text-[18px] font-medium text-[#070F1A] mb-4">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π</h3>
                        
                        <div className="space-y-4">
                          <div>
                            <div className="flex justify-between items-center mb-2">
                              <div className="flex items-center gap-2">
                                <img src="/clock.svg" alt="Clock" className="w-3 h-3" />
                                <span className="text-[12px] text-[#8E8E93]">–î–Ω–∏</span>
                              </div>
                              <span className="text-[12px] font-medium text-[#070F1A]">
                                3 / 3
                            </span>
                            </div>
                          </div>
                          
                          <div>
                            <div className="flex justify-between items-center mb-2">
                              <div className="flex items-center gap-2">
                                <img src="/Vector09.svg" alt="Tokens" className="w-3 h-3" />
                              <span className="text-[12px] text-[#8E8E93]">–¢–æ–∫–µ–Ω—ã</span>
                              </div>
                              <span className="text-[12px] font-medium text-[#070F1A]">
                                50000 / 50000
                              </span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-[90px] h-[3px]">
                              <div 
                                className="bg-[#0084FF] h-[3px] rounded-[90px] transition-all duration-300"
                                style={{ 
                                  width: `100%` 
                                }}
                              ></div>
                            </div>
                          </div>
                            </div>
                          </div>
                          
                      {/* –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π */}
                      <div className="bg-white rounded-[16px] p-6">
                        <p className="text-[14px] text-[#8E8E93] mb-4">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–±—ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥ –≤–∞—à—É –∫–æ–º–ø–∞–Ω–∏—é</p>
                        <h2 className="text-[18px] font-medium text-[#070F1A] mb-6">
                          –ú–Ω–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å {messageCount.toLocaleString()} —Å–æ–æ–±—â–µ–Ω–∏–π ‚âà {Math.round(messageCount / 5)} –¥–∏–∞–ª–æ–≥–æ–≤ –µ–∂–µ–º–µ—Å—è—á–Ω–æ
                        </h2>
                        
                        <div className="w-full relative">
                          <input 
                            type="range" 
                            min="500" 
                            max="25000" 
                            step="500" 
                            value={messageCount}
                            onChange={(e) => setMessageCount(parseInt(e.target.value))}
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer relative z-10"
                            style={{
                              background: `linear-gradient(to right, #0084FF 0%, #0084FF ${((messageCount - 500) / (25000 - 500)) * 100}%, #E5E7EB ${((messageCount - 500) / (25000 - 500)) * 100}%, #E5E7EB 100%)`
                            }}
                          />
                          {/* –û—Ç–º–µ—Ç–∫–∏ –Ω–∞ —Å–ª–∞–π–¥–µ—Ä–µ */}
                          <div className="absolute top-0 left-0 w-full h-2 pointer-events-none">
                            <div className="absolute top-0 left-0 w-px h-2 bg-gray-400"></div>
                            <div className="absolute top-0 left-[20%] w-px h-2 bg-gray-400"></div>
                            <div className="absolute top-0 left-[40%] w-px h-2 bg-gray-400"></div>
                            <div className="absolute top-0 left-[60%] w-px h-2 bg-gray-400"></div>
                            <div className="absolute top-0 left-[80%] w-px h-2 bg-gray-400"></div>
                            <div className="absolute top-0 right-0 w-px h-2 bg-gray-400"></div>
                          </div>
                          <div className="flex justify-between text-xs text-gray-500 mt-2">
                            <span>500</span>
                            <span>5000</span>
                            <span>10000</span>
                            <span>15000</span>
                            <span>20000</span>
                            <span>25000</span>
                          </div>
                        </div>
                      </div>
                      
                      {/* –¢–∞–±—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –æ–ø–ª–∞—Ç—ã */}
                      <div className="flex justify-center">
                        <div className="flex justify-center gap-2 bg-white border w-fit mx-auto p-1.5 rounded-full">
                          <button
                            onClick={() => setPaymentPeriod('monthly')}
                            className={`px-4 relative py-1 rounded-full duration-100 transition font-medium text-sm ${
                              paymentPeriod === 'monthly'
                                ? 'bg-emerald-500 text-white'
                                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                            }`}
                          >
                            1 –º–µ—Å—è—Ü
                          </button>
                          <button
                            onClick={() => setPaymentPeriod('quarterly')}
                            className={`px-4 relative py-1 rounded-full duration-100 transition font-medium text-sm ${
                              paymentPeriod === 'quarterly'
                                ? 'bg-emerald-500 text-white'
                                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                            }`}
                          >
                            3 –º–µ—Å—è—Ü–∞
                            <div className="!absolute truncate text-xs bg-primary text-white rounded-full px-2 py-0.5 -top-3.5 -right-2">15% —Å–∫–∏–¥–∫–∞</div>
                          </button>
                        </div>
                      </div>
                      
                      {/* –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã */}
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-stretch">
                        {/* –°—Ç–∞—Ä—Ç */}
                        <div className="bg-white rounded-[16px] p-6 flex flex-col">
                          <div className="flex items-center justify-between mb-4">
                            <h4 className="text-[18px] font-medium text-[#070F1A]">–°—Ç–∞—Ä—Ç</h4>
                            <div className="text-right">
                              <span className="text-[24px] font-medium text-[#070F1A]">{calculatePrice("–°—Ç–∞—Ä—Ç", messageCount, paymentPeriod).toLocaleString()}</span>
                              <span className="text-[14px] font-medium text-[#070F1A]"> ‚ÇΩ/–º–µ—Å</span>
                            </div>
                          </div>
                          <div className="space-y-2 text-[14px] text-[#8E8E93] flex-grow">
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ö–∞–Ω–∞–ª—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π: 1 –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä + –≤–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: –¥–æ 50 –ú–ë</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ú–µ—Ç—Ä–∏–∫–∏: —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ö–æ–º–∞–Ω–¥–∞: 1 –∞–∫–∫–∞—É–Ω—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è: AdaptoGPT</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                            </div>
                          </div>
                          <button className="w-full mt-6 h-[34px] bg-[#0084FF] text-white rounded-[10px] text-[14px] font-[500] hover:bg-[#0073E6] transition-colors">
                            –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ
                          </button>
                        </div>

                        {/* –ü—Ä–æ */}
                        <div className="bg-white rounded-[16px] p-6 flex flex-col">
                          <div className="flex items-center justify-between mb-4">
                            <h4 className="text-[18px] font-medium text-[#070F1A]">–ü—Ä–æ</h4>
                            <div className="text-right">
                              <span className="text-[24px] font-medium text-[#070F1A]">{calculatePrice("–ü—Ä–æ", messageCount, paymentPeriod).toLocaleString()}</span>
                              <span className="text-[14px] font-medium text-[#070F1A]"> ‚ÇΩ/–º–µ—Å</span>
                            </div>
                          </div>
                          <div className="space-y-2 text-[14px] text-[#8E8E93] flex-grow">
                            <div className="text-[16px] font-medium text-[#070F1A] mb-2">–í—Å–µ, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —Ç–∞—Ä–∏—Ñ "–°—Ç–∞—Ä—Ç" +</div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ö–∞–Ω–∞–ª—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π: –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ (–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã + –≤–∏–¥–∂–µ—Ç)</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: –¥–æ 200 –ú–ë</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>CRM-—Å–∏—Å—Ç–µ–º–∞ –æ—Ç Adapto –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä. CRM</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ú–µ—Ç—Ä–∏–∫–∏: —É–≥–ª—É–±–ª–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ö–æ–º–∞–Ω–¥–∞: –¥–æ 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–†–∞—Å—à–∏—Ä–µ–Ω–∏—è: –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</span>
                            </div>
                          </div>
                          <button className="w-full mt-6 h-[34px] bg-[#0084FF] text-white rounded-[10px] text-[14px] font-[500] hover:bg-[#0073E6] transition-colors">
                            –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ
                          </button>
                        </div>

                        {/* –ë–∏–∑–Ω–µ—Å */}
                        <div className="bg-white rounded-[16px] p-6 flex flex-col">
                          <div className="flex items-center justify-between mb-4">
                            <h4 className="text-[18px] font-medium text-[#070F1A]">–ë–∏–∑–Ω–µ—Å</h4>
                            <div className="text-right">
                              <span className="text-[24px] font-medium text-[#070F1A]">{calculatePrice("–ë–∏–∑–Ω–µ—Å", messageCount, paymentPeriod).toLocaleString()}</span>
                              <span className="text-[14px] font-medium text-[#070F1A]"> ‚ÇΩ/–º–µ—Å</span>
                            </div>
                          </div>
                          <div className="space-y-2 text-[14px] text-[#8E8E93] flex-grow">
                            <div className="text-[16px] font-medium text-[#070F1A] mb-2">–í—Å–µ, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —Ç–∞—Ä–∏—Ñ "–ü—Ä–æ" +</div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ö–æ–º–∞–Ω–¥–∞: –¥–æ 20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ–¥ –ø—Ä–æ–µ–∫—Ç</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –Ω–æ–≤—ã–º –≤–µ—Ä—Å–∏—è–º</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <img src="./Checkbox.svg" alt="‚úì" className="w-4 h-4" />
                              <span>White-label –≤–∏–¥–∂–µ—Ç–∞</span>
                            </div>
                          </div>
                          <button 
                            className="w-full mt-6 h-[34px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                            style={BUTTON_STYLES.blueButton}
                          >
                            –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {profileTab === 'notifications' && !isOperator && (
                    <div className="space-y-6">
                      {/* –ü–ª–∞—à–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Telegram –±–æ—Ç–∞ */}
                      <div className="border border-[#070F1A]/10 rounded-[16px] p-5">
                        <div className="flex items-center gap-2 mb-2">
                          <h3 className="text-[18px] font-medium text-[#070F1A]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤</h3>
                          <div className="flex items-center gap-1">
                            <span className="text-[18px] font-medium text-[#070F1A]">Telegram</span>
                          <img 
                            src="/tg.png" 
                            alt="Telegram" 
                            className="w-[15px] h-[13px]"
                          />
                          </div>
                        </div>
                        <p className="text-[14px] text-[#8E8E93] mb-6">
                          –ü–æ–ª—É—á–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö –æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —á–∞—Ç–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ —Ç–¥. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –±—ã—Ç—å –Ω–∞ —Å–≤—è–∑–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ –∏ –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞—Ö –¥–∏–∞–ª–æ–≥–æ–≤ —á–µ–ª–æ–≤–µ–∫–æ–º!
                        </p>
                        
                        <div className="mt-[30px]">
                          <p className="text-[14px] font-[500] text-[#070F1A] mb-4">
                            –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://t.me/Adapto_notifications_bot" target="_blank" rel="noopener noreferrer" className="text-[#0084FF] hover:underline">–Ω–∞—à Telegram-–±–æ—Ç</a> –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <span className="text-[#0084FF]">/start</span>.
                            <br />
                            –ü–æ—Å–ª–µ —á–µ–≥–æ –±–æ—Ç –≤—ã—à–ª–µ—Ç API –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ –Ω–∏–∂–µ
                          </p>
                          
                          <div className="flex gap-[10px]">
                            <input
                              type="text"
                              placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –∏–∑ @Adapto_notifications_bot"
                              value={telegramApiKey}
                              onChange={(e) => setTelegramApiKey(e.target.value)}
                              className="flex-1 h-[34px] px-4 border border-[#E5E7EB] rounded-[10px] text-[13px] font-[400] focus:outline-none focus:border-[#0084FF]"
                              style={INPUT_STYLES.inputField}
                            />
                            <button 
                              onClick={handleConnectTelegram}
                              disabled={isConnectingTelegram}
                              className="h-[34px] px-6 bg-[#0084FF] text-white rounded-[10px] text-[13px] font-[500] hover:bg-[#0073E6] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                              style={BUTTON_STYLES.blueButton}
                            >
                              {isConnectingTelegram ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å'}
                            </button>
                          </div>
                          
                        </div>
                      </div>

                      {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */}
                      <div className="border border-[#070F1A]/10 rounded-[16px] p-5">
                        <h3 className="text-[18px] font-medium text-[#070F1A] mb-4">–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>

                      <div className="space-y-4">
                          <div className="flex items-center justify-between p-3 bg-white rounded-[12px]">
                          <div>
                              <p className="text-[14px] font-[500] text-[#070F1A]">–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö</p>
                              <p className="text-[12px] text-[#8E8E93]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
                          </div>
                            <img 
                              src={telegramSettings?.notification_types?.includes('new_messages') ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                              alt="–í–∫–ª—é—á–∏—Ç—å" 
                              className="w-[34px] h-[34px] cursor-pointer hover:opacity-80 transition-opacity" 
                              onClick={() => toggleNotificationType('new_messages')}
                            />
                        </div>
                        
                          <div className="flex items-center justify-between p-3 bg-white rounded-[12px]">
                          <div>
                              <p className="text-[14px] font-[500] text-[#070F1A]">–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º</p>
                              <p className="text-[12px] text-[#8E8E93]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–≥–¥–∞ –¥–∏–∞–ª–æ–≥ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —á–µ–ª–æ–≤–µ–∫</p>
                          </div>
                            <img 
                              src={telegramSettings?.notification_types?.includes('operator_takeover') ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                              alt="–í–∫–ª—é—á–∏—Ç—å" 
                              className="w-[34px] h-[34px] cursor-pointer hover:opacity-80 transition-opacity" 
                              onClick={() => toggleNotificationType('operator_takeover')}
                            />
                        </div>
                        
                          <div className="flex items-center justify-between p-3 bg-white rounded-[12px]">
                          <div>
                              <p className="text-[14px] font-[500] text-[#070F1A]">–°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
                              <p className="text-[12px] text-[#8E8E93]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –∏ –æ—à–∏–±–∫–∞—Ö</p>
                          </div>
                            <img 
                              src={telegramSettings?.notification_types?.includes('system_alerts') ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                              alt="–í–∫–ª—é—á–∏—Ç—å" 
                              className="w-[34px] h-[34px] cursor-pointer hover:opacity-80 transition-opacity" 
                              onClick={() => toggleNotificationType('system_alerts')}
                            />
                        </div>

                          <div className="flex items-center justify-between p-3 bg-white rounded-[12px]">
                            <div>
                              <p className="text-[14px] font-[500] text-[#070F1A]">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã</p>
                              <p className="text-[12px] text-[#8E8E93]">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
                            </div>
                            <img 
                              src={telegramSettings?.notification_types?.includes('daily_reports') ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                              alt="–í–∫–ª—é—á–∏—Ç—å" 
                              className="w-[34px] h-[34px] cursor-pointer hover:opacity-80 transition-opacity" 
                              onClick={() => toggleNotificationType('daily_reports')}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {profileTab === 'theme' && (
                    <div className="space-y-6">
                      <div className="flex gap-[15px]">
                        <div
                          className={`w-[250px] h-[170px] rounded-[16px] border cursor-pointer transition-all ${
                            theme === 'light'
                              ? 'bg-[#DBE9FF] border-[#0084FF]'
                              : 'bg-[#F3F5F7] border-[#070F1A]/10'
                          }`}
                          onClick={() => setTheme('light')}
                        >
                          <div className="h-full flex flex-col">
                            <div className="w-full h-[120px] bg-white rounded-t-[16px] flex items-center justify-center border border-gray-200">
                              <img src="/Group 172.png" alt="–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞" className="w-full h-full object-cover rounded-t-[16px]" />
                            </div>
                            <div className="flex items-center gap-2 pl-[12px] h-[50px]">
                              <img 
                                src={theme === 'light' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                alt="–°–≤–µ—Ç–ª–∞—è" 
                                className="w-4 h-4" 
                              />
                              <span className="text-[14px] font-[500] text-[#070F1A]">–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</span>
                            </div>
                          </div>
                        </div>
                        <div 
                          className={`w-[250px] h-[170px] rounded-[16px] border cursor-pointer transition-all ${
                            theme === 'dark' 
                              ? 'bg-[#DBE9FF] border-[#0084FF]' 
                              : 'bg-[#F3F5F7] border-[#070F1A]/10'
                          }`}
                          onClick={() => setTheme('dark')}
                        >
                          <div className="h-full flex flex-col">
                            <div className="w-full h-[120px] bg-gray-800 rounded-t-[16px] flex items-center justify-center border border-gray-200">
                              <img src="/Group 173.png" alt="–¢–µ–º–Ω–∞—è —Ç–µ–º–∞" className="w-full h-full object-cover rounded-t-[16px]" />
                            </div>
                            <div className="flex items-center gap-2 pl-[12px] h-[50px]">
                              <img 
                                src={theme === 'dark' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                alt="–¢–µ–º–Ω–∞—è" 
                                className="w-4 h-4" 
                              />
                              <span className="text-[14px] font-[500] text-[#070F1A]">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );

      case 'widget-dev':
        return (
          <div className="space-y-0">
            <div className="flex justify-between items-center" style={{ marginBottom: '16px' }}>
              <div>
                <h1 className="text-[20px] font-[500] text-[#070F1A]">–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç</h1>
              </div>
              <div className="flex items-center gap-2">
                <Button 
                  onClick={handleCopyScript}
                  className="h-[34px] px-4 bg-[#0084FF] text-white hover:bg-[#0073E6] rounded-[10px] font-[500] text-[13px] flex items-center gap-2"
                  style={BUTTON_STYLES.blueButton}
                >
                  <img src="/document-copy.svg" alt="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(1)' }} />
                  –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
                </Button>
              </div>
            </div>

            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º */}
            <div className="border-b" style={{ borderColor: '#E5E6E7', marginLeft: '-16px', marginRight: '-16px' }}></div>

            {/* –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –¥–≤—É–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ */}
            <div className="flex h-[calc(100vh-200px)]">
              {/* –õ–µ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ */}
              <div className="flex-[1.2] flex flex-col" style={{ marginTop: '20px' }}>
                {/* –ü–ª–∞—à–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */}
                <div className="space-y-[10px] flex-1">
                  {/* –ü–ª–∞—à–∫–∞ 1: –†–∞–∑–¥–µ–ª—ã –≤–∏–¥–∂–µ—Ç–∞ */}
                  <div className="bg-white rounded-[16px] overflow-hidden">
                    <div 
                      className="p-[20px] h-[76px] flex items-center gap-4 cursor-pointer"
                      onClick={() => setOpenWidgetSections(prev => ({...prev, sections: !prev.sections}))}
                    >
                      <div className="w-[40px] h-[40px] bg-white rounded-[10px] flex items-center justify-center overflow-hidden">
                        <img src="/1231234.png" alt="–†–∞–∑–¥–µ–ª—ã" className="w-full h-full object-contain" />
                      </div>
                      <div className="flex-1">
                        <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">–†–∞–∑–¥–µ–ª—ã –≤–∏–¥–∂–µ—Ç–∞</h3>
                        <p className="text-[12px] text-[#8E8E93]">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —á–µ–≥–æ –±—É–¥–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –≤–∞—à –≤–∏–¥–∂–µ—Ç</p>
                      </div>
                      <div className={`transition-transform duration-300 ${openWidgetSections.sections ? '-rotate-90' : 'rotate-90'}`}>
                        <img src="/Bounds.svg" alt="–†–∞—Å–∫—Ä—ã—Ç—å" className="w-[11px] h-[11px]" style={{ filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }} />
                      </div>
                    </div>
                    {openWidgetSections.sections && (
                      <div className="px-[15px] pb-[15px]">
                        <div className="pt-4">
                          {/* –¢–∞–±—ã */}
                          <div className="border-b border-gray-200 mb-5">
                            <div className="flex">
                              <div className="flex-1 relative">
                                <button
                                  onClick={() => setActiveWidgetTab('main')}
                                  className={`w-full py-3 px-4 text-sm font-medium transition-colors flex items-center justify-center gap-[5px] ${
                                    activeWidgetTab === 'main'
                                      ? 'text-[#0084FF]'
                                      : 'text-[#8E8E93] hover:text-[#070F1A]'
                                  }`}
                                >
                                  <img 
                                    src="/house.svg" 
                                    alt="–ì–ª–∞–≤–Ω–∞—è" 
                                    className="w-[17px] h-[17px]" 
                                    style={{ 
                                      filter: activeWidgetTab === 'main' 
                                        ? 'brightness(0) saturate(100%) invert(27%) sepia(96%) saturate(1456%) hue-rotate(204deg) brightness(101%) contrast(101%)' 
                                        : 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)'
                                    }}
                                  />
                                  <span className="text-[14px]">–ì–ª–∞–≤–Ω–∞—è</span>
                                </button>
                                {activeWidgetTab === 'main' && (
                                  <div className="absolute bottom-0 left-0 right-0 h-[4px] bg-[#0084FF] rounded-t-[4px]"></div>
                                )}
                              </div>
                              <div className="flex-1 relative">
                                <button
                                  onClick={() => setActiveWidgetTab('chat')}
                                  className={`w-full py-3 px-4 text-sm font-medium transition-colors flex items-center justify-center gap-[5px] ${
                                    activeWidgetTab === 'chat'
                                      ? 'text-[#0084FF]'
                                      : 'text-[#8E8E93] hover:text-[#070F1A]'
                                  }`}
                                >
                                  <img 
                                    src="/Frame 147.svg" 
                                    alt="–ß–∞—Ç" 
                                    className="w-[17px] h-[17px]" 
                                    style={{ 
                                      filter: activeWidgetTab === 'chat' 
                                        ? 'brightness(0) saturate(100%) invert(27%) sepia(96%) saturate(1456%) hue-rotate(204deg) brightness(101%) contrast(101%)' 
                                        : 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)'
                                    }}
                                  />
                                  <span className="text-[14px]">–ß–∞—Ç</span>
                                </button>
                                {activeWidgetTab === 'chat' && (
                                  <div className="absolute bottom-0 left-0 right-0 h-[4px] bg-[#0084FF] rounded-t-[4px]"></div>
                                )}
                              </div>
                              <div className="flex-1 relative">
                                <button
                                  onClick={() => setActiveWidgetTab('form')}
                                  className={`w-full py-3 px-4 text-sm font-medium transition-colors flex items-center justify-center gap-[5px] ${
                                    activeWidgetTab === 'form'
                                      ? 'text-[#0084FF]'
                                      : 'text-[#8E8E93] hover:text-[#070F1A]'
                                  }`}
                                >
                                  <img 
                                    src="/clipboard-text.svg" 
                                    alt="–§–æ—Ä–º–∞" 
                                    className="w-[17px] h-[17px]" 
                                    style={{ 
                                      filter: activeWidgetTab === 'form' 
                                        ? 'brightness(0) saturate(100%) invert(27%) sepia(96%) saturate(1456%) hue-rotate(204deg) brightness(101%) contrast(101%)' 
                                        : 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)'
                                    }}
                                  />
                                  <span className="text-[14px]">–§–æ—Ä–º–∞</span>
                                </button>
                                {activeWidgetTab === 'form' && (
                                  <div className="absolute bottom-0 left-0 right-0 h-[4px] bg-[#0084FF] rounded-t-[4px]"></div>
                                )}
                              </div>
                            </div>
                          </div>

                          {/* –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–æ–≤ */}
                          {activeWidgetTab === 'main' && (
                            <div className="space-y-5">
                              {/* 1. –ò–º—è –ò–ò-–∞–≥–µ–Ω—Ç–∞ */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ò–º—è –ò–ò-–∞–≥–µ–Ω—Ç–∞</h4>
                                <div className="flex items-center gap-[15px]">
                                  <input
                                    type="text"
                                    value={aiAgentName}
                                    onChange={(e) => setAiAgentName(e.target.value)}
                                    className="w-[256px] h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  />
                                  <div className="flex items-center gap-2">
                                    <img 
                                      src={!showAILabel ? "/iOS/Switch-1.svg" : "/iOS/Switch.svg"} 
                                      alt="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å" 
                                      className="w-[34px] h-[34px] cursor-pointer" 
                                      onClick={() => setShowAILabel(!showAILabel)}
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ—Ç–∫—É –ò–ò –∞–≥–µ–Ω—Ç–∞</span>
                                  </div>
                                </div>
                              </div>

                              {/* 2. –õ–æ–≥–æ—Ç–∏–ø */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–õ–æ–≥–æ—Ç–∏–ø</h4>
                                <div className="space-y-3">
                                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setLogoType('default')}>
                                    <img 
                                      src={logoType === 'default' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                                  </div>
                                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setLogoType('custom')}>
                                    <img 
                                      src={logoType === 'custom' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π –ª–æ–≥–æ—Ç–∏–ø</span>
                                  </div>
                                  {logoType === 'custom' && (
                                    <div className="flex items-center gap-[10px] cursor-pointer" onClick={() => document.getElementById('logo-upload').click()}>
                                      <div className="w-[40px] h-[40px] bg-white rounded-[10px] flex items-center justify-center overflow-hidden">
                                        {customLogo ? (
                                          <img src={customLogo} alt="–õ–æ–≥–æ—Ç–∏–ø" className="w-full h-full object-contain" />
                                        ) : (
                                        <img src="/Group 125.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" className="w-full h-full object-contain" />
                                        )}
                                      </div>
                                      <div>
                                        {customLogoName ? (
                                          <>
                                            <p className="text-[14px] text-[#070F1A] font-[500]">–ó–∞–≥—Ä—É–∂–µ–Ω: {customLogoName}</p>
                                            <p className="text-[9px] text-[#8E8E93]">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</p>
                                          </>
                                        ) : (
                                          <>
                                        <p className="text-[14px] text-[#8E8E93] font-[500]">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</p>
                                        <p className="text-[9px] text-[#8E8E93]">–£–≥–ª—ã –≤–∞—à–µ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞ –±—É–¥—É—Ç –∑–∞–∫—Ä—É–≥–ª–µ–Ω—ã, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ª–æ–≥–æ—Ç–∏–ø —Å —á–µ—Ç–∫–∏–º–∏ —É–≥–ª–∞–º–∏.</p>
                                          </>
                                        )}
                                      </div>
                                      <input 
                                        type="file" 
                                        id="logo-upload" 
                                        className="hidden" 
                                        accept="image/*" 
                                        onChange={handleLogoUpload}
                                      />
                                    </div>
                                  )}
                                </div>
                              </div>

                              {/* 3. –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h4>
                                <textarea
                                  value={widgetTitle}
                                  onChange={(e) => setWidgetTitle(e.target.value)}
                                  className="w-full h-[80px] px-3 py-2 border border-[#070F1A]/10 rounded-[10px] text-[13px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20 resize-none"
                                  style={INPUT_STYLES.inputField}
                                />
                              </div>

                              {/* 4. –û–ø–∏—Å–∞–Ω–∏–µ */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–û–ø–∏—Å–∞–Ω–∏–µ</h4>
                                <textarea
                                  value={widgetDescription}
                                  onChange={(e) => setWidgetDescription(e.target.value)}
                                  className="w-full h-[80px] px-3 py-2 border border-[#070F1A]/10 rounded-[10px] text-[13px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20 resize-none"
                                  style={INPUT_STYLES.inputField}
                                />
                              </div>

                              {/* 5. –í–æ–ø—Ä–æ—Å—ã */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–í–æ–ø—Ä–æ—Å—ã</h4>
                                <div className="space-y-[10px]">
                                  {questions.map((question) => (
                                    <div key={question.id} className="bg-[#F3F5F7] rounded-[10px] p-3 h-[50px] flex items-center gap-[10px]">
                                      <img src="/Group 1.svg" alt="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å" className="w-4 h-4 cursor-move" />
                                      <input
                                        type="text"
                                        value={question.text}
                                        onChange={(e) => updateQuestionText(question.id, e.target.value)}
                                        className="flex-1 h-[40px] px-3 border border-[#070F1A]/10 rounded-[7px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                      />
                                      <img 
                                        src={question.enabled ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                                        alt="–í–∫–ª—é—á–∏—Ç—å" 
                                        className="w-[34px] h-[34px] cursor-pointer" 
                                        onClick={() => toggleQuestionEnabled(question.id)}
                                      />
                                      <img 
                                        src="/traash.svg" 
                                        alt="–£–¥–∞–ª–∏—Ç—å" 
                                        className="w-4 h-4 cursor-pointer ml-[10px]" 
                                        onClick={() => {
                                          setQuestionToDelete(question.id);
                                          setShowDeleteQuestionModal(true);
                                        }}
                                      />
                                    </div>
                                  ))}
                                </div>
                                
                                {/* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å */}
                                <button 
                                  onClick={addQuestion}
                                  className="mt-3 h-[34px] px-4 bg-[#0084FF] text-white hover:bg-[#0073E6] rounded-[90px] font-[500] text-[14px] transition-colors flex items-center justify-center gap-[2px]"
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                  </svg>
                                  –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å
                                </button>
                              </div>

                              {/* 6. –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–Ω–æ–ø–∫–∏ */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–Ω–æ–ø–∫–∏</h4>
                                <input
                                  type="text"
                                  value={buttonTitle}
                                  onChange={(e) => setButtonTitle(e.target.value)}
                                  className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[13px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  style={INPUT_STYLES.inputField}
                                />
                              </div>

                              {/* 7. –û–ø–∏—Å–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–û–ø–∏—Å–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏</h4>
                                <input
                                  type="text"
                                  value={buttonDescription}
                                  onChange={(e) => setButtonDescription(e.target.value)}
                                  className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[13px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  style={INPUT_STYLES.inputField}
                                />
                              </div>
                            </div>
                          )}

                          {activeWidgetTab === 'chat' && (
                            <div className="space-y-5">
                              {/* 1. –§–æ—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–§–æ—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ –ø—Ä–∞–≤–æ–º —É–≥–ª—É –≤–∏–¥–∂–µ—Ç–∞</h4>
                                <div className="space-y-3">
                                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setManagerPhotoType('none')}>
                                    <img 
                                      src={managerPhotoType === 'none' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å</span>
                                  </div>
                                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setManagerPhotoType('add')}>
                                    <img 
                                      src={managerPhotoType === 'add' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–î–æ–±–∞–≤–∏—Ç—å" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–î–æ–±–∞–≤–∏—Ç—å (–º–∞–∫—Å–∏–º—É–º 2)</span>
                                  </div>
                                  {managerPhotoType === 'add' && (
                                    <div className="flex items-center gap-[10px] cursor-pointer" onClick={() => document.getElementById('manager-photo-upload').click()}>
                                      <div className="w-[40px] h-[40px] bg-white rounded-[10px] flex items-center justify-center overflow-hidden">
                                        <img src="/Group 125.svg" alt="–§–æ—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞" className="w-full h-full object-contain" />
                                      </div>
                                      <div>
                                        <p className="text-[14px] text-[#8E8E93] font-[500]">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</p>
                                        <p className="text-[9px] text-[#8E8E93]">–í–µ—Å —Ñ–∞–π–ª–∞ –Ω–µ –±–æ–ª–µ–µ 500 –ö–ë</p>
                                      </div>
                                      <input type="file" id="manager-photo-upload" className="hidden" accept="image/*" />
                                    </div>
                                  )}
                                </div>
                              </div>

                              {/* 2. –°—Ç–∞—Ç—É—Å */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–°—Ç–∞—Ç—É—Å</h4>
                                <div className="flex items-center gap-[15px]">
                                  <input
                                    type="text"
                                    value={statusText}
                                    onChange={(e) => setStatusText(e.target.value)}
                                    className="flex-1 h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  />
                                  <div className="flex items-center gap-2">
                                    <img
                                      src={showStatus ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"}
                                      alt="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å"
                                      className="w-[34px] h-[34px] cursor-pointer"
                                      onClick={() => setShowStatus(!showStatus)}
                                    />
                                  </div>
                                </div>
                              </div>

                              {/* 3. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h4>
                                <input
                                  type="text"
                                  value={welcomeMessage}
                                  onChange={(e) => setWelcomeMessage(e.target.value)}
                                  className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  placeholder="–î–æ–±—Ä–æ–≥–æ –¥–Ω—è! –ß–µ–º –º—ã –º–æ–∂–µ–º –ø–æ–º–æ—á—å?"
                                />
                              </div>
                            </div>
                          )}

                          {activeWidgetTab === 'form' && (
                            <div className="space-y-5">
                              {/* 1. –ö–æ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ö–æ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å</h4>
                                <div className="space-y-3">
                                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setFormTrigger('never')}>
                                    <img 
                                      src={formTrigger === 'never' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–ù–∏–∫–æ–≥–¥–∞" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–ù–∏–∫–æ–≥–¥–∞</span>
                                  </div>
                                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setFormTrigger('before')}>
                                    <img 
                                      src={formTrigger === 'before' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –¥–∏–∞–ª–æ–≥–∞" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –¥–∏–∞–ª–æ–≥–∞</span>
                                  </div>
                                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setFormTrigger('during')}>
                                    <img 
                                      src={formTrigger === 'during' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–í –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–∏–∞–ª–æ–≥–∞" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–í –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–∏–∞–ª–æ–≥–∞</span>
                                  </div>
                                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setFormTrigger('timer')}>
                                    <img 
                                      src={formTrigger === 'timer' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–ü–æ —Ç–∞–π–º–µ—Ä—É" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–ü–æ —Ç–∞–π–º–µ—Ä—É</span>
                                  </div>
                                  <div className="flex items-center gap-2 cursor-pointer" onClick={() => setFormTrigger('after_answer')}>
                                    <img 
                                      src={formTrigger === 'after_answer' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞</span>
                                  </div>
                                </div>
                              </div>

                              {/* –ü–æ–ª–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ —Ç–∞–π–º–µ—Ä–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–ü–æ —Ç–∞–π–º–µ—Ä—É" */}
                              {formTrigger === 'timer' && (
                                <div>
                                  <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ —Ñ–æ—Ä–º—ã (—Å–µ–∫—É–Ω–¥—ã)</h4>
                                  <input
                                    type="number"
                                    value={formTimerSeconds}
                                    onChange={(e) => setFormTimerSeconds(parseInt(e.target.value) || 30)}
                                    min="1"
                                    max="300"
                                    className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  />
                                </div>
                              )}

                              {/* 2. –ü–æ–ª—è —Ñ–æ—Ä–º—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ "–ù–∏–∫–æ–≥–¥–∞" */}
                              {formTrigger !== 'never' && (
                                <>
                                  <div>
                                    <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ü–æ–ª—è —Ñ–æ—Ä–º—ã</h4>
                                    <div className="relative">
                                      <button
                                        onClick={() => setShowFormDropdown(!showFormDropdown)}
                                        className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20 flex items-center justify-between"
                                      >
                                        <span>–í—ã–±—Ä–∞—Ç—å (–¥–æ 4-—Ö –ø–æ–ª–µ–π)</span>
                                        <img 
                                          src="/Bounds.svg" 
                                          alt="–†–∞—Å–∫—Ä—ã—Ç—å" 
                                          className="w-3 h-3 transition-transform duration-300" 
                                          style={{ 
                                            transform: showFormDropdown ? 'rotate(-90deg)' : 'rotate(90deg)',
                                            filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)'
                                          }}
                                        />
                                      </button>
                                      
                                      {showFormDropdown && (
                                        <div className="absolute bottom-full left-0 right-0 mb-1 bg-white border border-[#070F1A]/10 rounded-[10px] shadow-lg z-50 max-h-[200px] overflow-hidden">
                                          <div className="p-2 max-h-[180px] overflow-y-auto">
                                            <div className="space-y-2">
                                              {formFields.map((field) => (
                                                <div 
                                                  key={field.id} 
                                                  className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                                  onClick={() => toggleFormField(field.type)}
                                                >
                                                  <img 
                                                    src={selectedFormFields.includes(field.type) ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                                    alt={field.label} 
                                                    className="w-4 h-4" 
                                                  />
                                                  <span className="text-[13px] text-[#070F1A]">{field.label}</span>
                                                </div>
                                              ))}
                                            </div>
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  </div>

                                  {/* 3. –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—è */}
                                  {selectedFormFields.length > 0 && (
                                    <div>
                                      <div className="space-y-[10px]">
                                        {formFields
                                          .filter(field => selectedFormFields.includes(field.type))
                                          .map((field) => (
                                            <div key={field.id} className="bg-[#F3F5F7] rounded-[10px] p-3 h-[70px] flex items-center gap-[10px]">
                                              <img src="/Group 1.svg" alt="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å" className="w-4 h-4 cursor-move" />
                                              <div className="flex-1 flex items-center gap-[10px]">
                                                <div className="bg-white rounded-[7px] px-3 py-2 flex-1 flex flex-col gap-[5px]">
                                                  <span className="text-[10px] text-[#8E8E93]">{field.label}</span>
                                                  <div className="flex items-center gap-[10px]">
                                                    <input
                                                      type="text"
                                                      value={field.placeholder}
                                                      onChange={(e) => updateFormFieldPlaceholder(field.id, e.target.value)}
                                                      className="flex-1 text-[14px] text-[#070F1A] focus:outline-none"
                                                    />
                                                    <img 
                                                      src="/vector.svg" 
                                                      alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" 
                                                      className="w-2 h-2 cursor-pointer" 
                                                    />
                                                  </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                  <span className="text-[13px] text-[#070F1A]">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</span>
                                                  <img
                                                    src={field.required ? "/iOS/Switch-1.svg" : "/iOS/Switch.svg"}
                                                    alt="–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"
                                                    className="w-[34px] h-[34px] cursor-pointer"
                                                    onClick={() => toggleFormFieldRequired(field.id)}
                                                  />
                                                </div>
                                              </div>
                                            </div>
                                          ))}
                                      </div>
                                    </div>
                                  )}

                                  {/* 4. –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã */}
                                  <div>
                                    <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã</h4>
                                    <input
                                      type="text"
                                      value={formTitle}
                                      onChange={(e) => setFormTitle(e.target.value)}
                                      placeholder="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É"
                                      className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                    />
                                  </div>

                                </>
                              )}

                              {/* 5. –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ */}
                              <div>
                                <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h4>
                                <input
                                  type="url"
                                  value={privacyPolicyLink}
                                  onChange={(e) => setPrivacyPolicyLink(e.target.value)}
                                  placeholder="https://example.com/privacy-policy"
                                  className={`w-full h-[34px] px-3 border rounded-[10px] text-[14px] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20 ${
                                    privacyPolicyLink && !validateUrl(privacyPolicyLink) 
                                      ? 'border-red-500' 
                                      : 'border-[#070F1A]/10'
                                  }`}
                                />
                                {privacyPolicyLink && !validateUrl(privacyPolicyLink) && (
                                  <p className="text-[12px] text-red-500 mt-1">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É</p>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>

                  {/* –ü–ª–∞—à–∫–∞ 2: –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞ */}
                  <div className="bg-white rounded-[16px] overflow-hidden">
                    <div 
                      className="p-[20px] h-[76px] flex items-center gap-4 cursor-pointer"
                      onClick={() => setOpenWidgetSections(prev => ({...prev, styling: !prev.styling}))}
                    >
                      <div className="w-[40px] h-[40px] bg-white rounded-[10px] flex items-center justify-center overflow-hidden">
                        <img src="/1231235.png" alt="–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è" className="w-full h-full object-contain" />
                      </div>
                      <div className="flex-1">
                        <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞</h3>
                        <p className="text-[12px] text-[#8E8E93]">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É –≤–∏–¥–∂–µ—Ç–∞ –ø–æ–¥ –≤–∞—à –±—Ä–µ–Ω–¥</p>
                      </div>
                      <div className={`transition-transform duration-300 ${openWidgetSections.styling ? '-rotate-90' : 'rotate-90'}`}>
                        <img src="/Bounds.svg" alt="–†–∞—Å–∫—Ä—ã—Ç—å" className="w-[11px] h-[11px]" style={{ filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }} />
                      </div>
                    </div>
                    {openWidgetSections.styling && (
                      <div className="px-[15px] pb-[15px] border-t border-[#070F1A]/10">
                        <div className="pt-4 space-y-5">
                          {/* 1. –¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞ –≤–∏–¥–∂–µ—Ç–∞ */}
                          <div>
                            <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞ –≤–∏–¥–∂–µ—Ç–∞</h4>
                            <div className="flex gap-[15px]">
                                                            <div
                                className={`w-[141px] h-[120px] rounded-[12px] border cursor-pointer transition-all ${
                                  widgetTheme === 'white'
                                    ? 'bg-[#DBE9FF] border-[#0084FF]'
                                    : 'bg-[#F3F5F7] border-[#070F1A]/10'
                                }`}
                                onClick={() => setWidgetTheme('white')}
                              >
                                <div className="h-full flex flex-col">
                                  <div className="w-full h-[80px] bg-white rounded-t-[12px] flex items-center justify-center border border-gray-200">
                                    <img src="/Group 161.png" alt="–ë–µ–ª–∞—è —Ç–µ–º–∞" className="w-full h-full object-contain rounded-t-[12px]" />
                                  </div>
                                  <div className="flex items-center gap-2 pl-[10px] pt-2">
                                    <img 
                                      src={widgetTheme === 'white' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–ë–µ–ª–∞—è" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–ë–µ–ª–∞—è</span>
                                  </div>
                                </div>
                              </div>
                              <div 
                                className={`w-[141px] h-[120px] rounded-[12px] border cursor-pointer transition-all ${
                                  widgetTheme === 'dark' 
                                    ? 'bg-[#DBE9FF] border-[#0084FF]' 
                                    : 'bg-[#F3F5F7] border-[#070F1A]/10'
                                }`}
                                onClick={() => setWidgetTheme('dark')}
                              >
                                <div className="h-full flex flex-col">
                                  <div className="w-full h-[80px] bg-gray-800 rounded-t-[12px] flex items-center justify-center border border-gray-200">
                                    <img src="/Group 160.png" alt="–¢–µ–º–Ω–∞—è —Ç–µ–º–∞" className="w-full h-full object-contain rounded-t-[12px]" />
                                  </div>
                                  <div className="flex items-center gap-2 pl-[10px] pt-2">
                                    <img 
                                      src={widgetTheme === 'dark' ? "/Checkbox.svg" : "/Checkbox-1.svg"} 
                                      alt="–¢–µ–º–Ω–∞—è" 
                                      className="w-4 h-4" 
                                    />
                                    <span className="text-[14px] text-[#070F1A]">–¢–µ–º–Ω–∞—è</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* 2. –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –∏ –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç */}
                          <div className="flex gap-[15px]">
                            <div className="flex-1">
                              <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</h4>
                              <div className="relative">
                                <input
                                  type="text"
                                  value={selectedGradient > 0 ? `Gradient ‚Ññ${selectedGradient}` : backgroundColor}
                                onChange={(e) => {
                                  if (selectedGradient === 0) {
                                    setBackgroundColor(e.target.value);
                                  }
                                }}
                                  className="w-full h-[34px] px-3 pr-12 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] bg-white"
                                />
                                <div 
                                  className="color-picker-button absolute right-2 top-1/2 transform -translate-y-1/2 w-[28px] h-[28px] cursor-pointer"
                                  onClick={() => openColorPicker('background')}
                                >
                                  <div 
                                    className="color-picker-preview w-[28px] h-[28px] rounded-[90px]"
                                    style={{ 
                                      background: 'conic-gradient(from 0deg, #0C28FF 0%, #03FFFF 14%, #24D627 23%, #FDFF22 41%, #FF2227 58%, #FE2DF6 77%, #7122FF 89%, #0C28FF 100%)',
                                      border: '1.5px solid transparent',
                                      backgroundClip: 'padding-box'
                                    }}
                                  >
                                    <div 
                                      className="w-[16px] h-[16px] rounded-[90px] absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"
                                      style={{ backgroundColor: backgroundColor.includes('gradient') ? '#FFFFFF' : backgroundColor }}
                                    ></div>
                                  </div>
                                </div>
                                {renderColorPicker('background')}
                              </div>
                              {/* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã */}
                              <div className="flex gap-[10px] mt-3">
                                {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((num) => (
                                  <div 
                                    key={num}
                                    className={`w-[20px] h-[20px] rounded-[90px] border cursor-pointer relative ${
                                      selectedGradient === num ? 'border-[#0084FF]' : 'border-[#C8C7CB]'
                                    }`}
                                    onClick={() => selectGradient(num)}
                                  >
                                    <div 
                                      className="w-[14px] h-[14px] rounded-[90px] absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"
                                      style={{
                                        background: num === 1 ? 'linear-gradient(30deg, #52AEFF 0%, #096EFD 100%)' :
                                                   num === 2 ? 'linear-gradient(30deg, #39E978 0%, #2A7344 100%)' :
                                                   num === 3 ? 'linear-gradient(30deg, #4C4C4C 0%, #282828 100%)' :
                                                   num === 4 ? 'linear-gradient(30deg, #D12020 0%, #8A2626 100%)' :
                                                   num === 5 ? 'linear-gradient(30deg, #D15820 0%, #8A4B26 100%)' :
                                                   num === 6 ? 'linear-gradient(30deg, #FDAB54 0%, #FA7F89 100%)' :
                                                   num === 7 ? 'linear-gradient(30deg, #A41AE8 0%, #60268A 100%)' :
                                                   num === 8 ? 'linear-gradient(30deg, #DAC887 0%, #EDAA24 100%)' :
                                                   num === 9 ? 'linear-gradient(30deg, #5675FF 0%, #1749BD 100%)' :
                                                   'linear-gradient(30deg, #28BCEE 0%, #27B0C2 100%)'
                                      }}
                                    ></div>
                                  </div>
                                ))}
                              </div>
                            </div>
                            <div className="flex-1">
                              <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</h4>
                              <div className="relative">
                                <input
                                  type="text"
                                  value={accentColor}
                                onChange={(e) => setAccentColor(e.target.value)}
                                  className="w-full h-[34px] px-3 pr-12 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] bg-white"
                                />
                                <div 
                                  className="color-picker-button absolute right-2 top-1/2 transform -translate-y-1/2 w-[28px] h-[28px] cursor-pointer"
                                  onClick={() => openColorPicker('accent')}
                                >
                                  <div 
                                    className="color-picker-preview w-[28px] h-[28px] rounded-[90px]"
                                    style={{ 
                                      background: 'conic-gradient(from 0deg, #0C28FF 0%, #03FFFF 14%, #24D627 23%, #FDFF22 41%, #FF2227 58%, #FE2DF6 77%, #7122FF 89%, #0C28FF 100%)',
                                      border: '1.5px solid transparent',
                                      backgroundClip: 'padding-box'
                                    }}
                                  >
                                    <div 
                                      className="w-[16px] h-[16px] rounded-[90px] absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"
                                      style={{ backgroundColor: accentColor }}
                                    ></div>
                                  </div>
                                </div>
                                {renderColorPicker('accent')}
                              </div>
                            </div>
                          </div>

                          {/* 3. –¶–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∏–¥–∂–µ—Ç–∞ */}
                          <div>
                            <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–¶–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∏–¥–∂–µ—Ç–∞</h4>
                            <div className="relative">
                              <input
                                type="text"
                                value={buttonColor}
                                onChange={(e) => setButtonColor(e.target.value)}
                                className="w-full h-[34px] px-3 pr-12 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] bg-white"
                              />
                              <div 
                                className="color-picker-button absolute right-2 top-1/2 transform -translate-y-1/2 w-[28px] h-[28px] cursor-pointer"
                                onClick={() => openColorPicker('button')}
                              >
                                <div 
                                  className="w-[28px] h-[28px] rounded-[90px]"
                                  style={{ 
                                    background: 'conic-gradient(from 0deg, #0C28FF 0%, #03FFFF 14%, #24D627 23%, #FDFF22 41%, #FF2227 58%, #FE2DF6 77%, #7122FF 89%, #0C28FF 100%)',
                                    border: '1.5px solid transparent',
                                    backgroundClip: 'padding-box'
                                  }}
                                >
                                  <div 
                                    className="w-[16px] h-[16px] rounded-[90px] absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"
                                    style={{ backgroundColor: buttonColor }}
                                  ></div>
                                </div>
                              </div>
                              {renderColorPicker('button')}
                            </div>
                          </div>

                          {/* 4. –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */}
                          <div className="flex gap-[15px]">
                            <div className="flex-1">
                              <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ü–æ–∑–∏—Ü–∏—è –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ</h4>
                              <div className="flex gap-[10px]">
                                <div className="flex-1">
                                  <label className="text-[12px] text-[#8E8E93] mb-1 block">–û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É</label>
                                  <input
                                    type="text"
                                    value={`${desktopBottomOffset}px`}
                                    onChange={(e) => {
                                      const value = e.target.value.replace('px', '');
                                      setDesktopBottomOffset(Number(value) || 0);
                                    }}
                                    className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  />
                                </div>
                                <div className="flex-1">
                                  <label className="text-[12px] text-[#8E8E93] mb-1 block">–û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞</label>
                                  <input
                                    type="text"
                                    value={`${desktopRightOffset}px`}
                                    onChange={(e) => {
                                      const value = e.target.value.replace('px', '');
                                      setDesktopRightOffset(Number(value) || 0);
                                    }}
                                    className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  />
                                </div>
                              </div>
                            </div>
                            <div className="flex-1">
                              <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–ü–æ–∑–∏—Ü–∏—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏ –ø–ª–∞–Ω—à–µ—Ç–µ</h4>
                              <div className="flex gap-[10px]">
                                <div className="flex-1">
                                  <label className="text-[12px] text-[#8E8E93] mb-1 block">–û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É</label>
                                  <input
                                    type="text"
                                    value={`${mobileBottomOffset}px`}
                                    onChange={(e) => {
                                      const value = e.target.value.replace('px', '');
                                      setMobileBottomOffset(Number(value) || 0);
                                    }}
                                    className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  />
                                </div>
                                <div className="flex-1">
                                  <label className="text-[12px] text-[#8E8E93] mb-1 block">–û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞</label>
                                  <input
                                    type="text"
                                    value={`${mobileRightOffset}px`}
                                    onChange={(e) => {
                                      const value = e.target.value.replace('px', '');
                                      setMobileRightOffset(Number(value) || 0);
                                    }}
                                    className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                  />
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* –ü–ª–∞—à–∫–∞ 3: –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã */}
                  <div className="bg-white rounded-[16px] overflow-hidden">
                    <div 
                      className="p-[20px] h-[76px] flex items-center gap-4 cursor-pointer"
                      onClick={() => setOpenWidgetSections(prev => ({...prev, triggers: !prev.triggers}))}
                    >
                      <div className="w-[40px] h-[40px] bg-white rounded-[10px] flex items-center justify-center overflow-hidden">
                        <img src="/1231236.png" alt="–¢—Ä–∏–≥–≥–µ—Ä—ã" className="w-full h-full object-contain" />
                      </div>
                      <div className="flex-1">
                        <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã</h3>
                        <p className="text-[12px] text-[#8E8E93]">–î–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∞, —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ –∏ –¥–æ–≥–æ–Ω—è—é—â–∏–µ —Å–º—Å</p>
                      </div>
                      <div className={`transition-transform duration-300 ${openWidgetSections.triggers ? '-rotate-90' : 'rotate-90'}`}>
                        <img src="/Bounds.svg" alt="–†–∞—Å–∫—Ä—ã—Ç—å" className="w-[11px] h-[11px]" style={{ filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }} />
                      </div>
                    </div>
                    {openWidgetSections.triggers && (
                      <div className="px-[15px] pb-[15px] border-t border-[#070F1A]/10">
                        <div className="pt-4 space-y-6">
                          
                          {/* –¢—Ä–∏–≥–≥–µ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                          <div>
                            <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–¢—Ä–∏–≥–≥–µ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h4>
                            <div className="grid grid-cols-2 gap-[15px] mb-4">
                              <button
                                onClick={() => setTriggerMessagesEnabled(true)}
                                className={`h-[34px] px-4 rounded-[10px] text-[14px] font-[500] transition-all ${
                                  triggerMessagesEnabled 
                                    ? 'bg-[#0084FF] text-white' 
                                    : 'bg-transparent border border-[#070F1A]/10 text-[#8E8E93]'
                                }`}
                              >
                                –ï—Å—Ç—å
                              </button>
                              <button
                                onClick={() => setTriggerMessagesEnabled(false)}
                                className={`h-[34px] px-4 rounded-[10px] text-[14px] font-[500] transition-all ${
                                  !triggerMessagesEnabled 
                                    ? 'bg-[#0084FF] text-white' 
                                    : 'bg-transparent border border-[#070F1A]/10 text-[#8E8E93]'
                                }`}
                              >
                                –ù–µ—Ç
                              </button>
                            </div>

                            {triggerMessagesEnabled && (
                              <div className="space-y-4">
                                {triggerMessages.map((message, index) => (
                                  <div key={message.id} className="bg-[#F3F5F7] rounded-[10px] p-[15px] h-[235px] relative">
                                    <div className="flex justify-between items-center mb-[13px]">
                                      <h5 className="text-[14px] font-[500] text-[#070F1A]">–¢—Ä–∏–≥–≥–µ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Ññ{index + 1}</h5>
                                      <button
                                        onClick={() => removeTriggerMessage(message.id)}
                                        className="w-[15px] h-[15px] flex items-center justify-center"
                                      >
                                        <img 
                                          src="/traash.svg" 
                                          alt="–£–¥–∞–ª–∏—Ç—å" 
                                          className="w-[16px] h-[16px]"
                                          style={{ filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%)' }}
                                        />
                                      </button>
                                    </div>
                                    
                                    <div className="bg-white rounded-[7px] px-[15px] py-[15px] space-y-4">
                                      <div className="flex gap-4">
                                        <div className="w-[155px]">
                                          <label className="text-[14px] text-[#8E8E93] mb-1 block">–í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ —á–µ—Ä–µ–∑:</label>
                                          <div className="flex items-center gap-1">
                                          <input
                                            type="number"
                                            value={message.timeDelay}
                                            onChange={(e) => updateTriggerMessage(message.id, 'timeDelay', Number(e.target.value))}
                                              className="w-[50px] h-[40px] px-2 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                          />
                                            <span className="text-[12px] text-[#070F1A] opacity-50">—Å–µ–∫</span>
                                          </div>
                                        </div>
                                        <div className="flex-1">
                                          <label className="text-[14px] text-[#8E8E93] mb-1 block">
                                            –°–æ–æ–±—â–µ–Ω–∏–µ 
                                            <span className="text-[10px] text-[#8E8E93]/70 ml-1">
                                              ({message.message.trim().split(/\s+/).filter(w => w.length > 0).length}/15 —Å–ª–æ–≤)
                                            </span>
                                          </label>
                                          <input
                                            type="text"
                                            value={message.message}
                                            onChange={(e) => updateTriggerMessage(message.id, 'message', e.target.value)}
                                            className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–º–∞–∫—Å–∏–º—É–º 15 —Å–ª–æ–≤)"
                                          />
                                        </div>
                                      </div>
                                      <div>
                                        <label className="text-[14px] text-[#8E8E93] mb-1 block">–ö–Ω–æ–ø–∫–∞ –æ—Ç–≤–µ—Ç–∞</label>
                                        <input
                                          type="text"
                                          value={message.buttonText}
                                          onChange={(e) => updateTriggerMessage(message.id, 'buttonText', e.target.value)}
                                          className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                        />
                                      </div>
                                    </div>
                                  </div>
                                ))}
                                
                                <button
                                  onClick={addTriggerMessage}
                                  className="mt-3 h-[34px] px-4 bg-[#0084FF] text-white hover:bg-[#0073E6] rounded-[90px] font-[500] text-[14px] transition-colors flex items-center justify-center gap-[2px]"
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                  </svg>
                                  –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä
                                </button>
                              </div>
                            )}
                          </div>

                          {/* –î–æ–≥–æ–Ω—è—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                          <div>
                            <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–î–æ–≥–æ–Ω—è—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h4>
                            <div className="grid grid-cols-2 gap-[15px] mb-4">
                              <button
                                onClick={() => setFollowUpMessagesEnabled(true)}
                                className={`h-[34px] px-4 rounded-[10px] text-[14px] font-[500] transition-all ${
                                  followUpMessagesEnabled 
                                    ? 'bg-[#0084FF] text-white' 
                                    : 'bg-transparent border border-[#070F1A]/10 text-[#8E8E93]'
                                }`}
                              >
                                –ï—Å—Ç—å
                              </button>
                              <button
                                onClick={() => setFollowUpMessagesEnabled(false)}
                                className={`h-[34px] px-4 rounded-[10px] text-[14px] font-[500] transition-all ${
                                  !followUpMessagesEnabled 
                                    ? 'bg-[#0084FF] text-white' 
                                    : 'bg-transparent border border-[#070F1A]/10 text-[#8E8E93]'
                                }`}
                              >
                                –ù–µ—Ç
                              </button>
                            </div>

                            {followUpMessagesEnabled && (
                              <div className="space-y-4">
                                {followUpMessages.map((message, index) => (
                                  <div key={message.id} className="bg-[#F3F5F7] rounded-[10px] p-[15px] h-[235px] relative">
                                    <div className="flex justify-between items-center mb-[13px]">
                                      <h5 className="text-[14px] font-[500] text-[#070F1A]">–î–æ–≥–æ–Ω—è—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Ññ{index + 1}</h5>
                                      <button
                                        onClick={() => removeFollowUpMessage(message.id)}
                                        className="w-[15px] h-[15px] flex items-center justify-center"
                                      >
                                        <img 
                                          src="/traash.svg" 
                                          alt="–£–¥–∞–ª–∏—Ç—å" 
                                          className="w-[16px] h-[16px]"
                                          style={{ filter: 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%)' }}
                                        />
                                      </button>
                                    </div>
                                    
                                    <div className="bg-white rounded-[7px] px-[15px] py-[15px] space-y-4">
                                      <div className="flex gap-4">
                                        <div className="w-[155px]">
                                          <label className="text-[14px] text-[#8E8E93] mb-1 block">–í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ —á–µ—Ä–µ–∑:</label>
                                          <div className="flex items-center gap-1">
                                          <input
                                            type="number"
                                            value={message.timeDelay}
                                            onChange={(e) => updateFollowUpMessage(message.id, 'timeDelay', Number(e.target.value))}
                                              className="w-[50px] h-[40px] px-2 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                          />
                                            <span className="text-[12px] text-[#070F1A] opacity-50">—Å–µ–∫</span>
                                          </div>
                                        </div>
                                        <div className="flex-1">
                                          <label className="text-[14px] text-[#8E8E93] mb-1 block">
                                            –°–æ–æ–±—â–µ–Ω–∏–µ 
                                            <span className="text-[10px] text-[#8E8E93]/70 ml-1">
                                              ({message.message.trim().split(/\s+/).filter(w => w.length > 0).length}/15 —Å–ª–æ–≤)
                                            </span>
                                          </label>
                                          <input
                                            type="text"
                                            value={message.message}
                                            onChange={(e) => updateFollowUpMessage(message.id, 'message', e.target.value)}
                                            className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–º–∞–∫—Å–∏–º—É–º 15 —Å–ª–æ–≤)"
                                          />
                                        </div>
                                      </div>
                                      <div>
                                        <label className="text-[14px] text-[#8E8E93] mb-1 block">–ö–Ω–æ–ø–∫–∞ –æ—Ç–≤–µ—Ç–∞</label>
                                        <input
                                          type="text"
                                          value={message.buttonText}
                                          onChange={(e) => updateFollowUpMessage(message.id, 'buttonText', e.target.value)}
                                          className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20"
                                        />
                                      </div>
                                    </div>
                                  </div>
                                ))}
                                
                                <button
                                  onClick={addFollowUpMessage}
                                  className="mt-3 h-[34px] px-4 bg-[#0084FF] text-white hover:bg-[#0073E6] rounded-[90px] font-[500] text-[14px] transition-colors flex items-center justify-center gap-[2px]"
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                  </svg>
                                  –î–æ–±–∞–≤–∏—Ç—å –¥–æ–≥–æ–Ω—è—é—â–µ–µ
                                </button>
                              </div>
                            )}
                          </div>

                          {/* –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ */}
                          <div>
                            <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞</h4>
                            <div className="flex gap-[10px] flex-wrap">
                              {['üëç –≠—Ç–æ –ø–æ–º–æ–≥–ª–æ', '–°–ø–∞—Å–∏–±–æ', '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç', 'üëç'].map((option) => (
                                <button
                                  key={option}
                                  onClick={() => setSelectedCompletionButton(option)}
                                  className={`h-[34px] px-[14px] rounded-[90px] text-[13px] font-[500] transition-all ${
                                    selectedCompletionButton === option
                                      ? 'bg-[#0084FF] text-white'
                                      : 'bg-transparent border border-[#070F1A]/10 text-[#8E8E93]'
                                  }`}
                                >
                                  {option}
                                </button>
                              ))}
                            </div>
                          </div>

                          {/* –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞ */}
                          <div>
                            <h4 className="text-[14px] font-[500] text-[#8E8E93] mb-[10px]">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞</h4>
                            <div className="flex gap-[10px] flex-wrap">
                              {['–ü–æ–ª—É—á–∏—Ç—å –¥–æ–ø. –ø–æ–º–æ—â—å', '–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º üë§', '–ù–µ—Ç'].map((option) => (
                                <button
                                  key={option}
                                  onClick={() => setSelectedHumanButton(option)}
                                  className={`h-[34px] px-[14px] rounded-[90px] text-[13px] font-[500] transition-all ${
                                    selectedHumanButton === option
                                      ? 'bg-[#0084FF] text-white'
                                      : 'bg-transparent border border-[#070F1A]/10 text-[#8E8E93]'
                                  }`}
                                >
                                  {option}
                                </button>
                              ))}
                            </div>
                          </div>

                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (sticky –∫ –Ω–∏–∑—É –º–µ–π–Ω-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) */}
                <div className="sticky bottom-0 z-10 mt-6">
                  <div className="w-full shadow-[0_12px_30px_rgba(7,15,26,0.12)]/50">
                    <Button
                      onClick={saveWidgetSettings}
                      className="w-full h-[34px] bg-[#0084FF] text-white hover:bg-[#0073E6] rounded-[10px] font-[500] text-[13px] shadow-[0_12px_30px_rgba(7,15,26,0.12)]"
                      style={BUTTON_STYLES.blueButton}
                    >
                      –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </Button>
                  </div>
                </div>
              </div>

              {/* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */}
              <div className="w-px bg-[#E5E6E7] self-stretch" style={{ marginLeft: '16px', marginRight: '16px', marginTop: '0px' }}></div>

              {/* –ü—Ä–∞–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä - –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–∂–µ—Ç–∞ */}
              <div className="flex-1 bg-[#F8F8FA] py-6 sticky top-0 self-start h-fit max-h-screen overflow-y-auto" style={{ marginTop: '20px' }}>
                {/* –ñ–∏–≤–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–∂–µ—Ç–∞ */}
                <div className="relative h-[680px]">
                  
                  {/* –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ */}
                  <div 
                    className="absolute transition-all duration-300"
                    style={{
                      bottom: `${widgetDevelopmentSettings.desktopBottomOffset || 20}px`,
                      right: `${(widgetDevelopmentSettings.desktopRightOffset || 20) + 40}px`, // —Å–¥–≤–∏–Ω—É—Ç–æ –ª–µ–≤–µ–µ –Ω–∞ 40px
                      zIndex: widgetDevelopmentSettings.zIndex || 9999
                    }}
                  >
                    <button
                      onClick={() => widgetPreviewOpen ? handleWidgetClose() : handleWidgetOpen()}
                      className="w-[50px] h-[50px] shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center"
                      style={{
                        backgroundColor: buttonColor || '#0084FF',
                        borderRadius: '990px 990px 0px 990px' // –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–æ –¥–∏–∑–∞–π–Ω—É
                      }}
                    >
                      {/* –ò–∫–æ–Ω–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è */}
                      {widgetPreviewOpen ? (
                        <img 
                          src="/Icon2.svg" 
                          alt="Close" 
                          className="w-4 h-4"
                          style={{ filter: 'brightness(0) invert(1)' }}
                        />
                      ) : (
                        <img 
                          src="/Vectorlogovidget.svg" 
                          alt="Widget" 
                          className="w-6 h-6"
                          style={{ filter: 'brightness(0) invert(1)' }}
                        />
                      )}
                    </button>
                  </div>
                  
                  {/* –í–∏–¥–∂–µ—Ç –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ */}
                  {widgetPreviewOpen && (
                    <div 
                      className="absolute transition-all duration-300"
                      style={{
                        bottom: `${(widgetDevelopmentSettings.desktopBottomOffset || 20) + 60}px`, // 50px –∫–Ω–æ–ø–∫–∞ + 10px –æ—Ç—Å—Ç—É–ø
                        right: `${(widgetDevelopmentSettings.desktopRightOffset || 20) + 40}px`, // —Å–¥–≤–∏–Ω—É—Ç–æ –ª–µ–≤–µ–µ –Ω–∞ 40px
                        zIndex: widgetDevelopmentSettings.zIndex || 9999
                      }}
                    >
                      <div className={`rounded-[20px] shadow-lg border w-[371px] h-[601px] flex flex-col overflow-hidden relative ${
                        widgetTheme === 'dark' 
                          ? 'bg-[#171717] border-white/10' 
                          : 'bg-white border-gray-200'
                      }`}>
                        
                        {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */}
                        <button
                          onClick={handleWidgetClose}
                          className="absolute top-[15px] right-[15px] z-10 w-[18px] h-[18px] flex items-center justify-center hover:bg-white/10 rounded-[5px] transition-colors"
                        >
                          <img src="/x-02.svg" alt="–ó–∞–∫—Ä—ã—Ç—å" className="w-[18px] h-[18px]" style={{ marginTop: '10px' }} />
                        </button>
                        
                        {/* –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º - —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */}
                        {widgetCurrentPage === 'home' && (
                          <div 
                            className="h-[238px] relative"
                            style={{
                              background: selectedGradient > 0 ? backgroundColor : backgroundColor
                            }}
                          >
                            {/* –õ–æ–≥–æ—Ç–∏–ø */}
                            <div className="absolute top-[21px] left-[20px]">
                              <div className="w-[40px] h-[40px] bg-white rounded-[10px] flex items-center justify-center overflow-hidden">
                                {logoType === 'custom' && customLogo ? (
                                  <img src={customLogo} alt="Logo" className="w-full h-full object-contain" />
                                ) : (
                                  <img src="/Group 1234.svg" alt="Logo" className="w-full h-full object-contain" />
                                )}
                              </div>
                            </div>
                            
                            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ */}
                            <div className="absolute top-[80px] left-[20px] text-white">
                              <h2 className="text-[22px] font-medium leading-tight mb-2">
                                {widgetTitle || '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã –ß–µ–º –º—ã –º–æ–∂–µ–º –ø–æ–º–æ—á—å?'}
                              </h2>
                              <p className="text-[14px] opacity-60">
                                {widgetDescription || '–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤ —á–∞—Ç–µ —Å–≤–æ–π'}
                              </p>
                            </div>
                            
                            {/* –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" - –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ —Ñ–æ–Ω–æ–≤ */}
                            <div className="absolute bottom-[-34px] left-[20px] z-50">
                              <button 
                                onClick={() => {
                                  console.log('–ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" –Ω–∞–∂–∞—Ç–∞');
                                  setWidgetCurrentPage('chat');
                                }}
                                className={`w-[332px] h-[69px] rounded-[12px] border flex items-center justify-start px-4 transition-colors cursor-pointer ${
                                  widgetTheme === 'dark'
                                    ? 'bg-[#212121] border-white/10 hover:bg-[#3A3A3A]'
                                    : 'bg-white border-[#070F1A]/10 hover:bg-gray-50'
                                }`}
                              >
                                <div className="flex-1 text-left">
                                  <h3 className={`text-[14px] font-medium mb-1 ${
                                    widgetTheme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                                  }`}>
                                    {buttonTitle || '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'}
                                  </h3>
                                  <p className={`text-[13px] font-normal ${
                                    widgetTheme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
                                  }`}>
                                    {buttonDescription || '–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã, –º—ã –≤—Å–µ–≥–¥–∞ –ø–æ–º–æ–∂–µ–º'}
                                  </p>
                                </div>
                                <div 
                                  className="w-[20px] h-[20px]" 
                                  style={{ 
                                    backgroundColor: accentColor,
                                    mask: 'url(/send.svg) no-repeat center',
                                    maskSize: 'contain',
                                    WebkitMask: 'url(/send.svg) no-repeat center',
                                    WebkitMaskSize: 'contain'
                                  }}
                                />
                              </button>
                            </div>
                          </div>
                        )}
                        
                        {/* –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å */}
                        <div className={`flex-1 relative ${
                          widgetTheme === 'dark' ? 'bg-[#171717]' : 'bg-white'
                        }`}>
                          
                          {/* –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ì–ª–∞–≤–Ω–∞—è" */}
                          {widgetCurrentPage === 'home' && (
                            <div className="p-5 pt-[50px]">
                              
                              {/* –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã */}
                              <div className={`w-[332px] rounded-[12px] border mt-0 overflow-hidden ${
                                widgetTheme === 'dark' 
                                  ? 'bg-[#171717] border-white/10' 
                                  : 'bg-white border-[#070F1A]/10'
                              }`}>
                                {questions.filter(q => q.enabled).slice(0, 4).map((question, index) => (
                                  <div key={question.id}>
                                    <button
                                      onClick={() => {
                                        setWidgetCurrentPage('chat');
                                        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–∞
                                      }}
                                      className={`w-full h-[47px] flex items-center justify-between px-4 transition-colors ${
                                        widgetTheme === 'dark' ? 'hover:bg-white/5' : 'hover:bg-gray-50'
                                      }`}
                                    >
                                      <span className={`text-[13px] font-normal ${
                                        widgetTheme === 'dark' ? 'text-white/70' : 'text-[#070F1A]'
                                      }`}>
                                        {question.text}
                                      </span>
                                      <img src="/Bounds 2.svg" alt="Arrow" className="w-3 h-3" />
                                    </button>
                                    {index < questions.filter(q => q.enabled).slice(0, 4).length - 1 && (
                                      <div className={`mx-[15px] border-b ${
                                        widgetTheme === 'dark' ? 'border-white/10' : 'border-[#070F1A]/10'
                                      }`}></div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ß–∞—Ç" */}
                          {widgetCurrentPage === 'chat' && (
                            <div className="flex flex-col h-full">
                              {/* 1. –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å - –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ */}
                              <div className={`h-[58px] border-b flex items-center px-4 relative ${
                                widgetTheme === 'dark' ? 'border-white/10' : 'border-[#070F1A]/10'
                              }`}>
                                {/* –°—Ç—Ä–µ–ª–∫–∞ –Ω–∞–∑–∞–¥ */}
                                <img 
                                  src="/Frame 195.svg" 
                                  alt="–ù–∞–∑–∞–¥" 
                                  className="w-3 h-3 cursor-pointer" 
                                  onClick={() => setWidgetCurrentPage('home')}
                                />
                                
                                {/* –õ–æ–≥–æ—Ç–∏–ø */}
                                <div className="ml-[10px] w-[35px] h-[35px] rounded-[10px] overflow-hidden">
                                  {logoType === 'custom' && customLogo ? (
                                    <img src={customLogo} alt="Logo" className="w-full h-full object-contain" />
                                  ) : (
                                    <img src="/Group 1234.svg" alt="Logo" className="w-full h-full object-contain" />
                                  )}
                                </div>
                                
                                {/* –ò–º—è –ò–ò-–∞–≥–µ–Ω—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å */}
                                <div className="ml-[10px] flex flex-col">
                                  <span className={`text-[16px] font-normal ${
                                    widgetTheme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                                  }`}>{aiAgentName}</span>
                                  {showStatus && (
                                    <span className={`text-[11px] ${
                                      widgetTheme === 'dark' ? 'text-white/50' : 'text-[#8E8E93]'
                                    }`}>{statusText}</span>
                                  )}
                                </div>
                                
                                {/* –§–æ—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ */}
                                {managerPhotoType === 'add' && managerPhotos.length > 0 && (
                                  <div className="ml-auto mr-[10px] flex gap-[10px]">
                                    {managerPhotos.slice(0, 2).map((photo, index) => (
                                      <div key={index} className="w-[35px] h-[35px] rounded-[90px] overflow-hidden">
                                        <img src={photo} alt="–ú–µ–Ω–µ–¥–∂–µ—Ä" className="w-full h-full object-cover" />
                                      </div>
                                    ))}
                                  </div>
                                )}
                                
                                {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */}
                                <button
                                  onClick={() => setWidgetPreviewOpen(false)}
                                  className="absolute top-[15px] right-[15px] z-10 w-[18px] h-[18px] flex items-center justify-center hover:bg-white/10 rounded-[5px] transition-colors"
                                >
                                  <img src="/x-02.svg" alt="–ó–∞–∫—Ä—ã—Ç—å" className="w-[18px] h-[18px]" style={{ filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)', marginTop: '10px' }} />
                                </button>
                              </div>
                              
                              {/* 2. –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π */}
                              <div className="flex-1 p-4 overflow-y-auto relative widget-chat-container" style={{ flexBasis: 0 }}>
                                
                                {chatMessages.map((message, index) => {
                                  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ—Ç –ò–ò
                                  const isLastAIMessage = !message.isUser && 
                                    index === chatMessages.length - 1;
                                  
                                  return (
                                    <div key={message.id} className={`mb-4 ${message.isUser ? 'flex justify-end' : 'flex justify-start'}`}>
                                      <div className={`max-w-[80%] ${message.isUser ? 'order-2' : 'order-1'}`}>
                                        <div 
                                          className={`px-3 py-2 rounded-[16px] ${
                                            message.isUser 
                                              ? (widgetTheme === 'dark' ? 'text-[#171717]' : 'text-white')
                                              : widgetTheme === 'dark' ? 'text-white/70' : 'text-[#070F1A]'
                                          }`}
                                          style={{
                                            backgroundColor: message.isUser 
                                              ? (widgetTheme === 'dark' ? '#FFFFFF' : '#0084FF')
                                              : widgetTheme === 'dark' ? '#212121' : '#EFEFEF'
                                          }}
                                        >
                                          <p className="text-sm">{message.text}</p>
                                        </div>
                                        {!message.isUser && (
                                          <div className="mt-[5px] ml-3">
                                            <p className="text-[9px] text-[#8E8E93]">
                                              {aiAgentName} ‚Ä¢ {message.time}
                                            </p>
                                          </div>
                                        )}
                                        
                                        {/* –ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞ - —Ç–æ–ª—å–∫–æ —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ò–ò */}
                                        {isLastAIMessage && showCompletionButton && (
                                          <div className="mt-3 ml-3 space-y-2">
                                            <button
                                              onClick={() => {
                                                setShowCompletionButton(false);
                                                setShowHumanButton(false);
                                                sendWidgetIntentMessage('–≠—Ç–æ –ø–æ–º–æ–≥–ª–æ');
                                              }}
                                              className="h-[34px] px-[14px] rounded-[90px] text-[13px] font-[500] transition-all bg-transparent border border-[#070F1A]/10 text-[#8E8E93] hover:bg-[#F3F5F7]"
                                            >
                                              {selectedCompletionButton}
                                            </button>
                                          </div>
                                        )}
                                        
                                        {/* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞ - —Ç–æ–ª—å–∫–æ —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ò–ò */}
                                        {isLastAIMessage && showHumanButton && selectedHumanButton !== '–ù–µ—Ç' && (
                                          <div className="mt-3 ml-3">
                                            <button
                                              onClick={async () => {
                                                setShowHumanButton(false);
                                                await sendWidgetIntentMessage('–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
                                              }}
                                              className="h-[34px] px-[14px] rounded-[90px] text-[13px] font-[500] transition-all text-white"
                                              style={{ backgroundColor: accentColor }}
                                            >
                                              {selectedHumanButton}
                                            </button>
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                              
                              {/* 3. –ü–æ–ª–µ –≤–≤–æ–¥–∞ - –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –≤–Ω–∏–∑—É */}
                              <div className="p-4 flex-shrink-0">
                                {/* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–µ–π–±–ª "–ù–µ–π—Ä–æ—Å–µ—Ç—å AdaptoGPT" - —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç—É–º–±–ª–µ—Ä–æ–º */}
                                {showAILabel && (
                                  <div className="mb-2 text-center overflow-hidden">
                                    <span className="text-[9px] font-medium animate-flash">–ù–µ–π—Ä–æ—Å–µ—Ç—å AdaptoGPT</span>
                                  </div>
                                )}
                                
                                {/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */}
                                <div className="relative">
                                  <input
                                    type="text"
                                    value={currentMessage}
                                    onChange={(e) => setCurrentMessage(e.target.value)}
                                    onKeyPress={(e) => {
                                      if (e.key === 'Enter') {
                                        handleWidgetChatSendMessage();
                                      }
                                    }}
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                                    className={`w-full h-[40px] px-4 py-2 pr-[100px] rounded-[20px] border focus:outline-none focus:ring-0 text-[14px] ${
                                      widgetTheme === 'dark' 
                                        ? 'border-white/10 text-white bg-transparent' 
                                        : 'border-[#E5E7EB] text-[#070F1A]'
                                    }`}
                                  />
                                  <div className="absolute right-1 top-1/2 transform -translate-y-1/2 flex items-center gap-1">
                                    <button 
                                      className="w-[22px] h-[32px] flex items-center justify-center transition-colors"
                                      title="–î–æ–±–∞–≤–∏—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ"
                                    >
                                      <img src="/paperclip.svg" alt="–í–ª–æ–∂–µ–Ω–∏–µ" className="w-[18px] h-[18px] text-[#8E8E93] hover:text-[#070F1A] transition-colors" />
                                    </button>
                                    <button 
                                      onClick={handleWidgetChatSendMessage}
                                      className="w-[32px] h-[32px] rounded-[90px] flex items-center justify-center cursor-pointer transition-colors"
                                      style={{ backgroundColor: accentColor }}
                                      title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"
                                    >
                                      <img src="/Frame 118.svg" alt="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" className="w-[12px] h-[12px]" style={{ filter: 'brightness(0) saturate(100%) invert(100%)' }} />
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                        
                        {/* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é - —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */}
                        {widgetCurrentPage === 'home' && (
                          <div className={`h-[70px] border-t flex items-center justify-center relative ${
                            widgetTheme === 'dark' 
                              ? 'bg-[#171717] border-white/10' 
                              : 'bg-white border-gray-200'
                          }`}>
                          <div className="flex items-center gap-20">
                            <button 
                              onClick={() => setWidgetCurrentPage('home')}
                              className={`flex flex-col items-center gap-1 ${
                                widgetCurrentPage === 'home' ? 'text-[#8E8E93]' : 'text-[#8E8E93]'
                              }`}
                              style={{
                                color: widgetCurrentPage === 'home' ? accentColor : '#8E8E93'
                              }}
                            >
                              <div 
                                className="w-[17px] h-[17px]"
                                style={{ 
                                  backgroundColor: widgetCurrentPage === 'home' ? accentColor : '#8E8E93',
                                  mask: 'url(/house.svg) no-repeat center',
                                  maskSize: 'contain',
                                  WebkitMask: 'url(/house.svg) no-repeat center',
                                  WebkitMaskSize: 'contain'
                                }}
                              />
                              <span className="text-[14px] font-medium">–ì–ª–∞–≤–Ω–∞—è</span>
                            </button>
                            <button 
                              onClick={() => setWidgetCurrentPage('chat')}
                              className={`flex flex-col items-center gap-1 ${
                                widgetCurrentPage === 'chat' ? 'text-[#8E8E93]' : 'text-[#8E8E93]'
                              }`}
                              style={{
                                color: widgetCurrentPage === 'chat' ? accentColor : '#8E8E93'
                              }}
                            >
                              <img 
                                src="/Frame 147.svg" 
                                alt="Chat" 
                                className="w-[17px] h-[17px]"
                                style={{ 
                                  filter: widgetCurrentPage === 'chat' 
                                    ? `brightness(0) saturate(100%) invert(27%) sepia(96%) saturate(1456%) hue-rotate(${getHueFromColor(accentColor)}deg) brightness(101%) contrast(101%)`
                                    : 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)'
                                }}
                              />
                              <span className="text-[14px] font-medium">–ß–∞—Ç</span>
                            </button>
                          </div>
                          
                          {/* –õ–µ–π–±–ª "–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç Adapto" - —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */}
                          {widgetCurrentPage === 'home' && (
                            <div className="absolute top-[-29px] left-1/2 transform -translate-x-1/2">
                              <span className="text-[9px] font-medium animate-flash">–í–∏–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç Adapto</span>
                            </div>
                          )}
                          </div>
                        )}
                        
                        {/* –í—Å–ø–ª—ã–≤–∞—é—â–∞—è —Ñ–æ—Ä–º–∞ - –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫ –≤–∏–¥–∂–µ—Ç–∞ */}
                        {showForm && (
                          <div 
                            className="absolute inset-0 bg-black bg-opacity-40 flex items-end justify-center p-[10px] z-50"
                            onClick={() => {
                              setWidgetFormData({});
                              setPolicyAccepted(false);
                              setShowForm(false);
                            }}
                          >
                            <div 
                              className={`w-[351px] rounded-[15px] p-4 flex flex-col ${
                                widgetTheme === 'dark' ? 'bg-[#212121]' : 'bg-white'
                              }`}
                              style={{ 
                                minHeight: '212px',
                                maxHeight: '400px',
                                height: 'auto',
                                alignSelf: 'flex-end'
                              }}
                              onClick={(e) => e.stopPropagation()}
                            >
                              {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã */}
                              <div className="flex items-center justify-between mb-4">
                                <h3 className={`text-[16px] font-medium ${
                                  widgetTheme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                                }`}>{formTitle}</h3>
                                <button
                                  onClick={() => {
                                    setWidgetFormData({});
                                    setPolicyAccepted(false);
                                    setShowForm(false);
                                  }}
                                  className="w-[24px] h-[24px] flex items-center justify-center hover:bg-gray-100 rounded-[90px] transition-colors"
                                >
                                  <img src="/x-02.svg" alt="–ó–∞–∫—Ä—ã—Ç—å" className="w-[14px] h-[14px]" style={{ filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }} />
                                </button>
                              </div>
                              
                              {/* –ü–æ–ª—è —Ñ–æ—Ä–º—ã */}
                              <div className="space-y-[10px] overflow-y-auto max-h-[200px]">
                                {selectedFormFields.map((fieldType) => {
                                  const field = formFields.find(f => f.type === fieldType);
                                  if (!field) return null;
                                  
                                  return (
                                    <div key={field.id}>
                                      <input
                                        type={field.type === 'email' ? 'email' : field.type === 'phone' ? 'tel' : 'text'}
                                        placeholder={field.placeholder}
                                        value={widgetFormData[fieldType] || ''}
                                        onChange={(e) => setWidgetFormData({...widgetFormData, [fieldType]: e.target.value})}
                                        className={`w-[319px] h-[34px] px-3 border rounded-[10px] text-[14px] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20 ${
                                          widgetTheme === 'dark' 
                                            ? 'border-white/10 text-white bg-transparent' 
                                            : 'border-[#070F1A]/10 text-[#070F1A]'
                                        }`}
                                      />
                                    </div>
                                  );
                                })}
                              </div>
                              
                              {/* –°–æ–≥–ª–∞—Å–∏–µ —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π */}
                              <div className="mt-[10px] mb-4">
                                <div className="flex items-start gap-2">
                                  <input
                                    type="checkbox"
                                    id="policy-checkbox"
                                    checked={policyAccepted}
                                    onChange={(e) => setPolicyAccepted(e.target.checked)}
                                    className="mt-0.5 w-4 h-4 text-[#0084FF] bg-gray-100 border-gray-300 rounded focus:ring-[#0084FF] focus:ring-2"
                                  />
                                  <label htmlFor="policy-checkbox" className={`text-[12px] cursor-pointer ${
                                    widgetTheme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                                  }`}>
                                    –ù–∞–∂–∏–º–∞—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å{' '}
                                    <span className="underline" style={{ color: accentColor }}>
                                      –ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                                    </span>
                                  </label>
                                </div>
                              </div>
                              
                              {/* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */}
                              <button
                                onClick={async () => {
                                  if (isFormSubmitting) return;
                                  
                                  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                                  const requiredFields = selectedFormFields.filter(fieldType => {
                                    const field = formFields.find(f => f.type === fieldType);
                                    return field?.required;
                                  });
                                  
                                  const allRequiredFilled = requiredFields.every(fieldType => widgetFormData[fieldType]?.trim());
                                  
                                  if (allRequiredFilled && policyAccepted) {
                                    setIsFormSubmitting(true);
                                    
                                    try {
                                      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                                      const formSubmissionData = {
                                        timestamp: new Date().toISOString(),
                                        formData: widgetFormData,
                                        formFields: selectedFormFields.map(fieldType => {
                                          const field = formFields.find(f => f.type === fieldType);
                                          return {
                                            id: field?.id,
                                            type: fieldType,
                                            label: field?.label,
                                            value: widgetFormData[fieldType]
                                          };
                                        })
                                      };
                                      
                                      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ CRM (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ user_id)
                                      try {
                                        const { crmAPI } = await import('./crm_api_functions.js');
                                        const name = widgetFormData.name || widgetFormData.fullname || '–õ–∏–¥ —Å —Ñ–æ—Ä–º—ã';
                                        const email = widgetFormData.email || null;
                                        const phone = widgetFormData.phone || null;
                                        const comment = widgetFormData.comment || widgetFormData.message || '';

                                        const client = await crmAPI.createClient(currentUser.id, {
                                          name,
                                          email,
                                          phone,
                                          source: 'widget',
                                          extra: { formFields: formSubmissionData.formFields }
                                        });
                                        await crmAPI.createDeal(currentUser.id, {
                                          title: name ? `–ó–∞—è–≤–∫–∞: ${name}` : '–ó–∞—è–≤–∫–∞ —Å —Ñ–æ—Ä–º—ã',
                                          client_id: client?.id || null,
                                          status: 'new',
                                          description: comment || '–ó–∞—è–≤–∫–∞ –∏–∑ –≤–∏–¥–∂–µ—Ç–∞',
                                          channel: 'widget'
                                        });
                                      } catch (crmError) {
                                        console.error('CRM save error:', crmError);
                                      }
                                      
                                      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                                      setWidgetFormData({});
                                      setPolicyAccepted(false);
                                      setShowForm(false);
                                      
                                      // –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ —á–∞—Ç–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
                                      try {
                                        const successMsg = {
                                          id: getUniqueTimestamp(),
                                          text: '–û—Ç–ª–∏—á–Ω–æ, –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.',
                                          isUser: false,
                                          time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
                                          timestamp: getUniqueTimestamp()
                                        };
                                        setChatMessages(prev => [...prev, successMsg]);
                                        await chatHistoryAPI.saveMessage(currentUser.id, 'assistant', successMsg.text, 'widget');
                                      } catch (_) {}
                                      
                                      console.log('–§–æ—Ä–º–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:', formSubmissionData);
                                    } catch (error) {
                                      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã:', error);
                                    } finally {
                                      setIsFormSubmitting(false);
                                    }
                                  }
                                }}
                                disabled={isFormSubmitting}
                                className="w-full h-[40px] rounded-[10px] text-white font-medium text-[14px] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                style={{ backgroundColor: accentColor }}
                              >
                                {isFormSubmitting ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}
                              </button>
                      </div>
                    </div>
                  )}
                </div>
              </div>
                  )}
                  
                  {/* –î–æ–≥–æ–Ω—è—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                  {showFollowUpMessage && followUpMessagesEnabled && followUpMessages.length > 0 && !widgetPreviewOpen && (
                    <div 
                      className="absolute transition-all duration-300"
                      style={{
                        bottom: `${(widgetDevelopmentSettings.desktopBottomOffset || 20) + 62}px`, // 50px –∫–Ω–æ–ø–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ + 12px –∑–∞–∑–æ—Ä
                        right: `${(widgetDevelopmentSettings.desktopRightOffset || 20) + 40}px`, // –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
                        zIndex: (widgetDevelopmentSettings.zIndex || 9999) + 1
                      }}
                    >
                      {/* –ü–ª–∞—à–∫–∞ –¥–æ–≥–æ–Ω—è—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */}
                      <div className={`rounded-[12px] shadow-lg border p-4 max-w-[300px] relative ${
                        widgetTheme === 'dark' 
                          ? 'bg-[#171717] border-white/10' 
                          : 'bg-white border-gray-200'
                      }`}>
                        {/* –ö—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è */}
                        <button
                          onClick={() => setShowFollowUpMessage(false)}
                          className="absolute top-2 right-2 w-4 h-4 flex items-center justify-center text-gray-400 hover:text-gray-600 transition-colors"
                        >
                          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                            <path d="M9 3L3 9M3 3L9 9" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                          </svg>
                        </button>
                        
                        <p className={`text-[12px] mb-0 pr-6 ${
                          widgetTheme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                        }`}>
                          {followUpMessages[0].message || '–ü—Ä–æ–¥–æ–ª–∂–∏–º –¥–∏–∞–ª–æ–≥?'}
                        </p>
                      </div>

                      {/* –ö–Ω–æ–ø–∫–∞ –¥–æ–≥–æ–Ω—è—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø–æ–¥ –ø–ª–∞—à–∫–æ–π */}
                      <div className="mt-[10px] flex justify-end">
                        <button
                          onClick={() => {
                            setShowFollowUpMessage(false);
                            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                            handleWidgetOpen();
                            setCurrentMessage(followUpMessages[0].message || '–ü—Ä–æ–¥–æ–ª–∂–∏–º –¥–∏–∞–ª–æ–≥?');
                            setTimeout(() => {
                              handleWidgetChatSendMessage();
                            }, 100);
                          }}
                          className="h-[34px] px-[14px] rounded-[90px] text-[12px] font-[400] transition-all text-white"
                          style={{ backgroundColor: accentColor }}
                        >
                          {followUpMessages[0].buttonText || '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'}
                        </button>
                      </div>
                    </div>
                  )}
                  
                  {/* –¢—Ä–∏–≥–≥–µ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                  {showTriggerMessage && triggerMessagesEnabled && triggerMessages.length > 0 && !widgetPreviewOpen && (
                    <div 
                      className="absolute transition-all duration-300"
                      style={{
                        bottom: `${(widgetDevelopmentSettings.desktopBottomOffset || 20) + 62}px`, // 50px –∫–Ω–æ–ø–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ + 12px –∑–∞–∑–æ—Ä
                        right: `${(widgetDevelopmentSettings.desktopRightOffset || 20) + 40}px`, // –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
                        zIndex: (widgetDevelopmentSettings.zIndex || 9999) + 1
                      }}
                    >
                      {/* –ü–ª–∞—à–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */}
                      <div className="relative max-w-[300px]">
                        {/* –ö—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è */}
                        <button
                          onClick={() => setShowTriggerMessage(false)}
                          className="absolute -top-3 right-2 w-4 h-4 flex items-center justify-center rounded-full bg-black/10 hover:bg-black/20 transition-colors z-10"
                          style={{ color: '#8E8E93' }}
                        >
                          <svg width="10" height="10" viewBox="0 0 12 12" fill="none">
                            <path d="M9 3L3 9M3 3L9 9" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                          </svg>
                        </button>
                        
                        {/* –ü–ª–∞—à–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º */}
                        <div className={`h-10 px-[13px] flex items-center rounded-[10px_10px_0px_10px] w-fit max-w-[300px] mr-[23px] ${
                          widgetTheme === 'dark' ? 'bg-[#171717]' : 'bg-white'
                        }`}>
                          <p className={`text-[14px] font-[500] mb-0 w-fit ${
                            widgetTheme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                          }`} style={{ letterSpacing: '-0.02em' }}>
                            {triggerMessages[0].message || '–£ –Ω–∞—Å –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω–∞—è –∞–∫—Ü–∏—è'}
                          </p>
                        </div>

                        {/* –ö–Ω–æ–ø–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø–æ–¥ –ø–ª–∞—à–∫–æ–π */}
                        <div className="pt-2 px-[13px] pb-[13px] flex justify-end mr-[23px]">
                          <button
                            onClick={() => {
                              setShowTriggerMessage(false);
                              // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                              handleWidgetOpen();
                              setCurrentMessage(triggerMessages[0].buttonText || '–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ');
                              setTimeout(() => {
                                handleWidgetChatSendMessage();
                              }, 100);
                            }}
                            className="h-[34px] px-4 rounded-[90px] text-[12px] font-[500] transition-all text-white"
                            style={{ backgroundColor: accentColor, letterSpacing: '-0.02em' }}
                          >
                            {triggerMessages[0].buttonText || '–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ'}
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞ */}
            {showDeleteQuestionModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className={`rounded-[20px] p-6 max-w-md w-full mx-4 ${
                  theme === 'dark' ? 'bg-[#070F1A]' : 'bg-white'
                }`}>
                  <h3 className={`text-[18px] font-[500] mb-2 ${
                    theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                  }`}>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å?</h3>
                  <p className={`text-[14px] mb-6 ${
                    theme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
                  }`}>–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –µ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.</p>
                  <div className="flex gap-3 justify-end">
                    <button
                      onClick={() => {
                        setShowDeleteQuestionModal(false);
                        setQuestionToDelete(null);
                      }}
                      className={`px-4 py-2 text-[14px] font-[500] transition-colors ${
                        theme === 'dark' 
                          ? 'text-white/70 hover:text-white' 
                          : 'text-[#8E8E93] hover:text-[#070F1A]'
                      }`}
                    >
                      –û—Ç–º–µ–Ω–∞
                    </button>
                    <button
                      onClick={() => deleteQuestion(questionToDelete)}
                      className="px-4 py-2 bg-[#FF0D0D] text-white text-[14px] font-[500] rounded-[10px] hover:bg-[#E00D0D] transition-colors"
                    >
                      –£–¥–∞–ª–∏—Ç—å
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );

      case 'available-dialogs':
        const availableDialogs = dialogsData.filter(d => 
          (d.status === 'active' || d.status === 'waiting') && 
          (d.canTakeover || d.need_handover)
        );
        
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[20px] font-[500]">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏</h1>
              {availableDialogs.length > 0 && (
                <div className="bg-[#FF3B30] text-white text-[12px] font-[500] px-2 py-1 rounded-full">
                  {availableDialogs.length}
                </div>
              )}
            </div>
            
            {availableDialogs.length === 0 ? (
              <div className="bg-white rounded-[15px] p-8 border border-gray-200">
                <div className="text-center">
                  <svg className="w-8 h-8 mx-auto mb-4" fill="#0084FF" viewBox="0 0 24 24">
                    <path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"></path>
                  </svg>
                  <h3 className="text-[18px] font-[500] text-[#070F1A] mb-2">
                    –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
                  </h3>
                  <p className="text-[14px] text-[#8E8E93] max-w-md mx-auto">
                    –í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –¥–∏–∞–ª–æ–≥–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –ò–ò-–∞–≥–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–º–æ—â—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞. 
                    –ö–∞–∫ —Ç–æ–ª—å–∫–æ —Ç–∞–∫–∏–µ –¥–∏–∞–ª–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è, –≤—ã —Å–º–æ–∂–µ—Ç–µ –∏—Ö –≤–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É.
                  </p>
                </div>
              </div>
            ) : (
              <div className="space-y-4">
                {availableDialogs.map((dialog) => (
                  <div key={dialog.id} className="bg-white rounded-[15px] p-6 border border-gray-200">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-3">
                          <h3 className="text-[16px] font-[500] text-[#070F1A]">{dialog.title}</h3>
                          {dialog.need_handover && (
                            <div className="bg-[#FF3B30] text-white text-[10px] font-[500] px-2 py-1 rounded-full">
                              –ñ–¥—ë—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                            </div>
                          )}
                          <div className={`text-[10px] font-[500] px-2 py-1 rounded-full ${
                            dialog.status === 'active' ? 'bg-[#36C76A]/10 text-[#36C76A]' : 'bg-[#FF9500]/10 text-[#FF9500]'
                          }`}>
                            {dialog.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–û–∂–∏–¥–∞–µ—Ç'}
                          </div>
                        </div>
                        <p className="text-[14px] text-[#8E8E93] mb-4">{dialog.lastMessage}</p>
                        <div className="flex items-center gap-4 text-[12px] text-[#8E8E93]">
                          <span>–°–æ–∑–¥–∞–Ω: {new Date(dialog.createdAt).toLocaleString('ru-RU')}</span>
                          {dialog.client?.name && <span>–ö–ª–∏–µ–Ω—Ç: {dialog.client.name}</span>}
                        </div>
                      </div>
                      {dialog.assignedTo && dialog.assignedTo !== currentUser?.id ? (
                        <button
                          disabled
                          className="bg-gray-300 text-gray-500 px-4 h-[34px] rounded-[10px] cursor-not-allowed"
                        >
                          –ó–∞–Ω—è—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
                        </button>
                      ) : dialog.assignedTo === currentUser?.id ? (
                        <button
                          disabled
                          className="bg-[#0084FF] text-white px-4 h-[34px] rounded-[10px] cursor-default"
                        >
                          –í–∞—à –¥–∏–∞–ª–æ–≥
                        </button>
                      ) : (
                        <button
                          onClick={() => handleTakeoverDialog(dialog.id)}
                          className="bg-[#0084FF] text-white px-4 h-[34px] rounded-[10px] hover:bg-[#0070E6] transition-colors"
                          style={BUTTON_STYLES.blueButton}
                        >
                          –í–∑—è—Ç—å –¥–∏–∞–ª–æ–≥
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );

      case 'operator-statistics':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[20px] font-[500]">–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" style={{ paddingTop: '12px' }}>
                                 <Card className="shadow-none">
                <CardContent className="p-[15px] h-[130px] flex flex-col justify-between" style={{ paddingTop: '13px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                    <p className="text-[14px] font-[500] text-[#8E8E93]">–ú–æ–∏ –¥–∏–∞–ª–æ–≥–∏</p>
                  </div>
                  <div className="flex items-end">
                    <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>
                      {dialogsData.filter(d => d.assignedTo === (currentUser?.id || 'current_operator')).length}
                    </p>
                  </div>
                </CardContent>
              </Card>

                                 <Card className="shadow-none">
                <CardContent className="p-[15px] h-[130px] flex flex-col justify-between" style={{ paddingTop: '13px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                    <p className="text-[14px] font-[500] text-[#8E8E93]">–†–µ—à–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è</p>
                  </div>
                  <div className="flex items-end">
                    <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>
                      {dialogsData.filter(d => d.status === 'closed' && d.assignedTo === (currentUser?.id || 'current_operator')).length}
                    </p>
                  </div>
                </CardContent>
              </Card>

                                 <Card className="shadow-none">
                <CardContent className="p-[15px] h-[130px] flex flex-col justify-between" style={{ paddingTop: '13px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                    <p className="text-[14px] font-[500] text-[#8E8E93]">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</p>
                  </div>
                  <div className="flex items-end">
                    <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>0 –º–∏–Ω</p>
                  </div>
                </CardContent>
              </Card>

                                 <Card className="shadow-none">
                <CardContent className="p-[15px] h-[130px] flex flex-col justify-between" style={{ paddingTop: '13px' }}>
                      <div className="flex items-center gap-2" style={{ height: '21px' }}>
                    <p className="text-[14px] font-[500] text-[#8E8E93]">–†–µ–π—Ç–∏–Ω–≥</p>
                  </div>
                  <div className="flex items-end">
                    <p className="text-[1.8rem] font-[500] text-[#070F1A]" style={{ height: '33px' }}>4.8</p>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>
        );

      case 'team':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">–ö–æ–º–∞–Ω–¥–∞</h1>
            </div>
            
            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */}
            <div className="h-px bg-[#E5E7EB] mb-4" style={{ marginLeft: '-32px', marginRight: '-32px', marginTop: '16px' }}></div>
            
            {/* –ü–ª–∞—à–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ */}
            <div>
              <div className="flex items-center gap-3">
                <div className="flex-1">
                  <h3 className="text-[14px] font-medium text-[#070F1A] mb-3">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
                  <div className="flex items-center gap-3">
                    <input 
                      type="email" 
                      placeholder="–í–≤–µ–¥–∏—Ç–µ email —É—á–∞—Å—Ç–Ω–∏–∫–∞"
                      value={teamInviteEmail}
                      onChange={(e) => setTeamInviteEmail(e.target.value)}
                      className="flex-1 h-[34px] px-3 bg-white rounded-[10px] focus:outline-none"
                      style={INPUT_STYLES.inputField}
                    />
                    <button 
                      className={`h-[34px] px-4 rounded-[10px] transition-colors ${
                        teamInviteEmail.trim() === '' 
                          ? 'cursor-not-allowed' 
                          : 'hover:bg-[#0073E6] cursor-pointer'
                      }`}
                      style={teamInviteEmail.trim() === '' 
                        ? BUTTON_STYLES.disabledButton 
                        : { ...BUTTON_STYLES.blueButton, backgroundColor: '#0084FF', color: 'white' }
                      }
                      disabled={teamInviteEmail.trim() === ''}
                      onClick={() => {
                        if (teamInviteEmail.trim() !== '') {
                          handleInviteMember(teamInviteEmail.trim());
                        }
                      }}
                    >
                      –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* –¢–∞–±–ª–∏—Ü–∞ –∫–æ–º–∞–Ω–¥—ã */}
            <div className="overflow-hidden -mx-6">
              {/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã */}
              <div className="grid grid-cols-3 gap-4 px-[26px] py-4 border-b border-[#070F1A]/10">
                <div className="text-[14px] font-[500] text-[#070F1A]">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                <div className="text-[14px] font-[500] text-[#070F1A]"></div>
                <div className="text-[14px] font-[500] text-[#070F1A] text-right">–†–æ–ª—å</div>
              </div>
              
              {/* –°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã */}
              <div className="divide-y divide-[#070F1A]/10">
                {/* –ê–¥–º–∏–Ω */}
                <div className="grid grid-cols-3 gap-4 px-[26px] py-4 transition-colors">
                  <div className="flex items-center gap-3">
                    <div className="w-[24px] h-[24px] bg-[#0084FF] rounded-[90px] flex items-center justify-center flex-shrink-0">
                      <span className="text-white font-semibold text-xs">{generateAvatar(currentUser?.name).letter}</span>
                    </div>
                    <div>
                      <p className="text-[14px] font-[500] text-[#070F1A]">{currentUser?.name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}</p>
                      <p className="text-[12px] text-[#8E8E93]">{currentUser?.email || 'admin@example.com'}</p>
                    </div>
                  </div>
                  <div></div>
                  <div className="flex items-center justify-end">
                    <div className="flex items-center gap-2">
                      <div className="flex items-center gap-1">
                        <div className="w-[16px] h-[16px] bg-[#0084FF] rounded-[90px] flex items-center justify-center">
                          <div 
                            className="w-[10px] h-[10px]" 
                            style={{ 
                              maskImage: 'url(/profile-circle.svg)', 
                              maskSize: 'contain', 
                              maskRepeat: 'no-repeat', 
                              maskPosition: 'center',
                              backgroundColor: 'white'
                            }} 
                          />
                        </div>
                        <span className="text-[12px] font-[500] text-[#070F1A]">–ê–¥–º–∏–Ω</span>
                      </div>
                      <div className="relative">
                        <button 
                          className="w-[14px] h-[14px] text-[#8E8E93] hover:text-[#070F1A] transition-colors opacity-50 cursor-not-allowed"
                          disabled
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14">
                            <path d="M 1.5 5.5 C 2.328 5.5 3 6.172 3 7 C 3 7.828 2.328 8.5 1.5 8.5 C 0.672 8.5 0 7.828 0 7 C 0 6.172 0.672 5.5 1.5 5.5 Z M 12.5 5.5 C 13.328 5.5 14 6.172 14 7 C 14 7.828 13.328 8.5 12.5 8.5 C 11.672 8.5 11 7.828 11 7 C 11 6.172 11.672 5.5 12.5 5.5 Z M 7 5.5 C 7.828 5.5 8.5 6.172 8.5 7 C 8.5 7.828 7.828 8.5 7 8.5 C 6.172 8.5 5.5 7.828 5.5 7 C 5.5 6.172 6.172 5.5 7 5.5 Z" fill="currentColor"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                {/* –û–ø–µ—Ä–∞—Ç–æ—Ä */}
                <div className="grid grid-cols-3 gap-4 px-[26px] py-4 transition-colors">
                  <div className="flex items-center gap-3">
                    <div className="w-[24px] h-[24px] bg-[#36C76A] rounded-[90px] flex items-center justify-center flex-shrink-0">
                      <span className="text-white font-semibold text-xs">–¢</span>
                    </div>
                    <div>
                      <p className="text-[14px] font-[500] text-[#070F1A]">{currentUser?.name || '–û–ø–µ—Ä–∞—Ç–æ—Ä'}</p>
                      <p className="text-[12px] text-[#8E8E93]">{currentUser?.email || 'operator@example.com'}</p>
                    </div>
                  </div>
                  <div></div>
                  <div className="flex items-center justify-end">
                    <div className="flex items-center gap-2">
                      <div className="flex items-center gap-1">
                        <div className="w-[16px] h-[16px] bg-[#A684FF] rounded-[90px] flex items-center justify-center">
                          <div 
                            className="w-[10px] h-[10px]" 
                            style={{ 
                              maskImage: 'url(/headphone.svg)', 
                              maskSize: 'contain', 
                              maskRepeat: 'no-repeat', 
                              maskPosition: 'center',
                              backgroundColor: 'white'
                            }} 
                          />
                        </div>
                        <span className="text-[12px] font-[500] text-[#070F1A]">–û–ø–µ—Ä–∞—Ç–æ—Ä</span>
                      </div>
                      <div className="relative">
                        <button 
                          className="w-[14px] h-[14px] text-[#8E8E93] hover:text-[#070F1A] transition-colors"
                          onClick={() => setTeamDropdownOpen(teamDropdownOpen === 'operator' ? null : 'operator')}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14">
                            <path d="M 1.5 5.5 C 2.328 5.5 3 6.172 3 7 C 3 7.828 2.328 8.5 1.5 8.5 C 0.672 8.5 0 7.828 0 7 C 0 6.172 0.672 5.5 1.5 5.5 Z M 12.5 5.5 C 13.328 5.5 14 6.172 14 7 C 14 7.828 13.328 8.5 12.5 8.5 C 11.672 8.5 11 7.828 11 7 C 11 6.172 11.672 5.5 12.5 5.5 Z M 7 5.5 C 7.828 5.5 8.5 6.172 8.5 7 C 8.5 7.828 7.828 8.5 7 8.5 C 6.172 8.5 5.5 7.828 5.5 7 C 5.5 6.172 6.172 5.5 7 5.5 Z" fill="currentColor"/>
                          </svg>
                        </button>
                        {teamDropdownOpen === 'operator' && (
                          <div className="absolute right-0 top-6 bg-white border border-[#E5E7EB] rounded-[10px] shadow-lg z-[9999] w-[100px]">
                            <button
                              className="w-full h-[34px] px-3 text-left text-[13px] text-red-600 hover:bg-red-50 rounded-[10px] transition-colors flex items-center gap-2"
                              onClick={() => {
                                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                                setTeamDropdownOpen(null);
                              }}
                            >
                              <img src="/traash.svg" alt="–£–¥–∞–ª–∏—Ç—å" className="w-4 h-4" />
                              –£–¥–∞–ª–∏—Ç—å
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );

      case 'operator-stats':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</h1>
            </div>
            
            {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */}
            <div className="h-px bg-[#E5E7EB] mb-4" style={{ marginLeft: '-32px', marginRight: '-32px', marginTop: '16px' }}></div>
            
            {/* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div className="bg-white rounded-[16px] p-6 border border-[#E5E7EB]">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-[14px] font-[500] text-[#070F1A]">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–∏–∞–ª–æ–≥–æ–≤</h3>
                  <div className="w-8 h-8 bg-[#0084FF]/10 rounded-[8px] flex items-center justify-center">
                    <img src="/chat.svg" alt="–î–∏–∞–ª–æ–≥–∏" className="w-4 h-4" />
                  </div>
                </div>
                <div className="text-[24px] font-[600] text-[#070F1A] mb-1">24</div>
                <div className="text-[12px] text-[#8E8E93]">+3 –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
              </div>
              
              <div className="bg-white rounded-[16px] p-6 border border-[#E5E7EB]">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-[14px] font-[500] text-[#070F1A]">–ó–∞–≤–µ—Ä—à–µ–Ω–æ –¥–∏–∞–ª–æ–≥–æ–≤</h3>
                  <div className="w-8 h-8 bg-[#36C76A]/10 rounded-[8px] flex items-center justify-center">
                    <img src="/check.svg" alt="–ó–∞–≤–µ—Ä—à–µ–Ω–æ" className="w-4 h-4" />
                  </div>
                </div>
                <div className="text-[24px] font-[600] text-[#070F1A] mb-1">18</div>
                <div className="text-[12px] text-[#8E8E93]">75% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
              </div>
              
              <div className="bg-white rounded-[16px] p-6 border border-[#E5E7EB]">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-[14px] font-[500] text-[#070F1A]">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</h3>
                  <div className="w-8 h-8 bg-[#FF9500]/10 rounded-[8px] flex items-center justify-center">
                    <img src="/clock.svg" alt="–í—Ä–µ–º—è" className="w-4 h-4" />
                  </div>
                </div>
                <div className="text-[24px] font-[600] text-[#070F1A] mb-1">2:34</div>
                <div className="text-[12px] text-[#8E8E93]">–º–∏–Ω—É—Ç—ã</div>
              </div>
              
              <div className="bg-white rounded-[16px] p-6 border border-[#E5E7EB]">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-[14px] font-[500] text-[#070F1A]">–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å</h3>
                  <div className="w-8 h-8 bg-[#A684FF]/10 rounded-[8px] flex items-center justify-center">
                    <img src="/star.svg" alt="–û—Ü–µ–Ω–∫–∞" className="w-4 h-4" />
                  </div>
                </div>
                <div className="text-[24px] font-[600] text-[#070F1A] mb-1">4.8</div>
                <div className="text-[12px] text-[#8E8E93]">–∏–∑ 5.0</div>
              </div>
            </div>
            
            {/* –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */}
            <div className="bg-white rounded-[16px] p-6 border border-[#E5E7EB]">
              <h3 className="text-[16px] font-[500] text-[#070F1A] mb-4">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º</h3>
              <div className="h-64 flex items-end justify-between gap-2">
                {[12, 8, 15, 22, 18, 25, 20].map((height, index) => (
                  <div key={index} className="flex flex-col items-center gap-2">
                    <div 
                      className="w-8 bg-[#0084FF] rounded-t-[4px]"
                      style={{ height: `${(height / 25) * 200}px` }}
                    ></div>
                    <span className="text-[10px] text-[#8E8E93]">
                      {['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'][index]}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );

      case 'crm':
        return (
          <div className="space-y-6">
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ */}
            <div className="flex justify-between items-center mb-[16px]">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">CRM</h1>
              <div className="flex gap-3">
                {/* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ */}
                <button 
                  onClick={() => setCreateDealModalOpen(true)}
                  className="h-[34px] bg-[#0084FF] text-white rounded-[10px] px-4 flex items-center gap-2 hover:bg-[#0073E6] transition-colors"
                  style={BUTTON_STYLES.blueButton}
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
                </button>
                
                {/* –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è */}
                <div className="relative group">
                  <button className="h-[34px] bg-white border border-[#E5E7EB] text-[#070F1A] font-[500] rounded-[10px] text-[13px] px-4 flex items-center gap-2 hover:bg-gray-50 transition-colors">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 15.75L8.25 12L9.66 10.59L11.25 12.18V3H12.75V12.18L14.34 10.59L15.75 12L12 15.75Z" fill="currentColor"/>
                      <path d="M20.25 15.75V18.75C20.25 19.1642 19.9142 19.5 19.5 19.5H4.5C4.08579 19.5 3.75 19.1642 3.75 18.75V15.75H2.25V18.75C2.25 19.9926 3.25736 21 4.5 21H19.5C20.7426 21 21.75 19.9926 21.75 18.75V15.75H20.25Z" fill="currentColor"/>
                    </svg>
                    –°–∫–∞—á–∞—Ç—å
                  </button>
                  {/* Dropdown –º–µ–Ω—é */}
                  <div className="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-[10px] shadow-lg py-1 z-10 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                    <button 
                      onClick={exportCRMToXLS}
                      className="w-full px-4 py-2 text-[12px] text-[#070F1A] hover:bg-gray-50 text-left"
                    >
                      –°–∫–∞—á–∞—Ç—å –≤ Excel
                    </button>
                    <button 
                      onClick={exportCRMToCSV}
                      className="w-full px-4 py-2 text-[12px] text-[#070F1A] hover:bg-gray-50 text-left"
                    >
                      –°–∫–∞—á–∞—Ç—å CSV
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div className="border-b border-gray-200 mb-0" style={{ borderColor: '#E5E6E7', marginTop: '16px', marginLeft: '-32px', marginRight: '-32px' }}></div>

            {/* –¢–∞–±—ã */}
            <div className="flex items-center gap-0 bg-[#F2F3F4] rounded-[10px] w-full max-w-[400px]" style={{ height: '40px', padding: '3px' }}>
              <button 
                className={`flex-1 px-5 rounded-[9px] text-[13px] font-medium transition-colors ${
                  crmActiveTab === 'deals' 
                    ? 'bg-white text-[#0084FF]' 
                    : 'text-[#8E8E93] hover:text-[#0084FF]'
                }`}
                style={{ height: '34px' }}
                onClick={() => setCrmActiveTab('deals')}
              >
                –°–¥–µ–ª–∫–∏
              </button>
              <button 
                className={`flex-1 px-5 rounded-[9px] text-[13px] font-medium transition-colors ${
                  crmActiveTab === 'tasks' 
                    ? 'bg-white text-[#0084FF]' 
                    : 'text-[#8E8E93] hover:text-[#0084FF]'
                }`}
                style={{ height: '34px' }}
                onClick={() => setCrmActiveTab('tasks')}
              >
                –ó–∞–¥–∞—á–∏
              </button>
              <button 
                className={`flex-1 px-5 rounded-[9px] text-[13px] font-medium transition-colors ${
                  crmActiveTab === 'clients' 
                    ? 'bg-white text-[#0084FF]' 
                    : 'text-[#8E8E93] hover:text-[#0084FF]'
                }`}
                style={{ height: '34px' }}
                onClick={() => setCrmActiveTab('clients')}
              >
                –ö–ª–∏–µ–Ω—Ç—ã
              </button>
            </div>

            {/* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
            <div className="flex justify-between items-center flex-wrap gap-[10px]">
              {/* –§–∏–ª—å—Ç—Ä—ã —Å–ª–µ–≤–∞ */}
              <div className="flex gap-[10px] flex-wrap order-1">

                {/* –§–∏–ª—å—Ç—Ä—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–¥–µ–ª–æ–∫ –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ */}
                {crmActiveTab !== 'tasks' && (
                  <>
                {/* –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –ª–∏–¥–∞ */}
                <div className="relative crm-dropdown">
                  <button
                    onClick={() => toggleCrmDropdown('leadQuality')}
                    className="h-[34px] pl-3 pr-3 bg-white rounded-[10px] text-[13px] flex items-center gap-[8px] hover:bg-white transition-colors group"
                  >
                    <span className="text-[#8E8E93] group-hover:text-[#070F1A] transition-colors">
                      –õ–∏–¥—ã
                    </span>
                    <img src="/Bounds.svg" alt="–†–∞—Å–∫—Ä—ã—Ç—å" className="w-2 h-2 transition-transform duration-300" style={{ 
                      filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)',
                      transform: crmDropdowns.leadQuality ? 'rotate(-90deg)' : 'rotate(90deg)'
                    }} />
                  </button>
                  
                  {crmDropdowns.leadQuality && (
                    <div className="absolute top-full left-0 mt-1 bg-white rounded-[12px] shadow-lg z-50 min-w-[160px]">
                      <div className="p-[2px]">
                        <div className="space-y-1">
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmLeadQualityFilter([]);
                              setCrmDropdowns(prev => ({...prev, leadQuality: false}));
                            }}
                          >
                            {crmLeadQualityFilter.length === 0 && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <div className="w-4 h-4 bg-gray-100 rounded-[4px]"></div>
                            <span className="text-[13px] text-[#070F1A]">–í—Å–µ –ª–∏–¥—ã</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmLeadQualityFilter(prev => 
                                prev.includes('hot') 
                                  ? prev.filter(item => item !== 'hot')
                                  : [...prev, 'hot']
                              );
                            }}
                          >
                            {crmLeadQualityFilter.includes('hot') && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <div className="w-4 h-4 rounded-[4px]" style={{ backgroundColor: '#FE6A51' }}></div>
                            <span className="text-[13px] text-[#070F1A]">–ì–æ—Ä—è—á–∏–µ</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmLeadQualityFilter(prev => 
                                prev.includes('warm') 
                                  ? prev.filter(item => item !== 'warm')
                                  : [...prev, 'warm']
                              );
                            }}
                          >
                            {crmLeadQualityFilter.includes('warm') && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <div className="w-4 h-4 rounded-[4px]" style={{ backgroundColor: '#FFC340' }}></div>
                            <span className="text-[13px] text-[#070F1A]">–¢–µ–ø–ª—ã–µ</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmLeadQualityFilter(prev => 
                                prev.includes('cold') 
                                  ? prev.filter(item => item !== 'cold')
                                  : [...prev, 'cold']
                              );
                            }}
                          >
                            {crmLeadQualityFilter.includes('cold') && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <div className="w-4 h-4 rounded-[4px]" style={{ backgroundColor: '#0099FF' }}></div>
                            <span className="text-[13px] text-[#070F1A]">–•–æ–ª–æ–¥–Ω—ã–µ</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º */}
                <div className="relative crm-dropdown">
                  <button
                    onClick={() => toggleCrmDropdown('contact')}
                    className="h-[34px] pl-3 pr-3 bg-white rounded-[10px] text-[13px] flex items-center gap-[8px] hover:bg-white transition-colors group"
                  >
                    <span className="text-[#8E8E93] group-hover:text-[#070F1A] transition-colors">
                      –ö–æ–Ω—Ç–∞–∫—Ç—ã
                    </span>
                    <img src="/Bounds.svg" alt="–†–∞—Å–∫—Ä—ã—Ç—å" className="w-2 h-2 transition-transform duration-300" style={{ 
                      filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)',
                      transform: crmDropdowns.contact ? 'rotate(-90deg)' : 'rotate(90deg)'
                    }} />
                  </button>
                  
                  {crmDropdowns.contact && (
                    <div className="absolute top-full left-0 mt-1 bg-white rounded-[12px] shadow-lg z-50 min-w-[160px]">
                      <div className="p-[2px]">
                        <div className="space-y-1">
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmContactFilter('all');
                              setCrmDropdowns(prev => ({...prev, contact: false}));
                            }}
                          >
                            {crmContactFilter === 'all' && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <div className="w-4 h-4 bg-gray-100 rounded-[4px]"></div>
                            <span className="text-[13px] text-[#070F1A]">–í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmContactFilter('with_contacts');
                              setCrmDropdowns(prev => ({...prev, contact: false}));
                            }}
                          >
                            {crmContactFilter === 'with_contacts' && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <img src="/Icon phone.svg" alt="–¢–µ–ª–µ—Ñ–æ–Ω" className="w-[13px] h-[13px]" style={phoneIconGreenStyle} />
                            <span className="text-[13px] text-[#070F1A]">–ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmContactFilter('without_contacts');
                              setCrmDropdowns(prev => ({...prev, contact: false}));
                            }}
                          >
                            {crmContactFilter === 'without_contacts' && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <img src="/Icon nophone.svg" alt="–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞" className="w-[13px] h-[13px]" />
                            <span className="text-[13px] text-[#070F1A]">–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* –§–∏–ª—å—Ç—Ä –ø–æ –≤–ª–∞–¥–µ–ª—å—Ü—É */}
                <div className="relative crm-dropdown">
                  <button
                    onClick={() => toggleCrmDropdown('owner')}
                    className="h-[34px] pl-3 pr-3 bg-white rounded-[10px] text-[13px] flex items-center gap-[8px] hover:bg-white transition-colors group"
                  >
                    <span className="text-[#8E8E93] group-hover:text-[#070F1A] transition-colors">
                      –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏
                    </span>
                    <img src="/Bounds.svg" alt="–†–∞—Å–∫—Ä—ã—Ç—å" className="w-2 h-2 transition-transform duration-300" style={{ 
                      filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)',
                      transform: crmDropdowns.owner ? 'rotate(-90deg)' : 'rotate(90deg)'
                    }} />
                  </button>
                  
                  {crmDropdowns.owner && (
                    <div className="absolute top-full left-0 mt-1 bg-white rounded-[12px] shadow-lg z-50 min-w-[180px]">
                      <div className="p-[2px]">
                        <div className="space-y-1">
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmOwnerFilter([]);
                              setCrmDropdowns(prev => ({...prev, owner: false}));
                            }}
                          >
                            {crmOwnerFilter.length === 0 && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <div className="w-4 h-4 bg-gray-100 rounded-[4px]"></div>
                            <span className="text-[13px] text-[#070F1A]">–í—Å–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmOwnerFilter(prev => 
                                prev.includes('ai') 
                                  ? prev.filter(item => item !== 'ai')
                                  : [...prev, 'ai']
                              );
                            }}
                          >
                            {crmOwnerFilter.includes('ai') && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <img src="/aiii.svg" alt="–ò–ò" className="w-[13px] h-[13px] align-middle" />
                            <span className="text-[13px] text-[#070F1A]">–ò–ò-–∞–≥–µ–Ω—Ç</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmOwnerFilter(prev => 
                                prev.includes('operator-1') 
                                  ? prev.filter(item => item !== 'operator-1')
                                  : [...prev, 'operator-1']
                              );
                            }}
                          >
                            {crmOwnerFilter.includes('operator-1') && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                              </svg>
                            )}
                            <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-[13px] h-[13px]" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                            <span className="text-[13px] text-[#070F1A]">–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmOwnerFilter(prev => 
                                prev.includes('operator-2') 
                                  ? prev.filter(item => item !== 'operator-2')
                                  : [...prev, 'operator-2']
                              );
                            }}
                          >
                            <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-[13px] h-[13px]" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                            <span className="text-[13px] text-[#070F1A]">–ú–∏—Ö–∞–∏–ª –ò–≤–∞–Ω–æ–≤</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                  </>
                )}
              </div>

              {/* –ü–ª–∞—à–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */}
              {crmActiveTab !== 'tasks' && (
              <div className="flex flex-wrap gap-2 mt-[10px] order-3 w-full">
                {crmLeadQualityFilter.map(quality => (
                  <div key={quality} className="flex items-center gap-2 bg-[#F2F3F4] rounded-[10px] px-2 py-2 h-[32px]">
                    <div className="w-[13px] h-[13px] rounded-[4px]" style={{ backgroundColor: quality === 'hot' ? '#FE6A51' : (quality === 'warm' ? '#FFC340' : '#0099FF') }}></div>
                    <p className="text-[13px] text-[#070F1A]">
                      {quality === 'hot' ? '–ì–æ—Ä—è—á–∏–µ' :
                       quality === 'warm' ? '–¢–µ–ø–ª—ã–µ' : '–•–æ–ª–æ–¥–Ω—ã–µ'}
                    </p>
                    <button 
                      onClick={() => setCrmLeadQualityFilter(prev => prev.filter(item => item !== quality))}
                      className="w-4 h-4 flex items-center justify-center transition-colors"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14">
                        <path d="M 9.828 3.111 C 10.121 2.818 10.596 2.818 10.889 3.111 C 11.182 3.404 11.182 3.879 10.889 4.172 L 8.061 7 L 10.889 9.828 C 11.182 10.121 11.182 10.596 10.889 10.889 C 10.596 11.182 10.121 11.182 9.828 10.889 L 7 8.061 L 4.172 10.889 C 3.879 11.182 3.404 11.182 3.111 10.889 C 2.818 10.596 2.818 10.121 3.111 9.828 L 5.939 7 L 3.111 4.172 C 2.818 3.879 2.818 3.404 3.111 3.111 C 3.404 2.818 3.879 2.818 4.172 3.111 L 7 5.939 Z" fill="#8E8E93" className="hover:fill-[#070F1A] transition-colors"></path>
                      </svg>
                    </button>
                  </div>
                ))}
                
                {crmContactFilter !== 'all' && (
                  <div className="flex items-center gap-2 bg-[#F2F3F4] rounded-[10px] px-2 py-2 h-[32px]">
                    {crmContactFilter === 'with_contacts' ? (
                      <img src="/Icon phone.svg" alt="–¢–µ–ª–µ—Ñ–æ–Ω" className="w-[13px] h-[13px]" style={phoneIconGreenStyle} />
                    ) : (
                      <img src="/Icon nophone.svg" alt="–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞" className="w-[13px] h-[13px]" style={{ 
                        filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)'
                      }} />
                    )}
                    <p className="text-[13px] text-[#070F1A]">
                      {crmContactFilter === 'with_contacts' ? '–ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã' : '–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤'}
                    </p>
                    <button 
                      onClick={() => setCrmContactFilter('all')}
                      className="w-4 h-4 flex items-center justify-center transition-colors"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14">
                        <path d="M 9.828 3.111 C 10.121 2.818 10.596 2.818 10.889 3.111 C 11.182 3.404 11.182 3.879 10.889 4.172 L 8.061 7 L 10.889 9.828 C 11.182 10.121 11.182 10.596 10.889 10.889 C 10.596 11.182 10.121 11.182 9.828 10.889 L 7 8.061 L 4.172 10.889 C 3.879 11.182 3.404 11.182 3.111 10.889 C 2.818 10.596 2.818 10.121 3.111 9.828 L 5.939 7 L 3.111 4.172 C 2.818 3.879 2.818 3.404 3.111 3.111 C 3.404 2.818 3.879 2.818 4.172 3.111 L 7 5.939 Z" fill="#8E8E93" className="hover:fill-[#070F1A] transition-colors"></path>
                      </svg>
                    </button>
                  </div>
                )}

                {crmOwnerFilter.map(owner => (
                  <div key={owner} className="flex items-center gap-2 bg-[#F2F3F4] rounded-[10px] px-2 py-2 h-[32px]">
                    {owner === 'ai' ? (
                      <img src="/aiii.svg" alt="–ò–ò" className="w-[13px] h-[13px]" />
                    ) : (
                      <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-[13px] h-[13px]" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                    )}
                    <p className="text-[13px] text-[#070F1A]">
                      {owner === 'ai' ? '–ò–ò-–∞–≥–µ–Ω—Ç' : owner === 'operator-1' ? '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' : owner === 'operator-2' ? '–ú–∏—Ö–∞–∏–ª –ò–≤–∞–Ω–æ–≤' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å'}
                    </p>
                    <button 
                      onClick={() => setCrmOwnerFilter(prev => prev.filter(item => item !== owner))}
                      className="w-4 h-4 flex items-center justify-center transition-colors"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14">
                        <path d="M 9.828 3.111 C 10.121 2.818 10.596 2.818 10.889 3.111 C 11.182 3.404 11.182 3.879 10.889 4.172 L 8.061 7 L 10.889 9.828 C 11.182 10.121 11.182 10.596 10.889 10.889 C 10.596 11.182 10.121 11.182 9.828 10.889 L 7 8.061 L 4.172 10.889 C 3.879 11.182 3.404 11.182 3.111 10.889 C 2.818 10.596 2.818 10.121 3.111 9.828 L 5.939 7 L 3.111 4.172 C 2.818 3.879 2.818 3.404 3.111 3.111 C 3.404 2.818 3.879 2.818 4.172 3.111 L 7 5.939 Z" fill="#8E8E93" className="hover:fill-[#070F1A] transition-colors"></path>
                      </svg>
                    </button>
                  </div>
                ))}
              </div>
              )}

              {/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –≤–∏–¥ */}
              <div className="flex gap-[10px] items-center order-2 ml-auto">
                {/* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */}
                <div className="relative crm-dropdown">
                  <button
                    onClick={() => toggleCrmDropdown('sortOrder')}
                    className="h-[34px] px-3 bg-white rounded-[10px] text-[13px] flex items-center gap-[8px] hover:bg-[#F2F3F4] transition-colors group"
                    onMouseEnter={(e) => {
                      const img = (e.currentTarget.querySelector('img') as HTMLImageElement);
                      if (img) { img.style.filter = 'brightness(0) saturate(100%)'; img.style.opacity = '1'; }
                    }}
                    onMouseLeave={(e) => {
                      const img = (e.currentTarget.querySelector('img') as HTMLImageElement);
                      if (img) { img.style.filter = 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)'; img.style.opacity = '0.8'; }
                    }}
                  >
                    <img src="/Frame 2089.svg" alt="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å" className="w-4 h-4 transition-colors" style={{ 
                      filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)',
                      opacity: 0.8
                    }} />
                    <span className="text-[#8E8E93] group-hover:text-[#070F1A] transition-colors">
                      –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </span>
                  </button>
                  
                  {crmDropdowns.sortOrder && (
                    <div className="absolute top-full right-0 mt-1 bg-white rounded-[12px] shadow-lg z-50 min-w-[160px]">
                      <div className="p-[2px]">
                        <div className="space-y-1">
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmSortOrder('newest');
                              setCrmDropdowns(prev => ({...prev, sortOrder: false}));
                            }}
                          >
                            <div className="w-4 h-4 bg-gray-100 rounded-[4px] flex items-center justify-center">
                              {crmSortOrder === 'newest' && (
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12">
                                  <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                                </svg>
                              )}
                            </div>
                            <span className="text-[13px] text-[#070F1A]">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setCrmSortOrder('oldest');
                              setCrmDropdowns(prev => ({...prev, sortOrder: false}));
                            }}
                          >
                            <div className="w-4 h-4 bg-gray-100 rounded-[4px] flex items-center justify-center">
                              {crmSortOrder === 'oldest' && (
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12">
                                  <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                                </svg>
                              )}
                          </div>
                            <span className="text-[13px] text-[#070F1A]">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</span>
                        </div>
                      </div>
                    </div>
                </div>
                  )}
                </div>

                {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ */}
                <div className="flex bg-[#F2F3F4] rounded-[10px] p-[2px]" style={{ height: '34px' }}>
                  <button 
                    className={`px-2 py-[2px] rounded-[8px] transition-colors ${
                      crmViewMode === 'kanban' 
                        ? 'bg-white' 
                        : 'text-[#8E8E93] hover:text-[#070F1A]'
                    }`}
                    style={{ height: '30px' }}
                    onClick={() => setCrmViewMode('kanban')}
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 6H21V8H3V6ZM3 11H21V13H3V11ZM3 16H21V18H3V16Z" fill="currentColor"/>
                    </svg>
                  </button>
                  <button 
                    className={`px-2 py-[2px] rounded-[8px] transition-colors ${
                      crmViewMode === 'list' 
                        ? 'bg-white' 
                        : 'text-[#8E8E93] hover:text-[#070F1A]'
                    }`}
                    style={{ height: '30px' }}
                    onClick={() => setCrmViewMode('list')}
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M8 6H21V8H8V6ZM8 11H21V13H8V11ZM8 16H21V18H8V16ZM3 6H5V8H3V6ZM3 11H5V13H3V11ZM3 16H5V18H3V16Z" fill="currentColor"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            {/* –ö–æ–Ω—Ç–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∞–±–∞ */}
            {crmActiveTab === 'deals' && (
              <div className="space-y-4">
                {crmViewMode === 'kanban' ? (
                  <div className="grid grid-cols-4 gap-4">
                    {/* –ö–æ–ª–æ–Ω–∫–∏ –≤–æ—Ä–æ–Ω–∫–∏ */}
                    {['–ù–æ–≤—ã–µ', '–í —Ä–∞–±–æ—Ç–µ', '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ', '–ó–∞–∫—Ä—ã—Ç—ã–µ'].map((stage, index) => (
                      <div 
                        key={stage} 
                        className={`bg-[#F2F3F4] rounded-[15px] p-[5px] transition-colors ${
                          dragOverColumn === stage ? 'bg-[#E3F2FD] border-2 border-[#0084FF]' : ''
                        }`}
                        onDragOver={(e) => {
                          e.preventDefault();
                          e.dataTransfer.dropEffect = 'move';
                          setDragOverColumn(stage);
                        }}
                        onDragLeave={() => {
                          setDragOverColumn(null);
                        }}
                        onDrop={(e) => {
                          e.preventDefault();
                          if (draggedDeal && draggedDeal.stage !== stage) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞–¥–∏—é —Å–¥–µ–ª–∫–∏
                            updateDealStage(draggedDeal.id, stage);
                            console.log(`–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ ${draggedDeal.title} –≤ ${stage}`);
                            // TODO: –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç API –≤—ã–∑–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
                          }
                          setDraggedDeal(null);
                          setDragOverColumn(null);
                        }}
                      >
                        <div className="flex items-center justify-between mb-4 mx-4" style={{
                          paddingTop: '9px',
                          marginLeft: '10px',
                          marginRight: '10px'
                        }}>
                          <h3 className="text-[14px] font-[500] text-[#070F1A]">{stage}</h3>
                          <span className="text-[12px] text-[#8E8E93] bg-white px-2 py-1 rounded-[6px]">
                            {getFilteredDeals().filter(deal => deal.stage === stage).length}
                          </span>
                        </div>
                        <div className="space-y-3">
                          {/* –°—Ç–∞–±–∏–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –ø–æ —Å—Ç–∞–¥–∏—è–º */}
                          {getFilteredDeals()
                            .filter(deal => deal.stage === stage)
                            .map((deal) => (
                              <div 
                                key={deal.id} 
                                className={`bg-white rounded-[15px] p-3 border border-[#E5E7EB] cursor-pointer hover:shadow-md transition-all ${
                                  draggedDeal?.id === deal.id ? 'opacity-50 scale-95' : ''
                                }`}
                                draggable
                                onDragStart={(e) => {
                                  setDraggedDeal(deal);
                                  e.dataTransfer.effectAllowed = 'move';
                                }}
                                onDragEnd={() => {
                                  setDraggedDeal(null);
                                  setDragOverColumn(null);
                                }}
                                onClick={() => {
                                  setCrmSelectedDeal(deal);
                                  setCrmSidebarOpen(true);
                                }}
                              >
                                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–∞—á–µ—Å—Ç–≤–æ–º –ª–∏–¥–∞ */}
                                <div className="flex items-center justify-between mb-1">
                                  <h4 className="text-[13px] font-[500] text-[#070F1A]">{deal.client.phone || `–û–±—Ä–∞—â–µ–Ω–∏–µ #${deal.id.slice(-4)}`}</h4>
                                  <span className={`text-[10px] px-2 py-1 rounded-[90px] ${
                                    deal.leadQuality === 'hot' ? 'bg-red-100 text-red-600' :
                                    deal.leadQuality === 'warm' ? 'bg-orange-100 text-orange-600' :
                                    'bg-blue-100 text-blue-600'
                                  }`}>
                                    {deal.leadQuality === 'hot' ? '–ì–æ—Ä—è—á–∏–π' : deal.leadQuality === 'warm' ? '–¢–µ–ø–ª—ã–π' : '–•–æ–ª–æ–¥–Ω—ã–π'}
                                  </span>
                                </div>
                                
                                <p className="text-[12px] text-[#8E8E93] mb-2">{deal.company}</p>
                                
                                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö –∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ */}
                                <div className="flex items-center gap-2 mb-2">
                                  <span className={`text-[10px] px-2 py-1 rounded-[15px] flex items-center gap-1 ${
                                    deal.hasContacts ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'
                                  }`}>
                                    {deal.hasContacts ? (
                                      <img src="/call-calling.svg" alt="–¢–µ–ª–µ—Ñ–æ–Ω" className="w-[10px] h-[10px]" style={phoneIconGreenStyle} />
                                    ) : (
                                      <div className="relative w-[10px] h-[10px]">
                                        <img src="/call-calling.svg" alt="–¢–µ–ª–µ—Ñ–æ–Ω" className="w-[10px] h-[10px]" style={phoneIconGreenStyle} />
                                        <div className="absolute top-1/2 left-0 right-0 h-[1px] bg-gray-400 transform -translate-y-1/2"></div>
                                      </div>
                                    )}
                                    {deal.hasContacts ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}
                                  </span>
                                  <span className="text-[10px] text-[#8E8E93] flex items-center gap-1">
                                    {deal.owner === 'ai' ? (
                                      <img src="/Frame 205.svg" alt="–ò–ò" className="w-[10px] h-[10px] align-middle" />
                                    ) : (
                                      <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-[10px] h-[10px] align-middle" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                                    )}
                                    {deal.ownerName}
                                  </span>
                                </div>
                                
                                <div className="flex items-center justify-between">
                                  <span className="text-[12px] text-[#0084FF] font-[500]">
                                    {deal.amount ? `${deal.amount.toLocaleString()}‚ÇΩ` : '–ë–µ–∑ —Å—É–º–º—ã'}
                                  </span>
                                  <span className="text-[11px] text-[#8E8E93]">{deal.days}–¥</span>
                                </div>
                              </div>
                            ))}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="space-y-3">
                    {getFilteredDeals().length === 0 ? (
                      <div className="bg-white border border-[#E5E7EB] rounded-[15px] p-6 text-center text-[#8E8E93]">
                        –°–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç
                      </div>
                    ) : (
                      getFilteredDeals().map((deal) => (
                        <div key={deal.id} className="bg-white border border-[#E5E7EB] rounded-[15px] p-4 cursor-pointer hover:shadow-md transition-all" onClick={() => { setCrmSelectedDeal(deal); setCrmSidebarOpen(true); }}>
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                              <div className="w-10 h-10 bg-[#0084FF]/10 rounded-[90px] flex items-center justify-center">
                                <span className="text-[#0084FF] font-[500] text-[14px]">#{deal.id?.toString().slice(-4) || ''}</span>
                              </div>
                              <div>
                                <h3 className="text-[14px] font-[500] text-[#070F1A]">{deal.title || '–°–¥–µ–ª–∫–∞'}</h3>
                                <p className="text-[12px] text-[#8E8E93]">–°–æ–∑–¥–∞–Ω–∞ {deal.createdDate || ''}</p>
                              </div>
                            </div>
                            <div className="flex items-center gap-4">
                              <span className="text-[14px] font-[500] text-[#070F1A]">{deal.amount || 0}‚ÇΩ</span>
                              <span className="px-3 py-1 bg-[#36C76A]/10 text-[#36C76A] text-[12px] font-[500] rounded-[6px]">
                                {deal.stage}
                              </span>
                            </div>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                )}
              </div>
            )}

            {crmActiveTab === 'tasks' && (
              <div className="space-y-4">
                {crmViewMode === 'list' ? (
                  <div className="space-y-3">
                    {tasks.map((task) => (
                      <div key={task.id} className="bg-white border border-[#E5E7EB] rounded-[15px] p-4 cursor-pointer hover:shadow-md transition-all" onClick={() => openTaskDetails(task)}>
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className={`w-3 h-3 rounded-[90px] ${task.status === 'completed' ? 'bg-[#36C76A]' : 'bg-[#E5E7EB]'}`}></div>
                            <div>
                              <h3 className="text-[14px] font-[500] text-[#070F1A]">{task.title || `–ó–∞–¥–∞—á–∞ #${task.id.slice(-4)}`}</h3>
                              <p className="text-[12px] text-[#8E8E93]">
                                –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {task.assigneeName} ‚Ä¢ –°–æ–∑–¥–∞–Ω–∞ {new Date(task.createdDate).toLocaleDateString()}
                              </p>
                            </div>
                          </div>
                          <div className="flex items-center gap-4">
                            <span className={`px-3 py-1 text-[12px] font-[500] rounded-[6px] ${
                              task.priority === 'high' ? 'bg-red-100 text-red-600' :
                              task.priority === 'medium' ? 'bg-orange-100 text-orange-600' :
                              'bg-green-100 text-green-600'
                            }`}>
                              {task.priority === 'high' ? '–í—ã—Å–æ–∫–∏–π' : task.priority === 'medium' ? '–°—Ä–µ–¥–Ω–∏–π' : '–ù–∏–∑–∫–∏–π'}
                            </span>
                            <span className="text-[11px] text-[#8E8E93]">
                              {task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '–ë–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞'}
                            </span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="grid grid-cols-3 gap-4">
                    {[
                      { key: 'pending', label: '–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é', color: 'bg-yellow-50 border-yellow-200' },
                      { key: 'in_progress', label: '–í —Ä–∞–±–æ—Ç–µ', color: 'bg-blue-50 border-blue-200' },
                      { key: 'completed', label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', color: 'bg-green-50 border-green-200' }
                    ].map((status) => (
                      <div 
                        key={status.key} 
                        className={`bg-[#F2F3F4] rounded-[15px] p-[5px] transition-colors ${
                          dragOverTaskColumn === status.key ? 'bg-[#E3F2FD] border-2 border-[#0084FF]' : ''
                        }`}
                        onDragOver={(e) => handleTaskDragOver(e, status.key)}
                        onDragLeave={handleTaskDragLeave}
                        onDrop={(e) => handleTaskDrop(e, status.key)}
                      >
                        <div className="flex items-center justify-between mb-4 mx-4">
                          <h3 className="text-[14px] font-[500] text-[#070F1A]">{status.label}</h3>
                          <span className="text-[12px] text-[#8E8E93] bg-white px-2 py-1 rounded-[6px]">
                            {getTasksByStatus(status.key).length}
                          </span>
                        </div>
                        
                        <div className="space-y-3">
                          {getTasksByStatus(status.key).map((task) => (
                            <div 
                              key={task.id} 
                              className={`bg-white rounded-[15px] p-3 border border-[#E5E7EB] cursor-grab hover:shadow-md transition-all ${
                                draggedTask?.id === task.id ? 'opacity-50 scale-95 cursor-grabbing' : ''
                              }`}
                              draggable
                              onDragStart={(e) => handleTaskDragStart(e, task)}
                              onDragEnd={handleTaskDragEnd}
                              onClick={(e) => {
                                if (!isDragging) {
                                  openTaskDetails(task);
                                }
                              }}
                            >
                              <h4 className="text-[13px] font-[500] text-[#070F1A] mb-1">{task.title || `–ó–∞–¥–∞—á–∞ #${task.id.slice(-4)}`}</h4>
                              <p className="text-[12px] text-[#8E8E93] mb-2">{task.assigneeName}</p>
                              <div className="flex items-center justify-between">
                                <span className={`px-2 py-1 text-[11px] font-[500] rounded-[4px] ${
                                  task.priority === 'high' ? 'bg-red-100 text-red-600' :
                                  task.priority === 'medium' ? 'bg-orange-100 text-orange-600' :
                                  'bg-green-100 text-green-600'
                                }`}>
                                  {task.priority === 'high' ? '–í—ã—Å–æ–∫–∏–π' : task.priority === 'medium' ? '–°—Ä–µ–¥–Ω–∏–π' : '–ù–∏–∑–∫–∏–π'}
                                </span>
                                <span className="text-[11px] text-[#8E8E93]">
                                  {task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '–ë–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞'}
                                </span>
                              </div>
                            </div>
                          ))}
                          
                          {/* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ –ø–µ—Ä–≤—É—é –∫–æ–ª–æ–Ω–∫—É - –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∑–∞–¥–∞—á */}
                          {status.key === 'pending' && (
                            <div className="mt-3">
                              <button
                                onClick={() => setCreateTaskModalOpen(true)}
                                className="w-full h-[34px] text-[#8E8E93] rounded-[8px] text-[13px] hover:border-[#0084FF] hover:text-[#0084FF] transition-colors flex items-center justify-center gap-2"
                                style={BUTTON_STYLES.whiteButton}
                              >
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M12 5V19M5 12H19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                                –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {crmActiveTab === 'clients' && (
              <div className="space-y-4">
                {console.log('Rendering clients tab, clients count:', clients.length, 'clients:', clients)}
                {console.log('crmActiveTab:', crmActiveTab)}
                {clients.length === 0 ? (
                  <div className="flex flex-col items-center justify-center py-12">
                    <div className="w-20 h-20 bg-[#F3F4F6] rounded-full flex items-center justify-center mb-4">
                      <svg className="w-8 h-8 text-[#8E8E93]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                      </svg>
                    </div>
                    <h3 className="text-[16px] font-[500] text-[#070F1A] mb-2">–ö–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                    <p className="text-[14px] text-[#8E8E93] text-center max-w-md">
                      –ö–ª–∏–µ–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ –Ω–∞—á–Ω—É—Ç –ø–æ—Å—Ç—É–ø–∞—Ç—å –∑–∞—è–≤–∫–∏ —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∫–∞–Ω–∞–ª—ã —Å–≤—è–∑–∏
                    </p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {clients.map((client) => (
                      <div 
                        key={client.id} 
                        className="bg-white rounded-[12px] p-4 border border-[#E5E7EB] hover:shadow-sm transition-shadow cursor-pointer"
                        onClick={() => {
                          setSelectedCrmClient(client);
                          setCrmClientSidebarOpen(true);
                        }}
                      >
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex-1">
                            <h3 className="text-[16px] font-[500] text-[#070F1A] mb-1">{client.name}</h3>
                            {client.company && (
                              <p className="text-[14px] text-[#8E8E93] mb-2">{client.company}</p>
                            )}
                          </div>
                          <span className={`px-2 py-1 rounded-[6px] text-[12px] font-[500] ${
                            client.status === 'active' 
                              ? 'bg-[#DCFCE7] text-[#166534]' 
                              : 'bg-[#FEF3C7] text-[#92400E]'
                          }`}>
                            {client.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π'}
                          </span>
                        </div>
                        
                        <div className="space-y-2">
                          {client.email && (
                            <div className="flex items-center text-[14px] text-[#6B7280]">
                              <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                              </svg>
                              {client.email}
                            </div>
                          )}
                          {client.phone && (
                            <div className="flex items-center text-[14px] text-[#6B7280]">
                              <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                              </svg>
                              {client.phone}
                            </div>
                          )}
                          {client.website && (
                            <div className="flex items-center text-[14px] text-[#6B7280]">
                              <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9" />
                              </svg>
                              <a href={client.website} target="_blank" rel="noopener noreferrer" className="text-[#3B82F6] hover:underline">
                                {client.website}
                              </a>
                            </div>
                          )}
                        </div>
                        
                        {client.notes && (
                          <div className="mt-3 pt-3 border-t border-[#F3F4F6]">
                            <p className="text-[12px] text-[#8E8E93] line-clamp-2">{client.notes}</p>
                          </div>
                        )}
                        
                        <div className="mt-3 pt-3 border-t border-[#F3F4F6] flex items-center justify-between">
                          <span className="text-[12px] text-[#8E8E93]">
                            {client.source === 'widget_form' ? '–ò–∑ –≤–∏–¥–∂–µ—Ç–∞' : client.source}
                          </span>
                          <span className="text-[12px] text-[#8E8E93]">
                            {new Date(client.created_at).toLocaleDateString('ru-RU')}
                          </span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
            
            {/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–¥–µ–ª–∫–∏ */}
            {crmSidebarOpen && (
              <>
                {/* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ */}
                <div 
                  className="fixed inset-0 bg-black bg-opacity-50 z-[9998]"
                  style={{ marginTop: 0 }}
                  onClick={() => setCrmSidebarOpen(false)}
                />
                
                {/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */}
                <div className="fixed right-0 top-0 h-full w-[500px] bg-white shadow-2xl z-[9999] transform transition-transform duration-300 ease-in-out" style={{ borderTopLeftRadius: '20px', borderBottomLeftRadius: '20px', marginTop: 0 }}>
                  <div className="h-full flex flex-col">
                    {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏ */}
                    <div className="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
                      <h2 className="text-[18px] font-[500] text-[#070F1A]">–î–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏</h2>
                      <button 
                        onClick={() => setCrmSidebarOpen(false)}
                        className="w-8 h-8 rounded-[90px] bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ color: '#8E8E93' }}>
                          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                      </button>
                    </div>
                    
                    {/* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–∞–Ω–µ–ª–∏ */}
                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                      {crmSelectedDeal && (
                        <>
                          {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                          <div>
                            <h3 className="text-[16px] font-[500] text-[#070F1A] mb-3">{crmSelectedDeal.title}</h3>
                            <div className="space-y-2">
                              <div className="flex justify-between">
                                <span className="text-[14px] text-[#8E8E93]">–°—Ç–∞–¥–∏—è:</span>
                                <span className="px-3 py-1 bg-[#0084FF]/10 text-[#0084FF] text-[12px] font-[500] rounded-[6px]">
                                  {crmSelectedDeal.stage}
                                </span>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-[14px] text-[#8E8E93]">–ö–∞—á–µ—Å—Ç–≤–æ –ª–∏–¥–∞:</span>
                                <div className="flex items-center gap-2">
                                  <div className="relative lead-quality-dropdown">
                                    <button
                                      onClick={() => setEditingLeadQuality(!editingLeadQuality)}
                                      className={`px-3 py-1 text-[12px] font-[500] rounded-[90px] flex items-center gap-2 hover:opacity-80 transition-opacity ${
                                  crmSelectedDeal.leadQuality === 'hot' ? 'bg-red-100 text-red-600' :
                                  crmSelectedDeal.leadQuality === 'warm' ? 'bg-orange-100 text-orange-600' :
                                  'bg-blue-100 text-blue-600'
                                      }`}
                                    >
                                  {crmSelectedDeal.leadQuality === 'hot' ? '–ì–æ—Ä—è—á–∏–π' :
                                   crmSelectedDeal.leadQuality === 'warm' ? '–¢–µ–ø–ª—ã–π' : '–•–æ–ª–æ–¥–Ω—ã–π'}
                                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                      </svg>
                                    </button>
                                    {editingLeadQuality && (
                                      <div className="absolute top-full left-0 mt-1 bg-white border border-[#E5E7EB] rounded-[10px] shadow-lg z-50 min-w-[120px]">
                                        <div className="p-2 space-y-1">
                                          <div 
                                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                            onClick={() => handleSaveLeadQuality('hot')}
                                          >
                                            <div className="w-3 h-3 bg-red-100 rounded-full"></div>
                                            <span className="text-[13px] text-[#070F1A]">–ì–æ—Ä—è—á–∏–π</span>
                                          </div>
                                          <div 
                                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                            onClick={() => handleSaveLeadQuality('warm')}
                                          >
                                            <div className="w-3 h-3 bg-orange-100 rounded-full"></div>
                                            <span className="text-[13px] text-[#070F1A]">–¢–µ–ø–ª—ã–π</span>
                                          </div>
                                          <div 
                                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                            onClick={() => handleSaveLeadQuality('cold')}
                                          >
                                            <div className="w-3 h-3 bg-blue-100 rounded-full"></div>
                                            <span className="text-[13px] text-[#070F1A]">–•–æ–ª–æ–¥–Ω—ã–π</span>
                                          </div>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-[14px] text-[#8E8E93]">–ö–æ–Ω—Ç–∞–∫—Ç—ã:</span>
                                <span className={`px-3 py-1 text-[12px] font-[500] rounded-[15px] flex items-center gap-2 ${
                                  crmSelectedDeal.hasContacts ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'
                                }`}>
                                  {crmSelectedDeal.hasContacts ? (
                                    <img src="/call-calling.svg" alt="–¢–µ–ª–µ—Ñ–æ–Ω" className="w-[10px] h-[10px]" style={phoneIconGreenStyle} />
                                  ) : (
                                    <div className="relative w-[10px] h-[10px]">
                                      <img src="/call-calling.svg" alt="–¢–µ–ª–µ—Ñ–æ–Ω" className="w-[10px] h-[10px]" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                                      <div className="absolute top-1/2 left-0 right-0 h-[1px] bg-gray-400 transform -translate-y-1/2"></div>
                                    </div>
                                  )}
                                  {crmSelectedDeal.hasContacts ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}
                                </span>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-[14px] text-[#8E8E93]">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</span>
                                <div className="flex items-center gap-2">
                                  <div className="relative executor-dropdown">
                                    <button
                                      onClick={() => crmSelectedDeal.owner !== 'ai' && toggleExecutorDropdown('deal')}
                                      className={`text-[12px] text-[#070F1A] flex items-center gap-2 ${crmSelectedDeal.owner === 'ai' ? 'cursor-default' : 'hover:opacity-80 transition-opacity'}`}
                                    >
                                  {crmSelectedDeal.owner === 'ai' ? (
                                    <img src="/Frame 205.svg" alt="–ò–ò" className="w-[12px] h-[12px] align-middle" />
                                  ) : (
                                    <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-[12px] h-[12px] align-middle" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                                  )}
                                  {crmSelectedDeal.ownerName}
                                      {crmSelectedDeal.owner !== 'ai' && (
                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                        </svg>
                                      )}
                                    </button>
                                    {executorDropdowns.deal && (
                                      <div className="absolute top-full right-0 mt-1 bg-white border border-[#E5E7EB] rounded-[10px] shadow-lg z-50 min-w-[160px]">
                                        <div className="p-2 space-y-1">
                                          <div 
                                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                            onClick={() => {
                                              setDeals(prev => prev.map(deal => 
                                                deal.id === crmSelectedDeal.id 
                                                  ? { ...deal, owner: 'ai', ownerName: '–ò–ò-–∞–≥–µ–Ω—Ç' }
                                                  : deal
                                              ));
                                              setCrmSelectedDeal(prev => ({ ...prev, owner: 'ai', ownerName: '–ò–ò-–∞–≥–µ–Ω—Ç' }));
                                              setExecutorDropdowns(prev => ({...prev, deal: false}));
                                            }}
                                          >
                                            <img src="/Frame 205.svg" alt="–ò–ò" className="w-4 h-4" />
                                            <span className="text-[13px] text-[#070F1A]">–ò–ò-–∞–≥–µ–Ω—Ç</span>
                                          </div>
                                          <div 
                                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                            onClick={() => {
                                              setDeals(prev => prev.map(deal => 
                                                deal.id === crmSelectedDeal.id 
                                                  ? { ...deal, owner: 'operator-1', ownerName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' }
                                                  : deal
                                              ));
                                              setCrmSelectedDeal(prev => ({ ...prev, owner: 'operator-1', ownerName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' }));
                                              setExecutorDropdowns(prev => ({...prev, deal: false}));
                                            }}
                                          >
                                            <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                                            <span className="text-[13px] text-[#070F1A]">–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞</span>
                                          </div>
                                          <div 
                                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                            onClick={() => {
                                              setDeals(prev => prev.map(deal => 
                                                deal.id === crmSelectedDeal.id 
                                                  ? { ...deal, owner: 'operator-2', ownerName: '–ú–∏—Ö–∞–∏–ª –°–∏–¥–æ—Ä–æ–≤' }
                                                  : deal
                                              ));
                                              setCrmSelectedDeal(prev => ({ ...prev, owner: 'operator-2', ownerName: '–ú–∏—Ö–∞–∏–ª –°–∏–¥–æ—Ä–æ–≤' }));
                                              setExecutorDropdowns(prev => ({...prev, deal: false}));
                                            }}
                                          >
                                            <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                                            <span className="text-[13px] text-[#070F1A]">–ú–∏—Ö–∞–∏–ª –°–∏–¥–æ—Ä–æ–≤</span>
                                          </div>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-[14px] text-[#8E8E93]">–°—Ç–∞—Ç—É—Å —Ä–µ—à–µ–Ω–∏—è:</span>
                                <span className={`px-3 py-1 text-[12px] font-[500] rounded-[90px] ${
                                  crmSelectedDeal.isResolved ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'
                                }`}>
                                  {crmSelectedDeal.isResolved ? '–†–µ—à–µ–Ω' : '–í —Ä–∞–±–æ—Ç–µ'}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-[14px] text-[#8E8E93]">–°–æ–∑–¥–∞–Ω–∞:</span>
                                <span className="text-[13px] text-[#070F1A]">{crmSelectedDeal.createdDate}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-[14px] text-[#8E8E93]">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç:</span>
                                <span className="text-[13px] text-[#070F1A]">{crmSelectedDeal.lastContact}</span>
                              </div>
                            </div>
                          </div>
                          
                          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ */}
                          <div>
                            <h4 className="text-[16px] font-[500] text-[#070F1A] mb-3">–ö–ª–∏–µ–Ω—Ç</h4>
                            <div className="space-y-2">
                              <div className="flex justify-between items-center">
                                <span className="text-[14px] font-[500] text-[#070F1A]">–ò–º—è:</span>
                                <div className="flex items-center gap-2">
                                  {editingField === 'name' ? (
                                    <div className="flex items-center gap-2">
                                      <input
                                        type="text"
                                        value={editedClientData.name || ''}
                                        onChange={(e) => setEditedClientData(prev => ({ ...prev, name: e.target.value }))}
                                        className="text-[12px] text-[#070F1A] border border-gray-300 rounded px-2 py-1 w-32"
                                        autoFocus
                                      />
                                      <button 
                                        onClick={() => handleSaveField('name')}
                                        className="w-4 h-4 text-green-600 hover:text-green-700"
                                      >
                                        <img src="/Frame 2069.svg" alt="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(50%) invert(35%) sepia(43%) saturate(1352%) hue-rotate(87deg) brightness(119%) contrast(119%)' }} />
                                      </button>
                                      <button 
                                        onClick={handleCancelEdit}
                                        className="w-4 h-4 text-red-600 hover:text-red-700"
                                      >
                                        <img src="/x-02.svg" alt="–û—Ç–º–µ–Ω–∞" className="w-4 h-4" style={redIconStyle} />
                                      </button>
                                    </div>
                                  ) : (
                                    <div className="flex items-center gap-2">
                                      <span className="text-[13px] text-[#070F1A]">{crmSelectedDeal.client.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                                      <button 
                                        onClick={() => handleEditField('name', crmSelectedDeal.client.name || '')}
                                        className="w-[11px] h-[11px] text-[#8E8E93] hover:text-[#070F1A] transition-colors"
                                      >
                                        <img src="/pencil.svg" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" className="w-[11px] h-[11px]" />
                                      </button>
                                    </div>
                                  )}
                                </div>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-[14px] font-[500] text-[#070F1A]">Email:</span>
                                <div className="flex items-center gap-2">
                                  {editingField === 'email' ? (
                                    <div className="flex items-center gap-2">
                                      <input
                                        type="email"
                                        value={editedClientData.email || ''}
                                        onChange={(e) => setEditedClientData(prev => ({ ...prev, email: e.target.value }))}
                                        className="text-[12px] text-[#070F1A] border border-gray-300 rounded px-2 py-1 w-32"
                                        autoFocus
                                      />
                                      <button 
                                        onClick={() => handleSaveField('email')}
                                        className="w-4 h-4 text-green-600 hover:text-green-700"
                                      >
                                        <img src="/Frame 2069.svg" alt="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(50%) invert(35%) sepia(43%) saturate(1352%) hue-rotate(87deg) brightness(119%) contrast(119%)' }} />
                                      </button>
                                      <button 
                                        onClick={handleCancelEdit}
                                        className="w-4 h-4 text-red-600 hover:text-red-700"
                                      >
                                        <img src="/x-02.svg" alt="–û—Ç–º–µ–Ω–∞" className="w-4 h-4" style={redIconStyle} />
                                      </button>
                                    </div>
                                  ) : (
                                    <div className="flex items-center gap-2">
                                      <span className="text-[12px] text-[#0084FF]">{crmSelectedDeal.client.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                      <button 
                                        onClick={() => handleEditField('email', crmSelectedDeal.client.email || '')}
                                        className="w-[11px] h-[11px] text-[#8E8E93] hover:text-[#070F1A] transition-colors"
                                      >
                                        <img src="/pencil.svg" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" className="w-[11px] h-[11px]" />
                                      </button>
                                    </div>
                                  )}
                                </div>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-[14px] font-[500] text-[#070F1A]">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                <div className="flex items-center gap-2">
                                  {editingField === 'phone' ? (
                                    <div className="flex items-center gap-2">
                                      <input
                                        type="tel"
                                        value={editedClientData.phone || ''}
                                        onChange={(e) => setEditedClientData(prev => ({ ...prev, phone: e.target.value }))}
                                        className="text-[12px] text-[#070F1A] border border-gray-300 rounded px-2 py-1 w-32"
                                        autoFocus
                                      />
                                      <button 
                                        onClick={() => handleSaveField('phone')}
                                        className="w-4 h-4 text-green-600 hover:text-green-700"
                                      >
                                        <img src="/Frame 2069.svg" alt="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(50%) invert(35%) sepia(43%) saturate(1352%) hue-rotate(87deg) brightness(119%) contrast(119%)' }} />
                                      </button>
                                      <button 
                                        onClick={handleCancelEdit}
                                        className="w-4 h-4 text-red-600 hover:text-red-700"
                                      >
                                        <img src="/x-02.svg" alt="–û—Ç–º–µ–Ω–∞" className="w-4 h-4" style={redIconStyle} />
                                      </button>
                                    </div>
                                  ) : (
                                    <div className="flex items-center gap-2">
                                      <span className="text-[13px] text-[#070F1A]">{crmSelectedDeal.client.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                      <button 
                                        onClick={() => handleEditField('phone', crmSelectedDeal.client.phone || '')}
                                        className="w-[11px] h-[11px] text-[#8E8E93] hover:text-[#070F1A] transition-colors"
                                      >
                                        <img src="/pencil.svg" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" className="w-[11px] h-[11px]" />
                                      </button>
                                    </div>
                                  )}
                                </div>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-[14px] font-[500] text-[#070F1A]">–ö–æ–º–ø–∞–Ω–∏—è:</span>
                                <div className="flex items-center gap-2">
                                  {editingField === 'company' ? (
                                    <div className="flex items-center gap-2">
                                      <input
                                        type="text"
                                        value={editedClientData.company || ''}
                                        onChange={(e) => setEditedClientData(prev => ({ ...prev, company: e.target.value }))}
                                        className="text-[12px] text-[#070F1A] border border-gray-300 rounded px-2 py-1 w-32"
                                        autoFocus
                                      />
                                      <button 
                                        onClick={() => handleSaveField('company')}
                                        className="w-4 h-4 text-green-600 hover:text-green-700"
                                      >
                                        <img src="/Frame 2069.svg" alt="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(50%) invert(35%) sepia(43%) saturate(1352%) hue-rotate(87deg) brightness(119%) contrast(119%)' }} />
                                      </button>
                                      <button 
                                        onClick={handleCancelEdit}
                                        className="w-4 h-4 text-red-600 hover:text-red-700"
                                      >
                                        <img src="/x-02.svg" alt="–û—Ç–º–µ–Ω–∞" className="w-4 h-4" style={redIconStyle} />
                                      </button>
                                    </div>
                                  ) : (
                                    <div className="flex items-center gap-2">
                                      <span className="text-[13px] text-[#070F1A]">{crmSelectedDeal.client.company || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</span>
                                      <button 
                                        onClick={() => handleEditField('company', crmSelectedDeal.client.company || '')}
                                        className="w-[11px] h-[11px] text-[#8E8E93] hover:text-[#070F1A] transition-colors"
                                      >
                                        <img src="/pencil.svg" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" className="w-[11px] h-[11px]" />
                                      </button>
                                    </div>
                                  )}
                                </div>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-[14px] font-[500] text-[#070F1A]">–°—É–º–º–∞:</span>
                                <div className="flex items-center gap-2">
                                  <span className="text-[13px] text-[#070F1A]">
                                    {crmSelectedDeal.amount ? `${crmSelectedDeal.amount.toLocaleString()}‚ÇΩ` : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
                                  </span>
                                  <button className="w-[11px] h-[11px] text-[#8E8E93] hover:text-[#070F1A] transition-colors">
                                    <img src="/pencil.svg" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" className="w-[11px] h-[11px]" />
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          {/* –ó–∞–º–µ—Ç–∫–∏ */}
                          <div>
                            <div className="flex items-center justify-between mb-3">
                              <h4 className="text-[16px] font-[500] text-[#070F1A]">–ó–∞–º–µ—Ç–∫–∏</h4>
                              {!editingNotes && (
                                <button
                                  onClick={startEditingNotes}
                                  className="text-[12px] text-[#0084FF] hover:underline"
                                >
                                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                              )}
                            </div>
                            
                            {editingNotes ? (
                              <div className="space-y-3">
                                <textarea
                                  value={editedNotes}
                                  onChange={(e) => setEditedNotes(e.target.value)}
                                  className="w-full h-24 px-3 py-2 border border-[#E5E7EB] rounded-[8px] text-[14px] focus:outline-none focus:border-[#0084FF] resize-none"
                                  placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –æ —Å–¥–µ–ª–∫–µ..."
                                />
                                <div className="flex gap-2">
                                  <button
                                    onClick={saveNotes}
                                    className="px-3 py-1 bg-[#0084FF] text-white text-[12px] rounded-[90px] hover:bg-[#0073E6] transition-colors h-[34px]"
                                  >
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                  </button>
                                  <button
                                    onClick={cancelEditingNotes}
                                    className="px-3 py-1 bg-gray-200 text-gray-700 text-[12px] rounded-[90px] hover:bg-gray-300 transition-colors h-[34px]"
                                  >
                                    –û—Ç–º–µ–Ω–∞
                                  </button>
                                </div>
                              </div>
                            ) : (
                              <div className="bg-[#F2F3F4] rounded-[15px] p-4">
                                <p className="text-[12px] text-[#070F1A] leading-relaxed">
                                  {crmSelectedDeal.notes || '–ó–∞–º–µ—Ç–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã'}
                                </p>
                              </div>
                            )}
                          </div>
                          
                          {/* –î–µ–π—Å—Ç–≤–∏—è */}
                          <div>
                            <h4 className="text-[16px] font-[500] text-[#070F1A] mb-3">–î–µ–π—Å—Ç–≤–∏—è</h4>
                            <div className="space-y-2">
                              {crmSelectedDeal.client.email ? (
                                <a 
                                  href={`mailto:${crmSelectedDeal.client.email}?subject=–ü–æ –ø–æ–≤–æ–¥—É —Å–¥–µ–ª–∫–∏: ${crmSelectedDeal.title}`}
                                  className="w-full h-[34px] bg-[#0084FF] text-white rounded-[10px] text-[14px] font-[500] hover:bg-[#0073E6] transition-colors flex items-center justify-center"
                                >
                                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å email
                                </a>
                              ) : (
                                <button 
                                  disabled
                                  className="w-full h-10 bg-gray-200 text-gray-500 rounded-[10px] text-[14px] font-[500] cursor-not-allowed"
                                >
                                  Email –Ω–µ —É–∫–∞–∑–∞–Ω
                                </button>
                              )}
                              
                              {crmSelectedDeal.client.phone ? (
                                <a 
                                  href={`tel:${crmSelectedDeal.client.phone}`}
                                  className="w-full h-[34px] bg-white border border-[#E5E7EB] text-[#070F1A] rounded-[10px] text-[14px] font-[500] hover:bg-gray-50 transition-colors flex items-center justify-center"
                                >
                                  –ü–æ–∑–≤–æ–Ω–∏—Ç—å
                                </a>
                              ) : (
                                <button 
                                  disabled
                                  className="w-full h-[34px] bg-gray-100 border border-gray-200 text-gray-500 rounded-[10px] text-[14px] font-[500] cursor-not-allowed"
                                >
                                  –¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω
                                </button>
                              )}
                              
                              {crmSelectedDeal.dialogId ? (
                                <button 
                                  onClick={() => {
                                    setCrmSidebarOpen(false);
                                    setCrmActiveTab('deals');
                                    // TODO: –ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –¥–∏–∞–ª–æ–≥—É
                                    console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ –¥–∏–∞–ª–æ–≥—É: ${crmSelectedDeal.dialogId}`);
                                  }}
                                  className="w-full h-[34px] bg-white border border-[#E5E7EB] text-[#070F1A] rounded-[10px] text-[14px] font-[500] hover:bg-gray-50 transition-colors flex items-center justify-center"
                                >
                                  –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏–∞–ª–æ–≥
                                </button>
                              ) : (
                                <button 
                                  disabled
                                  className="w-full h-[34px] bg-gray-100 border border-gray-200 text-gray-500 rounded-[10px] text-[14px] font-[500] cursor-not-allowed"
                                >
                                  –î–∏–∞–ª–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω
                                </button>
                              )}
                              
                              {/* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */}
                              <button 
                                onClick={() => handleDeleteDeal(crmSelectedDeal.id)}
                                className="w-full h-[34px] bg-red-50/50 border border-red-100/50 text-red-500/70 rounded-[10px] text-[14px] font-[500] hover:bg-red-100/50 hover:text-red-500 transition-colors flex items-center justify-center"
                              >
                                –£–¥–∞–ª–∏—Ç—å —Å–¥–µ–ª–∫—É
                              </button>
                            </div>
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∫–ª–∏–µ–Ω—Ç–∞ */}
            {crmClientSidebarOpen && selectedCrmClient && (
              <>
                {/* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ */}
                <div 
                  className="fixed inset-0 bg-black bg-opacity-50 z-[9998]"
                  style={{ marginTop: 0 }}
                  onClick={() => setCrmClientSidebarOpen(false)}
                />
                
                {/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */}
                <div className="fixed right-0 top-0 h-full w-[500px] bg-white shadow-2xl z-[9999] transform transition-transform duration-300 ease-in-out" style={{ borderTopLeftRadius: '20px', borderBottomLeftRadius: '20px', marginTop: 0 }}>
                  <div className="h-full flex flex-col">
                    {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏ */}
                    <div className="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
                      <h2 className="text-[18px] font-[500] text-[#070F1A]">–î–µ—Ç–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞</h2>
                      <button 
                        onClick={() => setCrmClientSidebarOpen(false)}
                        className="w-8 h-8 rounded-[90px] bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ color: '#8E8E93' }}>
                          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                      </button>
                    </div>
                    
                    {/* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–∞–Ω–µ–ª–∏ */}
                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                      {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                      <div>
                        <h3 className="text-[16px] font-[500] text-[#070F1A] mb-3">{selectedCrmClient.name}</h3>
                        <div className="space-y-3">
                          {selectedCrmClient.company && (
                            <div className="flex justify-between">
                              <span className="text-[14px] text-[#8E8E93]">–ö–æ–º–ø–∞–Ω–∏—è:</span>
                              <span className="text-[14px] text-[#070F1A] font-[500]">{selectedCrmClient.company}</span>
                            </div>
                          )}
                          
                          {selectedCrmClient.email && (
                            <div className="flex justify-between">
                              <span className="text-[14px] text-[#8E8E93]">Email:</span>
                              <a href={`mailto:${selectedCrmClient.email}`} className="text-[14px] text-[#0084FF] hover:underline">
                                {selectedCrmClient.email}
                              </a>
                            </div>
                          )}
                          
                          {selectedCrmClient.phone && (
                            <div className="flex justify-between">
                              <span className="text-[14px] text-[#8E8E93]">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                              <a href={`tel:${selectedCrmClient.phone}`} className="text-[14px] text-[#0084FF] hover:underline">
                                {selectedCrmClient.phone}
                              </a>
                            </div>
                          )}
                          
                          {selectedCrmClient.website && (
                            <div className="flex justify-between">
                              <span className="text-[14px] text-[#8E8E93]">–°–∞–π—Ç:</span>
                              <a href={selectedCrmClient.website} target="_blank" rel="noopener noreferrer" className="text-[14px] text-[#0084FF] hover:underline">
                                {selectedCrmClient.website}
                              </a>
                            </div>
                          )}
                          
                          <div className="flex justify-between">
                            <span className="text-[14px] text-[#8E8E93]">–°—Ç–∞—Ç—É—Å:</span>
                            <span className={`px-3 py-1 text-[12px] font-[500] rounded-[6px] ${
                              selectedCrmClient.status === 'active' 
                                ? 'bg-[#DCFCE7] text-[#166534]' 
                                : 'bg-[#FEF3C7] text-[#92400E]'
                            }`}>
                              {selectedCrmClient.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π'}
                            </span>
                          </div>
                          
                          <div className="flex justify-between">
                            <span className="text-[14px] text-[#8E8E93]">–ò—Å—Ç–æ—á–Ω–∏–∫:</span>
                            <span className="text-[14px] text-[#070F1A]">
                              {selectedCrmClient.source === 'widget_form' ? '–ò–∑ –≤–∏–¥–∂–µ—Ç–∞' : selectedCrmClient.source}
                            </span>
                          </div>
                          
                          <div className="flex justify-between">
                            <span className="text-[14px] text-[#8E8E93]">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</span>
                            <span className="text-[14px] text-[#070F1A]">
                              {new Date(selectedCrmClient.created_at).toLocaleDateString('ru-RU')}
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      {/* –ó–∞–º–µ—Ç–∫–∏ */}
                      {selectedCrmClient.notes && (
                        <div>
                          <h4 className="text-[14px] font-[500] text-[#070F1A] mb-3">–ó–∞–º–µ—Ç–∫–∏</h4>
                          <div className="bg-[#F9FAFB] rounded-[8px] p-4">
                            <p className="text-[14px] text-[#6B7280] whitespace-pre-wrap">{selectedCrmClient.notes}</p>
                          </div>
                        </div>
                      )}
                      
                      {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                      <div className="space-y-3 pt-4 border-t border-[#E5E7EB]">
                        <button 
                          onClick={async () => {
                            try {
                              // –°–æ–∑–¥–∞–µ–º —Å–¥–µ–ª–∫—É –≤ –ë–î
                              const dealData = {
                                title: `–°–¥–µ–ª–∫–∞ —Å ${selectedCrmClient.name}`,
                                stage: '–ù–æ–≤—ã–µ',
                                lead_quality: 'warm',
                                amount: 0,
                                owner: 'ai',
                                owner_name: '–ò–ò-–∞–≥–µ–Ω—Ç',
                                is_resolved: false,
                                description: `–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ ${selectedCrmClient.name}`,
                                client_id: selectedCrmClient.id,
                                dialog_id: null
                              };
                              
                              const createdDeal = await crmAPI.createDeal(currentUser?.id, dealData);
                              console.log('Deal created in Supabase:', createdDeal);
                              
                              // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                              const newDealObj = {
                                id: createdDeal.id,
                                title: dealData.title,
                                company: selectedCrmClient.company || '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
                                amount: dealData.amount,
                                days: 0, // –õ–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
                                stage: dealData.stage,
                                leadQuality: dealData.lead_quality,
                                hasContacts: !!(selectedCrmClient.email || selectedCrmClient.phone),
                                owner: dealData.owner,
                                ownerName: dealData.owner_name,
                                isResolved: dealData.is_resolved,
                                client: {
                                  name: selectedCrmClient.name,
                                  email: selectedCrmClient.email || '',
                                  phone: selectedCrmClient.phone || '',
                                  company: selectedCrmClient.company || ''
                                },
                                notes: dealData.description,
                                createdDate: new Date().toISOString().split('T')[0],
                                lastContact: new Date().toISOString().split('T')[0],
                                dialogId: dealData.dialog_id || ''
                              };
                              
                              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º CRM –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
                              await reloadCRMData();
                              setCrmClientSidebarOpen(false);
                              setCrmActiveTab('deals');
                            } catch (error) {
                              console.error('Error creating deal:', error);
                              alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏: ' + error.message);
                            }
                          }}
                          className="w-full h-[34px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0070E6] transition-colors flex items-center justify-center"
                          style={BUTTON_STYLES.blueButton}
                        >
                          –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏ */}
            {taskSidebarOpen && selectedTask && (
              <>
                <div 
                  className="fixed inset-0 bg-black bg-opacity-50 z-[9998]"
                  style={{ marginTop: 0 }}
                  onClick={() => setTaskSidebarOpen(false)}
                />
                <div className="fixed right-0 top-0 h-full w-[500px] bg-white shadow-2xl z-[9999] transform transition-transform duration-300 ease-in-out" style={{ borderTopLeftRadius: '20px', borderBottomLeftRadius: '20px', marginTop: 0 }}>
                  <div className="h-full flex flex-col">
                    {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏ */}
                    <div className="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
                      <h2 className="text-[18px] font-[500] text-[#070F1A]">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</h2>
                      <button
                        onClick={() => setTaskSidebarOpen(false)}
                        className="w-8 h-8 rounded-[90px] bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ color: '#8E8E93' }}>
                          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                      </button>
                    </div>
                    
                    {/* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–∞–Ω–µ–ª–∏ */}
                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                      {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                      <div>
                        <h3 className="text-[16px] font-[500] text-[#070F1A] mb-3">{selectedTask.title}</h3>
                        <div className="space-y-2">
                          <div className="flex justify-between">
                            <span className="text-[14px] text-[#8E8E93]">–°—Ç–∞—Ç—É—Å:</span>
                            <span className={`px-3 py-1 text-[12px] font-[500] rounded-[6px] ${
                              selectedTask.status === 'completed' ? 'bg-green-100 text-green-600' :
                              selectedTask.status === 'in_progress' ? 'bg-blue-100 text-blue-600' :
                              'bg-yellow-100 text-yellow-600'
                            }`}>
                              {selectedTask.status === 'completed' ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' :
                               selectedTask.status === 'in_progress' ? '–í —Ä–∞–±–æ—Ç–µ' : '–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é'}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-[14px] text-[#8E8E93]">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</span>
                            <span className={`px-3 py-1 text-[12px] font-[500] rounded-[6px] ${
                              selectedTask.priority === 'high' ? 'bg-red-100 text-red-600' :
                              selectedTask.priority === 'medium' ? 'bg-orange-100 text-orange-600' :
                              'bg-green-100 text-green-600'
                            }`}>
                              {selectedTask.priority === 'high' ? '–í—ã—Å–æ–∫–∏–π' :
                               selectedTask.priority === 'medium' ? '–°—Ä–µ–¥–Ω–∏–π' : '–ù–∏–∑–∫–∏–π'}
                            </span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-[14px] text-[#8E8E93]">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</span>
                            <div className="flex items-center gap-2">
                              <div className="relative executor-dropdown">
                                <button
                                  onClick={() => selectedTask.assignee !== 'ai' && toggleExecutorDropdown('task')}
                                  className={`text-[12px] text-[#070F1A] flex items-center gap-2 ${selectedTask.assignee === 'ai' ? 'cursor-default' : 'hover:opacity-80 transition-opacity'}`}
                                >
                                  {selectedTask.assignee === 'ai' ? (
                                    <img src="/Frame 205.svg" alt="–ò–ò" className="w-[12px] h-[12px] align-middle" />
                                  ) : (
                                    <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-[12px] h-[12px] align-middle" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                                  )}
                                  {selectedTask.assigneeName}
                                  {selectedTask.assignee !== 'ai' && (
                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                    </svg>
                                  )}
                                </button>
                                {executorDropdowns.task && (
                                  <div className="absolute top-full right-0 mt-1 bg-white border border-[#E5E7EB] rounded-[10px] shadow-lg z-50 min-w-[160px]">
                                    <div className="p-2 space-y-1">
                                      <div 
                                        className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                        onClick={() => {
                                          setTasks(prev => prev.map(task => 
                                            task.id === selectedTask.id 
                                              ? { ...task, assignee: 'ai', assigneeName: '–ò–ò-–∞–≥–µ–Ω—Ç' }
                                              : task
                                          ));
                                          setSelectedTask(prev => ({ ...prev, assignee: 'ai', assigneeName: '–ò–ò-–∞–≥–µ–Ω—Ç' }));
                                          setExecutorDropdowns(prev => ({...prev, task: false}));
                                        }}
                                      >
                                        <img src="/Frame 205.svg" alt="–ò–ò" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                                        <span className="text-[13px] text-[#070F1A]">–ò–ò-–∞–≥–µ–Ω—Ç</span>
                                      </div>
                                      <div 
                                        className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                        onClick={() => {
                                          setTasks(prev => prev.map(task => 
                                            task.id === selectedTask.id 
                                              ? { ...task, assignee: 'operator-1', assigneeName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' }
                                              : task
                                          ));
                                          setSelectedTask(prev => ({ ...prev, assignee: 'operator-1', assigneeName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' }));
                                          setExecutorDropdowns(prev => ({...prev, task: false}));
                                        }}
                                      >
                                        <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                                        <span className="text-[13px] text-[#070F1A]">–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞</span>
                                      </div>
                                      <div 
                                        className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                                        onClick={() => {
                                          setTasks(prev => prev.map(task => 
                                            task.id === selectedTask.id 
                                              ? { ...task, assignee: 'operator-2', assigneeName: '–ú–∏—Ö–∞–∏–ª –°–∏–¥–æ—Ä–æ–≤' }
                                              : task
                                          ));
                                          setSelectedTask(prev => ({ ...prev, assignee: 'operator-2', assigneeName: '–ú–∏—Ö–∞–∏–ª –°–∏–¥–æ—Ä–æ–≤' }));
                                          setExecutorDropdowns(prev => ({...prev, task: false}));
                                        }}
                                      >
                                        <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                                        <span className="text-[13px] text-[#070F1A]">–ú–∏—Ö–∞–∏–ª –°–∏–¥–æ—Ä–æ–≤</span>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-[14px] text-[#8E8E93]">–î–µ–¥–ª–∞–π–Ω:</span>
                            <div className="flex items-center gap-2">
                              {!editingTaskDeadline ? (
                                <>
                                  <span className="text-[13px] text-[#070F1A]">
                                    {selectedTask.dueDate ? new Date(selectedTask.dueDate).toLocaleDateString() : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
                                  </span>
                                  <button
                                    onClick={startEditingTaskDeadline}
                                    className="text-[12px] text-[#0084FF] hover:text-[#0066CC] transition-colors"
                                  >
                                    –ò–∑–º–µ–Ω–∏—Ç—å
                                  </button>
                                </>
                              ) : (
                                <div className="flex items-center gap-2">
                                  <input
                                    type="date"
                                    value={editedTaskDeadline}
                                    onChange={(e) => setEditedTaskDeadline(e.target.value)}
                                    className="text-[12px] border border-[#E5E7EB] rounded-[6px] px-2 py-1 focus:outline-none focus:border-[#0084FF]"
                                  />
                                  <button
                                    onClick={saveTaskDeadline}
                                    className="text-[12px] text-[#0084FF] hover:text-[#0066CC] transition-colors"
                                  >
                                    ‚úì
                                  </button>
                                  <button
                                    onClick={cancelEditingTaskDeadline}
                                    className="text-[12px] text-[#8E8E93] hover:text-[#070F1A] transition-colors"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-[14px] text-[#8E8E93]">–°–æ–∑–¥–∞–Ω–∞:</span>
                            <span className="text-[13px] text-[#070F1A]">
                              {new Date(selectedTask.createdDate).toLocaleDateString()}
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      {/* –û–ø–∏—Å–∞–Ω–∏–µ */}
                      <div>
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="text-[16px] font-[500] text-[#070F1A]">–û–ø–∏—Å–∞–Ω–∏–µ</h4>
                          {!editingTaskDescription && (
                            <button
                              onClick={startEditingTaskDescription}
                              className="text-[12px] text-[#0084FF] hover:text-[#0066CC] transition-colors"
                            >
                              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                          )}
                        </div>
                        
                        {editingTaskDescription ? (
                          <div>
                            <textarea
                              value={editedTaskDescription}
                              onChange={(e) => setEditedTaskDescription(e.target.value)}
                              className="w-full h-24 p-3 border border-[#E5E7EB] rounded-[10px] text-[12px] resize-none focus:outline-none focus:border-[#0084FF]"
                              placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..."
                            />
                            <div className="flex gap-2 mt-2">
                              <button
                                onClick={saveTaskDescription}
                                className="px-3 py-1 bg-[#0084FF] text-white text-[12px] rounded-[90px] hover:bg-[#0073E6] transition-colors h-[34px]"
                              >
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                              </button>
                              <button
                                onClick={cancelEditingTaskDescription}
                                className="px-3 py-1 bg-gray-200 text-gray-700 text-[12px] rounded-[90px] hover:bg-gray-300 transition-colors h-[34px]"
                              >
                                –û—Ç–º–µ–Ω–∞
                              </button>
                            </div>
                          </div>
                        ) : (
                          <div className="bg-[#F8F9FA] rounded-[15px] p-4">
                            <p className="text-[12px] text-[#070F1A] leading-relaxed">
                              {selectedTask.description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ'}
                            </p>
                          </div>
                        )}
                      </div>
                      
                      {/* –ó–∞–º–µ—Ç–∫–∏ */}
                      <div>
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="text-[16px] font-[500] text-[#070F1A]">–ó–∞–º–µ—Ç–∫–∏</h4>
                          {!editingTaskNotes && (
                            <button
                              onClick={startEditingTaskNotes}
                              className="text-[12px] text-[#0084FF] hover:text-[#0066CC] transition-colors"
                            >
                              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                          )}
                        </div>
                        
                        {editingTaskNotes ? (
                          <div>
                            <textarea
                              value={editedTaskNotes}
                              onChange={(e) => setEditedTaskNotes(e.target.value)}
                              className="w-full h-24 p-3 border border-[#E5E7EB] rounded-[10px] text-[12px] resize-none focus:outline-none focus:border-[#0084FF]"
                              placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –∫ –∑–∞–¥–∞—á–µ..."
                            />
                            <div className="flex gap-2 mt-2">
                              <button
                                onClick={saveTaskNotes}
                                className="px-3 py-1 bg-[#0084FF] text-white text-[12px] rounded-[90px] hover:bg-[#0073E6] transition-colors h-[34px]"
                              >
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                              </button>
                              <button
                                onClick={cancelEditingTaskNotes}
                                className="px-3 py-1 bg-gray-200 text-gray-700 text-[12px] rounded-[90px] hover:bg-gray-300 transition-colors h-[34px]"
                              >
                                –û—Ç–º–µ–Ω–∞
                              </button>
                            </div>
                          </div>
                        ) : (
                          <div className="bg-[#F8F9FA] rounded-[15px] p-4">
                            <p className="text-[12px] text-[#070F1A] leading-relaxed">
                              {selectedTask.notes || '–ó–∞–º–µ—Ç–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã'}
                            </p>
                          </div>
                        )}
                      </div>
                      
                      {/* –î–µ–π—Å—Ç–≤–∏—è */}
                      <div>
                        <h4 className="text-[16px] font-[500] text-[#070F1A] mb-3">–î–µ–π—Å—Ç–≤–∏—è</h4>
                        <div className="space-y-2">
                          <button 
                            onClick={() => {
                              updateTask(selectedTask.id, { status: selectedTask.status === 'completed' ? 'pending' : 'completed' });
                              setSelectedTask({...selectedTask, status: selectedTask.status === 'completed' ? 'pending' : 'completed'});
                            }}
                            className={`w-full h-[34px] rounded-[10px] text-[14px] font-[500] transition-colors ${
                              selectedTask.status === 'completed' 
                                ? 'bg-yellow-100 text-yellow-600 hover:bg-yellow-200' 
                                : 'bg-green-100 text-green-600 hover:bg-green-200'
                            }`}
                          >
                            {selectedTask.status === 'completed' ? '–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É' : '–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π'}
                          </button>
                          
                          <button 
                            onClick={() => {
                              if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
                                deleteTask(selectedTask.id);
                              }
                            }}
                            className="w-full h-[34px] bg-red-100 text-red-600 rounded-[10px] text-[14px] font-[500] hover:bg-red-200 transition-colors flex items-center justify-center"
                          >
                            –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </>
            )}
          </div>
        );

      case 'notifications':
        return (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h1 className="text-[20px] font-[500]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h1>
            </div>
            
            {/* –ü–ª–∞—à–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Telegram –±–æ—Ç–∞ */}
            <div className="border border-[#070F1A]/10 rounded-[16px] p-5">
              <div className="flex items-center gap-2 mb-2">
                <h3 className="text-[18px] font-medium text-[#070F1A]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤</h3>
                <div className="flex items-center gap-1">
                  <span className="text-[18px] font-medium text-[#070F1A]">Telegram</span>
                  <img 
                    src="/Vector 712783.svg" 
                    alt="Telegram" 
                    className="w-[15px] h-[13px]"
                  />
                </div>
              </div>
              <p className="text-[14px] text-[#8E8E93] mb-6">
                –ü–æ–ª—É—á–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö –æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —á–∞—Ç–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ —Ç–¥. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –±—ã—Ç—å –Ω–∞ —Å–≤—è–∑–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ –∏ –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞—Ö –¥–∏–∞–ª–æ–≥–æ–≤ —á–µ–ª–æ–≤–µ–∫–æ–º!
              </p>
              
              <div className="mt-[30px]">
                <p className="text-[14px] font-[500] text-[#070F1A] mb-4">
                  –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://t.me/Adapto_notifications_bot" target="_blank" rel="noopener noreferrer" className="text-[#0084FF] hover:underline">–Ω–∞—à Telegram-–±–æ—Ç</a> –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <span className="text-[#0084FF]">/start</span>.
                  <br />
                  –ü–æ—Å–ª–µ —á–µ–≥–æ –±–æ—Ç –≤—ã—à–ª–µ—Ç API –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ –Ω–∏–∂–µ
                </p>
                
                <div className="flex gap-[10px]">
                  <input
                    type="text"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –∏–∑ Telegram –±–æ—Ç–∞"
                    value={telegramApiKey}
                    onChange={(e) => setTelegramApiKey(e.target.value)}
                    className="flex-1 h-10 px-4 border border-[#E5E7EB] rounded-[10px] text-[13px] font-[400] focus:outline-none focus:border-[#0084FF]"
                    style={INPUT_STYLES.inputField}
                  />
                  <button 
                    onClick={handleConnectTelegram}
                    disabled={isConnectingTelegram}
                    className="h-10 px-6 bg-[#0084FF] text-white rounded-[10px] text-[13px] font-[500] hover:bg-[#0073E6] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    style={BUTTON_STYLES.blueButton}
                  >
                    {isConnectingTelegram ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å'}
                  </button>
                </div>
              </div>
            </div>

            {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */}
            <div className="border border-[#070F1A]/10 rounded-[16px] p-5">
              <h3 className="text-[18px] font-medium text-[#070F1A] mb-4">–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>

              <div className="space-y-4">
                <div className="flex items-center justify-between p-3 bg-gray-50 rounded-[12px]">
                  <div>
                    <p className="text-[14px] font-[500] text-[#070F1A]">–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö</p>
                    <p className="text-[12px] text-[#8E8E93]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
                  </div>
                  <img 
                    src={telegramSettings?.notification_types?.includes('new_messages') ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                    alt="–í–∫–ª—é—á–∏—Ç—å" 
                    className="w-[34px] h-[34px] cursor-pointer hover:opacity-80 transition-opacity" 
                    onClick={() => toggleNotificationType('new_messages')}
                  />
                </div>
                
                <div className="flex items-center justify-between p-3 bg-gray-50 rounded-[12px]">
                  <div>
                    <p className="text-[14px] font-[500] text-[#070F1A]">–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º</p>
                    <p className="text-[12px] text-[#8E8E93]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–≥–¥–∞ –¥–∏–∞–ª–æ–≥ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —á–µ–ª–æ–≤–µ–∫</p>
                  </div>
                  <img 
                    src={telegramSettings?.notification_types?.includes('operator_takeover') ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                    alt="–í–∫–ª—é—á–∏—Ç—å" 
                    className="w-[34px] h-[34px] cursor-pointer hover:opacity-80 transition-opacity" 
                    onClick={() => toggleNotificationType('operator_takeover')}
                  />
                </div>
                
                <div className="flex items-center justify-between p-3 bg-gray-50 rounded-[12px]">
                  <div>
                    <p className="text-[14px] font-[500] text-[#070F1A]">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
                    <p className="text-[12px] text-[#8E8E93]">–°–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–µ–≤—ã—à–µ–Ω—ã –ª–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤</p>
                  </div>
                  <img 
                    src={telegramSettings?.notification_types?.includes('system_alerts') ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                    alt="–í–∫–ª—é—á–∏—Ç—å" 
                    className="w-[34px] h-[34px] cursor-pointer hover:opacity-80 transition-opacity" 
                    onClick={() => toggleNotificationType('system_alerts')}
                  />
                </div>

                <div className="flex items-center justify-between p-3 bg-gray-50 rounded-[12px]">
                  <div className="flex-1">
                    <p className="text-[14px] font-[500] text-[#070F1A]">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã</p>
                    <p className="text-[12px] text-[#8E8E93]">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
                    <button
                      onClick={sendDailyReport}
                      className="mt-2 px-3 py-1 text-[12px] font-[500] text-white rounded-[6px] transition-colors"
                      style={{ backgroundColor: '#0084FF' }}
                    >
                      –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç
                    </button>
                  </div>
                  <img 
                    src={telegramSettings?.notification_types?.includes('daily_reports') ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                    alt="–í–∫–ª—é—á–∏—Ç—å" 
                    className="w-[34px] h-[34px] cursor-pointer hover:opacity-80 transition-opacity" 
                    onClick={() => toggleNotificationType('daily_reports')}
                  />
                </div>
              </div>
            </div>
          </div>
        );

      case 'stories-management':
        return (
          <div className="p-0">
            <div className="text-left mb-[16px]">
              <h1 className="text-[20px] font-[500] text-[#070F1A]">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ—Ä–∏—Å</h1>
            </div>
            
            <div className="h-px bg-[#E5E7EB] mb-[30px]" style={{ marginLeft: '-32px', marginRight: '-32px' }}></div>

            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h2 className="text-[16px] font-[500] text-[#070F1A]">–¢–µ–∫—É—â–∏–µ —Å—Ç–æ—Ä–∏—Å</h2>
                <button
                  onClick={() => setShowStoriesModal(true)}
                  className="bg-[#0084FF] text-white px-4 py-2 rounded-[10px] text-[14px] font-[500] hover:bg-[#0070E6] transition-colors"
                >
                  –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ—Ä–∏—Å
                </button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {stories.map((story) => (
                  <div key={story.id} className="bg-white border border-[#E5E7EB] rounded-[12px] p-4">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-[50px] h-[50px] border border-[#0084FF] rounded-[50px] flex items-center justify-center">
                        <div className="w-[46px] h-[46px] bg-white rounded-[50px] relative overflow-hidden">
                          <img 
                            src={story.image_url} 
                            alt={story.title} 
                            className="w-full h-full object-cover" 
                          />
                        </div>
                      </div>
                      <div className="flex-1">
                        <h3 className="text-[14px] font-[500] text-[#070F1A]">{story.title}</h3>
                        <p className="text-[12px] text-[#8E8E93]">–ü–æ—Ä—è–¥–æ–∫: {story.order_index}</p>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setEditingStory(story)}
                        className="flex-1 bg-[#F3F4F6] text-[#070F1A] px-3 py-2 rounded-[8px] text-[12px] font-[500] hover:bg-[#E5E7EB] transition-colors"
                      >
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                      </button>
                      <button
                        onClick={() => handleDeleteStory(story.id)}
                        className="flex-1 bg-[#FEF2F2] text-[#DC2626] px-3 py-2 rounded-[8px] text-[12px] font-[500] hover:bg-[#FEE2E2] transition-colors"
                      >
                        –£–¥–∞–ª–∏—Ç—å
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );

      default:
        return <div className="text-center py-8 text-gray-500">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>;
    }
  };

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ)
  if (false && isLoggedIn && !userAccess.hasAccess) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="max-w-4xl w-full mx-4">
          <div className="bg-white rounded-2xl shadow-lg p-8">
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
            <div className="text-center mb-8">
              <img src="/–õ–æ–≥–æ—Ç–∏–ø-–±–ª—ç–∫.svg" alt="Adapto" className="h-12 mx-auto mb-4" />
              <h1 className="text-3xl font-bold text-gray-900 mb-2">
                {userAccess.reason === 'trial_expired' ? '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω' : 
                 userAccess.reason === 'days_expired' ? '–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ' :
                 userAccess.reason === 'tokens_expired' ? '–õ–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω' :
                 '–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω'}
              </h1>
              <p className="text-gray-600">
                {userAccess.reason === 'trial_expired' ? '–í–∞—à 7-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.' :
                 userAccess.reason === 'days_expired' ? '–í—Ä–µ–º—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –∏—Å—Ç–µ–∫–ª–æ. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.' :
                 userAccess.reason === 'tokens_expired' ? '–í—ã –∏—Å—á–µ—Ä–ø–∞–ª–∏ –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤.' :
                 '–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∞—Ä–∏—Ñ.'}
              </p>
            </div>

            {/* –¢–∞—Ä–∏—Ñ—ã */}
            <div className="grid md:grid-cols-3 gap-6 mb-8">
              {/* Free —Ç–∞—Ä–∏—Ñ */}
              <div className="border-2 border-gray-200 rounded-xl p-6 relative">
                <div className="text-center">
                  <h3 className="text-xl font-semibold text-gray-900 mb-2">Free</h3>
                  <div className="text-3xl font-bold text-gray-900 mb-4">0‚ÇΩ</div>
                  <p className="text-gray-600 mb-6">–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω</p>
                  <ul className="text-sm text-gray-600 space-y-2 mb-6">
                    <li>‚ùå –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</li>
                    <li>‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤</li>
                    <li>‚ùå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</li>
                  </ul>
                  <button 
                    disabled
                    className="w-full py-3 px-4 border border-gray-300 rounded-lg text-gray-400 cursor-not-allowed"
                  >
                    –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ
                  </button>
                </div>
              </div>

              {/* Pro —Ç–∞—Ä–∏—Ñ */}
              <div className="border-2 border-blue-500 rounded-xl p-6 relative bg-blue-50">
                <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                  <span className="bg-blue-500 text-white px-4 py-1 rounded-[90px] text-sm font-medium">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</span>
                </div>
                <div className="text-center">
                  <h3 className="text-xl font-semibold text-gray-900 mb-2">Pro</h3>
                  <div className="text-3xl font-bold text-gray-900 mb-4">2,990‚ÇΩ<span className="text-lg text-gray-600">/–º–µ—Å</span></div>
                  <p className="text-gray-600 mb-6">–î–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞</p>
                  <ul className="text-sm text-gray-600 space-y-2 mb-6">
                    <li>‚úÖ 10,000 —Ç–æ–∫–µ–Ω–æ–≤ –≤ –º–µ—Å—è—Ü</li>
                    <li>‚úÖ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ</li>
                    <li>‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7</li>
                    <li>‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã</li>
                  </ul>
                  <button className="w-full py-3 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    –í—ã–±—Ä–∞—Ç—å Pro
                  </button>
                </div>
              </div>

              {/* Enterprise —Ç–∞—Ä–∏—Ñ */}
              <div className="border-2 border-gray-200 rounded-xl p-6 relative">
                <div className="text-center">
                  <h3 className="text-xl font-semibold text-gray-900 mb-2">Enterprise</h3>
                  <div className="text-3xl font-bold text-gray-900 mb-4">9,990‚ÇΩ<span className="text-lg text-gray-600">/–º–µ—Å</span></div>
                  <p className="text-gray-600 mb-6">–î–ª—è –∫—Ä—É–ø–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞</p>
                  <ul className="text-sm text-gray-600 space-y-2 mb-6">
                    <li>‚úÖ 50,000 —Ç–æ–∫–µ–Ω–æ–≤ –≤ –º–µ—Å—è—Ü</li>
                    <li>‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</li>
                    <li>‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</li>
                    <li>‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</li>
                  </ul>
                  <button className="w-full py-3 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    –í—ã–±—Ä–∞—Ç—å Enterprise
                  </button>
                </div>
              </div>
            </div>

            {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
            <div className="text-center text-sm text-gray-500">
              <p>–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –≤—ã–±–æ—Ä–æ–º —Ç–∞—Ä–∏—Ñ–∞? <a href="#" className="text-blue-500 hover:underline">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</a></p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Auth screen
  if (!isLoggedIn) {
    // –î–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ö–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –¥–∏–∑–∞–π–Ω
    if (currentStep === 'login') {
        return (
        <div className="h-screen flex bg-white">
          {/* –õ–µ–≤–∞—è —á–∞—Å—Ç—å - —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ */}
          <div className="w-1/2 bg-white flex flex-col">
            {/* –õ–æ–≥–æ—Ç–∏–ø —Å–≤–µ—Ä—Ö—É */}
            <div className="pt-10 flex justify-center">
              <img src="/–õ–æ–≥–æ—Ç–∏–ø-–±–ª—ç–∫.svg" alt="Adapto" className="h-8" />
            </div>
            
            {/* –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ */}
            <div className="flex-1 flex items-center justify-center p-8">
              <div className="w-full max-w-md space-y-8">
                <div className="text-center">
                  <h2 className="text-[24px] font-[500] text-[#070F1A]">–í—Ö–æ–¥ –≤ Adapto</h2>
                </div>
                
          <div className="space-y-[15px]">
                  <form onSubmit={handleLoginSubmit} className="space-y-[15px]">
                    <div>
                      <label className="block text-[13px] font-medium mb-2 text-[#070F1A]">Email</label>
                      <Input
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                        placeholder="your@email.com"
                        required
                        className="h-[34px] rounded-[10px] bg-white text-[#070F1A] placeholder-[#8E8E93] focus:outline-none"
                        style={INPUT_STYLES.inputField}
                      />
                    </div>
                    
                    <div>
                      <label className="block text-[13px] font-medium mb-2 text-[#070F1A]">–ü–∞—Ä–æ–ª—å</label>
                      <Input
                        type="password"
                        value={formData.password}
                        onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                        required
                        className="h-[34px] rounded-[10px] bg-white text-[#070F1A] placeholder-[#8E8E93] focus:outline-none"
                        style={INPUT_STYLES.inputField}
                      />
                    </div>
                    
                    {formErrors.general && (
                      <div className="text-red-400 text-sm">{formErrors.general}</div>
                    )}
                    
                    <Button 
                      type="submit" 
                      className="w-full h-[34px] rounded-[10px] text-white bg-[#0084FF] hover:bg-[#0073E6] transition-colors"
                      style={BUTTON_STYLES.blueButton}
                    >
                      –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
                    </Button>
                    
                    <div className="text-center">
                      <button
                        type="button"
                        className="text-[#8E8E93] hover:text-[#070F1A] text-sm"
                      >
                        –ó–∞–±—ã–ª –ø–∞—Ä–æ–ª—å?
                      </button>
            </div>

                    <div className="text-center">
                      <span className="text-[#8E8E93] text-sm">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? </span>
                      <button
                        type="button"
                        onClick={() => setCurrentStep('register')}
                        className="text-[#0084FF] hover:text-[#0073E6] text-sm font-[500]"
                      >
                        –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                      </button>
                  </div>
                  </form>
                    </div>
                    </div>
                    </div>
                    </div>
          
          {/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - —Å–ª–∞–π–¥–µ—Ä */}
          <div className="w-1/2 relative p-[15px]">
            <div className="w-full h-[calc(100vh-30px)] rounded-[20px] overflow-hidden transition-all duration-1000">
              <img 
                src={slideImages[currentSlide]}
                alt={`Slide ${currentSlide + 1}`}
                className={`w-full h-full object-cover object-center transition-all duration-1000 ease-in-out ${
                  isTransitioning ? 'opacity-50' : 'opacity-100'
                }`}
                onError={(e) => {
                  console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', slideImages[currentSlide]);
                  e.target.style.display = 'none';
                }}
              />
              {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–ª–∞–π–¥–µ—Ä–∞ –≤–Ω–∏–∑—É */}
              <div className="absolute bottom-[35px] left-1/2 transform -translate-x-1/2">
                <div className="bg-white bg-opacity-20 w-[96px] h-[24px] rounded-[90px] flex items-center justify-center gap-2 px-2">
                  {[0, 1, 2, 3, 4].map((index) => (
                    <div
                      key={index}
                      className={`w-2 h-2 rounded-[90px] transition-all duration-300 ${
                        index === currentSlide 
                          ? 'bg-white bg-opacity-100' 
                          : 'bg-white bg-opacity-30'
                      }`}
                    />
                  ))}
                </div>
          </div>
            </div>
          </div>
        </div>
      );
    }
    
        // –î–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –¥–∏–∑–∞–π–Ω
        return (
      <div className="h-screen flex bg-white">
        {/* –õ–µ–≤–∞—è —á–∞—Å—Ç—å - —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */}
        <div className="w-1/2 bg-white flex flex-col">
          {/* –õ–æ–≥–æ—Ç–∏–ø —Å–≤–µ—Ä—Ö—É */}
          <div className="pt-10 flex justify-center">
            <img src="/–õ–æ–≥–æ—Ç–∏–ø-–±–ª—ç–∫.svg" alt="Adapto" className="h-8" />
          </div>
          
          {/* –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */}
          <div className="flex-1 flex items-center justify-center p-8">
            <div className="w-full max-w-md space-y-8">
              <div className="text-center">
                <h2 className="text-[24px] font-[500] text-[#070F1A]">
                  {inviteToken ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'}
                </h2>
                {inviteToken && (
                  <p className="text-[14px] text-[#8E8E93] mt-2">
                    –í–∞—Å –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ –≤ –∫–æ–º–∞–Ω–¥—É –∫–∞–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                  </p>
                )}
              </div>
              
          <div className="space-y-[15px]">
                <form onSubmit={inviteToken ? handleOperatorRegisterSubmit : handleRegisterSubmit} className="space-y-[15px]">
                  {/* –ò–º—è –∏ –ö–æ–º–ø–∞–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ */}
                  <div className={inviteToken ? "grid grid-cols-1 gap-5" : "grid grid-cols-2 gap-5"}>
                    <div>
                      <label className="block text-[13px] font-medium mb-2 text-[#070F1A]">–ò–º—è</label>
                      <Input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        placeholder="–í–∞—à–µ –∏–º—è"
                        required
                        className="h-[34px] rounded-[10px] border border-[#070F1A] border-opacity-10 bg-white text-[#070F1A] placeholder-[#8E8E93] focus:border-[#070F1A] focus:border-opacity-20 font-[400]"
                      />
                    </div>
                    
                    {!inviteToken && (
                      <div>
                        <label className="block text-[13px] font-medium mb-2 text-[#070F1A]">–ö–æ–º–ø–∞–Ω–∏—è</label>
                        <Input
                          type="text"
                          value={formData.company}
                          onChange={(e) => setFormData({ ...formData, company: e.target.value })}
                          placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏"
                          required
                          className="h-[34px] rounded-[10px] border border-[#070F1A] border-opacity-10 bg-white text-[#070F1A] placeholder-[#8E8E93] focus:border-[#070F1A] focus:border-opacity-20 font-[400]"
                        />
                      </div>
                    )}
                </div>
                
                  {/* Email –∏ –¢–µ–ª–µ—Ñ–æ–Ω –Ω–∞ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ */}
                  <div className={inviteToken ? "grid grid-cols-1 gap-5" : "grid grid-cols-2 gap-5"}>
                <div>
                      <label className="block text-[13px] font-medium mb-2 text-[#070F1A]">Email</label>
                      <Input
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                        placeholder="your@email.com"
                        required
                        className="h-[34px] rounded-[10px] bg-white text-[#070F1A] placeholder-[#8E8E93] focus:outline-none"
                        style={INPUT_STYLES.inputField}
                  />
                </div>

                {!inviteToken && (
                  <div>
                    <label className="block text-[13px] font-medium mb-2 text-[#070F1A]">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <Input
                      type="tel"
                      value={formData.phone}
                      onChange={(e) => {
                        const formatted = formatPhoneNumber(e.target.value);
                        setFormData({ ...formData, phone: formatted });
                        const error = validatePhone(formatted);
                        setValidationErrors({ ...validationErrors, phone: error });
                      }}
                      placeholder="+7 (999) 123-45-67"
                      required
                      className="h-[34px] rounded-[10px] bg-white text-[#070F1A] placeholder-[#8E8E93] focus:outline-none"
                      style={INPUT_STYLES.inputField}
                    />
                  </div>
                )}
                </div>

                  {/* –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */}
                  {validationErrors.phone && (
                    <div className="text-red-400 text-sm mt-1">{validationErrors.phone}</div>
                  )}
                  
                  <div>
                    <label className="block text-[13px] font-medium mb-2 text-[#070F1A]">–ü–∞—Ä–æ–ª—å</label>
                    <Input
                      type="password"
                      value={formData.password}
                      onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                      placeholder="–°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å"
                      required
                      className="h-[34px] rounded-[10px] bg-white text-[#070F1A] placeholder-[#8E8E93] focus:outline-none"
                      style={INPUT_STYLES.inputField}
                    />
                  </div>
                  
                  <Button 
                    type="submit" 
                    className="w-full h-[34px] rounded-[10px] text-white bg-[#0084FF] hover:bg-[#0073E6] transition-colors"
                    style={BUTTON_STYLES.blueButton}
                  >
                    {inviteToken ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç'}
                </Button>
                  
                  <div className="text-center space-y-4">
                    <p className="text-xs text-[#8E8E93] leading-relaxed">
                      –ù–∞–∂–∏–º–∞—è "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç", –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –û—Ñ–µ—Ä—Ç—ã –∏ –¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ü–æ–ª–∏—Ç–∏–∫–æ–π –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
                    </p>
                    <span className="text-[#8E8E93] text-sm">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? </span>
                    <button
                      type="button"
                      onClick={() => setCurrentStep('login')}
                      className="text-[#0084FF] hover:text-[#0073E6] text-sm font-[500]"
                    >
                      –í–æ–π—Ç–∏
                    </button>
          </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        
        {/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - —Å–ª–∞–π–¥–µ—Ä */}
        <div className="w-1/2 relative p-[15px]">
          <div className="w-full h-[calc(100vh-30px)] rounded-[20px] overflow-hidden transition-all duration-1000">
            <img 
              src={slideImages[currentSlide]}
              alt={`Slide ${currentSlide + 1}`}
              className={`w-full h-full object-cover object-center transition-all duration-1000 ease-in-out ${
                isTransitioning ? 'opacity-50' : 'opacity-100'
              }`}
              onError={(e) => {
                console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', slideImages[currentSlide]);
                e.target.style.display = 'none';
              }}
            />
            {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–ª–∞–π–¥–µ—Ä–∞ –≤–Ω–∏–∑—É */}
            <div className="absolute bottom-[35px] left-1/2 transform -translate-x-1/2">
              <div className="bg-white bg-opacity-20 w-[96px] h-[24px] rounded-[90px] flex items-center justify-center gap-2 px-2">
                {[0, 1, 2, 3, 4].map((index) => (
                  <div
                    key={index}
                    className={`w-2 h-2 rounded-[90px] transition-all duration-300 ${
                      index === currentSlide 
                        ? 'bg-white bg-opacity-100' 
                        : 'bg-white bg-opacity-30'
                    }`}
                  />
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // üîÑ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loading –ø–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é (—É–±–∏—Ä–∞–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏–µ)
  if (isLoadingAuth) {
    return (
      <div className="h-screen flex items-center justify-center bg-[#F2F3F4]">
        <div className="text-center">
          <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#0084FF]"></div>
          <p className="mt-4 text-[#8E8E93]">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>
    );
  }

  // Main dashboard
  return (
    <div className={`h-screen flex ${theme === 'light' ? 'bg-[#F2F3F4]' : 'bg-[#070F1A]'}`}>
      {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–æ–ª–µ–π —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤ */}
      {currentUser?.role === 'super_admin' && (
        <div className="fixed top-4 right-4 z-50 bg-gray-800 text-white p-3 rounded-lg shadow-lg">
          <div className="text-sm mb-2">–†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞):</div>
          <div className="flex gap-2">
            <button 
              onClick={() => handleSwitchRole('admin')}
              className={`px-3 py-1 rounded text-xs transition-colors ${
                currentUser?.role === 'admin' ? 'bg-green-500' : 'bg-gray-600 hover:bg-gray-500'
              }`}
            >
              –ê–¥–º–∏–Ω
            </button>
            <button 
              onClick={() => handleSwitchRole('operator')}
              className={`px-3 py-1 rounded text-xs transition-colors ${
                currentUser?.role === 'operator' ? 'bg-green-500' : 'bg-gray-600 hover:bg-gray-500'
              }`}
            >
              –û–ø–µ—Ä–∞—Ç–æ—Ä
            </button>
            <button 
              onClick={() => handleSwitchRole('user')}
              className={`px-3 py-1 rounded text-xs transition-colors ${
                currentUser?.role === 'user' ? 'bg-green-500' : 'bg-gray-600 hover:bg-gray-500'
              }`}
            >
              –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            </button>
            <button 
              onClick={clearUserData}
              className="px-3 py-1 rounded text-xs bg-red-600 hover:bg-red-700 text-white transition-colors"
            >
              –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
          </div>
        </div>
      )}

      {/* Notification */}
      {showNotification && (
        <div className="fixed top-4 right-4 z-50 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300">
          <div className="text-sm font-medium mb-[11px]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
          <div className="flex items-center justify-between">
            <span className="text-sm">{notificationMessage}</span>
            <button 
              onClick={() => setShowNotification(false)}
              className="ml-4 text-red-600 hover:text-red-800 transition-colors"
            >
              √ó
            </button>
          </div>
        </div>
      )}

      {/* System Notification */}
      {showSystemNotification && (
        <div className="fixed top-4 right-4 z-50 bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300">
          <div className="text-sm font-medium mb-[11px]">–°–∏—Å—Ç–µ–º–∞</div>
          <div className="flex items-center justify-between">
            <span className="text-sm">{systemNotification}</span>
            <button 
              onClick={() => setShowSystemNotification(false)}
              className="ml-4 text-green-600 hover:text-green-800 transition-colors"
            >
              √ó
            </button>
          </div>
        </div>
      )}

      {/* Metric Info Modal */}
      {showMetricInfoModal && currentMetricInfo && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
          <div className={`rounded-[20px] p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto ${
            theme === 'dark' ? 'bg-[#070F1A]' : 'bg-white'
          }`}>
            <div className="flex items-center justify-between mb-6">
              <h2 className={`text-[20px] font-[500] ${
                theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
              }`}>{currentMetricInfo.title}</h2>
              <button 
                onClick={() => setShowMetricInfoModal(false)}
                className={`transition-colors ${
                  theme === 'dark' ? 'text-white/70 hover:text-white' : 'text-gray-400 hover:text-gray-600'
                }`}
              >
                <img src="/x-02.svg" alt="–ó–∞–∫—Ä—ã—Ç—å" className="w-6 h-6" />
              </button>
            </div>
            
            <div className="space-y-6">
              <div>
                <h3 className={`text-[16px] font-[500] mb-2 ${
                  theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                }`}>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                <p className={`text-[14px] leading-relaxed ${
                  theme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
                }`}>{currentMetricInfo.description}</p>
              </div>
              
              <div>
                <h3 className={`text-[16px] font-[500] mb-2 ${
                  theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                }`}>–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞</h3>
                <div className={`rounded-[10px] p-4 ${
                  theme === 'dark' ? 'bg-[#1E2538]' : 'bg-[#F3F5F7]'
                }`}>
                  <p className={`font-mono text-[14px] ${
                    theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                  }`}>{currentMetricInfo.formula}</p>
                </div>
              </div>
              
              <div>
                <h3 className={`text-[16px] font-[500] mb-2 ${
                  theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                }`}>–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ</h3>
                <div className="space-y-3">
                  {currentMetricInfo.explanation.split('\n\n').map((paragraph, index) => (
                    <p key={index} className={`text-[14px] leading-relaxed ${
                      theme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
                    }`}>{paragraph}</p>
                  ))}
                </div>
              </div>
            </div>
            
            <div className="mt-6 flex justify-end">
              <button 
                onClick={() => setShowMetricInfoModal(false)}
                className="px-6 py-2 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors text-[14px]"
              >
                –ü–æ–Ω—è—Ç–Ω–æ
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Help Modal */}
      {showHelpModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
          <div className={`rounded-[20px] p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto ${
            theme === 'dark' ? 'bg-[#070F1A]' : 'bg-white'
          }`}>
            <div className="flex items-center justify-between mb-6">
              <h2 className={`text-[20px] font-[500] ${
                theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
              }`}>–ü–æ–º–æ—â—å</h2>
              <button 
                onClick={() => setShowHelpModal(false)}
                className={`transition-colors ${
                  theme === 'dark' ? 'text-white/70 hover:text-white' : 'text-gray-400 hover:text-gray-600'
                }`}
              >
                <img src="/x-02.svg" alt="–ó–∞–∫—Ä—ã—Ç—å" className="w-6 h-6" />
              </button>
            </div>
            
            <div className="space-y-6">
              <div>
                <h3 className={`text-[16px] font-[500] mb-3 ${
                  theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                }`}>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Adapto!</h3>
                <p className={`text-[14px] leading-relaxed ${
                  theme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
                }`}>
                  –ú—ã –ø–æ–º–æ–∂–µ–º –≤–∞–º –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ò–ò-–∞–≥–µ–Ω—Ç–∞–º–∏.
                </p>
              </div>
              
              <div>
                <h3 className={`text-[16px] font-[500] mb-3 ${
                  theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                }`}>–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã</h3>
                <div className="space-y-3">
                  <div className={`rounded-[10px] p-4 ${
                    theme === 'dark' ? 'bg-[#1E2538]' : 'bg-[#F3F5F7]'
                  }`}>
                    <h4 className={`font-[500] mb-2 ${
                      theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                    }`}>–ì–ª–∞–≤–Ω–∞—è</h4>
                    <p className={`text-[14px] ${
                      theme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
                    }`}>–û–±–∑–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞</p>
                  </div>
                  <div className={`rounded-[10px] p-4 ${
                    theme === 'dark' ? 'bg-[#1E2538]' : 'bg-[#F3F5F7]'
                  }`}>
                    <h4 className={`font-[500] mb-2 ${
                      theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                    }`}>–î–∏–∞–ª–æ–≥–∏</h4>
                    <p className={`text-[14px] ${
                      theme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
                    }`}>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç-–±–æ—Ç–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤</p>
                  </div>
                  <div className={`rounded-[10px] p-4 ${
                    theme === 'dark' ? 'bg-[#1E2538]' : 'bg-[#F3F5F7]'
                  }`}>
                    <h4 className={`font-[500] mb-2 ${
                      theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                    }`}>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h4>
                    <p className={`text-[14px] ${
                      theme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
                    }`}>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞ –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤</p>
                  </div>
                  <div className={`rounded-[10px] p-4 ${
                    theme === 'dark' ? 'bg-[#1E2538]' : 'bg-[#F3F5F7]'
                  }`}>
                    <h4 className={`font-[500] mb-2 ${
                      theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                    }`}>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h4>
                    <p className={`text-[14px] ${
                      theme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
                    }`}>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ API</p>
                  </div>
                </div>
              </div>
              
              <div>
                <h3 className="text-lg font-medium text-[#070F1A] mb-3">–ù—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å?</h3>
                <p className="text-[#8E8E93] text-sm leading-relaxed">
                  –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–ª–∏ –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.
                </p>
              </div>
            </div>
            
            <div className="mt-6 flex justify-end">
              <button 
                onClick={() => setShowHelpModal(false)}
                className="px-6 py-2 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors text-[14px]"
              >
                –ü–æ–Ω—è—Ç–Ω–æ
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Unsaved Changes Modal */}
      {showUnsavedChangesModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
          <div className={`rounded-[20px] p-6 max-w-md w-full mx-4 ${
            theme === 'dark' ? 'bg-[#070F1A]' : 'bg-white'
          }`}>
            <h3 className={`text-[18px] font-[500] mb-2 ${
              theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
            }`}>–ù–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</h3>
            <p className={`text-[14px] mb-6 ${
              theme === 'dark' ? 'text-white/70' : 'text-[#8E8E93]'
            }`}>–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.</p>
            <div className="flex gap-3 justify-end">
              <button
                onClick={cancelNavigation}
                className={`px-4 py-2 text-[14px] font-[500] transition-colors ${
                  theme === 'dark' 
                    ? 'text-white/70 hover:text-white' 
                    : 'text-[#8E8E93] hover:text-[#070F1A]'
                }`}
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={confirmNavigation}
                className="px-4 py-2 bg-[#FF0D0D] text-white text-[14px] font-[500] rounded-[10px] hover:bg-[#E00D0D] transition-colors"
              >
                –ü–æ–∫–∏–Ω—É—Ç—å –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Sidebar */}
      <div className={`fixed md:relative z-50 md:z-auto transform transition-transform duration-300 ease-in-out ${
        sidebarOpen ? 'translate-x-0' : '-translate-x-full'
      } md:translate-x-0 ${sidebarCollapsed ? 'w-12' : 'w-56'} h-full ${theme === 'light' ? 'bg-[#F2F3F4]' : 'bg-[#070F1A]'} flex flex-col overflow-hidden`}>
        
        {/* Header with Logo and Language Icon */}
                        <div className="px-[10px] pt-5 pb-0" style={{ width: 'calc(100% + 10px)' }}>
          <div className="flex items-center justify-between">
            <div className="flex items-center pl-[10px]">
              {!sidebarCollapsed && (
                <button
                  onClick={() => {
                    setActiveSection('main');
                    localStorage.setItem('currentSection', 'main');
                    setSidebarOpen(false);
                  }}
                  className="hover:opacity-80 transition-opacity"
                >
                                      <img src={theme === 'light' ? '/–õ–æ–≥–æ—Ç–∏–ø-–±–ª—ç–∫.svg' : '/logo.svg'} alt="Adapto" className="w-[110px] h-6" />
                </button>
              )}
            </div>
            <div className={`flex items-center ${sidebarCollapsed ? 'justify-center w-full' : 'gap-2'}`}>
              <button 
                onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                className={`text-gray-400 hover:text-white transition-colors ${sidebarCollapsed ? '-ml-[6px]' : ''}`}
              >
                <img 
                  src={theme === 'light' ? "/—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞.svg" : "/—Ç–µ–º–Ω–∞—è —Ç–µ–º–∞.svg"} 
                  alt="Toggle sidebar" 
                  className="w-4 h-4"
                />
              </button>

            </div>
          </div>
        </div>
        
        {/* Navigation */}
                        <div className="flex-1 px-[10px] pt-5 overflow-y-auto" style={{ width: 'calc(100% + 10px)' }}>
          <nav className="space-y-[5px]">


            {menuItems.map((item) => (
              <div key={item.id}>
              {/* Section headings */}
              {!sidebarCollapsed && item.id === 'statistics' && (
                <div className="text-[10px] text-[#8E8E93] mb-1 ml-[12px]">–û—Å–Ω–æ–≤–Ω—ã–µ</div>
              )}
              {!sidebarCollapsed && item.id === 'adapto-ai' && (
                <div className="text-[10px] text-[#8E8E93] mb-1 mt-[18px] ml-[12px]">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
              )}
              <button
                onClick={() => {
                    if (item.hasSubmenu) {
                      if (sidebarCollapsed) {
                        // –í —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–º –º–µ–Ω—é - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ–µ –º–µ–Ω—é
                        setSidebarCollapsed(false);
                        setExpandedMenus(prev => 
                          prev.includes(item.id) 
                            ? prev.filter(id => id !== item.id)
                            : [...prev, item.id]
                        );
                      } else {
                        setExpandedMenus(prev => 
                          prev.includes(item.id) 
                            ? prev.filter(id => id !== item.id)
                            : [...prev, item.id]
                        );
                      }
                    } else {
                  setActiveSection(item.id);
                  localStorage.setItem('currentSection', item.id);
                  setSidebarOpen(false);
                  
                  // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —á–∞—Ç —Ä–∞–∑–¥–µ–ª—ã
                  if (item.id === 'my-adapto') {
                    ChatUtils.scrollToBottom(chatHistoryRef, 500);
                  } else if (item.id === 'widget-dev') {
                    ChatUtils.scrollToBottom(widgetChatRef, 500);
                  }
                    }
                }}
                className={`w-full flex items-center ${sidebarCollapsed ? 'justify-center w-[34px] h-[34px]' : 'gap-3'} px-3 h-[34px] rounded-[10px] text-left transition-colors ${
                  (activeSection === item.id || hoveredMenuId === item.id)
                          ? 'bg-[#F8F8FA] text-[#0084FF]'
                          : theme === 'light' ? 'text-[#8E8E93] hover:text-[#0084FF] hover:bg-[#F8F8FA]' : 'text-[#B3B7B9] hover:text-white hover:bg-[#1E2538]'
                }`}
                title={sidebarCollapsed ? item.label : ''}
                onMouseEnter={() => setHoveredMenuId(item.id)}
                onMouseLeave={() => setHoveredMenuId(null)}
              >
                {typeof item.icon === 'function' ? (
                  <div className={`${sidebarCollapsed ? 'w-[18px] h-[18px]' : 'w-4 h-4'}`}>
                    {(() => {
                      const iconElement = item.icon();
                      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–∫–æ–Ω–∫–∞ img —Ç–µ–≥–æ–º
                      if (iconElement.type === 'img') {
                        return React.cloneElement(iconElement, {
                          className: `${sidebarCollapsed ? 'w-[18px] h-[18px]' : 'w-4 h-4'}`,
                      style: {
                        filter: (activeSection === item.id || hoveredMenuId === item.id)
                              ? theme === 'light' ? 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)' 
                          : 'brightness(0) invert(1)'
                              : theme === 'light' ? 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)' 
                              : 'brightness(0) saturate(100%) invert(70%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.7) contrast(1)',
                            opacity: (activeSection === item.id || hoveredMenuId === item.id) ? 1 : 0.8
                          }
                        });
                      } else {
                        // –î–ª—è SVG –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º color
                        return React.cloneElement(iconElement, {
                          className: `${sidebarCollapsed ? 'w-[18px] h-[18px]' : 'w-4 h-4'}`,
                          style: {
                            color: (activeSection === item.id || hoveredMenuId === item.id)
                              ? theme === 'light' ? '#0084FF' : '#FFFFFF'
                              : theme === 'light' ? '#8E8E93' : '#B3B7B9',
                            opacity: (activeSection === item.id || hoveredMenuId === item.id) ? 1 : 0.8
                          }
                        });
                      }
                    })()}
                  </div>
                ) : (
                  <img 
                      src={`/${item.id === 'statistics' ? 'dashboard' : 
                         item.id === 'dialogs' ? 'chat' : 
                         item.id === 'knowledge' ? 'knowledge-base' : 
                           item.id === 'integrations' ? 'integration-2' : 
                           'default'}.svg?v=${Date.now()}`} 
                    alt={item.label}
                    className={`${sidebarCollapsed ? 'w-[18px] h-[18px]' : 'w-4 h-4'}`}
                    style={{
                        filter: activeSection === item.id 
                          ? theme === 'light' ? 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)' 
                          : 'brightness(0) invert(1)'
                          : theme === 'light' ? 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)' 
                          : 'brightness(0) saturate(100%) invert(70%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.7) contrast(1)',
                        opacity: activeSection === item.id ? 1 : 0.8
                    }}
                  />
                )}
                  {!sidebarCollapsed && (
                    <div className="flex items-center justify-between flex-1">
                      <span className="text-[13px] font-medium tracking-[0px]">{item.label}</span>
                      {item.hasSubmenu && (
                        <img 
                          src="/chevron-right.svg" 
                          alt="Expand" 
                          className={`w-4 h-4 transition-transform ${
                            expandedMenus.includes(item.id) 
                              ? 'rotate-90' 
                              : ''
                          }`}
                          style={{
                            filter: (activeSection === item.id || hoveredMenuId === item.id)
                              ? theme === 'light' ? 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)'
                              : 'brightness(0) invert(1)'
                              : theme === 'light' ? 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)'
                              : 'brightness(0) saturate(100%) invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.7) contrast(1)',
                            opacity: (activeSection === item.id || hoveredMenuId === item.id) ? 1 : 0.8
                          }}
                        />
                      )}
                    </div>
                  )}
                </button>

                {/* Submenu */}
                {item.hasSubmenu && expandedMenus.includes(item.id) && !sidebarCollapsed && (
                  <div className="ml-4 mt-1 space-y-1">
                    {item.submenu.map((subItem) => (
                      <button
                        key={subItem.id}
                        onClick={() => {
                          setActiveSection(subItem.id);
                          localStorage.setItem('currentSection', subItem.id);
                          setSidebarOpen(false);
                          
                          // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–∑—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —á–∞—Ç —Ä–∞–∑–¥–µ–ª—ã
                          if (subItem.id === 'my-adapto') {
                            ChatUtils.scrollToBottom(chatHistoryRef, 500);
                          } else if (subItem.id === 'widget-dev') {
                            ChatUtils.scrollToBottom(widgetChatRef, 500);
                          }
                        }}
                        className={`w-full flex items-center gap-3 pl-[20px] pr-3 h-[34px] rounded-[8px] text-left transition-colors tracking-[0px] ${
                                            activeSection === subItem.id
                    ? 'bg-[#F8F8FA] text-[#0084FF]'
                    : 'text-[#8E8E93] hover:text-[#0084FF] hover:bg-[#F8F8FA]'
                        }`}
                        onMouseEnter={() => setHoveredSubId(subItem.id)}
                        onMouseLeave={() => setHoveredSubId(null)}
                      >
                        {typeof subItem.icon === 'function' ? (
                          <div className={`${sidebarCollapsed ? 'w-[18px] h-[18px]' : 'w-4 h-4'}`}>
                            {(() => {
                              const el = subItem.icon();
                              if (el.type === 'img') {
                                return React.cloneElement(el, {
                                  className: `${sidebarCollapsed ? 'w-[18px] h-[18px]' : 'w-4 h-4'}`,
                                  style: {
                                    filter: (activeSection === subItem.id || hoveredSubId === subItem.id)
                                      ? 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)'
                                      : 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)',
                                    opacity: (activeSection === subItem.id || hoveredSubId === subItem.id) ? 1 : 0.8
                                  }
                                });
                              }
                              return el;
                            })()}
                          </div>
                        ) : (
                          <img 
                            src={`/${subItem.id === 'my-adapto' ? 'mouse-square-menu' : 
                                 subItem.id === 'model-settings' ? 'model-settings' : 
                                 subItem.id === 'model-extensions' ? 'extensions' : 
                                 subItem.id === 'widget-settings' ? 'widget' : 
                                 subItem.id === 'messengers' ? 'chat' : 
                                 subItem.id === 'crm-systems' ? 'crm' : 
                                 subItem.id === 'other-integrations' ? 'other' : 
                                 'default'}.svg?v=${Date.now()}`} 
                            alt={subItem.label}
                            className={`${sidebarCollapsed ? 'w-[18px] h-[18px]' : 'w-4 h-4'}`}
                            style={{
                              filter: (activeSection === subItem.id || hoveredSubId === subItem.id)
                                ? 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)'
                                : 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)',
                              opacity: (activeSection === subItem.id || hoveredSubId === subItem.id) ? 1 : 0.8
                            }}
                          />
                        )}
                        <span className="text-[13px] font-medium tracking-[-0.1px]">{subItem.label}</span>
              </button>
            ))}
                  </div>
                )}
              </div>
            ))}

          </nav>
        </div>

        {/* User Profile */}
                        <div className="px-[10px] pb-[15px]" style={{ width: 'calc(100% + 10px)' }}>
          {!sidebarCollapsed ? (
            <>
              {/* –ü–ª–∞—à–∫–∏ —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ */}
              {!isOperator && (
                <>
                  {/* –ü–ª–∞—à–∫–∞ —Å —Ç–∞—Ä–∏—Ñ–æ–º Pro */}
                  <div className="w-full h-[60px] rounded-[10px] mb-[10px] relative overflow-hidden">
                    <img src="/Frame 145.png" alt="Pro Background" className="w-full h-full object-cover absolute inset-0" />
                    <div className="p-3 h-full flex flex-col justify-center relative z-10">
                      <div className="flex flex-col items-start">
                        <span className="text-white text-[14px] font-medium">–¢–∞—Ä–∏—Ñ Pro —Å–æ —Å–∫–∏–¥–∫–æ–π</span>
                        <span className="text-white text-[14px] font-medium">-50% –Ω–∞ –ø–µ—Ä–≤—ã–π –≥–æ–¥</span>
              </div>
                    </div>
                  </div>
                  
                  {/* –ù–æ–≤—ã–π –¥–∏–∑–∞–π–Ω –ø–ª–∞—à–∫–∏ */}
                  <div className="w-full h-[80px] bg-white rounded-[10px] p-[7px] mb-[10px]">
                    {/* –ü–ª–∞—à–∫–∞ "–ü—Ä–æ–±–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞" */}
                    <div className="h-[22px] bg-[#EFFBF3] rounded-[7px] flex items-center justify-center mb-[7px]">
                      <span className="text-[#36C76A] text-[10px] font-medium">–ü—Ä–æ–±–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</span>
                    </div>
                
                {/* –î–≤–µ –∫–æ–ª–æ–Ω–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */}
                <div className="flex justify-between">
                  {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –°—Ä–æ–∫ */}
                  <div className="flex-1 text-center">
                    <div className="text-[10px] text-[#070F1A] opacity-60 mb-1">–°—Ä–æ–∫:</div>
                    <div className="flex items-center justify-center gap-1">
                      <img src="/clock.svg" alt="Clock" className="w-3 h-3" />
                      <span className="text-[12px] text-[#070F1A] font-medium">
                        {userLimits?.daysRemaining || 0}/7 –¥–Ω–µ–π
                      </span>
                    </div>
                  </div>
                  
                  {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –¢–æ–∫–µ–Ω—ã */}
                  <div className="flex-1 text-center">
                    <div className="text-[10px] text-[#070F1A] opacity-60 mb-1">–¢–æ–∫–µ–Ω—ã:</div>
                    <div className="flex items-center justify-center gap-1">
                      <img src="/Vector09.svg" alt="Tokens" className="w-3 h-3" />
                      <span className="text-[12px] text-[#070F1A] font-medium">
                        {userLimits?.tokensRemaining || 0}/{userLimits?.totalTokens || 1000}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
                </>
              )}
              
              {/* –°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */}
              {isOperator && (
                <div className="flex items-center justify-between mb-3 px-3 py-2 bg-[#F9FAFB] rounded-[12px] h-[40px] border border-[#E5E7EB]">
                  <span className="text-[12px] text-[#070F1A]">
                    {isOnline ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}
                  </span>
                  <img 
                    src={isOnline ? "/iOS/Switch.svg" : "/iOS/Switch-1.svg"} 
                    alt="–°—Ç–∞—Ç—É—Å" 
                    className="w-[34px] h-[34px] cursor-pointer hover:opacity-80 transition-opacity" 
                    onClick={() => setIsOnline(!isOnline)}
                  />
                </div>
              )}

              {/* –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
              <div className="relative user-dropdown">
                <div className={`rounded-[10px] py-3 pr-3 pl-0 mb-[10px] mt-[5px] cursor-pointer transition-colors h-[40px] flex items-center justify-between ${
                theme === 'light' ? 'hover:bg-gray-50' : 'hover:bg-[#1E2538]'
                }`} onClick={() => setShowUserDropdown(!showUserDropdown)}>
                <div className="flex items-center gap-3">
                    <div className="w-[28px] h-[28px] rounded-[7px] flex items-center justify-center" style={{ backgroundColor: generateAvatar(currentUser?.name).color }}>
                    <span className="text-white font-semibold text-xs">{generateAvatar(currentUser?.name).letter}</span>
                    </div>
                    <div className="flex flex-col">
                      <div className={`text-[13px] font-medium ${theme === 'light' ? 'text-[#070F1A]' : 'text-white'}`}>{currentUser?.company_name || '–ö–æ–º–ø–∞–Ω–∏—è'}</div>
                      <div className="text-[11px] text-[#8E8E93]">{currentUser?.email || 'email@example.com'}</div>
                </div>
              </div>
                  <div className="flex items-center">
                                      <img 
                    src="/chevron-right.svg" 
                    alt="Expand" 
                    className={`w-4 h-4 transition-transform duration-200 ${showUserDropdown ? 'rotate-90' : '-rotate-90'}`}
                    style={{
                      filter: theme === 'light' 
                        ? 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)'
                        : 'brightness(0) saturate(100%) invert(70%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.7) contrast(1)'
                    }}
                  />
                  </div>
                </div>
                
                {/* –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
                {showUserDropdown && (
                  <div className="user-dropdown absolute bottom-full left-0 right-0 mb-2 bg-white rounded-[15px] shadow-lg border border-gray-200 p-2 z-50">
                    {/* 1. –ú–æ–π –∞–∫–∫–∞—É–Ω—Ç */}
                    <button
                      onClick={() => {
                        setActiveSection('profile');
                        setShowUserDropdown(false);
                        setSidebarOpen(false);
                      }}
                      className={`w-full text-left px-3 py-2 text-[13px] rounded-[6px] transition-colors flex items-center gap-3 group tracking-[0px] ${
                        activeSection === 'profile' 
                          ? 'text-[#0084FF] bg-white' 
                          : 'text-[#8E8E93] hover:text-[#0084FF] hover:bg-white'
                      }`}
                    >
                      <img 
                        src="/Icon%20pers.svg" 
                        alt="–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç" 
                        className="w-4 h-4 transition-all duration-200" 
                        style={{ 
                          filter: activeSection === 'profile'
                            ? 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)'
                            : 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)'
                        }} 
                      />
                      –ú–æ–π –∞–∫–∫–∞—É–Ω—Ç
                    </button>
                    
                    {/* 2. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ */}
                    <button 
                      onClick={() => {
                        setActiveSection('profile');
                        setProfileTab('notifications');
                        setShowUserDropdown(false);
                        setSidebarOpen(false);
                      }}
                      className={`w-full text-left px-3 py-2 text-[13px] rounded-[6px] transition-colors flex items-center gap-3 group tracking-[0px] ${
                        activeSection === 'profile' && profileTab === 'notifications'
                          ? 'text-[#0084FF] bg-white' 
                          : 'text-[#8E8E93] hover:text-[#0084FF] hover:bg-white'
                      }`}
                    >
                      <img 
                        src="./Icon%20notific.svg" 
                        alt="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" 
                        className="w-4 h-4 transition-all duration-200" 
                        style={{ 
                          filter: activeSection === 'profile' && profileTab === 'notifications'
                            ? 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)'
                            : 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)'
                        }} 
                      />
                      –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </button>
                    
                    {/* 3. –û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ */}
                    {!isOperator && (
                      <button 
                        onClick={() => {
                          setActiveSection('profile');
                          setProfileTab('subscription');
                          setShowUserDropdown(false);
                          setSidebarOpen(false);
                        }}
                        className={`w-full text-left px-3 py-2 text-[13px] rounded-[6px] transition-colors flex items-center gap-3 group tracking-[0px] ${
                          activeSection === 'subscription' 
                            ? 'text-[#0084FF] bg-white' 
                            : 'text-[#8E8E93] hover:text-[#0084FF] hover:bg-white'
                        }`}
                      >
                        <img 
                          src="/Icon%20pers-1.svg" 
                          alt="–û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã" 
                          className="w-4 h-4 transition-all duration-200" 
                          style={{ 
                            filter: activeSection === 'subscription'
                              ? 'brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(199deg) brightness(104%) contrast(101%)'
                              : 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)'
                          }} 
                        />
                        –û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã
                      </button>
                    )}
                    
                    {/* 4. –ü–æ–º–æ—â—å */}
                    <button 
                      onClick={() => {
                        setShowHelpModal(true);
                        setShowUserDropdown(false);
                      }}
                      className="w-full text-left px-3 py-2 text-[13px] rounded-[6px] transition-colors flex items-center gap-3 group tracking-[0px] text-[#8E8E93] hover:text-[#0084FF] hover:bg-white"
                    >
                      <img src="/Icon%20quest.svg" alt="–ü–æ–º–æ—â—å" className="w-4 h-4 transition-all duration-200" style={{ filter: 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)' }} />
                      –ü–æ–º–æ—â—å
                    </button>
                    
                    {/* 5. –Ø–∑—ã–∫ */}
                    <button 
                      onClick={() => {
                        // TODO: –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–º–µ–Ω—ã —è–∑—ã–∫–∞
                        setShowUserDropdown(false);
                      }}
                      className="w-full text-left px-3 py-2 text-[13px] rounded-[6px] transition-colors flex items-center gap-3 group tracking-[0px] text-[#8E8E93] hover:text-[#0084FF] hover:bg-white"
                    >
                      <img src="/Icon%20wor.svg" alt="–Ø–∑—ã–∫" className="w-4 h-4 transition-all duration-200" style={{ filter: 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)' }} />
                      –Ø–∑—ã–∫
                    </button>
                    
                    <div className="border-t border-gray-200 my-2"></div>
                    
                    {/* 6. –í—ã–π—Ç–∏ */}
                    <button 
                      onClick={() => {
                        handleLogout();
                        setShowUserDropdown(false);
                      }}
                      className="w-full text-left px-3 py-2 text-[13px] rounded-[6px] transition-colors flex items-center gap-3 group tracking-[0px] text-[#8E8E93] hover:text-[#0084FF] hover:bg-white"
                    >
                      <img src="/Icon%20ex.svg" alt="–í—ã–π—Ç–∏" className="w-4 h-4 transition-all duration-200" style={{ filter: 'brightness(0) saturate(100%) invert(60%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.8) contrast(1)' }} />
                      –í—ã–π—Ç–∏
                    </button>
                  </div>
                )}
              </div>
            </>
          ) : (
            /* –£–∫–æ—Ä–æ—á–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ —Å–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é */
            <div className="flex flex-col items-center gap-2">
              
              {/* –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
              <div className={`cursor-pointer ${theme === 'light' ? 'hover:bg-gray-50 rounded-[10px] p-1' : ''}`} onClick={() => {
                setActiveSection('profile');
                localStorage.setItem('currentSection', 'profile');
                setSidebarOpen(false);
              }}>
                <div className="w-4 h-4 rounded-[90px] flex items-center justify-center" style={{ backgroundColor: generateAvatar(currentUser?.name).color }}>
                  <span className="text-white font-semibold text-[10px]">{generateAvatar(currentUser?.name).letter}</span>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Main content */}
      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Mobile header */}
                  <div className={`md:hidden flex items-center gap-4 p-4 border-b ${theme === 'light' ? 'border-gray-200 bg-white' : 'border-gray-700 bg-[#070F1A]'}`}>
          {/* –õ–æ–≥–æ—Ç–∏–ø */}
          <img src="/logo.svg" alt="Adapto" className="w-8 h-8" />
          
          {/* –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é */}
          <Button
            variant="ghost"
            size="sm"
            onClick={() => setSidebarOpen(true)}
            className={`${theme === 'light' ? 'text-[#070F1A]' : 'text-white'} ml-auto`}
          >
            <Menu className="w-3 h-3" />
          </Button>
        </div>

        {/* Content */}
        <main className="flex-1 bg-[#F8F8FA] rounded-[0px] ml-[10px] border-l flex flex-col overflow-hidden" style={{ borderColor: '#E5E6E7', marginTop: 0, marginRight: 0, marginBottom: 0 }}>
           <div className="p-4 flex-1 min-h-0 overflow-y-auto">
          {renderContent()}
          </div>
        </main>
      </div>

      {/* Widget Constructor Modal */}
      {showWidgetConstructor && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowWidgetConstructor(false)} />
          <div className={`relative w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden flex flex-col ${
            theme === 'dark' ? 'bg-[#070F1A] rounded-[20px]' : 'bg-white rounded-[20px]'
          }`}>
            {/* Header */}
            <div className={`flex items-center justify-between p-6 border-b ${
              theme === 'dark' ? 'border-white/10' : 'border-gray-200'
            }`}>
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => setShowWidgetConstructor(false)}
                  className={`transition-colors ${
                    theme === 'dark' ? 'text-white/70 hover:text-white' : 'text-gray-400 hover:text-gray-600'
                  }`}
                >
                  <img src="/Frame 195.svg" alt="–ù–∞–∑–∞–¥" className="w-4 h-4" />
                </button>
                <h3 className={`text-[20px] font-[500] ${
                  theme === 'dark' ? 'text-white' : 'text-[#070F1A]'
                }`}>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ / –í–∏–¥–∂–µ—Ç</h3>
    </div>
              <button 
                onClick={async () => {
                  try {
                    const script = generateWidgetCode();
                    await navigator.clipboard.writeText(script);
                    showNotificationMessage('–°–∫—Ä–∏–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                    
                  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç –∫–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π
                  setIntegrations(prev => prev.map(item => 
                    item.id === 'widget' 
                      ? { ...item, installed: true }
                      : item
                  ));
                  setShowWidgetConstructor(false);
                  } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);
                    showNotificationMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞');
                  }
                }}
                className="h-[40px] px-4 bg-[#0084FF] text-white hover:bg-[#0073E6] rounded-[10px] font-[500] text-[14px] flex items-center gap-2 transition-colors"
              >
                <img src="/document-copy.svg" alt="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(1)' }} />
                –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6">
              <div className="space-y-8">
                {/* Settings */}
                <div className="space-y-6">
                  {/* Accent Color */}
                  <div>
                    <label className="block text-sm font-medium mb-3">–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</label>
                    <div className="flex items-center gap-3">
                      <input 
                        type="text" 
                        value={widgetDevelopmentSettings.accentColor}
                        onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, accentColor: e.target.value})}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                        placeholder="HEX"
                      />
                      <input 
                        type="color" 
                        value={widgetDevelopmentSettings.accentColor}
                        onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, accentColor: e.target.value})}
                        className="w-10 h-10 rounded-lg border-2 border-gray-300 cursor-pointer"
                      />
                      <button 
                        onClick={() => setWidgetSettings({...widgetDevelopmentSettings, accentColor: '#1354FC'})}
                        className="text-gray-400 hover:text-gray-600"
                      >
                        √ó
                      </button>
                    </div>
                  </div>

                  {/* Button Color */}
                  <div>
                    <label className="block text-sm font-medium mb-3">–¶–≤–µ—Ç –∫–Ω–æ–ø–∫–∏</label>
                    <div className="grid grid-cols-3 gap-3">
                      {[
                        { id: 'light', label: '–°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω', bg: 'bg-white', border: 'border-blue-500', text: 'text-blue-500' },
                        { id: 'dark', label: '–¢–µ–º–Ω—ã–π —Ñ–æ–Ω', bg: 'bg-gray-900', border: 'border-white', text: 'text-white' },
                        { id: 'custom', label: '–ó–∞–¥–∞—Ç—å —Å–≤–æ–π —Ü–≤–µ—Ç', bg: 'bg-gradient-to-r from-yellow-400 via-pink-500 to-blue-500', border: 'border-blue-500', text: 'text-white' }
                      ].map((style) => (
                        <button
                          key={style.id}
                          onClick={() => setWidgetSettings({...widgetDevelopmentSettings, buttonColor: style.id})}
                          className={`p-3 rounded-lg border-2 transition-all ${
                            widgetDevelopmentSettings.buttonColor === style.id 
                              ? 'border-blue-500 ring-2 ring-blue-200' 
                              : 'border-gray-200 hover:border-gray-300'
                          }`}
                        >
                          <div 
                            className={`w-[140px] h-[42px] rounded-xl flex items-center justify-center gap-2 mb-2 mx-auto ${
                              style.id === 'light' ? 'bg-white border-2 border-gray-300' :
                              style.id === 'dark' ? 'bg-gray-900' :
                              'bg-gradient-to-r from-yellow-400 via-pink-500 to-blue-500'
                            }`}
                            style={{
                              borderColor: style.id === 'light' ? widgetDevelopmentSettings.accentColor : 'transparent',
                              color: style.id === 'light' ? widgetDevelopmentSettings.accentColor : 'white'
                            }}
                          >
                            <div 
                              className="w-4 h-4 rounded-[90px] opacity-80"
                              style={{ backgroundColor: style.id === 'light' ? widgetDevelopmentSettings.accentColor : 'currentColor' }}
                            ></div>
                            <span className="text-sm font-medium" style={{ maxWidth: '90px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                              –ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º
                            </span>
                          </div>
                          <span className={`text-xs ${widgetDevelopmentSettings.buttonColor === style.id ? 'text-blue-600' : 'text-gray-600'}`}>
                            {style.label}
                          </span>
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Button Text */}
                  <div>
                    <label className="block text-sm font-medium mb-3">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏</label>
                    <input 
                      type="text" 
                      value={widgetDevelopmentSettings.buttonText}
                      onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, buttonText: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                      placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º"
                    />
                  </div>

                  {/* Avatar */}
                  <div>
                    <label className="block text-sm font-medium mb-3">–ê–≤–∞—Ç–∞—Ä Adapto</label>
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        onClick={() => setWidgetSettings({...widgetDevelopmentSettings, avatar: 'default'})}
                        className={`p-3 rounded-lg border-2 transition-all ${
                          widgetDevelopmentSettings.avatar === 'default' 
                            ? 'border-blue-500 ring-2 ring-blue-200' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-[90px] mx-auto mb-2 flex items-center justify-center">
                          <div className="flex items-center justify-center w-6 h-6">
                            <div className="w-3 h-3 bg-white rounded-[90px] mr-1"></div>
                            <div className="w-1.5 h-1.5 bg-white rounded-[90px]"></div>
                          </div>
                        </div>
                        <span className="text-xs text-center block">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                      </button>
                      <button
                        onClick={() => document.getElementById('avatar-input')?.click()}
                        className={`p-3 rounded-lg border-2 transition-all ${
                          widgetDevelopmentSettings.avatar === 'custom' 
                            ? 'border-blue-500 ring-2 ring-blue-200' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="w-12 h-12 bg-gray-200 rounded-[90px] mx-auto mb-2 flex items-center justify-center">
                          <span className="text-gray-500">+</span>
                        </div>
                        <span className="text-xs text-center block">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
                        <input 
                          id="avatar-input"
                          type="file" 
                          accept="image/*"
                          className="hidden" 
                          onChange={(e) => {
                            const file = e.target.files?.[0];
                            if (file) {
                              setWidgetSettings({...widgetDevelopmentSettings, avatar: 'custom'});
                              showNotificationMessage('–ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω!');
                            }
                          }}
                        />
                      </button>
                    </div>
                  </div>
                </div>

                {/* Custom Color Picker */}
                {widgetDevelopmentSettings.buttonColor === 'custom' && (
                  <div>
                    <label className="block text-sm font-medium mb-3">–í–≤–µ–¥–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è —Ñ–æ–Ω–∞</label>
                    <div className="flex items-center gap-3">
                      <input 
                        type="text" 
                        value={widgetDevelopmentSettings.customButtonColor}
                        onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, customButtonColor: e.target.value})}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                        placeholder="HEX"
                      />
                      <input 
                        type="color" 
                        value={widgetDevelopmentSettings.customButtonColor}
                        onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, customButtonColor: e.target.value})}
                        className="w-10 h-10 rounded-lg border-2 border-gray-300 cursor-pointer"
                      />
                    </div>
                  </div>
                )}

                {/* –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ */}
                <div>
                  <label className="block text-sm font-medium mb-3">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞</label>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, widgetLocation: 'default'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.widgetLocation === 'default' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
                        <div className="text-sm text-gray-600">–ü—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, widgetLocation: 'custom'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.widgetLocation === 'custom' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</div>
                        <div className="text-sm text-gray-600">–í—ã–±—Ä–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é</div>
                      </div>
                    </button>
                  </div>
                  
                  {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞ */}
                  {widgetDevelopmentSettings.widgetLocation === 'custom' && (
                    <div className="mt-4 space-y-6 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <h4 className="text-sm font-medium mb-3">–î–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤</h4>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-2">–û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É</label>
                            <input 
                              type="number" 
                              value={widgetDevelopmentSettings.desktopBottomOffset}
                              onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, desktopBottomOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-2">–û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞</label>
                            <input 
                              type="number" 
                              value={widgetDevelopmentSettings.desktopRightOffset}
                              onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, desktopRightOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                        </div>
                      </div>
                      
                      <div>
                        <h4 className="text-sm font-medium mb-3">–î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤</h4>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-2">–û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É</label>
                            <input 
                              type="number" 
                              value={widgetDevelopmentSettings.mobileBottomOffset}
                              onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, mobileBottomOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-2">–û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞</label>
                            <input 
                              type="number" 
                              value={widgetDevelopmentSettings.mobileRightOffset}
                              onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, mobileRightOffset: parseInt(e.target.value)})}
                              className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                              min="0"
                            />
                          </div>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">Z-index</label>
                        <input 
                          type="number" 
                          value={widgetDevelopmentSettings.zIndex}
                          onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, zIndex: parseInt(e.target.value)})}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                          min="1"
                        />
                      </div>
                    </div>
                  )}
                </div>

                {/* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                  <div className="space-y-3">
                    {widgetDevelopmentSettings.welcomeMessages.map((message, index) => (
                      <div key={index} className="flex gap-2">
                        <input 
                          type="text" 
                          value={message}
                          onChange={(e) => {
                            const newMessages = [...widgetDevelopmentSettings.welcomeMessages];
                            newMessages[index] = e.target.value;
                            setWidgetSettings({...widgetDevelopmentSettings, welcomeMessages: newMessages});
                          }}
                          className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                          placeholder="–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
                        />
                        <button 
                          onClick={() => {
                            const newMessages = widgetDevelopmentSettings.welcomeMessages.filter((_, i) => i !== index);
                            setWidgetSettings({...widgetDevelopmentSettings, welcomeMessages: newMessages});
                          }}
                          className="px-3 py-2 text-red-500 hover:text-red-700"
                        >
                          √ó
                        </button>
                      </div>
                    ))}
                    <button 
                      onClick={() => {
                        const newMessages = [...widgetDevelopmentSettings.welcomeMessages, ''];
                        setWidgetSettings({...widgetDevelopmentSettings, welcomeMessages: newMessages});
                      }}
                      className="text-blue-600 hover:text-blue-700 text-sm"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    </button>
                  </div>
                </div>

                {/* –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–π –≤–æ–ø—Ä–æ—Å */}
                <div>
                  <label className="block text-sm font-medium mb-3">–¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–π –≤–æ–ø—Ä–æ—Å</label>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, triggerQuestionEnabled: 'no'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.triggerQuestionEnabled === 'no' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">–ù–µ—Ç</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, triggerQuestionEnabled: 'yes'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.triggerQuestionEnabled === 'yes' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">–ï—Å—Ç—å</div>
                      </div>
                    </button>
                  </div>
                  
                  {widgetDevelopmentSettings.triggerQuestionEnabled === 'yes' && (
                    <div className="space-y-4 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <label className="block text-sm font-medium mb-2">–ß–µ—Ä–µ–∑ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞—Ç—å:</label>
                        <div className="flex items-center gap-2">
                          <input 
                            type="number" 
                            value={widgetDevelopmentSettings.triggerQuestionDelay}
                            onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, triggerQuestionDelay: parseInt(e.target.value)})}
                            className="w-20 p-2 border border-gray-300 rounded-lg text-sm"
                            min="1"
                          />
                          <span className="text-sm text-gray-600">—Å–µ–∫</span>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">–í–æ–ø—Ä–æ—Å:</label>
                        <textarea 
                          value={widgetDevelopmentSettings.triggerQuestionText}
                          onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, triggerQuestionText: e.target.value})}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                          rows="3"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã:</label>
                        <div className="space-y-2">
                          {widgetDevelopmentSettings.quickReplies.map((reply, index) => (
                            <div key={index} className="flex gap-2">
                              <input 
                                type="text" 
                                value={reply}
                                onChange={(e) => {
                                  const newReplies = [...widgetDevelopmentSettings.quickReplies];
                                  newReplies[index] = e.target.value;
                                  setWidgetSettings({...widgetDevelopmentSettings, quickReplies: newReplies});
                                }}
                                className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                                placeholder="–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç"
                              />
                              <button 
                                onClick={() => {
                                  const newReplies = widgetDevelopmentSettings.quickReplies.filter((_, i) => i !== index);
                                  setWidgetSettings({...widgetDevelopmentSettings, quickReplies: newReplies});
                                }}
                                className="px-3 py-2 text-red-500 hover:text-red-700"
                              >
                                √ó
                              </button>
                            </div>
                          ))}
                          <button 
                            onClick={() => {
                              const newReplies = [...widgetDevelopmentSettings.quickReplies, ''];
                              setWidgetSettings({...widgetDevelopmentSettings, quickReplies: newReplies});
                            }}
                            className="text-blue-600 hover:text-blue-700 text-sm"
                          >
                            + –î–æ–±–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Follow up —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                <div>
                  <label className="block text-sm font-medium mb-3">Follow up —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                  <p className="text-sm text-gray-600 mb-4">–°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —É–≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –µ—Å–ª–∏ –≤—ã–π–¥–µ—Ç –∏–∑ –¥–∏–∞–ª–æ–≥–∞</p>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, followUpMessage: 'no'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.followUpMessage === 'no' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">–ù–µ—Ç</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, followUpMessage: 'yes'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.followUpMessage === 'yes' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">–ï—Å—Ç—å</div>
                      </div>
                    </button>
                  </div>
                  
                  {widgetDevelopmentSettings.followUpMessage === 'yes' && (
                    <div className="space-y-4 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <label className="block text-sm font-medium mb-2">–ß–µ—Ä–µ–∑ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞—Ç—å:</label>
                        <div className="flex items-center gap-2">
                          <input 
                            type="number" 
                            value={widgetDevelopmentSettings.followUpDelay}
                            onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, followUpDelay: parseInt(e.target.value)})}
                            className="w-20 p-2 border border-gray-300 rounded-lg text-sm"
                            min="1"
                          />
                          <span className="text-sm text-gray-600">—Å–µ–∫</span>
                        </div>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">–í–æ–ø—Ä–æ—Å:</label>
                        <textarea 
                          value={widgetDevelopmentSettings.followUpQuestion}
                          onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, followUpQuestion: e.target.value})}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                          rows="3"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã:</label>
                        <div className="space-y-2">
                          {widgetDevelopmentSettings.followUpQuickReply && (
                            <div className="flex gap-2">
                              <input 
                                type="text" 
                                value={widgetDevelopmentSettings.followUpQuickReply}
                                onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, followUpQuickReply: e.target.value})}
                                className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                                placeholder="–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç"
                              />
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö */}
                <div>
                  <label className="block text-sm font-medium mb-2">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</label>
                  <input 
                    type="url" 
                    value={widgetDevelopmentSettings.privacyPolicyUrl}
                    onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, privacyPolicyUrl: e.target.value})}
                    className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                    placeholder="https://example.com/privacy"
                  />
                </div>

                {/* –ö–∞–∫–∏–µ –º–µ—Ç–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å */}
                <div>
                  <label className="block text-sm font-medium mb-3">–ö–∞–∫–∏–µ –º–µ—Ç–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å</label>
                  <div className="grid grid-cols-2 gap-2">
                    {[
                      'utm_source',
                      'utm_medium', 
                      'utm_campaign',
                      'utm_term',
                      'utm_content',
                      'roistat_visit',
                      'gclid',
                      'fbclid'
                    ].map(tag => (
                      <button
                        key={tag}
                        onClick={() => {
                          const current = widgetDevelopmentSettings.dataTags || [];
                          const newTags = current.includes(tag)
                            ? current.filter(t => t !== tag)
                            : [...current, tag];
                          setWidgetSettings({...widgetDevelopmentSettings, dataTags: newTags});
                        }}
                        className={`p-2 rounded-lg border-2 transition-all text-sm ${
                          (widgetDevelopmentSettings.dataTags || []).includes(tag)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {tag}
                      </button>
                    ))}
                  </div>
                  <div className="mt-3">
                    <button 
                      onClick={() => {
                        const newTag = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏:');
                        if (newTag && !widgetDevelopmentSettings.dataTags.includes(newTag)) {
                          const newTags = [...widgetDevelopmentSettings.dataTags, newTag];
                          setWidgetSettings({...widgetDevelopmentSettings, dataTags: newTags});
                        }
                      }}
                      className="text-blue-600 hover:text-blue-700 text-sm"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É
                    </button>
                  </div>
                </div>

                {/* –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –≤–∏–¥–∂–µ—Ç–∞ */}
                <div className="border-t pt-6">
                  <h4 className="text-lg font-semibold mb-4">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –≤–∏–¥–∂–µ—Ç–∞</h4>
                  <div className="grid grid-cols-2 gap-4">
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, widgetMode: 'chat'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.widgetMode === 'chat' 
                          ? 'border-blue-500 bg-blue-50' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="flex items-center gap-3 mb-2">
                        <MessageSquare className="w-5 h-5 text-blue-600" />
                        <span className="font-medium">–ß–∞—Ç</span>
                      </div>
                      <p className="text-sm text-gray-600">–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —á–∞—Ç–∞ —Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</p>
                    </button>
                    <button
                      onClick={() => setWidgetSettings({...widgetDevelopmentSettings, widgetMode: 'questions'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        widgetDevelopmentSettings.widgetMode === 'questions' 
                          ? 'border-blue-500 bg-blue-50' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="flex items-center gap-3 mb-2">
                        <HelpCircle className="w-5 h-5 text-blue-600" />
                        <span className="font-medium">–ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã</span>
                      </div>
                      <p className="text-sm text-gray-600">–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å –≥–æ—Ç–æ–≤—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏</p>
                    </button>
                  </div>
                </div>

                {/* –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã */}
                {widgetDevelopmentSettings.widgetMode === 'questions' && (
                  <div className="border-t pt-6">
                    <h4 className="text-lg font-semibold mb-4">–ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h4>
                    <div className="space-y-4">
                      {widgetDevelopmentSettings.quickQuestions.map((item, index) => (
                        <div key={index} className="border border-gray-200 rounded-lg p-4">
                          <div className="flex items-start justify-between mb-3">
                            <h5 className="font-medium">–í–æ–ø—Ä–æ—Å {index + 1}</h5>
                            <button
                              onClick={() => {
                                const newQuestions = widgetDevelopmentSettings.quickQuestions.filter((_, i) => i !== index);
                                setWidgetSettings({...widgetDevelopmentSettings, quickQuestions: newQuestions});
                              }}
                              className="text-red-500 hover:text-red-700"
                            >
                              <X className="w-4 h-4" />
                            </button>
                          </div>
                          <div className="space-y-3">
                            <div>
                              <label className="block text-sm font-medium mb-1">–í–æ–ø—Ä–æ—Å</label>
                              <input
                                type="text"
                                value={item.question}
                                onChange={(e) => {
                                  const newQuestions = [...widgetDevelopmentSettings.quickQuestions];
                                  newQuestions[index].question = e.target.value;
                                  setWidgetSettings({...widgetDevelopmentSettings, quickQuestions: newQuestions});
                                }}
                                className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1">–û—Ç–≤–µ—Ç</label>
                              <textarea
                                value={item.answer}
                                onChange={(e) => {
                                  const newQuestions = [...widgetDevelopmentSettings.quickQuestions];
                                  newQuestions[index].answer = e.target.value;
                                  setWidgetSettings({...widgetDevelopmentSettings, quickQuestions: newQuestions});
                                }}
                                className="w-full p-2 border border-gray-300 rounded-lg text-sm h-20 resize-none"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                      <button
                        onClick={() => {
                          const newQuestions = [...widgetDevelopmentSettings.quickQuestions, { question: '', answer: '' }];
                          setWidgetSettings({...widgetDevelopmentSettings, quickQuestions: newQuestions});
                        }}
                        className="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors"
                      >
                        + –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å
                      </button>
                    </div>
                  </div>
                )}

                {/* –§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ */}
                <div className="border-t pt-6">
                  <h4 className="text-lg font-semibold mb-4">–§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏</h4>
                  <div className="space-y-4">
                    <div className="flex items-center gap-4">
                      <button
                        onClick={() => setWidgetSettings({...widgetDevelopmentSettings, leadFormEnabled: 'yes'})}
                        className={`px-4 py-2 rounded-lg border-2 transition-all ${
                          widgetDevelopmentSettings.leadFormEnabled === 'yes' 
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        –í–∫–ª—é—á–∏—Ç—å
                      </button>
                      <button
                        onClick={() => setWidgetSettings({...widgetDevelopmentSettings, leadFormEnabled: 'no'})}
                        className={`px-4 py-2 rounded-lg border-2 transition-all ${
                          widgetDevelopmentSettings.leadFormEnabled === 'no' 
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        –û—Ç–∫–ª—é—á–∏—Ç—å
                      </button>
                    </div>
                    
                    {widgetDevelopmentSettings.leadFormEnabled === 'yes' && (
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium mb-2">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã</label>
                          <input
                            type="text"
                            value={widgetDevelopmentSettings.leadFormTitle}
                            onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, leadFormTitle: e.target.value})}
                            className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                            placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã</label>
                          <input
                            type="text"
                            value={widgetDevelopmentSettings.leadFormDescription}
                            onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, leadFormDescription: e.target.value})}
                            className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                            placeholder="–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-2">–ü–æ–ª—è —Ñ–æ—Ä–º—ã</label>
                          <div className="space-y-3">
                            {widgetDevelopmentSettings.leadFormFields.map((field, index) => (
                              <div key={index} className="flex items-center gap-3 p-3 border border-gray-200 rounded-lg">
                                <div className="flex-1">
                                  <input
                                    type="text"
                                    value={field.label}
                                    onChange={(e) => {
                                      const newFields = [...widgetDevelopmentSettings.leadFormFields];
                                      newFields[index].label = e.target.value;
                                      setWidgetSettings({...widgetDevelopmentSettings, leadFormFields: newFields});
                                    }}
                                    className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è"
                                  />
                                </div>
                                <select
                                  value={field.type}
                                  onChange={(e) => {
                                    const newFields = [...widgetDevelopmentSettings.leadFormFields];
                                    newFields[index].type = e.target.value;
                                    setWidgetSettings({...widgetDevelopmentSettings, leadFormFields: newFields});
                                  }}
                                  className="p-2 border border-gray-300 rounded-lg text-sm"
                                >
                                  <option value="text">–¢–µ–∫—Å—Ç</option>
                                  <option value="email">Email</option>
                                  <option value="tel">–¢–µ–ª–µ—Ñ–æ–Ω</option>
                                </select>
                                <label className="flex items-center gap-2">
                                  <input
                                    type="checkbox"
                                    checked={field.required}
                                    onChange={(e) => {
                                      const newFields = [...widgetDevelopmentSettings.leadFormFields];
                                      newFields[index].required = e.target.checked;
                                      setWidgetSettings({...widgetDevelopmentSettings, leadFormFields: newFields});
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-sm">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ</span>
                                </label>
                                <button
                                  onClick={() => {
                                    const newFields = widgetDevelopmentSettings.leadFormFields.filter((_, i) => i !== index);
                                    setWidgetSettings({...widgetDevelopmentSettings, leadFormFields: newFields});
                                  }}
                                  className="text-red-500 hover:text-red-700"
                                >
                                  <X className="w-4 h-4" />
                                </button>
                              </div>
                            ))}
                            <button
                              onClick={() => {
                                const newFields = [...widgetDevelopmentSettings.leadFormFields, { name: '', label: '', type: 'text', required: false }];
                                setWidgetSettings({...widgetDevelopmentSettings, leadFormFields: newFields});
                              }}
                              className="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors"
                            >
                              + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è */}
                <div className="border-t pt-6">
                  <h4 className="text-lg font-semibold mb-4">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h4>
                  <div className="space-y-4">
                    {widgetDevelopmentSettings.quickReplies.map((reply, index) => (
                      <div key={index} className="flex items-center border rounded-md p-2">
                        <input
                          type="text"
                          value={reply}
                          onChange={(e) => {
                            const newReplies = [...widgetDevelopmentSettings.quickReplies];
                            newReplies[index] = e.target.value;
                            setWidgetSettings({...widgetDevelopmentSettings, quickReplies: newReplies});
                          }}
                          className="flex-1 p-2 border border-gray-300 rounded-md text-sm"
                          placeholder={`–°–æ–æ–±—â–µ–Ω–∏–µ ${index + 1}`}
                        />
                        <button
                          onClick={() => {
                            const newReplies = widgetDevelopmentSettings.quickReplies.filter((_, i) => i !== index);
                            setWidgetSettings({...widgetDevelopmentSettings, quickReplies: newReplies});
                          }}
                          className="ml-2 text-red-400 hover:text-red-600"
                        >
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                    <button
                      onClick={() => {
                        const newReplies = [...widgetDevelopmentSettings.quickReplies, ''];
                        setWidgetSettings({...widgetDevelopmentSettings, quickReplies: newReplies});
                      }}
                      className="text-blue-400 hover:text-blue-600 font-medium"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    </button>
                    <p className="text-sm text-gray-500">–£–∫–∞–∂–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∏–¥–Ω—ã –≤ –≤–∏–¥–∂–µ—Ç–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</p>
                  </div>
                </div>

                {/* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */}
                <div className="border-t pt-6">
                  <h4 className="text-lg font-semibold mb-4">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h4>
                  <div className="space-y-4">
                    {widgetDevelopmentSettings.welcomeMessages.map((message, index) => (
                      <div key={index} className="flex items-center border rounded-md p-2">
                        <input
                          type="text"
                          value={message}
                          onChange={(e) => {
                            const newMessages = [...widgetDevelopmentSettings.welcomeMessages];
                            newMessages[index] = e.target.value;
                            setWidgetSettings({...widgetDevelopmentSettings, welcomeMessages: newMessages});
                          }}
                          className="flex-1 p-2 border border-gray-300 rounded-md text-sm"
                          placeholder={`–°–æ–æ–±—â–µ–Ω–∏–µ ${index + 1}`}
                        />
                        <button
                          onClick={() => {
                            const newMessages = widgetDevelopmentSettings.welcomeMessages.filter((_, i) => i !== index);
                            setWidgetSettings({...widgetDevelopmentSettings, welcomeMessages: newMessages});
                          }}
                          className="ml-2 text-red-400 hover:text-red-600"
                        >
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                    <button
                      onClick={() => {
                        const newMessages = [...widgetDevelopmentSettings.welcomeMessages, ''];
                        setWidgetSettings({...widgetDevelopmentSettings, welcomeMessages: newMessages});
                      }}
                      className="text-blue-400 hover:text-blue-600 font-medium"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    </button>
                    <p className="text-sm text-gray-500">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∏–¥–Ω—ã –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞</p>
                  </div>
                </div>

                {/* –õ–æ–≥–æ—Ç–∏–ø –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥ */}
                <div className="border-t pt-6">
                  <h4 className="text-lg font-semibold mb-4">–õ–æ–≥–æ—Ç–∏–ø –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä—è–¥–æ–º —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º</label>
                        <input
                          type="text"
                          value={widgetDevelopmentSettings.buttonText}
                          onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, buttonText: e.target.value})}
                          className="w-full p-2 border border-gray-300 rounded-md text-sm"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                        />
                        <p className="mt-2 text-sm text-gray-500">–¢–µ–∫—Å—Ç, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ä—è–¥–æ–º —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –≤ –≤–∏–¥–∂–µ—Ç–µ.</p>
                      </div>
                    </div>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">–°—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø</label>
                        <input
                          type="url"
                          value={widgetDevelopmentSettings.logoUrl || ''}
                          onChange={(e) => setWidgetSettings({...widgetDevelopmentSettings, logoUrl: e.target.value})}
                          className="w-full p-2 border border-gray-300 rounded-md text-sm"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø"
                        />
                        <p className="mt-2 text-sm text-gray-500">–í—Å—Ç–∞–≤—å—Ç–µ URL –ª–æ–≥–æ—Ç–∏–ø–∞ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –≤–∏–¥–∂–µ—Ç–µ.</p>
                      </div>
                    </div>
                  </div>
                </div>

                {/* –ö–æ–¥ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ */}
                <div className="border-t pt-6">
                  <h4 className="text-lg font-semibold mb-4">–ö–æ–¥ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏</h4>
                  <div className="bg-gray-50 p-4 rounded-lg mb-4">
                    <p className="text-sm text-gray-700 mb-2">–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∫–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–∞ <span className="font-semibold text-blue-700">&lt;body&gt;</span> –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –≥–¥–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –≤–∏–¥–∂–µ—Ç.</p>
                  </div>
                  <div className="bg-gray-900 rounded-lg overflow-hidden">
                    <div className="flex items-center justify-between px-4 py-2 bg-gray-800">
                      <span className="text-gray-200 font-mono text-sm">HTML</span>
                      <div className="flex items-center gap-3">
                        <button 
                          onClick={() => {
                            navigator.clipboard.writeText(generateWidgetCode());
                            showNotificationMessage('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
                          }}
                          className="text-gray-200 hover:text-white transition-colors text-sm"
                        >
                          –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button 
                          onClick={openWidgetPreview}
                          className="text-gray-200 hover:text-white transition-colors text-sm underline"
                        >
                          –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                        </button>
                      </div>
                    </div>
                    <pre className="p-4 text-gray-200 text-sm overflow-x-auto">
                      <code>{generateWidgetCode()}</code>
                    </pre>
                  </div>
                </div>

                {/* –ü—Ä–µ–≤—å—é –≤–∏–¥–∂–µ—Ç–∞ */}
                <div className="border-t pt-6">
                  <h4 className="text-lg font-semibold mb-4">–ü—Ä–µ–≤—å—é –≤–∏–¥–∂–µ—Ç–∞</h4>
                  <div className="flex items-center justify-between mb-3">
                    <p className="text-sm text-gray-600">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å —Ç–µ–º –∂–µ —Å–∫—Ä–∏–ø—Ç–æ–º, —á—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç.</p>
                    <button onClick={openWidgetPreview} className="px-3 py-1.5 rounded-md text-sm bg-blue-600 text-white hover:bg-blue-700 transition-colors">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</button>
                  </div>
                  <div className="border rounded-lg shadow-inner h-96 overflow-hidden relative">
                    <iframe 
                      src={(() => {
                        const settings = {
                          accentColor: widgetDevelopmentSettings.accentColor,
                          buttonText: widgetDevelopmentSettings.buttonText,
                          buttonStyle: widgetDevelopmentSettings.buttonColor || 'rectangle',
                          buttonColor: widgetDevelopmentSettings.buttonColor || 'light',
                          customButtonColor: widgetDevelopmentSettings.customButtonColor,
                          widgetMode: widgetDevelopmentSettings.widgetMode,
                          quickQuestions: widgetDevelopmentSettings.quickQuestions,
                          leadFormEnabled: widgetDevelopmentSettings.leadFormEnabled,
                          leadFormTitle: widgetDevelopmentSettings.leadFormTitle,
                          leadFormDescription: widgetDevelopmentSettings.leadFormDescription,
                          leadFormFields: widgetDevelopmentSettings.leadFormFields,
                          welcomeMessages: widgetDevelopmentSettings.welcomeMessages,
                          quickReplies: widgetDevelopmentSettings.quickReplies,
                          logoUrl: widgetDevelopmentSettings.logoUrl,
                          logoName: widgetDevelopmentSettings.logoName,
                          suggestions: widgetDevelopmentSettings.suggestions,
                          triggerQuestionEnabled: widgetDevelopmentSettings.triggerQuestionEnabled,
                          triggerQuestionDelay: widgetDevelopmentSettings.triggerQuestionDelay,
                          triggerQuestionText: widgetDevelopmentSettings.triggerQuestionText,
                          followUpMessage: widgetDevelopmentSettings.followUpMessage,
                          followUpDelay: widgetDevelopmentSettings.followUpDelay,
                          followUpQuestion: widgetDevelopmentSettings.followUpQuestion,
                          followUpQuickReply: widgetDevelopmentSettings.followUpQuickReply,
                          privacyPolicyUrl: widgetDevelopmentSettings.privacyPolicyUrl,
                          dataTags: widgetDevelopmentSettings.dataTags,
                          widgetLocation: widgetDevelopmentSettings.widgetLocation,
                          desktopBottomOffset: widgetDevelopmentSettings.desktopBottomOffset,
                          desktopRightOffset: widgetDevelopmentSettings.desktopRightOffset,
                          mobileBottomOffset: widgetDevelopmentSettings.mobileBottomOffset,
                          mobileRightOffset: widgetDevelopmentSettings.mobileRightOffset,
                          zIndex: widgetDevelopmentSettings.zIndex,
                          avatar: widgetDevelopmentSettings.avatar
                        };
                        const userKey = currentUser?.id ? `adapto_${currentUser.id}` : 'adapto_demo';
                        return `${API_CONFIG.BASE_URL}/widget-preview.html?key=${userKey}&noCache=1&ts=${Date.now()}`;
                      })()} 
                      title="Widget Preview" 
                      className="w-full h-full"
                      style={{ border: 'none' }}
                    />
                  </div>
                </div>

                {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                <div className="flex justify-end gap-3 pt-6 border-t">
                  <Button 
                    variant="outline"
                    onClick={() => {
                      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–æ—Å–º–æ—Ç—Ä –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                      const previewUrl = `http://localhost:3002/preview.html?settings=${encodeURIComponent(JSON.stringify(widgetDevelopmentSettings))}`;
                      window.open(previewUrl, '_blank');
                    }}
                  >
                    –ü—Ä–µ–¥–æ—Å–º–æ—Ç—Ä
                  </Button>
                  <Button 
                    onClick={() => {
                      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                      localStorage.setItem('widgetDevelopmentSettings', JSON.stringify(widgetDevelopmentSettings));
                      showNotificationMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                      setShowWidgetModal(false);
                    }}
                  >
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Integration Modal */}
      {showIntegrationModal && selectedIntegration && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowIntegrationModal(false)} />
          <div className="relative bg-white rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-gray-200">
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => setShowIntegrationModal(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  ‚Üê
                </button>
                <h3 className="text-xl font-semibold">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ {selectedIntegration.name}</h3>
              </div>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6">
              <div className="space-y-6">
                <div className="flex items-center gap-4">
                  <img src={`/${selectedIntegration.icon}`} alt={selectedIntegration.name} className="w-12 h-12" />
                  <div>
                    <h4 className="text-lg font-medium">{selectedIntegration.name}</h4>
                    <p className="text-gray-600">{selectedIntegration.description}</p>
                  </div>
                </div>

                <div className="bg-gray-50 rounded-lg p-4">
                  <h5 className="font-medium mb-3">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ:</h5>
                  <div className="space-y-3 text-sm">
                    <p>1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ {selectedIntegration.name}</p>
                    <p>2. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏" –∏–ª–∏ "API"</p>
                    <p>3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à API –∫–ª—é—á</p>
                    <p>4. –í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –≤ –ø–æ–ª–µ –Ω–∏–∂–µ</p>
                    <p>5. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å"</p>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">API –ö–ª—é—á</label>
                  <Input
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á"
                    className="w-full"
                  />
                </div>

                <div className="flex gap-3">
                  <Button
                    onClick={() => handleIntegrationSuccess(selectedIntegration.id)}
                    className="flex-1"
                  >
                    –ü–æ–¥–∫–ª—é—á–∏—Ç—å
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => setShowIntegrationModal(false)}
                  >
                    –û—Ç–º–µ–Ω–∞
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Uninstall Modal */}
      {showUninstallModal && integrationToUninstall && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowUninstallModal(false)} />
          <div className="relative bg-white rounded-xl w-full max-w-md mx-4 p-6">
            <div className="text-center">
              <h3 className="text-lg font-semibold mb-4">–£–¥–∞–ª–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é?</h3>
              <p className="text-gray-600 mb-6">
                –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å {integrationToUninstall.name}? 
                –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
              </p>
              <div className="flex gap-3">
                <Button
                  onClick={confirmUninstall}
                  variant="destructive"
                  className="flex-1"
                >
                  –î–∞, —É–¥–∞–ª–∏—Ç—å
                </Button>
                <Button
                  variant="outline"
                  onClick={() => setShowUninstallModal(false)}
                  className="flex-1"
                >
                  –ù–µ—Ç, –æ—Ç–º–µ–Ω–∞
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Setup Wizard Modal –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ */}
      {showSetupWizard && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
                              <h2 className="text-[20px] font-[500]">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞—à–µ–≥–æ –ò–ò-–∞–≥–µ–Ω—Ç–∞</h2>
              <Button variant="ghost" onClick={() => setShowSetupWizard(false)}>
                <X className="w-4 h-4" />
              </Button>
            </div>

            {/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */}
            <div className="mb-8">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium">–®–∞–≥ {setupStep} –∏–∑ 4</span>
                <span className="text-sm text-gray-500">{Math.round((setupStep / 4) * 100)}%</span>
              </div>
              <div className="w-full bg-gray-200 rounded-[90px] h-2">
                <div 
                  className="bg-blue-600 h-2 rounded-[90px] transition-all duration-300"
                  style={{ width: `${(setupStep / 4) * 100}%` }}
                ></div>
              </div>
            </div>

            {/* –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —à–∞–≥–æ–≤ */}
            {setupStep === 1 && (
              <div className="space-y-6">
                <h3 className="text-xl font-semibold">–®–∞–≥ 1: –£—Ç–æ—á–Ω–∏—Ç–µ —Ü–µ–ª–∏ Adapto</h3>
                
                {/* 1. –ö–∞–∫—É—é –∑–∞–¥–∞—á—É –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å –ê–¥–∞–ø—Ç–æ? */}
                <div>
                  <label className="block mb-3 font-medium">1. –ö–∞–∫—É—é –∑–∞–¥–∞—á—É –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å –ê–¥–∞–ø—Ç–æ?</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button
                      onClick={() => setSetupData({...setupData, task: '–ü—Ä–æ–¥–∞–≤–∞—Ç—å'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        setupData.task === '–ü—Ä–æ–¥–∞–≤–∞—Ç—å' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">–ü—Ä–æ–¥–∞–≤–∞—Ç—å</div>
                        <div className="text-sm text-gray-600">–ü–æ–º–æ–≥–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∂–∞—Ö</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, task: '–ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        setupData.task === '–ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium mb-1">–ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                        <div className="text-sm text-gray-600">–î–∞–≤–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</div>
                      </div>
                    </button>
                  </div>
                </div>

                {/* 2. –ö–∞–∫–∞—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –∏–∏-–∞–≥–µ–Ω—Ç–∞? */}
                <div>
                  <label className="block mb-3 font-medium">2. –ö–∞–∫–∞—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –∏–∏-–∞–≥–µ–Ω—Ç–∞?</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {[
                      '–ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é',
                      '–ü—Ä–æ–¥–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç',
                      '–†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∫–ª–∏–µ–Ω—Ç–∞'
                    ].map(goal => (
                      <button
                        key={goal}
                        onClick={() => setSetupData({...setupData, mainGoal: goal})}
                        className={`p-4 rounded-lg border-2 transition-all ${
                          setupData.mainGoal === goal 
                            ? 'border-blue-500 ring-2 ring-blue-200' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="text-center">
                          <div className="text-lg font-medium">{goal}</div>
                        </div>
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, mainGoal: 'custom'})}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        setupData.mainGoal === 'custom' 
                          ? 'border-blue-500 ring-2 ring-blue-200' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="text-lg font-medium">–î—Ä—É–≥–æ–µ</div>
                        <div className="text-sm text-gray-600">–£–∫–∞–∑–∞—Ç—å —Å–≤–æ—é —Ü–µ–ª—å</div>
                      </div>
                    </button>
                  </div>
                  {setupData.mainGoal === 'custom' && (
                    <div className="mt-3">
                      <Input
                        value={setupData.customGoal || ''}
                        onChange={(e) => setSetupData({...setupData, customGoal: e.target.value})}
                        placeholder="–£–∫–∞–∂–∏—Ç–µ –≤–∞—à—É –≥–ª–∞–≤–Ω—É—é —Ü–µ–ª—å"
                        className="w-full"
                      />
                    </div>
                  )}
                </div>

                {/* 3. –ö–∞–∫–æ–π —Ü–∏–∫–ª —Å–¥–µ–ª–∫–∏ —É –≤–∞—Å –≤ –∫–æ–º–ø–∞–Ω–∏–∏? */}
                <div>
                  <label className="block mb-2 font-medium">3. –ö–∞–∫–æ–π —Ü–∏–∫–ª —Å–¥–µ–ª–∫–∏ —É –≤–∞—Å –≤ –∫–æ–º–ø–∞–Ω–∏–∏?</label>
                  <Textarea
                    value={setupData.dealCycle || ''}
                    onChange={(e) => setSetupData({...setupData, dealCycle: e.target.value})}
                    placeholder="–û–ø–∏—à–∏—Ç–µ —Ü–∏–∫–ª —Å–¥–µ–ª–∫–∏ –≤ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏..."
                    className="min-h-[100px]"
                  />
                </div>

                {/* 4. –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è */}
                <div>
                  <label className="block mb-2 font-medium">4. –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</label>
                  <Textarea
                    value={setupData.targetAudience || ''}
                    onChange={(e) => setSetupData({...setupData, targetAudience: e.target.value})}
                    placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é..."
                    className="min-h-[100px]"
                  />
                </div>
              </div>
            )}

            {setupStep === 2 && (
              <div className="space-y-6">
                <h3 className="text-xl font-semibold">–®–∞–≥ 2: –ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è</h3>
                
                {/* 1. –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é */}
                <div>
                  <label className="block mb-3 font-medium">–û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</label>
                  <div className="flex gap-3">
                    <button 
                      onClick={() => setSetupData({...setupData, addressing: '–¢—ã'})}
                      className={`flex-1 border rounded-[90px] h-12 transition-colors ${
                        setupData.addressing === '–¢—ã' ? 'bg-[#0084FF] text-white border-[#0084FF]' : 'bg-white hover:bg-gray-50 border-gray-200'
                      }`}
                    >
                      –ù–∞ "–¢—ã"
                    </button>
                    <button 
                      onClick={() => setSetupData({...setupData, addressing: '–í—ã'})}
                      className={`flex-1 border rounded-[90px] h-12 transition-colors ${
                        setupData.addressing === '–í—ã' ? 'bg-[#0084FF] text-white border-[#0084FF]' : 'bg-white hover:bg-gray-50 border-gray-200'
                      }`}
                    >
                      –ù–∞ "–í—ã"
                    </button>
                  </div>
                </div>

                {/* 2. –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è */}
                <div>
                  <label className="block mb-3 font-medium">2. –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è</label>
                  <div className="flex flex-wrap gap-3">
                    {[
                      { text: '–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π', emoji: 'üòä' },
                      { text: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π', emoji: 'üòê' },
                      { text: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π', emoji: 'üíº' },
                      { text: '–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π', emoji: 'üòÑ' }
                    ].map(t => (
                      <button 
                        key={t.text} 
                        onClick={() => setSetupData({...setupData, communicationStyle: t.text})} 
                        className={`px-6 py-3 rounded-[90px] border flex items-center gap-2 ${
                          setupData.communicationStyle === t.text ? 'bg-blue-600 text-white border-blue-600' : 'bg-white hover:bg-gray-50'
                        }`}
                      >
                        <span>{t.emoji}</span>
                        <span>{t.text}</span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ê–¥–∞–ø—Ç–æ */}
                <div>
                  <label className="block mb-3 font-medium">3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ê–¥–∞–ø—Ç–æ</label>
                  <div className="flex flex-wrap gap-2">
                    {[
                      '–ù–µ –æ–±—Å—É–∂–¥–∞–π —Ü–µ–Ω—ã',
                      '–ù–µ –¥–∞–≤–∞–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å–æ–≤–µ—Ç–æ–≤',
                      '–ù–µ –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π –ø–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º',
                      '–ù–µ —Ä–∞–∑—ä—è—Å–Ω—è–π —É—Å–ª–æ–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤',
                      '–ù–µ —Å–æ–∑–¥–∞–≤–∞–π –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –æ—Ç –ª–∏—Ü–∞ –∫–æ–º–ø–∞–Ω–∏–∏',
                      '–ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–π –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏'
                    ].map(restriction => (
                      <button
                        key={restriction}
                        onClick={() => {
                          const current = setupData.restrictions || [];
                          const newRestrictions = current.includes(restriction)
                            ? current.filter(r => r !== restriction)
                            : [...current, restriction];
                          setSetupData({...setupData, restrictions: newRestrictions});
                        }}
                        className={`px-4 py-2 rounded-[90px] border-2 transition-all text-sm ${
                          (setupData.restrictions || []).includes(restriction)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {restriction}
                      </button>
                    ))}
                    <button
                      onClick={() => setSetupData({...setupData, showCustomRestriction: true})}
                      className="px-4 py-2 rounded-[90px] border-2 border-gray-200 bg-white text-gray-700 hover:border-gray-300 text-sm"
                    >
                      –î—Ä—É–≥–æ–µ
                    </button>
                  </div>
                  {setupData.showCustomRestriction && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customRestriction || ''}
                        onChange={(e) => setSetupData({...setupData, customRestriction: e.target.value})}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customRestriction) {
                            const current = setupData.restrictions || [];
                            setSetupData({
                              ...setupData, 
                              restrictions: [...current, setupData.customRestriction],
                              customRestriction: '',
                              showCustomRestriction: false
                            });
                          }
                        }}
                        disabled={!setupData.customRestriction}
                      >
                        –î–æ–±–∞–≤–∏—Ç—å
                      </Button>
                    </div>
                  )}
                </div>

                {/* 4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è */}
                <div>
                  <label className="block mb-3 font-medium">4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è –ø–æ–¥ –≤–∞—à—É –∫–æ–º–ø–∞–Ω–∏—é</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {[
                      '–ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
                      '–ü–æ—è—Å–Ω—è—Ç—å —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π',
                      '–ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞',
                      '–ò–∑–±–µ–≥–∞—Ç—å –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π',
                      '–£—Ç–æ—á–Ω—è—Ç—å –∑–∞–¥–∞—á—É –≤ –Ω–∞—á–∞–ª–µ –æ–±—â–µ–Ω–∏—è',
                      '–ù–µ –æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞',
                      '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –æ–± –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞',
                      '–ò–∑–±–µ–≥–∞—Ç—å —Å–ø–æ—Ä–æ–≤',
                      '–û—Ç–≤–µ—á–∞—Ç—å –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞'
                    ].map(setting => (
                      <button
                        key={setting}
                        onClick={() => {
                          const current = setupData.communicationSettings || [];
                          const newSettings = current.includes(setting)
                            ? current.filter(s => s !== setting)
                            : [...current, setting];
                          setSetupData({...setupData, communicationSettings: newSettings});
                        }}
                        className={`p-3 rounded-lg border-2 transition-all text-left ${
                          (setupData.communicationSettings || []).includes(setting)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {setting}
                      </button>
                    ))}
                  </div>
                  <div className="mt-3">
                    <Input
                      value={setupData.customCommunicationSetting || ''}
                      onChange={(e) => setSetupData({...setupData, customCommunicationSetting: e.target.value})}
                      placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –æ–±—â–µ–Ω–∏—è"
                      className="w-full"
                    />
                  </div>
                </div>

                {/* 5. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö */}
                <div>
                  <label className="block mb-3 font-medium">5. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</label>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                    {[
                      '–ò–º—è',
                      '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
                      '–ü–æ—á—Ç–∞',
                      '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏',
                      '–ì–æ—Ä–æ–¥',
                      '–í–æ–∑—Ä–∞—Å—Ç'
                    ].map(dataType => (
                      <button
                        key={dataType}
                        onClick={() => {
                          const current = setupData.dataCollection || [];
                          const newData = current.includes(dataType)
                            ? current.filter(d => d !== dataType)
                            : [...current, dataType];
                          setSetupData({...setupData, dataCollection: newData});
                        }}
                        className={`p-2 rounded-lg border-2 transition-all text-sm ${
                          (setupData.dataCollection || []).includes(dataType)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {dataType}
                      </button>
                    ))}
                  </div>
                  <div className="flex gap-3">
                    <button
                      onClick={() => setSetupData({...setupData, dataCollection: []})}
                      className={`px-4 py-2 rounded-lg border-2 transition-all ${
                        (setupData.dataCollection || []).length === 0
                          ? 'border-blue-500 bg-blue-50 text-blue-700' 
                          : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                      }`}
                    >
                      –ù–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <button
                      onClick={() => setSetupData({...setupData, showCustomData: true})}
                      className="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-gray-300"
                    >
                      –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                  </div>
                  {setupData.showCustomData && (
                    <div className="mt-3 flex gap-2">
                      <Input
                        value={setupData.customData || ''}
                        onChange={(e) => setSetupData({...setupData, customData: e.target.value})}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–±–æ—Ä–∞"
                        className="flex-1"
                      />
                      <Button 
                        onClick={() => {
                          if (setupData.customData) {
                            const current = setupData.dataCollection || [];
                            setSetupData({
                              ...setupData, 
                              dataCollection: [...current, setupData.customData],
                              customData: '',
                              showCustomData: false
                            });
                          }
                        }}
                        disabled={!setupData.customData}
                      >
                        –î–æ–±–∞–≤–∏—Ç—å
                      </Button>
                    </div>
                  )}
                </div>

                {/* 6. –£—Ç–æ—á–Ω–µ–Ω–∏–µ –∏ –≤–æ–ø—Ä–æ—Å—ã */}
                <div>
                  <label className="block mb-3 font-medium">6. –£—Ç–æ—á–Ω–µ–Ω–∏–µ –∏ –≤–æ–ø—Ä–æ—Å—ã</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                    {[
                      '–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ–ø–æ–ª–Ω—ã–π',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è',
                      '–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∏—Å–∫ –æ—à–∏–±–∫–∏',
                      '–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏',
                      '–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–Ω–∫–æ—Å—Ç–µ–π',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ',
                      '–ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥–±–æ—Ä',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å—ã –≤–Ω–µ —Å–≤–æ–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –≤–µ—â–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π',
                      '–ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –∏–ª–∏ –∑–∞–∫–∞–∑–∞',
                      '–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ',
                      '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–≥–æ –º–æ–ª—á–∏—Ç'
                    ].map(question => (
                      <button
                        key={question}
                        onClick={() => {
                          const current = setupData.clarificationQuestions || [];
                          const newQuestions = current.includes(question)
                            ? current.filter(q => q !== question)
                            : [...current, question];
                          setSetupData({...setupData, clarificationQuestions: newQuestions});
                        }}
                        className={`p-3 rounded-lg border-2 transition-all text-left text-sm ${
                          (setupData.clarificationQuestions || []).includes(question)
                            ? 'border-blue-500 bg-blue-50 text-blue-700' 
                            : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'
                        }`}
                      >
                        {question}
                      </button>
                    ))}
                  </div>
                </div>

                {/* 7. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–º–∞–π–ª–∏–∫–æ–≤ */}
                <div>
                  <label className="block mb-3 font-medium">7. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–º–∞–π–ª–∏–∫–æ–≤</label>
                  <div className="flex gap-3">
                    {[
                      { text: '–ù–∏–∫–æ–≥–¥–∞', emoji: 'üòê' },
                      { text: '–†–µ–¥–∫–æ', emoji: 'üòä' },
                      { text: '–ß–∞—Å—Ç–æ', emoji: 'üòÑ' }
                    ].map(option => (
                      <button
                        key={option.text}
                        onClick={() => setSetupData({...setupData, emojiUsage: option.text})}
                        className={`flex-1 p-4 rounded-lg border-2 transition-all ${
                          setupData.emojiUsage === option.text
                            ? 'border-blue-500 ring-2 ring-blue-200' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="text-center">
                          <div className="text-2xl mb-2">{option.emoji}</div>
                          <div className="font-medium">{option.text}</div>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {setupStep === 3 && (
              <div className="space-y-6">
                <h3 className="text-xl font-semibold">–®–∞–≥ 3: –≠—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞</h3>
                <p className="text-gray-600">–û–ø–∏—à–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç</p>
                <p className="text-gray-600">–ß–µ–º –ª—É—á—à–µ –≤—ã –æ–ø–∏—à–∏—Ç–µ –≤–∞—à —Å–∫—Ä–∏–ø—Ç, —Ç–µ–º –ª—É—á—à–µ –∏–∏-–∞–≥–µ–Ω—Ç —Å–º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–¥–∞—á–∏.</p>
                
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                  <div className="flex items-start gap-3">
                    <div className="w-6 h-6 bg-blue-500 rounded-[90px] flex items-center justify-center flex-shrink-0 mt-0.5">
                      <span className="text-white text-sm">!</span>
                    </div>
                    <div>
                      <div className="font-medium text-blue-800 mb-1">–£–¥–µ–ª–∏—Ç–µ –≤—Ä–µ–º—è –¥–µ—Ç–∞–ª—å–Ω–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞</div>
                      <div className="text-sm text-blue-700">
                        –≠—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –¥–ª—è —Ö–æ—Ä–æ—à–µ–π —Ä–∞–±–æ—Ç—ã –≤–∞—à–µ–≥–æ –ò–ò-–ø—Ä–æ–¥–∞–∂–Ω–∏–∫–∞. –í—ã —Å–º–æ–∂–µ—Ç–µ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–∑–∂–µ, –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–π—á–∞—Å –¥–∞—Å—Ç –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–∑—É. –ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω —à–∞–±–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –Ω—É–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å.
                      </div>
                    </div>
                  </div>
                </div>

                <div className="space-y-4">
                  {(setupData.dialogStages || [
                    'üéØ –£–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–ê: –ü–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è —Ç–µ–ø–ª–æ, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫–∞–∫ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫. –°–ø—Ä–æ—Å–∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∫–∞–∫ –¥–µ–ª–∞. –°–æ–∑–¥–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.',
                    'üîç –í–´–Ø–°–ù–ï–ù–ò–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ï–ô: –ó–∞–¥–∞–≤–∞–π –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞, —Ü–µ–ª—è—Ö –∏ —Å–∏—Ç—É–∞—Ü–∏–∏. –£—Ç–æ—á–Ω–∏ –¥–µ—Ç–∞–ª–∏: –±—é–¥–∂–µ—Ç, —Å—Ä–æ–∫–∏, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.',
                    'üí° –ü–†–ï–ó–ï–ù–¢–ê–¶–ò–Ø –ò –ó–ê–ö–†–´–¢–ò–ï: –ü—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π. –†–∞—Å—Å–∫–∞–∂–∏ –æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö –∏ –≤—ã–≥–æ–¥–∞—Ö. –ü—Ä–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è—Ö - –≤—ã—è—Å–Ω–∏ –ø—Ä–∏—á–∏–Ω—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã. –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤ - –ø–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.'
                  ]).map((stage, index) => (
                    <div key={index} className="border border-gray-200 rounded-lg p-4">
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-gray-500 rounded-[90px] flex items-center justify-center flex-shrink-0 mt-0.5">
                          <span className="text-white text-sm">{index + 1}</span>
                        </div>
                        <div className="flex-1">
                          <Textarea
                            value={stage}
                            onChange={(e) => {
                              const newStages = [...(setupData.dialogStages || [])];
                              newStages[index] = e.target.value;
                              setSetupData({...setupData, dialogStages: newStages, dialogStagesModified: true});
                            }}
                            className="w-full resize-none"
                            rows={2}
                          />
                        </div>
                        <Button 
                          variant="ghost" 
                          size="sm"
                          onClick={() => {
                            const newStages = [...(setupData.dialogStages || [])];
                            newStages.splice(index, 1);
                            setSetupData({...setupData, dialogStages: newStages, dialogStagesModified: true});
                          }}
                        >
                          <img src="/traash.svg" alt="–£–¥–∞–ª–∏—Ç—å" className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  ))}
                  
                  <Button 
                    variant="outline" 
                    onClick={() => {
                      const newStages = [...(setupData.dialogStages || []), '–ù–æ–≤—ã–π —ç—Ç–∞–ø –¥–∏–∞–ª–æ–≥–∞'];
                      setSetupData({...setupData, dialogStages: newStages, dialogStagesModified: true});
                    }}
                    className="w-full"
                  >
                    <Plus className="w-4 h-4 mr-2" />
                    –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø
                  </Button>
                </div>

                {/* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω—ã —ç—Ç–∞–ø—ã */}
                {setupData.dialogStagesModified === false && (
                  <div className="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <div className="w-6 h-6 bg-yellow-500 rounded-[90px] flex items-center justify-center flex-shrink-0 mt-0.5">
                        <span className="text-white text-sm">‚ö†</span>
                      </div>
                      <div>
                        <div className="font-medium text-yellow-800 mb-1">–í—ã –Ω–µ –≤–Ω–µ—Å–ª–∏ –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>
                        <div className="text-sm text-yellow-700 mb-3">
                          –û–Ω –Ω–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –≤–∞—à –±–∏–∑–Ω–µ—Å —ç—Ç–æ –º–æ–∂–µ—Ç —Å–∫–∞–∑–∞—Ç—å—Å—è –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–∏-–∞–≥–µ–Ω—Ç–∞.
                        </div>
                        <div className="flex gap-3">
                          <Button 
                            variant="outline"
                            onClick={() => setSetupData({...setupData, dialogStagesModified: true})}
                          >
                            –í–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                          </Button>
                          <Button 
                            onClick={() => setSetupData({...setupData, dialogStagesModified: true})}
                          >
                            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                          </Button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {setupStep === 4 && (
              <div className="space-y-6">
                <h3 className="text-xl font-semibold">–®–∞–≥ 4: –û–±—É—á–µ–Ω–∏–µ –ê–¥–∞–ø—Ç–æ</h3>
                <p className="text-gray-600">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –º–∏–Ω–∏–º—É–º 1 —Ä–µ—Å—É—Ä—Å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–º–ø–∞–Ω–∏–∏, —á—Ç–æ–±—ã –ê–¥–∞–ø—Ç–æ —Å–º–æ–≥ –æ–±—É—á–∏—Ç—å—Å—è –Ω–∞ –Ω–µ–π</p>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {[
                    { id: 'site', name: '–°–∞–π—Ç', description: '–î–æ–±–∞–≤–∏—Ç—å URL –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞', icon: Globe },
                    { id: 'feed', name: '–¢–æ–≤–∞—Ä–Ω—ã–π —Ñ–∏–¥', description: 'CSV/XML —Ñ–∏–¥ –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥', icon: FileIcon },
                    { id: 'text', name: '–ù–∞–ø–∏—Å–∞—Ç—å —Å–∞–º–æ–º—É', description: '–í–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é', icon: EditIcon },
                    { id: 'file', name: '–§–∞–π–ª', description: 'PDF, Word, Excel, TXT, CSV, XML', icon: Upload }
                  ].map((option) => (
                    <button
                      key={option.id}
                      onClick={() => setSetupData({...setupData, selectedKnowledgeType: option.id})}
                      className="p-4 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors text-left"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <option.icon className="w-5 h-5 text-blue-600" />
                        </div>
                        <div>
                          <div className="font-medium">{option.name}</div>
                          <div className="text-sm text-gray-600">{option.description}</div>
                        </div>
                      </div>
                    </button>
                  ))}
                </div>

                {/* –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ */}
                {setupData.selectedKnowledgeType && (
                  <div className="mt-6 p-4 border border-blue-200 rounded-lg bg-blue-50">
                    <h4 className="font-medium mb-3">
                      {setupData.selectedKnowledgeType === 'site' && '–î–æ–±–∞–≤–∏—Ç—å URL —Å–∞–π—Ç–∞'}
                      {setupData.selectedKnowledgeType === 'feed' && '–ó–∞–≥—Ä—É–∑–∏—Ç—å CSV/XML —Ñ–∏–¥'}
                      {setupData.selectedKnowledgeType === 'text' && '–í–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é'}
                      {setupData.selectedKnowledgeType === 'file' && '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (PDF, Word, Excel, TXT, CSV, XML)'}
                    </h4>
                    
                    {setupData.selectedKnowledgeType === 'site' && (
                      <div className="space-y-3">
                        <Input
                          value={setupData.knowledgeInput || ''}
                          onChange={(e) => setSetupData({...setupData, knowledgeInput: e.target.value})}
                          placeholder="https://example.com"
                          className="w-full"
                        />
                        <Button 
                          onClick={async () => {
                            if (setupData.knowledgeInput) {
                              const newItem = {
                                type: 'site',
                                content: setupData.knowledgeInput,
                                nicheId: selectedNicheId
                              };
                              await handleAddKnowledgeItem(newItem);
                              setSetupData({
                                ...setupData, 
                                knowledgeInput: '',
                                selectedKnowledgeType: null
                              });
                            }
                          }}
                          disabled={!setupData.knowledgeInput}
                        >
                          –î–æ–±–∞–≤–∏—Ç—å —Å–∞–π—Ç
                        </Button>
                      </div>
                    )}
                    
                    {setupData.selectedKnowledgeType === 'text' && (
                      <div className="space-y-3">
                        <Textarea
                          value={setupData.knowledgeInput || ''}
                          onChange={(e) => setSetupData({...setupData, knowledgeInput: e.target.value})}
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, –ø—Ä–æ–¥—É–∫—Ç–∞—Ö, —É—Å–ª—É–≥–∞—Ö..."
                          className="w-full min-h-[120px]"
                        />
                        <Button 
                          onClick={async () => {
                            if (setupData.knowledgeInput) {
                              const newItem = {
                                type: 'text',
                                content: setupData.knowledgeInput,
                                nicheId: selectedNicheId
                              };
                              await handleAddKnowledgeItem(newItem);
                              setSetupData({
                                ...setupData, 
                                knowledgeInput: '',
                                selectedKnowledgeType: null
                              });
                            }
                          }}
                          disabled={!setupData.knowledgeInput}
                        >
                          –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
                        </Button>
                      </div>
                    )}
                    
                    {setupData.selectedKnowledgeType === 'file' && (
                      <div className="space-y-3">
                        <Input
                          type="file"
                          onChange={(e) => setSetupData({...setupData, knowledgeInput: e.target.files?.[0]?.name || ''})}
                          className="w-full"
                        />
                        <Button 
                          onClick={async () => {
                            if (setupData.knowledgeInput) {
                              const newItem = {
                                type: 'file',
                                content: setupData.knowledgeInput,
                                nicheId: selectedNicheId
                              };
                              await handleAddKnowledgeItem(newItem);
                              setSetupData({
                                ...setupData, 
                                knowledgeInput: '',
                                selectedKnowledgeType: null
                              });
                            }
                          }}
                          disabled={!setupData.knowledgeInput}
                        >
                          –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                        </Button>
                      </div>
                    )}
                    
                    {setupData.selectedKnowledgeType === 'feed' && (
                      <div className="space-y-3">
                        <Input
                          type="file"
                          accept=".csv,.xml"
                          onChange={(e) => setSetupData({...setupData, knowledgeInput: e.target.files?.[0]?.name || ''})}
                          className="w-full"
                        />
                        <Button 
                          onClick={async () => {
                            if (setupData.knowledgeInput) {
                              const newItem = {
                                type: 'feed',
                                content: setupData.knowledgeInput,
                                nicheId: selectedNicheId
                              };
                              await handleAddKnowledgeItem(newItem);
                              setSetupData({
                                ...setupData, 
                                knowledgeInput: '',
                                selectedKnowledgeType: null
                              });
                            }
                          }}
                          disabled={!setupData.knowledgeInput}
                        >
                          –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV/XML —Ñ–∏–¥
                        </Button>
                      </div>
                    )}
                  </div>
                )}

                {setupData.knowledgeItems && setupData.knowledgeItems.length > 0 && (
                  <div className="mt-4">
                    <h4 className="font-medium mb-2">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã:</h4>
                    <div className="space-y-2">
                      {setupData.knowledgeItems.map((item, index) => (
                        <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-blue-100 rounded-[90px] flex items-center justify-center">
                              {(item.type === 'site' || item.type === 'website') && <Globe className="w-4 h-4 text-blue-600" />}
                              {item.type === 'text' && <EditIcon className="w-4 h-4 text-blue-600" />}
                              {item.type === 'file' && <FileIcon className="w-4 h-4 text-blue-600" />}
                              {item.type === 'feed' && <FileIcon className="w-4 h-4 text-blue-600" />}
                            </div>
                            <span className="text-sm">{item.content}</span>
                          </div>
                          <div className="text-xs text-green-600">‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ</div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */}
            <div className="flex justify-between mt-8">
              <Button 
                variant="outline" 
                onClick={() => setSetupStep(Math.max(1, setupStep - 1))}
                disabled={setupStep === 1}
              >
                –ù–∞–∑–∞–¥
              </Button>
              
              {setupStep < 4 ? (
                <Button 
                  onClick={() => {
                    if (setupStep === 3) {
                      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–∞–ø–∞—Ö –¥–∏–∞–ª–æ–≥–∞
                      const originalStages = [
                        '–ü–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è –∏ —Å–ø—Ä–æ—Å–∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞. –£—Ç–æ—á–Ω–∏ –µ–≥–æ –ø—Ä–æ–±–ª–µ–º—É –∏ –ø–æ–π–º–∏ —Ç–µ–∫—É—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                        '–û–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ –∫–∞–∫ —Ä–µ—à–∏—à—å –µ–≥–æ –∑–∞–¥–∞—á—É/–Ω–∞–∑–æ–≤–∏ –Ω–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –ø—Ä–µ–¥–ª–æ–∂–∏ —Ç–æ–≤–∞—Ä—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É',
                        '–í–µ–¥–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞/–∑–∞—è–≤–∫–∏',
                        '–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑, —Å–¥–µ–ª–∞–π –∏—Ç–æ–≥ –∑–∞–∫–∞–∑–∞ –∏ –ø—Ä–∏—à–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.',
                        '–ü–µ—Ä–µ–≤–µ–¥–∏ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã –∏ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã'
                      ];
                      
                      const currentStages = setupData.dialogStages || [];
                      const hasChanges = currentStages.length !== originalStages.length || 
                        currentStages.some((stage, index) => stage !== originalStages[index]);
                      
                      if (!hasChanges) {
                        setSetupData({...setupData, dialogStagesModified: false});
                      } else {
                        setSetupData({...setupData, dialogStagesModified: true});
                        setSetupStep(setupStep + 1);
                      }
                    } else {
                      setSetupStep(setupStep + 1);
                    }
                  }}
                  disabled={
                    (setupStep === 1 && !setupData.task) ||
                    (setupStep === 2 && (!setupData.addressing || !setupData.communicationStyle)) ||
                    (setupStep === 3 && (!setupData.dialogStages || setupData.dialogStages.length === 0))
                  }
                >
                  –î–∞–ª–µ–µ
                </Button>
              ) : (
                <Button 
                  onClick={() => {
                    localStorage.setItem('hasShownSetupWizard', 'true');
                    setShowSetupWizard(false);
                    setShowModelSetupProgress(true);
                  }}
                  disabled={!setupData.knowledgeItems || setupData.knowledgeItems.length === 0}
                >
                  –ó–∞–≤–µ—Ä—à–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É
                </Button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Model Setup Progress Modal */}
      {showModelSetupProgress && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-white">
          <div className="text-center max-w-md mx-4">
            <div className="mb-8">
              <div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-[90px] animate-spin mx-auto mb-4"></div>
                              <h2 className="text-[20px] font-[500] text-gray-800 mb-2">–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å</h2>
              <p className="text-gray-600 mb-4">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –ú—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∞—à—É –º–æ–¥–µ–ª—å –ø–æ–¥ –≤–∞—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è.</p>
              <div className="text-3xl font-bold text-blue-600 mb-4">
                {Math.floor(modelSetupTimer / 60)}:{(modelSetupTimer % 60).toString().padStart(2, '0')}
              </div>
              
              {/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å —à–∞–≥–∞–º–∏ */}
              <div className="space-y-3">
                <div className="flex items-center justify-between text-sm">
                  <span>–ê–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–π –∏ –∑–∞–¥–∞—á</span>
                  <span className="text-green-600">‚úì</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è</span>
                  <span className="text-green-600">‚úì</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span>–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</span>
                  <span className="text-green-600">‚úì</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span>–û–±—É—á–µ–Ω–∏–µ –Ω–∞ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</span>
                  <span className="text-blue-600">‚è≥</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span>–§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏</span>
                  <span className="text-gray-400">‚óã</span>
                </div>
              </div>
            </div>
            
            <div className="w-full bg-gray-200 rounded-[90px] h-2">
              <div 
                className="bg-blue-600 h-2 rounded-[90px] transition-all duration-1000"
                style={{ width: `${((300 - modelSetupTimer) / 300) * 100}%` }}
              ></div>
            </div>
          </div>
        </div>
      )}

      {/* Site Import Popup */}
      {showSitePopup && (
        <div className="fixed inset-0 z-50 flex items-center justify-center" style={{ backgroundColor: 'rgba(7, 15, 26, 0.2)' }} onClick={handleSitePopupClose}>
          <div className="bg-white rounded-[20px] w-[700px] max-h-[90vh] overflow-y-auto relative" onClick={(e) => e.stopPropagation()}>
            <div className="p-[20px]">
              {/* Header */}
              <div className="flex items-center justify-between mb-[12px]">
                <h2 className="text-[20px] font-[500] text-[#070F1A]">–ö–∞–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞–Ω–∏—è?</h2>
                <button 
                  onClick={handleSitePopupClose}
                  className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
                >
                  <X className="w-5 h-5 text-gray-500" />
                </button>
              </div>

              {/* Description */}
              <p className="text-[#8E8E93] text-[14px] mb-[30px]">
                –í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∑–Ω–∞–Ω–∏—è–º–∏. –≠—Ç–æ –Ω–∞—É—á–∏—Ç –ò–ò, –∫–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –≤–∞—à–∏–º –±–∏–∑–Ω–µ—Å–æ–º
              </p>

              {/* Tabs */}
              <div className="flex gap-[20px] mb-[30px]">
                {/* Tab 1: –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Å–∞–π—Ç */}
                                  <div 
                    className={`w-[315px] h-[84px] border rounded-[15px] cursor-pointer transition-all ${
                      sitePopupTab === 'full' 
                        ? 'border-[#0084FF]/60 bg-[#FFFFFF]' 
                        : 'border-[#070F1A]/10 bg-white'
                    }`}
                    onClick={() => setSitePopupTab('full')}
                  >
                    <div className="h-full flex flex-col items-center justify-center">
                      <h3 className={`text-[16px] font-[500] mb-2 ${
                        sitePopupTab === 'full' ? 'text-[#070F1A]' : 'text-[#8E8E93]/70'
                      }`}>
                        –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Å–∞–π—Ç
                      </h3>
                      <p className={`text-[12px] font-[400] text-center px-4 ${
                        sitePopupTab === 'full' ? 'text-[#8E8E93]' : 'text-[#8E8E93]/70'
                      }`}>
                        –ò–ò –±—É–¥–µ—Ç –±—Ä–∞—Ç—å –∑–Ω–∞–Ω–∏—è —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü —Å–∞–π—Ç–∞
                      </p>
                    </div>
                  </div>

                {/* Tab 2: –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã */}
                                  <div 
                    className={`w-[315px] h-[84px] border rounded-[15px] cursor-pointer transition-all ${
                      sitePopupTab === 'selective' 
                        ? 'border-[#0084FF]/60 bg-[#FFFFFF]' 
                        : 'border-[#070F1A]/10 bg-white'
                    }`}
                    onClick={() => setSitePopupTab('selective')}
                  >
                    <div className="h-full flex flex-col items-center justify-center">
                      <h3 className={`text-[16px] font-[500] mb-2 ${
                        sitePopupTab === 'selective' ? 'text-[#070F1A]' : 'text-[#8E8E93]/70'
                      }`}>
                        –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                      </h3>
                      <p className={`text-[12px] font-[400] text-center px-4 ${
                        sitePopupTab === 'selective' ? 'text-[#8E8E93]' : 'text-[#8E8E93]/70'
                      }`}>
                        –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∞–π—Ç–∞
                      </p>
                    </div>
                  </div>
              </div>

              {/* Tab Content */}
              {sitePopupTab === 'full' ? (
                <div className="space-y-[30px]">
                  <div>
                    <h3 className="text-[18px] font-[500] text-[#070F1A] mb-[20px]">–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å URL-–∞–¥—Ä–µ—Å</h3>
                  <div className={`w-[650px] h-[34px] bg-white border rounded-[10px] flex items-center px-3 ${
                      siteUrlError ? 'border-red-500' : 'border-[#070F1A]/10'
                    }`} style={INPUT_STYLES.inputField}>
                      <input
                        type="url"
                        value={siteUrl}
                        onChange={(e) => handleSiteUrlChange(e.target.value)}
                        placeholder="https://mypage.com"
                        className="flex-1 bg-transparent text-[13px] font-[500] text-[#070F1A] placeholder-[#070F1A]/30 outline-none"
                      />
                    </div>
                    {siteUrlError && (
                      <p className="text-red-500 text-[12px] mt-1">{siteUrlError}</p>
                    )}
                  </div>
                </div>
              ) : (
                <div className="space-y-[30px]">
                  <div>
                    <h3 className="text-[18px] font-[500] text-[#070F1A] mb-[20px]">–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å URL-–∞–¥—Ä–µ—Å–∞ —Å—Ç—Ä–∞–Ω–∏—Ü</h3>
                    
                                          {selectedPages.map((page, index) => (
                        <div key={index} className="flex items-center gap-2 mb-2">
                          <div className={`w-[650px] h-[40px] bg-white border rounded-[10px] flex items-center px-3 ${
                            selectedPagesErrors[index] ? 'border-red-500' : 'border-[#070F1A]/10'
                          }`} style={INPUT_STYLES.inputField}>
                            <input
                              type="url"
                              value={page}
                              onChange={(e) => handlePageChange(index, e.target.value)}
                              placeholder="https://mypage.com"
                              className="flex-1 bg-transparent text-[13px] font-[500] text-[#070F1A] placeholder-[#070F1A]/30 outline-none"
                            />
                          </div>
                          {selectedPages.length > 1 && (
                            <button
                              onClick={() => handleRemovePage(index)}
                              className="w-8 h-8 flex items-center justify-center text-red-500 hover:bg-red-50 rounded-[8px] transition-colors"
                            >
                              <img src="/traash.svg" alt="–£–¥–∞–ª–∏—Ç—å" className="w-4 h-4" />
                            </button>
                          )}
                          {selectedPagesErrors[index] && (
                            <p className="text-red-500 text-[12px] mt-1">{selectedPagesErrors[index]}</p>
                          )}
                        </div>
                      ))}
                    
                    <button
                      onClick={handleAddPage}
                      className="h-[34px] px-4 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0084FF]/80 transition-colors text-[13px] font-[500]"
                      style={BUTTON_STYLES.blueButton}
                    >
                      –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    </button>
                  </div>
                </div>
              )}

              {/* Footer */}
              <div className="mt-[10px]">
                <p className="text-[10px] text-[#8E8E93] mb-[30px]">
                  –≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏ –±—É–¥–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.
                </p>
                <div className="flex justify-center">
                                      <button
                      onClick={handleSiteImport}
                      disabled={
                        (sitePopupTab === 'full' && (siteUrlError || !siteUrl.trim())) ||
                        (sitePopupTab === 'selective' && (selectedPagesErrors.some(err => err) || selectedPages.filter(p => p.trim()).length === 0))
                      }
                    className="w-[650px] h-[34px] bg-[#0084FF] text-white font-[500] text-[13px] rounded-[10px] hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                    style={BUTTON_STYLES.blueButton}
                    >
                      –ù–∞—á–∞—Ç—å –∏–º–ø–æ—Ä—Ç
                    </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Feed Import Popup */}
      {showFeedPopup && (
        <div className="fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-50" onClick={handleFeedPopupClose}>
          <div className="bg-white rounded-[20px] w-[700px] p-[20px]" onClick={(e)=>e.stopPropagation()}>
            {/* Header */}
            <div className="flex justify-between items-start mb-[12px]">
              <h2 className="text-[20px] font-[500] text-[#070F1A]">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–æ–≤–∞—Ä–Ω—ã–π —Ñ–∏–¥</h2>
              <button
                onClick={handleFeedPopupClose}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <X className="w-5 h-5 text-gray-500" />
              </button>
            </div>

            {/* Description */}
            <p className="text-[#8E8E93] text-[14px] mb-[30px]">
              –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä–Ω—ã–π —Ñ–∏–¥ (CSV/XML) –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∫–∞—Ç–∞–ª–æ–≥–∞
            </p>

            {/* Content */}
            <div className="space-y-[30px]">
              <div>
                <div className={`w-[650px] h-[34px] bg-white border rounded-[10px] flex items-center px-3 ${
                  feedUrlError ? 'border-red-500' : 'border-[#070F1A]/10'
                }`} style={INPUT_STYLES.inputField}>
                  <input
                    type="url"
                    value={feedUrl}
                    onChange={(e) => handleFeedUrlChange(e.target.value)}
                    placeholder="https://example.com/feed.xml –∏–ª–∏ https://example.com/products.csv"
                    className="flex-1 bg-transparent text-[13px] font-[500] text-[#070F1A] placeholder-[#070F1A]/30 outline-none"
                  />
                </div>
                {feedUrlError && (
                  <p className="text-red-500 text-[12px] mt-1">{feedUrlError}</p>
                )}
              </div>
            </div>

            {/* Footer */}
              <div className="mt-[10px]">
              <p className="text-[10px] text-[#8E8E93] mb-[30px]">
                –≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏ –±—É–¥–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.
              </p>
              <div className="flex justify-center">
                <button
                  onClick={handleFeedImport}
                  disabled={feedUrlError || !feedUrl.trim()}
                  className="w-[650px] h-[34px] bg-[#0084FF] text-white font-[500] text-[13px] rounded-[10px] hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                  style={BUTTON_STYLES.blueButton}
                >
                  –ù–∞—á–∞—Ç—å –∏–º–ø–æ—Ä—Ç
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* File Import Popup */}
      {showFilePopup && (
        <div className="fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-50" onClick={handleFilePopupClose}>
          <div className="bg-white rounded-[20px] w-[700px] p-[20px]" onClick={(e)=>e.stopPropagation()}>
            {/* Header */}
            <div className="flex justify-between items-start mb-[12px]">
              <h2 className="text-[20px] font-[500] text-[#070F1A]">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞</h2>
              <button
                onClick={handleFilePopupClose}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <X className="w-5 h-5 text-gray-500" />
              </button>
            </div>

            {/* Description */}
            <p className="text-[#8E8E93] text-[14px] mb-[30px]">
              –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∞: .docx, .doc, .pdf, .txt, .xls, .xlsx, .csv, .xml
            </p>

            {/* File Upload Area */}
            <div className="space-y-[30px]">
              <div className="border-2 border-dashed border-[#070F1A]/10 rounded-[10px] p-8 text-center">
                <input
                  type="file"
                  multiple
                  accept=".docx,.doc,.pdf,.txt,.xls,.xlsx,.csv,.xml"
                  onChange={handleFileSelect}
                  className="hidden"
                  id="file-upload"
                />
                <label htmlFor="file-upload" className="cursor-pointer">
                  <div className="space-y-4">
                    <div className="mx-auto w-12 h-12 bg-gray-100 rounded-[90px] flex items-center justify-center">
                      <Upload className="w-6 h-6 text-gray-400" />
                    </div>
                    <div>
                      <p className="text-[16px] font-[500] text-[#070F1A]">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</p>
                      <p className="text-[12px] text-[#8E8E93] mt-1">–ú–∞–∫—Å–∏–º—É–º: 3 —Ñ–∞–π–ª–∞, 100 –º–µ–≥–∞–±–∞–π—Ç –∑–∞ –æ–¥–Ω—É –æ—Ç–ø—Ä–∞–≤–∫—É.</p>
                    </div>
                  </div>
                </label>
              </div>

              {/* Selected Files */}
              {selectedFiles.length > 0 && (
                <div className="space-y-4">
                  <div className="space-y-2">
                    {selectedFiles.map((file, index) => (
                      <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-[10px]">
                        <div className="flex items-center gap-3">
                          <FileIcon className="w-5 h-5 text-blue-500" />
                          <span className="text-sm text-gray-700">{file.name}</span>
                        </div>
                        <button
                          onClick={() => handleRemoveFile(index)}
                          className="text-red-500 hover:text-red-700"
                        >
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>
                  
                  {/* Upload Button */}
                  <div className="flex justify-end">
                    <button
                      onClick={handleFileUpload}
                      className="px-6 py-2 bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors font-[500] text-[13px] flex items-center gap-2"
                      style={BUTTON_STYLES.blueButton}
                    >
                      <Upload className="w-4 h-4" />
                      –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Text Import Popup */}
      {showTextPopup && (
        <div className="fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-50" onClick={handleTextPopupClose}>
          <div className="bg-white rounded-[20px] w-[700px] p-[20px]" onClick={(e)=>e.stopPropagation()}>
            {/* Header */}
            <div className="flex justify-between items-start mb-[12px]">
              <h2 className="text-[20px] font-[500] text-[#070F1A]">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</h2>
              <button
                onClick={handleTextPopupClose}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ color: '#8E8E93' }}>
                  <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"></path>
                </svg>
              </button>
            </div>

            {/* Description */}
            <p className="text-[#8E8E93] text-[14px] mb-[30px]">
              –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –ò–ò-–∞–≥–µ–Ω—Ç –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
            </p>

            {/* Text Input */}
            <div className="space-y-[20px]">
              <div>
                <textarea
                  value={textContent}
                  onChange={(e) => handleTextContentChange(e.target.value)}
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, —É—Å–ª—É–≥–∞—Ö, —Ü–µ–Ω–∞—Ö, —É—Å–ª–æ–≤–∏—è—Ö —Ä–∞–±–æ—Ç—ã –∏ —Ç.–¥."
                  className={`w-full h-[200px] p-4 border rounded-[10px] text-[13px] resize-none ${
                    textContentError ? 'border-red-500' : 'border-[#070F1A]/10 focus:outline-none'
                  }`}
                  style={INPUT_STYLES.inputField}
                />
                {textContentError && (
                  <p className="text-red-500 text-[12px] mt-2">{textContentError}</p>
                )}
              </div>
            </div>

            {/* Button */}
            <div className="mt-[20px]">
              <button
                onClick={async () => {
                  if (!textContent.trim()) {
                    setTextContentError('–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
                    return;
                  }
                  
                  const newItem = {
                    type: 'text',
                    content: textContent.trim(),
                    status: '–ó–∞–≥—Ä—É–∂–µ–Ω–æ'
                  };
                  
                  await handleAddKnowledgeItem(newItem);
                  handleTextPopupClose();
                }}
                disabled={(textContent || '').trim().length < 50}
                className="w-full h-[34px] text-[13px] font-[500] text-white bg-[#0084FF] rounded-[10px] hover:bg-[#0073E6] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                style={BUTTON_STYLES.blueButton}
              >
                –î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Knowledge Details Popup */}
      {showKnowledgeDetailsPopup && selectedKnowledgeDetails && (
        <div className="fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-50" onClick={() => setShowKnowledgeDetailsPopup(false)}>
          <div className="bg-white rounded-[20px] w-[800px] max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex justify-between items-start mb-[20px] p-[20px] border-b border-[#070F1A]/10">
              <div>
                <h2 className="text-[20px] font-[500] text-[#070F1A] mb-2">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞</h2>
                <div className="flex items-center gap-2">
                  <div className="h-[24px] px-2 rounded-[7px] bg-gray-100 flex items-center gap-[2px]">
                    <img 
                      src={
                        (selectedKnowledgeDetails.source_type || selectedKnowledgeDetails.type) === 'site' ? '/global2.svg' :
                        (selectedKnowledgeDetails.source_type || selectedKnowledgeDetails.type) === 'feed' ? '/document-code.svg' :
                        (selectedKnowledgeDetails.source_type || selectedKnowledgeDetails.type) === 'text' ? '/edit-2.svg' :
                        '/document-copy.svg'
                      }
                      alt={selectedKnowledgeDetails.type}
                      className="w-[10px] h-[10px]"
                    />
                    <span className="text-[12px] font-[400] text-[#070F1A]">
                      {(selectedKnowledgeDetails.source_type || selectedKnowledgeDetails.type) === 'site' && '–°–∞–π—Ç'}
                      {(selectedKnowledgeDetails.source_type || selectedKnowledgeDetails.type) === 'feed' && '–¢–æ–≤–∞—Ä–Ω—ã–π —Ñ–∏–¥'}
                      {(selectedKnowledgeDetails.source_type || selectedKnowledgeDetails.type) === 'text' && '–¢–µ–∫—Å—Ç'}
                      {(selectedKnowledgeDetails.source_type || selectedKnowledgeDetails.type) === 'file' && '–§–∞–π–ª'}
                      {(selectedKnowledgeDetails.source_type || selectedKnowledgeDetails.type) === 'website' && '–°–∞–π—Ç'}
                    </span>
                  </div>
                  <div className={`h-[24px] px-3 rounded-[50px] flex items-center gap-2 ${
                    selectedKnowledgeDetails.status === '–ó–∞–≥—Ä—É–∂–µ–Ω–æ' ? 'bg-[#36C76A]/15 text-[#36C76A]' :
                    selectedKnowledgeDetails.status === '–û–±—Ä–∞–±–æ—Ç–∫–∞' ? 'bg-[#0084FF]/15 text-[#0084FF]' :
                    selectedKnowledgeDetails.status === '–û—à–∏–±–∫–∞' ? 'bg-[#FF3B30]/15 text-[#FF3B30]' :
                    'bg-[#0084FF]/15 text-[#0084FF]'
                  }`}>
                    <span className="text-[12px] font-[400]">
                      {selectedKnowledgeDetails.status || '–û–±—Ä–∞–±–æ—Ç–∫–∞...'}
                    </span>
                  </div>
                </div>
              </div>
              <button
                onClick={() => setShowKnowledgeDetailsPopup(false)}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <X className="w-5 h-5 text-gray-500" />
              </button>
            </div>

            {/* Content */}
            <div className="p-[20px] space-y-6">
              {/* Title */}
              {selectedKnowledgeDetails.title && (
                <div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</h3>
                  <p className="text-[14px] text-[#070F1A] bg-gray-50 p-3 rounded-[10px]">
                    {selectedKnowledgeDetails.title}
                  </p>
                </div>
              )}

              {/* URL */}
              {selectedKnowledgeDetails.source_url && (
                <div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-2">URL</h3>
                  <p className="text-[14px] text-[#0084FF] bg-gray-50 p-3 rounded-[10px] break-all">
                    <a href={selectedKnowledgeDetails.source_url} target="_blank" rel="noopener noreferrer" className="hover:underline">
                      {selectedKnowledgeDetails.source_url}
                    </a>
                  </p>
                </div>
              )}

              {/* Original Content */}
              {selectedKnowledgeDetails.original_content && (
                <div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-2">–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</h3>
                  <div className="bg-gray-50 p-4 rounded-[10px] max-h-[300px] overflow-y-auto">
                    <pre className="text-[13px] text-[#070F1A] whitespace-pre-wrap font-sans">
                      {selectedKnowledgeDetails.original_content}
                    </pre>
                  </div>
                </div>
              )}

              {/* Processed Content */}
              {selectedKnowledgeDetails.processed_content && selectedKnowledgeDetails.processed_content !== selectedKnowledgeDetails.original_content && (
                <div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-2">–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</h3>
                  <div className="bg-blue-50 p-4 rounded-[10px] max-h-[300px] overflow-y-auto">
                    <pre className="text-[13px] text-[#070F1A] whitespace-pre-wrap font-sans">
                      {selectedKnowledgeDetails.processed_content}
                    </pre>
                  </div>
                </div>
              )}

              {/* Structured Data */}
              {selectedKnowledgeDetails.structured_data && Object.keys(selectedKnowledgeDetails.structured_data).length > 0 && (
                <div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-2">–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                  <div className="bg-green-50 p-4 rounded-[10px] max-h-[300px] overflow-y-auto">
                    <pre className="text-[13px] text-[#070F1A] whitespace-pre-wrap">
                      {JSON.stringify(selectedKnowledgeDetails.structured_data, null, 2)}
                    </pre>
                  </div>
                </div>
              )}

              {/* Chunks */}
              {selectedKnowledgeDetails.chunks && selectedKnowledgeDetails.chunks.length > 0 && (
                <div>
                  <h3 className="text-[16px] font-[500] text-[#070F1A] mb-2">
                    –°–æ–∑–¥–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ ({selectedKnowledgeDetails.chunks.length})
                  </h3>
                  <div className="space-y-3 max-h-[400px] overflow-y-auto">
                    {selectedKnowledgeDetails.chunks.map((chunk, index) => (
                      <div key={index} className="bg-yellow-50 p-3 rounded-[10px] border border-yellow-200">
                        <div className="flex justify-between items-start mb-2">
                          <span className="text-[12px] font-[500] text-[#070F1A]">–ß–∞–Ω–∫ {index + 1}</span>
                          {chunk.tokens_estimate && (
                            <span className="text-[12px] text-[#8E8E93]">{chunk.tokens_estimate} —Ç–æ–∫–µ–Ω–æ–≤</span>
                          )}
                        </div>
                        <p className="text-[13px] text-[#070F1A] mb-2">
                          {chunk.chunk_text?.substring(0, 200)}
                          {chunk.chunk_text?.length > 200 && '...'}
                        </p>
                        {chunk.chunk_summary && (
                          <p className="text-[12px] text-[#8E8E93] italic">
                            –†–µ–∑—é–º–µ: {chunk.chunk_summary}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Metadata */}
              <div className="grid grid-cols-2 gap-4">
                {selectedKnowledgeDetails.created_at && (
                  <div>
                    <h3 className="text-[16px] font-[500] text-[#070F1A] mb-2">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</h3>
                    <p className="text-[14px] text-[#8E8E93]">
                      {new Date(selectedKnowledgeDetails.created_at).toLocaleString('ru-RU')}
                    </p>
                  </div>
                )}
                {selectedKnowledgeDetails.updated_at && (
                  <div>
                    <h3 className="text-[16px] font-[500] text-[#070F1A] mb-2">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</h3>
                    <p className="text-[14px] text-[#8E8E93]">
                      {new Date(selectedKnowledgeDetails.updated_at).toLocaleString('ru-RU')}
                    </p>
                  </div>
                )}
              </div>
            </div>

            {/* Footer */}
            <div className="p-[20px] border-t border-[#070F1A]/10">
              <div className="flex justify-end">
                <button
                  onClick={() => setShowKnowledgeDetailsPopup(false)}
                  className="h-[34px] px-6 text-[13px] font-[500] text-[#070F1A] bg-gray-100 rounded-[10px] hover:bg-gray-200 transition-colors"
                >
                  –ó–∞–∫—Ä—ã—Ç—å
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∫–ª–∏–µ–Ω—Ç–∞ */}
      {clientSidebarOpen && selectedClient && (
        <>
          <div 
            className="fixed inset-0 bg-black bg-opacity-50 z-[9998]"
            style={{ marginTop: 0 }}
            onClick={() => setClientSidebarOpen(false)}
          />
          <div className="fixed right-0 top-0 h-full w-[500px] bg-white shadow-2xl z-[9999] transform transition-transform duration-300 ease-in-out" style={{ borderTopLeftRadius: '20px', borderBottomLeftRadius: '20px', marginTop: 0 }}>
            <div className="h-full flex flex-col">
              {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏ */}
              <div className="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
                <h2 className="text-[18px] font-[500] text-[#070F1A]">–î–µ—Ç–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞</h2>
                <button 
                  onClick={() => setClientSidebarOpen(false)}
                  className="w-8 h-8 rounded-[90px] bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ color: '#8E8E93' }}>
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"></path>
                  </svg>
                </button>
              </div>
              
              {/* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–∞–Ω–µ–ª–∏ */}
              <div className="flex-1 overflow-y-auto p-6 space-y-6">
                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ */}
                <div>
                  <h4 className="text-[16px] font-[500] text-[#070F1A] mb-3">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                  <div className="space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="text-[14px] font-[500] text-[#070F1A]">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                      <span className="text-[12px] text-[#070F1A]">{selectedClient.phone}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-[14px] font-[500] text-[#070F1A]">Email:</span>
                      <span className="text-[12px] text-[#0084FF]">{selectedClient.email}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-[14px] font-[500] text-[#070F1A]">–ö–æ–º–ø–∞–Ω–∏—è:</span>
                      <span className="text-[12px] text-[#070F1A]">{selectedClient.company}</span>
                    </div>
                  </div>
                </div>

                {/* –î–µ–π—Å—Ç–≤–∏—è */}
                <div className="space-y-3">
                  <button 
                    onClick={() => setCreateTaskModalOpen(true)}
                    className="w-full h-[34px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors flex items-center justify-center"
                    style={BUTTON_STYLES.blueButton}
                  >
                    –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                  </button>
                  <button 
                    className="w-full h-[34px] text-[#070F1A] rounded-[10px] hover:bg-gray-50 transition-colors flex items-center justify-center"
                    style={BUTTON_STYLES.whiteButton}
                  >
                    –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏–∞–ª–æ–≥
                  </button>
                  <button 
                    onClick={() => handleDeleteClient(selectedClient.phone)}
                    className="w-full h-[34px] bg-red-50 border border-red-100 text-red-500 rounded-[10px] text-[14px] font-[500] hover:bg-red-100 transition-colors flex items-center justify-center"
                  >
                    –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                  </button>
                </div>
              </div>
            </div>
          </div>
        </>
      )}

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ */}
      {createDealModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-10 z-[9998]" style={{ marginTop: 0 }} onClick={() => setCreateDealModalOpen(false)}>
          <div className="fixed right-0 top-0 h-full w-[500px] bg-white shadow-2xl z-[9999] transform transition-transform duration-300 ease-in-out" style={{ borderTopLeftRadius: '16px', borderBottomLeftRadius: '16px', marginTop: 0 }} onClick={(e) => e.stopPropagation()}>
            <div className="h-full flex flex-col">
              {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
              <div className="flex items-center justify-between p-5 border-b border-[#E5E7EB]">
                <h2 className="text-[18px] font-[500] text-[#070F1A]">–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</h2>
                <button onClick={() => setCreateDealModalOpen(false)} className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ color: '#8E8E93' }}>
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"></path>
                  </svg>
                </button>
              </div>
              
              {/* –§–æ—Ä–º–∞ */}
              <div className="flex-1 overflow-y-auto p-5 space-y-4">
                {/* –ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ */}
                <div>
                  <label className="block text-[13px] font-[500] text-[#070F1A] mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏</label>
                  <input
                    type="text"
                    value={newDeal.title}
                    onChange={(e) => setNewDeal(prev => ({ ...prev, title: e.target.value }))}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏"
                    className="w-full h-[34px] px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none placeholder-[#8E8E93]"
                  />
                </div>

                {/* –°—Ç–∞–¥–∏—è (–∫–∞—Å—Ç–æ–º) */}
                <div className="relative">
                  <label className="block text-[13px] font-[500] text-[#070F1A] mb-2">–°—Ç–∞–¥–∏—è</label>
                  <button
                    onClick={() => setCrmDropdowns(prev => ({...prev, dealStage: !prev.dealStage}))}
                    className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20 flex items-center justify-between"
                  >
                    <span>{newDeal.stage || '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–¥–∏—é'}</span>
                    <img src="/Bounds.svg" alt="–†–∞—Å–∫—Ä—ã—Ç—å" className="w-[9px] h-[9px] transition-transform duration-300" style={{ transform: (crmDropdowns?.dealStage ? 'rotate(-90deg)' : 'rotate(90deg)'), filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }} />
                  </button>
                  {crmDropdowns?.dealStage && (
                    <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-[#070F1A]/10 rounded-[10px] shadow-lg z-50">
                      <div className="p-[2px]">
                        {['–ù–æ–≤—ã–µ','–í —Ä–∞–±–æ—Ç–µ','–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ','–ó–∞–∫—Ä—ã—Ç—ã–µ'].map(opt => {
                          const isSelected = newDeal.stage === opt;
                          return (
                            <div
                              key={opt}
                            className={`flex items-center gap-2 p-2 rounded-[10px] cursor-pointer h-[32px] ${isSelected ? 'bg-[#F2F3F4]' : 'hover:bg-[#F2F3F4]'}`}
                              onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setNewDeal(prev => ({...prev, stage: opt})); setCrmDropdowns(prev => ({...prev, dealStage:false})); }}
                            >
                              {isSelected && (
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                  <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                                </svg>
                              )}
                              <span className="text-[13px] text-[#070F1A]">{opt}</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>

                {/* –ö–∞—á–µ—Å—Ç–≤–æ –ª–∏–¥–∞ (–∫–∞—Å—Ç–æ–º) */}
                <div className="relative">
                  <label className="block text-[13px] font-[500] text-[#070F1A] mb-2">–ö–∞—á–µ—Å—Ç–≤–æ –ª–∏–¥–∞</label>
                  <button
                    onClick={() => setCrmDropdowns(prev => ({...prev, leadQualityDeal: !prev.leadQualityDeal}))}
                    className="w-full h-[34px] px-3 border border-[#070F1A]/10 rounded-[10px] text-[14px] text-[#070F1A] focus:outline-none focus:ring-2 focus:ring-[#0084FF]/20 flex items-center justify-between"
                  >
                    <span>{newDeal.leadQuality === 'hot' ? '–ì–æ—Ä—è—á–∏–π' : newDeal.leadQuality === 'warm' ? '–¢–µ–ø–ª—ã–π' : newDeal.leadQuality === 'cold' ? '–•–æ–ª–æ–¥–Ω—ã–π' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ'}</span>
                    <img src="/Bounds.svg" alt="–†–∞—Å–∫—Ä—ã—Ç—å" className="w-[9px] h-[9px] transition-transform duration-300" style={{ transform: (crmDropdowns?.leadQualityDeal ? 'rotate(-90deg)' : 'rotate(90deg)'), filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }} />
                  </button>
                  {crmDropdowns?.leadQualityDeal && (
                    <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-[#070F1A]/10 rounded-[10px] shadow-lg z-50">
                      <div className="p-[2px]">
                        {[
                          {key:'hot', label:'–ì–æ—Ä—è—á–∏–π'},
                          {key:'warm', label:'–¢–µ–ø–ª—ã–π'},
                          {key:'cold', label:'–•–æ–ª–æ–¥–Ω—ã–π'}
                        ].map(opt => {
                          const isSelected = newDeal.leadQuality === opt.key;
                          return (
                            <div
                              key={opt.key}
                            className={`flex items-center gap-2 p-2 rounded-[10px] cursor-pointer h-[32px] ${isSelected ? 'bg-[#F2F3F4]' : 'hover:bg-[#F2F3F4]'}`}
                              onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setNewDeal(prev => ({...prev, leadQuality: opt.key})); setCrmDropdowns(prev => ({...prev, leadQualityDeal:false})); }}
                            >
                              {isSelected && (
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" className="w-3 h-3">
                                  <path d="M 1.5 6 L 4.5 9 L 10.5 3" fill="transparent" strokeWidth="1.5" stroke="currentColor" strokeLinecap="round" strokeMiterlimit="10" strokeDasharray=""></path>
                                </svg>
                              )}
                              <span className="text-[13px] text-[#070F1A]">{opt.label}</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>

                {/* –°—É–º–º–∞ */}
                <div>
                  <label className="block text-[13px] font-[500] text-[#070F1A] mb-2">–°—É–º–º–∞ (‚ÇΩ)</label>
                  <input
                    type="number"
                    value={newDeal.amount}
                    onChange={(e) => setNewDeal(prev => ({ ...prev, amount: e.target.value }))}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                    className="w-full h-[34px] px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none placeholder-[#8E8E93]"
                  />
                </div>

                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ */}
                <div>
                  <h4 className="text-[13px] font-[500] text-[#070F1A] mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h4>
                  <div className="space-y-3">
                    <input
                      type="text"
                      value={newDeal.client.name}
                      onChange={(e) => setNewDeal(prev => ({ ...prev, client: { ...prev.client, name: e.target.value } }))}
                      placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞"
                      className="w-full h-[34px] px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none placeholder-[#8E8E93]"
                    />
                    <input
                      type="email"
                      value={newDeal.client.email}
                      onChange={(e) => setNewDeal(prev => ({ ...prev, client: { ...prev.client, email: e.target.value } }))}
                      placeholder="Email –∫–ª–∏–µ–Ω—Ç–∞"
                      className="w-full h-[34px] px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none placeholder-[#8E8E93]"
                    />
                    <input
                      type="tel"
                      value={newDeal.client.phone}
                      onChange={(e) => {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length > 0) {
                          if (value.length <= 1) {
                            value = '+7 (' + value;
                          } else if (value.length <= 4) {
                            value = '+7 (' + value.slice(1);
                          } else if (value.length <= 7) {
                            value = '+7 (' + value.slice(1, 4) + ') ' + value.slice(4);
                          } else if (value.length <= 9) {
                            value = '+7 (' + value.slice(1, 4) + ') ' + value.slice(4, 7) + '-' + value.slice(7);
                          } else if (value.length <= 11) {
                            value = '+7 (' + value.slice(1, 4) + ') ' + value.slice(4, 7) + '-' + value.slice(7, 9) + '-' + value.slice(9);
                          } else {
                            value = '+7 (' + value.slice(1, 4) + ') ' + value.slice(4, 7) + '-' + value.slice(7, 9) + '-' + value.slice(9, 11);
                          }
                        }
                        setNewDeal(prev => ({ ...prev, client: { ...prev.client, phone: value } }));
                      }}
                      placeholder="+7 (___) ___-__-__"
                      className="w-full h-[34px] px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none placeholder-[#8E8E93]"
                    />
                    <input
                      type="text"
                      value={newDeal.client.address || ''}
                      onChange={(e) => setNewDeal(prev => ({ ...prev, client: { ...prev.client, address: e.target.value } }))}
                      placeholder="–ê–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞"
                      className="w-full h-[34px] px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none placeholder-[#8E8E93]"
                    />
                    <input
                      type="text"
                      value={newDeal.client.company}
                      onChange={(e) => setNewDeal(prev => ({ ...prev, client: { ...prev.client, company: e.target.value } }))}
                      placeholder="–ö–æ–º–ø–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞"
                      className="w-full h-[34px] px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none placeholder-[#8E8E93]"
                    />
                  </div>
                </div>

                {/* –ó–∞–º–µ—Ç–∫–∏ */}
                <div>
                  <label className="block text-[14px] font-[500] text-[#070F1A] mb-2">–ó–∞–º–µ—Ç–∫–∏</label>
                  <textarea
                    value={newDeal.notes}
                    onChange={(e) => setNewDeal(prev => ({ ...prev, notes: e.target.value }))}
                    placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–¥–µ–ª–∫–µ"
                    rows={3}
                    className="w-full px-3 py-2 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none focus:border-[#0084FF] resize-none"
                  />
                </div>
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ */}
              <div className="p-5 border-t border-[#E5E7EB] flex flex-col gap-2">
                <button
                  onClick={() => {
                    const email = (newDeal?.client?.email || '').trim();
                    const phone = (newDeal?.client?.phone || '').trim();
                    const emailValid = email === '' || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                    const phoneDigits = phone.replace(/[^\d+]/g, '');
                    const phoneValid = phone === '' || /^\+?\d{10,15}$/.test(phoneDigits);
                    if (!emailValid) {
                      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
                      return;
                    }
                    if (!phoneValid) {
                      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω (10-15 —Ü–∏—Ñ—Ä, –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è +)');
                      return;
                    }
                    handleCreateDeal();
                  }}
                  className="w-full h-[34px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                  style={BUTTON_STYLES.blueButton}
                >
                  –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
                </button>
                <button
                  onClick={() => setCreateDealModalOpen(false)}
                  className="w-full h-[34px] text-gray-600 rounded-[10px] hover:bg-gray-200 transition-colors"
                  style={BUTTON_STYLES.whiteButton}
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ */}
      {createTaskModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-[9998]" style={{ marginTop: 0 }} onClick={() => setCreateTaskModalOpen(false)}>
          <div className="fixed right-0 top-0 h-full w-[500px] bg-white shadow-2xl z-[9999] transform transition-transform duration-300 ease-in-out" style={{ borderTopLeftRadius: '20px', borderBottomLeftRadius: '20px', marginTop: 0 }} onClick={(e) => e.stopPropagation()}>
            <div className="h-full flex flex-col">
              {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
              <div className="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
                <h2 className="text-[18px] font-[500] text-[#070F1A]">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
                <button onClick={() => setCreateTaskModalOpen(false)} className="w-8 h-8 rounded-[90px] bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ color: '#8E8E93' }}>
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"></path>
                  </svg>
                </button>
              </div>
              
              {/* –§–æ—Ä–º–∞ */}
              <div className="flex-1 overflow-y-auto p-6 space-y-4">
                {/* –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ */}
                <div>
                  <label className="block text-[14px] font-[500] text-[#070F1A] mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                  <input
                    type="text"
                    value={newTask.title}
                    onChange={(e) => setNewTask(prev => ({ ...prev, title: e.target.value }))}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"
                    className="w-full h-10 px-3 rounded-[10px] focus:outline-none"
                    style={INPUT_STYLES.inputField}
                  />
                </div>

                {/* –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ */}
                <div>
                  <label className="block text-[14px] font-[500] text-[#070F1A] mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                  <textarea
                    value={newTask.description}
                    onChange={(e) => setNewTask(prev => ({ ...prev, description: e.target.value }))}
                    placeholder="–û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏"
                    rows={3}
                    className="w-full px-3 py-2 rounded-[10px] focus:outline-none resize-none"
                    style={INPUT_STYLES.inputField}
                  />
                </div>

                {/* –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å */}
                <div>
                  <label className="block text-[14px] font-[500] text-[#070F1A] mb-2">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                  <div className="relative executor-dropdown">
                    <button
                      onClick={() => toggleExecutorDropdown('task')}
                      className="w-full h-10 px-3 rounded-[10px] flex items-center justify-between hover:border-[#0084FF] transition-colors"
                      style={INPUT_STYLES.inputField}
                    >
                      <span className="text-[#8E8E93] hover:text-[#070F1A] transition-colors">{newTask.assigneeName}</span>
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                    
                    {executorDropdowns.task && (
                      <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-[#E5E7EB] rounded-[10px] shadow-lg z-50">
                        <div className="p-2 space-y-1">
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setNewTask(prev => ({ ...prev, assignee: 'operator-1', assigneeName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' }));
                              setExecutorDropdowns(prev => ({...prev, task: false}));
                            }}
                          >
                            <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                            <span className="text-[13px] text-[#070F1A]">–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞</span>
                          </div>
                          <div 
                            className="flex items-center gap-2 p-2 hover:bg-[#F2F3F4] rounded-[10px] cursor-pointer h-[32px]"
                            onClick={() => {
                              setNewTask(prev => ({ ...prev, assignee: 'operator-2', assigneeName: '–ú–∏—Ö–∞–∏–ª –°–∏–¥–æ—Ä–æ–≤' }));
                              setExecutorDropdowns(prev => ({...prev, task: false}));
                            }}
                          >
                            <img src="/headphone.svg" alt="–û–ø–µ—Ä–∞—Ç–æ—Ä" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(66%) sepia(21%) saturate(828%) hue-rotate(230deg) brightness(95%) contrast(101%)' }} />
                            <span className="text-[13px] text-[#070F1A]">–ú–∏—Ö–∞–∏–ª –°–∏–¥–æ—Ä–æ–≤</span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç */}
                <div>
                  <label className="block text-[14px] font-[500] text-[#070F1A] mb-2">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                  <select
                    value={newTask.priority}
                    onChange={(e) => setNewTask(prev => ({ ...prev, priority: e.target.value }))}
                    className="w-full h-10 px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none focus:border-[#0084FF]"
                  >
                    <option value="low">–ù–∏–∑–∫–∏–π</option>
                    <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                    <option value="urgent">–°—Ä–æ—á–Ω—ã–π</option>
                  </select>
                </div>

                {/* –î–∞—Ç–∞ –¥–µ–¥–ª–∞–π–Ω–∞ */}
                <div>
                  <label className="block text-[14px] font-[500] text-[#070F1A] mb-2">–î–∞—Ç–∞ –¥–µ–¥–ª–∞–π–Ω–∞</label>
                  <input
                    type="date"
                    value={newTask.dueDate}
                    onChange={(e) => setNewTask(prev => ({ ...prev, dueDate: e.target.value }))}
                    className="w-full h-10 px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none focus:border-[#0084FF]"
                  />
                </div>

                {/* ID —Å–¥–µ–ª–∫–∏ */}
                <div>
                  <label className="block text-[14px] font-[500] text-[#070F1A] mb-2">ID —Å–¥–µ–ª–∫–∏</label>
                  <input
                    type="text"
                    value={newTask.dealId}
                    onChange={(e) => setNewTask(prev => ({ ...prev, dealId: e.target.value }))}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å–¥–µ–ª–∫–∏"
                    className="w-full h-10 px-3 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none focus:border-[#0084FF]"
                  />
                </div>

                {/* –ó–∞–º–µ—Ç–∫–∏ */}
                <div>
                  <label className="block text-[14px] font-[500] text-[#070F1A] mb-2">–ó–∞–º–µ—Ç–∫–∏</label>
                  <textarea
                    value={newTask.notes}
                    onChange={(e) => setNewTask(prev => ({ ...prev, notes: e.target.value }))}
                    placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ"
                    rows={3}
                    className="w-full px-3 py-2 border border-[#E5E7EB] rounded-[10px] text-[14px] focus:outline-none focus:border-[#0084FF] resize-none"
                  />
                </div>
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ */}
              <div className="p-6 border-t border-[#E5E7EB] flex gap-3">
                <button
                  onClick={() => setCreateTaskModalOpen(false)}
                  className="flex-1 h-[34px] text-gray-600 rounded-[10px] hover:bg-gray-200 transition-colors"
                  style={BUTTON_STYLES.whiteButton}
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
                <button
                  onClick={handleCreateTask}
                  className="flex-1 h-[34px] bg-[#0084FF] text-white rounded-[10px] hover:bg-[#0073E6] transition-colors"
                  style={BUTTON_STYLES.blueButton}
                >
                  –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Tooltip for metric info */}
      {hoveredMetricId && (
        <div
          className="fixed z-50 bg-white text-gray-900 text-sm px-4 py-3 rounded-[15px] shadow-lg border border-gray-200 pointer-events-none max-w-[300px]"
          style={{
            left: tooltipPosition.x,
            top: tooltipPosition.y,
            transform: 'translateX(-50%)'
          }}
        >
          <div className="text-[12px] text-gray-600 mb-2 font-[500]">
            {metricsData[hoveredMetricId]?.description || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ç—Ä–∏–∫–µ'}
          </div>
          <div className="bg-gray-100 px-3 py-2 rounded text-[12px] font-mono">
            {metricsData[hoveredMetricId]?.formula || '–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞'}
          </div>
        </div>
      )}

      {/* –ü–æ–ø–∞–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ */}
      {showCloseDialogPopup && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-[16px] p-5 w-[400px]">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-[18px] font-[500] text-[#070F1A]">–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥</h2>
              <button 
                onClick={() => setShowCloseDialogPopup(false)}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 text-gray-500">
                  <path d="M18 6 6 18"></path>
                  <path d="m6 6 12 12"></path>
                </svg>
              </button>
            </div>

            <div className="mb-6">
              <p className="text-[14px] text-[#8E8E93] leading-relaxed">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥?<br />
                –î–∏–∞–ª–æ–≥ –±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π.
              </p>
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => setShowCloseDialogPopup(false)}
                className="flex-1 h-[34px] text-[#070F1A] rounded-[12px] transition-colors hover:border-[#070F1A]/20"
                style={BUTTON_STYLES.whiteButton}
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleConfirmCloseDialog}
                className="flex-1 h-[34px] bg-[#0084FF] text-white rounded-[12px] transition-colors hover:bg-[#0066CC]"
                style={BUTTON_STYLES.blueButton}
              >
                –ó–∞–≤–µ—Ä—à–∏—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}

      {/* –ü–æ–ø–∞–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ */}
      {showDeleteDialogPopup && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-[16px] p-5 w-[400px]">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-[18px] font-[500] text-[#070F1A]">–£–¥–∞–ª–∏—Ç—å –¥–∏–∞–ª–æ–≥</h2>
              <button 
                onClick={() => setShowDeleteDialogPopup(false)}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 text-gray-500">
                  <path d="M18 6 6 18"></path>
                  <path d="m6 6 12 12"></path>
                </svg>
              </button>
            </div>

            <div className="mb-6">
              <p className="text-[14px] text-[#8E8E93] leading-relaxed">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–∏–∞–ª–æ–≥?<br />
                –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
              </p>
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => setShowDeleteDialogPopup(false)}
                className="flex-1 h-[34px] border border-[#070F1A]/10 text-[#070F1A] rounded-[12px] transition-colors hover:border-[#070F1A]/20 text-[14px] font-[500]"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleConfirmDeleteDialog}
                className="flex-1 h-[34px] bg-[#EF4444] text-white rounded-[12px] transition-colors hover:bg-[#DC2626] text-[14px] font-[500]"
              >
                –£–¥–∞–ª–∏—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}

      {/* –ü–æ–ø–∞–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ */}
      {showDeleteConfirmModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-[16px] p-5 w-[400px]">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-[18px] font-[500] text-[#070F1A]">–£–¥–∞–ª–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</h2>
              <button 
                onClick={() => setShowDeleteConfirmModal(false)}
                className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-[7px] transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 text-gray-500">
                  <path d="M18 6 6 18"></path>
                  <path d="m6 6 12 12"></path>
                </svg>
              </button>
            </div>

            <div className="mb-6">
              <p className="text-[14px] text-[#8E8E93] leading-relaxed">
                –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏?<br />
                –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
              </p>
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => setShowDeleteConfirmModal(false)}
                className="flex-1 h-[34px] border border-[#070F1A]/10 text-[#070F1A] rounded-[12px] transition-colors hover:border-[#070F1A]/20 text-[14px] font-[500]"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleDeleteCorrections}
                className="flex-1 h-[34px] bg-[#EF4444] text-white rounded-[12px] transition-colors hover:bg-[#DC2626] text-[14px] font-[500]"
              >
                –£–¥–∞–ª–∏—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Å–∫—Ä–∏–ø—Ç–æ–º –≤–∏–¥–∂–µ—Ç–∞ */}
      {showScriptModal && (
        <div className="fixed inset-0 bg-black/20 flex items-center justify-center z-50">
          <div className="bg-white rounded-[16px] p-6 w-[600px] max-h-[80vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-[10px]">
              <h3 className="text-[18px] font-[500] text-[#070F1A]">–°–∫—Ä–∏–ø—Ç –≤–∞—à–µ–≥–æ –≤–∏–¥–∂–µ—Ç–∞</h3>
              <button
                onClick={() => setShowScriptModal(false)}
                className="w-[32px] h-[32px] flex items-center justify-center hover:bg-[#F2F3F4] rounded-[8px] transition-colors"
              >
                <img src="/x-02.svg" alt="–ó–∞–∫—Ä—ã—Ç—å" className="w-4 h-4" style={{ filter: 'brightness(0) saturate(100%) invert(56%) sepia(6%) saturate(14%) hue-rotate(200deg) brightness(95%) contrast(89%)' }} />
              </button>
            </div>
            
            <div className="mb-[20px]">
              <p className="text-[14px] text-[#8E8E93] mb-[20px]">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –Ω–∞ –≤–∞—à —Å–∞–π—Ç:</p>
              <div className="bg-[#F8F8FA] rounded-[10px] p-4 border border-[#E5E6E7]">
                <pre className="text-[12px] text-[#070F1A] whitespace-pre-wrap font-mono">
                  {generateWidgetCode()}
                </pre>
              </div>
            </div>
            
            <div className="flex gap-3">
              <button
                onClick={async () => {
                  try {
                    await navigator.clipboard.writeText(generateWidgetCode());
                    showNotificationMessage('–°–∫—Ä–∏–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                  } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);
                  }
                }}
                className="flex-1 h-[34px] bg-[#0084FF] text-white rounded-[10px] font-[500] text-[13px] hover:bg-[#0073E6] transition-colors"
                style={BUTTON_STYLES.blueButton}
              >
                –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
              </button>
              <button
                onClick={() => {
                  const userKey = widgetApiKey || (currentUser?.id ? `adapto_${currentUser.id}` : 'adapto_demo');
                  const url = `${API_CONFIG.BASE_URL}/widget-preview.html?key=${userKey}&noCache=1&ts=${Date.now()}`;
                  window.open(url, '_blank', 'noopener,noreferrer');
                }}
                className="flex-1 h-[34px] bg-white text-[#070F1A] border border-[#E5E6E7] rounded-[10px] font-[500] text-[13px] hover:bg-[#F2F3F4] transition-colors"
                style={BUTTON_STYLES.whiteButton}
              >
                –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Telegram Bot Modal */}
      {showTelegramModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowTelegramModal(false)} />
          <div className="relative bg-white rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-gray-200">
              <div className="flex items-center gap-3">
                <img src="/tg.png" alt="Telegram" className="w-8 h-8" />
                <h3 className="text-xl font-semibold">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram –±–æ—Ç–∞</h3>
              </div>
              <button 
                onClick={() => setShowTelegramModal(false)}
                className="text-gray-400 hover:text-gray-600"
              >
                ‚úï
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6">
              <div className="space-y-6">
                <div className="bg-blue-50 rounded-lg p-4">
                  <h5 className="font-medium mb-3 text-blue-900">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–ª—É—á–µ–Ω–∏—é API —Ç–æ–∫–µ–Ω–∞:</h5>
                  <div className="space-y-3 text-sm text-blue-800">
                    <p>1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ BotFather</p>
                    <p>2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /newbot –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞</p>
                    <p>3. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞, BotFather –¥–∞—Å—Ç –≤–∞–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π API —Ç–æ–∫–µ–Ω</p>
                    <p>4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ - –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–∏–º –±–æ—Ç–æ–º</p>
                    <p>5. –í—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API —Ç–æ–∫–µ–Ω –≤ –ø–æ–ª–µ –Ω–∏–∂–µ</p>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">API –¢–æ–∫–µ–Ω –±–æ—Ç–∞</label>
                  <input
                    type="text"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ API —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞"
                    value={telegramBotToken}
                    onChange={(e) => setTelegramBotToken(e.target.value)}
                    className="w-full h-12 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={handleConnectTelegramBot}
                    disabled={isConnectingTelegramBot}
                    className="flex-1 h-12 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {isConnectingTelegramBot ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram'}
                  </button>
                  <button
                    onClick={() => setShowTelegramModal(false)}
                    className="px-6 h-12 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Stories Management Modal */}
      {showStoriesModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowStoriesModal(false)} />
          <div className="relative bg-white rounded-xl w-full max-w-md mx-4 p-6">
            <div className="text-center">
              <h3 className="text-lg font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ—Ä–∏—Å</h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-2 text-left">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                  <input
                    type="text"
                    value={newStoryTitle}
                    onChange={(e) => setNewStoryTitle(e.target.value)}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ—Ä–∏—Å"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2 text-left">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                  <input
                    type="text"
                    value={newStoryImage}
                    onChange={(e) => setNewStoryImage(e.target.value)}
                    placeholder="/path/to/image.png"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={handleAddStory}
                    className="flex-1 bg-[#0084FF] text-white px-4 py-2 rounded-lg font-medium hover:bg-[#0070E6] transition-colors"
                  >
                    –î–æ–±–∞–≤–∏—Ç—å
                  </button>
                  <button
                    onClick={() => setShowStoriesModal(false)}
                    className="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition-colors"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Edit Story Modal */}
      {editingStory && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={() => setEditingStory(null)} />
          <div className="relative bg-white rounded-xl w-full max-w-md mx-4 p-6">
            <div className="text-center">
              <h3 className="text-lg font-semibold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ—Ä–∏—Å</h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-2 text-left">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                  <input
                    type="text"
                    value={editingStory.title}
                    onChange={(e) => setEditingStory({...editingStory, title: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2 text-left">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                  <input
                    type="text"
                    value={editingStory.image_url}
                    onChange={(e) => setEditingStory({...editingStory, image_url: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2 text-left">–ü–æ—Ä—è–¥–æ–∫</label>
                  <input
                    type="number"
                    value={editingStory.order_index}
                    onChange={(e) => setEditingStory({...editingStory, order_index: parseInt(e.target.value)})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={() => handleEditStory(editingStory.id, {
                      title: editingStory.title,
                      image_url: editingStory.image_url,
                      order_index: editingStory.order_index
                    })}
                    className="flex-1 bg-[#0084FF] text-white px-4 py-2 rounded-lg font-medium hover:bg-[#0070E6] transition-colors"
                  >
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </button>
                  <button
                    onClick={() => setEditingStory(null)}
                    className="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition-colors"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

