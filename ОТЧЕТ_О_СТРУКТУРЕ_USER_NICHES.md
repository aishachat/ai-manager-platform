# üìä –û–¢–ß–ï–¢ –û –°–¢–†–£–ö–¢–£–†–ï USER_NICHES

## üîç –û–ë–ù–ê–†–£–ñ–ï–ù–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê

### –¢–∞–±–ª–∏—Ü–∞: `user_niches`
```sql
–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
- id (uuid, NOT NULL) - –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
- user_id (uuid, nullable) - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- niche_id (uuid, nullable) - –Ω–∏—à–∞
- is_primary (boolean, nullable) - –ø–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∏—à–∞
- created_at (timestamp, nullable) - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- project_id (uuid, nullable) - –ø—Ä–æ–µ–∫—Ç
```

## üéØ –õ–û–ì–ò–ö–ê RLS

### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–ª–æ—Å—å):
```sql
-- –¢–æ–ª—å–∫–æ project_id
project_id IN (SELECT id FROM projects WHERE owner_id = auth.uid())
```

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (—Ä–µ–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞):
```sql
-- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
user_id = auth.uid() 
AND project_id IN (SELECT id FROM projects WHERE owner_id = auth.uid())
```

## üìã –ü–†–ò–ù–¶–ò–ü –†–ê–ë–û–¢–´

### –õ–æ–≥–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ã:
- **–°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–∏—à–∞–º–∏ –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–∏—à–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
- –ù—É–∂–Ω–∞ –¥–≤–æ–π–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è: –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ò –ø–æ –ø—Ä–æ–µ–∫—Ç—É

### RLS –ø–æ–ª–∏—Ç–∏–∫–∞:
```sql
CREATE POLICY "user_niches_combined_access" ON public.user_niches
    FOR ALL USING (
        user_id = auth.uid() 
        AND project_id IN (
            SELECT id FROM public.projects WHERE owner_id = auth.uid()
        )
    )
    WITH CHECK (
        user_id = auth.uid() 
        AND project_id IN (
            SELECT id FROM public.projects WHERE owner_id = auth.uid()
        )
    );
```

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –°–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç:
- ‚úÖ `–®–ê–ì_10_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_USER_NICHES_–ü–†–ê–í–ò–õ–¨–ù–´–ô.sql`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É `user_id + project_id`
- ‚úÖ –ë–µ–∑ –æ—à–∏–±–æ–∫ —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏

### 2. –°–æ–∑–¥–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
- ‚úÖ `–ò–ù–°–¢–†–£–ö–¶–ò–Ø_–í–´–ü–û–õ–ù–ï–ù–ò–Ø_–®–ê–ì_10_–ü–†–ê–í–ò–õ–¨–ù–´–ô.md`
- ‚úÖ –û–±—ä—è—Å–Ω—è–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É
- ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### 1. –í—ã–ø–æ–ª–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
- –ó–∞–ø—É—Å—Ç–∏—Ç—å `–®–ê–ì_10_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_USER_NICHES_–ü–†–ê–í–ò–õ–¨–ù–´–ô.sql`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ —Ç–∞–±–ª–∏—Ü—ã:
–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:
- `ai_agent_settings` - –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–∂–µ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
- `dialogs` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ project_id
- `chat_messages` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ user_id –∏–ª–∏ project_id
- `widget_development_settings` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ project_id
- `telegram_settings` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ project_id
- `bot_corrections` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ project_id
- `knowledge_sources` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ project_id
- `knowledge_chunks` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ project_id
- `niches` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ project_id
- `niche_synonyms` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ project_id

### 3. –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã:
–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π.

## üí° –í–´–í–û–î–´

1. **–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É** - user_id + project_id
2. **–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã** –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º RLS
3. **–õ–æ–≥–∏–∫–∞ RLS –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã**:
   - `project_id` ‚Üí –ø–æ–ª–∏—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–µ–∫—Ç—ã
   - `user_id` ‚Üí –ø–æ–ª–∏—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - `owner_id` ‚Üí –ø–æ–ª–∏—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤
   - `user_id + project_id` ‚Üí –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞

## üìû –¢–†–ï–ë–£–ï–¢–°–Ø –î–ï–ô–°–¢–í–ò–ï
–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç `–®–ê–ì_10_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_USER_NICHES_–ü–†–ê–í–ò–õ–¨–ù–´–ô.sql` –∏ —Å–æ–æ–±—â–∏—Ç–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö.
