# üéØ –ò–¢–û–ì–û–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û RLS

## üìä –ü–û–ù–ò–ú–ê–ù–ò–ï –í–ê–®–ï–ô –°–ò–¢–£–ê–¶–ò–ò

### –ò—Å—Ç–æ—Ä–∏—è —Å–∏—Å—Ç–µ–º—ã:
- **–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ**: –°–∏—Å—Ç–µ–º–∞ –Ω–∞ `user_id` (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞)
- **–ü–æ—Ç–æ–º**: –í–Ω–µ–¥—Ä–∏–ª–∏ `project_id` (–∫–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞)
- **–°–µ–π—á–∞—Å**: –ï—Å—Ç—å –æ–±–∞ –ø–æ–ª—è –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Ç–∞–±–ª–∏—Ü

### –≠—Ç–æ –ù–ï –ø—Ä–æ–±–ª–µ–º–∞:
- –ù–∞–ª–∏—á–∏–µ –æ–±–æ–∏—Ö –ø–æ–ª–µ–π - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- USER_ID –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- PROJECT_ID - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è RLS

## üéØ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø

### 1. –ü–†–ò–û–†–ò–¢–ï–¢ PROJECT_ID –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Ç–∞–±–ª–∏—Ü:
```sql
project_id IN (SELECT id FROM projects WHERE owner_id = auth.uid())
```

**–ü—Ä–∏–º–µ–Ω—è—Ç—å –¥–ª—è:**
- `ai_agent_settings` ‚úÖ - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞
- `dialogs` - –¥–∏–∞–ª–æ–≥–∏ –ø—Ä–æ–µ–∫—Ç–∞
- `chat_messages` - —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ
- `widget_development_settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞
- `telegram_settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –ø—Ä–æ–µ–∫—Ç–∞
- `bot_corrections` - –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –±–æ—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞
- `knowledge_sources` - –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞
- `knowledge_chunks` - —á–∞–Ω–∫–∏ –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞

### 2. –ö–û–ú–ë–ò–ù–ò–†–û–í–ê–ù–ù–ê–Ø –ª–æ–≥–∏–∫–∞ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
```sql
user_id = auth.uid() 
AND project_id IN (SELECT id FROM projects WHERE owner_id = auth.uid())
```

**–ü—Ä–∏–º–µ–Ω—è—Ç—å –¥–ª—è:**
- `user_niches` ‚úÖ - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∏—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–æ–µ–∫—Ç–µ
- `conversations` - –≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã

### 3. –¢–û–õ–¨–ö–û USER_ID –¥–ª—è –ª–∏—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫:
```sql
user_id = auth.uid()
```

**–ü—Ä–∏–º–µ–Ω—è—Ç—å –¥–ª—è:**
- `autoswitch_settings` ‚úÖ - –ª–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 4. –°–ü–†–ê–í–û–ß–ù–ò–ö–ò:
```sql
-- –ß—Ç–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö
FOR SELECT USING (true)
-- –ó–∞–ø–∏—Å—å –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤
FOR ALL USING (EXISTS (SELECT 1 FROM projects WHERE owner_id = auth.uid()))
```

**–ü—Ä–∏–º–µ–Ω—è—Ç—å –¥–ª—è:**
- `niche_synonyms` ‚úÖ - —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
- `niches` - –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–∂–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫

## üöÄ –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (PROJECT_ID –ª–æ–≥–∏–∫–∞)
1. ‚úÖ `ai_agent_settings` - —Å–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤
2. `dialogs` - —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
3. `chat_messages` - —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
4. `widget_development_settings` - —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
5. `telegram_settings` - —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
6. `bot_corrections` - —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç

### –§–∞–∑–∞ 2: –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (PROJECT_ID –ª–æ–≥–∏–∫–∞)
7. `knowledge_sources` - —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
8. `knowledge_chunks` - —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç

### –§–∞–∑–∞ 3: –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
9. `niches` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å–ª–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫

### –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
10. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É API
11. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª—è—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
12. –£–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

## üí° –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –¢–ê–ö–û–ì–û –ü–û–î–•–û–î–ê

### 1. –ü—Ä–æ—Å—Ç–æ—Ç–∞:
- –û–¥–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Ç–∞–±–ª–∏—Ü
- –õ–µ–≥–∫–æ –ø–æ–Ω—è—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- –ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫

### 2. –ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞:
- –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤–∏–¥—è—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É

### 3. –ì–∏–±–∫–æ—Å—Ç—å:
- USER_ID –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
- –õ–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üö® –í–ê–ñ–ù–´–ï –ú–û–ú–ï–ù–¢–´

### 1. –ù–µ —Å–ø–µ—à–∏—Ç—å:
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–±–æ—Ç—É API
- –£–±–µ–∂–¥–∞—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### 2. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:
- –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã
- –û–±—ä—è—Å–Ω—è—Ç—å –≤—ã–±–æ—Ä RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- –°–æ–∑–¥–∞–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å:
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª—è—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö

## üìû –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –ù–ï–ú–ï–î–õ–ï–ù–ù–û:
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å `–®–ê–ì_12_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_AI_AGENT_SETTINGS_–ü–†–û–ï–ö–¢.sql`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü–û–°–õ–ï –£–°–ü–ï–•–ê:
1. –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å PROJECT_ID –ª–æ–≥–∏–∫—É
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É

### –í –î–û–õ–ì–û–°–†–û–ß–ù–û–ô –ü–ï–†–°–ü–ï–ö–¢–ò–í–ï:
1. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
2. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –∫–æ–º–∞–Ω–¥—ã

## üéØ –ò–¢–û–ì

–í–∞—à–∞ —Å–∏—Ç—É–∞—Ü–∏—è —Å USER_ID + PROJECT_ID - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏ –¥–∞–∂–µ —Ö–æ—Ä–æ—à–æ. –ì–ª–∞–≤–Ω–æ–µ - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è RLS –ø–æ–ª–∏—Ç–∏–∫. –†–µ–∫–æ–º–µ–Ω–¥—É—é PROJECT_ID –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–µ–π –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–±–æ—Ç—ã.
