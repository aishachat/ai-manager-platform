# üîç –ê–ù–ê–õ–ò–ó –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò RLS –ü–û–õ–ò–¢–ò–ö

## üéØ –ü–†–ò–ù–¶–ò–ü–´ –ù–ê–®–ò–• –ü–û–õ–ò–¢–ò–ö

### 1. PROJECT_ID –ª–æ–≥–∏–∫–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è):
```sql
project_id IN (SELECT id FROM projects WHERE owner_id = auth.uid())
```

### 2. USER_ID –ª–æ–≥–∏–∫–∞ (–ª–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏):
```sql
user_id = auth.uid()
```

### 3. OWNER_ID –ª–æ–≥–∏–∫–∞ (–≤–ª–∞–¥–µ–ª–µ—Ü):
```sql
owner_id = auth.uid()
```

### 4. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞:
```sql
user_id = auth.uid() 
AND project_id IN (SELECT id FROM projects WHERE owner_id = auth.uid())
```

### 5. –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –ª–æ–≥–∏–∫–∞:
```sql
-- –ß—Ç–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö
FOR SELECT USING (true)
-- –ó–∞–ø–∏—Å—å –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤
FOR ALL USING (EXISTS (SELECT 1 FROM projects WHERE owner_id = auth.uid()))
```

## ‚úÖ –ü–û–ß–ï–ú–£ –ü–û–õ–ò–¢–ò–ö–ò –ù–ï –ë–õ–û–ö–ò–†–£–Æ–¢ API

### 1. –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **–ù–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö UNION –∑–∞–ø—Ä–æ—Å–æ–≤** - —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã–µ —É—Å–ª–æ–≤–∏—è
- **–ù–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö JOIN** - —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- **–ù–µ—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** - —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ SELECT

### 2. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞:
- **–í–ª–∞–¥–µ–ª—å—Ü—ã –ø—Ä–æ–µ–∫—Ç–æ–≤** –≤–∏–¥—è—Ç –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –≤–∏–¥—è—Ç —Å–≤–æ–∏ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–í—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ** –≤–∏–¥—è—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
- **–ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏** –¥–ª—è service_role

### 3. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ:
- **–ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞** - —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤–∏–¥—è—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
- **–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏
- **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏** - –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º

## üö® –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### 1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤:
```sql
-- –ù–∞—à–∞ –ø–æ–ª–∏—Ç–∏–∫–∞
project_id IN (SELECT id FROM projects WHERE owner_id = auth.uid())

-- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å
-- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ projects.owner_id
CREATE INDEX IF NOT EXISTS idx_projects_owner_id ON public.projects(owner_id);
```

### 2. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã:
```sql
-- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤
-- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –±–æ–ª—å—à–æ–π IN —Å–ø–∏—Å–æ–∫
-- –†–µ—à–µ–Ω–∏–µ: –ø–æ–ª–∏—Ç–∏–∫–∞ –≤—Å–µ —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ
```

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ project_id:
```sql
-- –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç project_id
-- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –ø–æ–ª–∏—Ç–∏–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
-- –†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏
```

## üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### 1. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã:
```sql
-- –î–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤
CREATE INDEX IF NOT EXISTS idx_projects_owner_id ON public.projects(owner_id);

-- –î–ª—è —Ç–∞–±–ª–∏—Ü —Å project_id
CREATE INDEX IF NOT EXISTS idx_ai_agent_settings_project_id ON public.ai_agent_settings(project_id);
CREATE INDEX IF NOT EXISTS idx_dialogs_project_id ON public.dialogs(project_id);
CREATE INDEX IF NOT EXISTS idx_chat_messages_project_id ON public.chat_messages(project_id);
CREATE INDEX IF NOT EXISTS idx_user_niches_project_id ON public.user_niches(project_id);
CREATE INDEX IF NOT EXISTS idx_user_niches_user_id ON public.user_niches(user_id);

-- –î–ª—è —Ç–∞–±–ª–∏—Ü —Å user_id
CREATE INDEX IF NOT EXISTS idx_autoswitch_settings_user_id ON public.autoswitch_settings(user_id);

-- –î–ª—è —Ç–∞–±–ª–∏—Ü —Å owner_id
CREATE INDEX IF NOT EXISTS idx_conversations_owner_id ON public.conversations(owner_id);
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–ª–∞–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –î–æ–±–∞–≤–ª—è—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API:
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–±–æ—Ç—É —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –£–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

## üìä –ê–ù–ê–õ–ò–ó –ö–ê–ñ–î–û–ô –ü–û–õ–ò–¢–ò–ö–ò

### ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–´–ï –ü–û–õ–ò–¢–ò–ö–ò:

#### 1. PROJECT_ID –ª–æ–≥–∏–∫–∞:
```sql
project_id IN (SELECT id FROM projects WHERE owner_id = auth.uid())
```
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å
- **–ë—ã—Å—Ç—Ä–æ**: —Å –∏–Ω–¥–µ–∫—Å–æ–º –Ω–∞ owner_id
- **–õ–æ–≥–∏—á–Ω–æ**: –≤–ª–∞–¥–µ–ª–µ—Ü –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã

#### 2. USER_ID –ª–æ–≥–∏–∫–∞:
```sql
user_id = auth.uid()
```
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: –ø—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- **–ë—ã—Å—Ç—Ä–æ**: —Å –∏–Ω–¥–µ–∫—Å–æ–º –Ω–∞ user_id
- **–õ–æ–≥–∏—á–Ω–æ**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ

#### 3. OWNER_ID –ª–æ–≥–∏–∫–∞:
```sql
owner_id = auth.uid()
```
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: –ø—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- **–ë—ã—Å—Ç—Ä–æ**: —Å –∏–Ω–¥–µ–∫—Å–æ–º –Ω–∞ owner_id
- **–õ–æ–≥–∏—á–Ω–æ**: –≤–ª–∞–¥–µ–ª–µ—Ü –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ

#### 4. –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –ª–æ–≥–∏–∫–∞:
```sql
FOR SELECT USING (true)
```
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: –Ω–µ—Ç —É—Å–ª–æ–≤–∏–π
- **–ë—ã—Å—Ç—Ä–æ**: –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫
- **–õ–æ–≥–∏—á–Ω–æ**: —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º

### ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û –ú–ï–î–õ–ï–ù–ù–´–ï –ü–û–õ–ò–¢–ò–ö–ò:

#### 1. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞:
```sql
user_id = auth.uid() 
AND project_id IN (SELECT id FROM projects WHERE owner_id = auth.uid())
```
- **–ú–µ–¥–ª–µ–Ω–Ω–æ**: –¥–≤–∞ —É—Å–ª–æ–≤–∏—è + –ø–æ–¥–∑–∞–ø—Ä–æ—Å
- **–†–µ—à–µ–Ω–∏–µ**: –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ –æ–±–∞ –ø–æ–ª—è

## üéØ –ò–¢–û–ì–û–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –ù–ï–ú–ï–î–õ–ï–ù–ù–û:
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –∑–∞–ø—Ä–æ—Å—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 2. –ú–û–ù–ò–¢–û–†–ò–ù–ì:
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### 3. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–±–æ—Ç—É —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –£–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

## üí° –í–´–í–û–î

**–ü–æ–ª–∏—Ç–∏–∫–∏ –ù–ï —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–µ –∏ –ù–ï –±—É–¥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å API**, –ø–æ—Ç–æ–º—É —á—Ç–æ:

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
2. **–õ–æ–≥–∏—á–Ω–æ—Å—Ç—å** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –±—ã—Å—Ç—Ä–æ
4. **–ì–∏–±–∫–æ—Å—Ç—å** - service_role –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø

**–ì–ª–∞–≤–Ω–æ–µ** - –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API!
